"use strict";(self.webpackChunkreact_map_widgets=self.webpackChunkreact_map_widgets||[]).push([[7458,9483],{45667:(e,t,i)=>{i.d(t,{b:()=>c});const r=2654435761,n=2246822519,s=3266489917,a=668265263,o=374761393;function l(e){const t=[];for(let i=0,r=e.length;i<r;i++){let r=e.charCodeAt(i);r<128?t.push(r):r<2048?t.push(192|r>>6,128|63&r):r<55296||r>=57344?t.push(224|r>>12,128|r>>6&63,128|63&r):(i++,r=65536+((1023&r)<<10|1023&e.charCodeAt(i)),t.push(240|r>>18,128|r>>12&63,128|r>>6&63,128|63&r))}return new Uint8Array(t)}class c{constructor(e){this._seed=e,this._totallen=0,this._bufs=[],this.init()}init(){return this._bufs=[],this._totallen=0,this}updateFloatArray(e){const t=[];for(const i of e)isNaN(i)?t.push("NaN"):i===1/0?t.push("Infinity"):i===-1/0?t.push("-Infinity"):0===i?t.push("0"):t.push(i.toString(16));this.update(l(t.join("")))}updateIntArray(e){const t=Int32Array.from(e);this.update(new Uint8Array(t.buffer))}updateUint8Array(e){this.update(Uint8Array.from(e))}updateWithString(e){return this.update(l(e))}update(e){return this._bufs.push(e),this._totallen+=e.length,this}digest(){const e=new Uint8Array(this._totallen);let t=0;for(const i of this._bufs)e.set(i,t),t+=i.length;return this.init(),this._xxHash32(e,this._seed)}_xxHash32(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;const i=e;let l=t+o&4294967295,c=0;if(i.length>=16){const i=[t+r+n&4294967295,t+n&4294967295,t+0&4294967295,t-r&4294967295],s=e,a=s.length-16;let o=0;for(c=0;(4294967280&c)<=a;c+=4){const e=c,t=s[e]+(s[e+1]<<8),a=s[e+2]+(s[e+3]<<8),l=t*n+(a*n<<16);let d=i[o]+l&4294967295;d=d<<13|d>>>19;const h=65535&d,u=d>>>16;i[o]=h*r+(u*r<<16)&4294967295,o=o+1&3}l=(i[0]<<1|i[0]>>>31)+(i[1]<<7|i[1]>>>25)+(i[2]<<12|i[2]>>>20)+(i[3]<<18|i[3]>>>14)&4294967295}l=l+e.length&4294967295;const d=e.length-4;for(;c<=d;c+=4){const e=c,t=i[e]+(i[e+1]<<8),r=i[e+2]+(i[e+3]<<8);l=l+(t*s+(r*s<<16))&4294967295,l=l<<17|l>>>15,l=(65535&l)*a+((l>>>16)*a<<16)&4294967295}for(;c<i.length;++c)l+=i[c]*o,l=l<<11|l>>>21,l=(65535&l)*r+((l>>>16)*r<<16)&4294967295;return l^=l>>>15,l=((65535&l)*n&4294967295)+((l>>>16)*n<<16),l^=l>>>13,l=((65535&l)*s&4294967295)+((l>>>16)*s<<16),l^=l>>>16,l<0?l+4294967296:l}}},37923:(e,t,i)=>{i.d(t,{C:()=>D,b:()=>I});var r,n,s,a,o,l,c,d,h,u,p=i(57528),f=i(72412),g=i(34981),m=i(26917),_=i(59395),v=i(90080),y=i(54478),b=i(49399),x=i(48020),S=i(81993),w=i(66763),C=i(90235),A=i(80883),R=i(42451),E=i(58350),O=i(64839),T=i(32307),P=i(10773),M=i(66470);function I(e){const t=new T.N5,{vertex:i,fragment:I,attributes:D,varyings:L}=t;(0,R.NB)(i,e),t.include(_.d,e),t.include(y.c,e),t.include(w.A,e),t.include(v.g,e),D.add(M.r.POSITION,"vec3"),e.vvColor&&D.add(M.r.COLORFEATUREATTRIBUTE,"float"),L.add("vColor","vec4"),L.add("vpos","vec3");const F=e.multipassEnabled&&(e.output===g.V.Color||e.output===g.V.Alpha);F&&L.add("depth","float"),i.uniforms.add(new E.E("eColor",(e=>e.color)));const N=e.output===g.V.LinearDepth;N&&(t.include(b.L,e),(0,f.xJ)(t),(0,f.Mu)(t)),i.code.add((0,O.H)(r||(r=(0,p.A)(["\n    void main(void) {\n      vpos = position;\n      forwardNormalizedVertexColor();\n      forwardObjectAndLayerIdColor();\n\n      ","\n      ","\n      gl_Position = ","\n    }\n  "])),e.hasVertexColors?"vColor *= eColor;":e.vvColor?"vColor = eColor * interpolateVVColor(colorFeatureAttribute);":"vColor = eColor;",F?"depth = (view * vec4(vpos, 1.0)).z;":"",N?(0,O.H)(n||(n=(0,p.A)(["transformPositionWithDepth(proj, view, vpos, nearFar, linearDepth);"]))):(0,O.H)(s||(s=(0,p.A)(["transformPosition(proj, view, vpos);"]))))),t.include(m.HQ,e),F&&t.include(S.Q,e),I.include(A.a);const V=e.output===g.V.Highlight;return V&&t.include(x.Qh,e),I.code.add((0,O.H)(a||(a=(0,p.A)(["\n  void main() {\n    discardBySlice(vpos);\n    ","\n    vec4 fColor = vColor;\n\n    ","\n\n    if (fColor.a < ",") {\n      discard;\n    }\n\n    ","\n\n    ","\n    ",";\n    ",";\n    ","\n  }\n  "])),F?"terrainDepthTest(depth);":"",e.output===g.V.ObjectAndLayerIdColor?(0,O.H)(o||(o=(0,p.A)(["fColor.a = 1.0;"]))):"",O.H.float(C.y),e.output===g.V.Alpha?(0,O.H)(l||(l=(0,p.A)(["fragColor = vec4(fColor.a);"]))):"",e.output===g.V.Color?(0,O.H)(c||(c=(0,p.A)(["fragColor = highlightSlice(fColor, vpos); ",""])),e.transparencyPassType===P.y.Color?"fragColor = premultiplyAlpha(fragColor);":""):"",V?(0,O.H)(d||(d=(0,p.A)(["outputHighlight();"]))):"",e.output===g.V.LinearDepth?(0,O.H)(h||(h=(0,p.A)(["outputDepth(linearDepth);"]))):"",e.output===g.V.ObjectAndLayerIdColor?(0,O.H)(u||(u=(0,p.A)(["outputObjectAndLayerIdColor();"]))):"")),t}const D=Object.freeze(Object.defineProperty({__proto__:null,build:I},Symbol.toStringTag,{value:"Module"}))},19061:(e,t,i)=>{i.d(t,{H:()=>te,b:()=>X,c:()=>K});var r,n,s,a,o,l,c,d,h,u,p,f,g,m,_,v,y,b,x,S,w,C,A=i(57528),R=i(19555),E=i(72745),O=i(55855),T=i(34981),P=i(26917),M=i(90080),I=i(98720),D=i(40318),L=i(38280),F=i(62374),N=i(48020),V=i(66763),G=i(90235),U=i(80883),z=i(81449),B=i(69817),H=i(42451),j=i(95756),W=i(58350),k=i(21390),Z=i(64839),q=i(32307),Q=i(70367),J=i(10773),Y=i(66470);function X(e){const t=new q.N5,i=e.signedDistanceFieldEnabled;if(t.include(D.Q,e),t.include(P.HQ,e),e.occlusionPass)return t.include(L.I,e),t;const{vertex:E,fragment:X}=t;t.include(B.Y6),X.include(z.W),X.include(U.a),t.include(V.A,e),t.include(M.g,e),t.include(F.y),t.varyings.add("vcolor","vec4"),t.varyings.add("vtc","vec2"),t.varyings.add("vsize","vec2"),t.varyings.add("voccluded","float"),E.uniforms.add(new W.E("viewport",((e,t)=>t.camera.fullViewport)),new j.G("screenOffset",((e,t)=>(0,R.hZ)(ee,2*e.screenOffset[0]*t.camera.pixelRatio,2*e.screenOffset[1]*t.camera.pixelRatio))),new j.G("anchorPosition",(e=>K(e))),new W.E("materialColor",(e=>e.color))),(0,H.Nz)(E),i&&(E.uniforms.add(new W.E("outlineColor",(e=>e.outlineColor))),X.uniforms.add(new W.E("outlineColor",(e=>$(e)?e.outlineColor:O.uY)),new k.m("outlineSize",(e=>$(e)?e.outlineSize:0)))),e.pixelSnappingEnabled&&E.include(I.K),e.hasScreenSizePerspective&&((0,B.pM)(E),(0,B.OH)(E)),e.debugDrawLabelBorder&&t.varyings.add("debugBorderCoords","vec4"),t.attributes.add(Y.r.UV0,"vec2"),t.attributes.add(Y.r.COLOR,"vec4"),t.attributes.add(Y.r.SIZE,"vec2"),t.attributes.add(Y.r.FEATUREATTRIBUTE,"vec4"),E.code.add((0,Z.H)(r||(r=(0,A.A)(["\n    void main(void) {\n      ProjectHUDAux projectAux;\n      vec4 posProj = projectPositionHUD(projectAux);\n      forwardObjectAndLayerIdColor();\n\n      if (rejectBySlice(projectAux.posModel)) {\n        // Project outside of clip plane\n        gl_Position = vec4(1e038, 1e038, 1e038, 1.0);\n        return;\n      }\n      vec2 inputSize;\n      ","\n\n      ","\n\n      vec2 combinedSize = inputSize * pixelRatio;\n      vec4 quadOffset = vec4(0.0);\n      bool visible = testHUDVisibility(posProj);\n      voccluded = visible ? 0.0 : 1.0;\n    "])),e.hasScreenSizePerspective?(0,Z.H)(n||(n=(0,A.A)(["\n            inputSize = screenSizePerspectiveScaleVec2(size, projectAux.absCosAngle, projectAux.distanceToCamera, screenSizePerspective);\n            vec2 screenOffsetScaled = screenSizePerspectiveScaleVec2(screenOffset, projectAux.absCosAngle, projectAux.distanceToCamera, screenSizePerspectiveAlignment);\n         "]))):(0,Z.H)(s||(s=(0,A.A)(["\n            inputSize = size;\n            vec2 screenOffsetScaled = screenOffset;"]))),e.vvSize?"inputSize *= vvScale(featureAttribute).xx;":""));const te=(0,Z.H)(a||(a=(0,A.A)(["vec2 uv01 = floor(uv0);\nvec2 uv = uv0 - uv01;\nquadOffset.xy = ((uv01 - anchorPosition) * 2.0 * combinedSize + screenOffsetScaled) / viewport.zw * posProj.w;"]))),ie=e.pixelSnappingEnabled?i?(0,Z.H)(o||(o=(0,A.A)(["posProj = alignToPixelOrigin(posProj, viewport.zw) + quadOffset;"]))):(0,Z.H)(l||(l=(0,A.A)(["posProj += quadOffset;\nif (inputSize.x == size.x) {\nposProj = alignToPixelOrigin(posProj, viewport.zw);\n}"]))):(0,Z.H)(c||(c=(0,A.A)(["posProj += quadOffset;"])));E.code.add((0,Z.H)(d||(d=(0,A.A)(["\n    ","\n    ","\n    ","\n\n    ","\n\n    bool alphaDiscard = vcolor.a < ",";\n    ",'\n    if (alphaDiscard) {\n      // "early discard" if both symbol color (= fill) and outline color (if applicable) are transparent\n      gl_Position = vec4(1e38, 1e38, 1e38, 1.0);\n      return;\n    } else {\n      ',"\n      gl_Position = posProj;\n    }\n\n    vtc = uv;\n\n    ","\n    vsize = inputSize;\n    ","\n  }\n  "])),e.occlusionTestEnabled?"if (visible) {":"",te,e.vvColor?"vcolor = interpolateVVColor(featureAttribute.y) * materialColor;":"vcolor = color / 255.0 * materialColor;",e.output===T.V.ObjectAndLayerIdColor?(0,Z.H)(h||(h=(0,A.A)(["vcolor.a = 1.0;"]))):"",Z.H.float(G.y),i?"alphaDiscard = alphaDiscard && outlineColor.a < ".concat(Z.H.float(G.y),";"):"",ie,e.debugDrawLabelBorder?"debugBorderCoords = vec4(uv01, 1.5 / combinedSize);":"",e.occlusionTestEnabled?(0,Z.H)(u||(u=(0,A.A)(["} else { vtc = vec2(0.0);\n      ",""])),e.debugDrawLabelBorder?"debugBorderCoords = vec4(0.5, 0.5, 1.5 / combinedSize);}":"}"):"")),X.uniforms.add(new Q.N("tex",(e=>e.texture)));const re=e.debugDrawLabelBorder?(0,Z.H)(p||(p=(0,A.A)(["(isBorder > 0.0 ? 0.0 : ",")"])),Z.H.float(G.H)):Z.H.float(G.H),ne=(0,Z.H)(f||(f=(0,A.A)(["\n    ","\n\n    ","\n\n    ","\n\n    // Draw debug border with transparency, so that original texels along border are still partially visible\n    ","\n  "])),e.debugDrawLabelBorder?(0,Z.H)(g||(g=(0,A.A)(["\n      float isBorder = float(any(lessThan(debugBorderCoords.xy, debugBorderCoords.zw)) || any(greaterThan(debugBorderCoords.xy, 1.0 - debugBorderCoords.zw)));"]))):"",e.sampleSignedDistanceFieldTexelCenter?(0,Z.H)(m||(m=(0,A.A)(["\n      // Attempt to sample texel centers to avoid that thin cross outlines\n      // disappear with large symbol sizes.\n      // see: https://devtopia.esri.com/WebGIS/arcgis-js-api/issues/7058#issuecomment-603041\n      float txSize = float(textureSize(tex, 0).x);\n      float texelSize = 1.0 / txSize;\n\n      // Calculate how much we have to add/subtract to/from each texel to reach the size of an onscreen pixel\n      vec2 scaleFactor = (vsize - txSize) * texelSize;\n      vec2 samplePos = vtc + (vec2(1.0, -1.0) * texelSize) * scaleFactor;\n      "]))):(0,Z.H)(_||(_=(0,A.A)(["\n      vec2 samplePos = vtc;\n      "]))),i?(0,Z.H)(v||(v=(0,A.A)(["\n      vec4 fillPixelColor = vcolor;\n\n      // Get distance and map it into [-0.5, 0.5]\n      float d = rgba2float(texture(tex, samplePos)) - 0.5;\n\n      // Distance in output units (i.e. pixels)\n      float dist = d * vsize.x;\n\n      // Create smooth transition from the icon into its outline\n      float fillAlphaFactor = clamp(0.5 - dist, 0.0, 1.0);\n      fillPixelColor.a *= fillAlphaFactor;\n\n      if (outlineSize > 0.25) {\n        vec4 outlinePixelColor = outlineColor;\n        float clampedOutlineSize = min(outlineSize, 0.5*vsize.x);\n\n        // Create smooth transition around outline\n        float outlineAlphaFactor = clamp(0.5 - (abs(dist) - 0.5*clampedOutlineSize), 0.0, 1.0);\n        outlinePixelColor.a *= outlineAlphaFactor;\n\n        if (\n          outlineAlphaFactor + fillAlphaFactor < "," ||\n          fillPixelColor.a + outlinePixelColor.a < ","\n        ) {\n          discard;\n        }\n\n        // perform un-premultiplied over operator (see https://en.wikipedia.org/wiki/Alpha_compositing#Description)\n        float compositeAlpha = outlinePixelColor.a + fillPixelColor.a * (1.0 - outlinePixelColor.a);\n        vec3 compositeColor = vec3(outlinePixelColor) * outlinePixelColor.a +\n          vec3(fillPixelColor) * fillPixelColor.a * (1.0 - outlinePixelColor.a);\n\n        fragColor = vec4(compositeColor, compositeAlpha);\n      } else {\n        if (fillAlphaFactor < ",") {\n          discard;\n        }\n\n        fragColor = premultiplyAlpha(fillPixelColor);\n      }\n\n      // visualize SDF:\n      // fragColor = vec4(clamp(-dist/vsize.x*2.0, 0.0, 1.0), clamp(dist/vsize.x*2.0, 0.0, 1.0), 0.0, 1.0);\n      "])),re,Z.H.float(G.y),re):(0,Z.H)(y||(y=(0,A.A)(["\n          vec4 texColor = texture(tex, vtc, -0.5);\n          if (texColor.a < ",") {\n            discard;\n          }\n          fragColor = texColor * premultiplyAlpha(vcolor);\n          "])),re),e.debugDrawLabelBorder?(0,Z.H)(b||(b=(0,A.A)(["fragColor = mix(fragColor, vec4(1.0, 0.0, 1.0, 1.0), isBorder * 0.5);"]))):"");switch(e.output){case T.V.Color:X.code.add((0,Z.H)(x||(x=(0,A.A)(["\n        void main() {\n          ","\n          ","\n        }"])),ne,e.transparencyPassType===J.y.FrontFace?"fragColor.rgb /= fragColor.a;":""));break;case T.V.Alpha:X.code.add((0,Z.H)(S||(S=(0,A.A)(["\n        void main() {\n          ","\n          fragColor = vec4(fragColor.a);\n        }"])),ne));break;case T.V.ObjectAndLayerIdColor:X.code.add((0,Z.H)(w||(w=(0,A.A)(["\n        void main() {\n          ","\n          outputObjectAndLayerIdColor();\n        }"])),ne));break;case T.V.Highlight:X.constants.add("occludedHighlightFlag","vec4",N.U),X.constants.add("unoccludedHighlightFlag","vec4",N.bO),X.code.add((0,Z.H)(C||(C=(0,A.A)(["\n        void main() {\n          ","\n          if (voccluded == 1.0) {\n            fragColor = occludedHighlightFlag;\n          } else {\n            fragColor = unoccludedHighlightFlag;\n          }\n        }"])),ne))}return t}function $(e){return e.outlineColor[3]>0&&e.outlineSize>0}function K(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:ee;return e.textureIsSignedDistanceField?function(e,t,i){null!=t?(0,R.hZ)(i,e[0]*(t[2]-t[0])+t[0],e[1]*(t[3]-t[1])+t[1]):(0,R.hZ)(i,0,0)}(e.anchorPosition,e.distanceFieldBoundingBox,t):(0,R.C)(t,e.anchorPosition),t}const ee=(0,E.vt)(),te=Object.freeze(Object.defineProperty({__proto__:null,build:X,calculateAnchorPosForRendering:K},Symbol.toStringTag,{value:"Module"}))},86901:(e,t,i)=>{i.d(t,{H:()=>p,b:()=>u});var r,n,s=i(57528),a=i(73398),o=i(54355),l=i(21390),c=i(64839),d=i(32307),h=i(70367);function u(e){const t=new d.N5;t.include(a.c),t.include(o.g);const{usesHalfFloat:i}=e;return t.fragment.uniforms.add(new h.N("densityMap",(e=>e.densityMap)),new h.N("tex",(e=>e.colorRamp)),new l.m("densityNormalizer",(e=>1/(e.maxDensity-e.minDensity))),new l.m("minDensity",(e=>e.minDensity)),new l.m("densityMultiplier",(e=>3/(e.searchRadius*e.searchRadius*Math.PI)))),i&&t.constants.add("compressionFactor","float",4),t.fragment.code.add((0,c.H)(r||(r=(0,s.A)(["\n    void main() {\n      float density = texture(densityMap, uv).r * densityMultiplier",";\n      float densityRatio = (density - minDensity) * densityNormalizer;\n\n      vec4 color = texture(tex, vec2(clamp(densityRatio, 0.0, 1.0), 0.5));\n\n      discardOrAdjustAlpha(color);\n      fragColor = color;\n    }\n  "])),i?(0,c.H)(n||(n=(0,s.A)([" * compressionFactor"]))):"")),t}const p=Object.freeze(Object.defineProperty({__proto__:null,build:u},Symbol.toStringTag,{value:"Module"}))},26741:(e,t,i)=>{i.d(t,{H:()=>g,b:()=>f});var r,n,s,a,o,l=i(57528),c=i(42451),d=i(21390),h=i(64839),u=i(32307),p=i(66470);function f(e){const t=new u.N5,{vertex:i,fragment:f,attributes:g,varyings:m}=t;(0,c.NB)(i,e);const{isAttributeDriven:_,usesHalfFloat:v}=e;return g.add(p.r.POSITION,"vec3"),g.add(p.r.UV0,"vec2"),_&&(g.add(p.r.FEATUREATTRIBUTE,"float"),m.add("attributeValue","float")),v&&t.constants.add("compressionFactor","float",.25),m.add("unitCirclePos","vec2"),i.uniforms.add(new d.m("radius",((e,t)=>{let{resolutionForScale:i,searchRadius:r}=e,{camera:n,screenToWorldRatio:s,overlayStretch:a}=t;return 2*r*(0===i?1:i/s)*n.pixelRatio/n.fullViewport[2]/a}))),i.code.add((0,h.H)(r||(r=(0,l.A)(["\n    void main() {\n      unitCirclePos = uv0;\n\n      vec4 posProj = proj * (view * vec4(",", 1.0));\n      vec4 quadOffset = vec4(unitCirclePos * radius, 0.0, 0.0);\n\n      ","\n      gl_Position = posProj + quadOffset;\n    }\n  "])),p.r.POSITION,_?(0,h.H)(n||(n=(0,l.A)(["attributeValue = ",";"])),p.r.FEATUREATTRIBUTE):"")),f.code.add((0,h.H)(s||(s=(0,l.A)(["\n    void main() {\n      float radiusRatioSquared = dot(unitCirclePos, unitCirclePos);\n      if (radiusRatioSquared > 1.0) {\n        discard;\n      }\n\n      float oneMinusRadiusRatioSquared = 1.0 - radiusRatioSquared;\n      float density = oneMinusRadiusRatioSquared * oneMinusRadiusRatioSquared "," ",";\n      fragColor = vec4(density);\n    }\n  "])),_?(0,h.H)(a||(a=(0,l.A)([" * attributeValue"]))):"",v?(0,h.H)(o||(o=(0,l.A)([" * compressionFactor"]))):"")),t}const g=Object.freeze(Object.defineProperty({__proto__:null,build:f},Symbol.toStringTag,{value:"Module"}))},40431:(e,t,i)=>{i.d(t,{L:()=>D,b:()=>P});var r,n,s,a,o,l,c,d,h,u,p,f=i(57528),g=i(19555),m=i(72745),_=i(55855),v=i(26917),y=i(98720),b=i(40318),x=i(62374),S=i(10708),w=i(69817),C=i(95756),A=i(58350),R=i(21390),E=i(64839),O=i(32307),T=i(66470);function P(e){const t=new O.N5,{vertex:i,fragment:m}=t;return i.include(y.K),t.include(b.Q,e),t.include(v.HQ,e),t.attributes.add(T.r.UV0,"vec2"),i.uniforms.add(new A.E("viewport",((e,t)=>t.camera.fullViewport)),new R.m("lineSize",((e,t)=>e.size>0?Math.max(1,e.size)*t.camera.pixelRatio:0)),new C.G("pixelToNDC",((e,t)=>(0,g.hZ)(I,2/t.camera.fullViewport[2],2/t.camera.fullViewport[3]))),new R.m("borderSize",((e,t)=>null!=e.borderColor?t.camera.pixelRatio:0)),new C.G("screenOffset",((e,t)=>(0,g.hZ)(I,e.horizontalScreenOffset*t.camera.pixelRatio,0)))),t.varyings.add("coverageSampling","vec4"),t.varyings.add("lineSizes","vec2"),e.multipassEnabled&&t.varyings.add("depth","float"),e.occlusionTestEnabled&&t.include(x.y),e.hasScreenSizePerspective&&(0,w.OH)(i),i.code.add((0,E.H)(r||(r=(0,f.A)(["\n    void main(void) {\n      ProjectHUDAux projectAux;\n      vec4 endPoint = projectPositionHUD(projectAux);\n\n      vec3 vpos = projectAux.posModel;\n      if (rejectBySlice(vpos)) {\n        gl_Position = vec4(1e38, 1e38, 1e38, 1.0);\n        return;\n      }\n    ","\n\n    ","\n      // Add view dependent polygon offset to get exact same original starting point. This is mostly used to get the\n      // correct depth value\n      vec3 posView = (view * vec4(position, 1.0)).xyz;\n      ","\n\n      applyHUDViewDependentPolygonOffset(centerOffsetAndDistance.w, projectAux.absCosAngle, posView);\n      vec4 startPoint = proj * vec4(posView, 1.0);\n      // Apply screen offset to both start and end point\n      vec2 screenOffsetNorm = screenOffsetScaled * 2.0 / viewport.zw;\n      startPoint.xy += screenOffsetNorm * startPoint.w;\n      endPoint.xy += screenOffsetNorm * endPoint.w;\n      // Align start and end to pixel origin\n      vec4 startAligned = alignToPixelOrigin(startPoint, viewport.zw);\n      vec4 endAligned = alignToPixelOrigin(endPoint, viewport.zw);\n    ","\n      vec4 projectedPosition = mix(startAligned, endAligned, uv0.y);\n      // The direction of the line in screen space\n      vec2 screenSpaceDirection = normalize(endAligned.xy / endAligned.w - startAligned.xy / startAligned.w);\n      vec2 perpendicularScreenSpaceDirection = vec2(screenSpaceDirection.y, -screenSpaceDirection.x);\n    ","\n      float halfPixelSize = lineSizeScaled * 0.5;\n\n      // Compute full ndc offset, adding 1px padding for doing anti-aliasing and the border size\n      float padding = 1.0 + borderSizeScaled;\n      vec2 ndcOffset = (-halfPixelSize - padding + uv0.x * (lineSizeScaled + padding + padding)) * pixelToNDC;\n\n      // Offset x/y from the center of the line in screen space\n      projectedPosition.xy += perpendicularScreenSpaceDirection * ndcOffset * projectedPosition.w;\n\n      // Compute a coverage varying which we can use in the fragment shader to determine\n      // how much a pixel is actually covered by the line (i.e. to anti alias the line).\n      // This works by computing two coordinates that can be linearly interpolated and then\n      // subtracted to find out how far away from the line edge we are.\n      float edgeDirection = (uv0.x * 2.0 - 1.0);\n\n      float halfBorderSize = 0.5 * borderSizeScaled;\n      float halfPixelSizeAndBorder = halfPixelSize + halfBorderSize;\n      float outerEdgeCoverageSampler = edgeDirection * (halfPixelSizeAndBorder + halfBorderSize + 1.0);\n\n      float isOneSided = float(lineSizeScaled < 2.0 && borderSize < 2.0);\n\n      coverageSampling = vec4(\n        // Edge coordinate\n        outerEdgeCoverageSampler,\n\n        // Border edge coordinate\n        outerEdgeCoverageSampler - halfPixelSizeAndBorder * isOneSided,\n\n        // Line offset\n        halfPixelSize - 0.5,\n\n        // Border offset\n        halfBorderSize - 0.5 + halfPixelSizeAndBorder * (1.0 - isOneSided)\n      );\n\n      lineSizes = vec2(lineSizeScaled, borderSizeScaled);\n\n      gl_Position = projectedPosition;\n    }\n  "])),e.occlusionTestEnabled?(0,E.H)(n||(n=(0,f.A)(["\n      if (!testHUDVisibility(endPoint)) {\n        gl_Position = vec4(1e38, 1e38, 1e38, 1.0);\n        return;\n      }"]))):"",e.hasScreenSizePerspective?(0,E.H)(s||(s=(0,f.A)(["\n      vec3 perspectiveFactor = screenSizePerspectiveScaleFactor(projectAux.absCosAngle, projectAux.distanceToCamera, screenSizePerspectiveAlignment);\n      vec2 screenOffsetScaled = applyScreenSizePerspectiveScaleFactorVec2(screenOffset, perspectiveFactor);\n        "]))):(0,E.H)(a||(a=(0,f.A)(["vec2 screenOffsetScaled = screenOffset;"]))),e.multipassEnabled?"depth = posView.z;":"",e.depthHudEnabled?e.depthHudAlignStartEnabled?(0,E.H)(o||(o=(0,f.A)(["endAligned = vec4(endAligned.xy / endAligned.w * startAligned.w, startAligned.zw);"]))):(0,E.H)(l||(l=(0,f.A)(["startAligned = vec4(startAligned.xy / startAligned.w * endAligned.w, endAligned.zw);"]))):"",e.hasScreenSizePerspective?(0,E.H)(c||(c=(0,f.A)(["\n      float lineSizeScaled = applyScreenSizePerspectiveScaleFactorFloat(lineSize, perspectiveFactor);\n      float borderSizeScaled = applyScreenSizePerspectiveScaleFactorFloat(borderSize, perspectiveFactor);\n        "]))):(0,E.H)(d||(d=(0,f.A)(["\n      float lineSizeScaled = lineSize;\n      float borderSizeScaled = borderSize;\n        "]))))),m.uniforms.add(new A.E("uColor",(e=>M(e.color))),new A.E("borderColor",(e=>M(e.borderColor)))),e.multipassEnabled&&(m.include(S.H,e),m.uniforms.add(new C.G("inverseViewport",((e,t)=>t.inverseViewport)))),m.code.add((0,E.H)(h||(h=(0,f.A)(["\n    void main() {\n      ","\n\n      // Mix between line and border coverage offsets depending on whether we need\n      // a border (based on the sidedness).\n      vec2 coverage = min(1.0 - clamp(abs(coverageSampling.xy) - coverageSampling.zw, 0.0, 1.0), lineSizes);\n\n      // Mix between border and line color based on the line coverage (conceptually the line blends on top of the\n      // border background).\n      //\n      // Anti-alias by blending final result using the full (including optional border) coverage and the color alpha\n      float borderAlpha = uColor.a * borderColor.a * coverage.y;\n      float colorAlpha = uColor.a * coverage.x;\n\n      float finalAlpha = mix(borderAlpha, 1.0, colorAlpha);\n\n    ","\n  }\n  "])),e.multipassEnabled?"if( geometryDepthTest(gl_FragCoord.xy * inverseViewport, depth) ){ discard; }":"",e.depthHudEnabled?(0,E.H)(u||(u=(0,f.A)(["\n      if (finalAlpha < 0.01) {\n        discard;\n      }\n      "]))):(0,E.H)(p||(p=(0,f.A)(["\n      vec3 finalRgb = mix(borderColor.rgb * borderAlpha, uColor.rgb, colorAlpha);\n      fragColor = vec4(finalRgb, finalAlpha);\n      "]))))),t}function M(e){return null!=e?e:_.uY}const I=(0,m.vt)(),D=Object.freeze(Object.defineProperty({__proto__:null,build:P},Symbol.toStringTag,{value:"Module"}))},88849:(e,t,i)=>{i.d(t,{L:()=>J,b:()=>Q});var r,n,s,a,o,l,c,d,h,u,p,f,g,m,_,v,y,b,x,S,w,C,A=i(57528),R=i(99443),E=i(72412),O=i(34981),T=i(26917),P=i(3838),M=i(49399),I=i(17698),D=i(81993),L=i(90235),F=i(80883),N=i(81449),V=i(42451),G=i(95756),U=i(58350),z=i(21390),B=i(64839),H=i(43425),j=i(32307),W=i(70367),k=i(10773),Z=i(66470),q=i(50125);function Q(e){const t=new j.N5,i=e.multipassEnabled&&(e.output===O.V.Color||e.output===O.V.Alpha),Q=e.space===q.lM.World;t.include(P.s,e),t.include(I.r,e),e.output===O.V.LinearDepth&&t.include(M.L,e);const{vertex:J,fragment:Y}=t;return Y.include(N.W),(0,V.NB)(J,e),t.attributes.add(Z.r.POSITION,"vec3"),t.attributes.add(Z.r.PREVPOSITION,"vec3"),t.attributes.add(Z.r.UV0,"vec2"),t.varyings.add("vColor","vec4"),t.varyings.add("vpos","vec3"),t.varyings.add("vUV","vec2"),t.varyings.add("vSize","float"),(0,E.Mu)(t),i&&t.varyings.add("depth","float"),e.hasTip&&t.varyings.add("vLineWidth","float"),J.uniforms.add(new G.G("nearFar",((e,t)=>t.camera.nearFar)),new U.E("viewport",((e,t)=>t.camera.fullViewport))),J.code.add((0,B.H)(r||(r=(0,A.A)(["vec4 projectAndScale(vec4 pos) {\nvec4 posNdc = proj * pos;\nposNdc.xy *= viewport.zw / posNdc.w;\nreturn posNdc;\n}"])))),J.code.add((0,B.H)(n||(n=(0,A.A)(["void clip(vec4 pos, inout vec4 prev) {\nfloat vnp = nearFar[0] * 0.99;\nif (prev.z > -nearFar[0]) {\nfloat interpolation = (-vnp - pos.z) / (prev.z - pos.z);\nprev = mix(pos, prev, interpolation);\n}\n}"])))),Q?(t.attributes.add(Z.r.NORMAL,"vec3"),(0,V.S7)(J),J.constants.add("tiltThreshold","float",.7),J.code.add((0,B.H)(s||(s=(0,A.A)(["vec3 perpendicular(vec3 v) {\nvec3 n = (viewNormal * vec4(normal.xyz, 1.0)).xyz;\nvec3 n2 = cross(v, n);\nvec3 forward = vec3(0.0, 0.0, 1.0);\nfloat tiltDot = dot(forward, n);\nreturn abs(tiltDot) < tiltThreshold ? n : n2;\n}"]))))):J.code.add((0,B.H)(a||(a=(0,A.A)(["vec2 perpendicular(vec2 v) {\nreturn vec2(v.y, -v.x);\n}"])))),J.code.add((0,B.H)(o||(o=(0,A.A)(["\n      #define vecN ","\n\n      vecN normalizedSegment(vecN pos, vecN prev) {\n        vecN segment = pos - prev;\n        float segmentLen = length(segment);\n\n        // normalize or zero if too short\n        return (segmentLen > 0.001) ? segment / segmentLen : ",";\n      }\n\n      vecN displace(vecN pos, vecN prev, float displacementLen) {\n        vecN segment = normalizedSegment(pos, prev);\n\n        vecN displacementDirU = perpendicular(segment);\n        vecN displacementDirV = segment;\n\n        ","\n\n        return pos + displacementLen * (uv0.x * displacementDirU + uv0.y * displacementDirV);\n      }\n    "])),Q?"vec3":"vec2",Q?"vec3(0.0, 0.0, 0.0)":"vec2(0.0, 0.0)",e.anchor===q.kJ.Tip?"pos -= 0.5 * displacementLen * displacementDirV;":"")),e.space===q.lM.Screen&&(J.uniforms.add(new H.X("inverseProjectionMatrix",((e,t)=>t.camera.inverseProjectionMatrix))),J.code.add((0,B.H)(l||(l=(0,A.A)(["vec3 inverseProject(vec4 posScreen) {\nposScreen.xy = (posScreen.xy / viewport.zw) * posScreen.w;\nreturn (inverseProjectionMatrix * posScreen).xyz;\n}"])))),J.code.add((0,B.H)(c||(c=(0,A.A)(["bool rayIntersectPlane(vec3 rayDir, vec3 planeOrigin, vec3 planeNormal, out vec3 intersection) {\nfloat cos = dot(rayDir, planeNormal);\nfloat t = dot(planeOrigin, planeNormal) / cos;\nintersection = t * rayDir;\nreturn abs(cos) > 0.001 && t > 0.0;\n}"])))),J.uniforms.add(new z.m("perScreenPixelRatio",((e,t)=>t.camera.perScreenPixelRatio))),J.code.add((0,B.H)(d||(d=(0,A.A)(["\n      vec4 toFront(vec4 displacedPosScreen, vec3 posLeft, vec3 posRight, vec3 prev, float lineWidth) {\n        // Project displaced position back to camera space\n        vec3 displacedPos = inverseProject(displacedPosScreen);\n\n        // Calculate the plane that we want the marker to lie in. Note that this will always be an approximation since ribbon lines are generally\n        // not planar and we do not know the actual position of the displaced prev vertices (they are offset in screen space, too).\n        vec3 planeNormal = normalize(cross(posLeft - posRight, posLeft - prev));\n        vec3 planeOrigin = posLeft;\n\n        ",";\n\n        // Move the plane towards the camera by a margin dependent on the line width (approximated in world space). This tolerance corrects for the\n        // non-planarity in most cases, but sharp joins can place the prev vertices at arbitrary positions so markers can still clip.\n        float offset = lineWidth * perScreenPixelRatio;\n        planeOrigin *= (1.0 - offset);\n\n        // Intersect camera ray with the plane and make sure it is within clip space\n        vec3 rayDir = normalize(displacedPos);\n        vec3 intersection;\n        if (rayIntersectPlane(rayDir, planeOrigin, planeNormal, intersection) && intersection.z < -nearFar[0] && intersection.z > -nearFar[1]) {\n          return vec4(intersection.xyz, 1.0);\n        }\n\n        // Fallback: use depth of pos or prev, whichever is closer to the camera\n        float minDepth = planeOrigin.z > prev.z ? length(planeOrigin) : length(prev);\n        displacedPos *= minDepth / length(displacedPos);\n        return vec4(displacedPos.xyz, 1.0);\n      }\n  "])),e.hasCap?"\n                if(prev.z > posLeft.z) {\n                  vec2 diff = posLeft.xy - posRight.xy;\n                  planeOrigin.xy += perpendicular(diff) / 2.0;\n                }\n              ":""))),(0,V.Nz)(J),(0,E.i$)(t),J.code.add((0,B.H)(h||(h=(0,A.A)(["void main(void) {\nif (uv0.y == 0.0) {\ngl_Position = vec4(1e038, 1e038, 1e038, 1.0);\n}\nelse {\nfloat lineWidth = getLineWidth();\nfloat screenMarkerSize = getScreenMarkerSize();\nvec4 pos  = view * vec4(position, 1.0);\nvec4 prev = view * vec4(prevPosition, 1.0);\nclip(pos, prev);"])))),Q?(e.hideOnShortSegments&&J.code.add((0,B.H)(u||(u=(0,A.A)(["if (areWorldMarkersHidden(pos, prev)) {\ngl_Position = vec4(1e038, 1e038, 1e038, 1.0);\nreturn;\n}"])))),J.code.add((0,B.H)(p||(p=(0,A.A)(["pos.xyz = displace(pos.xyz, prev.xyz, getWorldMarkerSize(pos));\nvec4 displacedPosScreen = projectAndScale(pos);"]))))):(J.code.add((0,B.H)(f||(f=(0,A.A)(["vec4 posScreen = projectAndScale(pos);\nvec4 prevScreen = projectAndScale(prev);\nvec4 displacedPosScreen = posScreen;\ndisplacedPosScreen.xy = displace(posScreen.xy, prevScreen.xy, screenMarkerSize);"])))),e.space===q.lM.Screen&&J.code.add((0,B.H)(g||(g=(0,A.A)(["vec2 displacementDirU = perpendicular(normalizedSegment(posScreen.xy, prevScreen.xy));\nvec3 lineRight = inverseProject(posScreen + lineWidth * vec4(displacementDirU.xy, 0.0, 0.0));\nvec3 lineLeft = pos.xyz + (pos.xyz - lineRight);\npos = toFront(displacedPosScreen, lineLeft, lineRight, prev.xyz, lineWidth);\ndisplacedPosScreen = projectAndScale(pos);"]))))),J.code.add((0,B.H)(m||(m=(0,A.A)(["\n        ","\n        linearDepth = calculateLinearDepth(nearFar,pos.z);\n\n        // Convert back into NDC\n        displacedPosScreen.xy = (displacedPosScreen.xy / viewport.zw) * displacedPosScreen.w;\n\n        // Convert texture coordinate into [0,1]\n        vUV = (uv0 + 1.0) / 2.0;\n\n        ","\n\n        ","\n\n        vSize = screenMarkerSize;\n        vColor = getColor();\n\n        // Use camera space for slicing\n        vpos = pos.xyz;\n\n        gl_Position = displacedPosScreen;\n      }\n    }\n  "])),i?"depth = pos.z;":"",Q?"":"vUV *= displacedPosScreen.w;",e.hasTip?"vLineWidth = lineWidth;":"")),i&&t.include(D.Q,e),t.include(T.HQ,e),Y.uniforms.add(new U.E("intrinsicColor",(e=>e.color)),new W.N("tex",(e=>e.markerTexture))),Y.include(F.a),t.constants.add("texelSize","float",1/R.vO),Y.code.add((0,B.H)(_||(_=(0,A.A)(["float markerAlpha(vec2 samplePos) {\nsamplePos += vec2(0.5, -0.5) * texelSize;\nfloat sdf = rgba2float(texture(tex, samplePos)) - 0.5;\nfloat distance = sdf * vSize;\ndistance -= 0.5;\nreturn clamp(0.5 - distance, 0.0, 1.0);\n}"])))),e.hasTip&&(t.constants.add("relativeMarkerSize","float",R.Cz/R.vO),t.constants.add("relativeTipLineWidth","float",R.DZ),Y.code.add((0,B.H)(v||(v=(0,A.A)(["\n    float tipAlpha(vec2 samplePos) {\n      // Convert coordinates s.t. they are in pixels and relative to the tip of an arrow marker\n      samplePos -= vec2(0.5, 0.5 + 0.5 * relativeMarkerSize);\n      samplePos *= vSize;\n\n      float halfMarkerSize = 0.5 * relativeMarkerSize * vSize;\n      float halfTipLineWidth = 0.5 * max(1.0, relativeTipLineWidth * vLineWidth);\n\n      ","\n\n      float distance = max(abs(samplePos.x) - halfMarkerSize, abs(samplePos.y) - halfTipLineWidth);\n      return clamp(0.5 - distance, 0.0, 1.0);\n    }\n  "])),Q?"halfTipLineWidth *= fwidth(samplePos.y);":""))),t.constants.add("symbolAlphaCutoff","float",L.y),Y.code.add((0,B.H)(y||(y=(0,A.A)(["\n  void main() {\n    discardBySlice(vpos);\n    ","\n\n    vec4 finalColor = intrinsicColor * vColor;\n\n    ","\n\n    ","\n\n    ","\n\n    if (finalColor.a < symbolAlphaCutoff) {\n      discard;\n    }\n\n    ","\n    ","\n    ","\n    ","\n    ","\n  }\n  "])),i?"terrainDepthTest(depth);":"",Q?"vec2 samplePos = vUV;":"vec2 samplePos = vUV * gl_FragCoord.w;",e.hasTip?"finalColor.a *= max(markerAlpha(samplePos), tipAlpha(samplePos));":"finalColor.a *= markerAlpha(samplePos);",e.output===O.V.ObjectAndLayerIdColor?(0,B.H)(b||(b=(0,A.A)(["finalColor.a = 1.0;"]))):"",e.output===O.V.Alpha?(0,B.H)(x||(x=(0,A.A)(["fragColor = vec4(finalColor.a);"]))):"",e.output===O.V.Color?(0,B.H)(S||(S=(0,A.A)(["fragColor = highlightSlice(finalColor, vpos);"]))):"",e.output===O.V.Color&&e.transparencyPassType===k.y.Color?"fragColor = premultiplyAlpha(fragColor);":"",e.output===O.V.Highlight?(0,B.H)(w||(w=(0,A.A)(["fragColor = vec4(1.0);"]))):"",e.output===O.V.LinearDepth?(0,B.H)(C||(C=(0,A.A)(["outputDepth(linearDepth);"]))):"")),t}const J=Object.freeze(Object.defineProperty({__proto__:null,build:Q},Symbol.toStringTag,{value:"Module"}))},34026:(e,t,i)=>{i.d(t,{N:()=>S,b:()=>x});var r,n,s,a,o,l=i(57528),c=i(34981),d=i(26917),h=i(59395),u=i(54478),p=i(48020),f=i(90235),g=i(42451),m=i(58350),_=i(21390),v=i(64839),y=i(32307),b=i(66470);function x(e){const t=new y.N5,{vertex:i,fragment:x}=t;return t.include(h.d,e),t.include(u.c,e),(0,g.NB)(i,e),t.attributes.add(b.r.POSITION,"vec3"),t.varyings.add("vpos","vec3"),i.code.add((0,v.H)(r||(r=(0,l.A)(["void main(void) {\nvpos = position;\nforwardNormalizedVertexColor();\ngl_Position = transformPosition(proj, view, vpos);\n}"])))),e.output===c.V.Highlight&&t.include(p.Qh,e),t.include(d.HQ,e),x.uniforms.add(new _.m("alphaCoverage",((e,t)=>Math.min(1,e.width*t.camera.pixelRatio)))),e.hasVertexColors||x.uniforms.add(new m.E("constantColor",(e=>e.color))),x.code.add((0,v.H)(n||(n=(0,l.A)(["\n  void main() {\n    discardBySlice(vpos);\n\n    vec4 color = ",";\n\n    ","\n\n    if (color.a < ",") {\n      discard;\n    }\n\n    ","\n    ","\n  }\n  "])),e.hasVertexColors?"vColor":"constantColor",e.output===c.V.ObjectAndLayerIdColor?(0,v.H)(s||(s=(0,l.A)(["color.a = 1.0;"]))):"",v.H.float(f.y),e.output===c.V.Color?(0,v.H)(a||(a=(0,l.A)(["fragColor = highlightSlice(color, vpos);"]))):"",e.output===c.V.Highlight?(0,v.H)(o||(o=(0,l.A)(["outputHighlight();"]))):"")),t}const S=Object.freeze(Object.defineProperty({__proto__:null,build:x},Symbol.toStringTag,{value:"Module"}))},80381:(e,t,i)=>{i.d(t,{O:()=>u,a:()=>f,b:()=>p});var r,n=i(57528),s=i(19539),a=i(73398),o=i(21390),l=i(72790),c=i(64839),d=i(32307),h=i(70367);class u extends c.Y{constructor(){super(...arguments),this.overlayIndex=s.vr.INNER,this.opacity=1}}function p(){const e=new d.N5;return e.include(a.c),e.fragment.uniforms.add(new h.N("tex",(e=>e.texture))),e.fragment.uniforms.add(new l.c("overlayIdx",(e=>e.overlayIndex))),e.fragment.uniforms.add(new o.m("opacity",(e=>e.opacity))),e.fragment.code.add((0,c.H)(r||(r=(0,n.A)(["void main() {\nvec2 overlayUV = overlayIdx == 0 ? vec2(uv.x * 0.5, uv.y) : vec2(uv.x * 0.5 + 0.5, uv.y);\nfragColor = texture(tex, overlayUV) * opacity;\n}"])))),e}const f=Object.freeze(Object.defineProperty({__proto__:null,OverlayCompositingPassParameters:u,build:p},Symbol.toStringTag,{value:"Module"}))},91116:(e,t,i)=>{i.d(t,{P:()=>F,b:()=>L});var r,n,s,a,o,l,c,d,h,u=i(57528),p=i(72412),f=i(34981),g=i(26917),m=i(59395),_=i(85887),v=i(49399),y=i(48020),b=i(28790),x=i(67799),S=i(43557),w=i(81993),C=i(27920),A=i(2260),R=i(1773),E=i(80883),O=i(42451),T=i(5517),P=i(21390),M=i(64839),I=i(32307),D=i(10773);function L(e){const t=new I.N5,{vertex:i,fragment:L}=t;switch((0,O.NB)(i,e),t.varyings.add("vpos","vec3"),t.include(_.H,e),e.output!==f.V.Color&&e.output!==f.V.Alpha||(t.include(m.d,e),t.include(R.Bz,e),t.include(p.oD,e),t.varyings.add("vnormal","vec3"),t.varyings.add("vcolor","vec4"),e.multipassEnabled&&t.varyings.add("depth","float"),i.code.add((0,M.H)(r||(r=(0,u.A)(["\n      void main() {\n        vpos = calculateVPos();\n        vnormal = normalize(localNormal());\n\n        ","\n        gl_Position = transformPosition(proj, view, vpos);\n\n        ","\n\n        vcolor = getColor();\n      }\n    "])),e.multipassEnabled?"depth = (view * vec4(vpos, 1.0)).z;":"",e.output===f.V.Color?"forwardLinearDepth();":""))),t.include(w.Q,e),e.output){case f.V.Alpha:t.include(g.HQ,e),L.uniforms.add(new P.m("opacity",(e=>e.opacity))),L.code.add((0,M.H)(n||(n=(0,u.A)(["\n      void main() {\n        discardBySlice(vpos);\n        ","\n        float combinedOpacity = vcolor.a * opacity;\n        fragColor = vec4(combinedOpacity);\n      }\n    "])),e.multipassEnabled?"terrainDepthTest(depth);":""));break;case f.V.Color:t.include(g.HQ,e),t.include(x.kA,e),t.include(b.n,e),t.include(R.Bz,e),t.include(C.r,e),(0,O.yu)(L,e),(0,x.a8)(L),(0,x.eU)(L),L.uniforms.add(i.uniforms.get("localOrigin"),new T.t("ambient",(e=>e.ambient)),new T.t("diffuse",(e=>e.diffuse)),new T.t("specular",(e=>e.specular)),new P.m("opacity",(e=>e.opacity))),L.include(E.a),(0,S.O4)(L),L.code.add((0,M.H)(s||(s=(0,u.A)(["\n        void main() {\n          discardBySlice(vpos);\n          ","\n\n          shadingParams.viewDirection = normalize(vpos - cameraPosition);\n          shadingParams.normalView = vnormal;\n          vec3 normal = shadingNormal(shadingParams);\n          float ssao = evaluateAmbientOcclusionInverse();\n\n          float additionalAmbientScale = additionalDirectedAmbientLight(vpos + localOrigin);\n          vec3 additionalLight = ssao * mainLightIntensity * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor;\n          ","\n          vec3 albedo = vcolor.rgb * max(ambient, diffuse); // combine the old material parameters into a single one\n          float combinedOpacity = vcolor.a * opacity;\n          albedo += 0.25 * specular; // don't completely ignore specular for now\n\n          vec3 shadedColor = evaluateSceneLighting(normal, albedo, shadow, 1.0 - ssao, additionalLight);\n          fragColor = vec4(shadedColor, combinedOpacity);\n          fragColor = highlightSlice(fragColor, vpos);\n          ","\n        }\n      "])),e.multipassEnabled?"terrainDepthTest(depth);":"",e.receiveShadows?"float shadow = readShadowMap(vpos, linearDepth);":e.spherical?"float shadow = lightingGlobalFactor * (1.0 - additionalAmbientScale);":"float shadow = 0.0;",e.transparencyPassType===D.y.Color?"fragColor = premultiplyAlpha(fragColor);":""));break;case f.V.LinearDepth:case f.V.Shadow:case f.V.ShadowHighlight:case f.V.ShadowExcludeHighlight:t.include(m.d,e),(0,p.xJ)(t),t.varyings.add("depth","float"),i.code.add((0,M.H)(a||(a=(0,u.A)(["void main() {\nvpos = calculateVPos();\ngl_Position = transformPositionWithDepth(proj, view, vpos, nearFar, depth);\n}"])))),t.include(g.HQ,e),t.include(v.L,e),L.code.add((0,M.H)(o||(o=(0,u.A)(["void main() {\ndiscardBySlice(vpos);\noutputDepth(depth);\n}"]))));break;case f.V.Normal:t.include(m.d,e),t.include(A.n,e),(0,O.S7)(i),t.varyings.add("vnormal","vec3"),i.code.add((0,M.H)(l||(l=(0,u.A)(["void main(void) {\nvpos = calculateVPos();\nvnormal = normalize((viewNormal * vec4(localNormal(), 1.0)).xyz);\ngl_Position = transformPosition(proj, view, vpos);\n}"])))),t.include(g.HQ,e),L.code.add((0,M.H)(c||(c=(0,u.A)(["void main() {\ndiscardBySlice(vpos);\nvec3 normal = normalize(vnormal);\nif (gl_FrontFacing == false) normal = -normal;\nfragColor = vec4(vec3(0.5) + 0.5 * normal, 1.0);\n}"]))));break;case f.V.Highlight:t.include(m.d,e),t.include(A.n,e),t.varyings.add("vnormal","vec3"),i.code.add((0,M.H)(d||(d=(0,u.A)(["void main(void) {\nvpos = calculateVPos();\ngl_Position = transformPosition(proj, view, vpos);\n}"])))),t.include(g.HQ,e),t.include(y.Qh,e),L.code.add((0,M.H)(h||(h=(0,u.A)(["void main() {\ndiscardBySlice(vpos);\noutputHighlight();\n}"]))))}return t}const F=Object.freeze(Object.defineProperty({__proto__:null,build:L},Symbol.toStringTag,{value:"Module"}))},58071:(e,t,i)=>{i.d(t,{P:()=>Y,b:()=>J});var r,n,s,a,o,l,c,d,h,u,p,f,g,m,_,v,y,b,x,S,w,C,A=i(57528),R=i(72412),E=i(34981),O=i(26917),T=i(59395),P=i(90080),M=i(54478),I=i(49399),D=i(48020),L=i(81993),F=i(66763),N=i(90235),V=i(80883),G=i(42451),U=i(58350),z=i(21390),B=i(64839),H=i(32307),j=i(10773),W=i(66470),k=i(30250);const Z=.70710678118,q=Z,Q=.08715574274;function J(e){const t=new H.N5,i=e.multipassEnabled&&(e.output===E.V.Color||e.output===E.V.Alpha),{vertex:J,fragment:Y,attributes:X,varyings:$}=t;(0,G.NB)(J,e),t.include(T.d,e),t.include(M.c,e),t.include(F.A,e),t.include(P.g,e),e.draped?J.uniforms.add(new z.m("worldToScreenRatio",((e,t)=>1/t.screenToPCSRatio))):X.add(W.r.BOUNDINGRECT,"mat3"),X.add(W.r.POSITION,"vec3"),X.add(W.r.UVMAPSPACE,"vec4"),e.vvColor&&X.add(W.r.COLORFEATUREATTRIBUTE,"float"),$.add("vColor","vec4"),$.add("vpos","vec3"),$.add("vuv","vec2"),i&&$.add("depth","float"),J.uniforms.add(new U.E("uColor",(e=>e.color)));const K=e.style===k.O.ForwardDiagonal||e.style===k.O.BackwardDiagonal||e.style===k.O.DiagonalCross;K&&J.code.add((0,B.H)(r||(r=(0,A.A)(["\n      const mat2 rotate45 = mat2(",", ",",\n                                 ",", ",");\n    "])),B.H.float(Z),B.H.float(-q),B.H.float(q),B.H.float(Z))),e.draped||((0,G.yu)(J,e),J.uniforms.add(new z.m("worldToScreenPerDistanceRatio",((e,t)=>1/t.camera.perScreenPixelRatio))),J.code.add((0,B.H)(n||(n=(0,A.A)(["vec3 projectPointToLineSegment(vec3 center, vec3 halfVector, vec3 point) {\nfloat projectedLength = dot(halfVector, point - center) / dot(halfVector, halfVector);\nreturn center + halfVector * clamp(projectedLength, -1.0, 1.0);\n}"])))),J.code.add((0,B.H)(s||(s=(0,A.A)(["vec3 intersectRayPlane(vec3 rayDir, vec3 rayOrigin, vec3 planeNormal, vec3 planePoint) {\nfloat d = dot(planeNormal, planePoint);\nfloat t = (d - dot(planeNormal, rayOrigin)) / dot(planeNormal, rayDir);\nreturn rayOrigin + t * rayDir;\n}"])))),J.code.add((0,B.H)(a||(a=(0,A.A)(["\n      float boundingRectDistanceToCamera() {\n        vec3 center = vec3(boundingRect[0][0], boundingRect[0][1], boundingRect[0][2]);\n        vec3 halfU = vec3(boundingRect[1][0], boundingRect[1][1], boundingRect[1][2]);\n        vec3 halfV = vec3(boundingRect[2][0], boundingRect[2][1], boundingRect[2][2]);\n        vec3 n = normalize(cross(halfU, halfV));\n\n        vec3 viewDir = - vec3(view[0][2], view[1][2], view[2][2]);\n\n        float viewAngle = dot(viewDir, n);\n        float minViewAngle = ",";\n\n        if (abs(viewAngle) < minViewAngle) {\n          // view direction is (almost) parallel to plane -> clamp it to min angle\n          float normalComponent = sign(viewAngle) * minViewAngle - viewAngle;\n          viewDir = normalize(viewDir + normalComponent * n);\n        }\n\n        // intersect view direction with infinite plane that contains bounding rect\n        vec3 planeProjected = intersectRayPlane(viewDir, cameraPosition, n, center);\n\n        // clip to bounds by projecting to u and v line segments individually\n        vec3 uProjected = projectPointToLineSegment(center, halfU, planeProjected);\n        vec3 vProjected = projectPointToLineSegment(center, halfV, planeProjected);\n\n        // use to calculate the closest point to camera on bounding rect\n        vec3 closestPoint = uProjected + vProjected - center;\n\n        return length(closestPoint - cameraPosition);\n      }\n    "])),B.H.float(Q)))),J.code.add((0,B.H)(o||(o=(0,A.A)(["\n    vec2 scaledUV() {\n      vec2 uv = uvMapSpace.xy ",";\n      vec2 uvCellOrigin = uvMapSpace.zw ",";\n\n      ","\n\n      // Logarithmically discretize ratio to avoid jittering\n      float step = 0.1;\n      float discreteWorldToScreenRatio = log(worldToScreenRatio);\n      discreteWorldToScreenRatio = ceil(discreteWorldToScreenRatio / step) * step;\n      discreteWorldToScreenRatio = exp(discreteWorldToScreenRatio);\n\n      vec2 uvOffset = mod(uvCellOrigin * discreteWorldToScreenRatio, ",");\n      return uvOffset + (uv * discreteWorldToScreenRatio);\n    }\n  "])),K?" * rotate45":"",K?" * rotate45":"",e.draped?"":(0,B.H)(l||(l=(0,A.A)(["\n            float distanceToCamera = boundingRectDistanceToCamera();\n            float worldToScreenRatio = worldToScreenPerDistanceRatio / distanceToCamera;\n          "]))),B.H.float(e.patternSpacing)));const ee=e.output===E.V.LinearDepth;return ee&&(t.include(I.L,e),(0,R.xJ)(t),(0,R.Mu)(t)),J.code.add((0,B.H)(c||(c=(0,A.A)(["\n    void main(void) {\n      vuv = scaledUV();\n      vpos = position;\n      ","\n      forwardNormalizedVertexColor();\n      forwardObjectAndLayerIdColor();\n      ","\n      gl_Position = ","\n    }\n  "])),i?"depth = (view * vec4(vpos, 1.0)).z;":"",e.hasVertexColors?"vColor *= uColor;":e.vvColor?"vColor = uColor * interpolateVVColor(colorFeatureAttribute);":"vColor = uColor;",ee?(0,B.H)(d||(d=(0,A.A)(["transformPositionWithDepth(proj, view, vpos, nearFar, linearDepth);"]))):(0,B.H)(h||(h=(0,A.A)(["transformPosition(proj, view, vpos);"]))))),t.include(O.HQ,e),Y.include(V.a),e.draped&&Y.uniforms.add(new z.m("texelSize",((e,t)=>1/t.camera.pixelRatio))),e.output===E.V.Highlight&&t.include(D.Qh,e),i&&t.include(L.Q,e),e.output!==E.V.Highlight&&(Y.code.add((0,B.H)(u||(u=(0,A.A)(["\n      const float lineWidth = ",";\n      const float spacing = ",";\n      const float spacingINV = ",";\n\n      float coverage(float p, float txlSize) {\n        p = mod(p, spacing);\n\n        float halfTxlSize = txlSize / 2.0;\n\n        float start = p - halfTxlSize;\n        float end = p + halfTxlSize;\n\n        float coverage = (ceil(end * spacingINV) - floor(start * spacingINV)) * lineWidth;\n        coverage -= min(lineWidth, mod(start, spacing));\n        coverage -= max(lineWidth - mod(end, spacing), 0.0);\n\n        return coverage / txlSize;\n      }\n    "])),B.H.float(e.lineWidth),B.H.float(e.patternSpacing),B.H.float(1/e.patternSpacing))),e.draped||Y.code.add((0,B.H)(p||(p=(0,A.A)(["const int maxSamples = 5;\nfloat sampleAA(float p) {\nvec2 dxdy = abs(vec2(dFdx(p), dFdy(p)));\nfloat fwidth = dxdy.x + dxdy.y;\nivec2 samples = 1 + ivec2(clamp(dxdy, 0.0, float(maxSamples - 1)));\nvec2 invSamples = 1.0 / vec2(samples);\nfloat accumulator = 0.0;\nfor (int j = 0; j < maxSamples; j++) {\nif(j >= samples.y) {\nbreak;\n}\nfor (int i = 0; i < maxSamples; i++) {\nif(i >= samples.x) {\nbreak;\n}\nvec2 step = vec2(i,j) * invSamples - 0.5;\naccumulator += coverage(p + step.x * dxdy.x + step.y * dxdy.y, fwidth);\n}\n}\naccumulator /= float(samples.x * samples.y);\nreturn accumulator;\n}"]))))),Y.code.add((0,B.H)(f||(f=(0,A.A)(["\n    void main() {\n      discardBySlice(vpos);\n      ","\n      vec4 color = vColor;\n      color = highlightSlice(color, vpos);\n\n      ","\n\n      ","\n\n      if (color.a < ",") {\n        discard;\n      }\n\n      ","\n\n      ","\n      ","\n      ",";\n      ","\n    }\n  "])),i?"terrainDepthTest(depth);":"",e.output!==E.V.Highlight?(0,B.H)(g||(g=(0,A.A)(["color.a *= ",";"])),function(e){function t(t){return e.draped?(0,B.H)(S||(S=(0,A.A)(["coverage(vuv.",", texelSize)"])),t):(0,B.H)(w||(w=(0,A.A)(["sampleAA(vuv.",")"])),t)}switch(e.style){case k.O.ForwardDiagonal:case k.O.Horizontal:return t("y");case k.O.BackwardDiagonal:case k.O.Vertical:return t("x");case k.O.DiagonalCross:case k.O.Cross:return(0,B.H)(C||(C=(0,A.A)(["\n        1.0 - (1.0 - ",") * (1.0 - ",")\n      "])),t("x"),t("y"));default:return"0.0"}}(e)):"",e.output===E.V.ObjectAndLayerIdColor?(0,B.H)(m||(m=(0,A.A)(["color.a = 1.0;"]))):"",B.H.float(N.y),e.output===E.V.Alpha?(0,B.H)(_||(_=(0,A.A)(["fragColor = vec4(color.a);"]))):"",e.output===E.V.Color?(0,B.H)(v||(v=(0,A.A)(["fragColor = color; ",""])),e.transparencyPassType===j.y.Color?"fragColor = premultiplyAlpha(fragColor);":""):"",e.output===E.V.Highlight?(0,B.H)(y||(y=(0,A.A)(["outputHighlight();"]))):"",e.output===E.V.LinearDepth?(0,B.H)(b||(b=(0,A.A)(["outputDepth(linearDepth);"]))):"",e.output===E.V.ObjectAndLayerIdColor?(0,B.H)(x||(x=(0,A.A)(["outputObjectAndLayerIdColor();"]))):"")),t}const Y=Object.freeze(Object.defineProperty({__proto__:null,build:J},Symbol.toStringTag,{value:"Module"}))},14623:(e,t,i)=>{i.d(t,{R:()=>ve,b:()=>_e,r:()=>me});var r,n,s,a,o,l,c,d,h,u,p,f,g,m,_,v,y,b,x,S,w,C,A,R,E,O,T,P,M,I,D,L,F,N,V,G,U,z,B,H,j,W,k,Z=i(57528),q=i(72412),Q=i(34981),J=i(26917),Y=i(90080),X=i(3838),$=i(49399),K=i(56906),ee=i(17698),te=i(81993),ie=i(36324),re=i(90235),ne=i(80883),se=i(42451),ae=i(95756),oe=i(58350),le=i(21390),ce=i(64839),de=i(43425),he=i(32307),ue=i(10773),pe=i(66470),fe=i(50125),ge=i(46259);const me=1;function _e(e){const t=new he.N5,{attributes:i,varyings:_e,constants:ve,vertex:ye,fragment:be}=t;t.include(ie.p),t.include(X.s,e),t.include(K.q,e);const xe=e.applyMarkerOffset&&!e.draped;xe&&(ye.uniforms.add(new le.m("markerScale",(e=>e.markerScale))),t.include(ee.r,{space:fe.lM.World,draped:!1})),e.output===Q.V.LinearDepth&&t.include($.L,e),t.include(Y.g,e),(0,se.NB)(ye,e),ye.uniforms.add(new de.X("inverseProjectionMatrix",((e,t)=>t.camera.inverseProjectionMatrix)),new ae.G("nearFar",((e,t)=>t.camera.nearFar)),new le.m("miterLimit",(e=>"miter"!==e.join?0:e.miterLimit)),new oe.E("viewport",((e,t)=>t.camera.fullViewport))),ye.constants.add("LARGE_HALF_FLOAT","float",65500),i.add(pe.r.POSITION,"vec3"),i.add(pe.r.PREVPOSITION,"vec3"),i.add(pe.r.NEXTPOSITION,"vec3"),i.add(pe.r.SUBDIVISIONFACTOR,"float"),i.add(pe.r.UV0,"vec2"),_e.add("vColor","vec4"),_e.add("vpos","vec3"),_e.add("vLineDistance","float"),_e.add("vLineWidth","float"),(0,q.Mu)(t);const Se=e.multipassEnabled&&(e.output===Q.V.Color||e.output===Q.V.Alpha);Se&&_e.add("depth","float");const we=e.stippleEnabled;we&&_e.add("vLineSizeInv","float"),ve.add("aaWidth","float",e.stippleEnabled?0:1);const Ce=e.capType===ge.x.ROUND,Ae=e.stippleEnabled&&Ce,Re=e.falloffEnabled||Ae;Re&&_e.add("vLineDistanceNorm","float"),Ce&&(_e.add("vSegmentSDF","float"),_e.add("vReverseSegmentSDF","float")),ye.code.add((0,ce.H)(r||(r=(0,Z.A)(["#define PERPENDICULAR(v) vec2(v.y, -v.x);\nfloat interp(float ncp, vec4 a, vec4 b) {\nreturn (-ncp - a.z) / (b.z - a.z);\n}\nvec2 rotate(vec2 v, float a) {\nfloat s = sin(a);\nfloat c = cos(a);\nmat2 m = mat2(c, -s, s, c);\nreturn m * v;\n}"])))),ye.code.add((0,ce.H)(n||(n=(0,Z.A)(["vec4 projectAndScale(vec4 pos) {\nvec4 posNdc = proj * pos;\nposNdc.xy *= viewport.zw / posNdc.w;\nreturn posNdc;\n}"])))),(0,q.i$)(t),ye.code.add((0,ce.H)(s||(s=(0,Z.A)(["\n    void clipAndTransform(inout vec4 pos, inout vec4 prev, inout vec4 next, in bool isStartVertex) {\n      float vnp = nearFar[0] * 0.99;\n\n      if(pos.z > -nearFar[0]) {\n        //current pos behind ncp --\x3e we need to clip\n        if (!isStartVertex) {\n          if(prev.z < -nearFar[0]) {\n            //previous in front of ncp\n            pos = mix(prev, pos, interp(vnp, prev, pos));\n            next = pos;\n          } else {\n            pos = vec4(0.0, 0.0, 0.0, 1.0);\n          }\n        } else {\n          if(next.z < -nearFar[0]) {\n            //next in front of ncp\n            pos = mix(pos, next, interp(vnp, pos, next));\n            prev = pos;\n          } else {\n            pos = vec4(0.0, 0.0, 0.0, 1.0);\n          }\n        }\n      } else {\n        //current position visible\n        if (prev.z > -nearFar[0]) {\n          //previous behind ncp\n          prev = mix(pos, prev, interp(vnp, pos, prev));\n        }\n        if (next.z > -nearFar[0]) {\n          //next behind ncp\n          next = mix(next, pos, interp(vnp, next, pos));\n        }\n      }\n\n      ","\n      linearDepth = calculateLinearDepth(nearFar,pos.z);\n\n      pos = projectAndScale(pos);\n      next = projectAndScale(next);\n      prev = projectAndScale(prev);\n    }\n  "])),Se?"depth = pos.z;":"")),(0,se.Nz)(ye),ye.code.add((0,ce.H)(a||(a=(0,Z.A)(["\n  void main(void) {\n    // unpack values from uv0.y\n    bool isStartVertex = abs(abs(uv0.y)-3.0) == 1.0;\n\n    float coverage = 1.0;\n\n    // Check for special value of uv0.y which is used by the Renderer when graphics\n    // are removed before the VBO is recompacted. If this is the case, then we just\n    // project outside of clip space.\n    if (uv0.y == 0.0) {\n      // Project out of clip space\n      gl_Position = vec4(1e038, 1e038, 1e038, 1.0);\n    }\n    else {\n      bool isJoin = abs(uv0.y) < 3.0;\n      float lineSize = getSize();\n\n      if (lineSize < 1.0) {\n        coverage = lineSize; // convert sub-pixel coverage to alpha\n        lineSize = 1.0;\n      }\n      lineSize += aaWidth;\n\n      float lineWidth = lineSize * pixelRatio;\n      vLineWidth = lineWidth;\n      ","\n\n      vec4 pos  = view * vec4(position, 1.0);\n      vec4 prev = view * vec4(prevPosition, 1.0);\n      vec4 next = view * vec4(nextPosition, 1.0);\n  "])),we?(0,ce.H)(o||(o=(0,Z.A)(["vLineSizeInv = 1.0 / lineSize;"]))):"")),xe&&ye.code.add((0,ce.H)(l||(l=(0,Z.A)(["vec4 other = isStartVertex ? next : prev;\nbool markersHidden = areWorldMarkersHidden(pos, other);\nif(!isJoin && !markersHidden) {\npos.xyz += normalize(other.xyz - pos.xyz) * getWorldMarkerSize(pos) * 0.5;\n}"])))),ye.code.add((0,ce.H)(c||(c=(0,Z.A)(["clipAndTransform(pos, prev, next, isStartVertex);\nvec2 left = (pos.xy - prev.xy);\nvec2 right = (next.xy - pos.xy);\nfloat leftLen = length(left);\nfloat rightLen = length(right);"])))),(e.stippleEnabled||Ce)&&ye.code.add((0,ce.H)(d||(d=(0,Z.A)(["\n      float isEndVertex = float(!isStartVertex);\n      vec2 segmentOrigin = mix(pos.xy, prev.xy, isEndVertex);\n      vec2 segment = mix(right, left, isEndVertex);\n      ","\n    "])),Ce?(0,ce.H)(h||(h=(0,Z.A)(["vec2 segmentEnd = mix(next.xy, pos.xy, isEndVertex);"]))):"")),ye.code.add((0,ce.H)(u||(u=(0,Z.A)(["left = (leftLen > 0.001) ? left/leftLen : vec2(0.0, 0.0);\nright = (rightLen > 0.001) ? right/rightLen : vec2(0.0, 0.0);\nvec2 capDisplacementDir = vec2(0, 0);\nvec2 joinDisplacementDir = vec2(0, 0);\nfloat displacementLen = lineWidth;\nif (isJoin) {\nbool isOutside = (left.x * right.y - left.y * right.x) * uv0.y > 0.0;\njoinDisplacementDir = normalize(left + right);\njoinDisplacementDir = PERPENDICULAR(joinDisplacementDir);\nif (leftLen > 0.001 && rightLen > 0.001) {\nfloat nDotSeg = dot(joinDisplacementDir, left);\ndisplacementLen /= length(nDotSeg * left - joinDisplacementDir);\nif (!isOutside) {\ndisplacementLen = min(displacementLen, min(leftLen, rightLen)/abs(nDotSeg));\n}\n}\nif (isOutside && (displacementLen > miterLimit * lineWidth)) {"])))),e.roundJoins?ye.code.add((0,ce.H)(p||(p=(0,Z.A)(["\n        vec2 startDir = leftLen < 0.001 ? right : left;\n        startDir = PERPENDICULAR(startDir);\n\n        vec2 endDir = rightLen < 0.001 ? left : right;\n        endDir = PERPENDICULAR(endDir);\n\n        float factor = ",";\n\n        float rotationAngle = acos(clamp(dot(startDir, endDir), -1.0, 1.0));\n        joinDisplacementDir = rotate(startDir, -sign(uv0.y) * factor * rotationAngle);\n      "])),e.stippleEnabled?(0,ce.H)(f||(f=(0,Z.A)(["min(1.0, subdivisionFactor * ",")"])),ce.H.float((me+2)/(me+1))):(0,ce.H)(g||(g=(0,Z.A)(["subdivisionFactor"]))))):ye.code.add((0,ce.H)(m||(m=(0,Z.A)(["if (leftLen < 0.001) {\njoinDisplacementDir = right;\n}\nelse if (rightLen < 0.001) {\njoinDisplacementDir = left;\n}\nelse {\njoinDisplacementDir = (isStartVertex || subdivisionFactor > 0.0) ? right : left;\n}\njoinDisplacementDir = PERPENDICULAR(joinDisplacementDir);"]))));const Ee=e.capType!==ge.x.BUTT;return ye.code.add((0,ce.H)(_||(_=(0,Z.A)(["\n        displacementLen = lineWidth;\n      }\n    } else {\n      // CAP handling ---------------------------------------------------\n      joinDisplacementDir = isStartVertex ? right : left;\n      joinDisplacementDir = PERPENDICULAR(joinDisplacementDir);\n\n      ","\n    }\n  "])),Ee?(0,ce.H)(v||(v=(0,Z.A)(["capDisplacementDir = isStartVertex ? -right : left;"]))):"")),ye.code.add((0,ce.H)(y||(y=(0,Z.A)(["\n    // Displacement (in pixels) caused by join/or cap\n    vec2 dpos = joinDisplacementDir * sign(uv0.y) * displacementLen + capDisplacementDir * displacementLen;\n    float lineDistNorm = sign(uv0.y) * pos.w;\n\n    vLineDistance =  lineWidth * lineDistNorm;\n    ","\n\n    pos.xy += dpos;\n  "])),Re?(0,ce.H)(b||(b=(0,Z.A)(["vLineDistanceNorm = lineDistNorm;"]))):"")),Ce&&ye.code.add((0,ce.H)(x||(x=(0,Z.A)(["vec2 segmentDir = normalize(segment);\nvSegmentSDF = (isJoin && isStartVertex) ? LARGE_HALF_FLOAT : (dot(pos.xy - segmentOrigin, segmentDir) * pos.w) ;\nvReverseSegmentSDF = (isJoin && !isStartVertex) ? LARGE_HALF_FLOAT : (dot(pos.xy - segmentEnd, -segmentDir) * pos.w);"])))),e.stippleEnabled&&(e.draped?ye.uniforms.add(new le.m("worldToScreenRatio",((e,t)=>1/t.screenToPCSRatio))):ye.code.add((0,ce.H)(S||(S=(0,Z.A)(["vec3 segmentCenter = mix((nextPosition + position) * 0.5, (position + prevPosition) * 0.5, isEndVertex);\nfloat worldToScreenRatio = computeWorldToScreenRatio(segmentCenter);"])))),ye.code.add((0,ce.H)(w||(w=(0,Z.A)(["float segmentLengthScreenDouble = length(segment);\nfloat segmentLengthScreen = segmentLengthScreenDouble * 0.5;\nfloat discreteWorldToScreenRatio = discretizeWorldToScreenRatio(worldToScreenRatio);\nfloat segmentLengthRender = length(mix(nextPosition - position, position - prevPosition, isEndVertex));\nvStipplePatternStretch = worldToScreenRatio / discreteWorldToScreenRatio;"])))),e.draped?ye.code.add((0,ce.H)(C||(C=(0,Z.A)(["float segmentLengthPseudoScreen = segmentLengthScreen / pixelRatio * discreteWorldToScreenRatio / worldToScreenRatio;\nfloat startPseudoScreen = uv0.x * discreteWorldToScreenRatio - mix(0.0, segmentLengthPseudoScreen, isEndVertex);"])))):ye.code.add((0,ce.H)(A||(A=(0,Z.A)(["float startPseudoScreen = mix(uv0.x, uv0.x - segmentLengthRender, isEndVertex) * discreteWorldToScreenRatio;\nfloat segmentLengthPseudoScreen = segmentLengthRender * discreteWorldToScreenRatio;"])))),ye.uniforms.add(new le.m("stipplePatternPixelSize",(e=>(0,K.h)(e)))),ye.code.add((0,ce.H)(R||(R=(0,Z.A)(["float patternLength = lineSize * stipplePatternPixelSize;\nvStippleDistanceLimits = computeStippleDistanceLimits(startPseudoScreen, segmentLengthPseudoScreen, segmentLengthScreen, patternLength);\nvStippleDistance = mix(vStippleDistanceLimits.x, vStippleDistanceLimits.y, isEndVertex);\nif (segmentLengthScreenDouble >= 0.001) {\nvec2 stippleDisplacement = pos.xy - segmentOrigin;\nfloat stippleDisplacementFactor = dot(segment, stippleDisplacement) / (segmentLengthScreenDouble * segmentLengthScreenDouble);\nvStippleDistance += (stippleDisplacementFactor - isEndVertex) * (vStippleDistanceLimits.y - vStippleDistanceLimits.x);\n}\nvStippleDistanceLimits *= pos.w;\nvStippleDistance *= pos.w;\nvStippleDistanceLimits = isJoin ?\nvStippleDistanceLimits :\nisStartVertex ?\nvec2(-1e34, vStippleDistanceLimits.y) :\nvec2(vStippleDistanceLimits.x, 1e34);"]))))),ye.code.add((0,ce.H)(E||(E=(0,Z.A)(["\n      // Convert back into NDC\n      pos.xy = (pos.xy / viewport.zw) * pos.w;\n\n      vColor = getColor();\n      vColor.a *= coverage;\n\n      ","\n\n      // transform final position to camera space for slicing\n      vpos = (inverseProjectionMatrix * pos).xyz;\n      gl_Position = pos;\n      forwardObjectAndLayerIdColor();\n    }\n  }\n  "])),e.wireframe&&!e.draped?"pos.z -= 0.001 * pos.w;":"")),Se&&t.include(te.Q,e),t.include(J.HQ,e),be.include(ne.a),be.code.add((0,ce.H)(O||(O=(0,Z.A)(["\n  void main() {\n    discardBySlice(vpos);\n    ","\n  "])),Se?"terrainDepthTest(depth);":"")),e.wireframe?be.code.add((0,ce.H)(T||(T=(0,Z.A)(["vec4 finalColor = vec4(1.0, 0.0, 1.0, 1.0);"])))):(Ce&&be.code.add((0,ce.H)(P||(P=(0,Z.A)(["\n        float sdf = min(vSegmentSDF, vReverseSegmentSDF);\n        vec2 fragmentPosition = vec2(\n          min(sdf, 0.0),\n          vLineDistance\n        ) * gl_FragCoord.w;\n\n        float fragmentRadius = length(fragmentPosition);\n        float fragmentCapSDF = (fragmentRadius - vLineWidth) * 0.5; // Divide by 2 to transform from double pixel scale\n        float capCoverage = clamp(0.5 - fragmentCapSDF, 0.0, 1.0);\n\n        if (capCoverage < ",") {\n          discard;\n        }\n      "])),ce.H.float(re.y))),Ae?be.code.add((0,ce.H)(M||(M=(0,Z.A)(["\n      vec2 stipplePosition = vec2(\n        min(getStippleSDF() * 2.0 - 1.0, 0.0),\n        vLineDistanceNorm * gl_FragCoord.w\n      );\n      float stippleRadius = length(stipplePosition * vLineWidth);\n      float stippleCapSDF = (stippleRadius - vLineWidth) * 0.5; // Divide by 2 to transform from double pixel scale\n      float stippleCoverage = clamp(0.5 - stippleCapSDF, 0.0, 1.0);\n      float stippleAlpha = step(",", stippleCoverage);\n      "])),ce.H.float(re.y))):be.code.add((0,ce.H)(I||(I=(0,Z.A)(["float stippleAlpha = getStippleAlpha();"])))),e.output!==Q.V.ObjectAndLayerIdColor&&be.code.add((0,ce.H)(D||(D=(0,Z.A)(["discardByStippleAlpha(stippleAlpha, stippleAlphaColorDiscard);"])))),be.uniforms.add(new oe.E("intrinsicColor",(e=>e.color))),be.code.add((0,ce.H)(L||(L=(0,Z.A)(["vec4 color = intrinsicColor * vColor;"])))),e.innerColorEnabled&&(be.uniforms.add(new oe.E("innerColor",(e=>{var t;return null!==(t=e.innerColor)&&void 0!==t?t:e.color})),new le.m("innerWidth",((e,t)=>e.innerWidth*t.camera.pixelRatio))),be.code.add((0,ce.H)(F||(F=(0,Z.A)(["float distToInner = abs(vLineDistance * gl_FragCoord.w) - innerWidth;\nfloat innerAA = clamp(0.5 - distToInner, 0.0, 1.0);\nfloat innerAlpha = innerColor.a + color.a * (1.0 - innerColor.a);\ncolor = mix(color, vec4(innerColor.rgb, innerAlpha), innerAA);"]))))),be.code.add((0,ce.H)(N||(N=(0,Z.A)(["vec4 finalColor = blendStipple(color, stippleAlpha);"])))),e.falloffEnabled&&(be.uniforms.add(new le.m("falloff",(e=>e.falloff))),be.code.add((0,ce.H)(V||(V=(0,Z.A)(["finalColor.a *= pow(max(0.0, 1.0 - abs(vLineDistanceNorm * gl_FragCoord.w)), falloff);"]))))),e.stippleEnabled||be.code.add((0,ce.H)(G||(G=(0,Z.A)(["float featherStartDistance = max(vLineWidth - 2.0, 0.0);\nfloat value = abs(vLineDistance) * gl_FragCoord.w;\nfloat feather = (value - featherStartDistance) / (vLineWidth - featherStartDistance);\nfinalColor.a *= 1.0 - clamp(feather, 0.0, 1.0);"]))))),be.code.add((0,ce.H)(U||(U=(0,Z.A)(["\n    ","\n\n    if (finalColor.a < ",") {\n      discard;\n    }\n\n    ","\n    ","\n    ","\n    ","\n    ","\n    ","\n  }\n  "])),e.output===Q.V.ObjectAndLayerIdColor?(0,ce.H)(z||(z=(0,Z.A)(["finalColor.a = 1.0;"]))):"",ce.H.float(re.y),e.output===Q.V.Alpha?(0,ce.H)(B||(B=(0,Z.A)(["fragColor = vec4(finalColor.a);"]))):"",e.output===Q.V.Color?(0,ce.H)(H||(H=(0,Z.A)(["fragColor = highlightSlice(finalColor, vpos);"]))):"",e.output===Q.V.Color&&e.transparencyPassType===ue.y.Color?"fragColor = premultiplyAlpha(fragColor);":"",e.output===Q.V.Highlight?(0,ce.H)(j||(j=(0,Z.A)(["fragColor = vec4(1.0);"]))):"",e.output===Q.V.LinearDepth?(0,ce.H)(W||(W=(0,Z.A)(["outputDepth(linearDepth);"]))):"",e.output===Q.V.ObjectAndLayerIdColor?(0,ce.H)(k||(k=(0,Z.A)(["outputObjectAndLayerIdColor();"]))):"")),t}const ve=Object.freeze(Object.defineProperty({__proto__:null,build:_e,ribbonlineNumRoundJoinSubdivisions:me},Symbol.toStringTag,{value:"Module"}))},53070:(e,t,i)=>{i.d(t,{T:()=>h,a:()=>p,b:()=>u});var r,n=i(57528),s=i(9392),a=i(73398),o=i(5517),l=i(64839),c=i(32307),d=i(70367);class h extends l.Y{constructor(){super(...arguments),this.color=(0,s.fA)(1,1,1)}}function u(){const e=new c.N5;return e.include(a.c),e.fragment.uniforms.add(new d.N("tex",(e=>e.texture)),new o.t("uColor",(e=>e.color))),e.fragment.code.add((0,l.H)(r||(r=(0,n.A)(["void main() {\nvec4 texColor = texture(tex, uv);\nfragColor = texColor * vec4(uColor, 1.0);\n}"])))),e}const p=Object.freeze(Object.defineProperty({__proto__:null,TextureOnlyPassParameters:h,build:u},Symbol.toStringTag,{value:"Module"}))},15263:(e,t,i)=>{i.d(t,{W:()=>z,b:()=>U});var r,n,s,a,o,l,c,d,h,u,p,f,g=i(57528),m=i(72412),_=i(34981),v=i(26917),y=i(59395),b=i(90080),x=i(48020),S=i(50819),w=i(43557),C=i(81993),A=i(2260),R=i(26719),E=i(1773),O=i(92176),T=i(82884),P=i(90235),M=i(80883),I=i(42451),D=i(58350),L=i(21390),F=i(64839),N=i(32307),V=i(10773),G=i(66470);function U(e){const t=new N.N5,{vertex:i,fragment:U}=t;(0,I.NB)(i,e),t.include(y.d,e),t.attributes.add(G.r.POSITION,"vec3"),t.attributes.add(G.r.UV0,"vec2");const z=new D.E("waterColor",(e=>e.color));if(e.output===_.V.Color&&e.draped)return t.varyings.add("vpos","vec3"),i.uniforms.add(z),i.code.add((0,F.H)(r||(r=(0,g.A)(["\n        void main(void) {\n          if (waterColor.a < ",") {\n            // Discard this vertex\n            gl_Position = vec4(1e38, 1e38, 1e38, 1.0);\n            return;\n          }\n\n          vpos = position;\n          gl_Position = transformPosition(proj, view, vpos);\n        }\n    "])),F.H.float(P.y))),U.uniforms.add(z),U.code.add((0,F.H)(n||(n=(0,g.A)(["void main() {\nfragColor = waterColor;\n}"])))),t;switch(e.output!==_.V.Color&&e.output!==_.V.Alpha||(t.include(A.n,e),t.include(m.oD,e),t.varyings.add("vuv","vec2"),t.varyings.add("vpos","vec3"),t.varyings.add("vnormal","vec3"),t.varyings.add("vtbnMatrix","mat3"),e.multipassEnabled&&t.varyings.add("depth","float"),i.uniforms.add(z),i.code.add((0,F.H)(s||(s=(0,g.A)(["\n      void main(void) {\n        if (waterColor.a < ",") {\n          // Discard this vertex\n          gl_Position = vec4(1e38, 1e38, 1e38, 1.0);\n          return;\n        }\n\n        vuv = uv0;\n        vpos = position;\n\n        vnormal = getLocalUp(vpos, localOrigin);\n        vtbnMatrix = getTBNMatrix(vnormal);\n\n        ","\n\n        gl_Position = transformPosition(proj, view, vpos);\n        ","\n      }\n    "])),F.H.float(P.y),e.multipassEnabled?"depth = (view * vec4(vpos, 1.0)).z;":"",e.output===_.V.Color?"forwardLinearDepth();":""))),t.include(C.Q,e),e.output){case _.V.Alpha:t.include(v.HQ,e),U.uniforms.add(z),U.code.add((0,F.H)(a||(a=(0,g.A)(["\n        void main() {\n          discardBySlice(vpos);\n          ","\n\n          fragColor = vec4(waterColor.a);\n        }\n      "])),e.multipassEnabled?"terrainDepthTest(depth);":""));break;case _.V.Color:t.include(w.qU),t.include(S.W,{pbrMode:R.A9.Disabled,lightingSphericalHarmonicsOrder:2}),t.include(T.V),t.include(v.HQ,e),t.include(E.Bz,e),t.include(O.E,e),U.uniforms.add(z,new L.m("timeElapsed",(e=>e.timeElapsed)),i.uniforms.get("view"),i.uniforms.get("localOrigin")),(0,I.yu)(U,e),U.include(M.a),(0,w.Gc)(U),(0,w.O4)(U),U.code.add((0,F.H)(o||(o=(0,g.A)(["\n      void main() {\n        discardBySlice(vpos);\n        ","\n        vec3 localUp = vnormal;\n        // the created normal is in tangent space\n        vec4 tangentNormalFoam = getSurfaceNormalAndFoam(vuv, timeElapsed);\n\n        // we rotate the normal according to the tangent-bitangent-normal-Matrix\n        vec3 n = normalize(vtbnMatrix * tangentNormalFoam.xyz);\n        vec3 v = -normalize(vpos - cameraPosition);\n        float shadow = ",";\n        vec4 vPosView = view * vec4(vpos, 1.0);\n        vec4 final = vec4(getSeaColor(n, v, mainLightDirection, waterColor.rgb, mainLightIntensity, localUp, shadow, tangentNormalFoam.w, vPosView.xyz, vpos + localOrigin), waterColor.w);\n\n        // gamma correction\n        fragColor = delinearizeGamma(final);\n        fragColor = highlightSlice(fragColor, vpos);\n        ","\n      }\n    "])),e.multipassEnabled?"terrainDepthTest(depth);":"",e.receiveShadows?(0,F.H)(l||(l=(0,g.A)(["1.0 - readShadowMap(vpos, linearDepth)"]))):"1.0",e.transparencyPassType===V.y.Color?"fragColor = premultiplyAlpha(fragColor);":""));break;case _.V.Normal:t.include(A.n,e),t.include(T.V,e),t.include(v.HQ,e),t.varyings.add("vpos","vec3"),t.varyings.add("vuv","vec2"),i.uniforms.add(z),i.code.add((0,F.H)(c||(c=(0,g.A)(["\n        void main(void) {\n          if (waterColor.a < ",") {\n            // Discard this vertex\n            gl_Position = vec4(1e38, 1e38, 1e38, 1.0);\n            return;\n          }\n\n          vuv = uv0;\n          vpos = position;\n\n          gl_Position = transformPosition(proj, view, vpos);\n        }\n    "])),F.H.float(P.y))),U.uniforms.add(new L.m("timeElapsed",(e=>e.timeElapsed))),U.code.add((0,F.H)(d||(d=(0,g.A)(["void main() {\ndiscardBySlice(vpos);\nvec4 tangentNormalFoam = getSurfaceNormalAndFoam(vuv, timeElapsed);\ntangentNormalFoam.xyz = normalize(tangentNormalFoam.xyz);\nfragColor = vec4((tangentNormalFoam.xyz + vec3(1.0)) * 0.5, tangentNormalFoam.w);\n}"]))));break;case _.V.Highlight:t.include(x.Qh,e),t.varyings.add("vpos","vec3"),i.uniforms.add(z),i.code.add((0,F.H)(h||(h=(0,g.A)(["\n      void main(void) {\n        if (waterColor.a < ",") {\n          // Discard this vertex\n          gl_Position = vec4(1e38, 1e38, 1e38, 1.0);\n          return;\n        }\n\n        vpos = position;\n        gl_Position = transformPosition(proj, view, vpos);\n      }\n    "])),F.H.float(P.y))),t.include(v.HQ,e),U.code.add((0,F.H)(u||(u=(0,g.A)(["void main() {\ndiscardBySlice(vpos);\noutputHighlight();\n}"]))));break;case _.V.ObjectAndLayerIdColor:t.include(b.g,e),t.varyings.add("vpos","vec3"),i.uniforms.add(z),i.code.add((0,F.H)(p||(p=(0,g.A)(["\n      void main(void) {\n        if (waterColor.a < ",") {\n          // Discard this vertex\n          gl_Position = vec4(1e38, 1e38, 1e38, 1.0);\n          return;\n        }\n\n        vpos = position;\n        gl_Position = transformPosition(proj, view, vpos);\n        forwardObjectAndLayerIdColor();\n      }\n    "])),F.H.float(P.y))),t.include(v.HQ,e),U.code.add((0,F.H)(f||(f=(0,g.A)(["void main() {\ndiscardBySlice(vpos);\noutputObjectAndLayerIdColor();\n}"]))))}return t}const z=Object.freeze(Object.defineProperty({__proto__:null,build:U},Symbol.toStringTag,{value:"Module"}))},55877:(e,t,i)=>{var r;i.d(t,{u:()=>r}),function(e){e[e.KILOBYTES=1024]="KILOBYTES",e[e.MEGABYTES=1048576]="MEGABYTES",e[e.GIGABYTES=1073741824]="GIGABYTES"}(r||(r={}))},60767:(e,t,i)=>{i.d(t,{A:()=>s});var r=i(99486),n=i(99702);class s{constructor(e){this._observable=new n.I,this._set=new Set(e)}get size(){return(0,r.gc)(this._observable),this._set.size}add(e){const t=this._set.size;return this._set.add(e),this._set.size!==t&&this._observable.notify(),this}clear(){this._set.size>0&&(this._set.clear(),this._observable.notify())}delete(e){const t=this._set.delete(e);return t&&this._observable.notify(),t}entries(){return(0,r.gc)(this._observable),this._set.entries()}forEach(e,t){(0,r.gc)(this._observable),this._set.forEach(((i,r)=>e.call(t,i,r,this)),t)}has(e){return(0,r.gc)(this._observable),this._set.has(e)}keys(){return(0,r.gc)(this._observable),this._set.keys()}values(){return(0,r.gc)(this._observable),this._set.values()}[Symbol.iterator](){return(0,r.gc)(this._observable),this._set[Symbol.iterator]()}get[Symbol.toStringTag](){return this._set[Symbol.toStringTag]}}},83755:(e,t,i)=>{function r(){return new Float32Array(3)}function n(e){const t=new Float32Array(3);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t}function s(e,t,i){const r=new Float32Array(3);return r[0]=e,r[1]=t,r[2]=i,r}function a(){return r()}function o(){return s(1,1,1)}function l(){return s(1,0,0)}function c(){return s(0,1,0)}function d(){return s(0,0,1)}i.d(t,{fA:()=>s,o8:()=>n,vt:()=>r});const h=a(),u=o(),p=l(),f=c(),g=d();Object.freeze(Object.defineProperty({__proto__:null,ONES:u,UNIT_X:p,UNIT_Y:f,UNIT_Z:g,ZEROS:h,clone:n,create:r,createView:function(e,t){return new Float32Array(e,t,3)},fromValues:s,ones:o,unitX:l,unitY:c,unitZ:d,zeros:a},Symbol.toStringTag,{value:"Module"}))},70373:(e,t,i)=>{i.d(t,{w:()=>a});var r=i(18690),n=i(30015),s=i(61196);class a{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:9,t=arguments.length>1?arguments[1]:void 0;this._compareMinX=d,this._compareMinY=h,this._toBBox=e=>e,this._maxEntries=Math.max(4,e||9),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),t&&("function"==typeof t?this._toBBox=t:this._initFormat(t)),this.clear()}destroy(){this.clear(),y.prune(),b.prune(),x.prune(),S.prune()}all(e){this._all(this._data,e)}search(e,t){let i=this._data;const r=this._toBBox;if(_(e,i))for(y.clear();i;){for(let n=0,s=i.children.length;n<s;n++){const s=i.children[n],a=i.leaf?r(s):s;_(e,a)&&(i.leaf?t(s):m(e,a)?this._all(s,t):y.push(s))}i=y.pop()}}collides(e){let t=this._data;const i=this._toBBox;if(!_(e,t))return!1;for(y.clear();t;){for(let r=0,n=t.children.length;r<n;r++){const n=t.children[r],s=t.leaf?i(n):n;if(_(e,s)){if(t.leaf||m(e,s))return!0;y.push(n)}}t=y.pop()}return!1}load(e){if(!e.length)return this;if(e.length<this._minEntries){for(let t=0,i=e.length;t<i;t++)this.insert(e[t]);return this}let t=this._build(e.slice(0,e.length),0,e.length-1,0);if(this._data.children.length)if(this._data.height===t.height)this._splitRoot(this._data,t);else{if(this._data.height<t.height){const e=this._data;this._data=t,t=e}this._insert(t,this._data.height-t.height-1,!0)}else this._data=t;return this}insert(e){return e&&this._insert(e,this._data.height-1),this}clear(){return this._data=new A([]),this}remove(e){if(!e)return this;let t,i=this._data,n=null,s=0,a=!1;const o=this._toBBox(e);for(x.clear(),S.clear();i||x.length>0;){var l;if(i||(i=x.pop(),n=x.data[x.length-1],s=null!==(l=S.pop())&&void 0!==l?l:0,a=!0),i.leaf&&(t=(0,r.qh)(i.children,e,i.children.length,i.indexHint),-1!==t))return i.children.splice(t,1),x.push(i),this._condense(x),this;a||i.leaf||!m(i,o)?n?(s++,i=n.children[s],a=!1):i=null:(x.push(i),S.push(s),s=0,n=i,i=i.children[0])}return this}toJSON(){return this._data}fromJSON(e){return this._data=e,this}_all(e,t){let i=e;for(b.clear();i;){var r;if(!0===i.leaf)for(const e of i.children)t(e);else b.pushArray(i.children);i=null!==(r=b.pop())&&void 0!==r?r:null}}_build(e,t,i,r){const n=i-t+1;let s=this._maxEntries;if(n<=s){const r=new A(e.slice(t,i+1));return o(r,this._toBBox),r}r||(r=Math.ceil(Math.log(n)/Math.log(s)),s=Math.ceil(n/s**(r-1)));const a=new R([]);a.height=r;const l=Math.ceil(n/s),c=l*Math.ceil(Math.sqrt(s));v(e,t,i,c,this._compareMinX);for(let o=t;o<=i;o+=c){const t=Math.min(o+c-1,i);v(e,o,t,l,this._compareMinY);for(let i=o;i<=t;i+=l){const n=Math.min(i+l-1,t);a.children.push(this._build(e,i,n,r-1))}}return o(a,this._toBBox),a}_chooseSubtree(e,t,i,r){for(;r.push(t),!0!==t.leaf&&r.length-1!==i;){let i,r=1/0,n=1/0;for(let s=0,a=t.children.length;s<a;s++){const a=t.children[s],o=u(a),l=f(e,a)-o;l<n?(n=l,r=o<r?o:r,i=a):l===n&&o<r&&(r=o,i=a)}t=i||t.children[0]}return t}_insert(e,t,i){const r=this._toBBox,n=i?e:r(e);x.clear();const s=this._chooseSubtree(n,this._data,t,x);for(s.children.push(e),c(s,n);t>=0&&x.data[t].children.length>this._maxEntries;)this._split(x,t),t--;this._adjustParentBBoxes(n,x,t)}_split(e,t){const i=e.data[t],r=i.children.length,n=this._minEntries;this._chooseSplitAxis(i,n,r);const s=this._chooseSplitIndex(i,n,r);if(!s)return void console.log("  Error: assertion failed at PooledRBush._split: no valid split index");const a=i.children.splice(s,i.children.length-s),l=i.leaf?new A(a):new R(a);l.height=i.height,o(i,this._toBBox),o(l,this._toBBox),t?e.data[t-1].children.push(l):this._splitRoot(i,l)}_splitRoot(e,t){this._data=new R([e,t]),this._data.height=e.height+1,o(this._data,this._toBBox)}_chooseSplitIndex(e,t,i){let r,n,s;r=n=1/0;for(let a=t;a<=i-t;a++){const t=l(e,0,a,this._toBBox),o=l(e,a,i,this._toBBox),c=g(t,o),d=u(t)+u(o);c<r?(r=c,s=a,n=d<n?d:n):c===r&&d<n&&(n=d,s=a)}return s}_chooseSplitAxis(e,t,i){const r=e.leaf?this._compareMinX:d,n=e.leaf?this._compareMinY:h;this._allDistMargin(e,t,i,r)<this._allDistMargin(e,t,i,n)&&e.children.sort(r)}_allDistMargin(e,t,i,r){e.children.sort(r);const n=this._toBBox,s=l(e,0,t,n),a=l(e,i-t,i,n);let o=p(s)+p(a);for(let l=t;l<i-t;l++){const t=e.children[l];c(s,e.leaf?n(t):t),o+=p(s)}for(let l=i-t-1;l>=t;l--){const t=e.children[l];c(a,e.leaf?n(t):t),o+=p(a)}return o}_adjustParentBBoxes(e,t,i){for(let r=i;r>=0;r--)c(t.data[r],e)}_condense(e){for(let t=e.length-1;t>=0;t--){const i=e.data[t];if(0===i.children.length)if(t>0){const n=e.data[t-1],s=n.children;s.splice((0,r.qh)(s,i,s.length,n.indexHint),1)}else this.clear();else o(i,this._toBBox)}}_initFormat(e){const t=["return a"," - b",";"];this._compareMinX=new Function("a","b",t.join(e[0])),this._compareMinY=new Function("a","b",t.join(e[1])),this._toBBox=new Function("a","return {minX: a"+e[0]+", minY: a"+e[1]+", maxX: a"+e[2]+", maxY: a"+e[3]+"};")}}function o(e,t){l(e,0,e.children.length,t,e)}function l(e,t,i,r,n){n||(n=new A([])),n.minX=1/0,n.minY=1/0,n.maxX=-1/0,n.maxY=-1/0;for(let s,a=t;a<i;a++)s=e.children[a],c(n,e.leaf?r(s):s);return n}function c(e,t){e.minX=Math.min(e.minX,t.minX),e.minY=Math.min(e.minY,t.minY),e.maxX=Math.max(e.maxX,t.maxX),e.maxY=Math.max(e.maxY,t.maxY)}function d(e,t){return e.minX-t.minX}function h(e,t){return e.minY-t.minY}function u(e){return(e.maxX-e.minX)*(e.maxY-e.minY)}function p(e){return e.maxX-e.minX+(e.maxY-e.minY)}function f(e,t){return(Math.max(t.maxX,e.maxX)-Math.min(t.minX,e.minX))*(Math.max(t.maxY,e.maxY)-Math.min(t.minY,e.minY))}function g(e,t){const i=Math.max(e.minX,t.minX),r=Math.max(e.minY,t.minY),n=Math.min(e.maxX,t.maxX),s=Math.min(e.maxY,t.maxY);return Math.max(0,n-i)*Math.max(0,s-r)}function m(e,t){return e.minX<=t.minX&&e.minY<=t.minY&&t.maxX<=e.maxX&&t.maxY<=e.maxY}function _(e,t){return t.minX<=e.maxX&&t.minY<=e.maxY&&t.maxX>=e.minX&&t.maxY>=e.minY}function v(e,t,i,r,n){const a=[t,i];for(;a.length;){const t=a.pop(),i=a.pop();if(t-i<=r)continue;const o=i+Math.ceil((t-i)/r/2)*r;(0,s.q)(e,o,i,t,n),a.push(i,o,o,t)}}const y=new n.A,b=new n.A,x=new n.A,S=new n.A({deallocator:void 0});class w{constructor(){this.minX=1/0,this.minY=1/0,this.maxX=-1/0,this.maxY=-1/0}}class C extends w{constructor(){super(...arguments),this.height=1,this.indexHint=new r.vW}}class A extends C{constructor(e){super(),this.children=e,this.leaf=!0}}class R extends C{constructor(e){super(),this.children=e,this.leaf=!1}}},24387:(e,t,i)=>{function r(e){return e&&"getAtOrigin"in e&&"originOf"in e}i.d(t,{H:()=>r})},12016:(e,t,i)=>{i.d(t,{B:()=>l});var r=i(18690),n=i(54901),s=i(76460),a=i(50346),o=i(16783);class l{constructor(e,t,i,r){let n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{};this._mainMethod=t,this._transferLists=i,this._listeners=[],this._promise=(0,o.ho)(e,{...n,schedule:r}).then((e=>{if(void 0===this._thread){this._thread=e,this._promise=null,n.hasInitialize&&this.broadcast({},"initialize");for(const e of this._listeners)this._connectListener(e)}else e.close()})),this._promise.catch((t=>s.A.getLogger("esri.core.workers.WorkerHandle").error("Failed to initialize ".concat(e," worker: ").concat(t))))}on(e,t){const i={removed:!1,eventName:e,callback:t,threadHandle:null};return this._listeners.push(i),this._connectListener(i),(0,n.hA)((()=>{i.removed=!0,(0,r.TF)(this._listeners,i),this._thread&&null!=i.threadHandle&&i.threadHandle.remove()}))}destroy(){this._thread&&(this._thread.close(),this._thread=null),this._promise=null,this._listeners.length=0,this._transferLists={}}invoke(e,t){return this.invokeMethod(this._mainMethod,e,t)}invokeMethod(e,t,i){if(this._thread){const r=this._transferLists[e],n=r?r(t):[];return this._thread.invoke(e,t,{transferList:n,signal:i})}return this._promise?this._promise.then((()=>((0,a.Te)(i),this.invokeMethod(e,t,i)))):Promise.reject(null)}broadcast(e,t){return this._thread?Promise.all(this._thread.broadcast(t,e)).then((()=>{})):this._promise?this._promise.then((()=>this.broadcast(e,t))):Promise.reject()}get promise(){return this._promise}_connectListener(e){this._thread&&this._thread.on(e.eventName,e.callback).then((t=>{e.removed||(e.threadHandle=t)}))}}},28586:(e,t,i)=>{var r,n,s,a,o,l,c,d,h,u,p,f,g,m,_;i.d(t,{Pl:()=>v,Qg:()=>_,vE:()=>y}),function(e){e.U8="U8",e.I8="I8",e.U16="U16",e.I16="I16",e.U32="U32",e.I32="I32",e.F32="F32",e.F64="F64",e.Utf8String="Utf8String",e.NotSet="NotSet"}(r||(r={})),function(e){e.Png="Png",e.Jpeg="Jpeg",e.Dds="Dds",e.Raw="Raw",e.Dxt1="Dxt1",e.Dxt5="Dxt5",e.Etc2="Etc2",e.Astc="Astc",e.Pvrtc="Pvrtc",e.NotSet="NotSet"}(n||(n={})),function(e){e.Rgb8="Rgb8",e.Rgba8="Rgba8",e.R8="R8",e.Bgr8="Bgr8",e.Bgra8="Bgra8",e.Rg8="Rg8",e.NotSet="NotSet"}(s||(s={})),function(e){e.Position="Position",e.Normal="Normal",e.TexCoord="TexCoord",e.Color="Color",e.Tangent="Tangent",e.FeatureIndex="FeatureIndex",e.UvRegion="UvRegion",e.NotSet="NotSet"}(a||(a={})),function(e){e.Opaque="Opaque",e.Mask="Mask",e.Blend="Blend"}(o||(o={})),function(e){e.None="None",e.Mask="Mask",e.Alpha="Alpha",e.PreMultAlpha="PreMultAlpha",e.NotSet="NotSet"}(l||(l={})),function(e){e.Points="Points",e.Lines="Lines",e.LineStrip="LineStrip",e.Triangles="Triangles",e.TriangleStrip="TriangleStrip",e.NotSet="NotSet"}(c||(c={})),function(e){e.None="None",e.WrapXBit="WrapXBit",e.WrapYBit="WrapYBit",e.WrapXy="WrapXy",e.NotSet="NotSet"}(d||(d={})),function(e){e.Linear="Linear",e.Nearest="Nearest",e.NotSet="NotSet"}(h||(h={})),function(e){e.Linear="Linear",e.Nearest="Nearest",e.NearestMipmapNearest="NearestMipmapNearest",e.LinearMipmapNearest="LinearMipmapNearest",e.NearestMipmapLinear="NearestMipmapLinear",e.LinearMipmapLinear="LinearMipmapLinear",e.NotSet="NotSet"}(u||(u={})),function(e){e.FeatureId="FeatureId",e.GlobalUid="GlobalUid",e.UnspecifiedDateTime="UnspecifiedDateTime",e.EcmaIso8601DateTime="EcmaIso8601DateTime",e.EcmaIso8601DateOnly="EcmaIso8601DateOnly",e.TimeOnly="TimeOnly",e.TimeStamp="TimeStamp",e.ColorRgb="ColorRgb",e.ColorRgba="ColorRgba",e.Unrecognized="Unrecognized",e.NotSet="NotSet"}(p||(p={})),function(e){e.Texture="Texture",e.VertexAtrb="VertexAtrb",e.Implicit="Implicit",e.NotSet="NotSet"}(f||(f={})),function(e){e.Front="Front",e.Back="Back",e.None="None",e.NotSet="NotSet"}(g||(g={})),function(e){e.Pbr="Pbr",e.Unlit="Unlit"}(m||(m={})),function(e){e[e.Succeeded=0]="Succeeded",e[e.Failed=1]="Failed",e[e.MissingInputs=2]="MissingInputs"}(_||(_={}));const v=-1,y=-2},58299:(e,t,i)=>{i.r(t),i.d(t,{default:()=>qS});var r=i(35143),n=i(3825),s=i(91967),a=i(76460),o=i(50346),l=i(68134),c=i(52394),d=i(46053),h=i(81806),u=(i(47249),i(85842)),p=i(28586),f=i(12016);class g extends f.B{constructor(e){super("Lyr3DWorker","process",{process:e=>e.inputs},e,{hasInitialize:!0})}destroyWasm(){return this.broadcast({},"destroyWasm")}}var m=i(43414),_=i(59097),v=i(69539),y=i(39356),b=i(18690),x=i(55877),S=i(19276),w=i(54901),C=i(30015),A=i(78393),R=i(31633),E=i(63919),O=i(44680),T=i(34761),P=i(13191),M=(i(4336),i(20664)),I=i(9392),D=i(43047),L=i(55855),F=i(19451),N=i(43955),V=i(14556),G=i(80963);var U=i(15941);function z(e,t,i,r){if(null==t||null==r)return!1;const n=(0,N.t_)(t,r,j);if(n.projector===N.pO)return i[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=e[3],!0;if(null==n.projector)return!1;const{source:s,dest:a}=n;if(a.spatialReferenceId===N.rz.WEB_MERCATOR){const t=N.w5[s.spatialReferenceId][N.rz.WGS84];return null!=t&&(t(e,0,H,0),(0,N.s7)(H,0,i,0),i[3]=B(H[1],e[2],e[3],V.$O.radius),!0)}if(s.spatialReferenceId!==N.rz.WGS84&&s.spatialReferenceId!==N.rz.CGCS2000||a.spatialReferenceId!==N.rz.PLATE_CARREE){var o,l;n.projector(e,0,i,0);const t=null!==(o=s.metersPerUnit)&&void 0!==o?o:1,r=null!==(l=a.metersPerUnit)&&void 0!==l?l:1;i[3]=e[3]*t/r}else{const t=N.w5[s.spatialReferenceId][N.rz.SPHERICAL_ECEF],r=N.w5[N.rz.SPHERICAL_ECEF][N.rz.PLATE_CARREE];let a=e[3];null!=t&&null!=r&&(a=B(e[1],e[2],e[3],V.$O.radius)),n.projector(e,0,i,0),i[3]=a}return!0}function B(e,t,i,r){const n=r+t;if(n<r/2||i>n)return Number.MAX_VALUE;const s=Math.abs(W*e)+Math.asin(i/n);return s>=Math.PI/2?Number.MAX_VALUE:i/Math.cos(s)}const H=(0,I.vt)(),j=(0,N.Ur)(),W=(0,U.kU)(1);var k=i(45308),Z=i(14487),q=i(42294),Q=i(2413),J=i(44815),Y=i(75002),X=i(38496),$=i(93582);var K=i(91291);function ee(e,t,i,r){return null!=e&&((0,G.aI)(t,r)?((0,Q.C)(i,e),!0):(te[0]=e[0],te[1]=e[1],te[2]=0,!!(0,k.projectBuffer)(te,t,0,te,r,0,1)&&(i[0]=te[0],i[1]=te[1],te[0]=e[2],te[1]=e[3],te[2]=0,!!(0,k.projectBuffer)(te,t,0,te,r,0,1)&&(i[2]=te[0],i[3]=te[1],!0))))}const te=(0,I.vt)();var ie,re,ne=i(18117),se=i(84031),ae=i(64465),oe=i(50076),le=i(30726),ce=i(79369),de=i(49723),he=i(99773),ue=i(76312),pe=i(37040);!function(e){e[e.KTX2=1]="KTX2",e[e.Basis=2]="Basis",e[e.DDS_S3TC=4]="DDS_S3TC",e[e.PNG=8]="PNG",e[e.JPG=16]="JPG",e[e.KTX_ETC2=32]="KTX_ETC2"}(ie||(ie={})),function(e){e[e.None=0]="None",e[e.Color=1]="Color",e[e.MetallicRoughness=2]="MetallicRoughness",e[e.Normal=4]="Normal",e[e.Occlusion=8]="Occlusion",e[e.Emissive=16]="Emissive",e[e.AlphaMask=32]="AlphaMask",e[e.ColorTextures=19]="ColorTextures",e[e.GeometryTextures=36]="GeometryTextures",e[e.GeometryTexturesPBR=44]="GeometryTexturesPBR",e[e.AllTextures=37]="AllTextures",e[e.AllTexturesPBR=63]="AllTexturesPBR"}(re||(re={}));var fe=i(83490),ge=i(81330),me=i(78992);async function _e(e,t,i,r){if(null==e)return-1;const n=i.length,s=e.data,a=e.url;if(null!=s){if(s instanceof HTMLImageElement||s instanceof HTMLCanvasElement){const e=(0,ge.IR)(s);return i.push({id:n,usage:r,data:e,encoding:ie.PNG,downsampled:!1}),t.push({id:n,usage:r,encodings:[{name:void 0,encoding:ie.PNG}]}),n}if(s instanceof HTMLVideoElement)return-1;if(s instanceof ImageData)throw new oe.A("ImageData textures not supported yet for client side I3S nodes");if(s instanceof pe.Xi)throw new oe.A("EncodedMeshTexture textures not supported yet for client side I3S nodes")}else if(null!=a){const e=new Image;e.src=a;const s=await(0,ue.Sx)(e,e.src,!1,void 0),o=(0,ge.IR)(s);return i.push({id:n,usage:r,data:o,encoding:ie.PNG,downsampled:!1}),t.push({id:n,usage:r,encodings:[{name:void 0,encoding:ie.PNG}]}),n}return-1}class ve{constructor(e,t,i,r){this._uid=e,this._worker=r,this._id2Meta=new Map,this._oid2Meta=new Map,this._indexSR=t.indexSR,this._vertexSR=t.vertexSR,this._renderSR=t.renderSR,this._localMode=t.localMode,this._memCache=i.newCache("sl-client-mesh-data-".concat(this._uid))}get uid(){return this._uid}get worker(){return this._worker}get indexSR(){return this._indexSR}get renderSR(){return this._renderSR}createMeshNodeInfo(e,t){const i="mesh".concat(t),r=e.extent,n=r.spatialReference,s=this._indexSR,a=function(e,t){const{spatialReference:i}=e,r=[1,-1],n=[.5*e.width,.5*e.height,e.hasZ?.5*(e.zmax-e.zmin):0],s=i.isGeographic?i.metersPerUnit:1,a=e.center;let o=0;if(e.hasZ)for(let l=0;l<2;++l)for(let e=0;e<2;++e)for(let i=0;i<2;++i){const c=(a.x+r[l]*n[0]-t.x)*s,d=(a.y+r[e]*n[1]-t.y)*s,h=a.z+r[i]*n[2]-t.z;o=Math.max(c*c+d*d+h*h,o)}else for(let l=0;l<2;++l)for(let e=0;e<2;++e){const i=(a.x+r[l]*n[0]-t.x)*s,c=(a.y+r[e]*n[1]-t.y)*s;o=Math.max(i*i+c*c,o)}return(0,$.b)([t.x,t.y,t.z],Math.sqrt(o))}(r,e.origin);return z(a,n,a,s),{type:"mesh",id:i,version:be(e),oid:t,mbs:a,componentNodeIds:[],unloadedMesh:e,nodeIndex:null,loadMeshPromise:null}}addMeshNode(e,t){if(null!=this.getMeshNodeIndex(t.oid))throw new oe.A("I3SClientNodeLoader: client side mesh for feature oid=".concat(t.oid," already exists"));t.nodeIndex=e,this._id2Meta.set(t.id,t),this._oid2Meta.set(t.oid,t)}getMeshNodeIndex(e){const t=this._oid2Meta.get(e);return null==t||"mesh"!==t.type?null:t.nodeIndex}removeNode(e){const t=this._id2Meta.get(e);null!=t&&(this._id2Meta.delete(e),"mesh"===t.type&&this._oid2Meta.delete(t.oid))}async loadNodeJSON(e){const t=this._id2Meta.get(e);if(null==t)throw new oe.A("I3SClientNodeLoader::loadNodeJSON unable to find node ".concat(e));switch(t.type){case"mesh":return this._loadMeshNodeJSON(t);case"mesh-component":return this._loadMeshComponentNodeJSON(t);default:throw new oe.A("I3SClientNodeLoader::loadNodeJSON unable to handle node ".concat(e))}}async _loadMeshNodeJSON(e){const t=e.id,i=(await this._getMeshData(e)).loadedMesh;if(null==i.components||0===i.components.length)return{id:t,version:null,mbs:e.mbs,obb:null,sharedResource:null,geometryData:null,attributeData:null,featureData:null,children:null};const r=[],n=i.components;for(let s=0;s<n.length;++s){const i="".concat(t,"-component").concat(s),n={type:"mesh-component",id:i,mbs:e.mbs,componentIndex:s,meshNodeInfo:e,textureData:new Map};this._id2Meta.set(n.id,n),e.componentNodeIds.push(i),r.push({id:n.id,href:null,mbs:n.mbs,obb:null})}return{id:t,version:null,mbs:e.mbs,obb:null,sharedResource:null,geometryData:null,attributeData:null,featureData:null,children:r}}updateNodeIndex(e,t,i){const r=this._id2Meta.get(e);r&&"mesh"===r.type&&(r.nodeIndex=i)}async _loadMeshComponentNodeJSON(e){return{id:e.id,version:e.meshNodeInfo.version,mbs:e.mbs,obb:null,sharedResource:null,geometryData:null,attributeData:null,featureData:null,children:null,isEmpty:!1}}async loadNodeData(e,t){var i;const r=this._id2Meta.get(e);if(null==r||"mesh-component"!==r.type)throw new oe.A("Failed to load client node data for node ".concat(e," (unexpected node info)"));const n=r.meshNodeInfo,s=await this._getMeshData(n),a=s.loadedMesh,l=n.oid;if(null==a.components)throw new oe.A("Failed to load client node data for node ".concat(e," (unexpected null reference)"));const c=a.components[r.componentIndex],{material:d,requiredTextures:h,textureData:u}=await async function(e){const t=[],i=[];if(null==e)return{material:{alphaMode:"opaque",alphaCutoff:.1,doubleSided:!0,cullFace:0,normalTextureId:-1,emissiveTextureId:-1,occlusionTextureId:-1,emissiveFactor:[0,0,0],metallicRoughness:{baseColorFactor:[1,1,1,1],baseColorTextureId:-1,metallicRoughnessTextureId:-1,metallicFactor:0,roughnessFactor:.6000000238418579},wrapTextures:!1,hasParametersFromSource:!0},requiredTextures:t,textureData:i};const r=function(e){return e.hasOwnProperty("metallicRoughnessTexture")}(e);"auto"===e.alphaMode&&console.warn('alphaMode "auto" not supported by I3S PBRMaterial - defaulting to "blend".');const n=(0,me.Jr)({normalTexture:e.normalTexture,emissiveTexture:r?e.emissiveTexture:null,emissiveFactor:r?v.A.toUnitRGB(e.emissiveColor):null,occlusionTexture:r?e.occlusionTexture:null,metallicRoughnessTexture:r?e.metallicRoughnessTexture:null,metallicFactor:r?e.metallic:null,roughnessFactor:r?e.roughness:null}),s=n?me.mX[0]:r?e.metallic:0,a=n?me.mX[1]:r?e.roughness:0;return{material:{alphaMode:"auto"===e.alphaMode?"blend":e.alphaMode,alphaCutoff:e.alphaCutoff,doubleSided:e.doubleSided,cullFace:e.doubleSided?fe.s2.None:fe.s2.Back,normalTextureId:await _e(e.normalTexture,t,i,re.Normal),emissiveTextureId:r?await _e(e.emissiveTexture,t,i,re.Emissive):-1,occlusionTextureId:r?await _e(e.occlusionTexture,t,i,re.Occlusion):-1,emissiveFactor:r&&null!=e.emissiveColor?v.A.toUnitRGB(e.emissiveColor):[0,0,0],metallicRoughness:{baseColorFactor:null!=e.color?v.A.toUnitRGBA(e.color):[1,1,1,1],baseColorTextureId:await _e(e.colorTexture,t,i,re.Color),metallicRoughnessTextureId:r?await _e(e.metallicRoughnessTexture,t,i,re.MetallicRoughness):-1,metallicFactor:s,roughnessFactor:a},wrapTextures:!0,hasParametersFromSource:n},requiredTextures:t,textureData:i}}(c.material);if(null!=u)for(const o of u)null!=o&&r.textureData.set(o.id,o);const p={params:{material:d},type:"ArrayBufferView"},{vertexSpace:f,origin:g,transform:m}=a,_=[g.x,g.y,null!==(i=g.z)&&void 0!==i?i:0],y={featureDataPosition:_,featureIds:[],geometries:[p]};s.projectionPromise||((0,le.Lw)(this._worker,"SceneLayerWorker is needed to project mesh"),s.projectionPromise=this._worker.project({positions:a.vertexAttributes.position,localMatrix:null===m||void 0===m?void 0:m.localMatrix,vertexSpace:f.toJSON(),origin:_,inSpatialReference:a.spatialReference.toJSON(),outSpatialReference:this._vertexSR.toJSON(),localMode:this._localMode},t));const{projected:b,original:x}=await s.projectionPromise;a.vertexAttributes.position=x;const{transformed:S,original:w}=await async function(e,t,i,r){const{transform:n,vertexAttributes:s}=t.loadedMesh,a="source"===e.shading?s.normal:null;if(null==a||null==n||0===n.rotationAngle&&(0,M.i)(n.scale,I.Un))return{transformed:a,original:s.normal};if(!t.normalsTransformPromise){(0,le.Lw)(i,"SceneLayerWorker is needed to transform mesh normals");const e=(0,O.vt)();(0,E.Ge)(e,n.localMatrix),t.normalsTransformPromise=i.transformNormals({normalMatrix:e,normals:a},r)}return t.normalsTransformPromise}(c,s,this._worker,t);a.vertexAttributes.normal=w,(0,o.Te)(t);const{geometryBuffer:C,geometryDescriptor:A}=function(e,t,i,r,n,s){const a=1,o=t.length/3,l=3*o;let c=0,d=0,h=!1,u=0,p=!1,f=0,g=!1,m=0,_=0,v=0;c+=xe,c+=xe,d=c,c+=3*l*Se,null!=i&&(h=!0,u=c,c+=3*l*Se),null!=r&&(p=!0,f=c,c+=2*l*Se),null!=n&&(g=!0,m=c,c+=4*l*we),_=c,c+=a*Ce,v=c,c+=2*a*xe;const y=new ArrayBuffer(c),b=new Uint8Array(y);ye(b,0,l),ye(b,xe,a);const x=new Float32Array(y,d),S=null!=i?new Float32Array(y,u):null,w=null!=r?new Float32Array(y,f):null,C=null!=n?new Uint8Array(y,m):null;for(let A=0;A<o;++A){const s=3*A;for(let a=0;a<3;++a){const o=t[s+a],l=3*o,c=9*A+3*a;if(x[c]=e[l],x[c+1]=e[l+1],x[c+2]=e[l+2],null!=S&&(S[c]=i[l],S[c+1]=i[l+1],S[c+2]=i[l+2]),null!=w){const e=2*o,t=6*A+2*a;w[t]=r[e],w[t+1]=r[e+1]}if(null!=C){const e=4*o,t=12*A+4*a;C[t]=n[e],C[t+1]=n[e+1],C[t+2]=n[e+2],C[t+3]=n[e+3]}}}return ye(b,_,s),ye(b,_+xe,s/2**32),ye(b,v,0),ye(b,v+xe,o-1),{geometryBuffer:y,geometryDescriptor:{isDraco:!1,isLegacy:!0,color:g,normal:h,uv0:p,uvRegion:!1,featureIndex:!0}}}(b,c.faces,S,a.vertexAttributes.uv,a.vertexAttributes.color,l);return{geometryData:y,attributeDataInfo:{attributeData:{},loadedAttributes:[]},geometryBuffer:C,geometryDescriptor:A,requiredTextures:h,textureData:u,normalReferenceFrame:this._vertexSR.isGeographic?"east-north-up":"vertex-reference-frame"}}async loadAttributes(e,t,i){const r=e.numFeatures,n={};for(const{field:{name:s}}of t)n[s]=new Array(r);return n}async loadTextures(e,t,i){const r=e.id,n=this._id2Meta.get(r);if(null==n||"mesh-component"!==n.type)throw new Error("Failed to load textures for node ".concat(e.id," (unexpected node info)"));const s=[];for(const a of t)s.push(n.textureData.get(a.id)||null);return s}async _getMeshData(e){const t=e.version,i=this._memCache.get(t);if(null==i){if(null!=e.loadMeshPromise)return e.loadMeshPromise;const i=async(i,r)=>{const n=e.unloadedMesh.clone();try{await n.load()}catch(o){r(o)}const s=n.memoryUsage,a={loadedMesh:n,projectionPromise:null,normalsTransformPromise:null,usedMemoryInBytes:s};this._memCache.put(t,a,s,ce.Ti),e.loadMeshPromise=null,i(a)};return e.loadMeshPromise=new Promise(((e,t)=>i(e,t))),e.loadMeshPromise}return i}}function ye(e,t,i){e[t]=255&i,e[t+1]=255&i>>8,e[t+2]=255&i>>16,e[t+3]=255&i>>24}function be(e){var t;const i=null===(t=e.metadata.displaySource)||void 0===t?void 0:t.source;if(null==i||!Array.isArray(i)||!i.length||i[0]instanceof File)return(0,de.lk)();const r=i;let n="";for(const s of r)n+=s.makeHash();return n+JSON.stringify(null!=e.transform?e.transform.toJSON():"")+((0,he.Hq)(e.vertexSpace)?JSON.stringify(e.vertexSpace.origin):"")}const xe=4,Se=4,we=1,Ce=8;var Ae=i(20365);let Re=class extends s.A{constructor(){super(),this.referenceCount=0,this.callbacks=new Array,this.runIndex=0}get running(){return this.callbacks.some((e=>e.running))}runTask(e){this._sort();const t=this.callbacks,i={numIndexLoading:0,numNodesLoading:0};for(let r=0;r<t.length&&!e.done;++r)t[r].priority=t[r].runTask(e,i),this.runIndex=r}_sort(){const e=this.callbacks;let t=e.length;for(let i=this.runIndex;i>0;i--){const r=e[i-1];let n=i;for(;n<e.length&&r.priority<=e[n].priority&&(n!==t||r.priority<e[n].priority);)e[n-1]=e[n],n++;e[n-1]=r,t=n-1}this.runIndex=0}add(e){this._sort(),e.priority=1/0,this.callbacks.unshift(e),this.notifyChange("running")}remove(e){(0,b.Xy)(this.callbacks,e),this.runIndex=this.callbacks.length,this._sort(),this.notifyChange("running")}};(0,r._)([(0,d.MZ)({readOnly:!0})],Re.prototype,"running",null),Re=(0,r._)([(0,u.$)("esri.views.3d.layers.i3s.I3SFrameTask")],Re);class Ee{constructor(e,t){this.task=e,this.handle=t}}const Oe=new Map;function Te(e,t){let i=Oe.get(e);if(null==i){const t=new Re,r=e.registerTask(Ae.W6.I3S_CONTROLLER,t);i=new Ee(t,r),Oe.set(e,i)}return i.task.add(t),(0,w.hA)((()=>{null!=i&&(i.task.remove(t),i.task.callbacks.length>0||(Oe.delete(e),i.handle.remove(),i.task.destroy()),i=null)}))}var Pe=i(31111),Me=i(12119),Ie=i(74279);class De{constructor(e,t,i,r,n,s,a,o){this.id=e,this.mbs=t,this.obb=i,this.version=r,this.resources=n,this.children=s,this.lodSelection=a,this.numFeatures=o}}var Le=i(95225),Fe=i(59231);class Ne{constructor(e,t,i,r,n){this.childOffset=e,this.childCount=t,this.visibilityCache=i,this.ref=r,this.node=n,this.useAsHole=0,this.filterImpact=Me.TJ.NotChecked,this.traversalState=null,this.parent=-1}}class Ve{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new Array,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new Array;this.nodes=e,this.children=t,this.lastTraversed=0,this.numNodesWithLoadedChildren=0}}class Ge{get _useNodePages(){return this._pageSize>0}constructor(e,t,i,r,n,s,a,o,l,c,d,h,u,p,f,g){var m,_;this.viewingMode=e,this._layer=t,this._streamDataController=r,this._clientNodeLoader=n,this._viewportQueries=s,this._logger=a,this.holeFilling=o,this._isLoaded=l,this._isReloading=c,this._isSelected=d,this._enable=h,this._needsUpdate=u,this._canRequest=p,this._computeVisibilityObb=f,this._computeNodeFiltering=g,this._dirty=!0,this._nodePages=new Map,this._clientNodePage=null,this._pageSize=0,this._rootIndex=0,this._lodMetric=Me.cJ.None,this._lodConversion=e=>e,this._isEditable=!1,this._urlPrefix="",this._loadingNodes=new Set,this._loadingPages=new Set,this._failedNodes=new Set,this._failedPages=new Set,this._indexMissing=1,this._maxUnloadedPrio=Number.NEGATIVE_INFINITY,this._maxProcessingPrio=Number.POSITIVE_INFINITY,this._version=je(0),this._visibilityCacheVersion=je(0),this._maxLevel=1,this._featureEstimate={estimate:0,leavesReached:!1},this._unloadedMemoryEstimate=0,this._missingPagesAndNodes=new C.A({deallocator:null}),this._prefetchNodes=new C.A({deallocator:null}),this._updates=new ze(this._missingPagesAndNodes),this._imModificationUncategorized=new C.A({deallocator:null}),this.ignoreServiceObb=!1,this.progressiveLoadPenalty=0,this._pageQueue=new Array,this._newPages=new Array,this.needNodeElevationRange=!1,this.layerHasModifications=!1,this._layerHasFilter=!1,this._frameNumber=0,this._traverseDescendantsQueue=[0],this._traverseDescendantsNestingLevel=0,this._isEditable=(0,Pe.lC)()&&null!=(null===(m=t.associatedLayer)||void 0===m?void 0:m.infoFor3D),null!==(_=t.serviceUpdateTimeStamp)&&void 0!==_&&_.lastUpdate&&(this._lastUpdate="".concat(t.serviceUpdateTimeStamp.lastUpdate)),this._maxLodLevel=this._viewportQueries?this._viewportQueries.maxLodLevel:1,this._init(i)}_init(e){if("page"===e.type){const t=e.rootPage;switch(this._urlPrefix=e.urlPrefix,this._pageSize=e.pageSize,e.lodMetric){case"maxScreenThreshold":this._lodMetric=Me.cJ.MaxScreenThreshold;break;case"maxScreenThresholdSQ":this._lodMetric=Me.cJ.MaxScreenThreshold,this._lodConversion=$e}if(this._isEditable){this._rootIndex=-1;const i=Qe(e.rootIndex,e.pageSize),r=t.nodes[i],n={nodes:[{index:this._rootIndex,children:[e.rootIndex],mesh:void 0,obb:r.obb,lodThreshold:r.lodThreshold}]};this._addPage(qe(this._rootIndex,this._pageSize),n),this.getNode(-1).serviceObbInIndexSR=void 0}else this._rootIndex=e.rootIndex;this._addPage(qe(e.rootIndex,this._pageSize),t),this._updateParentsAndLevel()}else if("node"===e.type){this._urlPrefix=e.urlPrefix;const t=new Ve;if(this._nodePages.set(0,t),this._isEditable){this._clientNodePage=new Ve;const t={id:"-1",version:null,mbs:e.rootNode.mbs,obb:e.rootNode.obb,sharedResource:null,geometryData:null,attributeData:null,featureData:null,children:[{id:"root",href:"../root",mbs:e.rootNode.mbs,obb:e.rootNode.obb}]};this._rootIndex=this._makeClientRefNode(new Me.ay(t.id,null),-1);const i=this._validateNode(t.id,t);i&&this._addNode(i,this._rootIndex)}else this._rootIndex=this._makeRefNode(new Me.ay(e.rootNode.id,null),-1);const i=this._validateNode(e.rootNode.id,e.rootNode);i&&this._addNode(i,0)}}addClientNodeToIndex(e,t){const i=new Me.ay(e,t),r=this._makeClientRefNode(i,-1);return this._linkChildToParentNode(-1,r),this.requestUpdate(),r}removeClientNodeFromIndex(e,t,i){this._destroyClientRefNode(e,t,i),this.requestUpdate()}_loadPage(e){this._loadingPages.add(e);const t=this._urlPrefix+e;this._streamDataController.request(t,"json").then((t=>{this._pageQueue.push({pageIndex:e,page:t})})).catch((t=>{this._loadingPages.delete(e),(0,o.zf)(t)||(this._failedPages.add(e),this._logger.error("#loadPage()",this._layer,"Error when loading page ".concat(e),t))}))}_addQueuedPages(e){for(;this._pageQueue.length>0&&!e.done;){const{pageIndex:t,page:i}=this._pageQueue.shift();this._addPage(t,i),this._loadingPages.delete(t),e.madeProgress(),this.needNodeElevationRange&&this._newPages.push(t)}this._updateParentsAndLevel()}_invalidateElevationRangeForNewPages(e){if(this.needNodeElevationRange)for(;this._newPages.length>0&&!e.done;){const e=this._nodePages.get(this._newPages.shift());null===e||void 0===e||e.nodes.forEach((e=>{let t=e.parent;for(;null!=t&&t!==this._rootIndex;){const e=this.getNode(t);e&&!Number.isNaN(null===e||void 0===e?void 0:e.elevationRangeMin)&&(e.invalidateElevationRange(),this.invalidateBoundingVolumeCache(t)),t=this.getParentIndex(t)}}))}}_addPage(e,t){const i=[],r=[],n=t.nodes.map(((t,n)=>{var s,a,o;const l=i.length,c=t.children?t.children.length:0;r.push(this._rootIndex);for(let e=0;e<c;e++)i.push(t.children[e]);const d="".concat(t.index),h=Fe.ab.fromJSON(t.obb),u=(0,$.b)(h.center,h.radius),p=null===(s=t.mesh)||void 0===s?void 0:s.attribute,f=null===(a=t.mesh)||void 0===a?void 0:a.geometry,g=null===(o=t.mesh)||void 0===o?void 0:o.material,m={hasSharedResource:!1,isEmpty:null==f,attributes:null!=(null===p||void 0===p?void 0:p.resource)?"".concat(p.resource):void 0,geometry:null!=(null===f||void 0===f?void 0:f.resource)?"".concat(f.resource):void 0,texture:null!=(null===g||void 0===g?void 0:g.resource)?"".concat(g.resource):void 0,geometryDefinition:f?f.definition:-1,materialDefinition:g?g.definition:-1},_=new Me.bP(d,Je(n,e,this._pageSize),u,c,0,m,this._lastUpdate,this._lodMetric,this._lodConversion(t.lodThreshold),f?f.featureCount:null);return _.serviceObbInIndexSR=h,_.visibilityObbInRenderSR=this._computeVisibilityObb(_),_.vertexCount=f?f.vertexCount:0,new Ne(l,c,He(this._visibilityCacheVersion),null,_)})),s=new Ve(n,i);-1===e?this._clientNodePage=s:this._nodePages.set(e,s)}_updateParentsAndLevel(){const e=new Array,t=(t,i,r)=>{const n=this._getPage(t);if(null!=n){const s=Qe(t,this._pageSize),a=n.nodes[s];a.parent=null!=i?i:-1;const o=a.node;null!=o&&(o.level=r,e.push(t))}};for(t(this._rootIndex,null,0);e.length;){const i=e.pop(),r=this.getNode(i);if(null!=r)for(let e=0;e<r.childCount;e++)t(this.getChildIndex(r.index,e),i,r.level+1),this._maxLevel=Math.max(this._maxLevel,r.level+1)}}_getPage(e){const t=qe(e,this._pageSize);return this._getPageFromPageIndex(t)}_getPageFromPageIndex(e){return e<0?this._clientNodePage:this._nodePages.get(e)}_getNodeInternal(e){const t=this._getPage(e);return null==t?null:(t.lastTraversed=this._frameNumber,t.nodes[Qe(e,this._pageSize)])}_addNode(e,t){e.children&&this.populateChildren(t,e.children);const i=this.getParent(t),r=null!=i?i.level+1:0;this._maxLevel=Math.max(this._maxLevel,e.children?r+1:r);const{lodMetric:n,maxError:s}=function(e){if(e)for(let t=0;t<e.length;t++)for(const i of Ye)if(i[0]===e[t].metricType)return{lodMetric:i[1],maxError:e[t].maxError};return{lodMetric:Me.cJ.None,maxError:0}}(e.lodSelection),a=this._getNodeInternal(t),o=new Me.bP(e.id,t,e.mbs,a.childCount,r,e.resources,e.version,n,s,e.numFeatures);a.node=o,e.obb&&(o.serviceObbInIndexSR=Fe.ab.fromJSON(e.obb)),o.visibilityObbInRenderSR=this._computeVisibilityObb(o);const l=a.ref;return null!=l&&(null==l.serviceMbsInIndexSR&&(l.serviceMbsInIndexSR=e.mbs),o.shareServiceBVsInRenderSRWith(l),l.visibilityObbInRenderSR=o.visibilityObbInRenderSR),o}_makeRefNode(e,t){const i=this._nodePages.get(0);if(t<-1)return this._makeClientRefNode(e,t);if(null==i)return-1;const r=i.nodes.length,n=new Ne(0,0,He(this._visibilityCacheVersion),e,null);return i.nodes.push(n),n.parent=t,e.invalidateServiceBVsInRenderSR(),r}_makeClientRefNode(e,t){const i=this._clientNodePage;if(null==i)return-1;if(t>=0)throw new Error("I3SIndex::client side nodes can not be made children of service side nodes.");const r=-(i.nodes.length+1),n=new Ne(0,0,He(this._visibilityCacheVersion),e,null);return i.nodes.push(n),n.parent=t,e.invalidateServiceBVsInRenderSR(),r}_linkChildToParentNode(e,t){const i=this._clientNodePage;if(null==i||e>=0)return;const r=Qe(e,this._pageSize),n=Qe(t,this._pageSize),s=i.nodes[r],a=s.childOffset;i.children.splice(s.childOffset+s.childCount,0,t);s.childCount+=1,null!=s.node&&(s.node.childCount+=1);for(const o of i.nodes)o.childOffset>a&&(o.childOffset+=1);i.nodes[n].parent=e,this._updateParentBoundingInformation(e)}_destroyClientRefNode(e,t,i){const r=this._clientNodePage;if(null==r)return;const n=this.getParentIndex(e);if(null==n)return;const s=new Set,a=new Map,o=e=>{var i,n,a;const l=Qe(e,this._pageSize),c=r.nodes[l];if(c.childCount>0)for(let t=c.childOffset;t<c.childOffset+c.childCount;++t)o(r.children[t]);const d=null!==(i=null===(n=c.node)||void 0===n?void 0:n.id)&&void 0!==i?i:null===(a=c.ref)||void 0===a?void 0:a.id;if(null==d)throw new Error("Node has no id");t(d,e),s.add(c)};o(e);const l=r.nodes,c=r.children,d=r.nodes.map((()=>-1)),h=[],u=[];for(let m=0;m<l.length;++m){const e=l[m];if(s.has(e))continue;const t=h.length,r=Je(m,-1,this._pageSize),n=Je(t,-1,this._pageSize);if(e.node&&(e.node.index=n),d[m]=n,h.push(e),r!==n){var p,f,g;const t=null!==(p=null===(f=e.node)||void 0===f?void 0:f.id)&&void 0!==p?p:null===(g=e.ref)||void 0===g?void 0:g.id;if(null==t)throw new Error("Node has no id");i(t,r,n),a.set(r,n)}}for(let m=0;m<h.length;++m){const e=Je(m,-1,this._pageSize),t=h[m],i=u.length;for(let r=t.childOffset;r<t.childOffset+t.childCount;++r){const t=c[r];if(t>=0)u.push(t);else{const i=Qe(t,this._pageSize),r=l[i];if(s.has(r))continue;const n=d[i];u.push(n),r.parent=e}}t.childOffset=i,t.childCount=u.length-i,t.node&&(t.node.childCount=t.childCount)}r.nodes=h,r.children=u,this._updateParentBoundingInformation(d[Qe(n,this._pageSize)])}_updateParentBoundingInformation(e){let t=e;do{var i;let e=null;const r=this._clientNodeLoader.indexSR,n=this._clientNodeLoader.renderSR,s=this._getNodeInternal(t);if(null==s)return;for(let i=0;i<s.childCount;i++){const s=this.getChildIndex(t,i),a=this._getNodeInternal(s),o=null!=a?a.ref||a.node:null;if(null!=o&&o.serviceMbsInIndexSR[3]>0)if(null==e)e=(0,$.c)(o.serviceMbsInIndexSR,Ke);else{const t=et,i=tt,s=it;z(o.serviceMbsInIndexSR,r,t,n),z(e,r,i,n),(0,$.u)(t,i,s),z(s,n,e,r)}}const a=s.ref||s.node;null!=a&&(null!=e?(null!==(i=a.serviceMbsInIndexSR)&&void 0!==i||(a.serviceMbsInIndexSR=(0,$.d)()),(0,$.c)(e,a.serviceMbsInIndexSR)):(0,Ie.Q7)(a.serviceMbsInIndexSR),a.invalidateServiceBVsInRenderSR(),a.geometryObbInRenderSR=null),this.invalidateNodeVisibilityCacheInternal(s),t=this.getParentIndex(t)}while(null!=t)}populateChildren(e,t){const i=this._getNodeInternal(e),r=this._getPage(e);i.childOffset=r.children.length,i.childCount=t.length;for(let n=0;n<t.length;n++){const i=this._makeRefNode(t[n],e);r.children.push(i)}}getNode(e){const t=this._getNodeInternal(e);return null!=t?t.node:null}getIndexById(e){let t;return this._forAllNodes(((i,r)=>{(null!=i.node&&i.node.id===e||null!=i.ref&&i.ref.id===e)&&(t=r)})),t}getNodeById(e){const t=this.getIndexById(e);return null!=t&&t>=0?this.getNode(t):null}getChildIndex(e,t){const i=this._getPage(e);if(null==i)return-1;const r=i.nodes[Qe(e,this._pageSize)];return i.children[r.childOffset+t]}getParentIndex(e){const t=this._getPage(e);return null!=t&&e!==this._rootIndex?t.nodes[Qe(e,this._pageSize)].parent:null}getParent(e){const t=this.getParentIndex(e);return null!=t?this.getNode(t):null}isLeaf(e){const t=this._getNodeInternal(e);return null!=t&&0===t.childCount}get rootNode(){return this.getNode(this._rootIndex)}get isEditable(){return this._isEditable}removeAllGeometryObbs(){this._forAllNodes((e=>{null!=e.node&&(e.node.geometryObbInRenderSR=null)}))}invalidateVisibilityCache(){this._visibilityCacheVersion=je(this._visibilityCacheVersion)}invalidateNodeVisibilityCache(e){const t=this._getNodeInternal(e);null!=t&&this.invalidateNodeVisibilityCacheInternal(t)}invalidateNodeVisibilityCacheInternal(e){e.visibilityCache=He(this._visibilityCacheVersion)}invalidateBoundingVolumeCache(e){const t=this._getNodeInternal(e);null!=t&&(Be(t),this.invalidateNodeVisibilityCacheInternal(t))}updateElevationChanged(e){const t=this._getNodeInternal(e);if(null==t)return;if(!this.needNodeElevationRange)return void this.invalidateBoundingVolumeCache(e);const i=null!=t.node?t.node:t.ref;null!=i&&i.invalidateElevationRange()}invalidateGeometryVisibility(e){const t=this._getNodeInternal(e),i=null===t||void 0===t?void 0:t.node;i&&(i.geometryObbInRenderSR=null,i.invalidateServiceBVsInRenderSR())}invalidateVisibilityObbs(){null!=this.rootNode&&this.traverse(this.rootNode,(e=>(e.visibilityObbInRenderSR=this._computeVisibilityObb(e),e.geometryObbInRenderSR=null,!0)))}_updateElevationRange(e){this._updateElevationRangeInternal(e,null)}_updateElevationRangeInternal(e,t){var i,r,n;const s=this._getNodeInternal(e);if(!s)return!1;const a=null!==(i=null===s||void 0===s?void 0:s.node)&&void 0!==i?i:null===s||void 0===s?void 0:s.ref;if(!a)return!1;if(a.elevationRangeValid)return null!==t&&void 0!==t&&t.expandElevationRange(a),!0;const o=new Le.H;let l=!1;for(let u=0;u<s.childCount;u++){const t=this.getChildIndex(e,u),i=this._updateElevationRangeInternal(t,o);l=l||!i}if(0===s.childCount||l){var c;const e=!(null!==(c=s.node)&&void 0!==c&&c.resources.isEmpty);this._viewportQueries.expandElevationRange(a,e,o)}const d=a.elevationRangeMin,h=a.elevationRangeMax;return d===o.elevationRangeMin&&h===o.elevationRangeMax?(null!==t&&void 0!==t&&t.expandElevationRange(a),!0):(null!==(r=s.node)&&void 0!==r&&r.setElevationRange(o),null!==(n=s.ref)&&void 0!==n&&n.setElevationRange(o),this.invalidateBoundingVolumeCache(e),null!==t&&void 0!==t&&t.expandElevationRange(a),!0)}isNodeVisible(e){const t=this._getNodeInternal(e);if(null==t)return!0;const i=t.ref;if(null!=i&&!i.serviceMbsInIndexSR)return!0;if(!this.needNodeElevationRange&&ke(t.visibilityCache,this._visibilityCacheVersion))return Ze(t.visibilityCache);const r=t.node,n=this._viewportQueries;if(r&&r.level>0){n.ensureElevationAgnosticBoundingVolume(r,this.viewingMode);const e=r.elevationAgnosticBoundingVolume;if(!n.isElevationAgnosticBoundingVolumeVisible(this.viewingMode,e))return t.visibilityCache=We(!1,this._visibilityCacheVersion),!1}if(this.needNodeElevationRange&&this._updateElevationRange(e),!ke(t.visibilityCache,this._visibilityCacheVersion)){if(this._layerHasFilter&&this._computeNodeFiltering&&(null!=r||null!=i)&&t.filterImpact===Me.TJ.NotChecked){const e=null!=r?r.serviceMbsInIndexSR:null!=i?i.serviceMbsInIndexSR:null;t.filterImpact=null!=e?this._computeNodeFiltering(e):Me.TJ.Unmodified}const e=null!=r&&t.filterImpact===Me.TJ.Culled,s=null!=r&&r.imModificationImpact===Me.Js.Culled,a=!r||i&&!r.visibilityObbInRenderSR?null!==i&&void 0!==i?i:null:r,o=!s&&(!a||n.isNodeVisible(a))&&!e;return t.visibilityCache=We(o,this._visibilityCacheVersion),o}return Ze(t.visibilityCache)}isGeometryVisible(e){var t;if(!this.isNodeVisible(e))return!1;const i=this._getNodeInternal(e);return!!(null==(null===i||void 0===i||null===(t=i.node)||void 0===t?void 0:t.geometryObbInRenderSR)||this.layerHasModifications&&i.node.imModificationImpact===Me.Js.NotChecked)||this._viewportQueries.isGeometryVisible(i.node)}_traverseCoverage(e,t,i,r,n){const s=this._getPage(e);if(null==s||0===t.childCount)return;const a=t.childOffset+t.childCount,o=new Array;for(let l=t.childOffset;l<a;++l){const e=s.children[l],t=this._getNodeInternal(e);null!=(null===t||void 0===t?void 0:t.node)&&this.isGeometryVisible(e)&&o.push(t)}r/=o.length;for(const l of o){const e=l.node.index;this._isLoaded(e)||this._isReloading(e)?(n.delta=Math.max(n.delta,i),n.coverage+=r):this._traverseCoverage(e,l,i+1,r,n)}}useNodeAsHole(e){if("off"===this.holeFilling)return!1;const t=this._getNodeInternal(e);if(null==t)return!1;if("always"===this.holeFilling)return!0;if(ke(t.useAsHole,this._version))return Ze(t.useAsHole);const i={delta:0,coverage:0};this._traverseCoverage(e,t,0,1,i);const r=i.delta*i.coverage<=.5;return t.useAsHole=We(r,this._version),r}get maxLevel(){return this._maxLevel}get dirty(){return this._dirty}destroy(){this._updates.add.prune(),this._updates.update.prune()}requestUpdate(){this._dirty=!0,this._indexMissing=1,this._version=je(this._version)}imModificationsChanged(e){this.layerHasModifications=e,this._forAllNodes((e=>{let{node:t}=e;null!=t&&(t.imModificationImpact=Me.Js.NotChecked,t.visibilityObbInRenderSR=this._computeVisibilityObb(t),t.hasModifications&&this.invalidateGeometryVisibility(t.index))})),this.invalidateVisibilityCache()}layerFilterChanged(e){this._layerHasFilter=e,this._forAllNodes((e=>{if(null!=e){e.filterImpact=Me.TJ.NotChecked;const t=e.node;null!=t&&this.invalidateNodeVisibilityCache(t.index)}})),this.invalidateVisibilityCache()}update(e,t,i){if(!this._dirty)return;this._pageQueue.length>0&&this._addQueuedPages(t),this._invalidateElevationRangeForNewPages(t),this._maxUnloadedPrio=Number.NEGATIVE_INFINITY,this._maxProcessingPrio=Number.NEGATIVE_INFINITY,this._missingPagesAndNodes.clear(),this._prefetchNodes.clear(),this._updates.reset(e),Ue.clear();let r=!0;const n=new Xe,s=new Xe,a=this._imModificationUncategorized;a.clear();const o=new Set;let l=0;this.traverseVisible(((o,c,d)=>{const h=qe(o,this._pageSize);if(null==c){let e=this._entryPriority(o);return e===1/0&&(e=this._entryPriority(d)),Ue.set(h,Math.max(e,Ue.get(h)||0)),this._loadingPages.has(h)||this._failedPages.has(h)||(this._missingPagesAndNodes.push(h),++l),void(this._maxProcessingPrio=Math.max(this._maxProcessingPrio,e))}const u=c.node;if(this._updateNodeFeatureEstimate(u,s),null==u){const e=this._entryPriority(o);return this._loadingNodes.has(o)||this._failedNodes.has(o)||(this._missingPagesAndNodes.push(o),Ue.set(o,e)),void(this._maxProcessingPrio=Math.max(this._maxProcessingPrio,e))}const p=this._getPage(o);if(0===this._missingPagesAndNodes.length&&!this._useNodePages)for(let e=0;e<c.childCount;e++){const t=p.children[c.childOffset+e],i=this._getNodeInternal(t);null==i||i.node||this._loadingNodes.has(t)||this._failedNodes.has(t)||(Ue.set(t,this._entryPriority(t)),this._prefetchNodes.push(t))}if(u.failed||u.resources.isEmpty)return void(r&&c.childCount>0&&this._isSelected(u)&&(r=!1));if(this._isLoaded(o)){if(n.known+=u.memory,++n.knownNodes,this._isSelected(u)?c.childCount>0&&(r=!1):(n.unremoved+=u.memory,r=!1),this._needsUpdate(u)){const e=this._entryPriority(o);Ue.set(o,e),this._maxProcessingPrio=Math.max(this._maxProcessingPrio,e),this._updates.update.push(o)}return}if(u.memory&&(n.known+=u.memory,++n.knownNodes),!this._isSelected(u))return void(this._isReloading(o)&&this._updates.remove.push(o));if(c.childCount>0&&(r=!1),u.memory?(n.missing+=u.memory,n.known+=u.memory,++n.knownNodes):++n.missingNodes,e.includes(u.index))return this._maxProcessingPrio=Math.max(this._maxProcessingPrio,this._entryPriority(o)),void(this._updates.cancel=this._updates.cancel.filter((e=>e!==u.index)));if(!t.done&&this._enable(u))return void t.madeProgress();const f=this._entryPriority(o);Ue.set(o,f),this._maxProcessingPrio=Math.max(this._maxProcessingPrio,f),this._updates.add.push(o),this.layerHasModifications&&i&&null!=u&&u.imModificationImpact===Me.Js.NotChecked&&a.push(o)}),o),this._frameNumber++,this._missingPagesAndNodes.sort(((e,t)=>e-t)),this._missingPagesAndNodes.filterInPlace(((e,t)=>t<1||this._missingPagesAndNodes.data[t-1]!==e)),this._missingPagesAndNodes.sort(((e,t)=>Ue.get(e)-Ue.get(t))),this._missingPagesAndNodes.length>0&&(this._maxUnloadedPrio=Ue.get(this._missingPagesAndNodes.back()),this._prefetchNodes.clear()),this._removeUnusedNodePages(o,l);const c=this._updates.add;c.length>0&&this.layerHasModifications&&(a.length>0&&null!==i&&void 0!==i&&i(a),c.filterInPlace((e=>{const t=this._getNodeInternal(e),i=null==(null===t||void 0===t?void 0:t.node)||t.node.imModificationImpact!==Me.Js.Culled;return i||this.invalidateNodeVisibilityCache(e),i}))),this._unloadedMemoryEstimate=n.missing-n.unremoved,n.knownNodes>3&&n.missingNodes>0&&(this._unloadedMemoryEstimate+=n.known/n.knownNodes*n.missingNodes),this._unloadedMemoryEstimate=.8*Math.max(0,this._unloadedMemoryEstimate),this._featureEstimate.estimate=this._computeFeatureEstimate(s),this._featureEstimate.leavesReached=r,this._updates.add.filterInPlace((e=>Ue.get(e)>=this._maxUnloadedPrio)).sort(((e,t)=>Ue.get(e)-Ue.get(t))),this._updates.update.sort(((e,t)=>Ue.get(e)-Ue.get(t))),this._indexMissing=this._loadingPages.size+this._loadingNodes.size+this._missingPagesAndNodes.length,this._dirty=this._indexMissing>0,Ue.clear()}checkFeatureTarget(e,t){const i=this._viewportQueries.updateScreenSpaceErrorBias(t);let r=t,n=t,s=i,a=10;for(;a--;){const i=new Xe;if(this._updateFeatureEstimate(r,i),this._computeFeatureEstimate(i)<=e){if(r>=t||i.missingNodes>0||0===a)break;s=r,r=.5*(r+n)}else n=r,r=.5*(r+s)}return this._version=je(this._version),this._viewportQueries.updateScreenSpaceErrorBias(i),Math.min(t,r)}_removeUnusedNodePages(e,t){if(!this._useNodePages)return;const i=e.size,r=this._nodePages,n=r.size+this._loadingPages.size+t;if(n>rt&&n>i){const t=new Array;for(const[i,n]of r)0!==n.numNodesWithLoadedChildren||e.has(i)||t.push([n.lastTraversed,i]);t.sort(((e,t)=>e[0]-t[0])).some((e=>{const t=e[1];return this._deleteNodePage(t),r.size<=rt}))}}_updateFeatureEstimate(e,t){this._version=je(this._version),this._viewportQueries.updateScreenSpaceErrorBias(e),this.traverseVisible(((e,i)=>this._updateNodeFeatureEstimate(null!=i?i.node:void 0,t)))}_updateNodeFeatureEstimate(e,t){null==e||e.failed||null==e.numFeatures||this._isSelected(e)&&(null!=e.numFeatures?(t.missing+=e.numFeatures,t.known+=e.numFeatures,++t.knownNodes):++t.missingNodes)}_computeFeatureEstimate(e){let t=e.known-e.unremoved;return e.knownNodes>3&&e.missingNodes>0&&(t+=e.known/e.knownNodes*e.missingNodes),Math.max(0,t)}load(){return this._load(this._missingPagesAndNodes)}prefetch(){return this._prefetchNodes.sort(((e,t)=>Ue.get(e)-Ue.get(t))),this._load(this._prefetchNodes)}_load(e){if(0===e.length||!this._canRequest())return!1;for(;e.length>0&&this._canRequest();){const t=e.pop();this._useNodePages&&t>=0?this._loadPage(t):this._loadNode(t)}return!0}get isLoading(){return this._indexMissing>0}get isPrefetching(){return this._prefetchNodes.length>0}get indexLoading(){return this._loadingPages.size+this._loadingNodes.size}get indexMissing(){return this._indexMissing}get unloadedMemoryEstimate(){return this._unloadedMemoryEstimate}get updates(){return this._updates}get featureEstimate(){return this._featureEstimate}get maxPriority(){return Math.max(this._maxProcessingPrio,this._maxUnloadedPrio)}nodeTraversalState(e){if(null==e)return null;const t=e.index,i=this._getNodeInternal(t);if(!i)return null;let r=null===i||void 0===i?void 0:i.traversalState;if(r&&ke(r.version,this._version))return r;const n=this._viewportQueries.getLodLevel(e),s=this._viewportQueries.hasLOD(e);let a=!0;if(s){const e=this.getParentIndex(t);if(null!=e){const t=this._getNodeInternal(e),i=null===t||void 0===t?void 0:t.traversalState;a=!!i&&n>i.lodLevel}else a=n>0}else a=0===e.childCount;return r?(r.lodLevel=n,r.isChosen=a,r.version=We(!0,this._version),r):(r=new Me.EG(s,a,n,We(!0,this._version)),i.traversalState=r,r)}async _loadNode(e){this._loadingNodes.add(e);const t=this._getNodeInternal(e).ref;if(null==t)return void this._failedNodes.add(e);const i=t.id,r=this._urlPrefix+i,n=()=>{this._loadingNodes.delete(e),0===this._missingPagesAndNodes.length&&0===this._loadingNodes.size&&this.requestUpdate()};let s=null;try{s=e>=0?await this._streamDataController.request(r,"json"):await this._clientNodeLoader.loadNodeJSON(i)}catch(c){return n(),void((0,o.zf)(c)||(this._logger.error("#loadNode()",this._layer,"Error loading node: "+r),this._failedNodes.add(e)))}n();const a=this._validateNode(i,s);if(null==a)return;a.obb&&this.invalidateNodeVisibilityCache(e);const l=this._addNode(a,e);this.nodeTraversalState(l)}_validateNode(e,t){var i,r;if(null==t||"object"!=typeof t||t.id!==e)return this._logger.error("#validateNode()",this._layer,'Invalid node. Wrong type or wrong id "'.concat(e,'"')),null;if(!Array.isArray(t.mbs))return this._logger.error("#validateNode()",this._layer,"Invalid bounding volume on node ".concat(e,".")),null;t.sharedResource&&"./shared"!==t.sharedResource.href&&"./shared/"!==t.sharedResource.href&&this._logger.warn("#validateNode()",this._layer,'Invalid shared resource href on node "'.concat(e,'"'));const n=t.geometryData;null==n||Array.isArray(n)&&0===n.length||Array.isArray(n)&&1===n.length&&"./geometries/0"===n[0].href||this._logger.warn("#validateNode()",this._layer,'Invalid geometry data on node "'.concat(e,'"'));const s=t.attributeData,a=this._layer.attributeStorageInfo;null==s||Array.isArray(s)&&!s.some(((e,t)=>{var i,r;return e.href!=="./attributes/".concat(null!==(i=null===a||void 0===a||null===(r=a[t])||void 0===r?void 0:r.key)&&void 0!==i?i:"f_".concat(t),"/0")}))||this._logger.warn("#validateNode()",this._layer,'Invalid attribute data on node "'.concat(e,'"')),t.featureData&&t.featureData.length>1&&this._logger.warn("#validateNode()",this._layer,"Node ".concat(e," has ").concat(t.featureData.length," bundles. Only the first bundle will be loaded."));const o=t.hasOwnProperty("obb")&&!this.ignoreServiceObb?t.obb:void 0,l=t.featureData&&1===t.featureData.length&&t.featureData[0].featureRange?t.featureData[0].featureRange[1]-t.featureData[0].featureRange[0]+1:void 0,c=Array.isArray(t.children)?t.children.map((t=>{if(null==t)return null;const i=t=>this._logger.error("#validateNode()",this._layer,"Invalid node reference on node ".concat(e,": ").concat(t));if("number"==typeof t.id)i("id ".concat(t.id," is a number instead of a string."));else if("string"!=typeof t.id||!Array.isArray(t.mbs))return i("Missing or invalid id."),null;if(!Array.isArray(t.mbs))return i("Invalid bounding volume on reference ".concat(t.id,".")),null;t.href&&t.href!=="../"+t.id&&this._logger.error("#validateNode()",this._layer,'Invalid node href on node "'.concat(e,'"'));const r=new Me.ay("".concat(t.id),t.mbs);return r.serviceObbInIndexSR=!this.ignoreServiceObb&&t.hasOwnProperty("obb")&&t.obb?Fe.ab.fromJSON(t.obb):null,r.visibilityObbInRenderSR=this._computeVisibilityObb(r),r})).filter((e=>null!=e)):null,d=null!==(i=null===(r=t.featureData)||void 0===r?void 0:r.length)&&void 0!==i&&i,h=!0===t.isEmpty;return new De(e,t.mbs,o,"string"==typeof t.version?t.version:null,{isEmpty:!d&&h,hasSharedResource:null!=t.sharedResource,attributes:t.attributeData?e:void 0,texture:t.textureData&&t.textureData.length>0?e:void 0,geometry:null!=t.geometryData?e:void 0},c,Array.isArray(t.lodSelection)?t.lodSelection:null,l)}resetFailedNodes(){this._failedNodes.clear(),this._failedPages.clear(),this._forAllNodes((e=>{null!=e.node&&(e.node.failed=!1)}))}_entryPriority(e){const t=this._getNodeInternal(e),i=this.getParentIndex(e);if(null==t||null==i&&null==t.node)return null==i?1/0:this._entryPriority(i);let r=0;if(t.node&&null!=i){const e=this._getNodeInternal(i).traversalState;null!=e&&(r=e.lodLevel)}let n=this.progressiveLoadPenalty;for(let a=e;null!=a;a=this.getParentIndex(a))if(this._isLoaded(a)){n=0;break}const s=null!=t.ref?this._viewportQueries.distToPOI(t.ref):null!=t.node?this._viewportQueries.distToPOI(t.node):0;return-s-r*(s+this.progressiveLoadPenalty)+n}traverseVisible(e,t){const i=this._getNodeInternal(this._rootIndex);null!=i?this._traverseVisible(this._rootIndex,null,i,e,t):e(this._rootIndex,null,null)}_traverseVisible(e,t,i,r,n){const s=qe(e,this._pageSize);if(n&&n.add(s),i.node&&0===i.childCount)return void(this.isGeometryVisible(e)&&r(e,i,t));if(!this.isNodeVisible(e))return;if(r(e,i,t),null==i.node)return;const a=this.nodeTraversalState(i.node);if(null!==a&&void 0!==a&&a.nodeHasLOD&&a.lodLevel===this._maxLodLevel)return;const o=this._getPageFromPageIndex(s);for(let l=0;l<i.childCount;l++){const t=o.children[i.childOffset+l],s=this._getNodeInternal(t);if(s)this._traverseVisible(t,e,s,r,n);else{if(n){const e=qe(t,this._pageSize);n.add(e)}r(t,null,e)}}}traverse(e,t){t(e)&&this.traverseDescendants(e,t)}traverseDescendants(e,t){++this._traverseDescendantsNestingLevel;const i=e.index,r=this._pageSize,n=qe(i,r),s=this._getPageFromPageIndex(n);if(null==s)return;const a=this._frameNumber,o=this._nodePages;s.lastTraversed=a;const l=Qe(i,r),c=s.nodes[l],{childCount:d}=c;if(0===d)return;const h=1===this._traverseDescendantsNestingLevel?this._traverseDescendantsQueue:[0];let u=0;const p=[];{const{childOffset:e,childCount:t}=c,{children:i}=s;h.length=2**Math.ceil(Math.log2(u+t));for(let r=e;r<e+t;++r){const e=i[r];e>=0?(h[u]=e,++u):p.push(e)}}if(p.length>0){const e=this._clientNodePage;if(e){const i=e.children;let r=0;for(;r<p.length;){const n=p[r];++r;const s=-n-1,a=e.nodes[s],o=a.node;if(!o)continue;if(!t(o))continue;const{childCount:l}=a;if(0===l)continue;const{childOffset:c}=a,d=c+l;for(let e=c;e<d;++e)p.push(i[e])}}}if(u>0){let e=0;if(r>0){let i=n*r,l=s,c=l.nodes;for(;e<u;){const n=h[e];let s;if(++e,i<=n&&n<i+r)s=l;else{const e=n/r|0,t=o.get(e);if(void 0===t)continue;s=t,s.lastTraversed=a,l=s,c=l.nodes,i=r*e}const d=c[n-i],p=d.node;if(null==p)continue;if(!1===t(p))continue;const{childCount:f}=d;if(0===f)continue;const g=u+f;for(h.length<g&&(h.length=2**Math.ceil(Math.log2(u+f)));h.length<u+f;)h.length+=h.length;const m=s.children,{childOffset:_}=d,v=_+f;for(let e=_;e<v;++e)h[u]=m[e],++u}}else{const i=o.get(0);if(i)for(;e<u;){const r=h[e];++e;const n=i.nodes[r],s=n.node;if(!s)continue;if(!t(s))continue;const{childCount:a}=n;if(0===a)continue;h.length=Math.max(h.length,2**Math.ceil(Math.log2(u+a)));const o=i.children,{childOffset:l}=n,c=l+a;for(let e=l;e<c;++e)h[u]=o[e],++u}}}--this._traverseDescendantsNestingLevel}updateChildrenLoaded(e,t){let i=this.getNode(e);for(;null!=i;){const e=i.childrenLoaded,r=e+t;i.childrenLoaded=r;const n=0===e?1:0===r?-1:0,s=i.index;0!==n&&(this._getPage(s).numNodesWithLoadedChildren+=n),i=this.getParent(s)}}checkChildrenLoadedInvariant(){if(null==this.rootNode)return!0;const e=[],t=i=>{let r=this._isLoaded(i.index)||this._isReloading(i.index)?1:0;return this.traverseDescendants(i,(e=>(r+=t(e),!1))),i.childrenLoaded!==r&&e.push(i.index),r};return t(this.rootNode),e.length&&this._logger.error("childrenLoaded invariant broken at following nodes: "+e.join(",")),e.length>0}updateElevationInfo(e,t){this.needNodeElevationRange=t&&!!e&&("relative-to-ground"===e.mode||"on-the-ground"===e.mode),this._viewportQueries.updateElevationInfo(e),this.invalidateAllElevationRanges()}invalidateAllElevationRanges(){this._forAllNodes((e=>{Be(e),null!=e.node&&e.node.invalidateElevationRange(),null!=e.ref&&e.ref.invalidateElevationRange()}))}_forAllNodes(e){if(null!=this._clientNodePage){const t=this._clientNodePage;for(let i=0;i<t.nodes.length;i++)e(t.nodes[i],-(i+1))}for(const[t,i]of this._nodePages){const r=t*this._pageSize;for(let t=0;t<i.nodes.length;t++)e(i.nodes[t],r+t)}}clearCaches(){if(this._useNodePages){const e=this._nodePages,t=new Set;this.traverseVisible((e=>t.add(qe(e,this._pageSize))));for(const[i,r]of e)if(0!==r.numNodesWithLoadedChildren||t.has(i))for(const e of r.nodes)e.traversalState=null;else this._deleteNodePage(i)}}_deleteNodePage(e){this._nodePages.delete(e)}get test(){return{addNode:(e,t)=>this._addNode(this._validateNode(e.id,e),t),getNodeInternal:e=>this._getNodeInternal(e),getPageIndex:e=>qe(e,this._pageSize),getIndexWithinPage:e=>Qe(e,this._pageSize),getNodePage:e=>e<0?this._clientNodePage:this._nodePages.get(e),getChildIndices:e=>{const t=this._getNodeInternal(e),i=this._getPage(e);if(null==t||null==i)return[];const r=[];for(let n=t.childOffset;n<t.childOffset+t.childCount;++n)r.push(i.children[n]);return r},rootIndex:this._rootIndex,clientNodePage:this._clientNodePage,nodePages:this._nodePages}}}const Ue=new Map;class ze{constructor(e){this.missing=e,this.update=new C.A({deallocator:null}),this.add=new C.A({deallocator:null}),this.remove=new C.A({deallocator:null}),this.cancel=[]}reset(e){this.add.clear(),this.update.clear(),this.cancel=e}}function Be(e){var t,i;null!==(t=e.node)&&void 0!==t&&t.invalidateServiceBVsInRenderSR(),null===(i=e.ref)||void 0===i||i.invalidateServiceBVsInRenderSR()}function He(e){return(0,Ie.b$)(e,-2)}function je(e){return(0,Ie.b$)(e,2)}function We(e,t){return t+(e?1:0)}function ke(e,t){return(-2&e)===t}function Ze(e){return 1==(1&e)}function qe(e,t){return e<0?-1:t>0?e/t|0:0}function Qe(e,t){return e<0?-e-1:0===t?e:e%t}function Je(e,t,i){return-1===t?-(e+1):0===i?e:t*i+e}const Ye=[["maxScreenThreshold",Me.cJ.MaxScreenThreshold],["screenSpaceRelative",Me.cJ.ScreenSpaceRelative],["removedFeatureDiameter",Me.cJ.RemovedFeatureDiameter],["distanceRangeFromDefaultCamera",Me.cJ.DistanceRangeFromDefaultCamera]];class Xe{constructor(){this.known=0,this.knownNodes=0,this.missing=0,this.missingNodes=0,this.unremoved=0}}function $e(e){return Math.sqrt(e*(4/Math.PI))}const Ke=(0,$.d)(),et=(0,$.d)(),tt=(0,$.d)(),it=(0,$.d)(),rt=(0,h.A)("esri-mobile")?100:300;var nt;!function(e){e[e.FadeIn=0]="FadeIn",e[e.FadeOut=1]="FadeOut"}(nt||(nt={}));class st{constructor(e){this._layerView=e,this._lodGlobalDirty=!1}startNodeLoading(e,t,i,r){this._maxLodLevel=r.maxLodLevel,this._index=i,this._isNodeInScaleBounds=e,this._removeNodes=t}shouldLoadNode(e){if(null==e)return!1;const t=this._index.nodeTraversalState(e);return!!this._isChosenMaxLOD(t)||!!t.isChosen&&this._childrenRequireLoading(e)}setLodGlobalDirty(){this._lodGlobalDirty=!0}get requiresLODGlobalHandling(){return null!=this._index&&!0===this._lodGlobalDirty}lodGlobalHandling(e){if(!this.requiresLODGlobalHandling)return!1;this._lodGlobalDirty=!1;const t=this._layerView.view.resourceController.memoryController.usedMemory,i=Math.max(0,Math.floor(10*(t-1)));at.clear(),this._lodGlobalHandling(this._index.rootNode,i,!1,!!this._layerView.nodeCrossfadingEnabled);const r=at.length;this._removeNodes(at,e);const n=at.length<r;return 0!==at.length&&(this._lodGlobalDirty=!0),at.clear(),n}_lodGlobalHandling(e,t,i,r){if(null==e)return!1;const n=e.index,s=this._index,a=this._layerView,o=s.nodeTraversalState(e),l=this._isChosenMaxLOD(o),c=e.resources.isEmpty;if(l&&c)return e.childrenLoaded>0&&this._removeChildrenRecursive(e),!0;const d=a.isNodeLoaded(n);if(r&&d&&l){const t=!i&&this.hasNoVisibleChildren(e);a.fadeNode(n,nt.FadeIn,!t)}const h=d&&(!a.isNodeFullyFadedIn||a.isNodeFullyFadedIn(n));if(d&&(a.updateNodeState(n,l?Me.UY.Leaf:Me.UY.Hole),l))return h&&this._removeChildrenRecursive(e),h;const u=e.childCount>0;let p=u;if(u)for(let m=0;m<e.childCount;m++){const e=s.getChildIndex(n,m),a=s.getNode(e);null!=a?s.isGeometryVisible(e)&&!this._lodGlobalHandling(a,t,i||h,r)&&this._isNodeInScaleBounds(a)&&(p=!1):s.isNodeVisible(e)&&(p=!1)}const f=d&&!l&&(p||at.length<t);f&&at.push(n),!r||f||!d||i||p||a.fadeNode(n,nt.FadeIn,!1);const g=e.resources.isEmpty;return p||h&&!f||g}_removeChildrenRecursive(e){this._index.traverseDescendants(e,(e=>((this._layerView.isNodeLoaded(e.index)||this._layerView.isNodeReloading(e.index))&&at.push(e.index),e.childrenLoaded>0)))}hasNoVisibleChildren(e){let t=!0;return this._index.traverseDescendants(e,(e=>!(!t||!this._index.isNodeVisible(e.index))&&(this._layerView.isNodeLoaded(e.index)?(t=!1,!1):e.childrenLoaded>0))),t}_childrenRequireLoading(e){let t=!1,i=!0;return this._index.traverseDescendants(e,(e=>{if(!i||!this._index.isNodeVisible(e.index))return!1;const r=this._index.nodeTraversalState(e);return this._isChosenMaxLOD(r)&&this._index.isGeometryVisible(e.index)&&(t=!0),this._layerView.isNodeLoaded(e.index)?(i=!1,!1):e.childrenLoaded>0})),i&&t}_isChosenMaxLOD(e){return e.isChosen&&(!e.nodeHasLOD||e.lodLevel===this._maxLodLevel)}}const at=new C.A({deallocator:null});var ot=i(98773),lt=i(53084),ct=i(90534),dt=i(62562);var ht,ut=i(90235);!function(e){e[e.Earth=1]="Earth",e[e.Mars=2]="Mars",e[e.Moon=3]="Moon",e[e.COUNT=4]="COUNT"}(ht||(ht={}));var pt=i(96897),ft=i(93345);function gt(e){return e.sort(((e,t)=>e.encoding-t.encoding))}const mt={ktx2:ie.KTX2,basis:ie.Basis,dds:ie.DDS_S3TC,png:ie.PNG,jpg:ie.JPG,"ktx-etc2":ie.KTX_ETC2},_t={[fe.JS.KTX2_ENCODING]:ie.Basis,[fe.JS.BASIS_ENCODING]:ie.Basis,[fe.JS.DDS_ENCODING]:ie.DDS_S3TC,"image/png":ie.PNG,"image/jpg":ie.JPG,"image/jpeg":ie.JPG,"image/ktx":ie.KTX_ETC2};const vt=()=>({alphaMode:"opaque",alphaCutoff:ut.H,doubleSided:!0,cullFace:fe.s2.None,normalTextureId:-1,emissiveTextureId:-1,occlusionTextureId:-1,emissiveFactor:[0,0,0],metallicRoughness:{baseColorFactor:[.8,.8,.8,1],baseColorTextureId:-1,metallicRoughnessTextureId:-1,metallicFactor:0,roughnessFactor:.6},wrapTextures:!1,hasParametersFromSource:!0});ft.pF.CLAMP_TO_EDGE,ft.pF.CLAMP_TO_EDGE,ft.pF.REPEAT,ft.pF.REPEAT;class yt{constructor(e,t,i,r,n,s){if(this._streamDataController=t,this._logger=i,this._defaultGeometrySchema=r,this._requiredAttributes=n,this._options=s,this._logLayer=e,this._layerUrl=e.parsedUrl.path,this._geometryDefinitions=e.geometryDefinitions,e.materialDefinitions){const t=e.textureSetDefinitions;this._materialAndTextures=e.materialDefinitions.map((i=>function(e,t,i){var r,n;const s=new Map,a=(e,t)=>{if(null==e)return-1;const i=s.get(e.id);if(i)return i.usage|=t,i.id;const r=s.size;return s.set(e.id,{id:r,usage:t}),r},o=t.pbrMetallicRoughness,l=null===o||void 0===o?void 0:o.baseColorFactor,c=t.emissiveFactor,d=(0,h.A)("disable-feature:diffuse-rendering-i3s")||i?(0,me.me)({normalTexture:t.normalTexture,emissiveTexture:t.emissiveTexture,emissiveFactor:t.emissiveFactor,occlusionTexture:t.occlusionTexture,metallicRoughnessTexture:null===o||void 0===o?void 0:o.metallicRoughnessTexture,metallicFactor:null===o||void 0===o?void 0:o.metallicFactor,roughnessFactor:null===o||void 0===o?void 0:o.roughnessFactor}):(0,me.Jr)({normalTexture:t.normalTexture,emissiveTexture:t.emissiveTexture,emissiveFactor:t.emissiveFactor,occlusionTexture:t.occlusionTexture,metallicRoughnessTexture:null===o||void 0===o?void 0:o.metallicRoughnessTexture,metallicFactor:null===o||void 0===o?void 0:o.metallicFactor,roughnessFactor:null===o||void 0===o?void 0:o.roughnessFactor}),u=d?me.mX[0]:null!==(r=null===o||void 0===o?void 0:o.metallicFactor)&&void 0!==r?r:me.Rk[0],p=d?me.mX[1]:null!==(n=null===o||void 0===o?void 0:o.roughnessFactor)&&void 0!==n?n:me.Rk[1],f="mask"===t.alphaMode?re.Color|re.AlphaMask:re.Color,g={baseColorFactor:l?[l[0],l[1],l[2],l[3]]:[1,1,1,1],baseColorTextureId:a(null===o||void 0===o?void 0:o.baseColorTexture,f),metallicRoughnessTextureId:a(null===o||void 0===o?void 0:o.metallicRoughnessTexture,re.MetallicRoughness),metallicFactor:u,roughnessFactor:p},m={alphaMode:t.alphaMode,alphaCutoff:t.alphaCutoff,doubleSided:t.doubleSided,cullFace:"none"===t.cullFace?fe.s2.None:"back"===t.cullFace?fe.s2.Back:"front"===t.cullFace?fe.s2.Front:fe.s2.None,normalTextureId:a(t.normalTexture,re.Normal),emissiveTextureId:a(t.emissiveTexture,re.Emissive),occlusionTextureId:a(t.occlusionTexture,re.Occlusion),emissiveFactor:c?[c[0],c[1],c[2]]:[0,0,0],metallicRoughness:g,wrapTextures:!1,hasParametersFromSource:d},_=[];return s.forEach(((t,i)=>{let{usage:r}=t;const n=null!=e&&e[i]&&e[i].formats,s=n?gt(n.map((e=>{let{name:t,format:i}=e;return{name:t,encoding:mt[i]}}))):[];_.push({id:i,usage:r,encodings:s})})),{material:m,textures:_}}(t,i,"integrated-mesh"===e.type)))}}_load(e,t,i){return this._streamDataController.request(e,t,i)}_loadAttribute(e,t,i){const r="".concat(this._layerUrl,"/nodes/").concat(e.resources.attributes,"/attributes/").concat(t.key,"/0");return this._load(r,"binary",i).then((e=>(0,dt.m0)(t,e)))}async loadAttributes(e,t,i){const r=await Promise.allSettled(t.map((t=>this._loadAttribute(e,t.attributeStorageInfo,i)))),n={};for(let s=0;s<t.length;++s){const i=r[s],a=t[s];if("fulfilled"===i.status){const e=i.value;n[a.name]=e}else{const t=i.reason;(0,o.QP)(t),this._logger.error("#loadAttributes",this._logLayer,"Failed to load attributeData for '".concat(a.name,"' on node '").concat(e.id,"'"),t)}}return n}async loadNodeData(e,t){var i;const r=null!=this._requiredAttributes&&e.resources.attributes?(0,ot.Ke)(this.loadAttributes(e,this._requiredAttributes,t)):null,{bufferDefinition:n,bufferIndex:s}=function(e,t){const i={bufferDefinition:null,bufferIndex:0},r=t.resources.geometryDefinition;if(null==e||null==r||r<0)return i;const n=r>=0?e[r].geometryBuffers:null;if(null==n)return i;for(let s=0;s<n.length;s++){const e=n[s];if(null==e.compressedAttributes)i.bufferIndex=s,i.bufferDefinition=n[s];else if("draco"===e.compressedAttributes.encoding&&!(0,h.A)("disable-feature:i3s-draco"))return i.bufferIndex=s,i.bufferDefinition=e,i}return i}(this._geometryDefinitions,e),a=!!e.resources.geometry,o=a?(0,ot.Ke)(this._loadGeometry(e.resources.geometry,s,t)):null,l=e.resources.hasSharedResource?await this._loadShared(e,t):null,c=e.resources.materialDefinition,d=this._materialAndTextures&&null!=c&&c>=0?this._materialAndTextures[c]:null!=l?function(e){var t,i;const r=null!==e&&void 0!==e&&e.materialDefinitions?Object.keys(e.materialDefinitions)[0]:null,n=null!==e&&void 0!==e&&e.textureDefinitions?Object.keys(e.textureDefinitions)[0]:null,s=r?null===(t=e.materialDefinitions)||void 0===t?void 0:t[r]:null,a=n?null===(i=e.textureDefinitions)||void 0===i?void 0:i[n]:null,o=vt();if(null!=s){const e=s.params;e.diffuse&&(o.metallicRoughness.baseColorFactor=[e.diffuse[0],e.diffuse[1],e.diffuse[2],1]),null!=e.doubleSided&&(o.doubleSided=e.doubleSided,o.cullFace=e.doubleSided?fe.s2.None:fe.s2.Back),"none"!==e.cullFace&&"front"!==e.cullFace&&"back"!==e.cullFace||(o.cullFace="none"===e.cullFace?fe.s2.None:"back"===e.cullFace?fe.s2.Back:fe.s2.Front),e.transparency&&(o.metallicRoughness.baseColorFactor[3]=(0,U.qE)(1-e.transparency,0,1)),(e.useVertexColorAlpha||o.metallicRoughness.baseColorFactor[3]<1)&&(o.alphaMode="blend")}const l=[];if(null!=a){const e=0;!a.wrap||"repeat"!==a.wrap[0]&&"repeat"!==a.wrap[1]||(o.wrapTextures=!0);let t=re.Color;"rgba"===a.channels&&(o.alphaMode="blend",t|=re.AlphaMask);const i=a.images.length-1,r=a.images[i],n=e=>null===e||void 0===e?void 0:e.split("/").pop(),s=Array.isArray(a.encoding)?gt(a.encoding.map(((e,t)=>({name:n(r.href[t]),encoding:_t[e]||0})))):[{name:n(r.href),encoding:_t[a.encoding]||0}];l.push({id:e,usage:t,encodings:s}),o.metallicRoughness.baseColorTextureId=e}return{material:o,textures:l}}(l):null,u=null===d||void 0===d?void 0:d.material,p=null!==(i=null===d||void 0===d?void 0:d.textures)&&void 0!==i?i:[],f="".concat(e.id),g=!a&&this._options.loadFeatureData,m=g?await this._loadFeatureData(f,t):null,_=g?function(e){if(!e)return null;for(const t of e.featureData){const e=t.geometries;if(null!=e)for(const i of e)return{featureIds:[t.id],featureDataPosition:t.position,geometries:[i]}}return null}(m):function(e){return{featureIds:[],geometries:[{type:"ArrayBufferView",params:{material:e}}],featureDataPosition:[0,0,0]}}(u),v=null==_?function(e){if(!e)return null;const t=new Array;for(const i of e.featureData)null!=i.position&&t.push({featureIds:[i.id],featureDataPosition:i.position,geometries:[]});return t}(m):null,y=p.length>0?(0,ot.Ke)(this.loadTextures(e,p,t)):null;let b=null,x=null;if(o){b=(0,ot.QA)(await o);const e=function(e,t){if(!e||null===t||void 0===t||!t.materialDefinitions)return e;const i=Object.keys(t.materialDefinitions)[0];return!t.materialDefinitions[i].params.vertexRegions&&e.vertexAttributes.region&&delete(e=(0,lt.o8)(e)).vertexAttributes.region,e}(this._defaultGeometrySchema,l);x=(0,dt.qs)(n,e)}const S=y?(0,ot.QA)(await y):null,w=r?(0,ot.QA)(await r):{},C=w?{attributeData:w,loadedAttributes:this._requiredAttributes}:null;if(null!=_)return{geometryData:_,attributeDataInfo:C,geometryBuffer:b,geometryDescriptor:x,requiredTextures:p,textureData:S};if(null!=v)return{pointData:v,attributeDataInfo:C,geometryBuffer:b,geometryDescriptor:x,requiredTextures:p,textureData:S};throw new Error}static _addAbsoluteHrefTexture(e,t){const i=e.textureDefinitions;if(null!=i)for(const r of Object.keys(i))for(const e of i[r].images)Array.isArray(e.href)?e.hrefConcat=e.href.map((e=>(0,ct.s2)(e,t))):e.hrefConcat=(0,ct.s2)(e.href,t)}static _fixTextureEncodings(e){const t=e.textureDefinitions;if(null!=t)for(const i in t){const e=t[i];if(Array.isArray(e.encoding))for(let t=0;t<e.encoding.length;t++){const i=e.encoding[t];"data:"===i.substring(0,5)&&(e.encoding[t]=i.substring(5))}else{const t=e.encoding;"data:"===t.substring(0,5)&&(e.encoding=t.substring(5))}}}async _loadShared(e,t){if(null==e.resources.geometry)return{};const i="".concat(this._layerUrl,"/nodes/").concat(e.resources.geometry,"/shared"),r=await this._load(i,"json",t);return yt._fixTextureEncodings(r),yt._addAbsoluteHrefTexture(r,i),r}_loadTexture(e,t,i,r,n,s){let a=!1;return n===ie.DDS_S3TC||n===ie.KTX2||n===ie.Basis?this._load(e,"binary",s).then((e=>({id:t,usage:i,data:e,encoding:n,downsampled:a}))):this._load(e,"image",s).then((e=>{let s=e;if(r&&e.width*e.height>=4096){const t=Math.ceil(e.width/2),i=Math.ceil(e.height/2),r=document.createElement("canvas");r.width=t,r.height=i,r.getContext("2d").drawImage(e,0,0,t,i),s=r,a=!0}return{id:t,usage:i,data:s,encoding:n,downsampled:a}}))}loadTextures(e,t,i){const r=!!this._options.uncompressedTextureDownsamplingEnabled,n=this._options.textureUsageMask;return Promise.all(t.map((t=>{if(0==(t.usage&n))return null;const s=function(e,t){if(null!=t)return e.find((e=>0!=(e.encoding&t)))}(t.encodings,this._options.textureEncodings);if(null==s)return this._logger.error("#loadTextures",this._logLayer,"No known encoding for texture found on node ".concat(e.id)),Promise.reject();const a=e.resources.texture||e.id,o="".concat(this._layerUrl,"/nodes/").concat(a,"/textures/").concat(s.name);return this._loadTexture(o,t.id,t.usage,r,s.encoding,i)})))}_loadFeatureData(e,t){const i="".concat(this._layerUrl,"/nodes/").concat(e,"/features/0");return this._load(i,"json",t)}_loadGeometry(e,t,i){const r="".concat(this._layerUrl,"/nodes/").concat(e,"/geometries/").concat(t);return this._load(r,"binary",i)}}class bt{constructor(e,t,i){this._requester=e,this._customParameters=t,this._apiKey=i,this._activeRequests=new Set}get busy(){return this._requester.busy}request(e,t,i){const r=new AbortController,n=(0,o.NY)(i,(()=>r.abort())),s={signal:r.signal,query:{...this._customParameters,token:this._apiKey}},a=this._requester.request(e,t,s),l={response:a,abortController:r,abortHandle:n};return this._activeRequests.add(l),(0,o.Gk)(a,(()=>{var e;l.abortController=null,null!==(e=l.abortHandle)&&void 0!==e&&e.remove(),l.abortHandle=null,this._activeRequests.delete(l)})),a}cancelAll(){this._activeRequests.forEach((e=>{var t,i;null!==(t=e.abortController)&&void 0!==t&&t.abort(),e.abortController=null,null===(i=e.abortHandle)||void 0===i||i.remove()})),this._activeRequests.clear()}}var xt=i(34111),St=i(98510),wt=i(19196),Ct=i(90707);function At(e){return"point"===e.type}class Rt{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;this.array=e,this.spatialReference=t,this.offset=i}}function Et(e){return"array"in e}function Ot(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"ground";if(At(t))return e.getElevation(t.x,t.y,t.z||0,t.spatialReference,i);if(Et(t)){var r;let n=t.offset;return e.getElevation(t.array[n++],t.array[n++],t.array[n]||0,null!==(r=t.spatialReference)&&void 0!==r?r:e.spatialReference,i)}return e.getElevation(t[0],t[1],t[2]||0,e.spatialReference,i)}var Tt,Pt=i(66470);function Mt(e,t,i,r,n,s,a,o,l,c,d){const h=zt[d.mode];let u,p,f=0;if((0,k.projectBuffer)(e,t,i,r,l.spatialReference,n,o))return h.requiresAlignment(d)?(f=h.applyElevationAlignmentBuffer(r,n,s,a,o,l,c,d),u=s,p=a):(u=r,p=n),(0,k.projectBuffer)(u,l.spatialReference,p,s,c.spatialReference,a,o)?f:void 0}function It(e,t,i,r,n){const s=(At(e)?e.z:Et(e)?e.array[e.offset+2]:e[2])||0;switch(i.mode){case"on-the-ground":{var a;const i=null!==(a=Ot(t,e,"ground"))&&void 0!==a?a:0;return n.verticalDistanceToGround=0,n.sampledElevation=i,void(n.z=i)}case"relative-to-ground":{var o;const a=null!==(o=Ot(t,e,"ground"))&&void 0!==o?o:0,l=i.geometryZWithOffset(s,r);return n.verticalDistanceToGround=l,n.sampledElevation=a,void(n.z=l+a)}case"relative-to-scene":{var l;const a=null!==(l=Ot(t,e,"scene"))&&void 0!==l?l:0,o=i.geometryZWithOffset(s,r);return n.verticalDistanceToGround=o,n.sampledElevation=a,void(n.z=o+a)}case"absolute-height":{var c;const a=i.geometryZWithOffset(s,r),o=null!==(c=Ot(t,e,"ground"))&&void 0!==c?c:0;return n.verticalDistanceToGround=a-o,n.sampledElevation=o,void(n.z=a)}default:return void(n.z=0)}}function Dt(e,t,i,r){return It(e,t,i,r,Ht),Ht.z}function Lt(e,t,i){return null==t||null==i?e.definedChanged:"on-the-ground"===t&&"on-the-ground"===i?e.staysOnTheGround:t===i||"on-the-ground"!==t&&"on-the-ground"!==i?Tt.UPDATE:e.onTheGroundChanged}function Ft(e){return"relative-to-ground"===e||"relative-to-scene"===e}function Nt(e){return"absolute-height"!==e}function Vt(e,t,i,r,n){It(t,i,n,r,Ht),Gt(e,Ht.verticalDistanceToGround);const s=Ht.sampledElevation,a=(0,T.C)(Bt,e.transformation);return jt[0]=t.x,jt[1]=t.y,jt[2]=Ht.z,(0,Ct.l)(t.spatialReference,jt,a,r.spatialReference)?e.transformation=a:console.warn("Could not locate symbol object properly, it might be misplaced"),s}function Gt(e,t){for(let i=0;i<e.geometries.length;++i){const r=e.geometries[i].getMutableAttribute(Pt.r.CENTEROFFSETANDDISTANCE);r&&r.data[3]!==t&&(r.data[3]=t,e.geometryVertexAttributeUpdated(e.geometries[i],Pt.r.CENTEROFFSETANDDISTANCE))}}class Ut{constructor(){this.verticalDistanceToGround=0,this.sampledElevation=0,this.z=0}}!function(e){e[e.NONE=0]="NONE",e[e.UPDATE=1]="UPDATE",e[e.RECREATE=2]="RECREATE"}(Tt||(Tt={}));const zt={"absolute-height":{applyElevationAlignmentBuffer:function(e,t,i,r,n,s,a,o){const l=o.calculateOffsetRenderUnits(a),c=o.featureExpressionInfoContext;t*=3,r*=3;for(let d=0;d<n;++d){const n=e[t],s=e[t+1],a=e[t+2];i[r]=n,i[r+1]=s,i[r+2]=null==c?a+l:l,t+=3,r+=3}return 0},requiresAlignment:function(e){const t=e.meterUnitOffset,i=e.featureExpressionInfoContext;return 0!==t||null!=i}},"on-the-ground":{applyElevationAlignmentBuffer:function(e,t,i,r,n,s){let a=0;const o=s.spatialReference;t*=3,r*=3;for(let c=0;c<n;++c){var l;const n=e[t],c=e[t+1],d=e[t+2],h=null!==(l=s.getElevation(n,c,d,o,"ground"))&&void 0!==l?l:0;a+=h,i[r]=n,i[r+1]=c,i[r+2]=h,t+=3,r+=3}return a/n},requiresAlignment:()=>!0},"relative-to-ground":{applyElevationAlignmentBuffer:function(e,t,i,r,n,s,a,o){let l=0;const c=o.calculateOffsetRenderUnits(a),d=o.featureExpressionInfoContext,h=s.spatialReference;t*=3,r*=3;for(let p=0;p<n;++p){var u;const n=e[t],a=e[t+1],o=e[t+2],p=null!==(u=s.getElevation(n,a,o,h,"ground"))&&void 0!==u?u:0;l+=p,i[r]=n,i[r+1]=a,i[r+2]=null==d?o+p+c:p+c,t+=3,r+=3}return l/n},requiresAlignment:()=>!0},"relative-to-scene":{applyElevationAlignmentBuffer:function(e,t,i,r,n,s,a,o){let l=0;const c=o.calculateOffsetRenderUnits(a),d=o.featureExpressionInfoContext,h=s.spatialReference;t*=3,r*=3;for(let p=0;p<n;++p){var u;const n=e[t],a=e[t+1],o=e[t+2],p=null!==(u=s.getElevation(n,a,o,h,"scene"))&&void 0!==u?u:0;l+=p,i[r]=n,i[r+1]=a,i[r+2]=null==d?o+p+c:p+c,t+=3,r+=3}return l/n},requiresAlignment:()=>!0}},Bt=(0,P.vt)(),Ht=new Ut,jt=(0,I.vt)();i(35238);var Wt=i(19902),kt=i(13312);function Zt(e){return"declaredClass"in e}function qt(e){return"declaredClass"in e}function Qt(e,t){return e?function(e){return"declaredClass"in e}(e)?e:new y.A({layer:t,sourceLayer:t,visible:e.visible,symbol:(0,lt.o8)(e.symbol),attributes:(0,lt.o8)(e.attributes),geometry:Jt(e.geometry)}):null}function Jt(e){return null==e?null:Zt(e)?e:(0,Wt.rS)(function(e){const{wkid:t,wkt:i,wkt2:r,latestWkid:n}=e.spatialReference,s={wkid:t,wkt:i,wkt2:r,latestWkid:n};switch(e.type){case"point":{const{x:t,y:i,z:r,m:n}=e;return{x:t,y:i,z:r,m:n,spatialReference:s}}case"polygon":{const{rings:t,hasZ:i,hasM:r}=e;return{rings:Yt(t),hasZ:i,hasM:r,spatialReference:s}}case"polyline":{const{paths:t,hasZ:i,hasM:r}=e;return{paths:Yt(t),hasZ:i,hasM:r,spatialReference:s}}case"extent":{const{xmin:t,xmax:i,ymin:r,ymax:n,zmin:a,zmax:o,mmin:l,mmax:c,hasZ:d,hasM:h}=e;return{xmin:t,xmax:i,ymin:r,ymax:n,zmin:a,zmax:o,mmin:l,mmax:c,hasZ:d,hasM:h,spatialReference:s}}case"multipoint":{const{points:t,hasZ:i,hasM:r}=e;return{points:$t(t)?Xt(t):t,hasZ:i,hasM:r,spatialReference:s}}default:return}}(e))}function Yt(e){return function(e){for(const t of e)if(0!==t.length)return $t(t);return!1}(e)?e.map((e=>Xt(e))):e}function Xt(e){return e.map((e=>Array.from(e)))}function $t(e){return e.length>0&&((0,A.vZ)(e[0])||(0,A.aI)(e[0]))}var Kt=i(98976);async function ei(e,t,i,r){const n=null===e||void 0===e?void 0:e.expression;if("string"!=typeof n)return null;const s=ai(n);if(null!=s)return{cachedResult:s};const a=await(0,Kt.lw)();(0,o.Te)(i);const l=a.arcadeUtils,c=l.createSyntaxTree(n);return l.dependsOnView(c)?(null!=r&&r.error("Expressions containing '$view' are not supported on ElevationInfo"),{cachedResult:0}):{arcade:{func:l.createFunction(c),context:l.createExecContext(null,{sr:t}),modules:a}}}function ti(e,t,i){return e.arcadeUtils.createFeature(t.attributes,t.geometry,i)}function ii(e,t){if(null!=e&&!si(e)){if(!t||!e.arcade)return void a.A.getLogger("esri.views.3d.layers.graphics.featureExpressionInfoUtils").errorOncePerTick("Arcade support required but not provided");const i=t;i._geometry&&(i._geometry=Jt(i._geometry)),e.arcade.modules.arcadeUtils.updateExecContext(e.arcade.context,t)}}function ri(e){var t,i;let r=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=null===e||void 0===e?void 0:e.featureExpressionInfo;const s=null===(t=n)||void 0===t?void 0:t.expression;return r||"0"===s||(n=null),null!==(i=n)&&void 0!==i?i:null}const ni={cachedResult:0};function si(e){return null!=e.cachedResult}function ai(e){return"0"===e?0:null}class oi{constructor(){this._meterUnitOffset=0,this._renderUnitOffset=0,this._unit="meters",this._metersPerElevationInfoUnit=1,this._featureExpressionInfoContext=null,this.centerPointInElevationSR=null,this.mode=null}get featureExpressionInfoContext(){return this._featureExpressionInfoContext}get meterUnitOffset(){return this._meterUnitOffset}get unit(){return this._unit}set unit(e){this._unit=e,this._metersPerElevationInfoUnit=(0,_.Ao)(e)}get requiresSampledElevationInfo(){return"absolute-height"!==this.mode}reset(){this.mode=null,this._meterUnitOffset=0,this._renderUnitOffset=0,this._featureExpressionInfoContext=null,this.unit="meters"}set offsetMeters(e){this._meterUnitOffset=e,this._renderUnitOffset=0}set offsetElevationInfoUnits(e){this._meterUnitOffset=e*this._metersPerElevationInfoUnit,this._renderUnitOffset=0}addOffsetRenderUnits(e){this._renderUnitOffset+=e}geometryZWithOffset(e,t){const i=this.calculateOffsetRenderUnits(t);return null!=this.featureExpressionInfoContext?i:e+i}calculateOffsetRenderUnits(e){let t=this._meterUnitOffset;const i=this.featureExpressionInfoContext;return null!=i&&(t+=function(e){if(null!=e){if(si(e))return e.cachedResult;const t=e.arcade;let i=null===t||void 0===t?void 0:t.modules.arcadeUtils.executeFunction(t.func,t.context);return"number"!=typeof i&&(e.cachedResult=0,i=0),i}return 0}(i)*this._metersPerElevationInfoUnit),t/e.unitInMeters+this._renderUnitOffset}setFromElevationInfo(e){var t;this.mode=e.mode,this.unit=(0,_.Tg)(e.unit)?e.unit:"meters",this.offsetElevationInfoUnits=null!==(t=e.offset)&&void 0!==t?t:0}updateFeatureExpressionInfoContext(e,t,i){if(null==e)return void(this._featureExpressionInfoContext=null);const r=null===e||void 0===e?void 0:e.arcade;r&&null!=t&&null!=i?(this._featureExpressionInfoContext=function(e){return{cachedResult:e.cachedResult,arcade:e.arcade?{func:e.arcade.func,context:e.arcade.modules.arcadeUtils.createExecContext(null,{sr:e.arcade.context.spatialReference}),modules:e.arcade.modules}:null}}(e),ii(this._featureExpressionInfoContext,ti(r.modules,t,i))):this._featureExpressionInfoContext=e}static fromElevationInfo(e){const t=new oi;return null!=e&&t.setFromElevationInfo(e),t}}const li=1e5;class ci{constructor(e,t,i,r,n,s,a,o){let l=arguments.length>8&&void 0!==arguments[8]?arguments[8]:{};this._indexSR=e,this._renderCoordsHelper=t,this._clippingArea=n,this._elevationProvider=s,this._viewingMode=a,this._options=l,this._frustum=(0,wt.vt)(),this._frustumMbs=(0,L.vt)(),this._useFrustumCulling=!1,this._poi=(0,I.vt)(),this._elevationContext=null,this.minDistance=1/0,this.maxDistance=0,this.maxLodLevel=2,this._tmpObb=new Fe.ab,this._tmp1=(0,I.vt)(),this._tmp2=(0,I.vt)(),this._tmp3=(0,I.vt)(),this._tmp0=(0,I.vt)(),this._screenspaceErrorBias=l.screenspaceErrorBias||1,this._progressiveLoadFactor=l.progressiveLoadFactor||1,this.updateCamera(i,r);const c=this._renderCoordsHelper.spatialReference;this._renderSR=c,this._renderSRSphericalPCPF=(0,St.lO)(c),this._isGlobalMode=c===this._renderSRSphericalPCPF,this.updateElevationInfo(o),this._tmpPoint=(0,ne.T)(0,0,0,e),this._isECEFOBBInLocalMode=this._indexSR.isWGS84&&(c.isWebMercator||(0,G.r1)(c)),this._indexSREllipsoidRadius=(0,xt.tO)(this._indexSR).radius,this._indexSRSphericalPCPF=(0,St.lO)(e),this._projectorIndexSRToIndexSRSphericalPCPF=(0,N.jd)(this._indexSR,this._indexSRSphericalPCPF)}updateElevationInfo(e){null!=e?(this._elevationContext=oi.fromElevationInfo(e),this._elevationContext.updateFeatureExpressionInfoContext(function(e){const t=null===e||void 0===e?void 0:e.expression;if("string"==typeof t){const e=ai(t);if(null!=e)return{cachedResult:e}}return null}(ri(e,!1)))):this._elevationContext=null}updateCamera(e,t){if(this._useFrustumCulling=t,t){(0,wt.ui)(e.viewMatrix,e.projectionMatrix,this._frustum,hi);{const t=e.eye,i=di;(0,M.n)(i,e.viewForward);const r=ui;(0,M.y)(r,hi[4],t);const n=.5*(0,M.j)(r,r)/(0,M.j)(i,r),s=this._frustumMbs;(0,M.q)(s,t,i,n);const a=1+n;s[3]=a}}this._screenSizeFactor=1/(e.perScreenPixelRatio/2),this._camPos=e.eye,this.minDistance=1/0,this.maxDistance=0}setPointOfInterest(e){this._poi=e}updateScreenSpaceErrorBias(e){const t=this._screenspaceErrorBias;return this._screenspaceErrorBias=e,t}updateClippingArea(e){this._clippingArea=e}expandElevationRange(e,t,i){var r,n;if(null==this._elevationContext)return;const s=e.serviceMbsInIndexSR;if(!s)return;const a="relative-to-scene"===this._elevationContext.mode?"scene":"ground";if(this._elevationProvider.getSphereElevationBounds){const e=this._elevationProvider.getSphereElevationBounds(s,this._indexSR,a);return void(e&&i.expandElevationRange(e))}const o=s[0],l=s[1],c=s[2],d=this._elevationProvider.getElevation(o,l,c,this._indexSR,a);d&&i.expandElevationRangeValues(d,d);const h=t?null:null===(r=(n=this._elevationProvider).getRootElevationBounds)||void 0===r?void 0:r.call(n);h&&i.expandElevationRange(h)}getServiceMbsInRenderSR(e){const t=e.serviceMbsInRenderSR;if((0,Ie.hB)(t))return t;e.serviceMbsInIndexSR&&(0,D.c)(t,e.serviceMbsInIndexSR);const i=e.elevationRangeMin;if(this._elevationContext&&Number.isFinite(i)){let r=0,n=0;const s=e.elevationRangeMax;switch(this._elevationContext.mode){case"relative-to-ground":r=this._elevationContext.geometryZWithOffset(t[2],this._renderCoordsHelper)+i-t[2],n=s-i;break;case"on-the-ground":r=i-t[2],n=s-i}t[2]+=r+.5*n,t[3]+=.5*n}else this._elevationContext&&t[3]<li&&(this._tmpPoint.x=t[0],this._tmpPoint.y=t[1],this._tmpPoint.z=t[2],t[2]=Dt(this._tmpPoint,this._elevationProvider,this._elevationContext,this._renderCoordsHelper));return z(t,this._indexSR,t,this._renderSR),t}getAndUpdateVisibilityObbInRenderSR(e){{const t=e.visibilityObbInRenderSR;if(t)return t}const t=.01*this._indexSREllipsoidRadius,{serviceMbsInIndexSR:i,serviceObbInIndexSR:r}=e;if(null==r||!i||!r.isValid||this._isECEFOBBInLocalMode&&(r.halfSizeX>t||r.halfSizeY>t||r.halfSizeZ>t))return null;{let t=e.serviceObbInRenderSR;if(null==t)t=new Fe.ab,e.serviceObbInRenderSR=t;else if(t.isValid)return t;const n=i[3];let s=0,a=0;const o=r.centerZ,l=this._renderCoordsHelper,c=this._elevationContext;if(c&&e.elevationRangeValid){const t=e.elevationRangeMin,i=e.elevationRangeMax;switch(c.mode){case"relative-to-ground":s=c.geometryZWithOffset(o,l)+t-o,a=i-t;break;case"on-the-ground":s=t-o,a=i-t}}else if(c&&n<li){const e=this._tmpPoint;e.x=r.centerX,e.y=r.centerY,e.z=o,s=Dt(e,this._elevationProvider,c,l)-o}const d=a>0,h=d?this._tmpObb:t;return r.transform(h,this._indexSR,this._renderSR,s,this._renderSRSphericalPCPF,this._indexSRSphericalPCPF,this._projectorIndexSRToIndexSRSphericalPCPF),d&&(0,Fe.gm)(h,0,a,this._viewingMode,t),t}}getNodeObbInRenderSRIndependentOfElevationOffset(e){{var t,i;const r=null!==(t=null!==(i=e.visibilityObbInRenderSR)&&void 0!==i?i:e.serviceObbInRenderSR)&&void 0!==t?t:null;if(null!==r&&void 0!==r&&r.isValid)return r}const r=e.serviceObbInIndexSR;return r?(r.transform(fi,this._indexSR,this._renderSR,void 0,this._renderSRSphericalPCPF,this._indexSRSphericalPCPF,this._projectorIndexSRToIndexSRSphericalPCPF),fi):null}ensureElevationAgnosticBoundingVolume(e,t){-1===e.elevationAgnosticBoundingVolume[3]&&(t===ae.RT.Global?this._updateElevationAgnosticBoundingVolumeGlobal(e):this._updateElevationAgnosticBoundingVolumeLocal(e))}_updateElevationAgnosticBoundingVolumeGlobal(e){const t=this.getNodeObbInRenderSRIndependentOfElevationOffset(e),i=e.elevationAgnosticBoundingVolume,r=gi;let n=-1;if(t){t.getCenter(r),(0,M.n)(r,r),t.getCorners(mi);for(const e of mi){(0,M.n)(e,e);const t=(0,M.j)(e,r);if(t<=0)return void(i[3]=-1);const s=Math.sqrt(1-t*t);n=Math.max(n,s)}}else{const t=e.serviceMbsInRenderSR;if(!(0,Ie.hB)(t))return void(i[3]=-1);{const e=(0,M.c)(gi,(0,$.g)(t)),i=t[3],r=(0,M.C)(e);n=0===i?0:r<i?-1:i/r,(0,M.n)(e,e)}}(0,D.b)(i,r);i[3]=n+.001}_updateElevationAgnosticBoundingVolumeLocal(e){const t=e.elevationAgnosticBoundingVolume,i=this.getNodeObbInRenderSRIndependentOfElevationOffset(e);if(i){const e=i.getCenter(gi);e[2]=0,(0,D.b)(t,e);let r=0;const n=_i;i.getCorners(mi);for(const t of mi){t[2]=0;const e=(0,M.v)(n,t);r=Math.max(r,e)}t[3]=Math.sqrt(r)}else{const i=e.serviceMbsInRenderSR;if((0,Ie.hB)(i)){const e=(0,M.c)(gi,(0,$.g)(i));e[2]=0,(0,D.b)(t,e),t[3]=i[3]}}}isNodeVisible(e){const t=this.getServiceMbsInRenderSR(e);if(!this._isMBSinClippingArea(t))return!1;if(!this._useFrustumCulling)return!0;const i=this.getAndUpdateVisibilityObbInRenderSR(e);return i?i.isVisible(this._frustum):(0,wt.m7)(this._frustum,(0,$.w)(t))}isElevationAgnosticBoundingVolumeVisible(e,t){return!this._useFrustumCulling||-1===t[3]||(e===ae.RT.Global?this._isConeVisibleInFrustum(t):this._isCylinderVisibleInFrustum(t))}_isConeVisibleInFrustum(e){const t=this._frustumMbs,i=t,r=(0,M.C)(i),n=t[3],s=e,a=(0,M.j)(s,i),o=e[3];if(o>.9)return!0;if(r<=n)return!0;{const e=(0,M.h)(pi,s,a);if((0,M.m)(e,i)<n)return!0}const l=a/r;if(a<=0)return-l<n;const c=Math.sqrt(1-l*l);if(c<o)return!0;const d=n/r;return c*Math.sqrt(1-d*d)-d*l<o}_isCylinderVisibleInFrustum(e){const t=this._frustumMbs,i=t,r=t[3],n=(0,M.c)(pi,i);n[2]=0;const s=e[3];return(0,M.m)(n,e)<=s+r}isGeometryVisible(e){var t;if(!this._useFrustumCulling)return!0;const i=e.geometryObbInRenderSR;return null!==(t=null===i||void 0===i?void 0:i.isVisible(this._frustum))&&void 0!==t?t:this.isNodeVisible(e)}_isMBSinClippingArea(e){return null==this._clippingArea||(0,Ie.aM)(this._clippingArea,e)!==Ie.JA.OUTSIDE}_screenSpaceDiameterMbs(e,t){const i=this.getServiceMbsInRenderSR(e),r=Math.sqrt((0,M.a)((0,$.g)(i),this._camPos)),n=r-i[3];return this._updateMinMaxDistance(r),n<0?.5*Number.MAX_VALUE:t/n*this._screenSizeFactor}calcCameraDistance(e){return this.calcCameraDistanceToCenter(e)-this.getServiceMbsInRenderSR(e)[3]}calcCameraDistanceToCenter(e){const t=this.getServiceMbsInRenderSR(e),i=(0,M.p)((0,$.g)(t),this._camPos);return this._updateMinMaxDistance(i),i}calcAngleDependentLoD(e){const t=this.getServiceMbsInRenderSR(e),i=t[3],r=(Math.abs(t[0]*(t[0]-this._camPos[0])+t[1]*(t[1]-this._camPos[1])+t[2]*(t[2]-this._camPos[2]))/(0,M.l)((0,$.g)(t))+i)/(0,M.p)((0,$.g)(t),this._camPos);return Math.min(1,r)}hasLOD(e){return e.lodMetric!==Me.cJ.None}_getDistancePlanarMode(e,t){const i=e[0]-t[0],r=e[1]-t[1],n=e[2]-t[2],s=i*i+r*r,a=t[3];if(s<=a*a)return Math.abs(n);const o=Math.sqrt(s)-a;return Math.sqrt(n*n+o*o)}_getDistanceGlobeMode(e,t){const i=(0,M.l)((0,$.g)(t)),r=(0,M.l)(e)-i;(0,M.h)(this._tmp0,e,(0,M.j)(e,(0,$.g)(t))/(0,M.o)(e));const n=(0,M.a)((0,$.g)(t),this._tmp0),s=t[3];if(n<=s*s)return Math.abs(r);{const n=(0,M.h)(this._tmp0,(0,$.g)(t),1/i),a=i,o=s*s/2/a,l=(0,M.h)(this._tmp1,n,a-o),c=e,d=(0,M.f)(this._tmp2,c,l),h=(0,M.f)(this._tmp2,d,(0,M.h)(this._tmp3,n,(0,M.j)(n,d))),u=(0,M.g)(this._tmp2,l,(0,M.h)(this._tmp2,h,s/(0,M.l)(h)));let p=(0,M.p)(c,u);if(r>=2e5){const e=(0,M.f)(this._tmp1,c,u);let t=(0,M.j)(e,n)/(0,M.l)(e);t<.08&&(t=1e-4),p/=t}return p}}_getDistance(e,t){return this._isGlobalMode?this._getDistanceGlobeMode(e,t):this._getDistancePlanarMode(e,t)}_updateMinMaxDistance(e){e>0?(this.minDistance=Math.min(this.minDistance,e),this.maxDistance=Math.max(this.maxDistance,e)):(this.minDistance=0,this.maxDistance=Math.max(this.maxDistance,-e))}getLodLevel(e){if(e.lodMetric===Me.cJ.None)return 0;if(0===e.childCount)return this.maxLodLevel;if(this._useFrustumCulling&&this._progressiveLoadFactor<1){const t=this._progressiveLoadFactor*this._screenspaceErrorBias,i=this._screenspaceErrorBias;return this.evaluateLODmetric(e,t)?this.evaluateLODmetric(e,i)?2:1:0}return this.evaluateLODmetric(e,this._screenspaceErrorBias)?this.maxLodLevel:0}evaluateLODmetric(e,t){switch(e.lodMetric){case Me.cJ.ScreenSpaceRelative:{const i=this.getServiceMbsInRenderSR(e),r=this._getDistance(this._camPos,i),n=2*r/this._screenSizeFactor,s=r+i[3];return this._updateMinMaxDistance(s),e.maxError*t<=n}case Me.cJ.MaxScreenThreshold:{let i=this._screenSpaceDiameterMbs(e,e.serviceMbsInIndexSR[3]*t);return this._options.angleDependentLoD&&(i*=this.calcAngleDependentLoD(e)),i<e.maxError}case Me.cJ.RemovedFeatureDiameter:return this._screenSpaceDiameterMbs(e,e.maxError)*t<10;case Me.cJ.DistanceRangeFromDefaultCamera:return this.calcCameraDistance(e)>e.maxError*t}return!1}distToPOI(e){const t=this.getServiceMbsInRenderSR(e);return(0,M.p)((0,$.g)(t),this._poi)-t[3]}distCameraToPOI(){return(0,M.p)(this._camPos,this._poi)}}const di=(0,I.vt)(),hi=(0,wt.Qy)(),ui=(0,I.vt)(),pi=(0,I.vt)(),fi=new Fe.ab,gi=(0,I.vt)(),mi=[(0,I.vt)(),(0,I.vt)(),(0,I.vt)(),(0,I.vt)(),(0,I.vt)(),(0,I.vt)(),(0,I.vt)(),(0,I.vt)()],_i=(0,I.vt)();function vi(e,t,i){if(null==e||null==i)return!1;let r=!0;return yi[0]=null!=e.xmin?e.xmin:0,yi[1]=null!=e.ymin?e.ymin:0,yi[2]=null!=e.zmin?e.zmin:0,r=r&&(0,k.projectBuffer)(yi,e.spatialReference,0,yi,i,0,1),t[0]=yi[0],t[1]=yi[1],yi[0]=null!=e.xmax?e.xmax:0,yi[1]=null!=e.ymax?e.ymax:0,yi[2]=null!=e.zmax?e.zmax:0,r=r&&(0,k.projectBuffer)(yi,e.spatialReference,0,yi,i,0,1),t[2]=yi[0],t[3]=yi[1],null==e.xmin&&(t[0]=-1/0),null==e.ymin&&(t[1]=-1/0),null==e.xmax&&(t[2]=1/0),null==e.ymax&&(t[3]=1/0),r}const yi=(0,I.vt)();var bi;!function(e){e[e.ELEVATION=0]="ELEVATION",e[e.BASEMAP=1]="BASEMAP",e[e.I3S_INDEX=2]="I3S_INDEX",e[e.I3S_DATA=3]="I3S_DATA",e[e.SYMBOLOGY=4]="SYMBOLOGY"}(bi||(bi={}));(()=>{const e=new Array;e[bi.ELEVATION]=10,e[bi.BASEMAP]=10,e[bi.I3S_INDEX]=10,e[bi.I3S_DATA]=10,e[bi.SYMBOLOGY]=5})();const xi=.1;let Si=class extends s.A{constructor(e){super(e),this._quality=1,this._usedMemory=0,this._updating=!1,this._stableQuality=0,this._downscaleMemoryUsed=0,this._canFastRecover=!1,this._memoryPredicted=0,this._cacheStorage=new ce.F,this._warnMemoryUsage=null,this._numQualityChanges=0,this._maxMemory=750,this._additionalCacheMemory=0,this.addHandles((0,c.mg)({prepare:()=>this._updateMemory()}))}destroy(){this._cacheStorage.destroy()}get maxMemory(){return this._maxMemory}set maxMemory(e){null==e||e<=0||(this._stableQuality=0,this._canFastRecover=!1,this._maxMemory<e&&this._updateQuality(1),this._maxMemory=e)}get additionalCacheMemory(){return this._additionalCacheMemory}set additionalCacheMemory(e){null!=e&&(this._additionalCacheMemory=e)}get memoryFactor(){return this._quality}get updating(){return this._updating}get usedMemory(){return this._usedMemory}get usedCacheMemory(){return this._cacheStorage.size}newCache(e,t){return new ce.Mn(e,this._cacheStorage,t)}resetStableQuality(){this._stableQuality=0}disableMemCache(){this.additionalCacheMemory=-4096}update(){if(this._memoryPredicted<=0&&!this._updating)return;let e=this._layersUpdating();if(this._memoryPredicted<.6&&this._canFastRecover)this._downscaleMemoryUsed=0,this._stableQuality=0,this._canFastRecover=!1,this._updateQuality(1);else if(e)(this._memoryPredicted>1.1||this._usedMemory>1)&&(this._stableQuality>0?(this._downscaleMemoryUsed=0,this._updateQuality(this._stableQuality)):this._quality>xi&&this._downscaleMemoryUsed<this._usedMemory&&(this._updateQuality(this._quality/1.3),this._downscaleMemoryUsed=this._usedMemory,this._canFastRecover=!1));else if(this._downscaleMemoryUsed=0,this._usedMemory>1)this._stableQuality=0,this._canFastRecover=!1,e=this._updateQuality(this._quality/1.3),this._downscaleMemoryUsed=this._memoryPredicted;else if(this._stableQuality!==this._quality)if(this._usedMemory<.75&&this._quality<1){this._stableQuality=this._quality;const t=.05;e=this._updateQuality(this._quality+t)}else this._quality<1&&(this._canFastRecover=!0);this._updating=e}_updateQuality(e){return(e=Math.min(Math.max(e,xi),1))!==this._quality&&(this._quality=e,++this._numQualityChanges,!0)}_layersUpdating(){return this.view.allLayerViews.some((e=>!!e.updating))}_updateMemory(){var e,t,i,r;if(!this.view)return;null===(e=this.view._stage)||void 0===e||null===(e=e.renderer)||void 0===e||e.tick();const n=null===(t=this.view._stage)||void 0===t||null===(t=t.renderer)||void 0===t?void 0:t.usedMemory;let s=(null!==(i=null===(r=this.view.basemapTerrain)||void 0===r?void 0:r.usedMemory)&&void 0!==i?i:0)+(n?n.fbos+n.edges+n.plugins:0),o=0;this.view.allLayerViews&&this.view.allLayerViews.forEach((e=>{if(function(e){return"usedMemory"in e&&"unloadedMemory"in e&&"ignoresMemoryFactor"in e}(e)){const t=e.ignoresMemoryFactor?this._quality:1;s+=e.usedMemory*t,o+=e.unloadedMemory*t}}));const l=null==this._warnMemoryUsage||Math.round(10*s)!==Math.round(10*this._warnMemoryUsage),c=1048576*this.maxMemory;if(s>c&&l){this._warnMemoryUsage=s;const e=e=>(e/1048576).toLocaleString(void 0,{maximumFractionDigits:1})+" MB",t=Math.round(100*this._quality);a.A.getLogger(this).warn("Memory Limit exceeded! Limit: ".concat(e(c)," Current: ").concat(e(s)," Projected: ").concat(e(s+o)," Quality: ").concat(t,"%"))}this._usedMemory=s/c,this._memoryPredicted=(s+o)/c;const d=c-s;this._cacheStorage.maxSize=Math.max(0,d+1048576*this.additionalCacheMemory)}get test(){const e=this;return{cacheStorage:this._cacheStorage,resetQualityChanges:()=>{const t=e._numQualityChanges;return e._numQualityChanges=0,t},disableMemCache:()=>e.disableMemCache()}}};(0,r._)([(0,d.MZ)({constructOnly:!0})],Si.prototype,"view",void 0),(0,r._)([(0,d.MZ)()],Si.prototype,"maxMemory",null),(0,r._)([(0,d.MZ)()],Si.prototype,"additionalCacheMemory",null),(0,r._)([(0,d.MZ)({readOnly:!0})],Si.prototype,"memoryFactor",null),(0,r._)([(0,d.MZ)({readOnly:!0})],Si.prototype,"updating",null),(0,r._)([(0,d.MZ)({readOnly:!0})],Si.prototype,"usedMemory",null),(0,r._)([(0,d.MZ)({readOnly:!0})],Si.prototype,"usedCacheMemory",null),(0,r._)([(0,d.MZ)()],Si.prototype,"_quality",void 0),(0,r._)([(0,d.MZ)()],Si.prototype,"_usedMemory",void 0),(0,r._)([(0,d.MZ)()],Si.prototype,"_updating",void 0),(0,r._)([(0,d.MZ)()],Si.prototype,"_stableQuality",void 0),(0,r._)([(0,d.MZ)()],Si.prototype,"_maxMemory",void 0),(0,r._)([(0,d.MZ)()],Si.prototype,"_additionalCacheMemory",void 0),Si=(0,r._)([(0,u.$)("esri.views.3d.support.MemoryController")],Si);var wi=i(90992);const Ci=1e-4;let Ai=class extends((0,K.g)(s.A)){get isMeshPyramid(){var e;return"mesh-pyramids"===this.layer.profile||"MeshPyramid"===(null===(e=this.layer.store)||void 0===e?void 0:e.lodType)}get isGraphics3D(){return"points"===this.layer.profile}get useMaximumNumberOfFeatures(){return!this.isMeshPyramid&&(null==this.layer.priority||"High"===this.layer.priority)}get indexStreamController(){const e=this.layerView.view.resourceController.createStreamDataRequester(bi.I3S_INDEX);return new bt(e,this.layer.customParameters,this.layer.apiKey)}get dataStreamController(){const e=this.layerView.view.resourceController.createStreamDataRequester(bi.I3S_DATA);return new bt(e,this.layer.customParameters,this.layer.apiKey)}get crsVertex(){return(0,Ie.Dd)(this.layer)}get crsIndex(){return(0,Ie.Rm)(this.layer)}get layer(){return this.layerView.i3slayer}get running(){return this.updating}get rootNodeVisible(){if(this._index){const e=this._index.rootNode;if(e)return this._updateViewData(),this._index.isNodeVisible(e.index)}return!0}get index(){return this._index}get requiredAttributes(){return this._requiredAttributes}constructor(e){super(e),this.screenSizeFactor=0,this.featureTarget=5e4,this.fixedFeatureTarget=!1,this.updating=!0,this.updatingProgress=1,this.leavesReached=!1,this.scaleVisibilityEnabled=!0,this.worker=null,this._featureLOD=1,this._stableFeatureLOD=!1,this._isIdle=!1,this._cameraDirty=!0,this._invisibleDirty=!1,this._idleStateCallbacks=null,this._newLoadingNodes=new C.A({deallocator:null}),this._loadedNodeScales=new Map,this._modificationsNodeFilteringArray=new C.A,this._downloadingCount=0,this._loadingNodes=new Map,this._updatingNodes=new Map,this._progressMaxNumNodes=1,this._requiredAttributes=new Array,this._requiredAttributesDirty=!0,this._updatesDisabled=!1,this.disableIDBCache=!1,this._disableMemCache=!1,this._restartNodeLoading=!1,this._fields=null,this._attributeStorageInfo=null,this._idleQueue=new se.T,this._elevationUpdateNodes=new C.A({deallocator:null}),this._errorCount=0}initialize(){const{layerView:e,layer:t}=this;this._disableMemCache=!e.loadCachedGPUData||!e.addCachedGPUData,this._lodHandling=new st(e),this._defaultGeometrySchema=t.store.defaultGeometrySchema,this.disableIDBCache=(0,h.A)("disable-feature:idb-cache"),"fields"in t&&(this._fields=t.fields,this._attributeStorageInfo=t.attributeStorageInfo),this.addResolvingPromise(Promise.all([t.indexInfo,t.when(),e.when()]).then((i=>{let[r]=i;if(this.destroyed||!e||e.destroyed||!r)return;const{view:n,clientGeometry:s}=e,{resourceController:o}=n;if(this._setClippingArea(n.clippingArea),this.addHandles([(0,l.wB)((()=>{var e;return null===n||void 0===n||null===(e=n.pointsOfInterest)||void 0===e||null===(e=e.focus)||void 0===e?void 0:e.renderLocation}),(e=>this._pointOfInterestChanged(e)),l.Vh),(0,l.wB)((()=>n.quality),(()=>this._setCameraDirty()),l.OH),(0,l.wB)((()=>e.contentVisible),(e=>{const t=e?()=>this._updateIdleState(!0):()=>this._updateViewData(),i=e?()=>this._updateIdleState(!1):()=>{};e&&null!=this._index&&this._index.invalidateAllElevationRanges(),this._idleStateCallbacks?(e||this.cancelNodeLoading(),this.restartNodeLoading(),this._idleStateCallbacks.idleBegin=t,this._idleStateCallbacks.idleEnd=i):this._idleStateCallbacks=o.scheduler.registerIdleStateCallbacks(t,i)}),l.Vh),Te(e.view.resourceController.scheduler,this),(0,l.wB)((()=>e.uncompressedTextureDownsamplingEnabled),(()=>this.restartNodeLoading())),(0,l.wB)((()=>[this.featureTarget,this.fixedFeatureTarget]),(()=>{this._setCameraDirty(),this._stableFeatureLOD=!1})),(0,l.wB)((()=>{var e;return null===(e=n.state)||void 0===e?void 0:e.contentCamera}),(()=>this._setCameraDirty())),(0,l.wB)((()=>t.elevationInfo),(e=>this._elevationInfoChanged(e))),(0,l.wB)((()=>t.effectiveScaleRange),(()=>this._scaleBoundsChanged())),(0,l.wB)((()=>e.lodFactor),(()=>this._setCameraDirty())),(0,l.wB)((()=>e.availableFields),(()=>this._requiredFieldsChange())),(0,l.wB)((()=>e.holeFilling),(e=>null!=this._index&&(this._index.holeFilling=e)))]),this._updateScaleHandles(),this._viewportQueries=new ci(this.crsIndex,n.renderCoordsHelper,n.state.contentCamera,!n.state.fixedContentCamera||this.isGraphics3D,this._clippingArea,this.isMeshPyramid?n.basemapTerrain:n.elevationProvider,(0,ae.yX)(n.viewingMode),this.layer.elevationInfo,{progressiveLoadFactor:this._getProgressiveLoadFactor(),screenspaceErrorBias:this._lod,angleDependentLoD:this._lod<.5}),this._clientNodeLoader=new ve(this.layer.uid,{indexSR:this.crsIndex,vertexSR:this.crsVertex,renderSR:n.renderCoordsHelper.spatialReference,localMode:"local"===n.viewingMode},n.resourceController.memoryController,this.worker),this._index=new Ge((0,ae.yX)(n.viewingMode),t,r,this.indexStreamController,this._clientNodeLoader,this._viewportQueries,a.A.getLogger(this),e.holeFilling,(t=>e.isNodeLoaded(t)),(t=>e.isNodeReloading(t)),(e=>this._shouldLoadNode(e)),(e=>this._enableFromGPUCache(e,Me.UY.Leaf)),(e=>this._needsUpdate(e)),(()=>!this.indexStreamController.busy),(t=>{var i,r;return null!==(i=null===(r=e.computeVisibilityObb)||void 0===r?void 0:r.call(e,t))&&void 0!==i?i:null}),null!==e&&void 0!==e&&e.computeNodeFiltering?t=>e.computeNodeFiltering(t):void 0),this._index.updateElevationInfo(this.layer.elevationInfo,this.isMeshPyramid||this.isGraphics3D),this._index.imModificationsChanged(!!e.hasModifications),this._index.layerFilterChanged(!!e.hasGeometryFilter),null!=s){for(const e of s)this._addMesh(e.mesh,e.oid);this.addHandles(s.on("change",(e=>{for(const t of e.removed)this._removeMesh(t.oid);for(const t of e.added)this._addMesh(t.mesh,t.oid)})))}this._startNodeLoading()}))),this._tmpPoint=(0,ne.T)(0,0,0,this.crsIndex)}updateNodeModificationStatus(e){const t=this._index,i=this.layerView;null!=t&&(null===i||void 0===i?void 0:i.updateNodeModificationStatus)&&(this._modificationsNodeFilteringArray.clear(),e.forAll((e=>{const i=t.getNode(e);null!=i&&this._modificationsNodeFilteringArray.push(i)})),i.updateNodeModificationStatus(this._modificationsNodeFilteringArray),this._invisibleDirty=!0)}destroy(){this.cancelNodeLoading(),this._idleStateCallbacks&&(this._isIdle=!1,this._idleStateCallbacks.remove(),this._idleStateCallbacks=null),this._nodeLoader=null,Ri.prune(),null!=Ei&&(Ei.hide(),Ei=null)}get viewportQueries(){return this._viewportQueries}_getRequiredAttributes(){if(null==this._attributeStorageInfo||!this._fields||!this.layerView.availableFields)return[];const e=this._attributeStorageInfo,t=this._fields,i=this.layer.objectIdField;return this.layerView.availableFields.map((i=>{const r=Ti(e,i),n=Ti(t,i);return r>=0&&n>=0?{index:r,name:t[n].name,field:t[n],attributeStorageInfo:e[r]}:null})).filter((e=>null!=e&&e.name!==i))}_requiredFieldsChange(){const e=this._getRequiredAttributes();Oi(this._requiredAttributes,e)||(this._requiredAttributes=e,this._requiredAttributesDirty=!1,this.restartNodeLoading())}requestUpdate(){this._requiredAttributesDirty=!0,this.restartNodeLoading()}_setClippingArea(e){const t=(0,Q.vt)();vi(e,t,this.layerView.view.renderSpatialReference)?this._clippingArea=t:this._clippingArea=null}_pointOfInterestChanged(e){null!=this._viewportQueries&&(this._viewportQueries.setPointOfInterest(e),null!=this._index&&(this._index.progressiveLoadPenalty=Pi.distancePenalty*this._viewportQueries.distCameraToPOI(),this._index.requestUpdate()))}updateClippingArea(e){this._setClippingArea(e),null!=this._viewportQueries&&null!=this._index&&(this._viewportQueries.updateClippingArea(this._clippingArea),this._index.invalidateVisibilityCache()),this._setCameraDirty()}_setCameraDirty(){this._cameraDirty=!0,this._lodHandling.setLodGlobalDirty(),this._evaluateUpdating()}_addMesh(e,t){if(null==this._index)return;const i=this._clientNodeLoader.createMeshNodeInfo(e,t),r=this._index.addClientNodeToIndex(i.id,i.mbs);this._clientNodeLoader.addMeshNode(r,i),this._evaluateUpdating(),this.notifyChange("rootNodeVisible")}_removeMesh(e){const t=this._clientNodeLoader.getMeshNodeIndex(e);if(null!=t){if(null==this._index)throw new Error("delayed removal of client side i3s node geometry not supported yet.");{const e=(e,t)=>{var i,r,n,s;this.layerView.removeNode(t),this._loadedNodeScales.delete(t),this._clientNodeLoader.removeNode(e),this.layerView.deleteCachedNodeData&&null!=e&&this.layerView.deleteCachedNodeData(e),null===(i=(r=this.layerView).deleteCachedGPUData)||void 0===i||i.call(r,null===(n=(s=this.layerView).loadCachedGPUData)||void 0===n?void 0:n.call(s,t))},i=(e,t,i)=>{this._clientNodeLoader.updateNodeIndex(e,t,i),this.layerView.updateNodeIndex&&this.layerView.updateNodeIndex(t,i)};this._index.removeClientNodeFromIndex(t,e,i),this.notifyChange("rootNodeVisible")}}}updateElevationChanged(e,t){const i=this._index;if(null==(null===i||void 0===i?void 0:i.rootNode)||null==t)return null;this.crsIndex.equals(t)||(ee(e,t,Mi,this.crsIndex),e=Mi);const r=this._elevationUpdateNodes;return r.clear(),(0,Ie.II)(e,i.rootNode,i,(e=>r.push(e.index))),r.length&&(r.forAll((e=>i.updateElevationChanged(e))),this._setCameraDirty()),r}removeAllGeometryObbs(){null!=this._index&&this._index.removeAllGeometryObbs()}getRenderMbs(e){return null!=this._viewportQueries?this._viewportQueries.getServiceMbsInRenderSR(e):null}_elevationInfoChanged(e){null!=this._index&&(this._index.updateElevationInfo(e,this.isMeshPyramid||this.isGraphics3D),this._setCameraDirty())}_updateScaleHandles(){const e="scale-bounds";this.removeHandles(e),this._areScaleBoundsActive&&this.addHandles(this.layerView.view.basemapTerrain.on("scale-change",(e=>this._scaleUpdateHandler(e))),e)}_scaleBoundsChanged(){this._areScaleBoundsActive||this._loadedNodeScales.clear(),this._updateScaleHandles(),this._setCameraDirty()}_scaleUpdateHandler(e){this._updateScaleInBoundingRect(e.extent,e.spatialReference),this._setCameraDirty()}_updateScaleInBoundingRect(e,t){const i=this._index;null!=i&&null!=i.rootNode&&ee(e,t,Mi,this.crsIndex)&&this._loadedNodeScales.forEach(((e,t)=>{const r=i.getNode(t);null!=r&&(0,Q.m7)(Mi,r.serviceMbsInIndexSR)&&this._loadedNodeScales.set(t,this._computeScale(r))}))}restartNodeLoading(){this._restartNodeLoading=!0,this.cancelNodeLoading(),this._evaluateUpdating()}schedule(e,t){return this._idleQueue.push(e,t)}reschedule(e,t){return this._idleQueue.unshift(e,t)}get _isIntegratedMesh(){return"integrated-mesh"===this.layer.type}get _areScaleBoundsActive(){const{minScale:e,maxScale:t}=(0,wi.Cf)(this.layer);return this.scaleVisibilityEnabled&&(e>0||t>0)}get unloadedMemoryEstimate(){return null!=this._index&&this.layerView.contentVisible?this._index.unloadedMemoryEstimate*this._lodDropFactor:0}async _loadNodeData(e,t){return e.index<0?this._clientNodeLoader.loadNodeData(e.id,t):this._nodeLoader.loadNodeData(e,t)}async _loadAttributes(e,t,i){return(e.index<0?this._clientNodeLoader:this._nodeLoader).loadAttributes(e,t,i)}get indexDepth(){return null!=this._index?this._index.maxLevel:0}set disableMemCache(e){this.layerView.loadCachedGPUData&&this.layerView.addCachedGPUData?this._disableMemCache=e:this._disableMemCache=!0}runTask(e,t){return this.layerView.contentVisible?this.layerView.visible&&null!=this._index?(this._processWithErrorLogging(e,t),this._index.maxPriority):-1/0:(this._updateViewData(),this._evaluateUpdating(),-1/0)}_processWithErrorLogging(e,t){try{this._process(e,t)}catch(i){this._errorCount<50?a.A.getLogger(this).error("Error during processing: ".concat(i," at ").concat(i.stack)):50===this._errorCount&&a.A.getLogger(this).error("Too many errors for this layer. Further errors will not be displayed."),this._errorCount++}}_process(e,t){this._restartNodeLoading&&this._startNodeLoading(),null!=this._nodeLoader&&null!=this._index&&(this._updateViewData(),this._invisibleDirty&&this._removeInvisibleNodes(e)&&(this._invisibleDirty=!1),this._isIntegratedMesh&&(e.enabled=!1),e.run((()=>this._processIndex(e))),this._updateFeatureLOD(),e.run((()=>this._processCache(e))),this._isIntegratedMesh&&(e.enabled=!0),e.run((()=>this._processNodes(e,t))),this._idleQueue.runTask(e),e.run((()=>this._prefetchIndex())),t.numIndexLoading+=this._index.indexLoading,t.numNodesLoading+=this._downloadingCount,e.run((()=>this._lodHandling.lodGlobalHandling(e))),this._evaluateUpdating())}_processIndex(e){if(null==this._index)return!1;if(this._index.dirty){this._newLoadingNodes.clear(),this._index.update(Array.from(this._loadingNodes.keys()),e,(e=>this.updateNodeModificationStatus(e))),this._disableMemCache||(this._newLoadingNodes.pushArray(this._index.updates.add.data,this._index.updates.add.length),this._newLoadingNodes.pushArray(this._index.updates.missing.data,this._index.updates.missing.length));const t=this._index.featureEstimate.leavesReached;this._index.isLoading||t===this._get("leavesReached")||this._set("leavesReached",t)}return this._index.load()}_prefetchIndex(){return!(null==this._index||this._loadingNodes.size>0||this._index.updates.add.length>0)&&this._index.prefetch()}_updateFeatureLOD(){if(!this.useMaximumNumberOfFeatures||null==this._index||null==this._viewportQueries)return;const e=!this._index.isLoading,t=this.featureTarget*this._baseLOD,i=this._index.featureEstimate;if(i.estimate=i.estimate||t/2,this._index.indexMissing>500){if(this._featureLOD<=Ci)return;this._featureLOD/=1.5,this._stableFeatureLOD=!1}else if(e&&i.estimate<t){if(i.leavesReached||this._featureLOD>=1e4||this._stableFeatureLOD)return;const e=Math.min(10,Math.max(t/i.estimate,1.001));this._featureLOD*=e;const r=this._lod,n=this._index.checkFeatureTarget(t,r);n!==r&&(this._featureLOD=n/this._baseLOD,this._stableFeatureLOD=!0)}else{if(!(i.estimate>1.2*t||e&&i.estimate>t))return;if(this._featureLOD<=Ci)return;this._featureLOD/=1+.25*(i.estimate/t-1),this._stableFeatureLOD=!1}this._featureLOD=Math.min(1e4,Math.max(Ci,this._featureLOD)),this._viewportQueries.updateScreenSpaceErrorBias(this._lod),this._index.requestUpdate()}_processCache(e){const t=this._index;if(null==t)return!1;for(;this._newLoadingNodes.length>0&&!e.done;){const i=this._newLoadingNodes.pop();for(let r=t.getParent(i);null!=r&&!this.layerView.isNodeLoaded(r.index)&&this._isNodeInScaleBounds(r);r=t.getParent(r.index))if(this._enableFromGPUCache(r,Me.UY.Hole)){e.madeProgress();break}}return e.hasProgressed}_processNodes(e,t){if(null==this._index)return!1;let i=(this._isIdle?100:2)-this._loadingNodes.size;const r=this._index.updates;for(r.cancel.forEach(this._cancelNode,this),r.cancel=[];r.remove.length>0&&!e.done;)this.layerView.removeNode(r.remove.pop()),e.madeProgress();for(;r.update.length>0&&!e.done;){const t=this._index.getNode(r.update.pop());null!=t&&(this._updateLoadedNode(t),e.madeProgress())}for(;r.add.length>0&&!e.done&&i>0;){--i;const n=this._index.getNode(r.add.back());if(null==n||n.cacheState!==Me.iF.Cached&&!this._hasNodeLoadToken(t))break;r.add.pop(),this._loadNode(n),e.madeProgress()}return e.hasProgressed}_cancelAllNodes(){this._loadingNodes.forEach((e=>e.abort())),this._loadingNodes.clear(),this._updatingNodes.forEach((e=>e.abort())),this._updatingNodes.clear()}_cancelNode(e){const t=this._loadingNodes.get(e);t&&(t.abort(),this._loadingNodes.delete(e))}_hasNodeLoadToken(e){return!(!this._isIdle&&e.numNodesLoading+this._loadingNodes.size>=2)&&this._downloadingCount<30&&!this.dataStreamController.busy}_evaluateUpdating(){let e=!1,t=0;if(this.layerView){if(this.layerView.contentVisible){const i=(null!=this._index?this._index.indexMissing:0)+3*(null!=this._index?this._index.updates.add.length:0)+2*this._loadingNodes.size;e=!!(i>0||this._updatingNodes.size>0||this._restartNodeLoading||this._cameraDirty||this._idleQueue.running||this._lodHandling&&this._lodHandling.requiresLODGlobalHandling||null!=this._index&&this._index.isPrefetching),0===i&&(this._progressMaxNumNodes=1),this._progressMaxNumNodes=Math.max(i,this._progressMaxNumNodes),t=1-i/this._progressMaxNumNodes}else e=this._cameraDirty,t=e?0:1;this.updating=e,this.updatingProgress=t}}_updateViewData(){if(!this._cameraDirty||null==this._index||null==this._viewportQueries)return;const e=this.layerView.view,{contentCamera:t,fixedContentCamera:i}=e.state;this.screenSizeFactor=1/(t.perScreenPixelRatio/2),this._viewportQueries.updateCamera(t,!i||this.isGraphics3D),this._viewportQueries.setPointOfInterest(e.pointsOfInterest.focus.renderLocation),this._viewportQueries.updateScreenSpaceErrorBias(this._lod),this._index.invalidateVisibilityCache(),this._index.progressiveLoadPenalty=Pi.distancePenalty*this._viewportQueries.distCameraToPOI(),this._index.requestUpdate(),this._stableFeatureLOD=!1,this._invisibleDirty=!0,this._cameraDirty=!1,this.notifyChange("rootNodeVisible")}_getProgressiveLoadFactor(){return this.layerView.view.quality<1?1:this.layerView.progressiveLoadFactor}get _lod(){return this._featureLOD*this._baseLOD}get _baseLOD(){const e=this.layerView.lodFactor;return this.fixedFeatureTarget?1:(e>0?e:1)*this.layerView.view.quality}get _lodDropFactor(){return this.fixedFeatureTarget?1:(Math.min(this.layerView.view.quality,.5)-xi)/.4}isGeometryVisible(e){var t;return!(null===(t=this._index)||void 0===t||!t.isGeometryVisible(e.index))}updateVisibility(e){var t;null===(t=this._index)||void 0===t||t.invalidateNodeVisibilityCache(e)}invalidateGeometryVisibility(e){var t;null===(t=this._index)||void 0===t||t.invalidateGeometryVisibility(e)}invalidateVisibilityObbs(){var e;null===(e=this._index)||void 0===e||e.invalidateVisibilityObbs()}modificationsChanged(){var e;null!==(e=this._index)&&void 0!==e&&e.imModificationsChanged(!!this.layerView.hasModifications),this._invisibleDirty=!0}_shouldLoadNode(e){return!(!this._lodHandling.shouldLoadNode(e)||this._shouldDropNode(e))&&!(null==this._index||!this._index.isGeometryVisible(e.index))&&this._isNodeInScaleBounds(e)}_shouldDropNode(e){if(null==this._viewportQueries)return!1;const t=this._lodDropFactor;return!(t>=1||!this._lodHandling.hasNoVisibleChildren(e))&&Math.abs(this._viewportQueries.calcCameraDistanceToCenter(e))-this._viewportQueries.minDistance>(this._viewportQueries.maxDistance-this._viewportQueries.minDistance)*t}_startNodeLoading(){this._restartNodeLoading=!1;const e=this._index;if(this._updatesDisabled||null==e||null==this._viewportQueries)return;this._updateViewData(),this._requiredAttributesDirty&&(this._requiredAttributes=this._getRequiredAttributes(),this._requiredAttributesDirty=!1);const t={textureEncodings:this.layerView.supportedTextureEncodings,uncompressedTextureDownsamplingEnabled:this.layerView.uncompressedTextureDownsamplingEnabled,textureUsageMask:this.layerView.rendererTextureUsage,loadFeatureData:this.useMaximumNumberOfFeatures};this._nodeLoader=new yt(this.layer,this.dataStreamController,a.A.getLogger(this),this._defaultGeometrySchema,this._requiredAttributes,t),e.requestUpdate(),this._lodHandling.startNodeLoading((e=>this._isNodeInScaleBounds(e)),((e,t)=>this._removeNodes(e,t,Ii.fadeout)),e,{maxLodLevel:this._viewportQueries.maxLodLevel}),this._evaluateUpdating()}isNodeLoading(){return null!=this._nodeLoader&&null!=this._index}cancelNodeLoading(){this.isNodeLoading()&&(this.indexStreamController.cancelAll(),this.dataStreamController.cancelAll(),this._idleQueue.cancelAll(),this._cancelAllNodes(),this._nodeLoader=null,this._evaluateUpdating())}_removeInvisibleNodes(e){const t=this._index;if(null==t||null==this._viewportQueries)return!1;Ri.clear(),this.layerView.getLoadedNodeIndices(Ri);const i=0===this._viewportQueries.maxDistance,r=i?()=>!1:e=>this._shouldDropNode(e);return Ri.filterInPlace((e=>{const i=t.getNode(e);return null==i||!t.isGeometryVisible(e)||r(i)||!this._isNodeInScaleBounds(i)})),Ri.length>0&&this._lodHandling.setLodGlobalDirty(),this._removeNodes(Ri,e,Ii.pop),!(i&&this._lodDropFactor<1)&&(0===Ri.length||(Ri.clear(),!1))}markNodeToRemove(e){Ri.push(e)}removeMarkedNodes(){this._removeNodes(Ri,Ae.Bb,Ii.pop)}_removeNodes(e,t,i){const r=e.length;if(0!==r&&!t.done){for(null!=this._index&&this._index.requestUpdate();e.length>0&&!t.done;){const r=e.pop(),n=this._index;i===Ii.fadeout&&this.layerView.nodeFadeoutEnabled&&null!=n&&n.isGeometryVisible(r)?this.layerView.fadeNode(r,nt.FadeOut,!0):this.layerView.removeNode(r),t.madeProgress()}if(this._loadedNodeScales.size>0)for(let t=e.length;t<r;t++){const i=e.data[t];this._loadedNodeScales.delete(i)}}}_needsUpdate(e){if(e.resources.isEmpty||this._updatingNodes.has(e.index))return!1;const t=this.layerView.getLoadedAttributes(e.index);return null!=t&&t!==this._requiredAttributes}async _updateLoadedNode(e){const t=new AbortController;this._updatingNodes.set(e.index,t),this._evaluateUpdating();try{const i=Oi(this.layerView.getLoadedAttributes(e.index),this._requiredAttributes);let r=null;r=i?this.layerView.getAttributeData(e.index):await this._loadAttributes(e,this._requiredAttributes,t.signal),await this.schedule((()=>this.layerView.updateAttributes(e.index,{loadedAttributes:this._requiredAttributes,attributeData:r},t.signal)),t.signal)}catch(i){if(!(0,o.zf)(i))return this.layerView.updateAttributes(e.index,{loadedAttributes:this._requiredAttributes,attributeData:{}},t.signal)}this._updatingNodes.delete(e.index),this._evaluateUpdating()}_loadNode(e){if(this._loadingNodes.has(e.index))return void a.A.getLogger(this).error("already loading node "+e.index);const t=new AbortController;this._loadingNodes.set(e.index,t),this._evaluateUpdating(),this._loadAndAddNode(e,t.signal).then((i=>{i&&null!=this._index&&this._loadingNodes.get(e.index)===t&&(this._loadingNodes.delete(e.index),this._index.requestUpdate())})).catch((e=>{if(!(0,o.zf)(e))throw e})).finally((()=>{this._loadingNodes.get(e.index)===t&&this._loadingNodes.delete(e.index),this._evaluateUpdating()}))}_loadAndAddNode(e,t){return e.cacheState===Me.iF.Uncached?this._loadUncached(e,t).then((()=>!1)):this._loadCached(e,t).then((t=>!t&&(e.cacheState=Me.iF.Uncached,!0))).catch((t=>!(0,o.zf)(t)&&(e.cacheState=Me.iF.Uncached,!0)))}_enableFromGPUCache(e,t){if(this._disableMemCache||null==this._index)return!1;if(t===Me.UY.Hole&&!this._index.useNodeAsHole(e.index))return!0;const i=this._loadCachedGPUData(e);return!!i&&(this.layerView.addCachedGPUData(e,i,t),this._nodeAdded(),!0)}_loadCachedGPUData(e){const t=this.layerView.loadCachedGPUData(e.index);return null!=(null===t||void 0===t?void 0:t.attributeInfo)&&Oi(t.attributeInfo.loadedAttributes,this._requiredAttributes)?t:(this.layerView.deleteCachedGPUData(t),null)}_nodeAdded(){null!=this._index&&this._index.requestUpdate(),this._lodHandling.setLodGlobalDirty(),this._evaluateUpdating()}updateLoadStatus(e,t){const i=this._index;null!=i&&i.updateChildrenLoaded(e,t?1:-1)}async _loadCached(e,t){if(this._enableFromGPUCache(e,Me.UY.Leaf))return!0;const i=this.layerView;if(this.disableIDBCache||!i.loadCachedNodeData||!i.addCachedNodeData)return!1;const r=e.index>=0?(t,i)=>this._nodeLoader.loadTextures(e,t,i):(t,i)=>this._clientNodeLoader.loadTextures(e,t,i),n=await this.schedule((()=>i.loadCachedNodeData(e,t,r)),t);if(null==n)return!1;const s=this._requiredAttributes,a=await this.reschedule((()=>this._loadAttributes(e,s,t)),t);return await this.reschedule((()=>i.addCachedNodeData(e,n,{loadedAttributes:s,attributeData:a},t)),t),this._nodeAdded(),!0}_loadUncached(e,t){return this._downloadingCount++,this._loadNodeData(e,t).catch((e=>{throw this._downloadingCount--,e})).then((i=>(this._downloadingCount--,this.schedule((()=>this.layerView.addNode(e,i,t)),t)))).then((()=>{this._nodeAdded(),e.cacheState=Me.iF.Cached})).catch((t=>{if(!(0,o.zf)(t))throw a.A.getLogger(this).error("#loadNodeData()",this.layer,"Failed to load node '".concat(e.id,"'"),t),e.failed=!0,null!=this._index&&this._index.requestUpdate(),t}))}_updateIdleState(e){e!==this._isIdle&&(this._isIdle=e,this._evaluateUpdating(),e&&this._index&&null!=this._index&&this._index.resetFailedNodes())}_getScale(e){if(this._loadedNodeScales.has(e.index))return this._loadedNodeScales.get(e.index);const t=this._computeScale(e);return this.layerView.isNodeLoaded(e.index)&&this._loadedNodeScales.set(e.index,t),t}_computeScale(e){this._tmpPoint.x=e.serviceMbsInIndexSR[0],this._tmpPoint.y=e.serviceMbsInIndexSR[1],this._tmpPoint.z=e.serviceMbsInIndexSR[2];const t=e.serviceMbsInIndexSR[3];return this.layerView.view.basemapTerrain.getSphereScale(this._tmpPoint,t)}_isNodeInScaleBounds(e){if(!this._areScaleBoundsActive)return!0;const t=this._getScale(e),{minScale:i,maxScale:r}=(0,wi.Cf)(this.layer);return(0,wi.JU)(t,i,r)}get test(){const e=this;return{index:this._index,set disableUpdates(t){e._updatesDisabled=t,t?e.cancelNodeLoading():e.requestUpdate()},set disableIDBCache(t){e.disableIDBCache=t},set ignoreServiceObb(t){null!=e._index&&(e._index.ignoreServiceObb=t)},shouldLoadNode:t=>e._shouldLoadNode(t)}}notifyLODUpdate(){this._lodHandling.setLodGlobalDirty(),this._evaluateUpdating(),null!=this._index&&this._index.requestUpdate()}geometryFilterChanged(e){const t=this._index;null!=t&&t.layerFilterChanged(e),this._setCameraDirty()}};(0,r._)([(0,d.MZ)({readOnly:!0})],Ai.prototype,"isMeshPyramid",null),(0,r._)([(0,d.MZ)({readOnly:!0})],Ai.prototype,"isGraphics3D",null),(0,r._)([(0,d.MZ)({readOnly:!0})],Ai.prototype,"useMaximumNumberOfFeatures",null),(0,r._)([(0,d.MZ)({readOnly:!0})],Ai.prototype,"indexStreamController",null),(0,r._)([(0,d.MZ)({readOnly:!0})],Ai.prototype,"dataStreamController",null),(0,r._)([(0,d.MZ)({readOnly:!0})],Ai.prototype,"crsVertex",null),(0,r._)([(0,d.MZ)({readOnly:!0})],Ai.prototype,"crsIndex",null),(0,r._)([(0,d.MZ)()],Ai.prototype,"screenSizeFactor",void 0),(0,r._)([(0,d.MZ)()],Ai.prototype,"featureTarget",void 0),(0,r._)([(0,d.MZ)()],Ai.prototype,"fixedFeatureTarget",void 0),(0,r._)([(0,d.MZ)()],Ai.prototype,"layerView",void 0),(0,r._)([(0,d.MZ)()],Ai.prototype,"layer",null),(0,r._)([(0,d.MZ)()],Ai.prototype,"updating",void 0),(0,r._)([(0,d.MZ)({readOnly:!0})],Ai.prototype,"running",null),(0,r._)([(0,d.MZ)()],Ai.prototype,"updatingProgress",void 0),(0,r._)([(0,d.MZ)({readOnly:!0})],Ai.prototype,"leavesReached",void 0),(0,r._)([(0,d.MZ)({constructOnly:!0})],Ai.prototype,"scaleVisibilityEnabled",void 0),(0,r._)([(0,d.MZ)({constructOnly:!0})],Ai.prototype,"worker",void 0),(0,r._)([(0,d.MZ)({readOnly:!0,dependsOn:[]})],Ai.prototype,"rootNodeVisible",null),Ai=(0,r._)([(0,u.$)("esri.layers.graphics.controllers.I3SOnDemandController")],Ai);const Ri=new C.A({deallocator:null});let Ei;function Oi(e,t){return null!=e&&e.length===t.length&&e.every((e=>Ti(t,e.name)>=0))}function Ti(e,t){const i=t.toLowerCase();for(let r=0;r<e.length;r++)if(e[r].name.toLowerCase()===i)return r;return-1}const Pi={factorIM:.2,factor3dObject:.05,distancePenalty:10},Mi=(0,Q.vt)();var Ii;!function(e){e[e.pop=0]="pop",e[e.fadeout=1]="fadeout"}(Ii||(Ii={}));var Di=i(53430),Li=(i(14303),i(15492)),Fi=i(86300),Ni=(i(78135),i(95444),i(90632)),Vi=i(15011),Gi=(i(63844),i(14873),i(47662),i(72690),i(86946),i(71832),i(5766),i(35039)),Ui=(i(86616),i(87663)),zi=i(9624),Bi=i(91789),Hi=i(25515),ji=i(99784),Wi=i(87708);function ki(e){return null==e||"simple"===e.type||"unique-value"===e.type||"class-breaks"===e.type||"dictionary"===e.type||"heatmap"===e.type}function Zi(e,t){if(null==e)return null;if(!ki(e))return new oe.A("renderer-conversion-3d:unsupported-renderer","Unsupported renderer of type '".concat(e.type||e.declaredClass,"'"),{renderer:e});switch(e.type){case"simple":return function(e){return qi(e,(0,Wi.t)(e.symbol).error)}(e);case"unique-value":return function(e,t){var i;const r={...Wi.c,...t},n=null===(i=e.uniqueValueInfos)||void 0===i?void 0:i.map((e=>(0,Wi.t)(e.symbol,r).error)).filter(b.Ru),s=(0,Wi.t)(e.defaultSymbol,r);return s.error&&null!==n&&void 0!==n&&n.unshift(s.error),qi(e,n)}(e,t);case"class-breaks":return function(e){const t=e.classBreakInfos.map((e=>(0,Wi.t)(e.symbol).error)).filter(b.Ru),i=(0,Wi.t)(e.defaultSymbol);return i.error&&t.unshift(i.error),qi(e,t)}(e);case"dictionary":case"heatmap":return null}return null}function qi(e,t){if(!t)return null;let i;if(i=Array.isArray(t)?t:[t],i.length>0){const t=i.map((e=>e.details.symbol.type||e.details.symbol.declaredClass)).filter((e=>!!e));t.sort();const r=[];return t.forEach(((e,i)=>{0!==i&&e===t[i-1]||r.push(e)})),new oe.A("renderer-conversion-3d:unsupported-symbols","Renderer contains symbols (".concat(r.join(", "),") which are not supported in 3D"),{renderer:e,symbolErrors:i})}return null}var Qi=i(84847),Ji=i(34913),Yi=i(94918),Xi=i(37471),$i=i(74343),Ki=i(73471),er=i(84202),tr=i(44460);const ir=Xi.A.fromSimpleMarkerSymbol(er.UK),rr=Ji.A.fromSimpleLineSymbol(er.A7),nr=$i.A.fromSimpleFillSymbol(er.Cx),sr=new Yi.A({symbolLayers:new S.A([new Qi.A({material:{color:tr.fT},edges:new Ki.A({size:"1px",color:tr.JR})})])});function ar(e){if(null==e)return null;switch(e.type){case"mesh":return sr;case"point":case"multipoint":return ir;case"polyline":return rr;case"polygon":case"extent":return nr}return null}var or=i(4212),lr=i(47675);const cr=3,dr=3,hr=10;var ur,pr=i(72745),fr=i(83755),gr=i(13927),mr=i(95925),_r=i(50468);!function(e){e.length=function(e,t){const i=e[t],r=e[t+1],n=e[t+2];return Math.sqrt(i*i+r*r+n*n)},e.normalize=function(e,t){const i=e[t],r=e[t+1],n=e[t+2],s=1/Math.sqrt(i*i+r*r+n*n);e[t]*=s,e[t+1]*=s,e[t+2]*=s},e.scale=function(e,t,i){e[t]*=i,e[t+1]*=i,e[t+2]*=i},e.add=function(e,t,i,r,n){let s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:t;(n=n||e)[s]=e[t]+i[r],n[s+1]=e[t+1]+i[r+1],n[s+2]=e[t+2]+i[r+2]},e.subtract=function(e,t,i,r,n){let s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:t;(n=n||e)[s]=e[t]-i[r],n[s+1]=e[t+1]-i[r+1],n[s+2]=e[t+2]-i[r+2]}}(ur||(ur={}));var vr=i(87634),yr=i(37761),br=i(86994);const xr=ur,Sr=[[-.5,-.5,.5],[.5,-.5,.5],[.5,.5,.5],[-.5,.5,.5],[-.5,-.5,-.5],[.5,-.5,-.5],[.5,.5,-.5],[-.5,.5,-.5]],wr=[0,0,1,-1,0,0,1,0,0,0,-1,0,0,1,0,0,0,-1],Cr=[0,0,1,0,1,1,0,1],Ar=[0,1,2,2,3,0,4,0,3,3,7,4,1,5,6,6,2,1,1,0,4,4,5,1,3,2,6,6,7,3,5,4,7,7,6,5],Rr=new Array(36);for(let QS=0;QS<6;QS++)for(let e=0;e<6;e++)Rr[6*QS+e]=QS;const Er=new Array(36);for(let QS=0;QS<6;QS++)Er[6*QS]=0,Er[6*QS+1]=1,Er[6*QS+2]=2,Er[6*QS+3]=2,Er[6*QS+4]=3,Er[6*QS+5]=0;const Or=[[-.5,0,-.5],[.5,0,-.5],[.5,0,.5],[-.5,0,.5],[0,-.5,0],[0,.5,0]],Tr=[0,1,-1,1,1,0,0,1,1,-1,1,0,0,-1,-1,1,-1,0,0,-1,1,-1,-1,0],Pr=[5,1,0,5,2,1,5,3,2,5,0,3,4,0,1,4,1,2,4,2,3,4,3,0],Mr=[0,0,0,1,1,1,2,2,2,3,3,3,4,4,4,5,5,5,6,6,6,7,7,7];const Ir=(0,fr.fA)(-.5,0,-.5),Dr=(0,fr.fA)(.5,0,-.5),Lr=(0,fr.fA)(0,0,.5),Fr=(0,fr.fA)(0,.5,0),Nr=(0,fr.vt)(),Vr=(0,fr.vt)(),Gr=(0,fr.vt)(),Ur=(0,fr.vt)(),zr=(0,fr.vt)();(0,M.f)(Nr,Ir,Fr),(0,M.f)(Vr,Ir,Dr),(0,M.b)(Gr,Nr,Vr),(0,M.n)(Gr,Gr),(0,M.f)(Nr,Dr,Fr),(0,M.f)(Vr,Dr,Lr),(0,M.b)(Ur,Nr,Vr),(0,M.n)(Ur,Ur),(0,M.f)(Nr,Lr,Fr),(0,M.f)(Vr,Lr,Ir),(0,M.b)(zr,Nr,Vr),(0,M.n)(zr,zr);const Br=[Ir,Dr,Lr,Fr],Hr=[0,-1,0,Gr[0],Gr[1],Gr[2],Ur[0],Ur[1],Ur[2],zr[0],zr[1],zr[2]],jr=[0,1,2,3,1,0,3,2,1,3,0,2],Wr=[0,0,0,1,1,1,2,2,2,3,3,3];function kr(e,t,i,r){const n=function(e,t,i){const r=e;let n,s;if(i)n=[0,-1,0,1,0,0,0,0,1,-1,0,0,0,0,-1,0,1,0],s=[0,1,2,0,2,3,0,3,4,0,4,1,1,5,2,2,5,3,3,5,4,4,5,1];else{const e=r*(1+Math.sqrt(5))/2;n=[-r,e,0,r,e,0,-r,-e,0,r,-e,0,0,-r,e,0,r,e,0,-r,-e,0,r,-e,e,0,-r,e,0,r,-e,0,-r,-e,0,r],s=[0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1]}for(let c=0;c<n.length;c+=3)xr.scale(n,c,e/xr.length(n,c));let a={};function o(t,i){t>i&&([t,i]=[i,t]);const r=t.toString()+"."+i.toString();if(a[r])return a[r];let s=n.length;return n.length+=3,xr.add(n,3*t,n,3*i,n,s),xr.scale(n,s,e/xr.length(n,s)),s/=3,a[r]=s,s}for(let c=0;c<t;c++){const e=s.length,t=new Array(4*e);for(let i=0;i<e;i+=3){const e=s[i],r=s[i+1],n=s[i+2],a=o(e,r),l=o(r,n),c=o(n,e),d=4*i;t[d]=e,t[d+1]=a,t[d+2]=c,t[d+3]=r,t[d+4]=l,t[d+5]=a,t[d+6]=n,t[d+7]=c,t[d+8]=l,t[d+9]=a,t[d+10]=l,t[d+11]=c}s=t,a={}}const l=(0,Y.Wz)(n);for(let c=0;c<l.length;c+=3)xr.normalize(l,c);return[[Pt.r.POSITION,new _r.n((0,Y.Wz)(n),s,3,!0)],[Pt.r.NORMAL,new _r.n(l,s,3,!0)]]}(t,i,r);return new yr.V(e,n)}function Zr(e,t,i,r,n,s,a,o){var l;let c=arguments.length>8&&void 0!==arguments[8]?arguments[8]:null;const d=i?(0,I.o8)(i):(0,I.vt)(),h=t?(0,I.o8)(t):(0,I.fA)(0,0,1);null!==(l=a)&&void 0!==l||(a=(0,pr.vt)());const u=r?[255*r[0],255*r[1],255*r[2],r.length>3?255*r[3]:255]:[255,255,255,255],p=null!=n&&2===n.length?n:[1,1],f=(0,X.EH)(1),g=[[Pt.r.POSITION,new _r.n(d,f,3,!0)],[Pt.r.NORMAL,new _r.n(h,f,3,!0)],[Pt.r.UV0,new _r.n(a,f,a.length)],[Pt.r.COLOR,new _r.n(u,f,4,!0)],[Pt.r.SIZE,new _r.n(p,f,2)]];if(null!=s&&(s=[s[0],s[1],s[2],s[3]],g.push([Pt.r.CENTEROFFSETANDDISTANCE,new _r.n(s,f,4)])),o){const e=[o[0],o[1],o[2],o[3]];g.push([Pt.r.FEATUREATTRIBUTE,new _r.n(e,f,4)])}return new yr.V(e,g,null,vr.X.Point,c)}function qr(e,t,i,r,n){let s=!(arguments.length>5&&void 0!==arguments[5])||arguments[5],a=!(arguments.length>6&&void 0!==arguments[6])||arguments[6],o=0;const l=i,c=t;let d=(0,fr.fA)(0,o,0),h=(0,fr.fA)(0,o+c,0),u=(0,fr.fA)(0,-1,0),p=(0,fr.fA)(0,1,0);n&&(o=c,h=(0,fr.fA)(0,0,0),d=(0,fr.fA)(0,o,0),u=(0,fr.fA)(0,1,0),p=(0,fr.fA)(0,-1,0));const f=[h,d],g=[u,p],m=r+2,_=Math.sqrt(c*c+l*l);if(n)for(let w=r-1;w>=0;w--){const e=w*(2*Math.PI/r),t=(0,fr.fA)(Math.cos(e)*l,o,Math.sin(e)*l);f.push(t);const i=(0,fr.fA)(c*Math.cos(e)/_,-l/_,c*Math.sin(e)/_);g.push(i)}else for(let w=0;w<r;w++){const e=w*(2*Math.PI/r),t=(0,fr.fA)(Math.cos(e)*l,o,Math.sin(e)*l);f.push(t);const i=(0,fr.fA)(c*Math.cos(e)/_,l/_,c*Math.sin(e)/_);g.push(i)}const v=new Array,y=new Array;if(s){for(let e=3;e<f.length;e++)v.push(1),v.push(e-1),v.push(e),y.push(0),y.push(0),y.push(0);v.push(f.length-1),v.push(2),v.push(1),y.push(0),y.push(0),y.push(0)}if(a){for(let e=3;e<f.length;e++)v.push(e),v.push(e-1),v.push(0),y.push(e),y.push(e-1),y.push(1);v.push(0),v.push(2),v.push(f.length-1),y.push(1),y.push(2),y.push(g.length-1)}const b=(0,Y.oe)(3*m);for(let w=0;w<m;w++)b[3*w]=f[w][0],b[3*w+1]=f[w][1],b[3*w+2]=f[w][2];const x=(0,Y.oe)(3*m);for(let w=0;w<m;w++)x[3*w]=g[w][0],x[3*w+1]=g[w][1],x[3*w+2]=g[w][2];const S=[[Pt.r.POSITION,new _r.n(b,v,3,!0)],[Pt.r.NORMAL,new _r.n(x,y,3,!0)]];return new yr.V(e,S)}function Qr(e,t,i,r,n){return!(Math.abs((0,M.j)(t,e))>n)&&((0,M.b)(i,e,t),(0,M.n)(i,i),(0,M.b)(r,i,e),(0,M.n)(r,r),!0)}function Jr(e,t,i,r,n,s,a){return Qr(e,t,n,s,a)||Qr(e,i,n,s,a)||Qr(e,r,n,s,a)}(0,I.vt)();class Yr{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;this.geometry=e,this.textures=t}}class Xr{constructor(e,t,i){this.components=e,this.minScreenSpaceRadius=t,this.pivotOffset=i;const r=this.geometries;this.numVertices=r.reduce(((e,t)=>e+t.attributes.get(Pt.r.POSITION).indices.length),0)}get geometries(){return(0,b.Am)(this.components.map((e=>e.geometry)))}}class $r{constructor(e){this.levels=e,this.levels.sort(((e,t)=>e.minScreenSpaceRadius===t.minScreenSpaceRadius?e.numVertices-t.numVertices:e.minScreenSpaceRadius-t.minScreenSpaceRadius))}}function Kr(e){const t=[];return e.levels.forEach((e=>e.components.forEach((e=>t.push(e.geometry.material))))),(0,b.Am)(t)}function en(e){const t=new Array;return e.levels.forEach((e=>e.components.forEach((e=>{null!=e.textures&&t.push(...e.textures)})))),(0,b.Am)(t)}function tn(e){const t=new Array;return e.levels.forEach((e=>e.components.forEach((e=>t.push(e.geometry))))),(0,b.Am)(t)}function rn(e,t){const i=function(e,t){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return new $r(e.map((e=>{const r=t(e.tesselation);return i&&function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e;const i=e.attributes,r=i.get(Pt.r.POSITION).data,n=i.get(Pt.r.NORMAL).data;if(n){const e=t.getMutableAttribute(Pt.r.NORMAL).data;for(let t=0;t<n.length;t+=3){const i=n[t+1];e[t+1]=-n[t+2],e[t+2]=i}}if(r){const e=t.getMutableAttribute(Pt.r.POSITION).data;for(let t=0;t<r.length;t+=3){const i=r[t+1];e[t+1]=-r[t+2],e[t+2]=i}}}(r),new Xr([new Yr(r)],e.minScreenSpaceRadius)})))};switch(e){case"sphere":return i([{tesselation:0,minScreenSpaceRadius:0},{tesselation:1,minScreenSpaceRadius:8},{tesselation:2,minScreenSpaceRadius:16},{tesselation:3,minScreenSpaceRadius:50},{tesselation:4,minScreenSpaceRadius:250}],(e=>kr(t,.5,e,!0)));case"cube":return i([{tesselation:0,minScreenSpaceRadius:0}],(()=>function(e,t){Array.isArray(t)||(t=[t,t,t]);const i=new Array(24);for(let r=0;r<8;r++)i[3*r]=Sr[r][0]*t[0],i[3*r+1]=Sr[r][1]*t[1],i[3*r+2]=Sr[r][2]*t[2];return new yr.V(e,[[Pt.r.POSITION,new _r.n(i,Ar,3,!0)],[Pt.r.NORMAL,new _r.n(wr,Rr,3)],[Pt.r.UV0,new _r.n(Cr,Er,2)]])}(t,1)));case"cone":return i(nn,(e=>qr(t,1,.5,e,!1)),!0);case"inverted-cone":return i(nn,(e=>qr(t,1,.5,e,!0)),!0);case"cylinder":return i(nn,(e=>function(e,t,i,r,n,s,a){var o;const l=n?(0,fr.o8)(n):(0,fr.fA)(1,0,0),c=s?(0,fr.o8)(s):(0,fr.fA)(0,0,0);null!==(o=a)&&void 0!==o||(a=!0);const d=(0,fr.vt)();(0,M.n)(d,l);const h=(0,fr.vt)();(0,M.h)(h,d,Math.abs(t));const u=(0,fr.vt)();(0,M.h)(u,h,-.5),(0,M.g)(u,u,c);const p=(0,fr.fA)(0,1,0);Math.abs(1-(0,M.j)(d,p))<.2&&(0,M.s)(p,0,0,1);const f=(0,fr.vt)();(0,M.b)(f,d,p),(0,M.n)(f,f),(0,M.b)(p,f,d);const g=2*r+(a?2:0),m=r+(a?2:0),_=(0,Y.oe)(3*g),v=(0,Y.oe)(3*m),y=(0,Y.oe)(2*g),b=new Array(3*r*(a?4:2)),x=new Array(3*r*(a?4:2));a&&(_[3*(g-2)]=u[0],_[3*(g-2)+1]=u[1],_[3*(g-2)+2]=u[2],y[2*(g-2)]=0,y[2*(g-2)+1]=0,_[3*(g-1)]=_[3*(g-2)]+h[0],_[3*(g-1)+1]=_[3*(g-2)+1]+h[1],_[3*(g-1)+2]=_[3*(g-2)+2]+h[2],y[2*(g-1)]=1,y[2*(g-1)+1]=1,v[3*(m-2)]=-d[0],v[3*(m-2)+1]=-d[1],v[3*(m-2)+2]=-d[2],v[3*(m-1)]=d[0],v[3*(m-1)+1]=d[1],v[3*(m-1)+2]=d[2]);const S=(e,t,i)=>{b[e]=t,x[e]=i};let w=0;const C=(0,fr.vt)(),A=(0,fr.vt)();for(let E=0;E<r;E++){const e=E*(2*Math.PI/r);(0,M.h)(C,p,Math.sin(e)),(0,M.h)(A,f,Math.cos(e)),(0,M.g)(C,C,A),v[3*E]=C[0],v[3*E+1]=C[1],v[3*E+2]=C[2],(0,M.h)(C,C,i),(0,M.g)(C,C,u),_[3*E]=C[0],_[3*E+1]=C[1],_[3*E+2]=C[2],y[2*E]=E/r,y[2*E+1]=0,_[3*(E+r)]=_[3*E]+h[0],_[3*(E+r)+1]=_[3*E+1]+h[1],_[3*(E+r)+2]=_[3*E+2]+h[2],y[2*(E+r)]=E/r,y[2*E+1]=1;const t=(E+1)%r;S(w++,E,E),S(w++,E+r,E),S(w++,t,t),S(w++,t,t),S(w++,E+r,E),S(w++,t+r,t)}if(a){for(let e=0;e<r;e++){const t=(e+1)%r;S(w++,g-2,m-2),S(w++,e,m-2),S(w++,t,m-2)}for(let e=0;e<r;e++){const t=(e+1)%r;S(w++,e+r,m-1),S(w++,g-1,m-1),S(w++,t+r,m-1)}}const R=[[Pt.r.POSITION,new _r.n(_,b,3,!0)],[Pt.r.NORMAL,new _r.n(v,x,3,!0)],[Pt.r.UV0,new _r.n(y,b,2,!0)]];return new yr.V(e,R)}(t,1,.5,e,[0,0,1],[0,0,.5])));case"tetrahedron":return i([{tesselation:0,minScreenSpaceRadius:0}],(()=>function(e,t){Array.isArray(t)||(t=[t,t,t]);const i=new Array(12);for(let r=0;r<4;r++)i[3*r]=Br[r][0]*t[0],i[3*r+1]=Br[r][1]*t[1],i[3*r+2]=Br[r][2]*t[2];return new yr.V(e,[[Pt.r.POSITION,new _r.n(i,jr,3,!0)],[Pt.r.NORMAL,new _r.n(Hr,Wr,3)]])}(t,1)),!0);case"diamond":return i([{tesselation:0,minScreenSpaceRadius:0}],(()=>function(e,t){Array.isArray(t)||(t=[t,t,t]);const i=new Array(18);for(let r=0;r<6;r++)i[3*r]=Or[r][0]*t[0],i[3*r+1]=Or[r][1]*t[1],i[3*r+2]=Or[r][2]*t[2];return new yr.V(e,[[Pt.r.POSITION,new _r.n(i,Pr,3,!0)],[Pt.r.NORMAL,new _r.n(Tr,Mr,3)]])}(t,1)),!0);default:return}}const nn=[{tesselation:6,minScreenSpaceRadius:0},{tesselation:18,minScreenSpaceRadius:7},{tesselation:64,minScreenSpaceRadius:65}];class sn{constructor(e){var t,i,r,n;this.estimated=!1,this.verticesPerFeature=null!==(t=e.verticesPerFeature)&&void 0!==t?t:0,this.verticesPerCoordinate=null!==(i=e.verticesPerCoordinate)&&void 0!==i?i:0,this.drawCallsPerFeature=null!==(r=e.drawCallsPerFeature)&&void 0!==r?r:0,this.memory=null!==(n=e.memory)&&void 0!==n?n:new cn}}class an extends sn{constructor(e){super(e),this.estimated=!0}}class on extends sn{constructor(e,t){super(t),this.numComplexities=e}}class ln extends an{constructor(e,t){super(t),this.numComplexities=e}}class cn{constructor(){this.bytesPerFeature=0,this.bytesPerFeatureLabel=0,this.resourceBytes=0,this.draped={bytesPerFeature:0,bytesPerFeatureLabel:0}}}var dn=i(7342),hn=i(65131);const un=new an({});function pn(e){let t=0,i=0,r=0,n=!1,s=0;const a=new cn;for(const o of e)null!=o&&(t+=o.verticesPerFeature,i+=o.verticesPerCoordinate,r+=o.drawCallsPerFeature,a.bytesPerFeature+=o.memory.bytesPerFeature,a.bytesPerFeatureLabel+=o.memory.bytesPerFeatureLabel,a.resourceBytes+=o.memory.resourceBytes,a.draped.bytesPerFeature+=o.memory.bytesPerFeature,a.draped.bytesPerFeatureLabel+=o.memory.bytesPerFeatureLabel,n=n||o.estimated,++s);return n?new ln(s,{verticesPerFeature:t,verticesPerCoordinate:i,drawCallsPerFeature:r,memory:a}):new on(s,{verticesPerFeature:t,verticesPerCoordinate:i,drawCallsPerFeature:r,memory:a})}const fn={};function gn(e,t){var i,r,n;const s=mn(e,t),a=(0,dn.RF)(t)?2:0;switch(t.type){case"extrude":return new sn({verticesPerFeature:-12,verticesPerCoordinate:12,drawCallsPerFeature:a,memory:s});case"fill":if("mesh-3d"===e.type)return new sn({drawCallsPerFeature:a,memory:s});if(null!=t.outline&&t.outline.size>0)return new sn({verticesPerFeature:-12,verticesPerCoordinate:9,memory:s});case"water":return new sn({verticesPerFeature:-6,verticesPerCoordinate:3,memory:s});case"line":return new sn({verticesPerFeature:-6,verticesPerCoordinate:6,memory:s});case"object":return null!==(i=t.resource)&&void 0!==i&&i.href?new an({verticesPerFeature:100,memory:s}):{..._n(null!==(r=null===(n=t.resource)||void 0===n?void 0:n.primitive)&&void 0!==r?r:lr.r),memory:s};case"path":{var o;let e=0,i=0;switch(t.profile){case"circle":e=hr;break;case"quad":e=4;break;default:return void(0,or.Xb)(t.profile)}switch(null!==(o=t.join)&&void 0!==o?o:"simple"){case"round":i=cr;break;case"miter":case"bevel":i=1;break;default:return}const r=2*e,n=e*i*2,a=n+r;let l=-2*n-r;switch(t.cap){case"none":break;case"butt":case"square":l+=2*(e-1);break;case"round":l+=2*(e*(dr-1)*2+e);break;default:return}return new sn({verticesPerFeature:l,verticesPerCoordinate:a,memory:s})}case"text":case"icon":return new sn({verticesPerFeature:6,memory:s});default:return}}function mn(e,t){const i="point-3d"===e.type;switch(t.type){case"extrude":return t.edges&&t.edges.size>0?yn.EXTRUDE_EDGES:yn.EXTRUDE;case"fill":return null!=t.outline&&t.outline.size>0?yn.FILL_OUTLINE:yn.FILL;case"water":return yn.FILL;case"line":return"round"===t.join?yn.LINE_ROUND:yn.LINE_MITER;case"path":switch(t.join){case"round":switch(t.profile){case"circle":return yn.PATH_ROUND_CIRCLE;case"quad":return yn.PATH_ROUND_QUAD;default:return void(0,or.Xb)(t.profile)}case"miter":case"bevel":switch(t.profile){case"circle":return yn.PATH_MITER_CIRCLE;case"quad":return yn.PATH_MITER_QUAD;default:return void(0,or.Xb)(t.profile)}default:return}case"object":return i?yn.OBJECT_POINT:yn.OBJECT_POLYGON;case"icon":case"text":return i?yn.ICON_POINT:yn.ICON_POLYGON;default:return}}function _n(e){const t=fn[e];if(t)return t;const i=vn(rn(e,new hn.$U({})).levels);return fn[e]=new sn({verticesPerFeature:i}),fn[e]}function vn(e){return e.reduce(((e,t,i)=>e+t.numVertices*(1/10**i)),0)/e.reduce(((e,t,i)=>e+1/10**i),0)}const yn={ICON_POINT:{bytesPerFeature:2379.8272296852992,bytesPerFeatureLabel:852.246235,resourceBytes:0,draped:{bytesPerFeature:1868.2382921559424,bytesPerFeatureLabel:839.205415}},ICON_POLYGON:{bytesPerFeature:2957.8429876524656,bytesPerFeatureLabel:862.5307816666666,resourceBytes:0,draped:{bytesPerFeature:2579.7767085451133,bytesPerFeatureLabel:856.9298550000001}},OBJECT_POINT:{bytesPerFeature:603.543820573039,bytesPerFeatureLabel:717.4551849999999,resourceBytes:0,draped:{bytesPerFeature:603.543820573039,bytesPerFeatureLabel:717.4551849999999}},OBJECT_POLYGON:{bytesPerFeature:1111.1693389308373,bytesPerFeatureLabel:707.4535949999998,resourceBytes:0,draped:{bytesPerFeature:1111.1693389308373,bytesPerFeatureLabel:707.4535949999998}},LINE_MITER:{bytesPerFeature:3081.208408220661,bytesPerFeatureLabel:858.6749016666668,resourceBytes:0,draped:{bytesPerFeature:2682.57863388475,bytesPerFeatureLabel:844.6118016666666}},LINE_ROUND:{bytesPerFeature:3209.3236242927915,bytesPerFeatureLabel:858.1810416666667,resourceBytes:0,draped:{bytesPerFeature:2687.6256038096126,bytesPerFeatureLabel:849.578535}},PATH_MITER_CIRCLE:{bytesPerFeature:38708.74276663992,bytesPerFeatureLabel:858.70415,resourceBytes:0,draped:{bytesPerFeature:38708.74276663992,bytesPerFeatureLabel:858.70415}},PATH_ROUND_CIRCLE:{bytesPerFeature:42098.00590216518,bytesPerFeatureLabel:868.3632500000001,resourceBytes:0,draped:{bytesPerFeature:42098.00590216518,bytesPerFeatureLabel:868.3632500000001}},PATH_MITER_QUAD:{bytesPerFeature:25037.823002405767,bytesPerFeatureLabel:835.93355,resourceBytes:0,draped:{bytesPerFeature:25037.823002405767,bytesPerFeatureLabel:835.93355}},PATH_ROUND_QUAD:{bytesPerFeature:40320.254760224525,bytesPerFeatureLabel:851.66955,resourceBytes:0,draped:{bytesPerFeature:40320.254760224525,bytesPerFeatureLabel:851.66955}},FILL:{bytesPerFeature:3147.43349219103,bytesPerFeatureLabel:850.7598550000001,resourceBytes:0,draped:{bytesPerFeature:2673.7898488975106,bytesPerFeatureLabel:846.6459950000002}},FILL_OUTLINE:{bytesPerFeature:4565.099993465867,bytesPerFeatureLabel:855.334515,resourceBytes:0,draped:{bytesPerFeature:3904.46969705314,bytesPerFeatureLabel:844.7081016666667}},EXTRUDE:{bytesPerFeature:7551.2282834569505,bytesPerFeatureLabel:849.5513283333333,resourceBytes:0,draped:{bytesPerFeature:7551.2282834569505,bytesPerFeatureLabel:849.5513283333333}},EXTRUDE_EDGES:{bytesPerFeature:2959.8379634500698,bytesPerFeatureLabel:602.0969283333335,resourceBytes:0,draped:{bytesPerFeature:2959.8379634500698,bytesPerFeatureLabel:602.0969283333335}}};class bn{constructor(e,t,i){this.maximumTotalNumberOfVertices=e,this.maximumNumberOfFeatures=t,this.averageSymbolComplexity=i}}var xn,Sn;i(66388);class wn{constructor(e,t){this.spatialReference=e,this._view=t}getElevation(e,t,i){return this._view.elevationProvider.getElevation(e,t,0,this.spatialReference,i)}async queryElevation(e,t,i,r,n){return this._view.elevationProvider.queryElevation(e,t,0,this.spatialReference,n,i,r)}}!function(e){e[e.USER=1]="USER",e[e.SCALE_RANGE=2]="SCALE_RANGE",e[e.FILTER=4]="FILTER",e[e.DECONFLICTION=8]="DECONFLICTION",e[e.ALL_GRAPHIC=15]="ALL_GRAPHIC",e[e.ALL_LABEL=255]="ALL_LABEL"}(xn||(xn={})),function(e){e[e.GRAPHIC=1]="GRAPHIC",e[e.LABEL=16]="LABEL"}(Sn||(Sn={}));var Cn=i(54099),An=i(20176),Rn=i(1484),En=i(26724);const On=(0,q.vt)();let Tn=class extends s.A{constructor(e){super(e),this.events=new Cn.A,this.hasZ=null,this.hasM=null,this.objectIdField=null,this.featureAdapter={getAttribute:(e,t)=>"graphic"in e?e.graphic.attributes[t]:En.T.getAttribute(e,t),getAttributes:e=>"graphic"in e?e.graphic.attributes:En.T.getAttributes(e),getObjectId:e=>{var t;return"graphic"in e?null!==(t=(0,ji.RW)(e.graphic,this.objectIdField))&&void 0!==t?t:void 0:En.T.getObjectId(e)},getGeometry:e=>"graphic"in e?e.getAsOptimizedGeometry(this.hasZ,this.hasM):En.T.getGeometry(e),getCentroid:(e,t)=>{if("graphic"in e){let i=null;null!=e.centroid?i=e.centroid:"point"===e.graphic.geometry.type&&(0,zi.projectPoint)(e.graphic.geometry,Pn,this.viewSpatialReference)&&(i=Pn);const r=new Array(2+(t.hasZ?1:0)+(t.hasM?1:0));return null==i?(r[0]=0,r[1]=0,r[2]=0,r[3]=0):(r[0]=i.x,r[1]=i.y,t.hasZ&&(r[2]=i.hasZ?i.z:0),t.hasM&&(r[t.hasZ?3:2]=i.hasM?i.m:0)),new Rn.A([],r)}return En.T.getCentroid(e,t)},cloneWithGeometry:(e,t)=>"graphic"in e?new An.Om(t,this.featureAdapter.getAttributes(e),null,this.featureAdapter.getObjectId(e)):En.T.cloneWithGeometry(e,t)}}forEachInBounds(e,t){this.getSpatialIndex().forEachInBounds(e,t)}forEachBounds(e,t){const i=this.getSpatialIndex();for(const r of e){const e=this.featureAdapter.getObjectId(r);null!=i.getBounds(e,On)&&t(On)}}};(0,r._)([(0,d.MZ)({constructOnly:!0})],Tn.prototype,"getSpatialIndex",void 0),(0,r._)([(0,d.MZ)({constructOnly:!0})],Tn.prototype,"forEach",void 0),(0,r._)([(0,d.MZ)({constructOnly:!0})],Tn.prototype,"hasZ",void 0),(0,r._)([(0,d.MZ)({constructOnly:!0})],Tn.prototype,"hasM",void 0),(0,r._)([(0,d.MZ)({constructOnly:!0})],Tn.prototype,"objectIdField",void 0),(0,r._)([(0,d.MZ)({constructOnly:!0})],Tn.prototype,"viewSpatialReference",void 0),(0,r._)([(0,d.MZ)({constructOnly:!0})],Tn.prototype,"featureSpatialReference",void 0),Tn=(0,r._)([(0,u.$)("esri.views.3d.layers.graphics.Graphics3DFeatureStore")],Tn);const Pn={type:"point",x:0,y:0,hasZ:!1,hasM:!1,spatialReference:null};class Mn{constructor(e,t,i){this.graphic=e,this.renderingInfo=t,this.layer=i}}class In{constructor(e,t){this.scheduler=e,this.schedule=t,this.sharedResources=null,this.streamDataRequester=null,this.elevationProvider=null,this.renderer=null,this.stage=null,this.clippingExtent=null,this.renderCoordsHelper=null,this.overlaySR=null,this.layer=null,this.drapeSourceRenderer=null,this.graphicsCoreOwner=null,this.localOriginFactory=null,this.featureExpressionInfoContext=null,this.screenSizePerspectiveEnabled=!0,this.slicePlaneEnabled=!1,this.physicalBasedRenderingEnabled=!1,this.skipHighSymbolLods=!1,this.isAsync=!1}}var Dn=i(82041),Ln=i(76931),Fn=i(22955);function Nn(e){return null!=e.mapPositions}function Vn(e,t,i,r,n){const s=e.stageObject,a=s.geometries;let o=0;for(const l of a){if(!Nn(l))continue;const{update:e,averageGeometrySampledElevation:a}=Jn(l,t,i,r,n);o+=a,e&&s.geometryVertexAttributeUpdated(l,Pt.r.POSITION)}return o/a.length}function Gn(e,t,i,r,n,s){const a=e.stageObject,o=t.centerPointInElevationSR;let l=0;a.usesVerticalDistanceToGround?(r(o,Qn),Gt(a,Qn.verticalDistanceToGround),l=Qn.sampledElevation):(r(o,Qn),"absolute-height"!==t.mode&&(l=Qn.sampledElevation));const c=(0,T.C)(Un,null!==s&&void 0!==s?s:a.transformation),d=(0,M.s)(qn,c[12],c[13],c[14]);Fn.b.TESTS_DISABLE_OPTIMIZATIONS?(jn[0]=o.x,jn[1]=o.y,jn[2]=Qn.z,(0,Ct.l)(o.spatialReference,jn,c,n.spatialReference)&&(s?(0,T.C)(s,c):a.transformation=c)):n.setAltitudeOfTransformation(Qn.z,c);const h=Hn/n.unitInMeters;return(Math.abs(c[12]-d[0])>=h||Math.abs(c[13]-d[1])>=h||Math.abs(c[14]-d[2])>=h)&&(s?(0,T.C)(s,c):a.transformation=c),l}const Un=(0,P.vt)();function zn(e,t,i,r,n){const s=e.graphics3DSymbolLayer.lodRenderer;if(null==s)return 0;const a=t.centerPointInElevationSR;r(a,Qn);const o="absolute-height"!==t.mode?Qn.sampledElevation:0,l=s.instanceData,c=e.instanceIndex,d=Zn;l.getGlobalTransform(c,d);const h=(0,M.s)(qn,d[12],d[13],d[14]);Fn.b.TESTS_DISABLE_OPTIMIZATIONS?(jn[0]=a.x,jn[1]=a.y,jn[2]=Qn.z,(0,Ct.l)(a.spatialReference,jn,d,n.spatialReference)&&l.setGlobalTransform(c,d)):n.setAltitudeOfTransformation(Qn.z,d);const u=Hn/n.unitInMeters;return(Fn.b.TESTS_DISABLE_OPTIMIZATIONS||Math.abs(d[12]-h[0])>=u||Math.abs(d[13]-h[1])>=u||Math.abs(d[14]-h[2])>=u)&&l.setGlobalTransform(c,d),o}function Bn(e,t,i,r,n){const s=e.stageObject,a=s.geometries;if(0===a.length)return 0;let o=0,l=null,c=0,d=!1;for(const h of a){if(!Nn(h))continue;const e=h.attributes.get(Pt.r.POSITION);if(e!==l){const{update:s,averageGeometrySampledElevation:a}=Jn(h,t,i,r,n);c=a,l=e,d=s}d&&s.geometryVertexAttributeUpdated(h,Pt.r.POSITION),o+=c}return o/a.length}const Hn=.01,jn=(0,I.vt)(),Wn=(0,I.vt)(),kn=(0,I.vt)(),Zn=(0,P.vt)(),qn=(0,I.vt)(),Qn=new Ut;function Jn(e,t,i,r,n){let s=!1;const a=e.transformation,o=t.requiresSampledElevationInfo;Wn[0]=a[12],Wn[1]=a[13],Wn[2]=a[14],e.invalidateBoundingInfo();const l=e.getMutableAttribute(Pt.r.POSITION),c=l.data,d=l.size,h=c.length/d,u=new Rt(e.mapPositions,i);let p=0,f=0;for(let g=0;g<h;g++){if(kn[0]=c[p],kn[1]=c[p+1],kn[2]=c[p+2],r(u,Qn),o&&(f+=Qn.sampledElevation),Fn.b.TESTS_DISABLE_OPTIMIZATIONS)c[p]=u.array[u.offset],c[p+1]=u.array[u.offset+1],c[p+2]=Qn.z,(0,k.projectBuffer)(c,i,p,c,n.spatialReference,p,1),c[p]-=Wn[0],c[p+1]-=Wn[1],c[p+2]-=Wn[2],s=!0;else{jn[0]=c[p]+Wn[0],jn[1]=c[p+1]+Wn[1],jn[2]=c[p+2]+Wn[2],n.setAltitude(jn,Qn.z),c[p]=jn[0]-Wn[0],c[p+1]=jn[1]-Wn[1],c[p+2]=jn[2]-Wn[2];const e=Hn/n.unitInMeters;(Math.abs(kn[0]-c[p])>=e||Math.abs(kn[1]-c[p+1])>=e||Math.abs(kn[2]-c[p+2])>=e)&&(s=!0)}p+=d,u.offset+=3}return f/=h,{update:s,averageGeometrySampledElevation:f}}var Yn=i(205),Xn=i(5262);function $n(e,t){if("point"===e.type)return es(e,t,!1);if(Zt(e))switch(e.type){case"extent":return es(e.center,t,!1);case"polygon":return es(e.centroid,t,!1);case"polyline":return es(Kn(e),t,!0);case"mesh":return es(e.origin,t,!1)}else switch(e.type){case"extent":return es(function(e){return(0,ne.T)(.5*(e.xmax+e.xmin),.5*(e.ymax+e.ymin),null!=e.zmin&&null!=e.zmax&&isFinite(e.zmin)&&isFinite(e.zmax)?.5*(e.zmax+e.zmin):void 0,e.spatialReference)}(e),t,!0);case"polygon":return es(function(e){const t=e.rings[0];if(!t||0===t.length)return null;const i=(0,Yn.S8)(e.rings,!!e.hasZ);return(0,ne.T)(i[0],i[1],i[2],e.spatialReference)}(e),t,!0);case"polyline":return es(Kn(e),t,!0)}}function Kn(e){const t=e.paths[0];if(!t||0===t.length)return null;const i=(0,Xn.$H)(t,(0,Xn.Yl)(t)/2);return(0,ne.T)(i[0],i[1],i[2],e.spatialReference)}function es(e,t,i){const r=i?e:function(e,t){if(!e)return null;let i;if(qt(e)){if(null==t)return e.clone();if(qt(t))return t.copy(e)}return null!=t?(i=t,i.x=e.x,i.y=e.y,i.spatialReference=e.spatialReference,e.hasZ?(i.z=e.z,i.hasZ=e.hasZ):(i.z=void 0,i.hasZ=!1),e.hasM?(i.m=e.m,i.hasM=!0):(i.m=void 0,i.hasM=!1)):(i=(0,ne.T)(e.x,e.y,e.z,e.spatialReference),e.hasM&&(i.m=e.m,i.hasM=!0)),i}(e);return t&&e?(0,zi.projectPoint)(e,r,t)?r:null:r}function ts(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;const r=(0,L.o8)(L.Un);return null!=e&&(r[0]=e[0],r[1]=e[1],r[2]=e[2]),null!=t?r[3]=t:null!=e&&e.length>3&&(r[3]=e[3]),i&&(r[0]*=i,r[1]*=i,r[2]*=i,r[3]*=i),r}function is(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:I.Un,t=arguments.length>1?arguments[1]:void 0,i=arguments.length>2?arguments[2]:void 0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;const n=new Array(3);if(null==t||null==i)n[0]=1,n[1]=1,n[2]=1;else{let r,s=0;for(let a=2;a>=0;a--){const o=e[a];let l;const c=null!=o,d=0===a&&!r&&!c,h=i[a];"symbol-value"===o||d?l=0!==h?t[a]/h:1:c&&"proportional"!==o&&isFinite(o)&&(l=0!==h?o/h:1),null!=l&&(n[a]=l,r=l,s=Math.max(s,Math.abs(l)))}for(let e=2;e>=0;e--)null==n[e]?n[e]=r:0===n[e]&&(n[e]=.001*s)}for(let s=2;s>=0;s--)n[s]/=r;return(0,I.ci)(n)}function rs(e){return ns(function(e){return null!=e.isPrimitive}(e)?[e.width,e.depth,e.height]:e)?null:"Symbol sizes may not be negative values"}function ns(e){const t=e=>null==e||e>=0;return Array.isArray(e)?e.every(t):t(e)}function ss(e,t,i){if(null!=i.minDemResolution)return i.minDemResolution;const r=(0,R.GA)(t),n=(0,q.VL)(e)*r,s=(0,q.yr)(e)*r,a=(0,q.uJ)(e)*(t.isGeographic?1:r);return 0===n&&0===s&&0===a?i.minDemResolutionForPoints:.01*Math.max(n,s,a)}var as=i(46702);class os{constructor(e,t,i){this.baseMaterial=e,this.edgeMaterials=t,this.properties=i}}class ls{get isElevationSource(){return!!this.stageObject.lastValidElevationBB}constructor(e,t,i,r,n,s,a){let o=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null;this.graphics3DSymbolLayer=e,this.stageObject=t,this._uniqueGeometries=i,this._uniqueMaterials=r,this._sharedResource=n,this.elevationAligner=s,this.elevationContext=a,this._edgeState=o,this.type="object3d",this._stageLayer=null,this._visible=!1,this._addedToStage=!1,this.alignedSampledElevation=0,this.needsElevationUpdates=!1,this.useObjectOriginAsAttachmentOrigin=!1}initialize(e){this._stageLayer=e;const t=e.stage;t.addMany(this._uniqueMaterials),t.addMany(this._uniqueGeometries),t.add(this.stageObject)}destroy(){var e,t;if(!this._stageLayer)return;const i=this._stageLayer.stage;i.removeMany(this._uniqueMaterials),i.removeMany(this._uniqueGeometries),i.remove(this.stageObject),this._addedToStage&&(this._stageLayer.remove(this.stageObject),this._addedToStage=!1),null!==(e=i.renderer.edgeView)&&void 0!==e&&e.removeObject(this.stageObject),this.stageObject.dispose(),null!==(t=this._sharedResource)&&void 0!==t&&t.release(),this._visible=!1,this._stageLayer=null}layerOpacityChanged(e,t){if(null==this._edgeState)return;const i=cs(this._edgeState.baseMaterial);let r=!1;for(const n of this._edgeState.edgeMaterials)n.objectTransparency!==i&&(n.objectTransparency=i,r=!0);r&&this.resetEdgeObject(t),this._stageLayer.stage.renderer.ensureEdgeView().updateAllComponentOpacities(this.stageObject,[e])}slicePlaneEnabledChanged(e,t){null!=this._edgeState&&(this._stageLayer.stage.renderer.ensureEdgeView().updateAllComponentMaterials(this.stageObject,this._edgeState.edgeMaterials,{hasSlicePlane:e},!t),this._edgeState.properties.hasSlicePlane=e)}setVisibility(e){if(null!=this._stageLayer&&this._visible!==e&&(this._visible=e,this.stageObject.visible=e,this._visible&&!this._addedToStage&&(this._stageLayer.add(this.stageObject),this._addedToStage=!0),this._edgeState)){const t=this._stageLayer.stage.renderer.ensureEdgeView();t.hasObject(this.stageObject)?t.updateObjectVisibility(this.stageObject,e):e&&this._addOrUpdateEdgeObject(t,!1)}}get visible(){return this._visible}alignWithElevation(e,t,i,r){if(null==this.elevationAligner)return;null!=i&&ii(this.elevationContext.featureExpressionInfoContext,i);this.alignedSampledElevation=this.elevationAligner(this,this.elevationContext,e.spatialReference,((i,r)=>It(i,e,this.elevationContext,t,r)),t),this.resetEdgeObject(r)}alignWithAbsoluteElevation(e,t,i){this.alignedSampledElevation=this.elevationAligner(this,this.elevationContext,null,((t,i)=>{i.sampledElevation=e,i.verticalDistanceToGround=0,i.z=e}),t),this.resetEdgeObject(i)}getCenterObjectSpace(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,I.vt)();return(0,M.c)(e,(0,$.g)(this.stageObject.boundingVolumeObjectSpace.bounds))}getBoundingBoxObjectSpace(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,q.vt)();const t=this.stageObject.boundingVolumeObjectSpace;return(0,q.Ne)(e,t.min),(0,q.vI)(e,t.max),e}computeAttachmentOrigin(e){const t=this.stageObject.effectiveTransformation;if(this.useObjectOriginAsAttachmentOrigin)e.render.origin[0]+=t[12],e.render.origin[1]+=t[13],e.render.origin[2]+=t[14],e.render.num++;else for(const i of this.stageObject.geometries)i.computeAttachmentOrigin(us)&&((0,M.e)(us,us,t),(0,M.g)(e.render.origin,e.render.origin,us),e.render.num++)}async getProjectedBoundingBox(e,t,i,r,n){const s=this.getBoundingBoxObjectSpace(n),a=ps,o=(0,q.fT)(s)?1:a.length;for(let u=0;u<o;u++){const e=a[u];hs[0]=s[e[0]],hs[1]=s[e[1]],hs[2]=s[e[2]],(0,M.e)(hs,hs,this.stageObject.transformation),ds[3*u]=hs[0],ds[3*u+1]=hs[1],ds[3*u+2]=hs[2]}if(!e(ds,0,o))return null;(0,q.Ie)(s);let l=null;this.calculateRelativeScreenBounds&&(l=this.calculateRelativeScreenBounds());for(let u=0;u<3*o;u+=3){for(let e=0;e<3;e++)s[e]=Math.min(s[e],ds[u+e]),s[e+3]=Math.max(s[e+3],ds[u+e]);l&&i.push({location:ds.slice(u,u+3),screenSpaceBoundingRect:l})}if(null!==t&&void 0!==t&&t.service&&"absolute-height"!==this.elevationContext.mode){var c;(0,q.gX)(s,us);const e="relative-to-scene"===this.elevationContext.mode?"scene":"ground";let i=0;if(t.useViewElevation)i=null!==(c=t.service.getElevation(us[0],us[1],e))&&void 0!==c?c:0;else try{var d;const n=ss(s,t.service.spatialReference,t);i=null!==(d=await t.service.queryElevation(us[0],us[1],r,n,e))&&void 0!==d?d:0}catch(h){}(0,q.cY)(s,0,0,-this.alignedSampledElevation+i)}return s}addObjectState(e,t){e===fe.Mg.Highlight&&t.addObject(this.stageObject,this.stageObject.highlight()),e===fe.Mg.MaskOccludee&&t.addObject(this.stageObject,this.stageObject.maskOccludee())}removeObjectState(e){e.removeObject(this.stageObject)}resetEdgeObject(e){if(null==this._edgeState)return;const t=this._stageLayer.stage.renderer.ensureEdgeView();this._visible?this._addOrUpdateEdgeObject(t,e):t.removeObject(this.stageObject)}_addOrUpdateEdgeObject(e,t){const i=this._edgeState;if(null==i)return;const r=cs(i.baseMaterial);for(const n of i.edgeMaterials)n.objectTransparency=r;e.addOrUpdateObject3D(this.stageObject,i.edgeMaterials,i.properties,!t).then((()=>{var e;return null===(e=this._stageLayer)||void 0===e?void 0:e.sync()}))}}function cs(e){return e.isVisible()?e.parameters.transparent?as.x.TRANSPARENT:as.x.OPAQUE:as.x.INVISIBLE}const ds=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],hs=(0,I.vt)(),us=(0,I.vt)(),ps=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]];class fs{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;this.labelText=t,this.elevationOffset=null!==e&&void 0!==e?e:0}}var gs,ms;!function(e){e[e.RecreateSymbol=0]="RecreateSymbol",e[e.RecreateGraphics=1]="RecreateGraphics",e[e.FastUpdate=2]="FastUpdate"}(gs||(gs={}));class _s{constructor(e){this.schedule=e,this._abortController=null,this._loadStatus=ms.LOADING,this._loadError=null,this._loader=null,this.logger=null}destroy(){this.abortLoad()}get loadStatus(){return this._loadStatus}load(e,t){var i,r;return this._loadStatus===ms.LOADED?(e&&e(),null!==(i=this._loader)&&void 0!==i?i:Promise.resolve()):this._loadStatus===ms.FAILED?(t&&t(this._loadError),null!==(r=this._loader)&&void 0!==r?r:Promise.resolve()):(null==this._loader&&(this._abortController=new AbortController,this._loader=this.doLoad(this._abortController.signal).then((()=>{this._abortController=null,this._loadStatus=ms.LOADED}),(e=>{throw this._loadError=e,this._abortController=null,this._loadStatus=ms.FAILED,!(0,o.zf)(e)&&this.logger&&e.message&&this.logger.warn(e.message),e}))),this._loader.then(e,t).catch((()=>{})),this._loader)}abortLoad(){null!=this._abortController?this._abortController=(0,le.DC)(this._abortController):this._loadStatus===ms.LOADING&&(this._loadStatus=ms.FAILED),this._loader=null}}!function(e){e[e.LOADING=0]="LOADING",e[e.LOADED=1]="LOADED",e[e.FAILED=2]="FAILED"}(ms||(ms={}));var vs=i(63048);const ys=()=>a.A.getLogger("esri.views.3d.layers.graphics.Graphics3DSymbolLayer");class bs extends _s{constructor(e,t,i,r){super(i.schedule),this.symbol=e,this.symbolLayer=t,this._context=i,this.ignoreDrivers=!1,this._drivenProperties={color:!1,opacity:!1,opacityAlwaysOpaque:!0,size:!1},this._materials=[],this.usedMemory=0,this.logger=ys(),this._elevationOptions={supportsOffsetAdjustment:!1,supportsOnTheGround:!0},this.skipHighSymbolLodsChanged=!0,this._renderPriority=r.renderPriority,this._renderPriorityStep=r.renderPriorityStep,this._elevationContext=new oi,this.complexity=this.computeComplexity(),this.ignoreDrivers=r.ignoreDrivers,this.ignoreDrivers||(this._drivenProperties=xs(this._context.renderer)),this._updateElevationContext()}getCachedSize(){return null}get extentPadding(){return 0}get materials(){return this._materials}_drivenPropertiesChanged(e){if(this.ignoreDrivers)return!1;const t=this._drivenProperties,i=xs(e);return i.color!==t.color||i.opacity!==t.opacity||i.opacityAlwaysOpaque!==t.opacityAlwaysOpaque||i.size!==t.size}get needsDrivenTransparentPass(){return this._drivenProperties.opacity&&!this._drivenProperties.opacityAlwaysOpaque}_logGeometryCreationWarnings(e,t,i,r){const n=e.projectionSuccess,s="polygons"in e?e.polygons:null,a="".concat(r," geometry failed to be created");let o=null;n?!this._logGeometryValidationWarnings(t,i,r)&&s&&0===s.length&&"rings"===i&&t.length>0&&t[0].length>2&&(o="".concat(a," (filled rings should use clockwise winding - try reversing the order of vertices)")):o="".concat(a," (failed to project geometry to view spatial reference)"),o&&ys().warnOncePerTick(o)}_logGeometryValidationWarnings(e,t,i){const r="".concat(i," geometry failed to be created");return!e.length||1===e.length&&!e[0].length?(ys().warnOncePerTick("".concat(r," (no ").concat(t," were defined)")),!0):(!Array.isArray(e)||!Array.isArray(e[0]))&&(ys().warnOncePerTick("".concat(r," (").concat(t," should be defined as a 2D array)")),!0)}_validateGeometry(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;if(null!=t&&!t.includes(e.type))return this.logger.warn("unsupported geometry type for "+i+" symbol: ".concat(e.type)),!1;if("point"===e.type){const t=e;if(!isFinite(t.x)||!isFinite(t.y))return ys().warn("point coordinate is not a valid number, graphic skipped"),!1}return!0}_defaultElevationInfoNoZ(){return Ss}_defaultElevationInfoZ(){return ws}_updateElevationContext(){null!=this._elevationInfoOverride?(this._elevationContext.setFromElevationInfo(this._elevationInfoOverride),this._elevationContext.updateFeatureExpressionInfoContext(null)):this._context.layer.elevationInfo?(this._elevationContext.setFromElevationInfo(this._context.layer.elevationInfo),this._elevationContext.updateFeatureExpressionInfoContext(this._context.featureExpressionInfoContext)):this._elevationContext.reset()}getDefaultElevationInfo(e){return e.hasZ?this._defaultElevationInfoZ():this._defaultElevationInfoNoZ()}getGeometryElevationMode(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.getDefaultElevationInfo(e);return this._elevationContext.mode||t.mode}setElevationInfoOverride(e){this._elevationInfoOverride=e,this._updateElevationContext()}setGraphicElevationContext(e){var t,i;let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new oi;const n=e.geometry,s=this.getDefaultElevationInfo(n);r.unit=null!=this._elevationContext.unit?this._elevationContext.unit:s.unit,r.mode=this.getGeometryElevationMode(n,s),r.offsetMeters=null!==(t=null!==(i=this._elevationContext.meterUnitOffset)&&void 0!==i?i:s.offset)&&void 0!==t?t:0;const a=!this._elevationOptions.supportsOnTheGround&&"on-the-ground"===r.mode;a&&(r.mode="relative-to-ground",r.offsetMeters=0);const o=a?ni:this._elevationContext.featureExpressionInfoContext;return r.updateFeatureExpressionInfoContext(o,e,this._context.layer),r}prepareSymbolLayerPatch(e){}updateGeometry(e,t){return!1}updateTransform(e,t,i,r){return!1}onRemoveGraphic(e){}_getLayerOpacity(){var e;if(this._context.graphicsCoreOwner&&"fullOpacity"in this._context.graphicsCoreOwner)return null!==(e=this._context.graphicsCoreOwner.fullOpacity)&&void 0!==e?e:0;const t=this._context.layer.opacity;return null!==t&&void 0!==t?t:1}_getCombinedOpacity(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Cs,i=1;return this.draped||(i*=this._getLayerOpacity()),this._drivenProperties.opacity||(null!=e?i*=e.a:t.hasIntrinsicColor||(i=0)),i}_getCombinedOpacityAndColor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Cs;const i=this._getCombinedOpacity(e,t);if(this._drivenProperties.color)return ts(null,i);return ts(null!=e?v.A.toUnitRGB(e):I.Un,i)}_getVertexOpacityAndColor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;const i=ts(this._drivenProperties.color?e.color:null,this._drivenProperties.opacity?e.opacity:null);return t&&(i[0]*=t,i[1]*=t,i[2]*=t,i[3]*=t),i}isFastUpdatesEnabled(){return null!=this._fastUpdates}computeComplexity(){return gn(this.symbol,this.symbolLayer)}globalPropertyChanged(e,t,i){switch(e){case"opacity":return this.layerOpacityChanged(t,i),!0;case"elevationInfo":{const e=this._elevationContext.mode;return this._updateElevationContext(),this.layerElevationInfoChanged(t,i,e)!==Tt.RECREATE}case"slicePlaneEnabled":return this.slicePlaneEnabledChanged(t,i);case"physicalBasedRenderingEnabled":return this.physicalBasedRenderingChanged();case"pixelRatio":return this.pixelRatioChanged;case"skipHighSymbolLods":return this.skipHighSymbolLodsChanged;default:return!1}}get pixelRatioChanged(){return!0}updateGraphics3DGraphicElevationInfo(e,t,i){let r=Tt.UPDATE;return e.forEach((e=>{const n=t(e);if(null!=n){const t=e.graphic;this.setGraphicElevationContext(t,n.elevationContext),n.needsElevationUpdates=i(n.elevationContext.mode)}else r=Tt.RECREATE})),r}applyRendererDiff(e,t){return gs.RecreateSymbol}getFastUpdateAttrValues(e){if(!this._fastUpdates)return null;const t=this._fastUpdates.visualVariables,i=t.size?(0,vs.ul)(t.size.field,e):0,r=t.color?(0,vs.ul)(t.color.field,e):0,n=t.opacity?(0,vs.ul)(t.opacity.field,e):0;return(0,L.fA)(i,r,n,0)}get draped(){return this._draped}ensureDrapedStatus(e){return null==this._draped?(this._draped=e,!0):(e!==this.draped&&ys().warnOnce("A symbol can only produce either draped or non-draped visualizations. Use two separate symbol instances for draped and non-draped graphics if necessary."),!1)}test(){return{drivenProperties:this._drivenProperties,getVisVarFields:()=>{var e,t,i,r,n,s,a,o;return{size:null!==(e=null===(t=this._fastUpdates)||void 0===t||null===(t=t.visualVariables.size)||void 0===t?void 0:t.field)&&void 0!==e?e:null,color:null!==(i=null===(r=this._fastUpdates)||void 0===r||null===(r=r.visualVariables.color)||void 0===r?void 0:r.field)&&void 0!==i?i:null,opacity:null!==(n=null===(s=this._fastUpdates)||void 0===s||null===(s=s.visualVariables.opacity)||void 0===s?void 0:s.field)&&void 0!==n?n:null,rotation:null!==(a=null===(o=this._fastUpdates)||void 0===o||null===(o=o.visualVariables.rotation)||void 0===o?void 0:o.field)&&void 0!==a?a:null}}}}}function xs(e){const t={color:!1,opacity:!1,opacityAlwaysOpaque:!0,size:!1};return e&&"visualVariables"in e&&e.visualVariables&&e.visualVariables.forEach((e=>{switch(e.type){case"color":if(t.color=!0,e.stops)for(let i=0;i<e.stops.length;i++){const r=e.stops[i].color;r&&(t.opacity=!0,r.a<1&&(t.opacityAlwaysOpaque=!1))}break;case"opacity":t.opacity=!0,t.opacityAlwaysOpaque=!1;break;case"size":t.size=!0}})),t}const Ss={mode:"on-the-ground",offset:0,unit:"meters"},ws={mode:"absolute-height",offset:0,unit:"meters"},Cs={hasIntrinsicColor:!1};var As=i(64232),Rs=i(94966),Es=i(73146),Os=i(35416),Ts=i(68967);class Ps extends Es.J{get geometries(){return this._geometries}get transformation(){var e;return null!==(e=this._transformation)&&void 0!==e?e:P.zK}set transformation(e){var t;this._transformation=(0,T.C)(null!==(t=this._transformation)&&void 0!==t?t:(0,P.vt)(),e),this._invalidateBoundingVolume(),this._emit("transformationChanged",this)}get shaderTransformation(){return this._shaderTransformation}set shaderTransformation(e){var t;this._shaderTransformation=e?(0,T.C)(null!==(t=this._shaderTransformation)&&void 0!==t?t:(0,P.vt)(),e):null,this._invalidateBoundingVolume(),this._emit("shaderTransformationChanged",this)}get effectiveTransformation(){var e;return null!==(e=this.shaderTransformation)&&void 0!==e?e:this.transformation}constructor(){var e,t;let i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};super(),this.type=vr.X.Object,this._shaderTransformation=null,this._parentLayer=null,this._visible=!0,this.castShadow=null===(e=i.castShadow)||void 0===e||e,this.usesVerticalDistanceToGround=null!==(t=i.usesVerticalDistanceToGround)&&void 0!==t&&t,this.graphicUid=i.graphicUid,this.layerUid=i.layerUid,i.isElevationSource&&(this.lastValidElevationBB=new Ms),this._geometries=i.geometries?Array.from(i.geometries):new Array}dispose(){this._geometries.length=0}get parentLayer(){return this._parentLayer}set parentLayer(e){(0,br.vA)(null==this._parentLayer||null==e,"Object3D can only be added to a single Layer"),this._parentLayer=e}addGeometry(e){e.visible=this._visible,this._geometries.push(e),this._emit("geometryAdded",{object:this,geometry:e}),this._invalidateBoundingVolume()}removeGeometry(e){const t=this._geometries.splice(e,1)[0];t&&(this._emit("geometryRemoved",{object:this,geometry:t}),this._invalidateBoundingVolume())}removeAllGeometries(){for(;this._geometries.length>0;)this.removeGeometry(0)}geometryVertexAttributeUpdated(e,t){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];this._emit("attributesChanged",{object:this,geometry:e,attribute:t,sync:i}),(0,Pt.b)(t)&&this._invalidateBoundingVolume()}get visible(){return this._visible}set visible(e){if(this._visible!==e){this._visible=e;for(const e of this._geometries)e.visible=this._visible;this._emit("visibilityChanged",this)}}maskOccludee(){const e=new Os.X(fe.Mg.MaskOccludee);for(const t of this._geometries)t.occludees=(0,Ts.Ci)(t.occludees,e);return this._emit("occlusionChanged",this),e}removeOcclude(e){for(const t of this._geometries)t.occludees=(0,Ts.PC)(t.occludees,e);this._emit("occlusionChanged",this)}highlight(){const e=new Os.X(fe.Mg.Highlight);for(const t of this._geometries)t.highlights=(0,Ts.Ci)(t.highlights,e);return this._emit("highlightChanged",this),e}removeHighlight(e){for(const t of this._geometries)t.highlights=(0,Ts.PC)(t.highlights,e);this._emit("highlightChanged",this)}getCombinedStaticTransformation(e,t){return(0,T.lw)(t,this.transformation,e.transformation)}getCombinedShaderTransformation(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:(0,P.vt)();return(0,T.lw)(t,this.effectiveTransformation,e.transformation)}get boundingVolumeWorldSpace(){return this._bvWorldSpace||(this._bvWorldSpace=this._bvWorldSpace||new Is,this._validateBoundingVolume(this._bvWorldSpace,Gs.WorldSpace)),this._bvWorldSpace}get boundingVolumeObjectSpace(){return this._bvObjectSpace||(this._bvObjectSpace=this._bvObjectSpace||new Is,this._validateBoundingVolume(this._bvObjectSpace,Gs.ObjectSpace)),this._bvObjectSpace}_validateBoundingVolume(e,t){const i=t===Gs.ObjectSpace;for(const r of this._geometries){const t=r.boundingInfo;t&&Ds(t,e,i?r.transformation:this.getCombinedShaderTransformation(r))}(0,M.k)((0,$.g)(e.bounds),e.min,e.max,.5);for(const r of this._geometries){const t=r.boundingInfo;if(null==t)continue;const n=i?r.transformation:this.getCombinedShaderTransformation(r),s=(0,Rs.hG)(n);(0,M.e)(Vs,t.center,n);const a=(0,M.p)(Vs,(0,$.g)(e.bounds)),o=t.radius*s;e.bounds[3]=Math.max(e.bounds[3],a+o)}}_invalidateBoundingVolume(){var e;const t=null===(e=this._bvWorldSpace)||void 0===e?void 0:e.bounds;this._bvObjectSpace=this._bvWorldSpace=void 0,this._parentLayer&&t&&this._parentLayer.notifyObjectBBChanged(this,t)}_emit(e,t){this._parentLayer&&this._parentLayer.events.emit(e,t)}get test(){const e=this;return{hasGeometry:t=>e._geometries.includes(t),getGeometryIndex:t=>e._geometries.indexOf(t)}}}class Ms{constructor(){this.min=(0,I.fA)(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this.max=(0,I.fA)(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE)}isEmpty(){return this.max[0]<this.min[0]&&this.max[1]<this.min[1]&&this.max[2]<this.min[2]}}class Is extends Ms{constructor(){super(...arguments),this.bounds=(0,$.d)()}}function Ds(e,t,i){const r=e.bbMin,n=e.bbMax;if((0,T.tZ)(i)){const e=(0,M.s)(Ls,i[12],i[13],i[14]);(0,M.g)(Fs,r,e),(0,M.g)(Ns,n,e);for(let i=0;i<3;++i)t.min[i]=Math.min(t.min[i],Fs[i]),t.max[i]=Math.max(t.max[i],Ns[i])}else if((0,M.e)(Fs,r,i),(0,M.i)(r,n))for(let s=0;s<3;++s)t.min[s]=Math.min(t.min[s],Fs[s]),t.max[s]=Math.max(t.max[s],Fs[s]);else{(0,M.e)(Ns,n,i);for(let e=0;e<3;++e)t.min[e]=Math.min(t.min[e],Fs[e],Ns[e]),t.max[e]=Math.max(t.max[e],Fs[e],Ns[e]);for(let e=0;e<3;++e){(0,M.c)(Fs,r),(0,M.c)(Ns,n),Fs[e]=n[e],Ns[e]=r[e],(0,M.e)(Fs,Fs,i),(0,M.e)(Ns,Ns,i);for(let e=0;e<3;++e)t.min[e]=Math.min(t.min[e],Fs[e],Ns[e]),t.max[e]=Math.max(t.max[e],Fs[e],Ns[e])}}}const Ls=(0,I.vt)(),Fs=(0,I.vt)(),Ns=(0,I.vt)(),Vs=(0,I.vt)();var Gs;function Us(e,t,i,r,n){const s=e.clippingExtent;if((0,As.g)(t,Hs,e.elevationProvider.spatialReference),null!=s&&!(0,q.Uc)(s,Hs))return null;(0,As.g)(t,Hs,e.renderCoordsHelper.spatialReference),i.localOrigin=e.localOriginFactory.getOrigin(Hs);const a=new Ps({geometries:[i],castShadow:!1,layerUid:e.layer.uid,graphicUid:n,usesVerticalDistanceToGround:!0});return{object:a,sampledElevation:Vt(a,t,e.elevationProvider,e.renderCoordsHelper,r)}}function zs(e,t,i){const r=e.elevationContext,n=i.spatialReference;(0,As.g)(t,Hs,n),r.centerPointInElevationSR=(0,ne.T)(Hs[0],Hs[1],t.hasZ?Hs[2]:0,null!=n?n:null)}function Bs(e){switch(e.type){case"point":return e;case"polygon":case"extent":return $n(e);case"polyline":{const t=e.paths[0];if(!t||0===t.length)return null;const i=(0,Xn.$H)(t,(0,Xn.Yl)(t)/2);return(0,ne.T)(i[0],i[1],i[2],e.spatialReference)}case"mesh":return e.origin}return null}!function(e){e[e.WorldSpace=0]="WorldSpace",e[e.ObjectSpace=1]="ObjectSpace"}(Gs||(Gs={}));const Hs=(0,I.vt)();var js=i(59422),Ws=i(48549),ks=i(34981),Zs=i(59696),qs=i(45463),Qs=i(77730),Js=i(52757),Ys=i(16506),Xs=i(42693),$s=i(32119),Ks=i(28584),ea=i(40431),ta=i(57162);class ia extends Xs.w{initializeConfiguration(e,t){t.spherical=e.viewingMode===ae.RT.Global}initializeProgram(e){return new Ks.B(e.rctx,ia.shader.get().build(this.configuration),$s.D)}setPipelineState(e){const t=e?ft.MT.ALWAYS:ft.MT.LESS;return this.configuration.depthHudEnabled?(0,ta.Ey)({depthTest:{func:t},depthWrite:ta.kn}):(0,ta.Ey)({blending:(0,ta.p3)(ft.dn.ONE,ft.dn.SRC_ALPHA,ft.dn.ONE_MINUS_SRC_ALPHA,ft.dn.ONE_MINUS_SRC_ALPHA),depthTest:{func:t},colorWrite:ta.wE})}initializePipeline(){return this.setPipelineState(this.configuration.multipassEnabled)}}ia.shader=new Ys.$(ea.L,(()=>i.e(9873).then(i.bind(i,99873))));var ra=i(99415),na=i(92656);class sa extends na.E{constructor(){super(...arguments),this.screenCenterOffsetUnitsEnabled=!1,this.spherical=!1,this.occlusionTestEnabled=!0,this.hasVerticalOffset=!1,this.hasScreenSizePerspective=!1,this.depthHudEnabled=!1,this.depthHudAlignStartEnabled=!1,this.hasSlicePlane=!1,this.multipassEnabled=!1}}(0,r._)([(0,ra.W)()],sa.prototype,"screenCenterOffsetUnitsEnabled",void 0),(0,r._)([(0,ra.W)()],sa.prototype,"spherical",void 0),(0,r._)([(0,ra.W)()],sa.prototype,"occlusionTestEnabled",void 0),(0,r._)([(0,ra.W)()],sa.prototype,"hasVerticalOffset",void 0),(0,r._)([(0,ra.W)()],sa.prototype,"hasScreenSizePerspective",void 0),(0,r._)([(0,ra.W)()],sa.prototype,"depthHudEnabled",void 0),(0,r._)([(0,ra.W)()],sa.prototype,"depthHudAlignStartEnabled",void 0),(0,r._)([(0,ra.W)()],sa.prototype,"hasSlicePlane",void 0),(0,r._)([(0,ra.W)()],sa.prototype,"multipassEnabled",void 0),(0,r._)([(0,ra.W)({constValue:!0})],sa.prototype,"hasSliceInVertexProgram",void 0),(0,r._)([(0,ra.W)({constValue:!1})],sa.prototype,"draped",void 0);class aa extends qs.im{get uniqueMaterialIdentifier(){return this._uniqueMaterialIdentifier}constructor(e){super(e,new la),this.produces=new Map([[Qs.N.LINE_CALLOUTS,e=>e===ks.V.Color],[Qs.N.LINE_CALLOUTS_HUD_DEPTH,e=>e===ks.V.Color]]),this._configuration=new sa,this._uniqueMaterialIdentifier=aa.uniqueMaterialIdentifier(this.parameters)}passParameters(){return this.parameters}getConfiguration(e,t){const i=(null===t||void 0===t?void 0:t.slot)!==Qs.N.LINE_CALLOUTS;return this._configuration.occlusionTestEnabled=this.parameters.occlusionTest,this._configuration.hasVerticalOffset=null!=this.parameters.verticalOffset,this._configuration.hasScreenSizePerspective=null!=this.parameters.screenSizePerspective,this._configuration.depthHudEnabled=i,this._configuration.depthHudAlignStartEnabled=!!this.parameters.depthHUDAlignStart,this._configuration.screenCenterOffsetUnitsEnabled="screen"===this.parameters.centerOffsetUnits,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.multipassEnabled=t.multipassEnabled,this._configuration}intersect(){}createGLMaterial(e){return new oa(e)}createBufferWriter(){return new ha}validateParameters(e){const t=aa.uniqueMaterialIdentifier(e);t!==this._uniqueMaterialIdentifier&&(this._uniqueMaterialIdentifier=t)}static uniqueMaterialIdentifier(e){var t;return JSON.stringify({horizontalScreenOffset:null!==(t=e.horizontalScreenOffset)&&void 0!==t?t:0,centerOffsetUnits:e.centerOffsetUnits||"world"})}}class oa extends Zs.A{beginSlot(e){return this.ensureTechnique(ia,e)}}class la extends qs.qA{constructor(){super(...arguments),this.horizontalScreenOffset=0,this.color=[0,0,0,1],this.size=1,this.occlusionTest=!1,this.shaderPolygonOffset=1e-5,this.depthHUDAlignStart=!1,this.centerOffsetUnits="world",this.hasSlicePlane=!1}}const ca=(0,Ws.BP)().vec3f(Pt.r.POSITION).vec3f(Pt.r.NORMAL).vec2f(Pt.r.UV0).vec4f(Pt.r.CENTEROFFSETANDDISTANCE),da=[(0,js.fA)(0,0),(0,js.fA)(1,0),(0,js.fA)(0,1),(0,js.fA)(1,0),(0,js.fA)(1,1),(0,js.fA)(0,1)];class ha{constructor(){this.vertexBufferLayout=ca}elementCount(e){return 6*e.attributes.get(Pt.r.POSITION).indices.length}write(e,t,i,r,n){(0,Js.Hk)(i.attributes.get(Pt.r.POSITION),e,r.position,n,6),(0,Js.p1)(i.attributes.get(Pt.r.NORMAL),t,r.normal,n,6),(0,Js.Ut)(i.attributes.get(Pt.r.CENTEROFFSETANDDISTANCE),r.centerOffsetAndDistance,n,6);for(let s=0;s<da.length;++s)r.uv0.setVec(n+s,da[s])}}class ua extends bs{constructor(e,t){super(e,null,t,ga),this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!1},this.ensureDrapedStatus(!1)}async doLoad(){this._materials[0]=new aa(this._materialParameters),this._context.stage.add(this._materials[0])}destroy(){super.destroy(),this._context.stage.remove(this._materials[0]),this._materials.length=0}_perInstanceMaterialParameters(e){var t;const i=this._materialParameters;return i.horizontalScreenOffset=null!==(t=e.horizontalScreenOffset)&&void 0!==t?t:0,i.centerOffsetUnits=e.centerOffsetUnits||"world",i}get _materialParameters(){var e;const t=new la,i=this.symbol,r=i.callout;if(t.color=null!=r.color?v.A.toUnitRGBA(r.color):[0,0,0,0],t.color[3]*=this._getLayerOpacity(),t.size=(0,Ln.Lz)(r.size||0),i.verticalOffset){const{screenLength:e,minWorldLength:r,maxWorldLength:n}=i.verticalOffset;t.verticalOffset={screenLength:(0,Ln.Lz)(e),minWorldLength:r||0,maxWorldLength:null!=n?n:1/0}}t.borderColor=null!=(null===(e=r.border)||void 0===e?void 0:e.color)?v.A.toUnitRGBA(r.border.color):null;const n="object"===i.symbolLayers.at(0).type,s="label-3d"===i.type;return t.occlusionTest=!n,t.shaderPolygonOffset=n?0:void 0,t.depthHUDAlignStart=s,t.hasSlicePlane=this._context.slicePlaneEnabled,t.screenSizePerspective=this._context.screenSizePerspectiveEnabled?this._context.sharedResources.screenSizePerspectiveSettings:null,t}_defaultElevationInfoNoZ(){return fa}createGraphics3DGraphic(e){const t=e.renderingInfo,i=e.graphic,r=this.setGraphicElevationContext(i,new oi,t.elevationOffset||0),n=t.symbol,s="on-the-ground"===this._elevationContext.mode&&("cim"===n.type||!n.symbolLayers.some((e=>"object"===e.type||"text"===e.type)));if("label-3d"!==n.type&&s)return null;if("point-3d"===n.type&&n.symbolLayers.every((e=>"text"===e.type&&!(0,Dn.Ie)(e))))return null;const a=$n(i.geometry);return null==a?null:this._createAs3DShape(a,r,t,i.uid)}layerOpacityChanged(){var e;null===(e=this._materials[0])||void 0===e||e.setParameters(this._materialParameters)}layerElevationInfoChanged(e,t,i){const r=this._elevationContext.mode,n=Lt(ua.elevationModeChangeTypes,i,r);return n!==Tt.UPDATE||e.forEach((e=>{const i=t(e);null!=i&&this.updateGraphicElevationContext(e.graphic,i)})),n}slicePlaneEnabledChanged(){var e;return null!==(e=this._materials[0])&&void 0!==e&&e.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return!0}setGraphicElevationContext(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return super.setGraphicElevationContext(e,t),t.addOffsetRenderUnits(i),t}updateGraphicElevationContext(e,t){this.setGraphicElevationContext(e,t.elevationContext,null!=t.metadata?t.metadata.elevationOffset:0),t.needsElevationUpdates=Ft(t.elevationContext.mode)}computeComplexity(){return new sn({verticesPerFeature:6})}_createVertexData(e){const{translation:t,centerOffset:i}=e,r=new _r.n(t?[t[0],t[1],t[2]]:[0,0,0],pa,3,!0),n=new _r.n(i?[i[0],i[1],i[2],i[3]]:[0,0,0,1],pa,4,!0);return[[Pt.r.POSITION,r],[Pt.r.NORMAL,new _r.n([0,0,1],pa,3,!0)],[Pt.r.CENTEROFFSETANDDISTANCE,n]]}_getOrCreateMaterial(e){var t;const i=this._perInstanceMaterialParameters(e),r=aa.uniqueMaterialIdentifier(i);if(r===(null===(t=this._materials[0])||void 0===t?void 0:t.uniqueMaterialIdentifier))return{material:this._materials[0],isUnique:!1};if(null!=e.materialCollection){let t=e.materialCollection.get(r);return null==t&&(t=new aa(i),e.materialCollection.add(r,t)),{material:t,isUnique:!1}}return{material:new aa(i),isUnique:!0}}_createAs3DShape(e,t,i,r){const n=this._context.layer.uid,s=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:r,layerUid:n}),a=this._getOrCreateMaterial(i),o=new yr.V(a.material,this._createVertexData(i),null,vr.X.Point,s),l=Us(this._context,e,o,t,r);if(null==l)return null;const c=new ls(this,l.object,[o],a.isUnique?[a.material]:null,null,Gn,t);return c.metadata=new fs(i.elevationOffset),c.alignedSampledElevation=l.sampledElevation,c.needsElevationUpdates=Ft(t.mode),zs(c,e,this._context.elevationProvider),c}}ua.elevationModeChangeTypes={definedChanged:Tt.UPDATE,staysOnTheGround:Tt.UPDATE,onTheGroundChanged:Tt.RECREATE};const pa=[0],fa={mode:"relative-to-ground",offset:0},ga={ignoreDrivers:!0,renderPriority:0,renderPriorityStep:1};class ma{constructor(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:(0,I.vt)(),r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:(0,L.vt)(),n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:"world",a=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,o=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null;this.renderer=e,this.symbol=t,this.translation=i,this.centerOffset=r,this.horizontalScreenOffset=n,this.centerOffsetUnits=s,this.elevationOffset=a,this.materialCollection=o}}const _a=()=>a.A.getLogger("esri.views.3d.layers.graphics.Graphics3DCalloutSymbolLayerFactory");function va(e,t){if(!(0,Dn.YX)(e))return _a().error("Graphics3DCalloutSymbolLayerFactory#make","symbol of type '".concat(e.type,"' does not support callouts")),null;if(!e.callout)return null;const i=ya[e.callout.type];return i?new i(e,t):(_a().error("Graphics3DCalloutSymbolLayerFactory#make","unknown or unsupported callout type ".concat(e.callout.type)),null)}const ya={line:ua};var ba=i(21499),xa=i(3789),Sa=i(19555),wa=i(65215),Ca=i(98618);const Aa=new xa.A(Array,(e=>(0,q.hZ)(e,q.v_)),null,10,5),Ra=(0,Q.vt)();class Ea{get labelLayers(){return this._labelLayers||b.tR}get extent(){return this._extent}get isElevationSource(){return this.layers.some((e=>null===e||void 0===e?void 0:e.isElevationSource))}constructor(e,t,i,r,n){this.graphic=e,this.graphics3DSymbol=t,this.layers=i,this._visibleFlags=xn.ALL_LABEL,this.deconflictionPriority=0,++t.referenced,this._featureExpressionFeature=n?ti(n,e,r):null}initialize(e){this._layer=e,this._forEachSymbolLayerGraphic((t=>{t.initialize(e),t.setVisibility(this.isVisible())}))}destroy(){this._forEachSymbolLayerGraphic((e=>e.destroy())),this._calloutLayer=null,--this.graphics3DSymbol.referenced,this.graphics3DSymbol=null}get destroyed(){return null==this.layers}clearLabelGraphics(){this._forEachLabelGraphic((e=>e.destroy())),this._labelLayers=null}addLabelGraphic(e,t){this._labelLayers||(this._labelLayers=new Array),this._labelLayers.push(e),e.initialize(t),e.setVisibility(this.isVisible(Sn.LABEL))}setCalloutGraphic(e){this._calloutLayer=e,this._layer&&(e.initialize(this._layer),e.setVisibility(this.isVisible()))}get calloutLayer(){return this._calloutLayer}get isDraped(){let e=!1;return this._forEachSymbolLayerGraphic((t=>{"draped"===t.type&&(e=!0)})),e}isVisible(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Sn.GRAPHIC,t=arguments.length>1?arguments[1]:void 0;const i=t?this._visibleFlags|t|Sn.LABEL*t:this._visibleFlags;return e===Sn.GRAPHIC?(i&xn.ALL_GRAPHIC)===xn.ALL_GRAPHIC:(i&xn.ALL_LABEL)===xn.ALL_LABEL}setVisibilityFlag(e,t,i){const r=this.isVisible(e);i?this._visibleFlags|=e*t:this._visibleFlags&=~(e*t);const n=this.isVisible(e);if(r===n)return!1;if(e===Sn.LABEL)this._forEachLabelGraphic((e=>e.setVisibility(n)));else{this._forEachSymbolLayerGraphic((e=>e.setVisibility(n)));const e=this.isVisible(Sn.LABEL);this._forEachLabelGraphic((t=>t.setVisibility(e)))}return!0}getVisibilityFlag(e,t){return 0!=(this._visibleFlags&e*t)}computeExtent(e){if(!this._extent){const t=this.graphic.geometry;if(null==t)return!1;this._extent=(0,Q.vt)(),(0,ji.iQ)(t,this._extent);const i=t.spatialReference;if(!(0,G.aI)(i,e)&&!ee(this._extent,i,this._extent,e))return this._extent=null,!1}return!0}getAsOptimizedGeometry(e,t){return this._optimizedGeometry||(this._optimizedGeometry=this._convertGraphicToOptimizedGeometry(this.graphic,e,t)),this._optimizedGeometry}_convertGraphicToOptimizedGeometry(e,t,i){let r=e.geometry;return"mesh"!==r.type&&"extent"!==r.type||(r=wa.A.fromExtent("mesh"===r.type?r.extent:r)),(0,Ca.Ux)(r,t,i)}get usedMemory(){let e=(0,ba.eY)(this.graphic.attributes);return this._forEachSymbolLayerGraphic((t=>e+=t.graphics3DSymbolLayer.usedMemory)),e}computeAttachmentOrigin(){const e={render:{origin:(0,I.vt)(),num:0},draped:{origin:(0,pr.vt)(),num:0}};for(const t of this.layers)null!=t&&t.computeAttachmentOrigin(e);return e.render.num>1&&(0,M.h)(e.render.origin,e.render.origin,1/e.render.num),e.draped.num>1&&(0,Sa.hs)(e.draped.origin,e.draped.origin,1/e.draped.num),e}async getProjectedBoundingBox(e,t,i,r,n){return n||(n={boundingBox:null,requiresDrapedElevation:!1,screenSpaceObjects:[]}),n.boundingBox?(0,q.Ie)(n.boundingBox):n.boundingBox=(0,q.Ie)(),n.requiresDrapedElevation=!1,await(0,ot.jJ)(this.layers,(async s=>{if(null==s)return;const a="draped"===s.type?t:e,o=Aa.acquire(),l=await s.getProjectedBoundingBox(a,i,n.screenSpaceObjects,r,o);isFinite(l[2])&&isFinite(l[5])||(n.requiresDrapedElevation=!0),l&&(0,q.RF)(n.boundingBox,o),Aa.release(o)})),(0,q.vQ)(n.boundingBox)||(0,Q.vQ)((0,q.ES)(n.boundingBox,Ra))?n:null}needsElevationUpdates(){var e,t;for(const i of this.layers)if(null!=i&&("object3d"===i.type||"lod-instance"===i.type)&&i.needsElevationUpdates)return!0;return null!==(e=null===(t=this._labelLayers)||void 0===t?void 0:t.some((e=>{var t;return null!==(t=null===e||void 0===e?void 0:e.needsElevationUpdates)&&void 0!==t&&t})))&&void 0!==e&&e}alignWithElevation(e,t,i){this._forEachRenderedGraphic((r=>{"object3d"!==r.type&&"lod-instance"!==r.type||r.alignWithElevation(e,t,this._featureExpressionFeature,i)}))}alignWithAbsoluteElevation(e,t,i){this._forEachRenderedGraphic((r=>{"object3d"===r.type&&r.alignWithAbsoluteElevation(e,t,i)}))}addObjectStateSet(e,t){this._forEachSymbolLayerGraphic((i=>i.addObjectState(e,t)))}removeObjectState(e){this._forEachSymbolLayerGraphic((t=>t.removeObjectState(e)))}_forEachGraphicList(e,t){null===e||void 0===e||e.forEach((e=>e&&t(e)))}_forEachSymbolLayerGraphic(e){this._forEachGraphicList(this.layers,e),this._calloutLayer&&e(this._calloutLayer)}_forEachLabelGraphic(e){this._forEachGraphicList(this._labelLayers,e)}_forEachRenderedGraphic(e){this._forEachSymbolLayerGraphic(e),this._forEachLabelGraphic(e)}get test(){const e=this;return{addLabelLayer:t=>{e._labelLayers||(e._labelLayers=new Array),e._labelLayers.push(t)}}}}var Oa=i(38983),Ta=i(45136),Pa=i(59883);function Ma(e,t){if(!e||e.symbol)return null;const i=null===t||void 0===t?void 0:t.renderer;return e&&null!=i&&i.getObservationRenderer?i.getObservationRenderer(e):i}function Ia(e,t){var i;const r=Ma(e,t),n=function(e,t){if(null!=e.symbol)return e.symbol;const i=Ma(e,t);return null!=i&&"dot-density"!==i.type?i.getSymbol(e,t):null}(e,t);if(null==n)return null;const s={renderer:r,symbol:n};if(null==r||!("visualVariables"in r)||!r.visualVariables)return s;const a=null!==(i=(0,Li.getVisualVariableValues)(r,e,t))&&void 0!==i?i:[],o=["proportional","proportional","proportional"];for(const{variable:l,value:c}of a)switch(l.type){case"color":s.color=c.toRgba();break;case"size":if("outline"===l.target)s.outlineSize=c;else{const e=l.axis,t=l.useSymbolValue?"symbol-value":c;switch(e){case"width":o[0]=t;break;case"depth":o[1]=t;break;case"height":o[2]=t;break;case"width-and-depth":o[0]=o[1]=t;break;default:o[0]=o[1]=o[2]=t}}break;case"opacity":s.opacity=c;break;case"rotation":switch(l.axis){case"tilt":s.tilt=c;break;case"roll":s.roll=c;break;default:s.heading=c}}return"proportional"===o[0]&&"proportional"===o[1]&&"proportional"===o[2]||(s.size=o),s}async function Da(e,t){var i;const r=Ma(e,t),n=await async function(e,t){if(null!=e.symbol)return e.symbol;const i=Ma(e,t);return null!=i?i.getSymbolAsync(e,t):null}(e,t);if(!n)return null;const s={renderer:r,symbol:n};if(!r||!("visualVariables"in r)||!r.visualVariables)return s;const a=null!==(i=(0,Li.getVisualVariableValues)(r,e,t))&&void 0!==i?i:[],o=["proportional","proportional","proportional"];for(const{variable:l,value:c}of a)if("color"===l.type)s.color=v.A.toUnitRGBA(c);else if("size"===l.type)if("outline"===l.target)s.outlineSize=c;else{const e=l.axis,t=l.useSymbolValue?"symbol-value":c;"width"===e?o[0]=t:"depth"===e?o[1]=t:"height"===e?o[2]=t:o[0]=o[1]="width-and-depth"===e?t:o[2]=t}else"opacity"===l.type?s.opacity=c:"rotation"===l.type&&"tilt"===l.axis?s.tilt=c:"rotation"===l.type&&"roll"===l.axis?s.roll=c:"rotation"===l.type&&(s.heading=c);return(isFinite(o[0])||isFinite(o[1])||isFinite(o[2]))&&(s.size=o),s}var La,Fa,Na,Va=i(91217),Ga=i(99785),Ua=i(41289);!function(e){e[e.RasterImage=0]="RasterImage",e[e.Features=1]="Features"}(La||(La={})),function(e){e[e.MapLayer=0]="MapLayer",e[e.ViewLayer=1]="ViewLayer",e[e.Outline=2]="Outline",e[e.SnappingHint=3]="SnappingHint"}(Fa||(Fa={})),function(e){e[e.WithRasterImage=0]="WithRasterImage",e[e.WithoutRasterImage=1]="WithoutRasterImage"}(Na||(Na={}));var za,Ba=i(19539);class Ha{constructor(e,t){this.vec3=e,this.id=t}}function ja(e,t,i,r){return new Ha((0,I.fA)(e,t,i),r)}class Wa{constructor(){this._extent=(0,Q.vt)(),this.resolution=0,this.renderLocalOrigin=ja(0,0,0,"O"),this.pixelRatio=1,this.mapUnitsPerPixel=1,this.canvasGeometries=new ka}get extent(){return this._extent}setupGeometryViewsCyclical(e){this.setupGeometryViewsDirect();const t=.001*e.range;if(this._extent[0]-t<=e.min){const t=this.canvasGeometries.extents[this.canvasGeometries.numViews++];(0,Q.cY)(this._extent,e.range,0,t)}if(this._extent[2]+t>=e.max){const t=this.canvasGeometries.extents[this.canvasGeometries.numViews++];(0,Q.cY)(this._extent,-e.range,0,t)}}setupGeometryViewsDirect(){this.canvasGeometries.numViews=1,(0,Q.C)(this.canvasGeometries.extents[0],this._extent)}hasSomeSizedView(){for(let e=0;e<this.canvasGeometries.numViews;e++){const t=this.canvasGeometries.extents[e];if(t[0]!==t[2]&&t[1]!==t[3])return!0}return!1}}class ka{constructor(){this.extents=[(0,Q.vt)(),(0,Q.vt)(),(0,Q.vt)()],this.numViews=0}}!function(e){e[e.Color=0]="Color",e[e.ColorNoRasterImage=1]="ColorNoRasterImage",e[e.Highlight=2]="Highlight",e[e.WaterNormal=3]="WaterNormal",e[e.Occluded=4]="Occluded",e[e.ObjectAndLayerIdColor=5]="ObjectAndLayerIdColor"}(za||(za={}));class Za{constructor(e,t,i){this._fbos=e,this._format=t,this._name=i}get valid(){var e;return null!=(null===(e=this._handle)||void 0===e?void 0:e.getTexture())}dispose(){this._handle=(0,le.Gz)(this._handle)}get texture(){var e;return null===(e=this._handle)||void 0===e?void 0:e.getTexture()}bind(e,t,i){var r,n,s;this._handle&&this._handle.fbo.width===t&&this._handle.fbo.height===i||(null!==(r=this._handle)&&void 0!==r&&r.release(),this._handle=this._fbos.acquire(t,i,this._name,this._format)),e.unbindTexture(null===(n=this._handle)||void 0===n?void 0:n.fbo.colorTexture),e.bindFramebuffer(null===(s=this._handle)||void 0===s?void 0:s.fbo)}generateMipMap(){var e,t;(null===(e=this._handle)||void 0===e||null===(e=e.getTexture())||void 0===e||null===(e=e.descriptor)||void 0===e?void 0:e.hasMipmap)&&(null===(t=this._handle)||void 0===t||null===(t=t.getTexture())||void 0===t||t.generateMipmap())}}var qa=i(16455);class Qa{constructor(e,t,i,r){let n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:qa.N.RGBA_MIPMAP;this.output=i,this.content=r,this.fbo=new Za(e,n,t)}get valid(){return this.fbo.valid}}class Ja{constructor(e){this.targets=[new Qa(e,"overlay color",ks.V.Color,za.Color),new Qa(e,"overlay IM color",ks.V.Color,za.ColorNoRasterImage),new Qa(e,"overlay highlight",ks.V.Highlight,za.Highlight,qa.N.RGBA4),new Qa(e,"overlay water",ks.V.Normal,za.WaterNormal),new Qa(e,"overlay occluded",ks.V.Color,za.Occluded)],(0,h.A)("enable-feature:objectAndLayerId-rendering")&&this.targets.push(new Qa(e,"overlay oid",ks.V.ObjectAndLayerIdColor,za.ObjectAndLayerIdColor))}getTexture(e){var t;return null===(t=this.targets[e])||void 0===t?void 0:t.fbo.texture}dispose(){for(const e of this.targets)e.fbo.dispose()}computeValidity(){return this.targets.reduce(((e,t,i)=>t.valid?e|=1<<i:e),0)}}var Ya,Xa=i(55386);Xa.Zo;!function(e){e[e.Material=0]="Material",e[e.ShadowMap=1]="ShadowMap",e[e.Highlight=2]="Highlight"}(Ya||(Ya={}));i(43557);var $a=i(26719),Ka=(i(92176),i(7223));i(24245);Ka.n;i(21390);var eo,to=i(64839);i(70367);!function(e){e[e.Disabled=0]="Disabled",e[e.Enabled=1]="Enabled",e[e.EnabledWithWater=2]="EnabledWithWater",e[e.COUNT=3]="COUNT"}(eo||(eo={}));Ka.n;(0,L.vt)();var io=i(53070),ro=i(75941);class no{constructor(e){this._context=e,this._perConstructorInstances=new ro.O,this._frameCounter=0,this._keepAliveFrameCount=ao}get viewingMode(){return this._context.viewingMode}get constructionContext(){return this._context}destroy(){this._perConstructorInstances.forEach((e=>e.forEach((e=>e.technique.destroy())))),this._perConstructorInstances.clear()}acquire(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:oo;const i=t.key;let r=this._perConstructorInstances.get(e,i);if(null==r){const n=new e(this._context,t,(()=>this.release(n)));r=new so(n),this._perConstructorInstances.set(e,i,r)}return++r.refCount,r.technique}releaseAndAcquire(e,t,i){if(null!=i){if(t.key===i.key)return i;this.release(i)}return this.acquire(e,t)}release(e){if(null==e||this._perConstructorInstances.empty)return;const t=this._perConstructorInstances.get(e.constructor,e.key);null!=t&&(--t.refCount,0===t.refCount&&(t.refZeroFrame=this._frameCounter))}frameUpdate(){this._frameCounter++,this._keepAliveFrameCount!==ao&&this._perConstructorInstances.forEach(((e,t)=>{e.forEach(((e,i)=>{0===e.refCount&&e.refZeroFrame+this._keepAliveFrameCount<this._frameCounter&&(e.technique.destroy(),this._perConstructorInstances.delete(t,i))}))}))}async reloadAll(){const e=new Array;this._perConstructorInstances.forEach(((t,i)=>{e.push((async(e,t)=>{const i=t.shader;i&&(await i.reload(),e.forEach((e=>e.technique.reload(this._context))))})(t,i))})),await Promise.all(e)}}class so{constructor(e){this.technique=e,this.refCount=0,this.refZeroFrame=0}}const ao=-1,oo=new ra.K;var lo,co=i(60586),ho=i(96190);let uo=lo=class extends s.A{constructor(e){super(e),this._ray=(0,mr.vt)(),this._viewport=(0,L.fA)(0,0,1,1),this._padding=(0,L.fA)(0,0,0,0),this._fov=55/180*Math.PI,this._nearFar=(0,pr.fA)(1,1e3),this._viewDirty=!0,this._viewMatrix=(0,P.vt)(),this._viewProjectionDirty=!0,this._viewProjectionMatrix=(0,P.vt)(),this._viewInverseTransposeMatrixDirty=!0,this._viewInverseTransposeMatrix=(0,P.vt)(),this._frustumDirty=!0,this._frustum=(0,wt.vt)(),this._fullViewport=(0,L.vt)(),this._pixelRatio=1,this.row=0,this.column=0,this._rows=1,this._columns=1,this._center=(0,I.vt)(),this._up=(0,I.vt)(),this.relativeElevation=0}get pixelRatio(){return this._pixelRatio}set pixelRatio(e){this._pixelRatio=e>0?e:1}get rows(){return this._rows}set rows(e){this._rows=Math.max(1,e)}get columns(){return this._columns}set columns(e){this._columns=Math.max(1,e)}get eye(){return this._ray.origin}set eye(e){this._compareAndSetView(e,this._ray.origin)}get center(){return this._center}set center(e){this._compareAndSetView(e,this._center,"_center")}get ray(){return(0,M.f)(this._ray.direction,this.center,this.eye),this._ray}get up(){return this._up}set up(e){this._compareAndSetView(e,this._up,"_up")}get viewMatrix(){return this._ensureViewClean(),this._viewMatrix}set viewMatrix(e){(0,T.C)(this._viewMatrix,e),this.notifyChange("_viewMatrix"),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}get viewForward(){return this._ensureViewClean(),(0,M.s)((0,I.vt)(),-this._viewMatrix[2],-this._viewMatrix[6],-this._viewMatrix[10])}get viewUp(){return this._ensureViewClean(),(0,M.s)((0,I.vt)(),this._viewMatrix[1],this._viewMatrix[5],this._viewMatrix[9])}get viewRight(){return this._ensureViewClean(),(0,M.s)((0,I.vt)(),this._viewMatrix[0],this._viewMatrix[4],this._viewMatrix[8])}get nearFar(){return this._nearFar}get near(){return this._nearFar[0]}set near(e){this._nearFar[0]!==e&&(this._nearFar[0]=e,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_nearFar"))}get far(){return this._nearFar[1]}set far(e){this._nearFar[1]!==e&&(this._nearFar[1]=e,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_nearFar"))}get viewport(){return this._viewport}set viewport(e){this.x=e[0],this.y=e[1],this.width=e[2],this.height=e[3]}get screenViewport(){if(1===this.pixelRatio)return this._viewport;const e=(0,D.d)((0,L.vt)(),this._viewport,1/this.pixelRatio),t=this._get("screenViewport");return t&&(0,D.e)(e,t)?t:e}get screenPadding(){if(1===this.pixelRatio)return this._padding;const e=(0,D.d)((0,L.vt)(),this._padding,1/this.pixelRatio),t=this._get("screenPadding");return t&&(0,D.e)(e,t)?t:e}get x(){return this._viewport[0]}set x(e){e+=this._padding[vo.LEFT],this._viewport[0]!==e&&(this._viewport[0]=e,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get y(){return this._viewport[1]}set y(e){e+=this._padding[vo.BOTTOM],this._viewport[1]!==e&&(this._viewport[1]=e,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get width(){return this._viewport[2]}set width(e){this._viewport[2]!==e&&(this._viewport[2]=e,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get height(){return this._viewport[3]}set height(e){this._viewport[3]!==e&&(this._viewport[3]=e,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get fullWidth(){return this._viewport[2]+this._padding[vo.RIGHT]+this._padding[vo.LEFT]}set fullWidth(e){this.width=e-(this._padding[vo.RIGHT]+this._padding[vo.LEFT])}get fullHeight(){return this._viewport[3]+this._padding[vo.TOP]+this._padding[vo.BOTTOM]}set fullHeight(e){this.height=e-(this._padding[vo.TOP]+this._padding[vo.BOTTOM])}get fullViewport(){return this._fullViewport[0]=this._viewport[0]-this._padding[vo.LEFT],this._fullViewport[1]=this._viewport[1]-this._padding[vo.BOTTOM],this._fullViewport[2]=this.fullWidth,this._fullViewport[3]=this.fullHeight,this._fullViewport}get _aspect(){return this.width/this.height}get padding(){return this._padding}set padding(e){(0,D.a)(this._padding,e)||(this._viewport[0]+=e[vo.LEFT]-this._padding[vo.LEFT],this._viewport[1]+=e[vo.BOTTOM]-this._padding[vo.BOTTOM],this._viewport[2]-=e[vo.RIGHT]+e[vo.LEFT]-(this._padding[vo.RIGHT]+this._padding[vo.LEFT]),this._viewport[3]-=e[vo.TOP]+e[vo.BOTTOM]-(this._padding[vo.TOP]+this._padding[vo.BOTTOM]),(0,D.c)(this._padding,e),this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_padding"),this.notifyChange("_viewport"))}get viewProjectionMatrix(){return this._viewProjectionDirty&&((0,T.lw)(this._viewProjectionMatrix,this.projectionMatrix,this.viewMatrix),this._viewProjectionDirty=!1),this._viewProjectionMatrix}get projectionMatrix(){const e=this.width,t=this.height,i=this.near*Math.tan(this.fovY/2)*2,r=i*this._aspect,n=i/this.rows,s=r/this.columns,a=-r/2+this.column*s,o=a+s,l=-i/2+this.row*n,c=l+n,d=(0,T.$h)((0,P.vt)(),a*(1+2*this._padding[vo.LEFT]/e),o*(1+2*this._padding[vo.RIGHT]/e),l*(1+2*this._padding[vo.BOTTOM]/t),c*(1+2*this._padding[vo.TOP]/t),this.near,this.far),h=this._get("projectionMatrix");return h&&(0,T.aI)(h,d)?h:d}get inverseProjectionMatrix(){return(0,T.B8)((0,P.vt)(),this.projectionMatrix)||this._get("inverseProjectionMatrix")||(0,P.vt)()}get fov(){return this._fov}set fov(e){this._fov=e,this._viewProjectionDirty=!0,this._frustumDirty=!0}get fovX(){return function(e,t,i){return 2*Math.atan(t*Math.tan(.5*e)/Math.sqrt(t*t+i*i))}(this._fov,this.width,this.height)}set fovX(e){this._fov=function(e,t,i){return 2*Math.atan(Math.sqrt(t*t+i*i)*Math.tan(.5*e)/t)}(e,this.width,this.height),this._viewProjectionDirty=!0,this._frustumDirty=!0}get fovY(){return function(e,t,i){return 2*Math.atan(i*Math.tan(.5*e)/Math.sqrt(t*t+i*i))}(this._fov,this.width,this.height)}set fovY(e){this._fov=function(e,t,i){return 2*Math.atan(Math.sqrt(t*t+i*i)*Math.tan(.5*e)/i)}(e,this.width,this.height),this._viewProjectionDirty=!0,this._frustumDirty=!0}get distance(){return(0,M.p)(this.center,this.eye)}get frustum(){return this._recomputeFrustum(),this._frustum}get viewInverseTransposeMatrix(){return(this._viewInverseTransposeMatrixDirty||this._viewDirty)&&((0,T.B8)(this._viewInverseTransposeMatrix,this.viewMatrix),(0,T.mg)(this._viewInverseTransposeMatrix,this._viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),this._viewInverseTransposeMatrix}depthNDCToWorld(e){const t=2*e-1;return 2*this.near*this.far/(this.far+this.near-t*(this.far-this.near))}get perRenderPixelRatio(){return Math.tan(this.fovX/2)/(this.width/2)}get perScreenPixelRatio(){return this.perRenderPixelRatio*this.pixelRatio}get aboveGround(){return null!=this.relativeElevation&&this.relativeElevation>=0}copyFrom(e){(0,M.c)(this._ray.origin,e.eye),this.center=e.center,this.up=e.up,(0,D.c)(this._viewport,e.viewport),this.notifyChange("_viewport"),(0,D.c)(this._padding,e.padding),this.notifyChange("_padding"),(0,Sa.C)(this._nearFar,e.nearFar),this.notifyChange("_nearFar"),this._fov=e.fov,this.row=e.row,this.column=e.column,this.rows=e.rows,this.columns=e.columns,this.relativeElevation=e.relativeElevation;const t=e;return this._viewDirty=t._viewDirty,this._viewDirty||((0,T.C)(this._viewMatrix,e.viewMatrix),this.notifyChange("_viewMatrix")),this._viewProjectionDirty=!0,this._frustumDirty=t._frustumDirty,this._frustumDirty||((0,wt.C)(this._frustum,e.frustum),this._frustumDirty=!1),t._viewInverseTransposeMatrixDirty?this._viewInverseTransposeMatrixDirty=!0:((0,T.C)(this._viewInverseTransposeMatrix,e.viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),(0,D.c)(this._fullViewport,e.fullViewport),this.pixelRatio=e.pixelRatio,this}copyViewFrom(e){this.eye=e.eye,this.center=e.center,this.up=e.up}clone(){return(new lo).copyFrom(this)}equals(e){return(0,M.i)(this.eye,e.eye)&&(0,M.i)(this.center,e.center)&&(0,M.i)(this.up,e.up)&&(0,D.a)(this._viewport,e.viewport)&&(0,D.a)(this._padding,e.padding)&&(0,Sa.t2)(this.nearFar,e.nearFar)&&this._fov===e.fov&&this.pixelRatio===e.pixelRatio&&this.relativeElevation===e.relativeElevation&&this.row===e.row&&this.column===e.column&&this.rows===e.rows&&this.columns===e.columns}almostEquals(e){const t=Math.max(1,1/this.pixelRatio,1/e.pixelRatio);if(Math.abs(e.fov-this._fov)>=.001||(0,D.f)(e.screenPadding,this.screenPadding)>=t||(0,D.f)(this.screenViewport,e.screenViewport)>=t||this.row!==e.row||this.column!==e.column||this.rows!==e.rows||this.columns!==e.columns)return!1;(0,M.y)(go,e.eye,e.center),(0,M.y)(mo,this.eye,this.center);const i=(0,M.j)(go,mo),r=(0,M.w)(go),n=(0,M.w)(mo),s=5e-4;return i*i>=(1-1e-10)*r*n&&(0,M.v)(e.eye,this.eye)<Math.max(r,n)*s*s}computeRenderPixelSizeAt(e){return this.computeRenderPixelSizeAtDist(this._viewDirectionDistance(e))}computeRenderPixelSizeAtDist(e){return e*this.perRenderPixelRatio}computeScreenPixelSizeAt(e){return this.computeScreenPixelSizeAtDist(this._viewDirectionDistance(e))}_viewDirectionDistance(e){return Math.abs((0,ho.gr)(this.viewForward,(0,M.f)(go,e,this.eye)))}computeScreenPixelSizeAtDist(e){return e*this.perScreenPixelRatio}computeDistanceFromRadius(e,t){return e/Math.tan(Math.min(this.fovX,this.fovY)/(2*(t||1)))}getScreenCenter(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,Ln.gs)();return e[0]=(this.padding[vo.LEFT]+this.width/2)/this.pixelRatio,e[1]=(this.padding[vo.TOP]+this.height/2)/this.pixelRatio,e}getRenderCenter(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.5,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.5;return e[0]=this.padding[vo.LEFT]+this.width*t,e[1]=this.padding[vo.BOTTOM]+this.height*i,e[2]=.5,e}setGLViewport(e){const t=this.viewport,i=this.padding;e.setViewport(t[0]-i[3],t[1]-i[2],t[2]+i[1]+i[3],t[3]+i[0]+i[2])}applyProjection(e,t){e!==po&&(0,M.c)(po,e),po[3]=1,(0,D.t)(po,po,this.projectionMatrix);const i=Math.abs(po[3]);(0,M.h)(po,po,1/i);const r=this.fullViewport;t[0]=(0,U.Cc)(0,r[0]+r[2],.5+.5*po[0]),t[1]=(0,U.Cc)(0,r[1]+r[3],.5+.5*po[1]),t[2]=.5*(po[2]+1),t[3]=i}unapplyProjection(e,t){const i=this.fullViewport;po[0]=(e[0]/(i[0]+i[2])*2-1)*e[3],po[1]=(e[1]/(i[1]+i[3])*2-1)*e[3],po[2]=(2*e[2]-1)*e[3],po[3]=e[3],null!=this.inverseProjectionMatrix&&((0,D.t)(po,po,this.inverseProjectionMatrix),t[0]=po[0],t[1]=po[1],t[2]=po[2])}projectToScreen(e,t){return this.projectToRenderScreen(e,_o),this.renderToScreen(_o,t),t}projectToRenderScreen(e,t){if(po[0]=e[0],po[1]=e[1],po[2]=e[2],po[3]=1,(0,D.t)(po,po,this.viewProjectionMatrix),0===po[3])return null;const i=po;(0,M.h)(i,i,1/Math.abs(po[3]));const r=this.fullViewport,n=(0,U.Cc)(0,r[0]+r[2],.5+.5*i[0]),s=(0,U.Cc)(0,r[1]+r[3],.5+.5*i[1]);return"x"in t?(t.x=n,t.y=s):(t[0]=n,t[1]=s,t.length>2&&(t[2]=.5*(i[2]+1))),t}unprojectFromScreen(e,t){return this.unprojectFromRenderScreen(this.screenToRender(e,_o),t)}unprojectFromRenderScreen(e,t){if((0,T.lw)(fo,this.projectionMatrix,this.viewMatrix),!(0,T.B8)(fo,fo))return null;const i=this.fullViewport;return po[0]=2*(e[0]-i[0])/i[2]-1,po[1]=2*(e[1]-i[1])/i[3]-1,po[2]=2*e[2]-1,po[3]=1,(0,D.t)(po,po,fo),0===po[3]?null:(t[0]=po[0]/po[3],t[1]=po[1]/po[3],t[2]=po[2]/po[3],t)}constrainWindowSize(e,t,i,r){const n=e*this.pixelRatio,s=t*this.pixelRatio,a=Math.max(n-i/2,0),o=Math.max(this.fullHeight-s-r/2,0),l=-Math.min(n-i/2,0),c=-Math.min(this.fullHeight-s-r/2,0),d=i-l- -Math.min(this.fullWidth-n-i/2,0),h=r-c- -Math.min(s-r/2,0);return[Math.round(a),Math.round(o),Math.round(d),Math.round(h)]}computeUp(e){e===ae.RT.Global?this._computeUpGlobal():this._computeUpLocal()}screenToRender(e,t){const i=e[0]*this.pixelRatio,r=this.fullHeight-e[1]*this.pixelRatio;return t[0]=i,t[1]=r,t}renderToScreen(e,t){const i=e[0]/this.pixelRatio,r=(this.fullHeight-e[1])/this.pixelRatio;t[0]=i,t[1]=r}_computeUpGlobal(){(0,M.f)(go,this.center,this.eye);const e=(0,M.l)(this.center);e<1?((0,M.s)(this._up,0,0,1),this._markViewDirty(),this.notifyChange("_up")):Math.abs((0,M.j)(go,this.center))>.9999*(0,M.l)(go)*e||((0,M.b)(this._up,go,this.center),(0,M.b)(this._up,this._up,go),(0,M.n)(this._up,this._up),this.notifyChange("_up"),this._markViewDirty())}_computeUpLocal(){(0,M.D)(go,this.eye,this.center),Math.abs(go[2])<=.9999&&((0,M.h)(go,go,go[2]),(0,M.s)(this._up,-go[0],-go[1],1-go[2]),(0,M.n)(this._up,this._up),this.notifyChange("_up"),this._markViewDirty())}_compareAndSetView(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"";"number"==typeof e[0]&&isFinite(e[0])&&"number"==typeof e[1]&&isFinite(e[1])&&"number"==typeof e[2]&&isFinite(e[2])?(0,M.i)(e,t)||((0,M.c)(t,e),this._markViewDirty(),i.length&&this.notifyChange(i)):a.A.getLogger("esri.views.3d.webgl-engine.lib.Camera").warn("Camera vector contains invalid number, ignoring value")}_markViewDirty(){this._viewDirty=!0,this._frustumDirty=!0,this._viewProjectionDirty=!0}_recomputeFrustum(){this._frustumDirty&&((0,wt.ui)(this.viewMatrix,this.projectionMatrix,this._frustum),this._frustumDirty=!1)}_ensureViewClean(){this._viewDirty&&((0,T.t5)(this._viewMatrix,this.eye,this.center,this.up),this.notifyChange("_viewMatrix"),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0)}};(0,r._)([(0,d.MZ)()],uo.prototype,"_viewport",void 0),(0,r._)([(0,d.MZ)()],uo.prototype,"_padding",void 0),(0,r._)([(0,d.MZ)()],uo.prototype,"_fov",void 0),(0,r._)([(0,d.MZ)()],uo.prototype,"_nearFar",void 0),(0,r._)([(0,d.MZ)()],uo.prototype,"_viewDirty",void 0),(0,r._)([(0,d.MZ)()],uo.prototype,"_viewMatrix",void 0),(0,r._)([(0,d.MZ)()],uo.prototype,"_pixelRatio",void 0),(0,r._)([(0,d.MZ)()],uo.prototype,"pixelRatio",null),(0,r._)([(0,d.MZ)()],uo.prototype,"row",void 0),(0,r._)([(0,d.MZ)()],uo.prototype,"column",void 0),(0,r._)([(0,d.MZ)()],uo.prototype,"_rows",void 0),(0,r._)([(0,d.MZ)()],uo.prototype,"rows",null),(0,r._)([(0,d.MZ)()],uo.prototype,"_columns",void 0),(0,r._)([(0,d.MZ)()],uo.prototype,"columns",null),(0,r._)([(0,d.MZ)()],uo.prototype,"eye",null),(0,r._)([(0,d.MZ)()],uo.prototype,"center",null),(0,r._)([(0,d.MZ)()],uo.prototype,"_center",void 0),(0,r._)([(0,d.MZ)()],uo.prototype,"up",null),(0,r._)([(0,d.MZ)()],uo.prototype,"_up",void 0),(0,r._)([(0,d.MZ)({readOnly:!0})],uo.prototype,"viewForward",null),(0,r._)([(0,d.MZ)({readOnly:!0})],uo.prototype,"viewUp",null),(0,r._)([(0,d.MZ)({readOnly:!0})],uo.prototype,"viewRight",null),(0,r._)([(0,d.MZ)({readOnly:!0})],uo.prototype,"nearFar",null),(0,r._)([(0,d.MZ)()],uo.prototype,"near",null),(0,r._)([(0,d.MZ)()],uo.prototype,"far",null),(0,r._)([(0,d.MZ)()],uo.prototype,"viewport",null),(0,r._)([(0,d.MZ)({readOnly:!0})],uo.prototype,"screenViewport",null),(0,r._)([(0,d.MZ)({readOnly:!0})],uo.prototype,"screenPadding",null),(0,r._)([(0,d.MZ)()],uo.prototype,"x",null),(0,r._)([(0,d.MZ)()],uo.prototype,"y",null),(0,r._)([(0,d.MZ)()],uo.prototype,"width",null),(0,r._)([(0,d.MZ)()],uo.prototype,"height",null),(0,r._)([(0,d.MZ)()],uo.prototype,"fullWidth",null),(0,r._)([(0,d.MZ)()],uo.prototype,"fullHeight",null),(0,r._)([(0,d.MZ)({readOnly:!0})],uo.prototype,"_aspect",null),(0,r._)([(0,d.MZ)()],uo.prototype,"padding",null),(0,r._)([(0,d.MZ)({readOnly:!0})],uo.prototype,"projectionMatrix",null),(0,r._)([(0,d.MZ)({readOnly:!0})],uo.prototype,"inverseProjectionMatrix",null),(0,r._)([(0,d.MZ)()],uo.prototype,"fov",null),(0,r._)([(0,d.MZ)()],uo.prototype,"fovX",null),(0,r._)([(0,d.MZ)()],uo.prototype,"fovY",null),uo=lo=(0,r._)([(0,u.$)("esri.views.3d.webgl-engine.lib.Camera")],uo);const po=(0,L.vt)(),fo=(0,P.vt)(),go=(0,I.vt)(),mo=(0,I.vt)(),_o=(0,Ln.r_)();var vo;!function(e){e[e.TOP=0]="TOP",e[e.RIGHT=1]="RIGHT",e[e.BOTTOM=2]="BOTTOM",e[e.LEFT=3]="LEFT"}(vo||(vo={}));class yo{constructor(e,t,i,r){this._textureRepository=e,this._techniqueRepository=t,this.materialChanged=i,this.requestRender=r,this._id2glMaterialRef=new ro.O}dispose(){this._textureRepository.destroy()}acquire(e,t,i){this._ownMaterial(e);const r=e.produces.get(t);if(!r||!r(i))return null;let n=this._id2glMaterialRef.get(i,e.id);if(null==n){const t=e.createGLMaterial({material:e,techniqueRep:this._techniqueRepository,textureRepository:this._textureRepository,output:i});n=new bo(t),this._id2glMaterialRef.set(i,e.id,n)}return n.ref(),n.glMaterial}release(e,t){const i=this._id2glMaterialRef.get(t,e.id);null!=i&&(i.unref(),i.referenced||((0,le.WD)(i.glMaterial),this._id2glMaterialRef.delete(t,e.id)))}_ownMaterial(e){e.repository&&e.repository!==this&&a.A.getLogger("esri.views.3d.webgl-engine.lib.GLMaterialRepository").error("Material is already owned by a different material repository"),e.repository=this}}class bo{constructor(e){this.glMaterial=e,this._refCnt=0}ref(){++this._refCnt}unref(){--this._refCnt,(0,br.vA)(this._refCnt>=0)}get referenced(){return this._refCnt>0}}const xo=!1,So=null;var wo=i(88321);const Co=["layerObjectAdded","layerObjectRemoved","layerObjectsAdded","layerObjectsRemoved","transformationChanged","shaderTransformationChanged","visibilityChanged","occlusionChanged","highlightChanged","geometryAdded","geometryRemoved","attributesChanged"];var Ao,Ro=i(94536);!function(e){e[e.ASYNC=0]="ASYNC",e[e.SYNC=1]="SYNC"}(Ao||(Ao={}));class Eo extends Es.J{get objects(){return this._objects}constructor(e,t){var i,r,n,s;let a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"";super(),this.stage=e,this.apiLayerUid=a,this.type=vr.X.Layer,this.events=new Cn.A,this.visible=!0,this.pickable=!0,this.sliceable=!1,this._objects=new C.A,this._objectsAdded=new C.A,this._handles=new wo.A,this.apiLayerUid=a,this.visible=null===(i=null===t||void 0===t?void 0:t.visible)||void 0===i||i,this.pickable=null===(r=null===t||void 0===t?void 0:t.pickable)||void 0===r||r,this.updatePolicy=null!==(n=null===t||void 0===t?void 0:t.updatePolicy)&&void 0!==n?n:Ao.ASYNC,this._disableOctree=null!==(s=null===t||void 0===t?void 0:t.disableOctree)&&void 0!==s&&s,e.add(this);for(const o of Co)this._handles.add(this.events.on(o,(t=>e.handleEvent(o,t))))}destroy(){this._handles.size&&(this._handles.destroy(),this.stage.remove(this),this.invalidateSpatialQueryAccelerator())}add(e){this._objects.push(e),e.parentLayer=this,this.events.emit("layerObjectAdded",{layer:this,object:e}),null!=this._octree&&this._objectsAdded.push(e)}remove(e){this._objects.removeUnordered(e)&&(e.parentLayer=null,this.events.emit("layerObjectRemoved",{layer:this,object:e}),null!=this._octree&&(this._objectsAdded.removeUnordered(e)||this._octree.remove([e])))}addMany(e){this._objects.pushArray(e);for(const t of e)t.parentLayer=this;this.events.emit("layerObjectsAdded",{layer:this,objects:e}),null!=this._octree&&this._objectsAdded.pushArray(e)}removeMany(e){const t=new Array;if(this._objects.removeUnorderedMany(e,e.length,t),0!==t.length){for(const e of t)e.parentLayer=null;if(this.events.emit("layerObjectsRemoved",{layer:this,objects:t}),null!=this._octree){for(let e=0;e<t.length;)this._objectsAdded.removeUnordered(t[e])?(t[e]=t[t.length-1],t.length-=1):++e;this._octree.remove(t)}}}sync(){this.updatePolicy!==Ao.SYNC&&this.stage.syncLayer(this.id)}notifyObjectBBChanged(e,t){null==this._octree||this._objectsAdded.includes(e)||this._octree.update(e,t)}getSpatialQueryAccelerator(){return null==this._octree&&this._objects.length>50&&!this._disableOctree?(this._octree=new Ro.A((e=>e.boundingVolumeWorldSpace.bounds)),this._octree.add(this._objects.data,this._objects.length)):null!=this._octree&&this._objectsAdded.length>0&&(this._octree.add(this._objectsAdded.data,this._objectsAdded.length),this._objectsAdded.clear()),this._octree}invalidateSpatialQueryAccelerator(){this._octree=(0,le.pR)(this._octree),this._objectsAdded.clear()}}var Oo=i(44230),To=i(93684),Po=i(50125),Mo=i(14623),Io=i(60322),Do=i(96643),Lo=i(10773);const Fo=new Map([[Pt.r.POSITION,0],[Pt.r.PREVPOSITION,1],[Pt.r.NEXTPOSITION,2],[Pt.r.SUBDIVISIONFACTOR,3],[Pt.r.UV0,4],[Pt.r.COLOR,5],[Pt.r.COLORFEATUREATTRIBUTE,5],[Pt.r.SIZE,6],[Pt.r.SIZEFEATUREATTRIBUTE,6],[Pt.r.OPACITYFEATUREATTRIBUTE,7],[Pt.r.OBJECTANDLAYERIDCOLOR,8]]);class No extends Xs.w{initializeProgram(e){return new Ks.B(e.rctx,No.shader.get().build(this.configuration),Fo)}_makePipelineState(e,t){const i=this.configuration,r=e===Lo.y.NONE,n=e===Lo.y.FrontFace,s=(0,ks.cb)(i.output);return(0,ta.Ey)({blending:i.output===ks.V.Color||i.output===ks.V.Alpha?r?Io.V0:(0,Io.ez)(e):null,depthTest:{func:(0,Io.K_)(e)},depthWrite:r?i.writeDepth||s?ta.kn:null:(0,Io.XO)(e),colorWrite:ta.wE,stencilWrite:i.hasOccludees?Do.v0:null,stencilTest:i.hasOccludees?t?Do.a9:Do.qh:null,polygonOffset:r||n?i.hasPolygonOffset?Vo:null:Io.SE})}initializePipeline(){const e=this.configuration;if(e.occluder){const t=e.hasPolygonOffset?Vo:null;this._occluderPipelineTransparent=(0,ta.Ey)({blending:Io.V0,polygonOffset:t,depthTest:Do.sf,depthWrite:null,colorWrite:ta.wE,stencilWrite:null,stencilTest:Do.mK}),this._occluderPipelineOpaque=(0,ta.Ey)({blending:Io.V0,polygonOffset:t,depthTest:Do.sf,depthWrite:null,colorWrite:ta.wE,stencilWrite:Do.r8,stencilTest:Do.I$}),this._occluderPipelineMaskWrite=(0,ta.Ey)({blending:null,polygonOffset:t,depthTest:Do.m,depthWrite:null,colorWrite:null,stencilWrite:Do.v0,stencilTest:Do.a9})}return this._occludeePipelineState=this._makePipelineState(this.configuration.transparencyPassType,!0),this._makePipelineState(this.configuration.transparencyPassType,!1)}get primitiveType(){return this.configuration.wireframe?ft.WR.LINES:ft.WR.TRIANGLE_STRIP}getPipeline(e,t,i){return e?this._occludeePipelineState:this.configuration.occluder?i?this._occluderPipelineTransparent:t?this._occluderPipelineOpaque:this._occluderPipelineMaskWrite:super.getPipeline()}}No.shader=new Ys.$(Mo.R,(()=>i.e(1721).then(i.bind(i,61721))));const Vo={factor:0,units:-4};var Go,Uo=i(46259);!function(e){e[e.LEFT_JOIN_START=-2]="LEFT_JOIN_START",e[e.LEFT_JOIN_END=-1]="LEFT_JOIN_END",e[e.LEFT_CAP_START=-4]="LEFT_CAP_START",e[e.LEFT_CAP_END=-5]="LEFT_CAP_END",e[e.RIGHT_JOIN_START=2]="RIGHT_JOIN_START",e[e.RIGHT_JOIN_END=1]="RIGHT_JOIN_END",e[e.RIGHT_CAP_START=4]="RIGHT_CAP_START",e[e.RIGHT_CAP_END=5]="RIGHT_CAP_END"}(Go||(Go={}));class zo extends qs.im{constructor(e){super(e,new Ho),this._configuration=new Uo.Q,this.produces=new Map([[Qs.N.OPAQUE_MATERIAL,e=>e===ks.V.Highlight||e===ks.V.ObjectAndLayerIdColor||(e===ks.V.Color||e===ks.V.Alpha)&&this.parameters.renderOccluded===qs.m$.OccludeAndTransparentStencil],[Qs.N.OPAQUE_NO_SSAO_DEPTH,e=>e===ks.V.LinearDepth],[Qs.N.OCCLUDER_MATERIAL,e=>(0,ks.Mo)(e)&&this.parameters.renderOccluded===qs.m$.OccludeAndTransparentStencil],[Qs.N.TRANSPARENT_OCCLUDER_MATERIAL,e=>(0,ks.Mo)(e)&&this.parameters.renderOccluded===qs.m$.OccludeAndTransparentStencil],[Qs.N.TRANSPARENT_MATERIAL,e=>(e===ks.V.Color||e===ks.V.Alpha)&&this.parameters.writeDepth&&this.parameters.renderOccluded!==qs.m$.OccludeAndTransparentStencil],[Qs.N.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL,e=>(e===ks.V.Color||e===ks.V.Alpha)&&!this.parameters.writeDepth&&this.parameters.renderOccluded!==qs.m$.OccludeAndTransparentStencil],[Qs.N.DRAPED_MATERIAL,e=>(0,ks.i3)(e)]]),this._vertexAttributeLocations=Fo}getConfiguration(e,t){this._configuration.output=e,this._configuration.draped=t.slot===Qs.N.DRAPED_MATERIAL;const i=null!=this.parameters.stipplePattern&&e!==ks.V.Highlight;return this._configuration.stippleEnabled=i,this._configuration.stippleOffColorEnabled=i&&null!=this.parameters.stippleOffColor,this._configuration.stipplePreferContinuous=i&&this.parameters.stipplePreferContinuous,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasOccludees=this.parameters.hasOccludees,this._configuration.roundJoins="round"===this.parameters.join,this._configuration.capType=this.parameters.cap,this._configuration.applyMarkerOffset=null!=this.parameters.markerParameters&&function(e){return e.anchor===Po.kJ.Tip&&e.hideOnShortSegments&&"begin-end"===e.placement&&e.worldSpace}(this.parameters.markerParameters),this._configuration.hasPolygonOffset=this.parameters.hasPolygonOffset,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.vvSize=!!this.parameters.vvSize,this._configuration.vvColor=!!this.parameters.vvColor,this._configuration.vvOpacity=!!this.parameters.vvOpacity,this._configuration.innerColorEnabled=this.parameters.innerWidth>0&&null!=this.parameters.innerColor,this._configuration.falloffEnabled=this.parameters.falloff>0,this._configuration.occluder=this.parameters.renderOccluded===qs.m$.OccludeAndTransparentStencil,this._configuration.transparencyPassType=t.transparencyPassType,this._configuration.multipassEnabled=t.multipassEnabled,this._configuration.cullAboveGround=t.multipassTerrain.cullAboveGround,this._configuration.wireframe=this.parameters.wireframe,this._configuration}intersectDraped(e,t,i,r,n,s){if(!i.options.selectionMode)return;const a=e.attributes.get(Pt.r.POSITION).data,o=e.attributes.get(Pt.r.SIZE);let l=this.parameters.width;if(this.parameters.vvSize){const t=e.attributes.get(Pt.r.SIZEFEATUREATTRIBUTE).data[0];l*=(0,U.qE)(this.parameters.vvSize.offset[0]+t*this.parameters.vvSize.factor[0],this.parameters.vvSize.minSize[0],this.parameters.vvSize.maxSize[0])}else o&&(l*=o.data[0]);const c=r[0],d=r[1],h=(l/2+4)*e.screenToWorldRatio;let u=Number.MAX_VALUE,p=0;for(let f=0;f<a.length-5;f+=3){const e=a[f],t=a[f+1],i=c-e,r=d-t,n=a[f+3]-e,s=a[f+4]-t,o=(0,U.qE)((n*i+s*r)/(n*n+s*s),0,1),l=n*o-i,h=s*o-r,g=l*l+h*h;g<u&&(u=g,p=f/3)}u<h*h&&n(s.dist,s.normal,p,!1)}intersect(e,t,i,r,n,s){if(!i.options.selectionMode||!e.visible)return;if(!(0,br.zH)(t))return void a.A.getLogger("esri.views.3d.webgl-engine.materials.RibbonLineMaterial").error("intersection assumes a translation-only matrix");const o=e.attributes,l=o.get(Pt.r.POSITION).data;let c=this.parameters.width;if(this.parameters.vvSize){const e=o.get(Pt.r.SIZEFEATUREATTRIBUTE).data[0];c*=(0,U.qE)(this.parameters.vvSize.offset[0]+e*this.parameters.vvSize.factor[0],this.parameters.vvSize.minSize[0],this.parameters.vvSize.maxSize[0])}else o.has(Pt.r.SIZE)&&(c*=o.get(Pt.r.SIZE).data[0]);const d=i.camera,h=Yo;(0,Sa.C)(h,i.point);const u=c*d.pixelRatio/2+4*d.pixelRatio;(0,M.s)(al[0],h[0]-u,h[1]+u,0),(0,M.s)(al[1],h[0]+u,h[1]+u,0),(0,M.s)(al[2],h[0]+u,h[1]-u,0),(0,M.s)(al[3],h[0]-u,h[1]-u,0);for(let a=0;a<4;a++)if(!d.unprojectFromRenderScreen(al[a],ol[a]))return;(0,gr.Cr)(d.eye,ol[0],ol[1],ll),(0,gr.Cr)(d.eye,ol[1],ol[2],cl),(0,gr.Cr)(d.eye,ol[2],ol[3],dl),(0,gr.Cr)(d.eye,ol[3],ol[0],hl);let p=Number.MAX_VALUE,f=0;const g=ko(this.parameters,o)?l.length-2:l.length-5;for(let a=0;a<g;a+=3){Zo[0]=l[a]+t[12],Zo[1]=l[a+1]+t[13],Zo[2]=l[a+2]+t[14];const e=(a+3)%l.length;if(qo[0]=l[e]+t[12],qo[1]=l[e+1]+t[13],qo[2]=l[e+2]+t[14],(0,gr.mN)(ll,Zo)<0&&(0,gr.mN)(ll,qo)<0||(0,gr.mN)(cl,Zo)<0&&(0,gr.mN)(cl,qo)<0||(0,gr.mN)(dl,Zo)<0&&(0,gr.mN)(dl,qo)<0||(0,gr.mN)(hl,Zo)<0&&(0,gr.mN)(hl,qo)<0)continue;if(d.projectToRenderScreen(Zo,Xo),d.projectToRenderScreen(qo,$o),Xo[2]<0&&$o[2]>0){(0,M.f)(Qo,Zo,qo);const e=d.frustum,t=-(0,gr.mN)(e[wt.FB.NEAR],Zo)/(0,M.j)(Qo,(0,gr.Qj)(e[wt.FB.NEAR]));(0,M.h)(Qo,Qo,t),(0,M.g)(Zo,Zo,Qo),d.projectToRenderScreen(Zo,Xo)}else if(Xo[2]>0&&$o[2]<0){(0,M.f)(Qo,qo,Zo);const e=d.frustum,t=-(0,gr.mN)(e[wt.FB.NEAR],qo)/(0,M.j)(Qo,(0,gr.Qj)(e[wt.FB.NEAR]));(0,M.h)(Qo,Qo,t),(0,M.g)(qo,qo,Qo),d.projectToRenderScreen(qo,$o)}else if(Xo[2]<0&&$o[2]<0)continue;Xo[2]=0,$o[2]=0;const i=(0,Oo.kb)((0,Oo.Cr)(Xo,$o,tl),h);i<p&&(p=i,(0,M.c)(Ko,Zo),(0,M.c)(el,qo),f=a/3)}const m=i.rayBegin,_=i.rayEnd;if(p<u*u){let e=Number.MAX_VALUE;if((0,Oo.ld)((0,Oo.Cr)(Ko,el,tl),(0,Oo.Cr)(m,_,il),Jo)){(0,M.f)(Jo,Jo,m);const t=(0,M.l)(Jo);(0,M.h)(Jo,Jo,1/t),e=t/(0,M.p)(m,_)}s(e,Jo,f,!1)}}get _layout(){const e=(0,Ws.BP)().vec3f(Pt.r.POSITION).vec3f(Pt.r.PREVPOSITION).vec3f(Pt.r.NEXTPOSITION).f32(Pt.r.SUBDIVISIONFACTOR).vec2f(Pt.r.UV0);return this.parameters.vvSize?e.f32(Pt.r.SIZEFEATUREATTRIBUTE):e.f32(Pt.r.SIZE),this.parameters.vvColor?e.f32(Pt.r.COLORFEATUREATTRIBUTE):e.vec4f(Pt.r.COLOR),this.parameters.vvOpacity&&e.f32(Pt.r.OPACITYFEATUREATTRIBUTE),(0,h.A)("enable-feature:objectAndLayerId-rendering")&&e.vec4u8(Pt.r.OBJECTANDLAYERIDCOLOR),e}createBufferWriter(){return new jo(this._layout,this.parameters)}createGLMaterial(e){return new Bo(e)}validateParameters(e){"miter"!==e.join&&(e.miterLimit=0),null!=e.markerParameters&&(e.markerScale=e.markerParameters.width/e.width)}}class Bo extends Zs.A{constructor(){super(...arguments),this._stipplePattern=null}dispose(){super.dispose(),this._stippleTextureRepository.release(this._stipplePattern),this._stipplePattern=null}_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})}beginSlot(e){this._output!==ks.V.Color&&this._output!==ks.V.Alpha||this._updateOccludeeState(e);const t=this._material.parameters.stipplePattern;return this._stipplePattern!==t&&(this._material.setParameters({stippleTexture:this._stippleTextureRepository.swap(t,this._stipplePattern)}),this._stipplePattern=t),this.ensureTechnique(No,e)}}class Ho extends To.S{constructor(){super(...arguments),this.width=0,this.color=L.Un,this.join="miter",this.cap=Uo.x.BUTT,this.miterLimit=5,this.writeDepth=!0,this.hasPolygonOffset=!1,this.stippleTexture=null,this.stipplePreferContinuous=!0,this.markerParameters=null,this.markerScale=1,this.hasSlicePlane=!1,this.vvFastUpdate=!1,this.isClosed=!1,this.falloff=0,this.innerWidth=0,this.hasOccludees=!1,this.wireframe=!1}}class jo{constructor(e,t){this.vertexBufferLayout=e,this._parameters=t,this.numJoinSubdivisions=0;const i=t.stipplePattern?1:0;switch(this._parameters.join){case"miter":case"bevel":this.numJoinSubdivisions=i;break;case"round":this.numJoinSubdivisions=Mo.r+i}}_isClosed(e){return ko(this._parameters,e.attributes)}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){const t=e.attributes.get(Pt.r.POSITION).indices.length/2+1,i=this._isClosed(e);let r=i?2:4;return r+=((i?t:t-1)-(i?0:1))*(2*this.numJoinSubdivisions+4),r+=2,this._parameters.wireframe&&(r=2+4*(r-2)),r}write(e,t,i,r,n){var s,a,o,l,c;const d=rl,u=nl,p=sl,f=i.attributes.get(Pt.r.POSITION),g=f.indices,m=f.data.length/3,_=null===(s=i.attributes.get(Pt.r.DISTANCETOSTART))||void 0===s?void 0:s.data;g&&g.length!==2*(m-1)&&console.warn("RibbonLineMaterial does not support indices");const v=null!==(a=null!==(o=null===(l=i.attributes.get(Pt.r.SIZEFEATUREATTRIBUTE))||void 0===l?void 0:l.data[0])&&void 0!==o?o:null===(c=i.attributes.get(Pt.r.SIZE))||void 0===c?void 0:c.data[0])&&void 0!==a?a:1;let y=[1,1,1,1],b=0;const x=this.vertexBufferLayout.fields.has(Pt.r.COLORFEATUREATTRIBUTE);x?b=i.attributes.get(Pt.r.COLORFEATUREATTRIBUTE).data[0]:i.attributes.has(Pt.r.COLOR)&&(y=i.attributes.get(Pt.r.COLOR).data);const S=(0,h.A)("enable-feature:objectAndLayerId-rendering")?i.objectAndLayerIdColor:null,w=this.vertexBufferLayout.fields.has(Pt.r.OPACITYFEATUREATTRIBUTE),C=w?i.attributes.get(Pt.r.OPACITYFEATUREATTRIBUTE).data[0]:0,A=new Float32Array(r.buffer),R=(0,h.A)("enable-feature:objectAndLayerId-rendering")?new Uint8Array(r.buffer):null,E=this.vertexBufferLayout.stride/4;let O=n*E;const T=O;let P=0;const I=_?(e,t,i)=>P=_[i]:(e,t,i)=>P+=(0,M.p)(e,t),D=(0,h.A)("enable-feature:objectAndLayerId-rendering"),L=(e,t,i,r,n,s,a)=>{if(A[O++]=t[0],A[O++]=t[1],A[O++]=t[2],A[O++]=e[0],A[O++]=e[1],A[O++]=e[2],A[O++]=i[0],A[O++]=i[1],A[O++]=i[2],A[O++]=r,A[O++]=a,A[O++]=n,A[O++]=v,x)A[O++]=b;else{const e=Math.min(4*s,y.length-4);A[O++]=y[e],A[O++]=y[e+1],A[O++]=y[e+2],A[O++]=y[e+3]}w&&(A[O++]=C),D&&(null!=S&&(R[4*O]=S[0],R[4*O+1]=S[1],R[4*O+2]=S[2],R[4*O+3]=S[3]),O++)};O+=E,(0,M.s)(u,f.data[0],f.data[1],f.data[2]),e&&(0,M.e)(u,u,e);const F=this._isClosed(i);if(F){const t=f.data.length-3;(0,M.s)(d,f.data[t],f.data[t+1],f.data[t+2]),e&&(0,M.e)(d,d,e)}else(0,M.s)(p,f.data[3],f.data[4],f.data[5]),e&&(0,M.e)(p,p,e),L(u,u,p,1,Go.LEFT_CAP_START,0,0),L(u,u,p,1,Go.RIGHT_CAP_START,0,0),(0,M.c)(d,u),(0,M.c)(u,p);const N=F?0:1,V=F?m:m-1;for(let h=N;h<V;h++){const t=(h+1)%m*3;(0,M.s)(p,f.data[t],f.data[t+1],f.data[t+2]),e&&(0,M.e)(p,p,e),I(d,u,h),L(d,u,p,0,Go.LEFT_JOIN_END,h,P),L(d,u,p,0,Go.RIGHT_JOIN_END,h,P);const i=this.numJoinSubdivisions;for(let e=0;e<i;++e){const t=(e+1)/(i+1);L(d,u,p,t,Go.LEFT_JOIN_END,h,P),L(d,u,p,t,Go.RIGHT_JOIN_END,h,P)}L(d,u,p,1,Go.LEFT_JOIN_START,h,P),L(d,u,p,1,Go.RIGHT_JOIN_START,h,P),(0,M.c)(d,u),(0,M.c)(u,p)}F?((0,M.s)(p,f.data[3],f.data[4],f.data[5]),e&&(0,M.e)(p,p,e),P=I(d,u,V),L(d,u,p,0,Go.LEFT_JOIN_END,N,P),L(d,u,p,0,Go.RIGHT_JOIN_END,N,P)):(P=I(d,u,V),L(d,u,u,0,Go.LEFT_CAP_END,V,P),L(d,u,u,0,Go.RIGHT_CAP_END,V,P)),Wo(A,T+E,A,T,E),O=Wo(A,O-E,A,O,E),this._parameters.wireframe&&this._addWireframeVertices(r,T,O,E)}_addWireframeVertices(e,t,i,r){const n=new Float32Array(e.buffer,i*Float32Array.BYTES_PER_ELEMENT),s=new Float32Array(e.buffer,t*Float32Array.BYTES_PER_ELEMENT,i-t);let a=0;const o=e=>a=Wo(s,e,n,a,r);for(let l=0;l<s.length-1;l+=2*r)o(l),o(l+2*r),o(l+1*r),o(l+2*r),o(l+1*r),o(l+3*r)}}function Wo(e,t,i,r,n){for(let s=0;s<n;s++)i[r++]=e[t++];return r}function ko(e,t){return!!e.isClosed&&t.get(Pt.r.POSITION).indices.length>2}const Zo=(0,I.vt)(),qo=(0,I.vt)(),Qo=(0,I.vt)(),Jo=(0,I.vt)(),Yo=(0,I.vt)(),Xo=(0,Ln.r_)(),$o=(0,Ln.r_)(),Ko=(0,I.vt)(),el=(0,I.vt)(),tl=(0,Oo.vt)(),il=(0,Oo.vt)(),rl=(0,I.vt)(),nl=(0,I.vt)(),sl=(0,I.vt)(),al=[(0,Ln.r_)(),(0,Ln.r_)(),(0,Ln.r_)(),(0,Ln.r_)()],ol=[(0,I.vt)(),(0,I.vt)(),(0,I.vt)(),(0,I.vt)()],ll=(0,gr.vt)(),cl=(0,gr.vt)(),dl=(0,gr.vt)(),hl=(0,gr.vt)();class ul{constructor(e){this._originSR=e,this._rootOriginId="root/"+(0,Ni.c)(),this._origins=new Map,this._objects=new Map,this._gridSize=5e5}getOrigin(e){const t=this._origins.get(this._rootOriginId);if(null==t){const t=So;if(null!=t)return this._origins.set(this._rootOriginId,ja(t[0],t[1],t[2],this._rootOriginId)),this.getOrigin(e);const i=ja(e[0]+Math.random()-.5,e[1]+Math.random()-.5,e[2]+Math.random()-.5,this._rootOriginId);return this._origins.set(this._rootOriginId,i),i}const i=this._gridSize,r=Math.round(e[0]/i),n=Math.round(e[1]/i),s=Math.round(e[2]/i),a="".concat(r,"/").concat(n,"/").concat(s);let o=this._origins.get(a);const l=.5*i;if((0,M.f)(pl,e,t.vec3),pl[0]=Math.abs(pl[0]),pl[1]=Math.abs(pl[1]),pl[2]=Math.abs(pl[2]),pl[0]<l&&pl[1]<l&&pl[2]<l){if(o){const t=Math.max(...pl);if((0,M.f)(pl,e,o.vec3),pl[0]=Math.abs(pl[0]),pl[1]=Math.abs(pl[1]),pl[2]=Math.abs(pl[2]),Math.max(...pl)<t)return o}return t}return o||(o=ja(r*i,n*i,s*i,a),this._origins.set(a,o)),o}_drawOriginBox(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:(0,L.fA)(1,1,0,1);const i=window.view,r=i._stage,n=t.toString();if(!this._objects.has(n)){this._material=new zo({width:2,color:t}),r.add(this._material);const e=new Eo(r,{pickable:!1}),i=new Ps({castShadow:!1});r.add(i),e.add(i),this._objects.set(n,i)}const s=this._objects.get(n),a=[0,1,5,4,0,2,1,7,6,2,0,1,3,7,5,4,6,2,0],o=a.length,l=new Array(3*o),c=new Array,d=.5*this._gridSize;for(let u=0;u<o;u++)l[3*u]=e[0]+(1&a[u]?d:-d),l[3*u+1]=e[1]+(2&a[u]?d:-d),l[3*u+2]=e[2]+(4&a[u]?d:-d),u>0&&c.push(u-1,u);(0,k.projectBuffer)(l,this._originSR,0,l,i.renderSpatialReference,0,o);const h=new yr.V(this._material,[[Pt.r.POSITION,new _r.n(l,c,3,!0)]],null,vr.X.Line);r.add(h),s.addGeometry(h)}get test(){const e=this;return{set gridSize(t){e._gridSize=t}}}}const pl=(0,I.vt)();var fl=i(91417),gl=i(63401),ml=i(98521),_l=i(10708),vl=i(81993),yl=i(4998);class bl{constructor(e,t){this.shadowMap=e,this.slicePlane=t,this.slot=Qs.N.OPAQUE_MATERIAL,this.hasOccludees=!1,this.enableFillLights=!0,this.transparencyPassType=Lo.y.NONE,this.alignPixelEnabled=!1,this.decorations=fe.ID.ON,this.overlayStretch=1,this._camera=new uo,this._inverseViewport=(0,pr.vt)(),this.oldLighting=new yl.TA,this.newLighting=new yl.TA,this._fadedLighting=new yl.TA,this._lighting=this.newLighting,this.ssr=new xl,this.multipassEnabled=!1,this.multipassTerrain=new vl.h,this.multipassGeometry=new _l.U,this.hudRenderStyle=ml.D.Occluded,this.cloudsFade=new gl.ny}get camera(){return this._camera}set camera(e){this._camera=e,this._inverseViewport[0]=1/e.fullViewport[2],this._inverseViewport[1]=1/e.fullViewport[3]}get inverseViewport(){return this._inverseViewport}get lighting(){return this._lighting}get weatherFading(){return this._lighting===this._fadedLighting}fadeLighting(e){const{oldLighting:t,newLighting:i}=this;e>=1?this._lighting=i:(this._fadedLighting.lerpLighting(t,i,e),this._lighting=this._fadedLighting)}}class xl{constructor(){this.fadeFactor=1,this.reprojectionMatrix=(0,P.vt)()}}class Sl{constructor(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;this.rctx=e,this.sliceHelper=i,this.lastFrameCamera=new uo,this.output=ks.V.Color,this.renderOccludedMask=wl,this.bindParameters=new bl(t,null!=i?i.plane:null),this.bindParameters.alignPixelEnabled=!0}}const wl=qs.m$.Occlude|qs.m$.OccludeAndTransparent|qs.m$.OccludeAndTransparentStencil;let Cl=class extends uo{constructor(){super(...arguments),this._projectionMatrix=(0,P.vt)()}get projectionMatrix(){return this._projectionMatrix}};(0,r._)([(0,d.MZ)()],Cl.prototype,"_projectionMatrix",void 0),(0,r._)([(0,d.MZ)({readOnly:!0})],Cl.prototype,"projectionMatrix",null),Cl=(0,r._)([(0,u.$)("esri.views.3d.webgl-engine.lib.CascadeCamera")],Cl);var Al,Rl=i(98433);!function(e){e[e.Highlight=0]="Highlight",e[e.ExcludeHighlight=1]="ExcludeHighlight"}(Al||(Al={}));class El{constructor(){this.camera=new Cl,this.lightMat=(0,P.vt)()}}class Ol{constructor(){this.maxNumCascadesHighQuality=4,this.maxNumCascadesLowQuality=4,this.textureSizeModHighQuality=1.3,this.textureSizeModLowQuality=.9,this.splitSchemeLambda=0}}class Tl{constructor(e,t){this._fbos=e,this._viewingMode=t,this._enabled=!1,this._snapshots=new Array,this._textureHeight=0,this._numCascades=1,this.settings=new Ol,this._projectionView=(0,P.vt)(),this._projectionViewInverse=(0,P.vt)(),this._modelViewLight=(0,P.vt)(),this._cascadeDistances=[0,0,0,0,0],this._usedCascadeDistances=(0,L.vt)(),this._cascades=[new El,new El,new El,new El],this._lastOrigin=null,this._maxTextureWidth=Math.min((0,h.A)("esri-mobile")?4096:16384,e.rctx.parameters.maxTextureSize)}dispose(){this.enabled=!1,this.disposeOffscreenBuffers()}get depthTexture(){var e;return null===(e=this._handle)||void 0===e?void 0:e.getTexture()}get _textureWidth(){return this._textureHeight*this._numCascades}get numCascades(){return this._numCascades}get cascadeDistances(){return(0,D.s)(this._usedCascadeDistances,this._cascadeDistances[0],this._numCascades>1?this._cascadeDistances[1]:1/0,this._numCascades>2?this._cascadeDistances[2]:1/0,this._numCascades>3?this._cascadeDistances[3]:1/0)}disposeOffscreenBuffers(){this._handle=(0,le.Gz)(this._handle),this._discardSnapshots()}set maxCascades(e){this.settings.maxNumCascadesHighQuality=(0,U.qE)(Math.floor(e),1,4)}get maxCascades(){return this.settings.maxNumCascadesHighQuality}set enabled(e){this._enabled=e,e||this.disposeOffscreenBuffers()}get enabled(){return this._enabled}get ready(){return this._enabled&&null!=this.depthTexture}get cascades(){for(let e=0;e<this._numCascades;++e)Ul[e]=this._cascades[e];return Ul.length=this._numCascades,Ul}start(e,t,i,r,n){(0,br.vA)(this.enabled);const{near:s,far:a}=this._clampNearFar(i);this._computeCascadeDistances(s,a,r),this._textureHeight=this._computeTextureHeight(e,n,r),this._setupMatrices(e,t);const{viewMatrix:o,projectionMatrix:l}=e;for(let c=0;c<this._numCascades;++c)this._constructCascade(c,l,o,t);this._lastOrigin=null,this.clear()}finish(){var e;(0,br.vA)(this.enabled),null===(e=this._handle)||void 0===e||e.detachDepth()}getShadowMapMatrices(e){if(!this._lastOrigin||!(0,M.i)(e,this._lastOrigin)){this._lastOrigin=this._lastOrigin||(0,I.vt)(),(0,M.c)(this._lastOrigin,e);for(let t=0;t<this._numCascades;++t){(0,T.Tl)(zl,this._cascades[t].lightMat,e);for(let e=0;e<16;++e)Bl[16*t+e]=zl[e]}}return Bl}moveSnapshot(e){var t,i;(0,br.vA)(this.enabled),null!==(t=this._handle)&&void 0!==t&&t.detachDepth(),null!==(i=this._snapshots[e])&&void 0!==i&&i.release(),this._snapshots[e]=this._handle,this._handle=null,this.clear()}copySnapshot(e){var t,i,r;const n=null===(t=this._handle)||void 0===t||null===(t=t.getTexture())||void 0===t?void 0:t.descriptor;if(!this.enabled||!n)return;null===(i=this._snapshots[e])||void 0===i||i.release();const{width:s,height:a}=n,o=e===Al.Highlight?"shadow highlight snapshot":"shadow no highlight snapshot";this._snapshots[e]=this._fbos.acquire(s,a,o,qa.N.RGBA4);const l=this._fbos.rctx;this._bindFbo();const c=l.bindTexture(null===(r=this._snapshots[e])||void 0===r?void 0:r.getTexture(),Rl.g.TEXTURE_UNIT_FOR_UPDATES);l.gl.copyTexSubImage2D(ft.Ap.TEXTURE_2D,0,0,0,0,0,s,a),l.bindTexture(c,Rl.g.TEXTURE_UNIT_FOR_UPDATES)}getSnapshot(e){var t;return this.enabled?null===(t=this._snapshots[e])||void 0===t?void 0:t.getTexture():null}clear(){const e=this._fbos.rctx;this._ensureFbo(),this._bindFbo(),e.setClearColor(1,1,1,1),e.clearSafe(ft.hn.COLOR_BUFFER_BIT|ft.hn.DEPTH_BUFFER_BIT)}_computeTextureHeight(e,t,i){const r=Math.min(window.devicePixelRatio,t)/e.pixelRatio,n=i?this.settings.textureSizeModHighQuality:this.settings.textureSizeModLowQuality,s=(0,ge.Mv)(Math.floor(Math.max(e.fullWidth,e.fullHeight)*r*n)),a=Math.min(this._maxTextureWidth,this._numCascades*s);return(0,ge.uT)(a/this._numCascades)}_ensureFbo(){var e,t,i,r;(null===(e=this._handle)||void 0===e?void 0:e.fbo.width)===this._textureWidth&&(null===(t=this._handle)||void 0===t?void 0:t.fbo.height)===this._textureHeight||(null!==(i=this._handle)&&void 0!==i&&i.release(),this._handle=this._fbos.acquire(this._textureWidth,this._textureHeight,"shadow map",qa.N.RGBA4)),null===(r=this._handle)||void 0===r||r.acquireDepth(qa.z.DEPTH16_BUFFER)}_discardSnapshot(e){this._snapshots[e]=(0,le.Gz)(this._snapshots[e])}_discardSnapshots(){for(let e=0;e<this._snapshots.length;++e)this._discardSnapshot(e);this._snapshots.length=0}_bindFbo(){var e;const t=this._fbos.rctx;t.unbindTexture(this.depthTexture),t.bindFramebuffer(null===(e=this._handle)||void 0===e?void 0:e.fbo)}_constructCascade(e,t,i,r){const n=this._cascades[e],s=-this._cascadeDistances[e],a=-this._cascadeDistances[e+1],o=(t[10]*s+t[14])/Math.abs(t[11]*s+t[15]),l=(t[10]*a+t[14])/Math.abs(t[11]*a+t[15]);(0,br.vA)(o<l);for(let u=0;u<8;++u){(0,D.s)(Ml,u%4==0||u%4==3?-1:1,u%4==0||u%4==1?-1:1,u<4?o:l,1);const e=Il[u];(0,D.t)(e,Ml,this._projectionViewInverse),e[0]/=e[3],e[1]/=e[3],e[2]/=e[3]}(0,M.E)(Gl,Il[0]),n.camera.viewMatrix=(0,T.Tl)(Pl,this._modelViewLight,Gl);for(let u=0;u<8;++u)(0,M.e)(Il[u],Il[u],n.camera.viewMatrix);let c=Il[0][2],d=Il[0][2];for(let u=1;u<8;++u)c=Math.min(c,Il[u][2]),d=Math.max(d,Il[u][2]);c-=200,d+=200,n.camera.near=-d,n.camera.far=-c,function(e,t,i,r,n){const s=1/Il[0][3],a=1/Il[4][3];(0,br.vA)(s<a);let o=s+Math.sqrt(s*a);const l=Math.sin((0,U.XM)(e[2]*t[0]+e[6]*t[1]+e[10]*t[2]));o/=l,function(e,t,i,r,n,s,a,o){(0,Sa.hZ)(Hl,0,0);for(let x=0;x<4;++x)(0,Sa.WQ)(Hl,Hl,e[x]);(0,Sa.hs)(Hl,Hl,.25),(0,Sa.hZ)(jl,0,0);for(let x=4;x<8;++x)(0,Sa.WQ)(jl,jl,e[x]);(0,Sa.hs)(jl,jl,.25),(0,Sa.Cc)(Wl[0],e[4],e[5],.5),(0,Sa.Cc)(Wl[1],e[5],e[6],.5),(0,Sa.Cc)(Wl[2],e[6],e[7],.5),(0,Sa.Cc)(Wl[3],e[7],e[4],.5);let l=0,c=(0,Sa.hG)(Wl[0],Hl);for(let x=1;x<4;++x){const e=(0,Sa.hG)(Wl[x],Hl);e<c&&(c=e,l=x)}(0,Sa.Re)(kl,Wl[l],e[l+4]);const d=kl[0];let h,u;kl[0]=-kl[1],kl[1]=d,(0,Sa.Re)(Zl,jl,Hl),(0,Sa.Om)(Zl,kl)<0&&(0,Sa.ze)(kl,kl),(0,Sa.Cc)(kl,kl,Zl,i),(0,Sa.S8)(kl,kl),h=u=(0,Sa.Om)((0,Sa.Re)(ql,e[0],Hl),kl);for(let x=1;x<8;++x){const t=(0,Sa.Om)((0,Sa.Re)(ql,e[x],Hl),kl);t<h?h=t:t>u&&(u=t)}(0,Sa.C)(r,Hl),(0,Sa.hs)(ql,kl,h-t),(0,Sa.WQ)(r,r,ql);let p=-1,f=1,g=0,m=0;for(let x=0;x<8;++x){(0,Sa.Re)(Ql,e[x],r),(0,Sa.S8)(Ql,Ql);const t=kl[0]*Ql[1]-kl[1]*Ql[0];t>0?t>p&&(p=t,g=x):t<f&&(f=t,m=x)}(0,br.MX)(p>0,"leftArea"),(0,br.MX)(f<0,"rightArea"),(0,Sa.hs)(Jl,kl,h),(0,Sa.WQ)(Jl,Jl,Hl),(0,Sa.hs)(Yl,kl,u),(0,Sa.WQ)(Yl,Yl,Hl),Xl[0]=-kl[1],Xl[1]=kl[0];const _=(0,br.L)(r,e[m],Yl,(0,Sa.WQ)(ql,Yl,Xl),1,n),v=(0,br.L)(r,e[g],Yl,ql,1,s),y=(0,br.L)(r,e[g],Jl,(0,Sa.WQ)(ql,Jl,Xl),1,a),b=(0,br.L)(r,e[m],Jl,ql,1,o);(0,br.MX)(_,"rayRay"),(0,br.MX)(v,"rayRay"),(0,br.MX)(y,"rayRay"),(0,br.MX)(b,"rayRay")}(Il,o,l,Dl,Ll,Fl,Nl,Vl),function(e,t,i,r,n){(0,Sa.Re)(tc,i,r),(0,Sa.hs)(tc,tc,.5),ic[0]=tc[0],ic[1]=tc[1],ic[2]=0,ic[3]=tc[1],ic[4]=-tc[0],ic[5]=0,ic[6]=tc[0]*tc[0]+tc[1]*tc[1],ic[7]=tc[0]*tc[1]-tc[1]*tc[0],ic[8]=1,ic[$l(0,2)]=-(0,Sa.Om)(ec(ic,0),e),ic[$l(1,2)]=-(0,Sa.Om)(ec(ic,1),e);let s=(0,Sa.Om)(ec(ic,0),i)+ic[$l(0,2)],a=(0,Sa.Om)(ec(ic,1),i)+ic[$l(1,2)],o=(0,Sa.Om)(ec(ic,0),r)+ic[$l(0,2)],l=(0,Sa.Om)(ec(ic,1),r)+ic[$l(1,2)];s=-(s+o)/(a+l),ic[$l(0,0)]+=ic[$l(1,0)]*s,ic[$l(0,1)]+=ic[$l(1,1)]*s,ic[$l(0,2)]+=ic[$l(1,2)]*s,s=1/((0,Sa.Om)(ec(ic,0),i)+ic[$l(0,2)]),a=1/((0,Sa.Om)(ec(ic,1),i)+ic[$l(1,2)]),ic[$l(0,0)]*=s,ic[$l(0,1)]*=s,ic[$l(0,2)]*=s,ic[$l(1,0)]*=a,ic[$l(1,1)]*=a,ic[$l(1,2)]*=a,ic[$l(2,0)]=ic[$l(1,0)],ic[$l(2,1)]=ic[$l(1,1)],ic[$l(2,2)]=ic[$l(1,2)],ic[$l(1,2)]+=1,s=(0,Sa.Om)(ec(ic,1),t)+ic[$l(1,2)],a=(0,Sa.Om)(ec(ic,2),t)+ic[$l(2,2)],o=(0,Sa.Om)(ec(ic,1),i)+ic[$l(1,2)],l=(0,Sa.Om)(ec(ic,2),i)+ic[$l(2,2)],s=-.5*(s/a+o/l),ic[$l(1,0)]+=ic[$l(2,0)]*s,ic[$l(1,1)]+=ic[$l(2,1)]*s,ic[$l(1,2)]+=ic[$l(2,2)]*s,s=(0,Sa.Om)(ec(ic,1),t)+ic[$l(1,2)],a=(0,Sa.Om)(ec(ic,2),t)+ic[$l(2,2)],o=-a/s,ic[$l(1,0)]*=o,ic[$l(1,1)]*=o,ic[$l(1,2)]*=o,n[0]=ic[0],n[1]=ic[1],n[2]=0,n[3]=ic[2],n[4]=ic[3],n[5]=ic[4],n[6]=0,n[7]=ic[5],n[8]=0,n[9]=0,n[10]=1,n[11]=0,n[12]=ic[6],n[13]=ic[7],n[14]=0,n[15]=ic[8]}(Dl,Ll,Nl,Vl,n.projectionMatrix),n.projectionMatrix[10]=2/(i-r),n.projectionMatrix[14]=-(i+r)/(i-r)}(i,r,c,d,n.camera),(0,T.lw)(n.lightMat,n.camera.projectionMatrix,n.camera.viewMatrix);const h=this._textureHeight;n.camera.viewport=[e*h,0,h,h]}_setupMatrices(e,t){(0,T.lw)(this._projectionView,e.projectionMatrix,e.viewMatrix),(0,T.B8)(this._projectionViewInverse,this._projectionView);const i=this._viewingMode===ae.RT.Global?e.eye:(0,M.s)(Gl,0,0,1);(0,T.t5)(this._modelViewLight,[0,0,0],[-t[0],-t[1],-t[2]],i)}_clampNearFar(e){let{near:t,far:i}=e;return t<2&&(t=2),i<2&&(i=2),t>=i&&(t=2,i=4),{near:t,far:i}}_computeCascadeDistances(e,t,i){const r=i?this.settings.maxNumCascadesHighQuality:this.settings.maxNumCascadesLowQuality;this._numCascades=Math.min(1+Math.floor((0,br.kL)(t/e,4)),r);const n=(t-e)/this._numCascades,s=(t/e)**(1/this._numCascades);let a=e,o=e;for(let l=0;l<this._numCascades+1;++l)this._cascadeDistances[l]=(0,U.Cc)(a,o,this.settings.splitSchemeLambda),a*=s,o+=n}get test(){return{cascades:this._cascades,textureHeight:this._textureHeight}}}const Pl=(0,P.vt)(),Ml=(0,L.vt)(),Il=[];for(let QS=0;QS<8;++QS)Il.push((0,L.vt)());const Dl=(0,pr.vt)(),Ll=(0,pr.vt)(),Fl=(0,pr.vt)(),Nl=(0,pr.vt)(),Vl=(0,pr.vt)(),Gl=(0,I.vt)(),Ul=[],zl=(0,P.vt)(),Bl=P.zK.concat(P.zK,P.zK,P.zK,P.zK),Hl=(0,pr.vt)(),jl=(0,pr.vt)(),Wl=[(0,pr.vt)(),(0,pr.vt)(),(0,pr.vt)(),(0,pr.vt)()],kl=(0,pr.vt)(),Zl=(0,pr.vt)(),ql=(0,pr.vt)(),Ql=(0,pr.vt)(),Jl=(0,pr.vt)(),Yl=(0,pr.vt)(),Xl=(0,pr.vt)();function $l(e,t){return 3*t+e}const Kl=(0,pr.vt)();function ec(e,t){return(0,Sa.hZ)(Kl,e[t],e[t+3]),Kl}const tc=(0,pr.vt)(),ic=(0,O.vt)();var rc,nc;!function(e){e[e.OBJECT=0]="OBJECT",e[e.HUD=1]="HUD",e[e.TERRAIN=2]="TERRAIN",e[e.OVERLAY=3]="OVERLAY",e[e.I3S=4]="I3S",e[e.PCL=5]="PCL",e[e.LOD=6]="LOD",e[e.VOXEL=7]="VOXEL",e[e.TILES3D=8]="TILES3D"}(rc||(rc={}));class sc{constructor(){this.verticalOffset=0,this.selectionMode=!1,this.hud=!0,this.selectOpaqueTerrainOnly=!0,this.invisibleTerrain=!1,this.backfacesTerrain=!0,this.isFiltered=!1,this.filteredLayerUids=[],this.store=nc.ALL}}!function(e){e[e.MIN=0]="MIN",e[e.MINMAX=1]="MINMAX",e[e.ALL=2]="ALL"}(nc||(nc={}));class ac{constructor(e,t,i){this.object=e,this.geometryId=t,this.triangleNr=i}}class oc extends ac{constructor(e,t,i,r){super(e,t,i),this.center=null!=r?(0,I.o8)(r):null}}class lc{constructor(e){this.layerUid=e}}class cc extends lc{constructor(e,t){super(e),this.graphicUid=t}}var dc=i(97467),hc=i(5568),uc=i(75762);const pc=()=>a.A.getLogger("esri.views.3d.support.geometryUtils.boundedPlane");const fc=class{constructor(){this.plane=(0,gr.vt)(),this.origin=(0,I.vt)(),this.basis1=(0,I.vt)(),this.basis2=(0,I.vt)()}};function gc(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Dc;return{plane:(0,gr.vt)(e.plane),origin:(0,I.o8)(e.origin),basis1:(0,I.o8)(e.basis1),basis2:(0,I.o8)(e.basis2)}}function mc(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:gc();return _c(e.origin,e.basis1,e.basis2,t)}function _c(e,t,i){let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:gc();return(0,M.c)(r.origin,e),(0,M.c)(r.basis1,t),(0,M.c)(r.basis2,i),vc(r),function(e,t){Math.abs((0,M.j)(e.basis1,e.basis2)/((0,M.l)(e.basis1)*(0,M.l)(e.basis2)))>1e-6&&pc().warn(t,"Provided basis vectors are not perpendicular"),Math.abs((0,M.j)(e.basis1,Oc(e)))>1e-6&&pc().warn(t,"Basis vectors and plane normal are not perpendicular"),Math.abs(-(0,M.j)(Oc(e),e.origin)-e.plane[3])>1e-6&&pc().warn(t,"Plane offset is not consistent with plane origin")}(r,"fromValues()"),r}function vc(e){(0,gr.mR)(e.basis2,e.basis1,e.origin,e.plane)}function yc(e,t,i){e!==i&&mc(e,i);const r=(0,M.h)(uc.rq.get(),Oc(e),t);return(0,M.g)(i.origin,i.origin,r),i.plane[3]-=t,i}function bc(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:gc();const i=(e[2]-e[0])/2,r=(e[3]-e[1])/2;return(0,M.s)(t.origin,e[0]+i,e[1]+r,0),(0,M.s)(t.basis1,i,0,0),(0,M.s)(t.basis2,0,r,0),(0,gr.fA)(0,0,1,0,t.plane),t}function xc(e,t,i){return!!(0,gr.Ui)(e.plane,t,i)&&Tc(e,i)}function Sc(e,t,i){const r=Lc.get();Ic(e,t,r,Lc.get());let n=Number.POSITIVE_INFINITY;for(const s of Gc){const a=Mc(e,s,Fc.get()),o=uc.rq.get();if((0,gr.T7)(r,a,o)){const e=(0,M.D)(uc.rq.get(),t.origin,o),r=Math.abs((0,U.XM)((0,M.j)(t.direction,e)));r<n&&(n=r,(0,M.c)(i,o))}}return n===Number.POSITIVE_INFINITY?wc(e,t,i):i}function wc(e,t,i){if(xc(e,t,i))return i;const r=Lc.get(),n=Lc.get();Ic(e,t,r,n);let s=Number.POSITIVE_INFINITY;for(const a of Gc){const o=Mc(e,a,Fc.get()),l=uc.rq.get();if((0,gr.gv)(r,o,l)){const e=(0,mr.kb)(t,l);if(!(0,gr.Tj)(n,l))continue;e<s&&(s=e,(0,M.c)(i,l))}}return Rc(e,t.origin)<s&&Cc(e,t.origin,i),i}function Cc(e,t,i){const r=(0,gr._I)(e.plane,t,uc.rq.get()),n=(0,Oo.H6)(Pc(e,e.basis1),r,-1,1,uc.rq.get()),s=(0,Oo.H6)(Pc(e,e.basis2),r,-1,1,uc.rq.get());return(0,M.f)(i,(0,M.g)(uc.rq.get(),n,s),e.origin),i}function Ac(e,t,i){const{origin:r,basis1:n,basis2:s}=e,a=(0,M.f)(uc.rq.get(),t,r),o=(0,ho.gr)(n,a),l=(0,ho.gr)(s,a),c=(0,ho.gr)(Oc(e),a);return(0,M.s)(i,o,l,c)}function Rc(e,t){const i=Ac(e,t,uc.rq.get()),{basis1:r,basis2:n}=e,s=(0,M.l)(r),a=(0,M.l)(n),o=Math.max(Math.abs(i[0])-s,0),l=Math.max(Math.abs(i[1])-a,0),c=i[2];return o*o+l*l+c*c}function Ec(e,t){const i=-e.plane[3];return(0,ho.gr)(Oc(e),t)-i}function Oc(e){return(0,gr.Qj)(e.plane)}function Tc(e,t){const i=(0,M.f)(uc.rq.get(),t,e.origin),r=(0,M.o)(e.basis1),n=(0,M.o)(e.basis2),s=(0,M.j)(e.basis1,i),a=(0,M.j)(e.basis2,i);return-s-r<0&&s-r<0&&-a-n<0&&a-n<0}function Pc(e,t){const i=Fc.get();return(0,M.c)(i.origin,e.origin),(0,M.c)(i.vector,t),i}function Mc(e,t,i){const{basis1:r,basis2:n,origin:s}=e,a=(0,M.h)(uc.rq.get(),r,t.origin[0]),o=(0,M.h)(uc.rq.get(),n,t.origin[1]);(0,M.g)(i.origin,a,o),(0,M.g)(i.origin,i.origin,s);const l=(0,M.h)(uc.rq.get(),r,t.direction[0]),c=(0,M.h)(uc.rq.get(),n,t.direction[1]);return(0,M.h)(i.vector,(0,M.g)(l,l,c),2),i}function Ic(e,t,i,r){const n=Oc(e);(0,gr.mR)(n,t.direction,t.origin,i),(0,gr.mR)((0,gr.Qj)(i),n,t.origin,r)}const Dc={plane:(0,gr.vt)(),origin:(0,I.fA)(0,0,0),basis1:(0,I.fA)(1,0,0),basis2:(0,I.fA)(0,1,0)},Lc=new dc.I(gr.vt),Fc=new dc.I(Oo.vt),Nc=(0,I.vt)(),Vc=new dc.I((()=>gc())),Gc=[{origin:[-1,-1],direction:[1,0]},{origin:[1,-1],direction:[0,1]},{origin:[1,1],direction:[-1,0]},{origin:[-1,1],direction:[0,-1]}],Uc=(0,P.vt)(),zc=(0,P.vt)();Object.freeze(Object.defineProperty({__proto__:null,BoundedPlaneClass:fc,altitudeAt:Ec,axisAt:function(e,t,i,r){return function(e,t,i){switch(t){case hc._.X:(0,M.c)(i,e.basis1),(0,M.n)(i,i);break;case hc._.Y:(0,M.c)(i,e.basis2),(0,M.n)(i,i);break;case hc._.Z:(0,M.c)(i,Oc(e))}return i}(e,i,r)},closestPoint:wc,closestPointOnSilhouette:Sc,copy:mc,copyWithoutVerify:function(e,t){(0,M.c)(t.origin,e.origin),(0,M.c)(t.basis1,e.basis1),(0,M.c)(t.basis2,e.basis2),(0,gr.C)(t.plane,e.plane)},create:gc,distance:function(e,t){return Math.sqrt(Rc(e,t))},distance2:Rc,distanceToSilhouette:function(e,t){let i=Number.NEGATIVE_INFINITY;for(const r of Gc){const n=Mc(e,r,Fc.get()),s=(0,Oo.kb)(n,t);s>i&&(i=s)}return Math.sqrt(i)},elevate:yc,equals:function(e,t){return(0,M.i)(e.basis1,t.basis1)&&(0,M.i)(e.basis2,t.basis2)&&(0,M.i)(e.origin,t.origin)},extrusionContainsPoint:function(e,t){return(0,gr.Tj)(e.plane,t)&&Tc(e,t)},fromAABoundingRect:bc,fromValues:_c,intersectRay:xc,intersectRayClosestSilhouette:function(e,t,i){if(xc(e,t,i))return i;const r=Sc(e,t,uc.rq.get());return(0,M.g)(i,t.origin,(0,M.h)(uc.rq.get(),t.direction,(0,M.p)(t.origin,r)/(0,M.l)(t.direction))),i},normal:Oc,projectPoint:Cc,projectPointLocal:Ac,rotate:function(e,t,i,r){return e!==r&&mc(e,r),(0,T.$0)(zc,t,i),(0,M.e)(r.basis1,e.basis1,zc),(0,M.e)(r.basis2,e.basis2,zc),vc(r),r},setAltitudeAt:function(e,t,i,r){const n=Ec(e,t),s=(0,M.h)(Nc,Oc(e),i-n);return(0,M.g)(r,t,s),r},setExtent:function(e,t,i){return bc(t,i),yc(i,Ec(e,e.origin),i),i},transform:function(e,t,i){return e!==i&&mc(e,i),(0,T.B8)(Uc,t),(0,T.mg)(Uc,Uc),(0,M.e)(i.basis1,e.basis1,Uc),(0,M.e)(i.basis2,e.basis2,Uc),(0,M.e)((0,gr.Qj)(i.plane),(0,gr.Qj)(e.plane),Uc),(0,M.e)(i.origin,e.origin,t),(0,gr.mP)(i.plane,i.plane,i.origin),i},up:Dc,updateUnboundedPlane:vc,wrap:function(e,t,i){const r=Vc.get();return r.origin=e,r.basis1=t,r.basis2=i,r.plane=(0,gr.LV)(0,0,0,0),vc(r),r}},Symbol.toStringTag,{value:"Module"}));function Bc(e){return null!=(null===e||void 0===e?void 0:e.dist)}(0,I.vt)();class Hc extends cc{constructor(e,t,i){super(e,t),this.triangleNr=i}}class jc{constructor(){this.adds=new C.A,this.removes=new C.A,this.updates=new C.A({allocator:e=>e||new Wc,deallocator:e=>(e.renderGeometry=null,e)})}clear(){this.adds.clear(),this.removes.clear(),this.updates.clear()}prune(){this.adds.prune(),this.removes.prune(),this.updates.prune()}get empty(){return 0===this.adds.length&&0===this.removes.length&&0===this.updates.length}}class Wc{}class kc{constructor(){this.adds=new Array,this.removes=new Array,this.updates=new Array}}var Zc=i(97974);const qc=1e-5;class Qc{constructor(e){this.options=new sc,this._results=new Xc,this.transform=new Zc.dg,this.tolerance=qc,this.verticalOffset=null,this._ray=(0,mr.vt)(),this._rayEnd=(0,I.vt)(),this._rayBeginTransformed=(0,I.vt)(),this._rayEndTransformed=(0,I.vt)(),this.viewingMode=null!==e&&void 0!==e?e:ae.RT.Global}get results(){return this._results}get ray(){return this._ray}get rayBegin(){return this._ray.origin}get rayEnd(){return this._rayEnd}reset(e,t,i){this.resetWithRay((0,mr.Cr)(e,t,this._ray),i)}resetWithRay(e,t){this.camera=t,e!==this._ray&&(0,mr.C)(e,this._ray),0!==this.options.verticalOffset?this.viewingMode===ae.RT.Local?this._ray.origin[2]-=this.options.verticalOffset:this.verticalOffset=this.options.verticalOffset:this.verticalOffset=null,(0,M.g)(this._rayEnd,this._ray.origin,this._ray.direction),this._results.init(this._ray)}intersect(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1?arguments[1]:void 0,i=arguments.length>2?arguments[2]:void 0,r=arguments.length>3?arguments[3]:void 0,n=arguments.length>4?arguments[4]:void 0;this.point=t,this.filterPredicate=r,this.tolerance=null!==i&&void 0!==i?i:qc;const s=(0,Zc.ou)(this.verticalOffset);if(e&&e.length>0){const t=n?e=>{n(e)&&this.intersectObject(e)}:e=>{this.intersectObject(e)};for(const i of e){var a;const e=null===(a=i.getSpatialQueryAccelerator)||void 0===a?void 0:a.call(i);null!=e?(null!=s?e.forEachAlongRayWithVerticalOffset(this._ray.origin,this._ray.direction,t,s):e.forEachAlongRay(this._ray.origin,this._ray.direction,t),this.options.selectionMode&&this.options.hud&&e.forEachDegenerateObject(t)):i.objects.forAll((e=>t(e)))}}this.sortResults()}intersectObject(e){const t=e.geometries;if(!t)return;const i=e.effectiveTransformation,r=(0,Zc.ou)(this.verticalOffset);for(const n of t){if(!n.visible)continue;const{material:t,id:s}=n;this.transform.setAndInvalidateLazyTransforms(i,n.transformation),(0,M.e)(this._rayBeginTransformed,this.rayBegin,this.transform.inverse),(0,M.e)(this._rayEndTransformed,this.rayEnd,this.transform.inverse);const a=this.transform.transform;null!=r&&(r.objectTransform=this.transform),t.intersect(n,this.transform.transform,this,this._rayBeginTransformed,this._rayEndTransformed,((t,i,r,n,o,l)=>{if(t>=0){if(null!=this.filterPredicate&&!this.filterPredicate(this._ray.origin,this._rayEnd,t))return;const c=n?this._results.hud:this._results,d=n?n=>{const a=new oc(e,s,r,l);n.set(rc.HUD,a,t,i,P.zK,o)}:n=>n.set(rc.OBJECT,{object:e,geometryId:s,triangleNr:r},t,i,a,o);if((null==c.min.drapedLayerOrder||o>=c.min.drapedLayerOrder)&&(null==c.min.dist||t<c.min.dist)&&d(c.min),this.options.store!==nc.MIN&&(null==c.max.drapedLayerOrder||o<c.max.drapedLayerOrder)&&(null==c.max.dist||t>c.max.dist)&&d(c.max),this.options.store===nc.ALL)if(n){const e=new Kc(this._ray);d(e),this._results.hud.all.push(e)}else{const e=new $c(this._ray);d(e),this._results.all.push(e)}}}))}}sortResults(){(arguments.length>0&&void 0!==arguments[0]?arguments[0]:this._results.all).sort(((e,t)=>{var i,r;return e.dist!==t.dist?(null!==(i=e.dist)&&void 0!==i?i:0)-(null!==(r=t.dist)&&void 0!==r?r:0):e.drapedLayerOrder!==t.drapedLayerOrder?Jc(e.drapedLayerOrder,t.drapedLayerOrder):Jc(e.drapedLayerGraphicOrder,t.drapedLayerGraphicOrder)}))}}function Jc(e,t){return(null!==t&&void 0!==t?t:-Number.MAX_VALUE)-(null!==e&&void 0!==e?e:-Number.MAX_VALUE)}function Yc(e){return new Qc(e)}class Xc{constructor(){this.min=new $c((0,mr.vt)()),this.max=new $c((0,mr.vt)()),this.hud={min:new Kc((0,mr.vt)()),max:new Kc((0,mr.vt)()),all:new Array},this.ground=new $c((0,mr.vt)()),this.all=[]}init(e){this.min.init(e),this.max.init(e),this.ground.init(e),this.all.length=0,this.hud.min.init(e),this.hud.max.init(e),this.hud.all.length=0}}class $c{get ray(){return this._ray}get distanceInRenderSpace(){return null!=this.dist?((0,M.h)(td,this.ray.direction,this.dist),(0,M.l)(td)):null}getIntersectionPoint(e){return!!Bc(this)&&((0,M.h)(td,this.ray.direction,this.dist),(0,M.g)(e,this.ray.origin,td),!0)}getTransformedNormal(e){return(0,M.c)(id,this.normal),id[3]=0,(0,D.t)(id,id,this.transformation),(0,M.c)(e,id),(0,M.n)(e,e)}constructor(e){this.intersector=rc.OBJECT,this.normal=(0,I.vt)(),this.transformation=(0,P.vt)(),this._ray=(0,mr.vt)(),this.init(e)}init(e){this.dist=null,this.target=null,this.drapedLayerOrder=null,this.drapedLayerGraphicOrder=null,this.intersector=rc.OBJECT,(0,mr.C)(e,this._ray)}set(e,t,i,r,n,s,a){this.intersector=e,this.dist=i,(0,M.c)(this.normal,null!==r&&void 0!==r?r:I.Cb),(0,T.C)(this.transformation,null!==n&&void 0!==n?n:P.zK),this.target=t,this.drapedLayerOrder=s,this.drapedLayerGraphicOrder=a}copy(e){(0,mr.C)(e.ray,this._ray),this.intersector=e.intersector,this.dist=e.dist,this.target=e.target,this.drapedLayerOrder=e.drapedLayerOrder,this.drapedLayerGraphicOrder=e.drapedLayerGraphicOrder,(0,M.c)(this.normal,e.normal),(0,T.C)(this.transformation,e.transformation)}}class Kc extends $c{constructor(){super(...arguments),this.intersector=rc.HUD}}function ed(e){return new $c(e)}const td=(0,I.vt)(),id=(0,L.vt)();var rd,nd,sd;function ad(e){return e.geometry.indexCount>=1}!function(e){e[e.ADD=0]="ADD",e[e.UPDATE=1]="UPDATE",e[e.REMOVE=2]="REMOVE"}(rd||(rd={})),function(e){e[e.NONE=0]="NONE",e[e.VISIBILITY=1]="VISIBILITY",e[e.GEOMETRY=2]="GEOMETRY",e[e.TRANSFORMATION=4]="TRANSFORMATION",e[e.HIGHLIGHT=8]="HIGHLIGHT",e[e.OCCLUDEE=16]="OCCLUDEE"}(nd||(nd={})),function(e){e[e.Default=0]="Default",e[e.Screenshot=1]="Screenshot",e[e.ObjectAndLayerID=2]="ObjectAndLayerID"}(sd||(sd={}));var od=i(57481);class ld{constructor(e,t){this._material=e,this._repository=t,this._map=new Map}dispose(){this._map.forEach(((e,t)=>{null!=e&&this._repository.release(this._material,t)}))}load(e,t,i){const r=this._material.produces.get(t);if(!r||!r(i))return null;this._map.has(i)||this._map.set(i,this._repository.acquire(this._material,t,i));const n=this._map.get(i);if(null!=n){if(n.ensureResources(e)===fe.Am.LOADED)return n;this._repository.requestRender()}return null}}class cd extends Xa.gy{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,I.vt)();super(),this.origin=e,this.slicePlaneLocalOrigin=this.origin}}class dd{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;this.from=e,this.to=t}get numElements(){return this.to-this.from}}function hd(e){const t=new Map;e.forAll((e=>t.set(e.from,e)));let i=!0;for(;i;){i=!1;for(let r=0;r<e.length;++r){const n=e.data[r],s=t.get(n.to);if(!s)return;n.to=s.to,t.delete(s.from),e.removeUnordered(s),i=!0}}}class ud extends dd{constructor(e,t,i){super(t,i),this.geometry=e}get isVisible(){return this.geometry.visible}get hasHighlights(){return null!=this.geometry.highlights&&this.isVisible}get hasOccludees(){return null!=this.geometry.occludees}}class pd{constructor(){this.first=0,this.count=0}}class fd{constructor(){this._numElements=0,this._instances=new Map,this.holes=new C.A({allocator:e=>e||new dd,deallocator:null}),this.hasHiddenInstances=!1,this.hasHighlights=!1,this.hasOccludees=!1,this.drawCommandsDirty=!0,this.drawCommandsDefault=gd(),this.drawCommandsHighlight=gd(),this.drawCommandsOccludees=gd(),this.drawCommandsShadowHighlightRest=gd()}get numElements(){return this._numElements}get instances(){return this._instances}addInstance(e,t){this.deleteInstance(e),this._instances.set(e,t),this._numElements+=t.numElements}deleteInstance(e){const t=this._instances.get(e);t&&(this._numElements-=t.numElements,this._instances.delete(e))}updateInstance(e,t,i){const r=this._instances.get(e);r&&(this._numElements-=r.numElements,r.from=t,r.to=i,this._numElements+=r.numElements)}updateDrawState(e){e.isVisible?(e.hasHighlights&&(this.hasHighlights=!0),e.hasOccludees&&(this.hasOccludees=!0)):this.hasHiddenInstances=!0}updateDrawCommands(e){if(this.drawCommandsDefault.clear(),this.drawCommandsHighlight.clear(),this.drawCommandsOccludees.clear(),this.drawCommandsShadowHighlightRest.clear(),this.drawCommandsDirty=!1,0===this._instances.size)return;if(!this.needsMultipleCommands()){const t=this.drawCommandsDefault.pushNew(),i=this.holes.front();return null!=this.vao&&1===this.holes.length&&i.to===Math.floor(this.vao.byteSize/e)?(t.first=0,void(t.count=i.from)):(t.first=1/0,t.count=0,this._instances.forEach((e=>{t.first=Math.min(t.first,e.from),t.count=Math.max(t.count,e.to)})),void(t.count-=t.first))}const t=Array.from(this._instances.values()).sort(((e,t)=>e.from===t.from?e.to-t.to:e.from-t.from));for(const i of t)i.isVisible&&(md(i.hasOccludees?this.drawCommandsOccludees:this.drawCommandsDefault,i),md(i.hasHighlights?this.drawCommandsHighlight:this.drawCommandsShadowHighlightRest,i))}needsMultipleCommands(){return this.hasOccludees||this.hasHighlights||this.hasHiddenInstances}}function gd(){return new C.A({allocator:e=>e||new pd,deallocator:e=>e})}function md(e,t){const i=e.back();if(null==i){const i=e.pushNew();return i.first=t.from,void(i.count=t.numElements)}if(function(e,t){return e.first+e.count>=t.from}(i,t)){const e=t.from-i.first+t.numElements;i.count=e}else{const i=e.pushNew();i.first=t.from,i.count=t.numElements}}class _d{constructor(e){this.origin=e,this.buffers=new Array}dispose(){this.buffers.forEach((e=>e.vao.dispose())),this.buffers.length=0}findBuffer(e){return this.buffers.find((t=>t.instances.has(e)))}}class vd{constructor(e,t){this._cache=e(t,((e,t,i)=>this._remove(e,t,i)))}hitrate(){return this._cache.hitRate}destroy(){this._cache.destroy()}clear(){this._cache.clear()}getSize(e){return this._cache.getSize(e)}pop(e){const t=this._cache.peek(e);if(!t)return;const i=t.pop();if(t.length>0){if(i){const r=this._cache.getSize(e)-Math.round(i.usedMemory);this._cache.updateSize(e,t,r)}}else this._cache.pop(e);return i}put(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:ce.Cn;const r=this._cache.peek(e);if(!r)return void this._cache.put(e,[t],t.usedMemory,i);r.push(t);const n=this._cache.getSize(e)+Math.round(t.usedMemory);this._cache.updateSize(e,r,n)}_remove(e,t,i){switch(t){case ce.k2.ALL:return e.forEach((e=>e.dispose())),0;case ce.k2.SOME:{const t=e.shift();return t&&(i-=Math.round(t.usedMemory),t.dispose()),i}}}}var yd=i(36911);class bd extends yd.Z{}var xd=i(76718);class Sd{constructor(e,t,i){this._rctx=e,this._locations=t,this._layout=i,this._cache=new vd(e.newCache,"VAOCache")}dispose(){this._cache.destroy()}newVao(e){const t=e.toString();let i=this._cache.pop(t);return i||(i=new bd(this._rctx,this._locations,{geometry:this._layout},{geometry:xd.g.createVertex(this._rctx,ft._U.STATIC_DRAW)}),i.vertexBuffers.geometry.setSize(e),i)}deleteVao(e){if(null==e)return;const t=e.byteSize.toString();this._cache.put(t,e)}}let wd=class extends co.Ot{constructor(e){super(e),this._vaoCache=null,this._glMaterials=null,this._bufferWriter=null,this._dataByOrigin=new Map,this._hasHighlights=!1,this._hasOccludees=!1,this._produces=new Map,this.drapedPriority=0}destroy(){this._glMaterials=(0,le.WD)(this._glMaterials),this._dataByOrigin.forEach((e=>e.dispose())),this._dataByOrigin.clear(),this._vaoCache=(0,le.WD)(this._vaoCache)}initialize(){this.material.produces.forEach(((e,t)=>{this._produces.set(t,(t=>!(0===this._dataByOrigin.size||!(t!==ks.V.Highlight&&t!==ks.V.ShadowHighlight||this._hasHighlights))&&e(t)))}))}get produces(){return this._produces}initializeRenderContext(e,t){const{rctx:i}=e.renderContext;this._glMaterials=new ld(this.material,null!==t&&void 0!==t?t:e.materialRepository),this._bufferWriter=this.material.createBufferWriter(),this._vaoCache=new Sd(i,this.material.vertexAttributeLocations,(0,od.U)(this._bufferWriter.vertexBufferLayout))}uninitializeRenderContext(){}get hasOccludees(){return this._hasOccludees}get isDecoration(){return this.material.parameters.isDecoration}queryRenderOccludedState(e){return this.material.queryRenderOccludedState(e)}get materialReference(){return this.material}get numGeometries(){let e=0;return this._dataByOrigin.forEach((t=>e+=t.buffers.reduce(((e,t)=>e+t.instances.size),0))),e}get usedMemory(){let e=0;return this._dataByOrigin.forEach((t=>e+=t.buffers.reduce(((e,t)=>e+t.vao.usedMemory),0))),e}forEachGeometry(e){this._dataByOrigin.forEach((t=>t.buffers.forEach((t=>t.instances.forEach((t=>e(t.geometry)))))))}modify(e){this._updateGeometries(e.updates),this._addAndRemoveGeometries(e.adds,e.removes),this._updateDrawCommands()}_updateGeometries(e){const t=this._bufferWriter;if(null===t)return;const i=t.vertexBufferLayout.stride/4;for(const r of e){const e=r.renderGeometry,n=this._dataByOrigin.get(e.localOrigin.id),s=null===n||void 0===n?void 0:n.findBuffer(e.id);if(null==s)return;const a=s.instances.get(e.id);if(r.updateType&(nd.GEOMETRY|nd.TRANSFORMATION)){const r=Nd(t.elementCount(a.geometry.geometry)*i),n=t.vertexBufferLayout.createView(r.buffer);this._writeGeometry(e,n,0),s.vao.vertexBuffers.geometry.setSubData(r,a.from*i,0,a.numElements*i)}r.updateType&(nd.HIGHLIGHT|nd.OCCLUDEE|nd.VISIBILITY)&&(s.drawCommandsDirty=!0)}}_computeDeltas(e,t){const i=new ro.O;for(const r of e){const e=r.localOrigin;if(null==e)continue;let t=i.get(e.id,null);null==t&&(t=new Cd(e.vec3),i.set(e.id,null,t)),t.changes.push(r)}for(const r of t){const e=r.localOrigin;if(null==e)continue;const t=this._dataByOrigin.get(e.id),n=null===t||void 0===t?void 0:t.findBuffer(r.id);if(null==n)continue;let s=i.get(e.id,n);null==s&&(s=new Cd(e.vec3),i.set(e.id,n,s)),s.changes.push(r)}return i}_addAndRemoveGeometries(e,t){if(null===this._bufferWriter||null===this._vaoCache)return;const{_bufferWriter:i,_dataByOrigin:r}=this,n=i.vertexBufferLayout.stride/4,s=this._computeDeltas(e,t);s.forEach(((e,t)=>{const a=e.get(null),o=null!=a?a.changes:[];s.delete(t,null);let l=r.get(t);if(e.forEach(((e,a)=>{if(s.delete(t,a),null==a)return void(0,br.vA)(!1,"No VAO for removed geometries");if(a.instances.size===e.changes.length)return this._vaoCache.deleteVao(a.vao),(0,b.Xy)(l.buffers,a),void(0===l.buffers.length&&0===o.length&&r.delete(t));const c=a.numElements,d=a.vao.byteSize/4,h=o.reduce(((e,t)=>e+i.elementCount(t.geometry)),0),u=e.changes.reduce(((e,t)=>e+i.elementCount(t.geometry)),0),p=Math.min((c+h-u)*n,Ld),f=p>d;p>Pd&&p<d/2?(e.changes.forEach((e=>{let{id:t}=e;return a.deleteInstance(t)})),a.instances.forEach((e=>{let{geometry:t}=e;return o.push(t)})),this._vaoCache.deleteVao(a.vao),(0,b.Xy)(l.buffers,a)):f?this._applyAndRebuild(a,o,e):this._applyRemoves(a,e)})),o.length>0)for(null==l&&(l=new _d(a.origin),r.set(t,l)),l.buffers.forEach((e=>this._applyAdds(e,o)));o.length>0;)l.buffers.push(this._applyAndRebuild(new fd,o,null))}))}_updateDrawCommands(){this._hasHighlights=!1,this._hasOccludees=!1,this._dataByOrigin.forEach((e=>{e.buffers.forEach((e=>{e.drawCommandsDirty&&(e.hasHiddenInstances=!1,e.hasHighlights=!1,e.hasOccludees=!1,(0,Ui.Bs)(e.instances,(t=>(e.updateDrawState(t),e.hasHiddenInstances&&e.hasHighlights&&e.hasOccludees))),e.updateDrawCommands(this._bufferWriter.vertexBufferLayout.stride)),this._hasHighlights=this._hasHighlights||e.hasHighlights,this._hasOccludees=this._hasOccludees||e.hasOccludees}))}))}_applyAndRebuild(e,t,i){if(null!=i)for(const p of i.changes)e.deleteInstance(p.id);const r=this._bufferWriter,n=r.vertexBufferLayout.stride,s=n/4,a=Math.floor(Ld/s);let o=e.numElements;for(;t.length>0;){const i=t.pop(),n=r.elementCount(i.geometry);if(o+n>a&&o>0){t.push(i);break}o+=n;const s=new ud(i,0,0);(0,br.vA)(null==e.instances.get(i.id)),e.addInstance(i.id,s)}const l=o*s,c=Nd(l),d=r.vertexBufferLayout.createView(c.buffer);let h=0;e.hasHiddenInstances=!1,e.hasHighlights=!1,e.hasOccludees=!1,e.instances.forEach(((t,i)=>{this._writeGeometry(t.geometry,d,h);const n=h;h+=r.elementCount(t.geometry.geometry),e.updateInstance(i,n,h),e.updateDrawState(t)})),this._vaoCache.deleteVao(e.vao),e.vao=this._vaoCache.newVao(Vd(l)),e.vao.vertexBuffers.geometry.setSubData(c,0,0,h*s),e.holes.clear();const u=e.holes.pushNew();return u.from=h,u.to=Math.floor(e.vao.byteSize/n),e.updateDrawCommands(n),e}_applyRemoves(e,t){if(0===t.changes.length||null===this._bufferWriter)return;for(const a of t.changes){const t=a.id,i=e.instances.get(t);if(!i)continue;e.deleteInstance(t);const r=Td.back();if(r){if(r.to===i.from){r.to=i.to;continue}if(r.from===i.to){r.from=i.from;continue}}const n=Td.pushNew();n.from=i.from,n.to=i.to}hd(Td);const i=this._bufferWriter.vertexBufferLayout.stride/4,r=Td.reduce(((e,t)=>Math.max(e,t.numElements)),0)*i,n=Nd(r);n.fill(0,0,r);const s=e.vao.vertexBuffers.geometry;Td.forAll((e=>s.setSubData(n,e.from*i,0,e.numElements*i))),e.holes.pushArray(Td.data,Td.length),Td.forAll(((e,t)=>Td.data[t]=null)),Td.clear(),e.drawCommandsDirty=!0}_applyAdds(e,t){if(0===t.length||null===this._bufferWriter)return;if(!function(e){return null!=e.vao}(e))return void this._applyAndRebuild(e,t,null);const i=this._bufferWriter,r=i.vertexBufferLayout.stride/4,n=e.numElements,s=t.reduce(((e,t)=>e+i.elementCount(t.geometry)),0),a=Math.min((n+s)*r,Ld),o=4*a;if(e.vao.byteSize<Vd(Ld-Pd)&&o>e.vao.byteSize)return void this._applyAndRebuild(e,t,null);hd(e.holes);const l=new Array;for(const m of t){const t=i.elementCount(m.geometry),r=Ad(e.holes,t);l.push(r)}const c=e.vao.vertexBuffers.geometry;let d=0,h=0,u=0;const p=Nd(a),f=i.vertexBufferLayout.createView(p.buffer);t.forEach(((t,n)=>{const s=l[n];if(null==s)return;if(u!==s){const e=u-h;e>0&&c.setSubData(p,h*r,0,e*r),h=s,d=0}const a=i.elementCount(t.geometry);this._writeGeometry(t,f,d),d+=a,u=s+a;const o=new ud(t,s,s+a);(0,br.vA)(null==e.instances.get(t.id)),e.addInstance(t.id,o),e.drawCommandsDirty=!0}));const g=u-h;g>0&&c.setSubData(p,h*r,0,g*r),(0,b.$i)(t,((e,t)=>null==l[t]))}_writeGeometry(e,t,i){if(null===this._bufferWriter)return;const r=e.localOrigin.vec3;(0,br.M_)(Rd,-r[0],-r[1],-r[2]);const n=(0,T.lw)(Ed,Rd,e.transformation);(0,T.B8)(Od,n),(0,T.mg)(Od,Od),this._bufferWriter.write(n,Od,e.geometry,t,i)}updateAnimation(e){return this.material.update(e)}prepareTechnique(e){if(!this.material.shouldRender(e))return null;const{output:t,bindParameters:i}=e,r=this.material.produces.get(i.slot);if(!r||!r(t))return null;const n=t===ks.V.Highlight||t===ks.V.ShadowHighlight;if(n&&!this._hasHighlights)return null;const s=t===ks.V.ShadowExcludeHighlight,a=!(n||s);for(const o of this._dataByOrigin.values())for(const r of o.buffers){if(n&&!r.hasHighlights)continue;const o=(n?r.drawCommandsHighlight:s&&r.needsMultipleCommands()?r.drawCommandsShadowHighlightRest:r.drawCommandsDefault)||null,l=a&&r.drawCommandsOccludees||null;if(null!==o&&void 0!==o&&o.length||null!==l&&void 0!==l&&l.length){const r=this._glMaterials.load(e.rctx,i.slot,t),n=null!=r?r.beginSlot(i):null;if(null!=n)return n}}return null}renderNode(e,t){const{output:i,bindParameters:r}=e,n=i===ks.V.Highlight||i===ks.V.ShadowHighlight,s=i===ks.V.ShadowExcludeHighlight,a=!(n||s),o=e.rctx,l=e.bindParameters.slot===Qs.N.OCCLUDER_MATERIAL,c=e.bindParameters.slot===Qs.N.TRANSPARENT_OCCLUDER_MATERIAL;o.runAppleAmdDriverHelper(),o.bindTechnique(t,r,this.material.parameters);for(const d of this._dataByOrigin.values())for(const e of d.buffers){if(n&&!e.hasHighlights)continue;const i=(n?e.drawCommandsHighlight:s&&e.needsMultipleCommands()?e.drawCommandsShadowHighlightRest:e.drawCommandsDefault)||null,h=a&&e.drawCommandsOccludees||null;(null!==i&&void 0!==i&&i.length||null!==h&&void 0!==h&&h.length)&&(t.program.bindDraw(new cd(d.origin),r,this.material.parameters),t.ensureAttributeLocations(e.vao),o.bindVAO(e.vao),null!==i&&void 0!==i&&i.length&&(o.setPipelineState(t.getPipeline(!1,l,c)),i.forAll((e=>o.drawArrays(t.primitiveType,e.first,e.count)))),(null===h||void 0===h?void 0:h.length)&&(o.setPipelineState(t.getPipeline(!0,l,c)),h.forAll((e=>o.drawArrays(t.primitiveType,e.first,e.count)))))}}get test(){return{material:this.material,glMaterials:this._glMaterials,dataByOrigin:this._dataByOrigin}}};(0,r._)([(0,d.MZ)({constructOnly:!0})],wd.prototype,"material",void 0),wd=(0,r._)([(0,u.$)("esri.views.3d.webgl-engine.materials.renderers.MergedRenderer")],wd);class Cd{constructor(e){this.origin=e,this.changes=new Array}}function Ad(e,t){let i;if(!e.some((e=>!(e.numElements<t)&&(i=e,!0))))return null;const r=i.from;return i.from+=t,i.from>=i.to&&e.removeUnordered(i),r}const Rd=(0,P.vt)(),Ed=(0,P.vt)(),Od=(0,P.vt)(),Td=new C.A({allocator:e=>e||new dd,deallocator:null}),Pd=65536,Md=4*Pd,Id=1024,Dd=16777216,Ld=Dd/4;let Fd=new Float32Array(Pd);function Nd(e){return Fd.length<e&&(Fd=new Float32Array(e)),Fd}function Vd(e){const t=4*e;return t<=Id?Id:t<Md?(0,U.cU)(t):Math.max(Math.min(Math.ceil(1.5*t/Md)*Md,Dd),t)}let Gd=class extends s.A{constructor(e){super(e),this._pending=new Ud,this._changes=new jc,this._materialRenderers=new C.A,this._sortedMaterialRenderers=new C.A,this._geometries=new Map,this._hasHighlights=!1,this._hasWater=!1}destroy(){this._changes.prune(),this._materialRenderers.forAll((e=>e.destroy())),this._materialRenderers.clear(),this._sortedMaterialRenderers.clear(),this._geometries.clear(),this._pending.clear()}get updating(){return!this._pending.empty||this._changes.updates.length>0}get rctx(){return this.rendererContext.rctx}get _materialRepository(){return this.rendererContext.materialRepository}get _localOriginFactory(){return this.rendererContext.localOriginFactory}get hasHighlights(){return this._hasHighlights}get hasWater(){return this._hasWater}get rendersOccludedDraped(){return this._materialRenderers.some((e=>0!==e.numGeometries&&!e.queryRenderOccludedState(qs.m$.Occlude)))}get isEmpty(){return!this.updating&&0===this._materialRenderers.length&&0===this._geometries.size}getMemoryForMaterial(e){var t;if(null==e)return 0;const i=this._materialRenderers.find((t=>t.materialReference===e));return null!==(t=null===i||void 0===i?void 0:i.usedMemory)&&void 0!==t?t:0}commitChanges(){if(!this.updating)return!1;this._processAddsRemoves();const e=function(e){const t=new Map,i=e=>{let i=t.get(e);return i||(i=new kc,t.set(e,i)),i};return e.removes.forAll((e=>{ad(e)&&i(e.material).removes.push(e)})),e.adds.forAll((e=>{ad(e)&&i(e.material).adds.push(e)})),e.updates.forAll((e=>{ad(e.renderGeometry)&&i(e.renderGeometry.material).updates.push(e)})),t}(this._changes);let t=!1;return e.forEach(((e,i)=>{let r=this._materialRenderers.find((e=>e.materialReference===i));if(!r&&e.adds.length>0){const e=new wd({material:i});e.initializeRenderContext(this.rendererContext.pluginContext,this._materialRepository),r=e,this._materialRenderers.push(r),t=!0}r&&(r.modify(e),0===r.numGeometries&&(this._materialRenderers.removeUnordered(r),r.destroy(),t=!0))})),this._changes.clear(),t&&this._updateSortedMaterialRenderers(),this._hasHighlights=this._materialRenderers.some((e=>{const t=e.produces.get(Qs.N.DRAPED_MATERIAL);return!!t&&t(ks.V.Highlight)})),this._hasWater=this._materialRenderers.some((e=>{const t=e.produces.get(Qs.N.DRAPED_WATER);return!!t&&t(ks.V.Normal)})),this.notifyChange("updating"),!0}addGeometries(e,t){if(0===e.length)return;const i=this._validateRenderGeometries(e);for(const n of i)this._geometries.set(n.id,n);const r=this._pending.empty;for(const n of i)this._pending.adds.add(n);r&&this.notifyChange("updating"),t===rd.UPDATE&&this._notifyGraphicGeometryChanged(e)}removeGeometries(e,t){const i=this._pending.empty,r=this._pending.adds;for(const n of e)r.has(n)?(this._pending.removed.add(n),r.delete(n)):this._pending.removed.has(n)||this._pending.removes.add(n),this._geometries.delete(n.id);i&&!this._pending.empty&&this.notifyChange("updating"),t===rd.UPDATE&&this._notifyGraphicGeometryChanged(e)}modifyGeometries(e,t){const i=0===this._changes.updates.length;for(const r of e){const e=this._changes.updates.pushNew();e.renderGeometry=this._validateRenderGeometry(r),e.updateType=t}switch(i&&this._changes.updates.length>0&&this.notifyChange("updating"),t){case nd.TRANSFORMATION:case nd.GEOMETRY:return this._notifyGraphicGeometryChanged(e);case nd.VISIBILITY:return this._notifyGraphicVisibilityChanged(e)}}updateAnimation(e){let t=!1;return this._sortedMaterialRenderers.forAll((i=>t=!!i.updateAnimation&&i.updateAnimation(e)||t)),t}shouldRender(e){return this._sortedMaterialRenderers.some((t=>t.prepareTechnique(e)))}render(e){this._sortedMaterialRenderers.forAll((t=>{const i=t.prepareTechnique(e);null!=i&&t.renderNode(e,i)}))}intersect(e,t,i,r,n){return this._geometries.forEach((s=>{if(r&&!r(s))return;this._intersectRenderGeometry(s,i,t,0,e,n);const a=this.rendererContext.longitudeCyclical;a&&(s.boundingSphere[0]-s.boundingSphere[3]<a.min&&this._intersectRenderGeometry(s,i,t,a.range,e,n),s.boundingSphere[0]+s.boundingSphere[3]>a.max&&this._intersectRenderGeometry(s,i,t,-a.range,e,n)),n++})),n}_updateSortedMaterialRenderers(){this._sortedMaterialRenderers.clear(),this._materialRenderers.forAll(((e,t)=>{e.drapedPriority=t,this._sortedMaterialRenderers.push(e)})),this._sortedMaterialRenderers.sort(((e,t)=>{var i,r,n,s;return(null===(i=t.materialReference)||void 0===i?void 0:i.renderPriority)===(null===(r=e.materialReference)||void 0===r?void 0:r.renderPriority)?e.drapedPriority-t.drapedPriority:((null===(n=t.materialReference)||void 0===n?void 0:n.renderPriority)||0)-((null===(s=e.materialReference)||void 0===s?void 0:s.renderPriority)||0)}))}_processAddsRemoves(){this._changes.adds.clear(),this._changes.removes.clear(),this._changes.adds.pushArray(Array.from(this._pending.adds)),this._changes.removes.pushArray(Array.from(this._pending.removes));for(let e=0;e<this._changes.updates.length;){const t=this._changes.updates.data[e];this._pending.has(t.renderGeometry)?this._changes.updates.removeUnorderedIndex(e):e++}this._pending.clear()}_intersectRenderGeometry(e,t,i,r,n,s){if(!e.visible)return;let a=0;r+=e.transformation[12],a=e.transformation[13],zd[0]=i[0]-r,zd[1]=i[1]-a,e.screenToWorldRatio=this.rendererContext.screenToWorldRatio,e.material.intersectDraped(e,null,n,zd,((i,r,a)=>{!function(e,t,i,r,n,s,a){const o=new Hc(s,a,t),l=t=>{t.set(rc.OVERLAY,o,e.dist,e.normal,e.transformation,i,r)};if((null==n.results.min.drapedLayerOrder||i>=n.results.min.drapedLayerOrder)&&(null==n.results.min.dist||n.results.ground.dist<=n.results.min.dist)&&l(n.results.min),n.options.store!==nc.MIN&&(null==n.results.max.drapedLayerOrder||i<n.results.max.drapedLayerOrder)&&(null==n.results.max.dist||n.results.ground.dist>n.results.max.dist)&&l(n.results.max),n.options.store===nc.ALL){const e=ed(n.ray);l(e),n.results.all.push(e)}}(t,a,s,e.material.renderPriority,n,e.layerUid,e.graphicUid)}),t)}_notifyGraphicGeometryChanged(e){if(null==this.drapeSource.notifyGraphicGeometryChanged)return;let t;for(const i of e){const e=i.graphicUid;null!=e&&e!==t&&(this.drapeSource.notifyGraphicGeometryChanged(e),t=e)}}_notifyGraphicVisibilityChanged(e){if(null==this.drapeSource.notifyGraphicVisibilityChanged)return;let t;for(const i of e){const e=i.graphicUid;null!=e&&e!==t&&(this.drapeSource.notifyGraphicVisibilityChanged(e),t=e)}}_validateRenderGeometries(e){for(const t of e)this._validateRenderGeometry(t);return e}_validateRenderGeometry(e){return null==e.localOrigin&&(e.localOrigin=this._localOriginFactory.getOrigin((0,$.g)(e.boundingSphere))),e}get test(){return{sortedMaterialRenderers:this._sortedMaterialRenderers}}};(0,r._)([(0,d.MZ)()],Gd.prototype,"drapeSource",void 0),(0,r._)([(0,d.MZ)()],Gd.prototype,"updating",null),(0,r._)([(0,d.MZ)()],Gd.prototype,"rctx",null),(0,r._)([(0,d.MZ)({constructOnly:!0})],Gd.prototype,"rendererContext",void 0),(0,r._)([(0,d.MZ)()],Gd.prototype,"_materialRepository",null),(0,r._)([(0,d.MZ)()],Gd.prototype,"_localOriginFactory",null),(0,r._)([(0,d.MZ)({readOnly:!0})],Gd.prototype,"isEmpty",null),(0,r._)([(0,d.MZ)()],Gd.prototype,"_materialRenderers",void 0),(0,r._)([(0,d.MZ)()],Gd.prototype,"_geometries",void 0),Gd=(0,r._)([(0,u.$)("esri.views.3d.webgl-engine.lib.SortedRenderGeometryRenderer")],Gd);class Ud{constructor(){this.adds=new Set,this.removes=new Set,this.removed=new Set}get empty(){return 0===this.adds.size&&0===this.removes.size&&0===this.removed.size}has(e){return this.adds.has(e)||this.removes.has(e)||this.removed.has(e)}clear(){this.adds.clear(),this.removes.clear(),this.removed.clear()}}const zd=(0,pr.vt)();class Bd extends Xs.w{initializeProgram(e){return new Ks.B(e.rctx,Bd.shader.get().build(),$s.D)}initializePipeline(){return this.configuration.hasAlpha?(0,ta.Ey)({blending:(0,ta.p3)(ft.dn.SRC_ALPHA,ft.dn.ONE,ft.dn.ONE_MINUS_SRC_ALPHA,ft.dn.ONE_MINUS_SRC_ALPHA),colorWrite:ta.wE}):(0,ta.Ey)({colorWrite:ta.wE})}}Bd.shader=new Ys.$(io.a,(()=>i.e(2553).then(i.bind(i,62553))));class Hd extends ra.K{constructor(){super(...arguments),this.hasAlpha=!1}}(0,r._)([(0,ra.W)()],Hd.prototype,"hasAlpha",void 0);var jd=i(71011),Wd=i(80381);class kd extends Xs.w{initializeProgram(e){return new Ks.B(e.rctx,kd.shader.get().build(),$s.D)}initializePipeline(){return(0,ta.Ey)({blending:(0,ta.ox)(ft.dn.ONE,ft.dn.ONE_MINUS_SRC_ALPHA),colorWrite:ta.wE})}}kd.shader=new Ys.$(Wd.a,(()=>i.e(1747).then(i.bind(i,71747))));var Zd=i(96673);let qd=class extends co.RW{constructor(e){super(e),this._overlays=null,this._renderTargets=null,this._overlayParameters=new Wd.O,this.hasHighlights=!1,this._hasWater=!1,this._renderers=new Map,this._sortedDrapeSourceRenderersDirty=!1,this._sortedRenderers=new C.A,this._passParameters=new io.T,this._materialRepository=null,this._screenToWorldRatio=1,this._localOriginFactory=null,this.unloadedMemory=0,this.ignoresMemoryFactor=!1,this._camera=new uo,this.worldToPCSRatio=1,this.events=new Cn.A,this.longitudeCyclical=null,this.produces=new Map([[Qs.N.DRAPED_MATERIAL,e=>e!==ks.V.Highlight||this.hasHighlights],[Qs.N.DRAPED_WATER,()=>this._hasWater]]),this._hasTargetWithoutRasterImage=!1,this._hasDrapedFeatureSource=!1,this._hasDrapedRasterSource=!1}initialize(){const e=this.view._stage.renderer.fboCache,t=this.view._stage.renderView,{waterTextures:i,stippleTextures:r,markerTextures:n}=t;this._shaderTechniques=new no({rctx:this._rctx,viewingMode:ae.RT.Local,stippleTextureRepository:r,markerTextureRepository:n,waterTextureRepository:i}),this._renderContext=new Sl(this._rctx,new Tl(e,this.view.state.viewingMode),null),this.addHandles([(0,l.wB)((()=>i.updating),(()=>this.events.emit("content-changed")),l.pc),(0,l.wB)((()=>this.spatialReference),(e=>this._localOriginFactory=new ul(e)),l.pc),(0,l.on)((()=>this.view.allLayerViews),"after-changes",(()=>this._sortedDrapeSourceRenderersDirty=!0))]),this._materialRepository=new yo(t.textureRepository,this._shaderTechniques,(()=>{this.notifyChange("rendersOccludedDraped"),this.events.emit("content-changed"),this.notifyChange("updating"),this.notifyChange("isEmpty")}),(()=>this.events.emit("content-changed"))),this._bindParameters.slot=Qs.N.DRAPED_MATERIAL,this._bindParameters.mainDepth=null,this._camera.near=1,this._camera.far=1e4,this._camera.relativeElevation=null,this._bindParameters.camera=this._camera,this._bindParameters.transparencyPassType=Lo.y.NONE,this._bindParameters.newLighting.noonFactor=0,this._bindParameters.newLighting.globalFactor=0,this._bindParameters.newLighting.set([new jd.$p((0,I.fA)(1,1,1))]),this.addHandles(this.view.resourceController.scheduler.registerTask(Ae.W6.STAGE,this))}destroy(){this._renderers.forEach((e=>e.destroy())),this._renderers.clear(),this._debugTextureTechnique=(0,le.Gz)(this._debugTextureTechnique),this._passParameters.texture=(0,le.WD)(this._passParameters.texture),this._shaderTechniques=(0,le.pR)(this._shaderTechniques),this.disposeOverlays()}get _bindParameters(){return this._renderContext.bindParameters}get _rctx(){return this.view._stage.renderView.renderingContext}get rctx(){return this._rctx}get materialRepository(){return this._materialRepository}get screenToWorldRatio(){return this._screenToWorldRatio}get localOriginFactory(){return this._localOriginFactory}initializeRenderContext(e){this.pluginContext=e}uninitializeRenderContext(){}renderNode(){}get updating(){return this._sortedDrapeSourceRenderersDirty||(0,Ui.Bs)(this._renderers,(e=>e.updating))}get hasOverlays(){return null!=this._overlays&&null!=this._renderTargets}getMemoryForMaterial(e){return Array.from(this._renderers.values()).reduce(((t,i)=>t+i.getMemoryForMaterial(e)),0)}get layers(){return this._sortedDrapeSourceRenderersDirty&&this._updateSortedDrapeSourceRenderers(),this._sortedRenderers.map((e=>e.drapeSource.layer)).filter((e=>!!e))}createGeometryDrapeSourceRenderer(e){return this.createDrapeSourceRenderer(e,Gd)}createDrapeSourceRenderer(e,t,i){const r=this._renderers.get(e);null!=r&&r.destroy();const n=new t({...i,rendererContext:this,drapeSource:e});return this._renderers.set(e,n),this._sortedDrapeSourceRenderersDirty=!0,"fullOpacity"in e&&this.addHandles((0,l.wB)((()=>e.fullOpacity),(()=>this.events.emit("content-changed"))),e),n}removeDrapeSourceRenderer(e){if(null==e)return;const t=this._renderers.get(e);null!=t&&(this._sortedDrapeSourceRenderersDirty=!0,this._renderers.delete(e),this.removeHandles(e),t.destroy())}computeValidity(){var e,t;return null!==(e=null===(t=this._renderTargets)||void 0===t?void 0:t.computeValidity())&&void 0!==e?e:0}releaseRenderTargets(){var e;null===(e=this._renderTargets)||void 0===e||e.dispose()}get overlays(){var e;return null!==(e=this._overlays)&&void 0!==e?e:[]}ensureDrapeTargets(e){this._hasTargetWithoutRasterImage=!!this._overlays&&(0,Ua.bw)(e,(e=>e.drapeTargetType===Na.WithoutRasterImage))}ensureDrapeSources(e){this._overlays?(this._hasDrapedFeatureSource=(0,Ua.bw)(e,(e=>e.drapeSourceType===La.Features)),this._hasDrapedRasterSource=(0,Ua.bw)(e,(e=>e.drapeSourceType===La.RasterImage))):this._hasDrapedFeatureSource=this._hasDrapedRasterSource=!1}get _needsColorWithoutRasterImage(){return this._hasDrapedRasterSource&&this._hasDrapedFeatureSource&&this._hasTargetWithoutRasterImage}ensureOverlays(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this._bindParameters.overlayStretch;null==this._overlays&&(this._renderTargets=new Ja(this.view._stage.renderer.fboCache),this._overlays=[new Wa,new Wa]),this.ensureDrapeTargets(e),this.ensureDrapeSources(t),this._bindParameters.overlayStretch=i}disposeOverlays(){this._overlays=null,this._renderTargets=(0,le.WD)(this._renderTargets),this.events.emit("textures-disposed")}getTexture(e){var t,i;if(null!=e)return e===za.ColorNoRasterImage&&!this._needsColorWithoutRasterImage&&this._hasDrapedFeatureSource?null===(t=this._renderTargets)||void 0===t?void 0:t.getTexture(za.Color):null===(i=this._renderTargets)||void 0===i?void 0:i.getTexture(e)}get running(){return this.updating}runTask(e){this._processDrapeSources(e,(()=>!0))}_processDrapeSources(e,t){let i=!1;for(const[r,n]of this._renderers){if(e.done)break;(r.destroyed||t(r))&&n.commitChanges()&&(i=!0,e.madeProgress())}this._sortedDrapeSourceRenderersDirty&&(this._sortedDrapeSourceRenderersDirty=!1,i=!0,this._updateSortedDrapeSourceRenderers()),i&&(null!=this._overlays&&0===this._renderers.size&&this.disposeOverlays(),this.notifyChange("updating"),this.notifyChange("isEmpty"),this.events.emit("content-changed"),this.hasHighlights=(0,Ui.Bs)(this._renderers,(e=>e.hasHighlights)),this.notifyChange("rendersOccludedDraped"),this._updateHasWater())}processSyncDrapeSources(){this._processDrapeSources(Ae.Bb,(e=>e.updatePolicy===Ao.SYNC))}get isEmpty(){return!Fn.b.OVERLAY_DRAW_DEBUG_TEXTURE&&!(0,Ui.Bs)(this._renderers,(e=>!e.isEmpty))}get hasWater(){return this._hasWater}get rendersOccludedDraped(){const e=this._renderContext.renderOccludedMask;this._renderContext.renderOccludedMask=Yd;const t=this._sortedRenderers.some((e=>{let{renderer:t}=e;return t.shouldRender(this._renderContext)}));return this._renderContext.renderOccludedMask=e,t}renders(e){return Fn.b.OVERLAY_DRAW_DEBUG_TEXTURE&&e!==za.Occluded||this._sortedRenderers.some((e=>{let{renderer:t}=e;return t.shouldRender(this._renderContext)}))}get mode(){var e,t;return this.isEmpty?eo.Disabled:null!==(e=this._renderTargets)&&void 0!==e&&e.getTexture(za.WaterNormal)?eo.EnabledWithWater:null!==(t=this._renderTargets)&&void 0!==t&&t.getTexture(za.Color)?eo.Enabled:eo.Disabled}updateAnimation(e){let t=!1;return this._renderers.forEach((i=>t=i.updateAnimation(e)||t)),t}updateDrapeSourceOrder(){this._sortedDrapeSourceRenderersDirty=!0}drawOverlays(e){if(this._overlays&&this._renderTargets){for(const e of this._overlays)this.longitudeCyclical?e.setupGeometryViewsCyclical(this.longitudeCyclical):e.setupGeometryViewsDirect();for(const t of this._renderTargets.targets){if(t.content===za.ColorNoRasterImage&&!this._needsColorWithoutRasterImage)continue;const i=this._drawTarget(Ba.vr.INNER,t,e),r=this._drawTarget(Ba.vr.OUTER,t,e);(i||r)&&t.fbo.generateMipMap()}}}_drawTarget(e,t,i){const r=this._overlays[e],n=r.canvasGeometries;if(0===n.numViews)return!1;const{alignPixelEnabled:s,contentPixelRatio:a}=i;this._screenToWorldRatio=a*r.mapUnitsPerPixel/this._bindParameters.overlayStretch;const o=t.output;if(this.isEmpty||o===ks.V.Highlight&&!this.hasHighlights||o===ks.V.Normal&&!this.hasWater||!r.hasSomeSizedView())return!1;const l=this._rctx;if(this._camera.pixelRatio=r.pixelRatio*a,this._renderContext.output=o,this._bindParameters.alignPixelEnabled=s,this._bindParameters.screenToWorldRatio=this._screenToWorldRatio,this._bindParameters.screenToPCSRatio=this._screenToWorldRatio*this.worldToPCSRatio,this._bindParameters.slot=o===ks.V.Normal?Qs.N.DRAPED_WATER:Qs.N.DRAPED_MATERIAL,t.content===za.Occluded&&(this._renderContext.renderOccludedMask=Yd),!this.renders(t.content))return this._renderContext.renderOccludedMask=wl,!1;const c=r.resolution;this._rctx.setViewport(e===Ba.vr.INNER?0:c,0,c,c);const d=2*r.resolution,h=r.resolution,u=t.fbo;if(u.bind(l,d,h),e===Ba.vr.INNER&&(l.setClearColor(0,0,0,0),l.clearSafe(ft.hn.COLOR_BUFFER_BIT)),Fn.b.OVERLAY_DRAW_DEBUG_TEXTURE&&t.content!==za.Occluded)for(let p=0;p<n.numViews;p++)this._setViewParameters(n.extents[p],r),this._ensureDebugPatternResources(r.resolution,Jd[e]),this._rctx.bindTechnique(this._debugTextureTechnique,this._renderContext.bindParameters,this._passParameters),this._rctx.screen.draw();return this._sortedRenderers.forAll((i=>{let{drapeSource:s,renderer:a}=i;if(t.content===za.ColorNoRasterImage&&s.drapeSourceType===La.RasterImage)return;const{fullOpacity:c}=s,p=null!=c&&c<1&&o===ks.V.Color?this.bindTemporaryFramebuffer(d,h):null;for(let e=0;e<n.numViews;e++)this._setViewParameters(n.extents[e],r),a.render(this._renderContext);if(p){u.bind(l,d,h),this._overlayParameters.texture=p.getTexture(),this._overlayParameters.opacity=c,this._overlayParameters.overlayIndex=e;const t=this.pluginContext.techniqueRepository.acquire(kd);this._rctx.bindTechnique(t,this._renderContext.bindParameters,this._overlayParameters),this._rctx.screen.draw(),t.release(),p.release()}})),l.bindFramebuffer(null),this._renderContext.renderOccludedMask=wl,!0}bindTemporaryFramebuffer(e,t){const i=this.view._stage.renderer.fboCache,r=i.acquire(e,t,"overlay tmp");return i.rctx.unbindTexture(r.fbo.colorTexture),i.rctx.bindFramebuffer(r.fbo),i.rctx.clearSafe(ft.hn.COLOR_BUFFER_BIT),r}async reloadShaders(){await this._shaderTechniques.reloadAll()}notifyContentChanged(){this.events.emit("content-changed")}intersect(e,t,i,r){this._sortedDrapeSourceRenderersDirty&&this._updateSortedDrapeSourceRenderers();let n=0;for(const{renderer:o}of this._sortedRenderers){var s,a;n=null!==(s=null===(a=o.intersect)||void 0===a?void 0:a.call(o,e,t,i,r,n))&&void 0!==s?s:n}}_updateSortedDrapeSourceRenderers(){if(this._sortedRenderers.clear(),0===this._renderers.size)return;const e=this.view.map.allLayers,t=e.length;this._renderers.forEach(((i,r)=>{var n;const s=e.indexOf(r.layer),a=s>=0,o=null!==(n=r.renderGroup)&&void 0!==n?n:a?Fa.MapLayer:Fa.ViewLayer,l=t*o+(a?s:0);this._sortedRenderers.push(new Qd(r,i,l))})),this._sortedRenderers.sort(((e,t)=>e.index-t.index))}_setViewParameters(e,t){const i=this._camera;i.viewport=[0,0,t.resolution,t.resolution],(0,T.v3)(i.projectionMatrix,0,e[2]-e[0],0,e[3]-e[1],i.near,i.far),(0,T.kN)(i.viewMatrix,[-e[0],-e[1],0])}_updateHasWater(){const e=(0,Ui.Bs)(this._renderers,(e=>e.hasWater));e!==this._hasWater&&(this._hasWater=e,this.events.emit("has-water",e))}_ensureDebugPatternResources(e,t){if((0,M.s)(this._passParameters.color,t[0],t[1],t[2]),this._passParameters.texture)return;const i=new Uint8Array(e*e*4);let r=0;for(let a=0;a<e;a++)for(let t=0;t<e;t++){const n=Math.floor(t/10),s=Math.floor(a/10);n<2||s<2||10*n>e-20||10*s>e-20?(i[r++]=255,i[r++]=255,i[r++]=255,i[r++]=255):(i[r++]=255,i[r++]=255,i[r++]=255,i[r++]=1&n&&1&s?1&t^1&a?0:255:1&n^1&s?0:128)}const n=new Zd.R(e);n.samplingMode=ft.Cj.NEAREST,this._passParameters.texture=new Rl.g(this._rctx,n,i);const s=new Hd;s.hasAlpha=!0,this._debugTextureTechnique=this._shaderTechniques.acquire(Bd,s)}get test(){return{drapedRenderers:Array.from(this._renderers.values()),sortedDrapeSources:Array.from(this._sortedRenderers).map((e=>{let{drapeSource:t}=e;return t})),getDrapeSourceRenderer:e=>this._renderers.get(e)}}};(0,r._)([(0,d.MZ)()],qd.prototype,"hasHighlights",void 0),(0,r._)([(0,d.MZ)()],qd.prototype,"_sortedDrapeSourceRenderersDirty",void 0),(0,r._)([(0,d.MZ)()],qd.prototype,"_shaderTechniques",void 0),(0,r._)([(0,d.MZ)({constructOnly:!0})],qd.prototype,"view",void 0),(0,r._)([(0,d.MZ)()],qd.prototype,"worldToPCSRatio",void 0),(0,r._)([(0,d.MZ)()],qd.prototype,"spatialReference",void 0),(0,r._)([(0,d.MZ)({type:Boolean,readOnly:!0})],qd.prototype,"updating",null),(0,r._)([(0,d.MZ)()],qd.prototype,"isEmpty",null),(0,r._)([(0,d.MZ)({readOnly:!0})],qd.prototype,"rendersOccludedDraped",null),qd=(0,r._)([(0,u.$)("esri.views.3d.terrain.OverlayRenderer")],qd);class Qd{constructor(e,t,i){this.drapeSource=e,this.renderer=t,this.index=i}}const Jd=[[1,.5,.5],[.5,.5,1]],Yd=qs.m$.OccludeAndTransparent;function Xd(e,t,i,r){const n=(0,Ga.jp)(e.rings,!!e.hasZ&&"on-the-ground"!==r.mode,Ga.Wq.CCW_IS_HOLE,e.spatialReference),s=(0,J.jh)(n.position.length),a=Mt(n.position,e.spatialReference,0,s,0,n.position,0,n.position.length/3,t,i,r),o=null!=a;return new sh(n.position,s,eh(n.polygons,n.position,s),Kd(n.outlines,n.position,s),o,a)}function $d(e,t){const i=(0,Ga.jp)(e.rings,!1,Ga.Wq.CCW_IS_HOLE),r=(0,k.projectBuffer)(i.position,e.spatialReference,0,i.position,t,0,i.position.length/3);for(let n=2;n<i.position.length;n+=3)i.position[n]=-2;return{position:i.position,polygons:eh(i.polygons,i.position),outlines:Kd(i.outlines,i.position),projectionSuccess:r}}function Kd(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return e.filter((e=>{let{count:t}=e;return t>1})).map((e=>{let{index:r,count:n}=e;const s=3*r,a=3*n;return null!=i?new ih(r,n,(0,J.l5)(t,s,a),(0,J.l5)(i,s,a)):new th(r,n,(0,J.l5)(t,s,a))}))}function eh(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;const r=new Array;for(const{index:n,count:s,holeIndices:a,pathLengths:o}of e){if(s<=1)continue;const e=3*n,l=3*s,c=a.map((e=>e-n)),d=null!=i?new rh(n,s,(0,J.l5)(t,3*n,3*s),(0,J.l5)(i,e,l),c,o):new nh(n,s,(0,J.l5)(t,3*n,3*s),c,o);r.push(d)}return r}class th{constructor(e,t,i){this.index=e,this.count=t,this.position=i}}class ih extends th{constructor(e,t,i,r){super(e,t,i),this.mapPositions=r}}class rh extends ih{constructor(e,t,i,r,n,s){super(e,t,i,r),this.holeIndices=n,this.pathLengths=s}}class nh extends th{constructor(e,t,i,r,n){super(e,t,i),this.holeIndices=r,this.pathLengths=n}}class sh{constructor(e,t,i,r,n,s){this.position=e,this.mapPositions=t,this.polygons=i,this.outlines=r,this.projectionSuccess=n,this.sampledElevation=s}}var ah=i(59046),oh=i(25672);const lh=["polygon","extent"];function ch(e,t,i,r,n,s){const a=(0,X.EH)(t.length),o=[[Pt.r.POSITION,new _r.n(r.positions,t,3,!0)],[Pt.r.NORMALCOMPRESSED,new _r.n(r.normals,t,2,!0)],[Pt.r.COLOR,new _r.n(n,a,4,!0)]];return new yr.V(e,o,r.elevation,vr.X.Mesh,s,i)}function dh(e,t,i,r,n,s,a,o,l,c,d,h,u){const p=i.length/3;let f=0,g=2*r.count;!function(e,t,i,r,n,s,a,o,l,c,d,h,u,p,f,g,m){(0,M.c)(Sh,g);const _=f>0?1:-1;let v=3*i,y=0,b=3*y,x=r,S=3*x;for(let A=0;A<r;++A)m&&(Sh[0]=e[v],Sh[1]=e[v+1],Sh[2]=e[v+2],(0,M.n)(Sh,Sh)),o[b]=e[v],o[b+1]=e[v+1],o[b+2]=e[v+2],l[b]=t[v],l[b+1]=t[v+1],l[b+2]=t[v+2],c[b]=-_*Sh[0],c[b+1]=-_*Sh[1],c[b+2]=-_*Sh[2],d[y]=0,o[S]=e[v]+f*Sh[0],o[S+1]=e[v+1]+f*Sh[1],o[S+2]=e[v+2]+f*Sh[2],l[S]=t[v],l[S+1]=t[v+1],l[S+2]=t[v+2],c[S]=_*Sh[0],c[S+1]=_*Sh[1],c[S+2]=_*Sh[2],d[x]=f,b+=3,S+=3,v+=3,y+=1,x+=1;v=3*s,b=0,S=3*p;const w=f<0?Ah:Ch,C=f<0?Ch:Ah;for(let A=0;A<a;++A)u[b]=n[v+w[0]],u[b+1]=n[v+w[1]],u[b+2]=n[v+w[2]],h[S]=n[v+C[0]]+r,h[S+1]=n[v+C[1]]+r,h[S+2]=n[v+C[2]]+r,b+=3,S+=3,v+=3}(e,t,r.index,r.count,i,0,p,n,s,a,o,l,c,g,d,h,u);let m=2*r.count;g=0,ph(n,s,o,a,f,r.pathLengths[0],r.count,m,l,g,d),m+=4*r.pathLengths[0],g+=2*r.pathLengths[0],f+=r.pathLengths[0];for(let _=1;_<r.pathLengths.length;++_)ph(n,s,o,a,f,r.pathLengths[_],r.count,m,l,g,d),m+=4*r.pathLengths[_],g+=2*r.pathLengths[_],f+=r.pathLengths[_]}function hh(e,t,i,r,n,s,a){r[s]=r[a],a*=3,e[s*=3]=e[a],e[s+1]=e[a+1],e[s+2]=e[a+2],t[s]=t[a],t[s+1]=t[a+1],t[s+2]=t[a+2],i[s]=n[0],i[s+1]=n[1],i[s+2]=n[2]}const uh=(0,I.vt)();function ph(e,t,i,r,n,s,a,o,l,c,d){let h=n,u=n+1,p=n+a,f=n+a+1,g=o,m=o+1,_=o+2*s,v=o+2*s+1;d<0&&(h=n+a+1,f=n),c*=3;for(let y=0;y<s;++y)y===s-1&&(d>0?(u=n,f=n+a):(u=n,h=n+a)),yh(e,h,u,p,uh),hh(e,t,r,i,uh,g,h),hh(e,t,r,i,uh,m,u),hh(e,t,r,i,uh,_,p),hh(e,t,r,i,uh,v,f),l[c++]=g,l[c++]=_,l[c++]=v,l[c++]=g,l[c++]=v,l[c++]=m,h++,u++,p++,f++,g+=2,m+=2,_+=2,v+=2}const fh=(0,I.vt)(),gh=(0,I.vt)(),mh=(0,I.vt)(),_h=(0,I.vt)(),vh=(0,I.vt)();function yh(e,t,i,r,n){t*=3,i*=3,r*=3,(0,M.s)(fh,e[t++],e[t++],e[t++]),(0,M.s)(gh,e[i++],e[i++],e[i++]),(0,M.s)(mh,e[r++],e[r++],e[r++]),(0,M.f)(_h,gh,fh),(0,M.f)(vh,mh,fh),(0,M.b)(n,vh,_h),(0,M.n)(n,n)}const bh=(0,I.vt)();const xh=(0,I.vt)(),Sh=(0,I.vt)(),wh=new Ut,Ch=[0,2,1],Ah=[0,1,2],Rh=.01;var Eh;!function(e){e[e.Main=0]="Main",e[e.Bottom=1]="Bottom"}(Eh||(Eh={}));class Oh{constructor(e,t,i,r){this.positions=e,this.elevation=t,this.normals=i,this.heights=r}}var Th=i(88685),Ph=i(401),Mh=i(48988),Ih=i(97763),Dh=i(29632),Lh=i(76589),Fh=i(93223),Nh=i(94439),Vh=i(52629);const Gh=L.uY,Uh=4;class zh{constructor(e,t,i,r){this.graphics3DSymbolLayer=e,this.renderGeometries=t,this.boundingBox=i,this._drapeSourceRenderer=r,this.type="draped",this.stage=null,this._visible=!1,this._addedToStage=!1,this.isElevationSource=!1}initialize(e){this.stage=e.stage}setVisibility(e){if(null!=this.stage&&this._visible!==e){if(this._visible=e,e&&!this._addedToStage)return this._addedToStage=!0,void this._drapeSourceRenderer.addGeometries(this.renderGeometries,rd.ADD);if(e||this._addedToStage){for(const e of this.renderGeometries)e.visible=this._visible;this._drapeSourceRenderer.modifyGeometries(this.renderGeometries,nd.VISIBILITY)}}}destroy(){this.stage&&this._addedToStage&&this._drapeSourceRenderer.removeGeometries(this.renderGeometries,rd.REMOVE),this._addedToStage=!1,this._visible=!1,this.stage=null}getCenterObjectSpace(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,I.vt)();return(0,M.s)(e,0,0,0)}getBoundingBoxObjectSpace(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,q.vt)();return(0,q.Ie)(e)}addObjectState(e,t){e===fe.Mg.Highlight&&(this.renderGeometries.forEach((e=>{const i=e.geometry.addHighlight();t.addRenderGeometry(e,i,this)})),this._addedToStage&&this._drapeSourceRenderer.modifyGeometries(this.renderGeometries,nd.HIGHLIGHT))}removeObjectState(e){this.renderGeometries.forEach((t=>{e.removeRenderGeometry(t)}))}removeRenderGeometryObjectState(e,t){e.geometry.removeHighlight(t),this._addedToStage&&this._drapeSourceRenderer.modifyGeometries(this.renderGeometries,nd.HIGHLIGHT)}computeAttachmentOrigin(e){for(const t of this.renderGeometries)t.geometry.computeAttachmentOrigin(jh)&&(e.draped.origin[0]+=jh[0],e.draped.origin[1]+=jh[1],e.draped.num++)}async getProjectedBoundingBox(e,t,i,r,n){(0,q.Ie)(n);for(let a=0;a<this.renderGeometries.length;a++){const t=this.renderGeometries[a];this._getRenderGeometryProjectedBoundingRect(t,e,Bh,i),(0,q.DC)(n,Bh)}if(t){let e;(0,q.gX)(n,jh);const i=ss(n,t.service.spatialReference,t);try{e=await t.service.queryElevation(jh[0],jh[1],r,i,"ground")}catch(s){}null!=e&&(n[2]=Math.min(n[2],e),n[5]=Math.max(n[5],e))}return n}_getRenderGeometryProjectedBoundingRect(e,t,i,r){if(this.boundingBox)(0,q.hZ)(Hh,this.boundingBox);else{const t=e.boundingSphere,i=t[3];Hh[0]=t[0]-i,Hh[1]=t[1]-i,Hh[2]=t[2]-i,Hh[3]=t[0]+i,Hh[4]=t[1]+i,Hh[5]=t[2]+i}return t(Hh,0,2),this.calculateRelativeScreenBounds&&r.push({location:(0,q.gX)(Hh),screenSpaceBoundingRect:this.calculateRelativeScreenBounds()}),(0,q.ES)(Hh,i)}}const Bh=(0,Q.vt)(),Hh=(0,q.vt)(),jh=(0,I.vt)();function Wh(e,t,i){return e.canvas||(e.canvas=document.createElement("canvas")),e.canvas.width=t,e.canvas.height=i,e.canvas}function kh(e){const{size:t}=e.definition,i=e.fontString(t);let r=Zh.get(i);if(!r){const n=Wh(Qh,0,0).getContext("2d");e.setFontProperties(n,t);const s=n.measureText(Jh);r=new qh(s.actualBoundingBoxAscent,s.actualBoundingBoxDescent),Zh.set(i,r)}return r}const Zh=new Map;class qh{get maxHeight(){return this.maxAscent+this.maxDescent}constructor(e,t){this.maxAscent=e,this.maxDescent=t}}const Qh={canvas:null},Jh=(()=>{let e="";for(let t=32;t<127;t++)e+=String.fromCharCode(t);return e})(),Yh=1;class Xh{constructor(e,t,i,r){this.text=e,this._alignment=t,this._parameters=i,this._maxSize=r,this._textWidths=[],this._lineWidths=[],this._renderPixelRatio=null,this._metricsCached=null,this.key="TextRenderer-".concat(this._parameters.key,"-").concat(this._alignment,"--").concat(e),this._lines=e.replaceAll(" ","\xa0").split(/\r?\n/)}get displayWidth(){return Math.ceil(this._displayWidth+2*this._horizontalPadding)}get displayHeight(){let e=this._metrics.firstLineAscent;for(let t=0;t<this._lines.length-1;t++)e+=this._lineSpacing;return e+=this._metrics.lastLineDescent,Math.ceil(e+2*this._haloSize+2*this._verticalPadding)}get renderedWidth(){return this._toRoundedRenderUnit(this.displayWidth)}get renderedHeight(){return this._toRoundedRenderUnit(this.displayHeight)}get firstRenderedBaselinePosition(){return this._toRenderUnit(this._firstLineYOffset+this._metrics.firstLineAscent)}get _firstLineYOffset(){return this._verticalPadding+this._haloSize}get _metrics(){if(null==this._metricsCached){const e=Wh(eu,iu,iu).getContext("2d"),t=this._parameters.definition.pixelRatio,i=this._fontSize*t;this._parameters.setFontProperties(e,i);let r=2*this._haloSize;const n=this._parameters.definition.font;"italic"!==n.style&&"oblique"!==n.style&&"bold"!==n.weight&&"bolder"!==n.weight||(r+=.3*e.measureText("A").width),this._textWidths.length=0,this._lineWidths.length=0;let s=0,a=0,o=0,l=0,c=0;this._lines.forEach(((i,n)=>{const d=e.measureText(i),h=d.width/t,u=h+r;this._textWidths.push(h),this._lineWidths.push(u),s=Math.max(s,u),l=Math.max(l,d.actualBoundingBoxAscent/t),c=Math.max(c,d.actualBoundingBoxDescent/t),0===n&&(a=d.actualBoundingBoxAscent/t),n===this._lines.length-1&&(o=d.actualBoundingBoxDescent/t)}));const d=kh(this._parameters),h=Math.max(l,d.maxAscent),u=Math.max(c,d.maxDescent),p=a,f="underline"===this._parameters.definition.font.decoration?u:o,g=s;this._metricsCached=new nu(p,f,h,u,g)}return this._metricsCached}get _lineSpacing(){return(this._midLineHeight+this._linePadding)*this._parameters.definition.lineSpacingFactor}get _midLineHeight(){return this._metrics.midLineHeight}get _linePadding(){return this._midLineHeight*tu}get _midLineAscent(){return this._metrics.maxLineAscent}get _renderedFontSize(){return this._toRenderUnit(this._fontSize)}get _fontSize(){return this._parameters.definition.size}get _renderedHaloSize(){return this._toRenderUnit(this._haloSize)}get _haloSize(){return this._parameters.haloSize}get _horizontalPadding(){return this._hasBackground?this._parameters.definition.background.padding[0]:0}get _verticalPadding(){return Math.max(this._hasBackground?this._parameters.definition.background.padding[1]:0,Yh)}get _hasBackground(){return!!this._parameters.backgroundStyle}get renderPixelRatio(){if(null==this._renderPixelRatio){const e=this._parameters.definition.pixelRatio;this._renderPixelRatio=Math.min(e,Math.min(this._maxSize[0]/this.displayWidth,this._maxSize[1]/this.displayHeight))}return this._renderPixelRatio}_getLineXOffset(e){switch(this._alignment){case Kh.Left:return this._horizontalPadding;case Kh.Center:return(this.displayWidth-this._lineWidths[e])/2;case Kh.Right:return this.displayWidth-this._horizontalPadding-this._lineWidths[e]}}render(e,t,i){e.save();const r=t/=this.renderPixelRatio,n=i/=this.renderPixelRatio,s=this._haloSize,a=this._firstLineYOffset+this._metrics.firstLineAscent;t+=s,i+=a;const o=this._haloSize>0;o&&this._renderHalo(e,r,n,s,a),this._parameters.setFontProperties(e,this._renderedFontSize);for(let l=0;l<this._lines.length;++l){const r=this._lines[l],n=this._getLineXOffset(l);o&&(e.globalCompositeOperation="destination-out",e.fillStyle="rgb(0, 0, 0)",this._fillText(e,r,t+n,i),this._renderLineDecoration(e,t+n,i,this._textWidths[l])),e.globalCompositeOperation="source-over",e.fillStyle=this._parameters.textStyle,this._fillText(e,r,t+this._getLineXOffset(l),i),this._renderLineDecoration(e,t+n,i,this._textWidths[l]),i+=this._lineSpacing}if(Fn.b.TEXT_SHOW_BASELINE){e.strokeStyle=ru,e.setLineDash([2,2]),e.lineWidth=1;let t=n+a;for(let i=0;i<this._lines.length;++i)this._drawLine(e,[r,t],[r+this.displayWidth,t]),t+=this._lineSpacing}if(Fn.b.TEXT_SHOW_BORDER&&(e.strokeStyle=ru,e.setLineDash([]),e.lineWidth=1,this._drawBox(e,[r,n],[this.displayWidth,this.displayHeight])),this._hasBackground){const t=this._parameters.definition.background.borderRadius*this.renderPixelRatio;this._roundedRect(e,r,n,t),e.globalCompositeOperation="destination-over",e.fillStyle=this._parameters.backgroundStyle,e.fill()}e.restore()}_renderLineDecoration(e,t,i,r){let n=arguments.length>4&&void 0!==arguments[4]&&arguments[4];if("none"===this._parameters.definition.font.decoration||0===r)return;const s=Math.max(this._parameters.definition.size/16,1);switch(this._parameters.definition.font.decoration){case"underline":i+=2*s;break;case"line-through":i-=.33*this._midLineAscent}const a=n?this._haloSize:0;e.strokeStyle=n?this._parameters.haloStyle:this._parameters.textStyle,e.lineWidth=this._toRenderUnit(s+2*a),e.beginPath(),e.moveTo(this._toRenderUnit(t-a),this._toRenderUnit(i)),e.lineTo(this._toRenderUnit(t+r+a),this._toRenderUnit(i)),e.stroke()}_roundedRect(e,t,i,r){t=this._toRenderUnit(t),i=this._toRenderUnit(i);const n=this.renderedWidth,s=this.renderedHeight;0!==r?(r=(0,U.qE)(r,0,Math.floor(s/2)),e.beginPath(),e.moveTo(t,i+r),e.arcTo(t,i,t+r,i,r),e.lineTo(t+n-r,i),e.arcTo(t+n,i,t+n,i+r,r),e.lineTo(t+n,i+s-r),e.arcTo(t+n,i+s,t+n-r,i+s,r),e.lineTo(t+r,i+s),e.arcTo(t,i+s,t,i+s-r,r),e.closePath()):e.rect(t,i,n,s)}_renderHalo(e,t,i,r,n){const s=this.renderedWidth,a=this.renderedHeight,o=Wh(eu,Math.max(s,iu),Math.max(a,iu)),l=o.getContext("2d");l.clearRect(0,0,s,a),this._parameters.setFontProperties(l,this._renderedFontSize),l.fillStyle=this._parameters.haloStyle,l.strokeStyle=this._parameters.haloStyle;const c=this._renderedHaloSize<3;l.lineJoin=c?"miter":"round",c?this._renderHaloEmulated(l,r,n):this._renderHaloNative(l,r,n);let d=n;for(let h=0;h<this._lines.length;++h){const e=this._getLineXOffset(h);this._renderLineDecoration(l,r+e,d,this._textWidths[h],!0),d+=this._lineSpacing}e.globalAlpha=this._parameters.definition.halo.color[3],e.drawImage(o,0,0,s,a,this._toRenderUnit(t),this._toRenderUnit(i),s,a),e.globalAlpha=1}_renderHaloEmulated(e,t,i){for(let r=0;r<this._lines.length;++r){const n=this._lines[r],s=this._getLineXOffset(r);for(const[r,a]of $h)this._fillText(e,n,t+s+this._haloSize*r,i+this._haloSize*a);i+=this._lineSpacing}}_renderHaloNative(e,t,i){const r=2*this._haloSize;for(let n=0;n<this._lines.length;++n){const s=this._lines[n],a=this._getLineXOffset(n),o=5,l=.1;for(let n=0;n<o;n++){const c=1-(o-1)*l+n*l;e.lineWidth=this._toRenderUnit(c*r),this._strokeText(e,s,t+a,i)}i+=this._lineSpacing}}get _displayWidth(){return this._metrics.displayWidth}_toRenderUnit(e){return e*this.renderPixelRatio}_toRoundedRenderUnit(e){return Math.round(e*this.renderPixelRatio)}_fillText(e,t,i,r){e.fillText(t,this._toRenderUnit(i),this._toRenderUnit(r))}_strokeText(e,t,i,r){e.strokeText(t,this._toRenderUnit(i),this._toRenderUnit(r))}_drawLine(e,t,i){e.beginPath(),e.moveTo(this._toRoundedRenderUnit(t[0])+.5,this._toRoundedRenderUnit(t[1])+.5),e.lineTo(this._toRoundedRenderUnit(i[0])+.5,this._toRoundedRenderUnit(i[1])+.5),e.stroke()}_drawBox(e,t,i){const r=this._toRenderUnit(t[0]),n=this._toRenderUnit(t[1]),s=this._toRenderUnit(i[0]),a=this._toRenderUnit(i[1]),o=Math.floor(r)+.5,l=Math.ceil(r+s)-.5,c=Math.floor(n)+.5,d=Math.ceil(n+a)-.5;e.beginPath(),e.moveTo(o,c),e.lineTo(l,c),e.lineTo(l,d),e.lineTo(o,d),e.lineTo(o,c),e.stroke()}}const $h=[];{const e=16;for(let t=0;t<360;t+=360/e)$h.push([Math.cos(Math.PI*t/180),Math.sin(Math.PI*t/180)])}var Kh;!function(e){e[e.Left=0]="Left",e[e.Center=1]="Center",e[e.Right=2]="Right"}(Kh||(Kh={}));const eu={canvas:null},tu=.2,iu=512,ru="rgb(255, 0, 255, 0.5)";class nu{get firstLineHeight(){return this.firstLineAscent+this.maxLineDescent}get midLineHeight(){return this.maxLineAscent+this.maxLineDescent}get lastLineHeight(){return this.maxLineAscent+this.lastLineDescent}constructor(e,t,i,r,n){this.firstLineAscent=e,this.lastLineDescent=t,this.maxLineAscent=i,this.maxLineDescent=r,this.displayWidth=n}}const su=Object.freeze({left:0,center:.5,right:1}),au=Object.freeze({"bottom-left":(0,pr.fA)(0,0),bottom:(0,pr.fA)(.5,0),"bottom-right":(0,pr.fA)(1,0),left:(0,pr.fA)(0,.5),center:(0,pr.fA)(.5,.5),right:(0,pr.fA)(1,.5),"top-left":(0,pr.fA)(0,1),top:(0,pr.fA)(.5,1),"top-right":(0,pr.fA)(1,1)});function ou(e){switch(e){case"left":return Kh.Left;case"right":return Kh.Right;default:return Kh.Center}}function lu(e){switch(e){case"bottom-left":case"left":case"top-left":return"left";case"bottom":case"center":case"top":return"center";case"bottom-right":case"right":case"top-right":return"right"}}var cu=i(72900);class du{constructor(e){var t;let i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.geometry=e,this.screenToWorldRatio=1,this._transformation=(0,P.vt)(),this._shaderTransformation=null,this._boundingSphere=null,this.id=(0,Ni.c)(),this.layerUid=i.layerUid,this.graphicUid=i.graphicUid,this.castShadow=null!==(t=i.castShadow)&&void 0!==t&&t,null!=i.objectShaderTransformation&&this.objectShaderTransformationChanged(i.objectShaderTransformation)}get transformation(){return this._transformation}set transformation(e){(0,T.C)(this._transformation,e),this._boundingSphere=null}get boundingInfo(){return this.geometry.boundingInfo}objectShaderTransformationChanged(e){var t;null==e?this._shaderTransformation=null:(null!==(t=this._shaderTransformation)&&void 0!==t||(this._shaderTransformation=(0,P.vt)()),(0,T.lw)(this._shaderTransformation,e,this.geometry.transformation)),this._boundingSphere=null}get boundingSphere(){var e;return this.boundingInfo?(null==this._boundingSphere&&(null!==(e=this._boundingSphere)&&void 0!==e||(this._boundingSphere=(0,$.d)()),(0,M.e)((0,$.g)(this._boundingSphere),this.boundingInfo.center,this.shaderTransformation),this._boundingSphere[3]=this.boundingInfo.radius*(0,Rs.hG)(this.shaderTransformation)),this._boundingSphere):$.N}get material(){return this.geometry.material}get type(){return this.geometry.type}get shaderTransformation(){var e;return null!==(e=this._shaderTransformation)&&void 0!==e?e:this.transformation}get attributes(){return this.geometry.attributes}get highlights(){return this.geometry.highlights}get occludees(){return this.geometry.occludees}get visible(){return this.geometry.visible}set visible(e){this.geometry.visible=e}}function hu(e){return function(e){return e instanceof Float32Array&&e.length>=16}(e)||function(e){return Array.isArray(e)&&e.length>=16}(e)}var uu=i(88105),pu=i(40318),fu=i(75803),gu=i(12028);class mu{constructor(){this.scale=0,this.factor=0,this.minScaleFactor=0}}var _u=i(99362),vu=i(19061);class yu extends Xs.w{initializeConfiguration(e,t){t.spherical=e.viewingMode===ae.RT.Global}initializeProgram(e){return new Ks.B(e.rctx,yu.shader.get().build(this.configuration),$s.D)}initializePipeline(){const e=this.configuration.transparencyPassType,t=this.configuration,i=e===Lo.y.NONE,r=e===Lo.y.FrontFace,n=this.configuration.hasPolygonOffset?bu:null,s=t.draped?null:(i||r)&&t.output!==ks.V.Highlight&&(t.depthEnabled||t.occlusionPass)?ta.kn:null;return(0,ta.Ey)({blending:t.output===ks.V.Color||t.output===ks.V.Alpha||t.output===ks.V.Highlight?i?xu:(0,Io.ez)(e):null,depthTest:t.draped?null:{func:ft.MT.LEQUAL},depthWrite:s,colorWrite:ta.wE,polygonOffset:n})}get primitiveType(){return this.configuration.occlusionPass?ft.WR.POINTS:ft.WR.TRIANGLES}}yu.shader=new Ys.$(vu.H,(()=>i.e(271).then(i.bind(i,60271))));const bu={factor:0,units:-4},xu=(0,ta.ox)(ft.dn.ONE,ft.dn.ONE_MINUS_SRC_ALPHA);class Su extends na.E{constructor(){super(...arguments),this.output=ks.V.Color,this.transparencyPassType=Lo.y.NONE,this.screenCenterOffsetUnitsEnabled=!1,this.spherical=!1,this.occlusionTestEnabled=!0,this.signedDistanceFieldEnabled=!1,this.sampleSignedDistanceFieldTexelCenter=!1,this.vvSize=!1,this.vvColor=!1,this.hasVerticalOffset=!1,this.hasScreenSizePerspective=!1,this.debugDrawLabelBorder=!1,this.hasSlicePlane=!1,this.hasPolygonOffset=!1,this.depthEnabled=!0,this.pixelSnappingEnabled=!0,this.draped=!1,this.multipassEnabled=!1,this.cullAboveGround=!1,this.occlusionPass=!1,this.objectAndLayerIdColorInstanced=!1}}(0,r._)([(0,ra.W)({count:ks.V.COUNT})],Su.prototype,"output",void 0),(0,r._)([(0,ra.W)({count:Lo.y.COUNT})],Su.prototype,"transparencyPassType",void 0),(0,r._)([(0,ra.W)()],Su.prototype,"screenCenterOffsetUnitsEnabled",void 0),(0,r._)([(0,ra.W)()],Su.prototype,"spherical",void 0),(0,r._)([(0,ra.W)()],Su.prototype,"occlusionTestEnabled",void 0),(0,r._)([(0,ra.W)()],Su.prototype,"signedDistanceFieldEnabled",void 0),(0,r._)([(0,ra.W)()],Su.prototype,"sampleSignedDistanceFieldTexelCenter",void 0),(0,r._)([(0,ra.W)()],Su.prototype,"vvSize",void 0),(0,r._)([(0,ra.W)()],Su.prototype,"vvColor",void 0),(0,r._)([(0,ra.W)()],Su.prototype,"hasVerticalOffset",void 0),(0,r._)([(0,ra.W)()],Su.prototype,"hasScreenSizePerspective",void 0),(0,r._)([(0,ra.W)()],Su.prototype,"debugDrawLabelBorder",void 0),(0,r._)([(0,ra.W)()],Su.prototype,"hasSlicePlane",void 0),(0,r._)([(0,ra.W)()],Su.prototype,"hasPolygonOffset",void 0),(0,r._)([(0,ra.W)()],Su.prototype,"depthEnabled",void 0),(0,r._)([(0,ra.W)()],Su.prototype,"pixelSnappingEnabled",void 0),(0,r._)([(0,ra.W)()],Su.prototype,"draped",void 0),(0,r._)([(0,ra.W)()],Su.prototype,"multipassEnabled",void 0),(0,r._)([(0,ra.W)()],Su.prototype,"cullAboveGround",void 0),(0,r._)([(0,ra.W)()],Su.prototype,"occlusionPass",void 0),(0,r._)([(0,ra.W)()],Su.prototype,"objectAndLayerIdColorInstanced",void 0),(0,r._)([(0,ra.W)({constValue:!0})],Su.prototype,"hasSliceInVertexProgram",void 0),(0,r._)([(0,ra.W)({constValue:!1})],Su.prototype,"hasVvInstancing",void 0);class wu extends qs.im{constructor(e){super(e,new ju),this._configuration=new Su,this.produces=new Map([[Qs.N.HUD_MATERIAL,e=>(0,ks.L0)(e)&&!this.parameters.drawInSecondSlot],[Qs.N.LABEL_MATERIAL,e=>(0,ks.L0)(e)&&this.parameters.drawInSecondSlot],[Qs.N.OCCLUSION_PIXELS,()=>this.parameters.occlusionTest],[Qs.N.DRAPED_MATERIAL,e=>(0,ks.L0)(e)]])}getConfiguration(e,t){return this._configuration.output=e,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasVerticalOffset=!!this.parameters.verticalOffset,this._configuration.hasScreenSizePerspective=!!this.parameters.screenSizePerspective,this._configuration.screenCenterOffsetUnitsEnabled="screen"===this.parameters.centerOffsetUnits,this._configuration.hasPolygonOffset=this.parameters.polygonOffset,this._configuration.draped=this.parameters.draped,this._configuration.occlusionTestEnabled=this.parameters.occlusionTest,this._configuration.pixelSnappingEnabled=this.parameters.pixelSnappingEnabled,this._configuration.signedDistanceFieldEnabled=this.parameters.textureIsSignedDistanceField,this._configuration.sampleSignedDistanceFieldTexelCenter=this.parameters.sampleSignedDistanceFieldTexelCenter,this._configuration.vvSize=!!this.parameters.vvSize,this._configuration.vvColor=!!this.parameters.vvColor,this._configuration.occlusionPass=t.slot===Qs.N.OCCLUSION_PIXELS&&this.parameters.occlusionTest,e===ks.V.Color&&(this._configuration.debugDrawLabelBorder=!!Fn.b.LABELS_SHOW_BORDER),this._configuration.depthEnabled=this.parameters.depthEnabled,this._configuration.transparencyPassType=t.transparencyPassType,this._configuration.multipassEnabled=t.multipassEnabled,this._configuration.cullAboveGround=t.multipassTerrain.cullAboveGround,this._configuration}intersect(e,t,i,r,n,s){if(!(i.options.selectionMode&&i.options.hud&&e.visible&&i.point))return;const a=this.parameters,o=i.point,l=i.camera;let{scaleX:c,scaleY:d}=this._getScreenScale(e);c*=l.pixelRatio,d*=l.pixelRatio,(0,E.z0)(Iu,t),e.attributes.has(Pt.r.FEATUREATTRIBUTE)&&function(e){const t=e[0],i=e[1],r=e[2],n=e[3],s=e[4],a=e[5],o=e[6],l=e[7],c=e[8],d=1/Math.sqrt(t*t+i*i+r*r),h=1/Math.sqrt(n*n+s*s+a*a),u=1/Math.sqrt(o*o+l*l+c*c);e[0]=t*d,e[1]=i*d,e[2]=r*d,e[3]=n*h,e[4]=s*h,e[5]=a*h,e[6]=o*u,e[7]=l*u,e[8]=c*u}(Iu);const h=e.attributes.get(Pt.r.POSITION),u=e.attributes.get(Pt.r.SIZE),p=e.attributes.get(Pt.r.NORMAL),f=e.attributes.get(Pt.r.CENTEROFFSETANDDISTANCE);(0,br.vA)(h.size>=3);const g=(0,vu.c)(a),m="screen"===this.parameters.centerOffsetUnits;for(let _=0;_<h.data.length/h.size;_++){const e=_*h.size;(0,M.s)(Eu,h.data[e],h.data[e+1],h.data[e+2]),(0,M.e)(Eu,Eu,t);const r=_*u.size;Bu[0]=u.data[r]*c,Bu[1]=u.data[r+1]*d,(0,M.e)(Eu,Eu,l.viewMatrix);const n=_*f.size;if((0,M.s)(Fu,f.data[n],f.data[n+1],f.data[n+2]),!m&&(Eu[0]+=Fu[0],Eu[1]+=Fu[1],0!==Fu[2])){const e=Fu[2];(0,M.n)(Fu,Eu),(0,M.f)(Eu,Eu,(0,M.h)(Fu,Fu,e))}const v=_*p.size;if((0,M.s)(Ou,p.data[v],p.data[v+1],p.data[v+2]),this._normalAndViewAngle(Ou,Iu,l,Gu),this._applyVerticalOffsetTransformationView(Eu,Gu,l,Ru),l.applyProjection(Eu,Tu),Tu[0]>-1){m&&(Fu[0]||Fu[1])&&(Tu[0]+=Fu[0]*l.pixelRatio,0!==Fu[1]&&(Tu[1]+=(0,gu.m0)(Fu[1],Ru.factorAlignment)*l.pixelRatio),l.unapplyProjection(Tu,Eu)),Tu[0]+=this.parameters.screenOffset[0]*l.pixelRatio,Tu[1]+=this.parameters.screenOffset[1]*l.pixelRatio,Tu[0]=Math.floor(Tu[0]),Tu[1]=Math.floor(Tu[1]),(0,gu.MD)(Bu,Ru.factor,Bu);const e=Uu*l.pixelRatio;let t=0;if(a.textureIsSignedDistanceField&&(t=a.outlineSize*l.pixelRatio/2),Au(o,Tu[0],Tu[1],Bu,e,t,a,g)){const e=i.ray;if((0,M.e)(Mu,Eu,(0,T.B8)(Lu,l.viewMatrix)),Tu[0]=o[0],Tu[1]=o[1],l.unprojectFromRenderScreen(Tu,Eu)){const t=(0,I.vt)();(0,M.c)(t,e.direction);const i=1/(0,M.l)(t);(0,M.h)(t,t,i),s((0,M.p)(e.origin,Eu)*i,t,-1,!0,1,Mu)}}}}}intersectDraped(e,t,i,r,n,s){const a=e.attributes.get(Pt.r.POSITION),o=e.attributes.get(Pt.r.SIZE),l=this.parameters,c=(0,vu.c)(l);let{scaleX:d,scaleY:h}=this._getScreenScale(e);d*=e.screenToWorldRatio,h*=e.screenToWorldRatio;const u=zu*e.screenToWorldRatio;for(let p=0;p<a.data.length/a.size;p++){const t=p*a.size,i=a.data[t],f=a.data[t+1],g=p*o.size;Bu[0]=o.data[g]*d,Bu[1]=o.data[g+1]*h;let m=0;l.textureIsSignedDistanceField&&(m=l.outlineSize*e.screenToWorldRatio/2),Au(r,i,f,Bu,u,m,l,c)&&n(s.dist,s.normal,-1,!1)}}createBufferWriter(){return new Zu(this)}_normalAndViewAngle(e,t,i,r){return hu(t)&&(t=(0,E.z0)(Du,t)),(0,M.t)(r.normal,e,t),(0,M.e)(r.normal,r.normal,i.viewInverseTransposeMatrix),r.cosAngle=(0,M.j)(Pu,Hu),r}_updateScaleInfo(e,t,i){const r=this.parameters;null!=r.screenSizePerspective?(0,gu.cJ)(i,t,r.screenSizePerspective,e.factor):(e.factor.scale=1,e.factor.factor=0,e.factor.minScaleFactor=0),null!=r.screenSizePerspectiveAlignment?(0,gu.cJ)(i,t,r.screenSizePerspectiveAlignment,e.factorAlignment):(e.factorAlignment.factor=e.factor.factor,e.factorAlignment.scale=e.factor.scale,e.factorAlignment.minScaleFactor=e.factor.minScaleFactor)}applyShaderOffsetsView(e,t,i,r,n,s,a){const o=this._normalAndViewAngle(t,i,n,Gu);return this._applyVerticalGroundOffsetView(e,o,n,a),this._applyVerticalOffsetTransformationView(a,o,n,s),this._applyPolygonOffsetView(a,o,r[3],n,a),this._applyCenterOffsetView(a,r,a),a}applyShaderOffsetsNDC(e,t,i,r,n){return this._applyCenterOffsetNDC(e,t,i,r),null!=n&&(0,M.c)(n,r),this._applyPolygonOffsetNDC(r,t,i,r),r}_applyPolygonOffsetView(e,t,i,r,n){const s=r.aboveGround?1:-1;let a=Math.sign(i);0===a&&(a=s);const o=s*a;if(this.parameters.shaderPolygonOffset<=0)return(0,M.c)(n,e);const l=(0,U.qE)(Math.abs(t.cosAngle),.01,1),c=1-Math.sqrt(1-l*l)/l/r.viewport[2];return(0,M.h)(n,e,o>0?c:1/c),n}_applyVerticalGroundOffsetView(e,t,i,r){const n=(0,M.l)(e),s=i.aboveGround?1:-1,a=i.computeRenderPixelSizeAtDist(n)*pu.R,o=(0,M.h)(Eu,t.normal,s*a);return(0,M.g)(r,e,o),r}_applyVerticalOffsetTransformationView(e,t,i,r){var n,s;const a=this.parameters;if(null===(n=a.verticalOffset)||void 0===n||!n.screenLength){if(a.screenSizePerspective||a.screenSizePerspectiveAlignment){const i=(0,M.l)(e);this._updateScaleInfo(r,i,t.cosAngle)}else r.factor.scale=1,r.factorAlignment.scale=1;return e}const o=(0,M.l)(e),l=null!==(s=a.screenSizePerspectiveAlignment)&&void 0!==s?s:a.screenSizePerspective,c=(0,_u.kE)(i,o,a.verticalOffset,t.cosAngle,l);return this._updateScaleInfo(r,o,t.cosAngle),(0,M.h)(t.normal,t.normal,c),(0,M.g)(e,e,t.normal)}_applyCenterOffsetView(e,t,i){const r="screen"!==this.parameters.centerOffsetUnits;return i!==e&&(0,M.c)(i,e),r&&(i[0]+=t[0],i[1]+=t[1],t[2]&&((0,M.n)(Ou,i),(0,M.g)(i,i,(0,M.h)(Ou,Ou,t[2])))),i}_applyCenterOffsetNDC(e,t,i,r){const n="screen"!==this.parameters.centerOffsetUnits;return r!==e&&(0,M.c)(r,e),n||(r[0]+=t[0]/i.fullWidth*2,r[1]+=t[1]/i.fullHeight*2),r}_applyPolygonOffsetNDC(e,t,i,r){const n=this.parameters.shaderPolygonOffset;if(e!==r&&(0,M.c)(r,e),n){const e=i.aboveGround?1:-1,s=e*Math.sign(t[3]);r[2]-=(s||e)*n}return r}createGLMaterial(e){return new Cu(e)}calculateRelativeScreenBounds(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:(0,Q.vt)();return function(e,t,i,r){r[0]=e.anchorPosition[0]*-t[0]+e.screenOffset[0]*i,r[1]=e.anchorPosition[1]*-t[1]+e.screenOffset[1]*i}(this.parameters,e,t,i),i[2]=i[0]+e[0],i[3]=i[1]+e[1],i}_getScreenScale(e){const t=e.attributes.get(Pt.r.FEATUREATTRIBUTE);if(null==t)return{scaleX:1,scaleY:1};const i=(0,L.ci)(t.data,Vu),[r,n]=(0,vs.VC)(Nu,this.parameters,i);return{scaleX:r,scaleY:n}}}class Cu extends fu.m{constructor(e){super({...e,...e.material.parameters})}selectProgram(e){return this.ensureTechnique(yu,e)}beginSlot(e){return this.updateTexture(this._material.parameters.textureId),this._material.setParameters(this.textureBindParameters),this.selectProgram(e)}}function Au(e,t,i,r,n,s,a,o){let l=t-n-(o[0]>0?r[0]*o[0]:0),c=l+r[0]+2*n,d=i-n-(o[1]>0?r[1]*o[1]:0),h=d+r[1]+2*n;const u=a.distanceFieldBoundingBox;return a.textureIsSignedDistanceField&&null!=u&&(l+=r[0]*u[0],d+=r[1]*u[1],c-=r[0]*(1-u[2]),h-=r[1]*(1-u[3]),l-=s,c+=s,d-=s,h+=s),e[0]>l&&e[0]<c&&e[1]>d&&e[1]<h}const Ru=new class{constructor(){this.factor=new mu,this.factorAlignment=new mu}},Eu=(0,I.vt)(),Ou=(0,I.vt)(),Tu=(0,L.vt)(),Pu=(0,I.vt)(),Mu=(0,I.vt)(),Iu=(0,O.vt)(),Du=(0,O.vt)(),Lu=(0,P.vt)(),Fu=(0,I.vt)(),Nu=(0,I.vt)(),Vu=(0,L.vt)(),Gu={normal:Pu,cosAngle:0},Uu=1,zu=2,Bu=[0,0],Hu=(0,I.fA)(0,0,1);class ju extends fu.N{constructor(){super(...arguments),this.renderOccluded=qs.m$.Occlude,this.isDecoration=!1,this.color=(0,L.fA)(1,1,1,1),this.texCoordScale=[1,1],this.polygonOffset=!1,this.anchorPosition=(0,pr.fA)(.5,.5),this.screenOffset=[0,0],this.shaderPolygonOffset=1e-5,this.textureIsSignedDistanceField=!1,this.sampleSignedDistanceFieldTexelCenter=!1,this.outlineColor=(0,L.fA)(1,1,1,1),this.outlineSize=0,this.vvSizeEnabled=!1,this.vvSize=null,this.vvColor=null,this.vvOpacity=null,this.vvSymbolAnchor=null,this.vvSymbolRotationMatrix=null,this.hasSlicePlane=!1,this.pixelSnappingEnabled=!0,this.occlusionTest=!0,this.centerOffsetUnits="world",this.drawInSecondSlot=!1,this.depthEnabled=!0,this.draped=!1}}const Wu=(0,Ws.BP)().vec3f(Pt.r.POSITION).vec3f(Pt.r.NORMAL).vec2f(Pt.r.UV0).vec4u8(Pt.r.COLOR).vec2f(Pt.r.SIZE).vec4f(Pt.r.CENTEROFFSETANDDISTANCE).vec4f(Pt.r.FEATUREATTRIBUTE),ku=Wu.clone().vec4u8(Pt.r.OBJECTANDLAYERIDCOLOR);class Zu{constructor(e){this._material=e,this.vertexBufferLayout=(0,h.A)("enable-feature:objectAndLayerId-rendering")?ku:Wu}elementCount(e){return 6*e.attributes.get(Pt.r.POSITION).indices.length}write(e,t,i,r,n){(0,Js.Hk)(i.attributes.get(Pt.r.POSITION),e,r.position,n,6),(0,Js.p1)(i.attributes.get(Pt.r.NORMAL),t,r.normal,n,6);const s=i.attributes.get(Pt.r.UV0).data;let a,o,l,c;if(null==s||s.length<4){const e=this._material.parameters;a=0,o=0,l=e.texCoordScale[0],c=e.texCoordScale[1]}else a=s[0],o=s[1],l=s[2],c=s[3];l=Math.min(1.99999,l+1),c=Math.min(1.99999,c+1);let d=i.attributes.get(Pt.r.POSITION).indices.length,h=n;const u=r.uv0;for(let _=0;_<d;++_)u.set(h,0,a),u.set(h,1,o),h++,u.set(h,0,l),u.set(h,1,o),h++,u.set(h,0,l),u.set(h,1,c),h++,u.set(h,0,l),u.set(h,1,c),h++,u.set(h,0,a),u.set(h,1,c),h++,u.set(h,0,a),u.set(h,1,o),h++;(0,Js.tb)(i.attributes.get(Pt.r.COLOR),4,r.color,n,6);const{data:p,indices:f}=i.attributes.get(Pt.r.SIZE);d=f.length;const g=r.size;h=n;for(let _=0;_<d;++_){const e=p[2*f[_]],t=p[2*f[_]+1];for(let i=0;i<6;++i)g.set(h,0,e),g.set(h,1,t),h++}if(i.attributes.get(Pt.r.CENTEROFFSETANDDISTANCE)?(0,Js.Ut)(i.attributes.get(Pt.r.CENTEROFFSETANDDISTANCE),r.centerOffsetAndDistance,n,6):(0,Js.Pq)(r.centerOffsetAndDistance,n,6*d),i.attributes.get(Pt.r.FEATUREATTRIBUTE)?(0,Js.Ut)(i.attributes.get(Pt.r.FEATUREATTRIBUTE),r.featureAttribute,n,6):(0,Js.Pq)(r.featureAttribute,n,6*d),null!=i.objectAndLayerIdColor){var m;const e=null===(m=i.attributes.get(Pt.r.POSITION))||void 0===m?void 0:m.indices;if(e){const t=e.length,s=r.getField(Pt.r.OBJECTANDLAYERIDCOLOR,uu.XP);(0,Js.tH)(i.objectAndLayerIdColor,s,t,n,6)}}}}const qu=(0,I.fA)(0,0,1),Qu=cu.CN,Ju=[Qu/2,Qu/2,1-Qu/2,1-Qu/2],Yu=[cu.Q_*Qu,cu.Q_*Qu];class Xu extends bs{getCachedSize(){return{size:this._getIconSize()}}constructor(e,t,i,r){super(e,t,i,r),this._cimSymbolMaterials=new Map,this._cimSymbolTextures=new Map,this._cimMaterialParametersInfo=null,this._size=null,this._symbolTextureRatio=1,this._outlineSize=0,this._patchTask=null,this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!0}}async doLoad(e){this._validateOrThrow();const t=this._prepareMaterialParameters(),i=this._getPrimitive();if(null!=i)this._prepareResourcesPrimitive(t,i);else{const i=(0,Nh.N7)(this.symbolLayer),r=(0,ct.r$)(i);r&&"application/json"===r.mediaType?await this._prepareResourcesCIM(t,JSON.parse(r.data),e):await this._prepareResourcesHref(t,i,e)}}_validateOrThrow(){if(this._drivenProperties.size)return;const e=rs(this._getIconSize());if(e)throw new oe.A("graphics3diconsymbollayer:invalid-size",e)}_getIconSize(){const e=this.symbolLayer,t=Math.round(null!=e.size?(0,Ln.Lz)(e.size):16);return this._drivenProperties.size?Math.max(t,64):t}_generateTextureCIM(e){let t=this._cimData;if(t&&t.symbol||this.logger.error("Can't create texture, CIM data is undefined"),t.primitiveOverrides){t=(0,lt.o8)(t);const i=t.primitiveOverrides;Mh.$.evaluateOverrides(i,e,this._arcadeInfo.geometryType,null,null),Mh.$.applyOverrides(t.symbol,i)}const i=(0,Th.Wm)(JSON.stringify(t));let r=this._cimSymbolTextures.get(i);if(r)return r;const n=this._context.sharedResources.cimSymbolRasterizer,s=this._context.renderer&&"dictionary"===this._context.renderer.type?this._context.renderer.fieldMap:null;s&&Mh.$.applyDictionaryTextOverrides(t.symbol,e,s,null);const a=null!=this._cimScaleFactorOrFunction?(0,Ih.s4)(this._cimScaleFactorOrFunction,e):1;1!==a&&t.symbol&&(0,Dh.Km)(t.symbol,a,!0);const o=Ph.wp.getEnvelope(t,null,n.resourceManager);if(o&&o.width&&o.height){var l,c;const e=o.x+o.width/2,i=o.y+o.height/2,s=n.rasterize({type:"cim",data:t},o.width,o.height,e,i,1,"esriGeometryPoint"),a=new Fh.Q({x:-o.x/o.width-.5,y:(o.height+o.y)/o.height-.5});this._cimMaterialParametersInfo.anchorPosition=this._getAnchorPos("relative",a),r=new pt.g(s,{width:null!==(l=null===s||void 0===s?void 0:s.width)&&void 0!==l?l:1,height:null!==(c=null===s||void 0===s?void 0:s.height)&&void 0!==c?c:1})}else r=new pt.g(new ImageData(1,1),{width:1,height:1});return this._cimSymbolTextures.set(i,r),this._context.stage.add(r),r}_prepareMaterialParameters(){const e={anchorPosition:this._getAnchorPos(this.symbolLayer.anchor,this.symbolLayer.anchorPosition)},t=this.symbol;if(function(e){return e&&"point-3d"===e.type&&e.hasVisibleVerticalOffset()}(t)){const{screenLength:i,minWorldLength:r,maxWorldLength:n}=t.verticalOffset;e.verticalOffset={screenLength:(0,Ln.Lz)(i),minWorldLength:r||0,maxWorldLength:null!=n?n:1/0}}return this._context.screenSizePerspectiveEnabled&&(e.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings),e.occlusionTest=!0,e.hasSlicePlane=this._context.slicePlaneEnabled,e}_prepareResourcesPrimitive(e,t){const i=this._getOutlineSize();if($u(t)&&0===i)throw new Error("Nothing to render");if(this._outlineSize=i,e.color=this._getFillColor(),e.outlineColor=this._getOutlineColor(),e.outlineSize=this._outlineSize,null!=this._context.sharedResources.textures){const i=this._context.sharedResources.textures.fromData("".concat(t,"-icon"),(()=>(0,cu.sZ)(t)));this._textureHandle=i,e.textureId=i.texture.id}e.textureIsSignedDistanceField=!0,e.sampleSignedDistanceFieldTexelCenter=(0,cu.ny)(t),e.distanceFieldBoundingBox=Ju;const r=this._getIconSize();this._size=[r,r],this._symbolTextureRatio=1/Qu,this._createMaterialAndAddToStage(e,this._context.stage)}async _prepareResourcesHref(e,t,i){this._outlineSize=this._getOutlineSize(),e.color=this._getFillColor(),e.outlineColor=this._getOutlineColor(),e.outlineSize=this._outlineSize,e.textureIsSignedDistanceField=!1;const r=this._getIconSize(),n=r*this._context.graphicsCoreOwner.view.state.rasterPixelRatio;if(null!=this._context.sharedResources.textures){const s=await(0,ot.Ke)(this._context.sharedResources.textures.fromUrl(t,n,{signal:i}));if(!1===s.ok)throw(0,o.QP)(s.error),new oe.A("graphics3diconsymbollayer:request-failed","Failed to load (Request for icon resource failed: ".concat(t,")"));this._textureHandle=s.value;const a=s.value.texture;this._size=this._computeSizeFromTexture(a,r),e.textureId=a.id}this._createMaterialAndAddToStage(e,this._context.stage)}async _prepareResourcesCIM(e,t,r){if(this._cimData=t,!this._context.sharedResources.cimSymbolRasterizer){const e=(await i.e(6840).then(i.bind(i,6840))).CIMSymbolRasterizer;(0,o.Te)(r),this._context.sharedResources.cimSymbolRasterizer||(this._context.sharedResources.cimSymbolRasterizer=new e(this._context.renderCoordsHelper.spatialReference))}const n=this._context.sharedResources.cimSymbolRasterizer,s=[],a=t,l=null===a||void 0===a?void 0:a.symbol;Ph.wp.fetchResources(l,n.resourceManager,s,r),Ph.wp.fetchFonts(l,n.resourceManager,s);const c=this._context.layer.fields?this._context.layer.fields.map((e=>e.toJSON())):[],d=this._context.renderCoordsHelper.spatialReference;if(this._arcadeInfo={spatialReference:d,fields:c,geometryType:"esriGeometryPoint"},null!==a&&void 0!==a&&a.primitiveOverrides&&s.push(Mh.$.createRenderExpressions(a.primitiveOverrides,this._arcadeInfo)),s.length>0&&(await Promise.all(s),(0,o.Te)(r)),this._context.renderer&&"dictionary"===this._context.renderer.type&&this._context.renderer.scaleExpression){const e=this._context.renderer;if(e.scaleExpression){const t=e.scaleExpression,i=await(0,Kt.Ad)(t,this._context.layer.spatialReference,c);this._cimScaleFactorOrFunction=(e,t,r)=>{const n=(0,Vh.A)(i,e,{$view:r},"esriGeometryPoint",t);return null!==n?n:1}}}(0,o.Te)(r),this._cimMaterialParametersInfo=e,this._cimMaterialParametersInfo.color=this._getFillColor(),this._cimMaterialParametersInfo.outlineColor=[0,0,0,0],this._cimMaterialParametersInfo.outlineSize=0,this._cimMaterialParametersInfo.textureIsSignedDistanceField=!1}_getPrimitive(){return this.symbolLayer.resource&&this.symbolLayer.resource.href?null:this.symbolLayer.resource&&this.symbolLayer.resource.primitive||Lh.r}_getOutlineSize(){var e;let t=0;const i=this.symbolLayer;return null!=(null===(e=i.outline)||void 0===e?void 0:e.size)?Math.max((0,Ln.Lz)(i.outline.size),0):(t=$u(this._getPrimitive())?1.5:0,Math.max(t,0))}_getOutlineColor(){var e;const t=this._getLayerOpacity(),i=this.symbolLayer,r=null===i||void 0===i||null===(e=i.outline)||void 0===e?void 0:e.color;if(null!=r){const e=v.A.toUnitRGB(r),i=r.a*t;return[e[0],e[1],e[2],i]}return[0,0,0,0]}_getFillColor(){var e;if($u(this._getPrimitive()))return Gh;const t=null==this._getPrimitive(),i=null===(e=this.symbolLayer)||void 0===e||null===(e=e.material)||void 0===e?void 0:e.color;return this._getCombinedOpacityAndColor(i,{hasIntrinsicColor:t})}_getAnchorPos(e,t){return"relative"===e?(0,pr.fA)((t.x||0)+.5,.5-(t.y||0)):e in au?au[e]:au.center}_createMaterialAndAddToStage(e,t){if(this._cimData){var i;this._fastUpdates=null;let r=e.textureId?this._cimSymbolMaterials.get(e.textureId):null;return r||(r=new wu(e),this._cimSymbolMaterials.set(null!==(i=e.textureId)&&void 0!==i?i:0,r),t.add(r)),r}return this._fastUpdates=(0,vs.s_)(this._context.renderer,this._fastVisualVariableConvertOptions()),this._fastUpdates&&(e={...e,...this._fastUpdates.materialParameters}),this._materials[0]=new wu(e),t.add(this._materials[0]),this._materials[0]}_setDrapingDependentMaterialParameters(){this.draped&&(this._forEachMaterial((e=>{e.setParameters({verticalOffset:null,screenSizePerspective:null,occlusionTest:!1,hasSlicePlane:!1,shaderPolygonOffset:0,draped:this.draped})})),this.layerOpacityChanged())}destroy(){super.destroy(),this._patchTask=(0,le.DC)(this._patchTask),this._forEachMaterial((e=>this._context.stage.remove(e))),this._materials.length=0,this._cimSymbolMaterials.clear(),this._cimSymbolTextures.forEach((e=>this._context.stage.remove(e))),this._cimSymbolTextures.clear(),this._textureHandle=(0,le.Gz)(this._textureHandle)}_getScaleFactor(e,t){if(this._drivenProperties.size&&e.size){for(let t=0;t<3;t++){const i=e.size[t];i&&"symbol-value"!==i&&"proportional"!==i&&(e.size[t]=(0,Ln.Lz)(i))}if("symbol-value"===e.size[0])return 1;if(isFinite(+e.size[0]))return+e.size[0]/t;if(isFinite(+e.size[2]))return+e.size[2]/t}return 1}createGraphics3DGraphic(e){var t;const i=e.graphic;if(!this._validateGeometry(i.geometry))return null;let r,n=[0,0];if(this._cimData){if(!this._cimData.symbol)return null;const e=this._generateTextureCIM(i),t={textureId:e.id,...this._cimMaterialParametersInfo};r=this._createMaterialAndAddToStage(t,this._context.stage),n=[e.parameters.width,e.parameters.height]}else n=this._size,r=this._materials[0];const s=Bs(i.geometry);if(null==s)return this.logger.warn("unsupported geometry type for icon symbol: ".concat(i.geometry.type)),null;const a=e.renderingInfo,o=this._getVertexOpacityAndColor(a);let l=1;if(null===(t=this._fastUpdates)||void 0===t||!t.visualVariables.size){const e=n[0]>n[1]?n[0]:n[1];l=this._getScaleFactor(a,e)}l*=this._symbolTextureRatio;const c=(0,pr.fA)(n[0]*l,n[1]*l),d=this.setGraphicElevationContext(i);return this.ensureDrapedStatus("on-the-ground"===d.mode)&&this._setDrapingDependentMaterialParameters(),this.draped?this._createAsOverlay(i,s,r,o,c,e.layer.uid):this._createAs3DShape(i,s,r,o,c,d,i.uid)}layerOpacityChanged(){const e=this._getFillColor(),t=this._getOutlineColor();this._forEachMaterial((i=>{i.setParameters({color:e}),i.setParameters({outlineColor:t})}))}layerElevationInfoChanged(e,t,i){const r=this._elevationContext.mode,n=Lt(Xu.elevationModeChangeTypes,i,r);if(n!==Tt.UPDATE)return n;const s=Ft(r)||"absolute-height"===r;return this.updateGraphics3DGraphicElevationInfo(e,t,(()=>s))}slicePlaneEnabledChanged(){return this.draped||this._forEachMaterial((e=>{e.setParameters({hasSlicePlane:this._context.slicePlaneEnabled})})),!0}physicalBasedRenderingChanged(){return!0}get pixelRatioChanged(){return null!=this._getPrimitive()}applyRendererDiff(e,t){for(const r in e.diff){var i;if("visualVariables"!==r)return gs.RecreateSymbol;if(!(0,vs.J_)(this._fastUpdates,t,this._fastVisualVariableConvertOptions()))return gs.RecreateSymbol;null===(i=this._materials[0])||void 0===i||i.setParameters(this._fastUpdates.materialParameters)}return gs.FastUpdate}prepareSymbolLayerPatch(e){var t;if(null!==(t=this._patchTask)&&void 0!==t&&t.abort(),"partial"!==e.diff.type)return;const i=e.diff.diff;this._preparePatchResource(e,i)}_preparePatchResource(e,t){var i;if(!t.resource||"partial"!==t.resource.type)return;const r=t.resource.diff;if("complete"!==(null===r||void 0===r||null===(i=r.href)||void 0===i?void 0:i.type))return;const n=r.href.newValue,{textures:s}=this._context.sharedResources;if(null==n||null==s)return;const a=this._getIconSize(),l=a*this._context.graphicsCoreOwner.view.state.pixelRatio;e.symbolLayerStatePatches.push((()=>{this._patchTask=(0,le.DC)(this._patchTask),this._patchTask=(0,ot.UT)((e=>this._context.schedule((async(e,t)=>{const i=await(0,ot.Ke)(s.fromUrl(n,l,{signal:t}));(0,o.Te)(t);const r=!i.ok;if(r&&(0,o.QP)(i.error),this._textureHandle=(0,le.Gz)(this._textureHandle),this._patchTask=null,r){this._forEachMaterial((e=>{e.visible=!1,e.setParameters({textureId:null})}));const e="Failed to load (Request for icon resource failed: ".concat(n,")");return void this.logger.error(new oe.A("graphics3diconsymbollayer:request-failed",e))}this._textureHandle=i.value;const c=i.value.texture;this._size=this._computeSizeFromTexture(c,a),this._forEachMaterial((e=>{e.setParameters({textureId:c.id}),e.visible=!0}))}),e)))})),delete r.href}_defaultElevationInfoNoZ(){return Ku}_createAs3DShape(e,t,i,r,n,s,a){const o=this.getFastUpdateAttrValues(e),l=this._context.layer.uid,c=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:a,layerUid:l}),d=Zr(i,qu,null,r,n,ep,null,o,c),h=Us(this._context,t,d,s,a);if(null==h)return null;const u=new ls(this,h.object,[d],null,null,Gn,s);return u.alignedSampledElevation=h.sampledElevation,u.needsElevationUpdates=Ft(s.mode)||"absolute-height"===s.mode,u.getScreenSize=this._createScreenSizeGetter(n,o),u.calculateRelativeScreenBounds=e=>i.calculateRelativeScreenBounds(u.getScreenSize(),1,e),zs(u,t,this._context.elevationProvider),u}_createAsOverlay(e,t,i,r,n,s){i.renderPriority=this._renderPriority;const a=(0,I.vt)();(0,As.g)(t,a,this._context.overlaySR),a[2]=-2;const o=this._context.clippingExtent;if(null!=o&&!(0,q.Uc)(o,a))return null;const l=this.getFastUpdateAttrValues(e),c=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:e.uid,layerUid:this._context.layer.uid}),d=Zr(i,qu,a,r,n,null,null,l,c),h=new du(d,{layerUid:s,graphicUid:e.uid}),u=new zh(this,[h],null,this._context.drapeSourceRenderer);return u.getScreenSize=this._createScreenSizeGetter(n,l),u.calculateRelativeScreenBounds=e=>i.calculateRelativeScreenBounds(u.getScreenSize(),1,e),u}_createScreenSizeGetter(e,t){var i=this;const r=this._outlineSize+2;if(this._fastUpdates&&t){const n=e[0]/this._symbolTextureRatio,s=e[1]/this._symbolTextureRatio;return function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,pr.vt)();const[a,o]=(0,vs.VC)(tp,i._fastUpdates.materialParameters,t);return e[0]=a*n+r,e[1]=o*s+r,e}}const n=e[0]/this._symbolTextureRatio+r,s=e[1]/this._symbolTextureRatio+r;return function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,pr.vt)();return e[0]=n,e[1]=s,e}}_fastVisualVariableConvertOptions(){const e=Math.max(this._size[0],this._size[1]),t=(0,I.fA)(e,e,e),i=(0,Ln.PN)(1),r=e*i,n=(0,I.fA)(r,r,r);return new vs.wI({size:!0,color:!0,rotation:!0,opacity:!1},t,n,i)}_forEachMaterial(e){this._materials.forEach(e),this._cimSymbolMaterials.forEach(e)}_computeSizeFromTexture(e,t){var i,r;let{parameters:n}=e;const s=(null!==(i=n.width)&&void 0!==i?i:1)/(null!==(r=n.height)&&void 0!==r?r:1);return s>1?[t,Math.round(t/s)]:[Math.round(t*s),t]}test(){return{...super.test(),material:this._materials[0]}}}function $u(e){return null!=e&&("cross"===e||"x"===e)}Xu.PRIMITIVE_SIZE=Yu,Xu.elevationModeChangeTypes={definedChanged:Tt.UPDATE,staysOnTheGround:Tt.NONE,onTheGroundChanged:Tt.RECREATE};const Ku={mode:"relative-to-ground",offset:0},ep=(0,L.fA)(0,0,0,1),tp=(0,I.vt)();function ip(e){switch(e){case"butt":return Uo.x.BUTT;case"square":return Uo.x.SQUARE;case"round":return Uo.x.ROUND;default:return null}}function rp(e){return"diamond"===e?"kite":e}function np(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;const r=[],n=t.mapPositions;!function(e,t){const{attributeData:{position:i},removeDuplicateStartEnd:r}=e,n=function(e){const t=e.length;return e[0]===e[t-3]&&e[1]===e[t-2]&&e[2]===e[t-1]}(i)&&r,s=i.length/3-(n?1:0),a=new Array(2*(s-1)),o=n?i.slice(0,-3):i;let l=0;for(let c=0;c<s-1;c++)a[l++]=c,a[l++]=c+1;t.push([Pt.r.POSITION,new _r.n(o,a,3,n)])}(t,r);const s=r[0][1].data,a=r[0][1].indices.length,o=(0,X.EH)(a);return function(e,t,i){if(null!=e.attributeData.colorFeature)return;const r=e.attributeData.color;t.push([Pt.r.COLOR,new _r.n(null!==r&&void 0!==r?r:L.Un,i,4)])}(t,r,o),function(e,t,i){var r;null==e.attributeData.sizeFeature&&t.push([Pt.r.SIZE,new _r.n([null!==(r=e.attributeData.size)&&void 0!==r?r:1],i,1,!0)])}(t,r,o),function(e,t,i){e.attributeData.normal&&t.push([Pt.r.NORMAL,new _r.n(e.attributeData.normal,i,3)])}(t,r,o),function(e,t,i){null!=e.attributeData.colorFeature&&t.push([Pt.r.COLORFEATUREATTRIBUTE,new _r.n([e.attributeData.colorFeature],i,1,!0)])}(t,r,o),function(e,t,i){null!=e.attributeData.sizeFeature&&t.push([Pt.r.SIZEFEATUREATTRIBUTE,new _r.n([e.attributeData.sizeFeature],i,1,!0)])}(t,r,o),function(e,t,i){null!=e.attributeData.opacityFeature&&t.push([Pt.r.OPACITYFEATUREATTRIBUTE,new _r.n([e.attributeData.opacityFeature],i,1,!0)])}(t,r,o),function(e,t,i){if(null==e.overlayInfo||e.overlayInfo.renderCoordsHelper.viewingMode!==ae.RT.Global||!e.overlayInfo.spatialReference.isGeographic)return;const r=(0,J.jh)(i.length),n=(0,xt.tO)(e.overlayInfo.spatialReference);for(let h=0;h<r.length;h+=3)(0,N.RC)(i,h,r,h,n);const s=i.length/3,a=(0,Y.oe)(s+1);let o=sp,l=ap,c=0,d=0;(0,Sa.hZ)(o,r[d++],r[d++]),d++,a[0]=0;for(let h=1;h<s+1;++h)h===s&&(d=0),(0,Sa.hZ)(l,r[d++],r[d++]),d++,c+=(0,Sa.xg)(o,l),a[h]=c,[o,l]=[l,o];t.push([Pt.r.DISTANCETOSTART,new _r.n(a,t[0][1].indices,1,!0)])}(t,r,s),new yr.V(e,r,n,vr.X.Line,i)}const sp=(0,pr.vt)(),ap=(0,pr.vt)();function op(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;const r=new Array;for(const{index:n,count:s}of e){if(s<=1)continue;const e=3*n,a=3*s;r.push({position:(0,J.l5)(t,3*n,3*s),mapPositions:null!=i?(0,J.l5)(i,e,a):void 0})}return r}var lp=i(88849);const cp=new Map([[Pt.r.POSITION,0],[Pt.r.PREVPOSITION,1],[Pt.r.UV0,2],[Pt.r.NORMAL,3],[Pt.r.COLOR,4],[Pt.r.COLORFEATUREATTRIBUTE,4],[Pt.r.SIZE,5],[Pt.r.SIZEFEATUREATTRIBUTE,5],[Pt.r.OPACITYFEATUREATTRIBUTE,6]]);class dp extends Xs.w{initializeProgram(e){return new Ks.B(e.rctx,dp.shader.get().build(this.configuration),cp)}_makePipelineState(e,t){const i=this.configuration,r=e===Lo.y.NONE;return(0,ta.Ey)({blending:i.output===ks.V.Color||i.output===ks.V.Alpha?r?Io.V0:(0,Io.ez)(e):null,depthTest:i.space===Po.lM.Draped?null:{func:(0,Io.K_)(e)},depthWrite:i.space===Po.lM.Draped?null:r?i.writeDepth?ta.kn:null:(0,Io.XO)(e),colorWrite:ta.wE,stencilWrite:i.hasOccludees?Do.v0:null,stencilTest:i.hasOccludees?t?Do.a9:Do.qh:null,polygonOffset:{factor:0,units:-10}})}initializePipeline(){return this.configuration.occluder&&(this._occluderPipelineTransparent=(0,ta.Ey)({blending:Io.V0,depthTest:Do.sf,depthWrite:null,colorWrite:ta.wE,stencilWrite:null,stencilTest:Do.mK}),this._occluderPipelineOpaque=(0,ta.Ey)({blending:Io.V0,depthTest:Do.sf,depthWrite:null,colorWrite:ta.wE,stencilWrite:Do.r8,stencilTest:Do.I$}),this._occluderPipelineMaskWrite=(0,ta.Ey)({blending:null,depthTest:Do.m,depthWrite:null,colorWrite:null,stencilWrite:Do.v0,stencilTest:Do.a9})),this._occludeePipelineState=this._makePipelineState(this.configuration.transparencyPassType,!0),this._makePipelineState(this.configuration.transparencyPassType,!1)}getPipeline(e,t,i){return e?this._occludeePipelineState:this.configuration.occluder?i?this._occluderPipelineTransparent:t?this._occluderPipelineOpaque:this._occluderPipelineMaskWrite:super.getPipeline()}}dp.shader=new Ys.$(lp.L,(()=>i.e(6419).then(i.bind(i,66419))));class hp extends qs.im{constructor(e){super(e,new pp),this.produces=new Map([[Qs.N.OPAQUE_MATERIAL,e=>e===ks.V.Highlight||(0,ks.j8)(e)&&this.parameters.renderOccluded===qs.m$.OccludeAndTransparentStencil],[Qs.N.OPAQUE_NO_SSAO_DEPTH,e=>e===ks.V.LinearDepth],[Qs.N.OCCLUDER_MATERIAL,e=>(0,ks.MU)(e)&&this.parameters.renderOccluded===qs.m$.OccludeAndTransparentStencil],[Qs.N.TRANSPARENT_OCCLUDER_MATERIAL,e=>(0,ks.MU)(e)&&this.parameters.renderOccluded===qs.m$.OccludeAndTransparentStencil],[Qs.N.TRANSPARENT_MATERIAL,e=>(0,ks.j8)(e)&&this.parameters.writeDepth],[Qs.N.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL,e=>(0,ks.j8)(e)&&!this.parameters.writeDepth],[Qs.N.DRAPED_MATERIAL,e=>e===ks.V.Color||e===ks.V.Highlight]]),this._vertexAttributeLocations=cp,this._configuration=new Po.Dt,this._layout=this.createLayout()}getConfiguration(e,t){return this._configuration.output=e,this._configuration.space=t.slot===Qs.N.DRAPED_MATERIAL?Po.lM.Draped:this.parameters.worldSpace?Po.lM.World:Po.lM.Screen,this._configuration.hideOnShortSegments=this.parameters.hideOnShortSegments,this._configuration.hasCap=this.parameters.cap!==Uo.x.BUTT,this._configuration.anchor=this.parameters.anchor,this._configuration.hasTip=this.parameters.hasTip,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasOccludees=this.parameters.hasOccludees,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.vvSize=!!this.parameters.vvSize,this._configuration.vvColor=!!this.parameters.vvColor,this._configuration.vvOpacity=!!this.parameters.vvOpacity,this._configuration.occluder=this.parameters.renderOccluded===qs.m$.OccludeAndTransparentStencil,this._configuration.transparencyPassType=t.transparencyPassType,this._configuration.multipassEnabled=t.multipassEnabled,this._configuration.cullAboveGround=t.multipassTerrain.cullAboveGround,this._configuration}intersect(){}createLayout(){const e=(0,Ws.BP)().vec3f(Pt.r.POSITION).vec3f(Pt.r.PREVPOSITION).vec2f(Pt.r.UV0);return this.parameters.worldSpace&&e.vec3f(Pt.r.NORMAL),this.parameters.vvSize?e.f32(Pt.r.SIZEFEATUREATTRIBUTE):e.f32(Pt.r.SIZE),this.parameters.vvColor?e.f32(Pt.r.COLORFEATUREATTRIBUTE):e.vec4f(Pt.r.COLOR),this.parameters.vvOpacity&&e.f32(Pt.r.OPACITYFEATUREATTRIBUTE),e}createBufferWriter(){return new fp(this._layout,this.parameters)}createGLMaterial(e){return new up(e)}}class up extends fu.m{constructor(){super(...arguments),this._markerPrimitive=null}dispose(){super.dispose(),this._markerTextureRepository.release(this._markerPrimitive),this._markerPrimitive=null}_updateParameters(e){const t=this._material.parameters.markerPrimitive;return t!==this._markerPrimitive&&(this._material.setParameters({markerTexture:this._markerTextureRepository.swap(t,this._markerPrimitive)}),this._markerPrimitive=t),this._material.setParameters(this.textureBindParameters),this.ensureTechnique(dp,e)}_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})}beginSlot(e){return this._output!==ks.V.Color&&this._output!==ks.V.Alpha||this._updateOccludeeState(e),this._updateParameters(e)}}class pp extends To.S{constructor(){super(...arguments),this.width=0,this.color=[1,1,1,1],this.markerPrimitive="arrow",this.placement="end",this.cap=Uo.x.BUTT,this.anchor=Po.kJ.Center,this.hasTip=!1,this.worldSpace=!1,this.hideOnShortSegments=!1,this.writeDepth=!0,this.hasSlicePlane=!1,this.vvFastUpdate=!1,this.hasOccludees=!1,this.markerTexture=null}}class fp{constructor(e,t){this.vertexBufferLayout=e,this._parameters=t}elementCount(){return"begin-end"===this._parameters.placement?12:6}write(e,t,i,r,n){const s=i.attributes.get(Pt.r.POSITION).data,a=s.length/3;let o=[1,0,0];const l=i.attributes.get(Pt.r.NORMAL);this._parameters.worldSpace&&null!=l&&(o=l.data);let c=1,d=0;this._parameters.vvSize?d=i.attributes.get(Pt.r.SIZEFEATUREATTRIBUTE).data[0]:i.attributes.has(Pt.r.SIZE)&&(c=i.attributes.get(Pt.r.SIZE).data[0]);let h=[1,1,1,1],u=0;this._parameters.vvColor?u=i.attributes.get(Pt.r.COLORFEATUREATTRIBUTE).data[0]:i.attributes.has(Pt.r.COLOR)&&(h=i.attributes.get(Pt.r.COLOR).data);let p=0;this._parameters.vvOpacity&&(p=i.attributes.get(Pt.r.OPACITYFEATUREATTRIBUTE).data[0]);const f=new Float32Array(r.buffer);let g=n*(this.vertexBufferLayout.stride/4);const m=(e,t,i,r)=>{if(f[g++]=e[0],f[g++]=e[1],f[g++]=e[2],f[g++]=t[0],f[g++]=t[1],f[g++]=t[2],f[g++]=i[0],f[g++]=i[1],this._parameters.worldSpace&&(f[g++]=o[0],f[g++]=o[1],f[g++]=o[2]),this._parameters.vvSize?f[g++]=d:f[g++]=c,this._parameters.vvColor)f[g++]=u;else{const e=Math.min(4*r,h.length-4);f[g++]=h[e],f[g++]=h[e+1],f[g++]=h[e+2],f[g++]=h[e+3]}this._parameters.vvOpacity&&(f[g++]=p)};let _;!function(e){e[e.ASCENDING=1]="ASCENDING",e[e.DESCENDING=-1]="DESCENDING"}(_||(_={}));const v=(t,i)=>{const r=(0,M.s)(gp,s[3*t],s[3*t+1],s[3*t+2]),n=mp;let o=t+i;do{(0,M.s)(n,s[3*o],s[3*o+1],s[3*o+2]),o+=i}while((0,M.F)(r,n)&&o>=0&&o<a);e&&((0,M.e)(r,r,e),(0,M.e)(n,n,e)),m(r,n,[-1,-1],t),m(r,n,[1,-1],t),m(r,n,[1,1],t),m(r,n,[-1,-1],t),m(r,n,[1,1],t),m(r,n,[-1,1],t)},y=this._parameters.placement;"begin"!==y&&"begin-end"!==y||v(0,_.ASCENDING),"end"!==y&&"begin-end"!==y||v(a-1,_.DESCENDING)}}const gp=(0,I.vt)(),mp=(0,I.vt)(),_p={dash:[4,3],dot:[1,3],"long-dash":[8,3],"short-dash":[4,1],"short-dot":[1,1]},vp={dash:_p.dash,"dash-dot":[..._p.dash,..._p.dot],dot:_p.dot,"long-dash":_p["long-dash"],"long-dash-dot":[..._p["long-dash"],..._p.dot],"long-dash-dot-dot":[..._p["long-dash"],..._p.dot,..._p.dot],none:null,"short-dash":_p["short-dash"],"short-dash-dot":[..._p["short-dash"],..._p["short-dot"]],"short-dash-dot-dot":[..._p["short-dash"],..._p["short-dot"],..._p["short-dot"]],"short-dot":_p["short-dot"],solid:null},yp=8;function bp(e){return null!=e&&"style"===e.type?function(e){return null!=e?function(e,t){return null==e?e:{pattern:e.slice(),pixelRatio:t}}(vp[e],yp):null}(e.style):null}var xp=i(76797);const Sp=["polyline","polygon","extent"],wp=new vs.wI({size:!0,color:!0,rotation:!1,opacity:!0});class Cp extends bs{constructor(e,t,i,r){super(e,t,i,r)}async doLoad(){if(this._fastUpdates=(0,vs.s_)(this._context.renderer,wp),!this._drivenProperties.size&&(null!=this.symbolLayer.size?this.symbolLayer.size:(0,Ln.PN)(1))<0)throw new oe.A("graphics3dlinesymbollayer:invalid-size","Symbol sizes may not be negative values")}_getMaterialParameters(e){var t,i;let r=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const n=this._getCombinedOpacityAndColor(r&&this._markerColor||this._materialColor);this._patternHidesLine&&!r&&(n[3]=0);const s={width:this._computeMaterialWidth(null===(t=this.symbolLayer)||void 0===t?void 0:t.size),color:n,hasPolygonOffset:!0,join:this.symbolLayer.join||"miter",cap:ip(this.symbolLayer.cap||"butt"),hasSlicePlane:this._context.slicePlaneEnabled,isClosed:e,stipplePattern:bp(this.symbolLayer.pattern)};return null!==(i=this._fastUpdates)&&void 0!==i&&i.visualVariables?{...s,...this._fastUpdates.materialParameters}:s}get _materialColor(){var e;return null===(e=this.symbolLayer.material)||void 0===e?void 0:e.color}get _markerColor(){var e;return null===(e=this.symbolLayer.marker)||void 0===e?void 0:e.color}get _lineMaterial(){return null==this._materials[Rp.Line]&&(this._materials[Rp.Line]=new zo(this._getMaterialParameters(!1)),this._context.stage.add(this._materials[Rp.Line])),this._materials[Rp.Line]}get _ringMaterial(){return null==this._materials[Rp.Ring]&&(this._materials[Rp.Ring]=new zo(this._getMaterialParameters(!0)),this._context.stage.add(this._materials[Rp.Ring])),this._materials[Rp.Ring]}get _wireframeLineMaterial(){return null==this._materials[Rp.LineWireframe]&&(this._materials[Rp.LineWireframe]=new zo({...this._getMaterialParameters(!1),wireframe:!0}),this._context.stage.add(this._materials[Rp.LineWireframe])),this._materials[Rp.LineWireframe]}get _wireframeRingMaterial(){return null==this._materials[Rp.RingWireframe]&&(this._materials[Rp.RingWireframe]=new zo({...this._getMaterialParameters(!0),wireframe:!0}),this._context.stage.add(this._materials[Rp.RingWireframe])),this._materials[Rp.RingWireframe]}get _markerMaterial(){return null==this._materials[Rp.Marker]&&null!=this.symbolLayer.marker&&(this._materials[Rp.Marker]=new hp({...this._getMaterialParameters(!1,!0),placement:this.symbolLayer.marker.placement,markerPrimitive:rp(this.symbolLayer.marker.style)}),this._context.stage.add(this._materials[Rp.Marker])),this._materials[Rp.Marker]}destroy(){super.destroy(),this._forEachMaterial((e=>this._context.stage.remove(e))),this._materials.length=0}_getDrivenSize(e){return this._drivenProperties.size&&e.size?(0,Ln.Lz)(function(e){for(let t=0;t<3;t++){const i=e[t];if("number"==typeof i)return isFinite(i)?i:0}return 0}(e.size)):1}_getDrivenColor(e){const t=(0,L.fA)(1,1,1,1);return this._drivenProperties.color&&e.color&&(t[0]=e.color[0],t[1]=e.color[1],t[2]=e.color[2],e.color.length>0&&(t[3]=e.color[3])),this._drivenProperties.opacity&&e.opacity&&(t[3]=e.opacity),t}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,Sp,this.symbolLayer.type))return null;const i=this.setGraphicElevationContext(t);return this.ensureDrapedStatus("on-the-ground"===i.mode),this.draped?this._createAsOverlay(e,this._context.layer.uid):this._createAs3DShape(e,i,t.uid)}applyRendererDiff(e,t){for(const i in e.diff){if("visualVariables"!==i)return gs.RecreateSymbol;{const e=this._fastUpdates;if(!(0,vs.J_)(e,t,wp))return gs.RecreateSymbol;this._forEachMaterial((t=>null===t||void 0===t?void 0:t.setParameters(e.materialParameters)))}}return gs.FastUpdate}prepareSymbolLayerPatch(e){var t,i,r;if("partial"!==e.diff.type)return;const n=e.diff.diff,s={};"complete"===(null===(t=n.size)||void 0===t?void 0:t.type)&&(s.width=this._computeMaterialWidth(n.size.newValue),delete n.size),"complete"===(null===(i=n.cap)||void 0===i?void 0:i.type)&&(s.cap=ip(null!==(r=n.cap.newValue)&&void 0!==r?r:"butt"),delete n.cap);const a=this._prepareMarkerPatch(e,n);this._prepareMaterialPatch(e,n,a),e.symbolLayerStatePatches.push((()=>this._forEachMaterial((e=>null===e||void 0===e?void 0:e.setParameters(s)))))}layerOpacityChanged(){this._forEachMaterial(((e,t)=>this._updateMaterialLayerOpacity(e,t===Rp.Marker)))}_forEachMaterial(e){this._materials.forEach(e)}_updateMaterialLayerOpacity(e){var t;let i=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(null==e)return;const r=e.parameters.color,n=null===(t=this.symbolLayer)||void 0===t||null===(t=t.material)||void 0===t?void 0:t.color,s=this._patternHidesLine&&!i?0:this._getCombinedOpacity(n),a=(0,L.fA)(r[0],r[1],r[2],s);e.setParameters({color:a})}layerElevationInfoChanged(e,t,i){const r=this._elevationContext.mode,n=Lt(Cp.elevationModeChangeTypes,i,r);if(n!==Tt.UPDATE)return n;const s=Ft(r);return this.updateGraphics3DGraphicElevationInfo(e,t,(()=>s))}slicePlaneEnabledChanged(){const e={hasSlicePlane:this._context.slicePlaneEnabled};return this._forEachMaterial((t=>null===t||void 0===t?void 0:t.setParameters(e))),!0}physicalBasedRenderingChanged(){return!0}_getGeometryAsPolygonOrPolyline(e){switch(e.type){case"extent":if(e instanceof xp.A)return wa.A.fromExtent(e);break;case"polygon":case"polyline":return e}return null}_createAs3DShape(e,t,i){const r=e.graphic,n=this._getGeometryAsPolygonOrPolyline(r.geometry),s="polygon"===n.type?n.rings:n.paths,a=new Array,o=(0,q.vt)(),l=function(e,t,i,r){const n="polygon"===e.type?Ga.Wq.CCW_IS_HOLE:Ga.Wq.NONE,s="polygon"===e.type?e.rings:e.paths,{position:a,outlines:o}=(0,Ga.jp)(s,!!e.hasZ,n,e.spatialReference),l=(0,J.jh)(a.length),c=Mt(a,e.spatialReference,0,l,0,a,0,a.length/3,t,i,r),d=null!=c;return{lines:d?op(o,a,l):[],projectionSuccess:d,sampledElevation:c}}(n,this._context.elevationProvider,this._context.renderCoordsHelper,t),c="polygon"===n.type?"rings":"paths";this._logGeometryCreationWarnings(l,s,c,"LineSymbol3DLayer");for(let u=0;u<l.lines.length;u++){const t=l.lines[u],r=t.position,s=t.mapPositions;if(null!=this._context.clippingExtent&&((0,q.Ie)(o),(0,q.Hq)(o,s),!(0,q.KG)(o,this._context.clippingExtent)))continue;const c=this._createGeometry("polygon"===n.type?this._ringMaterial:this._lineMaterial,e,r,s,n.type,Ap.ELEVATED,i);a.push(c),Fn.b.LINE_WIREFRAMES&&a.push(c.instantiate({material:"polygon"===n.type?this._wireframeRingMaterial:this._wireframeLineMaterial})),null!=this._markerMaterial&&a.push(c.instantiate({material:this._markerMaterial}))}if(0===a.length)return null;const d=new Ps({geometries:a,castShadow:!1,layerUid:this._context.layer.uid,graphicUid:i}),h=new ls(this,d,a,null,null,Bn,t);return h.alignedSampledElevation=l.sampledElevation,h.needsElevationUpdates=Ft(t.mode),h}_createGeometry(e,t,i,r,n,s,a){var o,l,c;const d=s===Ap.DRAPED?{spatialReference:this._context.overlaySR,renderCoordsHelper:this._context.renderCoordsHelper}:null,h="polygon"===n,u=null===(o=this._fastUpdates)||void 0===o?void 0:o.visualVariables.color,p=null===(l=this._fastUpdates)||void 0===l?void 0:l.visualVariables.size,f=null===(c=this._fastUpdates)||void 0===c?void 0:c.visualVariables.opacity,g=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:a,layerUid:this._context.layer.uid});return np(e,{overlayInfo:d,removeDuplicateStartEnd:h,mapPositions:r,attributeData:{position:i,size:p?null:this._getDrivenSize(t.renderingInfo),color:u?null:this._getDrivenColor(t.renderingInfo),sizeFeature:p?(0,vs.ul)(p.field,t.graphic):null,colorFeature:u?(0,vs.ul)(u.field,t.graphic):null,opacityFeature:f?(0,vs.ul)(f.field,t.graphic):null}},g)}_createAsOverlay(e,t){const i=e.graphic,r=this._getGeometryAsPolygonOrPolyline(i.geometry),n="polygon"===r.type?r.rings:r.paths,s="polygon"===r.type?this._ringMaterial:this._lineMaterial;s.renderPriority=this._renderPriority;const a=Fn.b.LINE_WIREFRAMES?"polygon"===r.type?this._wireframeRingMaterial:this._wireframeLineMaterial:null,o=this._markerMaterial;null!=a&&(a.renderPriority=this._renderPriority-.001),null!=o&&(o.renderPriority=this._renderPriority-.002);const l=new Array,c=(0,q.vt)(),d=(0,q.Ie)(),h=function(e,t){const i="polygon"===e.type?Ga.Wq.CCW_IS_HOLE:Ga.Wq.NONE,r="polygon"===e.type?e.rings:e.paths,{position:n,outlines:s}=(0,Ga.jp)(r,!1,i),a=(0,k.projectBuffer)(n,e.spatialReference,0,n,t,0,n.length/3);for(let o=2;o<n.length;o+=3)n[o]=-2;return{lines:a?op(s,n):[],projectionSuccess:a}}(r,this._context.overlaySR),u="polygon"===r.type?"rings":"paths";this._logGeometryCreationWarnings(h,n,u,"LineSymbol3DLayer");for(const p of h.lines){if((0,q.Ie)(c),(0,q.Hq)(c,p.position),!(0,q.KG)(c,this._context.clippingExtent))continue;(0,q.RF)(d,c);const n=n=>{const s=this._createGeometry(n,e,p.position,void 0,r.type,Ap.DRAPED,i.uid),a=new du(s,{layerUid:t,graphicUid:i.uid});l.push(a)};if(null!=o){n(o);const e=this.symbolLayer.marker.placement;"begin"!==e&&"begin-end"!==e||(0,q.Hq)(c,p.position,0,1),"end"!==e&&"begin-end"!==e||(0,q.Hq)(c,p.position,p.position.length-3,1)}n(s),Fn.b.LINE_WIREFRAMES&&n(a)}return new zh(this,l,d,this._context.drapeSourceRenderer)}get _patternHidesLine(){const e=this.symbolLayer.pattern;return null!=e&&"style"===e.type&&"none"===e.style}_computeMaterialWidth(e){var t,i;return e=null!==(t=e)&&void 0!==t?t:(0,Ln.PN)(1),this._drivenProperties.size?null!==(i=this._fastUpdates)&&void 0!==i&&i.visualVariables.size?(0,Ln.Lz)(1):1:(0,Ln.Lz)(e)}_prepareMaterialPatch(e,t,i){var r,n;const s=t.material;if(null==s)return void(i.changed&&i.useMaterialColor&&this._patchMaterialColor(this._getCombinedOpacityAndColor(this._materialColor),this._materials[Rp.Marker],e));if("collection"===s.type)return;const a="complete"===s.type?null===(r=s.newValue)||void 0===r?void 0:r.color:"complete"===(null===(n=s.diff.color)||void 0===n?void 0:n.type)?s.diff.color.newValue:null,o=this._getCombinedOpacityAndColor(a);i.useMaterialColor&&this._patchMaterialColor((0,L.o8)(o),this._materials[Rp.Marker],e),this._patternHidesLine&&(o[3]=0),this._patchMaterialColor(o,this._materials[Rp.Line],e),delete t.material}_prepareMarkerPatch(e,t){var i;const r=t.marker,n=this._markerMaterial;if(null==r||"partial"!==r.type||null==r.diff||null!=r.diff.placement||null!=r.diff.style&&"complete"!==r.diff.style.type||null!=r.diff.color&&"complete"!==r.diff.color.type||null==n)return{changed:!1,useMaterialColor:null==this._markerColor};const s=r.diff.color,a=null!=s,o=a?s.newValue:null,l=null==o&&null==this._markerColor;o&&this._patchMaterialColor(this._getCombinedOpacityAndColor(o),n,e);const c=null===(i=r.diff.style)||void 0===i?void 0:i.newValue;return c&&e.symbolLayerStatePatches.push((()=>n.setParameters({markerPrimitive:rp(c)}))),delete t.marker,{changed:a,useMaterialColor:l}}_patchMaterialColor(e,t,i){null!=t&&i.symbolLayerStatePatches.push((()=>t.setParameters({color:e})))}}var Ap,Rp;function Ep(e,t,i){return!!(0,Z.F)(e,t,Op,i.spatialReference)&&(i.x=Op[0],i.y=Op[1],i.z=Op[2],!0)}Cp.elevationModeChangeTypes={definedChanged:Tt.RECREATE,staysOnTheGround:Tt.NONE,onTheGroundChanged:Tt.RECREATE},function(e){e[e.DRAPED=0]="DRAPED",e[e.ELEVATED=1]="ELEVATED"}(Ap||(Ap={})),function(e){e[e.Line=0]="Line",e[e.Ring=1]="Ring",e[e.LineWireframe=2]="LineWireframe",e[e.RingWireframe=3]="RingWireframe",e[e.Marker=4]="Marker"}(Rp||(Rp={}));const Op=(0,I.vt)();var Tp,Pp=i(79629),Mp=i(44032),Ip=i(63713),Dp=i(48620),Lp=i(26375);!function(e){e[e.EnableFastUpdates=0]="EnableFastUpdates",e[e.DisableFastUpdates=1]="DisableFastUpdates",e[e.UpdateFastLocalOrigin=2]="UpdateFastLocalOrigin"}(Tp||(Tp={}));var Fp=i(54439);class Np extends ls{constructor(){super(...arguments),this._originalGeometries=[],this._fastTransformUpdatesEnabled=!1}get fastTransformUpdatesEnabled(){return this._fastTransformUpdatesEnabled}enableFastTransformUpdates(e,t){if(this._fastTransformUpdatesEnabled)return;this._fastTransformUpdatesEnabled=!0;const{stageObject:i}=this,r=i.geometries.slice();i.removeAllGeometries();const n=(0,T.sC)(Vp,i.transformation),s=t.getOrigin(n);for(const a of r){const t=e(a.material),r=a.instantiate({material:t});r.localOrigin=s,i.addGeometry(r)}this._originalGeometries=r}disableFastTransformUpdates(e){if(!this._fastTransformUpdatesEnabled)return;this._fastTransformUpdatesEnabled=!1;const{stageObject:t}=this,i=t.geometries.map((t=>e(t.material)));t.removeAllGeometries();for(let r=0;r<this._originalGeometries.length;r++){const e=this._originalGeometries[r],n=i[r];n.setParameters({modelTransformation:null}),n===e.material?t.addGeometry(e):t.addGeometry(e.instantiate({material:n}))}this._originalGeometries.length=0}updateFastLocalOrigin(e,t,i){var r;if(!this._fastTransformUpdatesEnabled)return;const{stageObject:n}=this;if(0===n.geometries.length)return;const s=n.geometries[0].localOrigin,a=(0,T.sC)(Vp,e),o=i.getOrigin(a);if(o===s)return;const l=null!==(r=null===t||void 0===t?void 0:t.localMatrix)&&void 0!==r?r:P.zK;n.shaderTransformation=null,n.transformation=e,n.geometries.forEach((e=>{e.transformation=l,e.localOrigin=o}))}updateTransform(e,t,i){var r;const{stageObject:n}=this,s=null!==(r=null===t||void 0===t?void 0:t.localMatrix)&&void 0!==r?r:P.zK;if(!this._fastTransformUpdatesEnabled)return n.shaderTransformation=null,n.transformation=e,n.geometries.forEach((e=>{e.transformation=s})),void(this._fastUpdateEdgeTransform()||this.resetEdgeObject(i));const a=n.transformation,o=n.geometries[0].transformation,l=e,c=s,d=(0,T.lw)(Gp,a,o),h=(0,T.lw)(Up,l,c),u=(0,T.lw)(Bp,h,(0,T.B8)(Bp,o));n.shaderTransformation=u,this._setFastMaterialTransformation({matA:d,matB:h}),this._fastUpdateEdgeTransform()||this.resetEdgeObject(i)}alignWithElevation(e,t,i,r){if(!this._fastTransformUpdatesEnabled)return void super.alignWithElevation(e,t,i,r);null!=i&&ii(this.elevationContext.featureExpressionInfoContext,i);const{stageObject:n}=this;if(!n.geometries[0].material.parameters.modelTransformation)return;const s=n.transformation,a=n.geometries[0].transformation,o=(0,T.lw)(Gp,s,a),l=n.effectiveTransformation,c=(0,T.C)(zp,l);this.alignedSampledElevation=Gn(this,this.elevationContext,e.spatialReference,((i,r)=>It(i,e,this.elevationContext,t,r)),t,c),n.shaderTransformation=c;const d=n.geometries[0].transformation,h=(0,T.lw)(Up,c,d);this._setFastMaterialTransformation({matA:o,matB:h}),this._fastUpdateEdgeTransform()||this.resetEdgeObject(r)}_setFastMaterialTransformation(e){let{matA:t,matB:i}=e;const{stageObject:r}=this;if(0===r.geometries.length)return;const n=r.geometries[0].localOrigin,s=(0,T.kN)(Wp,(0,M.h)(Vp,n.vec3,-1)),a=(0,T.lw)(Hp,s,t),o=(0,T.lw)(jp,s,i),l=(0,T.B8)(Hp,a),c=(0,T.lw)(jp,o,l);for(const d of r.geometries)d.material.setParameters({modelTransformation:c})}_fastUpdateEdgeTransform(){return this._stageLayer.stage.renderer.ensureEdgeView().fastUpdateObject3DEdgesTransform(this.stageObject)}}const Vp=(0,I.vt)(),Gp=(0,P.vt)(),Up=(0,P.vt)(),zp=(0,P.vt)(),Bp=(0,P.vt)(),Hp=(0,P.vt)(),jp=(0,P.vt)(),Wp=(0,P.vt)();class kp{constructor(){this._fastTransformOriginalMaterials=new Map,this._fastTransformClonedMaterials=new Map,this._graphicReferenceCount=0}enable(e,t,i){e.enableFastTransformUpdates((e=>{if(this._graphicReferenceCount<=1){if(this._fastTransformOriginalMaterials.has(e))return e;const i=t.byMaterial(e);return this._fastTransformOriginalMaterials.set(e,i),t.delete(e),e}const r=new hn.$U(e.parameters);return i.stage.add(r),this._fastTransformClonedMaterials.set(r,e),r}),i.localOriginFactory)}disable(e,t,i){const r=new Set,n=new Set;e.disableFastTransformUpdates((e=>{if(!this._fastTransformClonedMaterials.has(e)){const i=e,s=this._fastTransformOriginalMaterials.get(i);return t.has(s.uid)?(r.add(i),t.byUid(s.uid).material):(n.add(i),s.material)}const s=e,a=this._fastTransformClonedMaterials.get(s);return this._fastTransformClonedMaterials.delete(s),i.stage.remove(s),a}));for(const s of r)this._fastTransformOriginalMaterials.delete(s),i.stage.remove(s);for(const s of n){const e=this._fastTransformOriginalMaterials.get(s);this._fastTransformOriginalMaterials.delete(s),t.set(e.uid,e)}}onAddGraphic(){this._graphicReferenceCount++}onRemoveGraphic(e,t,i){this._graphicReferenceCount--,this.disable(e,t,i)}forEachMaterialInfo(e){this._fastTransformOriginalMaterials.forEach(e)}forEachClonedMaterial(e){this._fastTransformClonedMaterials.forEach(e)}destroy(e){e.removeMany(Array.from(this._fastTransformClonedMaterials.keys())),e.removeMany(Array.from(this._fastTransformOriginalMaterials.values(),(e=>{let{material:t}=e;return t}))),this._fastTransformClonedMaterials.clear(),this._fastTransformOriginalMaterials.clear()}}class Zp{constructor(){this._byUid=new Map,this._byMaterial=new Map}get materials(){return Array.from(this._byUid.values(),(e=>e.material))}byUid(e){return this._byUid.get(e)}byMaterial(e){return this._byMaterial.get(e)}set(e,t){this._byUid.set(e,t),this._byMaterial.set(t.material,t)}delete(e){var t;const i=null===(t=this._byMaterial.get(e))||void 0===t?void 0:t.uid;i&&(this._byUid.delete(i),this._byMaterial.delete(e))}has(e){return this._byUid.has(e)}forEachMaterialInfo(e){this._byUid.forEach(e)}clear(){this._byUid.clear(),this._byMaterial.clear()}}var qp=i(51990),Qp=i(82809);const Jp=(0,Ws.BP)().vec3f(Pt.r.POSITION),Yp=(0,Ws.BP)().vec3f(Pt.r.POSITION).vec2f(Pt.r.UV0),Xp=(0,Ws.BP)().vec3f(Pt.r.POSITION).vec4u8(Pt.r.COLOR),$p=((0,Ws.BP)().vec3f(Pt.r.POSITION).vec4u8(Pt.r.OBJECTANDLAYERIDCOLOR),(0,Ws.BP)().vec3f(Pt.r.POSITION).vec2f(Pt.r.UV0).vec4u8(Pt.r.OBJECTANDLAYERIDCOLOR));(0,Ws.BP)().vec3f(Pt.r.POSITION).vec4u8(Pt.r.COLOR).vec4u8(Pt.r.OBJECTANDLAYERIDCOLOR);var Kp=i(34026);class ef extends Xs.w{initializeProgram(e){return new Ks.B(e.rctx,ef.shader.get().build(this.configuration),$s.D)}initializePipeline(){const e=this.configuration,t=(0,ta.p3)(ft.dn.SRC_ALPHA,ft.dn.ONE,ft.dn.ONE_MINUS_SRC_ALPHA,ft.dn.ONE_MINUS_SRC_ALPHA),i=function(t){let i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return(0,ta.Ey)({blending:i,depthTest:Do.m,depthWrite:r,colorWrite:ta.wE,stencilWrite:e.hasOccludees?Do.v0:null,stencilTest:e.hasOccludees?t?Do.a9:Do.qh:null})};return e.output===ks.V.Color?(this._occludeePipelineState=i(!0,e.transparent?t:null,ta.kn),i(!1,e.transparent?t:null,ta.kn)):i(!1)}get primitiveType(){return ft.WR.LINES}getPipeline(e){return e?this._occludeePipelineState:super.getPipeline()}}ef.shader=new Ys.$(Kp.N,(()=>i.e(6272).then(i.bind(i,36272))));class tf extends na.E{constructor(){super(...arguments),this.output=ks.V.Color,this.hasSlicePlane=!1,this.hasVertexColors=!1,this.transparent=!1,this.hasOccludees=!1}}(0,r._)([(0,ra.W)({count:ks.V.COUNT})],tf.prototype,"output",void 0),(0,r._)([(0,ra.W)()],tf.prototype,"hasSlicePlane",void 0),(0,r._)([(0,ra.W)()],tf.prototype,"hasVertexColors",void 0),(0,r._)([(0,ra.W)()],tf.prototype,"transparent",void 0),(0,r._)([(0,ra.W)()],tf.prototype,"hasOccludees",void 0);class rf extends qs.im{constructor(e){super(e,new sf),this._configuration=new tf,this.produces=new Map([[Qs.N.OPAQUE_MATERIAL,e=>e===ks.V.Color||e===ks.V.Highlight||e===ks.V.ObjectAndLayerIdColor]])}getConfiguration(e){return this._configuration.output=e,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasVertexColors=this.parameters.hasVertexColors,this._configuration.transparent=this.parameters.color[3]<1||this.parameters.width<1,this._configuration.hasOccludees=this.parameters.hasOccludees,this._configuration}intersect(e,t,i,r,n,s){if(!i.options.selectionMode||!e.visible)return;if(!(0,br.zH)(t))return void a.A.getLogger("esri.views.3d.webgl-engine.materials.NativeLineMaterial").error("intersection assumes a translation-only matrix");const o=e.attributes.get(Pt.r.POSITION).data,l=i.camera,c=mf;(0,Sa.C)(c,i.point);(0,M.s)(_f[0],c[0]-2,c[1]+2,0),(0,M.s)(_f[1],c[0]+2,c[1]+2,0),(0,M.s)(_f[2],c[0]+2,c[1]-2,0),(0,M.s)(_f[3],c[0]-2,c[1]-2,0);for(let a=0;a<4;a++)if(!l.unprojectFromRenderScreen(_f[a],vf[a]))return;(0,gr.Cr)(l.eye,vf[0],vf[1],yf),(0,gr.Cr)(l.eye,vf[1],vf[2],bf),(0,gr.Cr)(l.eye,vf[2],vf[3],xf),(0,gr.Cr)(l.eye,vf[3],vf[0],Sf);let d=Number.MAX_VALUE,h=0;for(let a=0;a<o.length-5;a+=3){if(af[0]=o[a]+t[12],af[1]=o[a+1]+t[13],af[2]=o[a+2]+t[14],of[0]=o[a+3]+t[12],of[1]=o[a+4]+t[13],of[2]=o[a+5]+t[14],(0,gr.mN)(yf,af)<0&&(0,gr.mN)(yf,of)<0||(0,gr.mN)(bf,af)<0&&(0,gr.mN)(bf,of)<0||(0,gr.mN)(xf,af)<0&&(0,gr.mN)(xf,of)<0||(0,gr.mN)(Sf,af)<0&&(0,gr.mN)(Sf,of)<0)continue;if(l.projectToRenderScreen(af,df),l.projectToRenderScreen(of,hf),df[2]<0&&hf[2]>0){(0,M.f)(lf,af,of);const e=l.frustum,t=-(0,gr.mN)(e[wt.FB.NEAR],af)/(0,M.j)(lf,(0,gr.Qj)(e[wt.FB.NEAR]));(0,M.h)(lf,lf,t),(0,M.g)(af,af,lf),l.projectToRenderScreen(af,df)}else if(df[2]>0&&hf[2]<0){(0,M.f)(lf,of,af);const e=l.frustum,t=-(0,gr.mN)(e[wt.FB.NEAR],of)/(0,M.j)(lf,(0,gr.Qj)(e[wt.FB.NEAR]));(0,M.h)(lf,lf,t),(0,M.g)(of,of,lf),l.projectToRenderScreen(of,hf)}else if(df[2]<0&&hf[2]<0)continue;df[2]=0,hf[2]=0;const e=(0,Oo.kb)((0,Oo.Cr)(df,hf,ff),c);e<d&&(d=e,(0,M.c)(uf,af),(0,M.c)(pf,of),h=a/3)}const u=i.rayBegin,p=i.rayEnd;if(d<4){let e=Number.MAX_VALUE;if((0,Oo.ld)((0,Oo.Cr)(uf,pf,ff),(0,Oo.Cr)(u,p,gf),cf)){(0,M.f)(cf,cf,u);const t=(0,M.l)(cf);(0,M.h)(cf,cf,1/t),e=t/(0,M.p)(u,p)}s(e,cf,h,!1)}}intersectDraped(e,t,i,r,n,s){if(!i.options.selectionMode)return;const a=e.attributes.get(Pt.r.POSITION).data,o=e.attributes.get(Pt.r.SIZE),l=o?o.data[0]:0,c=r[0],d=r[1],h=((l+1)/2+4)*e.screenToWorldRatio;let u=Number.MAX_VALUE,p=0;for(let f=0;f<a.length-5;f+=3){const e=a[f],t=a[f+1],i=c-e,r=d-t,n=a[f+3]-e,s=a[f+4]-t,o=(0,U.qE)((n*i+s*r)/(n*n+s*s),0,1),l=n*o-i,h=s*o-r,g=l*l+h*h;g<u&&(u=g,p=f/3)}u<h*h&&n(s.dist,s.normal,p,!1)}createGLMaterial(e){return new nf(e)}createBufferWriter(){const e=this.parameters.hasVertexColors?Xp:Jp;return new Qp.Z(e)}}class nf extends Zs.A{_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})}beginSlot(e){return this._output===ks.V.Color&&this._updateOccludeeState(e),this.ensureTechnique(ef,e)}}class sf extends qs.qA{constructor(){super(...arguments),this.color=L.Un,this.hasVertexColors=!1,this.hasSlicePlane=!1,this.width=1,this.hasOccludees=!1}}const af=(0,I.vt)(),of=(0,I.vt)(),lf=(0,I.vt)(),cf=(0,I.vt)(),df=(0,Ln.r_)(),hf=(0,Ln.r_)(),uf=(0,I.vt)(),pf=(0,I.vt)(),ff=(0,Oo.vt)(),gf=(0,Oo.vt)(),mf=(0,I.vt)(),_f=[(0,Ln.r_)(),(0,Ln.r_)(),(0,Ln.r_)(),(0,Ln.r_)()],vf=[(0,I.vt)(),(0,I.vt)(),(0,I.vt)(),(0,I.vt)()],yf=(0,gr.vt)(),bf=(0,gr.vt)(),xf=(0,gr.vt)(),Sf=(0,gr.vt)(),wf=["mesh"];class Cf{constructor(e,t,i){this.normals=e,this.indices=t,this.didFlipNormals=i}}const Af=(0,I.vt)(),Rf=(0,I.vt)(),Ef=(0,I.vt)(),Of=(0,I.vt)(),Tf=(0,I.vt)(),Pf=(0,P.vt)(),Mf=(0,O.vt)(),If=(0,P.vt)(),Df=(0,q.vt)(),Lf=[new Pp.A],Ff=new Ip.A;var Nf;!function(e){e[e.NONE=0]="NONE",e[e.RENDER=1]="RENDER"}(Nf||(Nf={}));var Vf=i(72733);class Gf{constructor(e,t,i,r){this.graphics3DSymbolLayer=e,this.instanceIndex=t,this.elevationAligner=i,this.elevationContext=r,this.type="lod-instance",this._highlights=new Set,this.alignedSampledElevation=0,this.isElevationSource=!1,this.needsElevationUpdates=!1}initialize(){}setVisibility(e){const t=this._lodRenderer.instanceData;e!==t.getVisible(this.instanceIndex)&&t.setVisible(this.instanceIndex,e)}destroy(){null!=this.instanceIndex&&(this._lodRenderer.instanceData.removeInstance(this.instanceIndex),this.graphics3DSymbolLayer.notifyDestroyGraphicLayer(this))}alignWithElevation(e,t,i){if(this.elevationAligner){ii(this.elevationContext.featureExpressionInfoContext,i);const r=(i,r)=>It(i,e,this.elevationContext,t,r),n=this.elevationAligner(this,this.elevationContext,e.spatialReference,r,t);null!=n&&(this.alignedSampledElevation=n)}}getCenterObjectSpace(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,I.vt)();return this._lodRenderer.instanceData.getCombinedLocalTransform(this.instanceIndex,jf),(0,M.e)(e,this._lodRenderer.baseBoundingSphere.center,jf)}getBoundingBoxObjectSpace(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,q.vt)();this._lodRenderer.instanceData.getCombinedLocalTransform(this.instanceIndex,jf);const t=this._lodRenderer.baseBoundingBox;(0,q.Ie)(e);for(let i=0;i<8;++i)(0,M.s)(zf,0==(1&i)?t[0]:t[3],0==(2&i)?t[1]:t[4],0==(4&i)?t[2]:t[5]),(0,M.e)(zf,zf,jf),(0,q.iT)(e,zf);return e}computeAttachmentOrigin(e){this._lodRenderer.instanceData.getGlobalTransform(this.instanceIndex,jf),e.render.origin[0]+=jf[12],e.render.origin[1]+=jf[13],e.render.origin[2]+=jf[14],e.render.num++}async getProjectedBoundingBox(e,t,i,r,n){const s=this.getBoundingBoxObjectSpace(n),a=Hf,o=(0,q.fT)(s)?1:a.length;this._lodRenderer.instanceData.getGlobalTransform(this.instanceIndex,jf);for(let d=0;d<o;d++){const e=a[d];zf[0]=s[e[0]],zf[1]=s[e[1]],zf[2]=s[e[2]],(0,M.e)(zf,zf,jf),Uf[3*d]=zf[0],Uf[3*d+1]=zf[1],Uf[3*d+2]=zf[2]}if(!e(Uf,0,o))return null;(0,q.Ie)(s);let l=null;this.calculateRelativeScreenBounds&&(l=this.calculateRelativeScreenBounds());for(let d=0;d<3*o;d+=3){for(let e=0;e<3;e++)s[e]=Math.min(s[e],Uf[d+e]),s[e+3]=Math.max(s[e+3],Uf[d+e]);l&&i.push({location:Uf.slice(d,d+3),screenSpaceBoundingRect:l})}if(t&&((0,q.gX)(s,Bf),"absolute-height"!==this.elevationContext.mode)){let e;const i=ss(s,t.service.spatialReference,t);try{e=await t.service.queryElevation(Bf[0],Bf[1],r,i,"ground")}catch(c){}null!=e&&(0,q.cY)(s,0,0,-this.alignedSampledElevation+e)}return s}addObjectState(e,t){if(e===fe.Mg.Highlight){const i=new Os.X(e);this._addHighlightId(i),t.addExternal((e=>{this._removeHighlightId(e)}),i)}}removeObjectState(e){this._highlights.forEach((t=>e.remove(t)))}_addHighlightId(e){this._highlights.add(e),this._lodRenderer.instanceData.setHighlight(this.instanceIndex,!0)}_removeHighlightId(e){this._highlights.delete(e),this._lodRenderer.instanceData.setHighlight(this.instanceIndex,this._highlights.size>0)}get _lodRenderer(){return this.graphics3DSymbolLayer.lodRenderer}}const Uf=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],zf=(0,I.vt)(),Bf=(0,I.vt)(),Hf=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]],jf=(0,P.vt)();function Wf(e,t){const i=e.stageResources.geometries.map((t=>new Yr(t,e.stageResources.textures))),r=null==e.lodThreshold||0===e.lodThreshold&&t>0?function(e){const t=e.reduce(((e,t)=>{let{geometry:i}=t;return e+i.indexCount/3}),0);return Math.sqrt(t*kf/Math.PI)}(i):e.lodThreshold;return new Xr(i,r,e.pivotOffset)}const kf=20;var Zf=i(39513),qf=i(8446),Qf=i(26314);class Jf{constructor(e,t,i){this._elementSize=t,this._buffer=xd.g.createVertex(e,ft._U.STATIC_DRAW),this.resize(i)}destroy(){this._buffer.dispose()}get elementSize(){return this._elementSize}get capacity(){return this._capacity}get array(){return this._array}get buffer(){return this._buffer}get usedMemory(){return this._array.byteLength+this._buffer.usedMemory}copyRange(e,t,i){let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;const n=new Uint8Array(this.array,e*this.elementSize,(t-e)*this.elementSize);new Uint8Array(i.array,r*this.elementSize).set(n)}transferAll(){this._buffer.setData(this._array)}transferRange(e,t){const i=e*this._elementSize,r=t*this._elementSize;this._buffer.setSubData(new Uint8Array(this._array),i,i,r)}resize(e){const t=e*this._elementSize,i=new ArrayBuffer(t);this._array&&(e>=this._capacity?new Uint8Array(i).set(new Uint8Array(this._array)):new Uint8Array(i).set(new Uint8Array(this._array).subarray(0,e*this._elementSize))),this._array=i,this._buffer.setSize(t),this._capacity=e}}class Yf{constructor(e){this.modelOriginHi=e.getField(Pt.r.INSTANCEMODELORIGINHI,uu.xs),this.modelOriginLo=e.getField(Pt.r.INSTANCEMODELORIGINLO,uu.xs),this.model=e.getField(Pt.r.INSTANCEMODEL,uu.jZ),this.modelNormal=e.getField(Pt.r.INSTANCEMODELNORMAL,uu.jZ),this.featureAttribute=e.getField(Pt.r.INSTANCEFEATUREATTRIBUTE,uu.Eq),this.color=e.getField(Pt.r.INSTANCECOLOR,uu.XP),this.objectAndLayerIdColor=e.getField(Pt.r.INSTANCEOBJECTANDLAYERIDCOLOR,uu.XP)}}class Xf{constructor(e,t){this._rctx=e,this._instanceBufferLayout=t,this._headIndex=0,this._tailIndex=0,this._firstIndex=null,this._captureFirstIndex=!0,this._updating=!1,this._prevHeadIndex=0,this._resized=!1,this._capacity=1}destroy(){this._buffer&&this._buffer.destroy()}get buffer(){return this._buffer.buffer}get view(){return this._view}get capacity(){return this._capacity}get size(){const e=this._headIndex,t=this._tailIndex;return e>=t?e-t:e+this._capacity-t}get isEmpty(){return this._headIndex===this._tailIndex}get isFull(){return this._tailIndex===(this._headIndex+1)%this._capacity}get headIndex(){return this._headIndex}get tailIndex(){return this._tailIndex}get firstIndex(){return this._firstIndex}get usedMemory(){var e,t;return null!==(e=null===(t=this._buffer)||void 0===t?void 0:t.usedMemory)&&void 0!==e?e:0}reset(){this._headIndex=0,this._tailIndex=0,this._firstIndex=null}startUpdateCycle(){this._captureFirstIndex=!0}beginUpdate(){(0,br.vA)(!this._updating,"already updating"),this._updating=!0,this._prevHeadIndex=this._headIndex}endUpdate(){(0,br.vA)(this._updating,"not updating"),this.size<b.$U*this.capacity&&this._shrink(),this._resized?(this._buffer.transferAll(),this._resized=!1):this._transferRange(this._prevHeadIndex,this._headIndex),this._updating=!1}allocateHead(){(0,br.vA)(this._updating,"not updating"),this.isFull&&this._grow();const e=this.headIndex;return this._captureFirstIndex&&(this._firstIndex=e,this._captureFirstIndex=!1),this._incrementHead(),(0,br.vA)(this._headIndex!==this._tailIndex,"invalid pointers"),e}freeTail(){(0,br.vA)(this._updating,"not updating"),(0,br.vA)(this.size>0,"invalid size");const e=this._tailIndex===this._firstIndex;this._incrementTail(),e&&(this._firstIndex=this._tailIndex)}_grow(){const e=Math.max($f,Math.floor(this._capacity*b.Ji));this._resize(e)}_shrink(){const e=Math.max($f,Math.floor(this._capacity*b.He));this._resize(e)}_resize(e){if((0,br.vA)(this._updating,"not updating"),e===this._capacity)return;const t=new Jf(this._rctx,this._instanceBufferLayout.stride,e);if(this._buffer){this._firstIndex&&(this._firstIndex=(this._firstIndex+this._capacity-this._tailIndex)%this._capacity);const e=this.size,i=this._compactInstances(t);(0,br.vA)(i===e,"invalid compaction"),this._buffer.destroy(),this._tailIndex=0,this._headIndex=i,this._prevHeadIndex=0}this._resized=!0,this._capacity=e,this._buffer=t,this._view=new Yf(this._instanceBufferLayout.createView(this._buffer.array))}_compactInstances(e){const t=this._headIndex,i=this._tailIndex;return i<t?(this._buffer.copyRange(i,t,e),t-i):i>t?(this._buffer.copyRange(i,this._capacity,e),t>0&&this._buffer.copyRange(0,t,e,this._capacity-i),t+(this._capacity-i)):0}_incrementHead(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;this._headIndex=(this._headIndex+e)%this._capacity}_incrementTail(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;this._tailIndex=(this._tailIndex+e)%this._capacity}_transferRange(e,t){e<t?this._buffer.transferRange(e,t):e>t&&(t>0&&this._buffer.transferRange(0,t),this._buffer.transferRange(e,this._capacity))}}const $f=64;var Kf;!function(e){e[e.ALLOCATED=1]="ALLOCATED",e[e.DEFAULT_ACTIVE=2]="DEFAULT_ACTIVE",e[e.VISIBLE=4]="VISIBLE",e[e.HIGHLIGHT=8]="HIGHLIGHT",e[e.HIGHLIGHT_ACTIVE=16]="HIGHLIGHT_ACTIVE",e[e.REMOVE=32]="REMOVE",e[e.TRANSFORM_CHANGED=64]="TRANSFORM_CHANGED",e[e.ACTIVE=18]="ACTIVE"}(Kf||(Kf={}));class eg{constructor(e){this.localTransform=e.getField(Pt.r.LOCALTRANSFORM,uu.E$),this.globalTransform=e.getField(Pt.r.GLOBALTRANSFORM,uu.E$),this.modelOrigin=e.getField(Pt.r.MODELORIGIN,uu.Xm),this.model=e.getField(Pt.r.INSTANCEMODEL,uu.jZ),this.modelNormal=e.getField(Pt.r.INSTANCEMODELNORMAL,uu.jZ),this.modelScaleFactors=e.getField(Pt.r.MODELSCALEFACTORS,uu.gH),this.boundingSphere=e.getField(Pt.r.BOUNDINGSPHERE,uu.Aj),this.featureAttribute=e.getField(Pt.r.FEATUREATTRIBUTE,uu.Eq),this.color=e.getField(Pt.r.COLOR,uu.XP),this.objectAndLayerIdColor=e.getField(Pt.r.OBJECTANDLAYERIDCOLOR,uu.XP),this.state=e.getField(Pt.r.STATE,uu.SL),this.lodLevel=e.getField(Pt.r.LODLEVEL,uu.SL)}}let tg=class extends s.A{constructor(e,t){super(e),this.events=new Cn.A,this._capacity=0,this._size=0,this._next=0,this._layout=function(e){let t=(0,Ws.BP)().mat4f64(Pt.r.LOCALTRANSFORM).mat4f64(Pt.r.GLOBALTRANSFORM).vec4f64(Pt.r.BOUNDINGSPHERE).vec3f64(Pt.r.MODELORIGIN).mat3f(Pt.r.INSTANCEMODEL).mat3f(Pt.r.INSTANCEMODELNORMAL).vec2f(Pt.r.MODELSCALEFACTORS);return e.includes(Pt.r.FEATUREATTRIBUTE)&&(t=t.vec4f(Pt.r.FEATUREATTRIBUTE)),e.includes(Pt.r.COLOR)&&(t=t.vec4u8(Pt.r.COLOR)),e.includes(Pt.r.OBJECTANDLAYERIDCOLOR)&&(t=t.vec4u8(Pt.r.OBJECTANDLAYERIDCOLOR)),t=t.u8(Pt.r.STATE).u8(Pt.r.LODLEVEL),t}(t),this._capacity=$f,this._buffer=this._layout.createBuffer(this._capacity),this._view=new eg(this._buffer)}get capacity(){return this._capacity}get size(){return this._size}get view(){return this._view}addInstance(){this._size+1>this._capacity&&this._grow();const e=this._findSlot();return this._view.state.set(e,Kf.ALLOCATED),this._size++,this.events.emit("instances-changed"),e}removeInstance(e){const t=this._view.state;(0,br.vA)(e>=0&&e<this._capacity&&0!=(t.get(e)&Kf.ALLOCATED),"invalid instance handle"),this._getStateFlag(e,Kf.ACTIVE)?this._setStateFlags(e,Kf.REMOVE):this.freeInstance(e),this.events.emit("instances-changed")}freeInstance(e){const t=this._view.state;(0,br.vA)(e>=0&&e<this._capacity&&0!=(t.get(e)&Kf.ALLOCATED),"invalid instance handle"),t.set(e,0),this._size--}setLocalTransform(e,t){let i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];this._view.localTransform.setMat(e,t),i&&this.updateModelTransform(e)}getLocalTransform(e,t){this._view.localTransform.getMat(e,t)}setGlobalTransform(e,t){let i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];this._view.globalTransform.setMat(e,t),i&&this.updateModelTransform(e)}getGlobalTransform(e,t){this._view.globalTransform.getMat(e,t)}updateModelTransform(e){const t=this._view,i=ig,r=rg;t.localTransform.getMat(e,ng),t.globalTransform.getMat(e,sg);const n=(0,T.lw)(sg,sg,ng);(0,M.s)(i,n[12],n[13],n[14]),t.modelOrigin.setVec(e,i),(0,E.z0)(r,n),t.model.setMat(e,r);const s=(0,Rs.wp)(ig,n);s.sort(),t.modelScaleFactors.set(e,0,s[1]),t.modelScaleFactors.set(e,1,s[2]),(0,E.B8)(r,r),(0,E.mg)(r,r),t.modelNormal.setMat(e,r),this._setStateFlags(e,Kf.TRANSFORM_CHANGED),this.events.emit("instance-transform-changed",{index:e})}getModelTransform(e,t){const i=this._view;i.model.getMat(e,rg),i.modelOrigin.getVec(e,ig),t[0]=rg[0],t[1]=rg[1],t[2]=rg[2],t[3]=0,t[4]=rg[3],t[5]=rg[4],t[6]=rg[5],t[7]=0,t[8]=rg[6],t[9]=rg[7],t[10]=rg[8],t[11]=0,t[12]=ig[0],t[13]=ig[1],t[14]=ig[2],t[15]=1}applyShaderTransformation(e,t){null!=this.shaderTransformation&&this.shaderTransformation.applyTransform(this,e,t)}getCombinedModelTransform(e,t){return this.getModelTransform(e,t),null!=this.shaderTransformation&&this.shaderTransformation.applyTransform(this,e,t),t}getCombinedLocalTransform(e,t){this._view.localTransform.getMat(e,t),null!=this.shaderTransformation&&this.shaderTransformation.applyTransform(this,e,t)}getCombinedMaxScaleFactor(e){let t=this._view.modelScaleFactors.get(e,1);return null!=this.shaderTransformation&&(this.shaderTransformation.scaleFactor(ig,this,e),t*=Math.max(ig[0],ig[1],ig[2])),t}getCombinedMedianScaleFactor(e){let t=this._view.modelScaleFactors.get(e,0);return null!=this.shaderTransformation&&(this.shaderTransformation.scaleFactor(ig,this,e),t*=function(e,t,i){return Math.max(Math.min(e,t),Math.min(Math.max(e,t),i))}(ig[0],ig[1],ig[2])),t}getModel(e,t){this._view.model.getMat(e,t)}setFeatureAttribute(e,t){this._view.featureAttribute.setVec(e,t)}getFeatureAttribute(e,t){this._view.featureAttribute.getVec(e,t)}setColor(e,t){this._view.color.setVec(e,t)}setObjectAndLayerIdColor(e,t){this._view.objectAndLayerIdColor.setVec(e,t)}setVisible(e,t){t!==this.getVisible(e)&&(this._setStateFlag(e,Kf.VISIBLE,t),this.events.emit("instance-visibility-changed",{index:e}))}getVisible(e){return this._getStateFlag(e,Kf.VISIBLE)}setHighlight(e,t){t!==this.getHighlight(e)&&(this._setStateFlag(e,Kf.HIGHLIGHT,t),this.events.emit("instance-highlight-changed"))}getHighlight(e){return this._getStateFlag(e,Kf.HIGHLIGHT)}getState(e){return this._view.state.get(e)}getLodLevel(e){return this._view.lodLevel.get(e)}countFlags(e){let t=0;for(let i=0;i<this._capacity;++i)this.getState(i)&e&&++t;return t}_setStateFlags(e,t){const i=this._view.state;t=i.get(e)|t,i.set(e,t)}_clearStateFlags(e,t){const i=this._view.state;t=i.get(e)&~t,i.set(e,t)}_setStateFlag(e,t,i){i?this._setStateFlags(e,t):this._clearStateFlags(e,t)}_getStateFlag(e,t){return!!(this._view.state.get(e)&t)}_grow(){this._capacity=Math.max($f,Math.floor(this._capacity*b.Ji)),this._buffer=this._layout.createBuffer(this._capacity).copyFrom(this._buffer),this._view=new eg(this._buffer)}_findSlot(){const e=this._view.state;let t=this._next;for(;e.get(t)&Kf.ALLOCATED;)t=t+1===this._capacity?0:t+1;return this._next=t+1===this._capacity?0:t+1,t}};(0,r._)([(0,d.MZ)({constructOnly:!0})],tg.prototype,"shaderTransformation",void 0),(0,r._)([(0,d.MZ)()],tg.prototype,"_size",void 0),(0,r._)([(0,d.MZ)({readOnly:!0})],tg.prototype,"size",null),tg=(0,r._)([(0,u.$)("esri.views.3d.webgl-engine.lib.lodRendering.InstanceData")],tg);const ig=(0,I.vt)(),rg=(0,O.vt)(),ng=(0,P.vt)(),sg=(0,P.vt)();class ag extends Ro.A{constructor(e,t){super((e=>(0,$.w)(this._instanceData.view.boundingSphere.getVec(e,this._tmpSphere))),{maximumDepth:25}),this._instanceData=e,this._boundingSphere=t,this._tmpSphere=(0,$.d)(),this._tmpMat4=(0,P.vt)()}addInstance(e){const t=this._instanceData.view.boundingSphere,i=this._instanceData.getCombinedModelTransform(e,this._tmpMat4);(0,M.e)((0,$.g)(this._tmpSphere),this._boundingSphere.center,i),this._tmpSphere[3]=this._boundingSphere.radius*(0,Rs.hG)(i),t.setVec(e,this._tmpSphere),this.add([e])}removeInstance(e){this.remove([e])}}class og{constructor(e,t){this._worldSpaceRadius=e,this._minScreenSpaceRadii=t}selectLevel(e,t,i){const r=i.computeScreenPixelSizeAt(e),n=this._worldSpaceRadius*t/r;let s=0;for(let a=1;a<this._minScreenSpaceRadii.length;++a)n>=this._minScreenSpaceRadii[a]&&(s=a);return s}}class lg extends cc{constructor(e,t,i,r,n,s){super(e,t),this.layerUid=e,this.graphicUid=t,this.geometryId=i,this.triangleNr=r,this.baseBoundingSphere=n,this.numLodLevels=s}}class cg{constructor(e,t){const i=e.renderContext.rctx,r=t.geometry;this._materialRepository=e.materialRepository,r.material.setParameters({instancedDoublePrecision:!0});const n=r.material.createBufferWriter(),s=n.vertexBufferLayout,a=n.elementCount(r),o=s.createBuffer(a);n.write(null,null,r,o,0),this.geometry=r,this.material=r.material,this.glMaterials=new ld(r.material,this._materialRepository),this.vertexBufferLayout=s,this.vbo=xd.g.createVertex(i,ft._U.STATIC_DRAW,o.buffer),this.vao=new bd(i,$s.D,{geometry:(0,od.U)(s)},{geometry:this.vbo}),this.vertexCount=a}destroy(){this.glMaterials.dispose(),this.vbo.dispose(),this.vao.dispose()}get boundingInfo(){return this.geometry.boundingInfo}get triangleCount(){return this.vertexCount/3}intersect(e,t,i,r,n,s,a,o){const l=this.geometry.id;this.material.intersect(this.geometry,e.transform.transform,e,i,r,((i,r,c,d,h)=>{if(i>=0){if(null!=t&&!t(e.rayBegin,e.rayEnd,i))return;const d=new lg(s.layerUid,s.graphicUid(n),l,c,a,o);if((null==e.results.min.drapedLayerOrder||h>=e.results.min.drapedLayerOrder)&&(null==e.results.min.dist||i<e.results.min.dist)&&e.results.min.set(rc.LOD,d,i,r,e.transform.transform,h),e.options.store!==nc.MIN&&(null==e.results.max.drapedLayerOrder||h>=e.results.max.drapedLayerOrder)&&(null==e.results.max.dist||i>e.results.max.dist)&&e.results.max.set(rc.LOD,d,i,r,e.transform.transform,h),e.options.store===nc.ALL){const t=ed(e.results.min.ray);t.set(rc.LOD,d,i,r,e.transform.transform,h),e.results.all.push(t)}}}))}}class dg{static async create(e,t,i){const r=await Promise.allSettled(t.components.map((t=>e.controller.schedule((()=>new cg(e,t)),i)))),n=r.map((e=>"fulfilled"===e.status?e.value:null)).filter(b.Ru);if((0,o.G4)(i)||n.length!==r.length){n.forEach((e=>e.destroy())),(0,o.Te)(i);for(const e of r)if("rejected"===e.status)throw e.reason}return new dg(t.minScreenSpaceRadius,n)}constructor(e,t){this.minScreenSpaceRadius=e,this.components=t}destroy(){this.components.forEach((e=>e.destroy()))}intersect(e,t,i,r,n,s,a){this.components.forEach((o=>o.intersect(e,t,i,r,n,s,this.boundingSphere,a)))}get boundingBox(){if(null==this._boundingBox){const e=(0,q.Ie)();this.components.forEach((t=>{null!=t.boundingInfo&&((0,q.iT)(e,t.boundingInfo.bbMin),(0,q.iT)(e,t.boundingInfo.bbMax))})),this._boundingBox=e}return this._boundingBox}get boundingSphere(){if(null==this._boundingSphere){const e=this.boundingBox,t=(0,I.vt)();(0,q.gX)(e,t),this._boundingSphere={center:t,radius:.5*(0,q._F)(e)}}return this._boundingSphere}get triangleCount(){return this.components.reduce(((e,t)=>e+t.triangleCount),0)}}var hg=i(59648),ug=i(27207);let pg=class extends co.S{constructor(e,t){super(e),this.type=rc.LOD,this.isGround=!1,this._levels=[],this._defaultRenderInstanceData=[new Array],this._highlightRenderInstanceData=[new Array],this._allRenderInstanceData=[this._defaultRenderInstanceData[0],this._highlightRenderInstanceData[0]],this._instanceIndex=0,this._cycleStartIndex=0,this._slicePlane=!1,this._camera=new uo,this._updateCyclesWithStaticCamera=-1,this._needFullCycle=!1,this.produces=new Map([[Qs.N.OPAQUE_MATERIAL,e=>this._produces(e)],[Qs.N.TRANSPARENT_MATERIAL,e=>!!this._hasTransparentLevels()&&this._produces(e)]]),this._instanceData=new tg({shaderTransformation:e.shaderTransformation},e.optionalFields),this.addHandles(t.registerTask(Ae.W6.LOD_RENDERER,this))}initialize(){this._instanceBufferLayout=function(e){let t=(0,Ws.BP)().vec3f(Pt.r.INSTANCEMODELORIGINHI).vec3f(Pt.r.INSTANCEMODELORIGINLO).mat3f(Pt.r.INSTANCEMODEL).mat3f(Pt.r.INSTANCEMODELNORMAL);return null!=e&&e.includes("featureAttribute")&&(t=t.vec4f(Pt.r.INSTANCEFEATUREATTRIBUTE)),null!=e&&e.includes("color")&&(t=t.vec4u8(Pt.r.INSTANCECOLOR)),null!=e&&e.includes("objectAndLayerIdColor")&&(t=t.vec4u8(Pt.r.INSTANCEOBJECTANDLAYERIDCOLOR)),t}(this.optionalFields),this._glInstanceBufferLayout=(0,od.U)(this._instanceBufferLayout,1),this.addHandles([this._instanceData.events.on("instances-changed",(()=>this._requestUpdateCycle())),this._instanceData.events.on("instance-transform-changed",(e=>{let{index:t}=e;this._requestUpdateCycle(),this.metadata.notifyGraphicGeometryChanged(t)})),this._instanceData.events.on("instance-visibility-changed",(e=>{let{index:t}=e;this._requestUpdateCycle(!0),this.metadata.notifyGraphicVisibilityChanged(t)})),this._instanceData.events.on("instance-highlight-changed",(()=>this._requestUpdateCycle(!0)))])}get _enableLevelSelection(){return this.symbol.levels.length>1}get levels(){return this._levels}get baseBoundingBox(){return this._levels[this._levels.length-1].boundingBox}get baseBoundingSphere(){return this._levels[this._levels.length-1].boundingSphere}get baseMaterial(){return this._levels[this._levels.length-1].components[0].material}get slicePlaneEnabled(){return this._slicePlane}set slicePlaneEnabled(e){this._slicePlane=e}get layerUid(){return this.metadata.layerUid}get instanceData(){return this._instanceData}get usedMemory(){return this._allRenderInstanceData.reduce(((e,t)=>t.reduce(((e,t)=>e+t.usedMemory),e)),0)}get renderStats(){const e=this._instanceData.size,t=[];return this._levels.forEach(((e,i)=>{const r=this._allRenderInstanceData[0][i].size+this._allRenderInstanceData[1][i].size,n=e.triangleCount;t.push({renderedInstances:r,renderedTriangles:r*n,trianglesPerInstance:n})})),{totalInstances:e,renderedInstances:t.reduce(((e,t)=>e+t.renderedInstances),0),renderedTriangles:t.reduce(((e,t)=>e+t.renderedTriangles),0),levels:t}}async initializeRenderContext(e,t){this._context=e;const i=e.renderContext.rctx,r=await Promise.allSettled(this.symbol.levels.map((r=>(this._defaultRenderInstanceData[0].push(new Xf(i,this._instanceBufferLayout)),this._highlightRenderInstanceData[0].push(new Xf(i,this._instanceBufferLayout)),dg.create(e,r,t))))),n=r.map((e=>"fulfilled"===e.status?e.value:null)).filter(b.Ru);if((0,o.G4)(t)||n.length!==r.length){n.forEach((e=>e.destroy())),(0,o.Te)(t);for(const e of r)if("rejected"===e.status)throw e.reason}this._levels=n,this._levelSelector=(e=>{const t=e.baseBoundingSphere.radius,i=e.levels.map((e=>e.minScreenSpaceRadius));return new og(t,i)})(this)}uninitializeRenderContext(){this._invalidateOctree(),this._levels.forEach((e=>e.destroy())),this._defaultRenderInstanceData[0].forEach((e=>e.destroy())),this._highlightRenderInstanceData[0].forEach((e=>e.destroy()))}_hasTransparentLevels(){return this._levels.some((e=>e.components.some((e=>{const t=e.material.produces.get(Qs.N.TRANSPARENT_MATERIAL);return t&&t(ks.V.Color)}))))}hasHighlights(){return this._highlightRenderInstanceData[0].some((e=>e.size>0))}_produces(e){return e!==ks.V.Highlight&&e!==ks.V.ShadowHighlight||this.hasHighlights()}prepareRender(e){if(!Fn.b.LOD_INSTANCE_RENDERER_DISABLE_UPDATES){if(this._enableLevelSelection){const t=e.bindParameters.contentCamera.equals(this._camera);this._camera.copyFrom(e.bindParameters.contentCamera),t||this._requestUpdateCycle()}this._needFullCycle&&(this.runTask(Ae.Bb),this._needFullCycle=!1)}}prepareTechniques(e){if(!this.baseMaterial.isVisible()||!this.baseMaterial.isVisibleForOutput(e.output))return null;const t=this._getInstanceDatas(e.output);if(!t)return null;const i=new Array;return t.forEach((t=>this.levels.forEach(((r,n)=>{r.components.forEach((r=>i.push(this._beginComponent(e,t[n],r))))})))),i}renderNode(e,t){const i=this._getInstanceDatas(e.output);if(!i||null==t)return;let r=0;e.rctx.bindVAO(),i.forEach((i=>this.levels.forEach(((n,s)=>{n.components.forEach((n=>this._renderComponent(e,t[r++],i[s],n,s)))}))))}_getInstanceDatas(e){const t=e!==ks.V.Highlight&&e!==ks.V.ShadowHighlight,i=e!==ks.V.ShadowExcludeHighlight;return t&&i?this._allRenderInstanceData:t?this._defaultRenderInstanceData:i?this._highlightRenderInstanceData:null}intersect(e,t,i,r){if(!this.baseMaterial.isVisible()||null==this._octree)return;const n=(0,I.vt)();(0,M.f)(n,r,i);const s=n=>{this._instanceData.getCombinedModelTransform(n,_g),e.transform.set(_g),(0,M.e)(vg,i,e.transform.inverse),(0,M.e)(yg,r,e.transform.inverse);const s=this._instanceData.getState(n),a=this._instanceData.getLodLevel(n),o=this._levels.length;(0,br.vA)(0!=(s&Kf.ACTIVE),"invalid instance state"),(0,br.vA)(a>=0&&a<o,"invaid lod level"),this._levels[a].intersect(e,t,vg,yg,n,this.metadata,o)};this.baseMaterial.parameters.verticalOffset?this._octree.forEach(s):this._octree.forEachAlongRay(i,n,s)}notifyShaderTransformationChanged(){this._invalidateOctree(),this._requestUpdateCycle()}get _octree(){if(null==this._octreeCached){var e;const t=this._instanceData,i=null===(e=t.view)||void 0===e?void 0:e.state;if(!i)return null;this._octreeCached=new ag(t,this.baseBoundingSphere);for(let e=0;e<t.capacity;++e)i.get(e)&Kf.ACTIVE&&this._octreeCached.addInstance(e)}return this._octreeCached}_invalidateOctree(){this._octreeCached=(0,le.pR)(this._octreeCached)}queryDepthRange(e){if(null==this._octree)return{near:1/0,far:-1/0};const t=e.viewForward,i=this._octree.findClosest(t,Ro.A.DepthOrder.FRONT_TO_BACK,e.frustum),r=this._octree.findClosest(t,Ro.A.DepthOrder.BACK_TO_FRONT,e.frustum);if(null==i||null==r)return{near:1/0,far:-1/0};const n=e.eye,s=this._instanceData.view;s.boundingSphere.getVec(i,mg),(0,M.f)(mg,mg,n);const a=(0,M.j)(mg,t)-mg[3];s.boundingSphere.getVec(r,mg),(0,M.f)(mg,mg,n);const o=(0,M.j)(mg,t)+mg[3];return{near:Math.max(e.near,a),far:Math.min(e.far,o)}}_requestUpdateCycle(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this._updateCyclesWithStaticCamera=-1,this._cycleStartIndex=this._instanceIndex,e&&(this._needFullCycle=!0,this._context.requestRender())}_startUpdateCycle(){this._updateCyclesWithStaticCamera++,this._allRenderInstanceData.forEach((e=>e.forEach((e=>e.startUpdateCycle()))))}get running(){return this._instanceData.size>0&&this._updateCyclesWithStaticCamera<1}runTask(e){const{_enableLevelSelection:t,_camera:i,_levelSelector:r}=this;this._allRenderInstanceData.forEach((e=>e.forEach((e=>e.beginUpdate()))));const n=this._instanceData,s=n.view;let a=n.size;const o=n.capacity;let l=this._instanceIndex;const c=Math.ceil(o/500);for(let d=0;d<a&&!e.done;++d){l===this._cycleStartIndex&&this._startUpdateCycle();const d=s.state.get(l);let h=0;if(!(d&Kf.ALLOCATED)){l=l+1===o?0:l+1,a++;continue}const u=s.lodLevel.get(l);if(d&Kf.DEFAULT_ACTIVE&&this._defaultRenderInstanceData[0][u].freeTail(),d&Kf.HIGHLIGHT_ACTIVE&&this._highlightRenderInstanceData[0][u].freeTail(),d&Kf.REMOVE)n.freeInstance(l);else if(d&Kf.VISIBLE){let e=0;t&&(s.modelOrigin.getVec(l,gg),e=r.selectLevel(gg,n.getCombinedMedianScaleFactor(l),i)),h=d&~(Kf.ACTIVE|Kf.TRANSFORM_CHANGED),e>=0&&(d&Kf.HIGHLIGHT?(fg(this._highlightRenderInstanceData[0][e],s,l),h|=Kf.HIGHLIGHT_ACTIVE):(fg(this._defaultRenderInstanceData[0][e],s,l),h|=Kf.DEFAULT_ACTIVE)),s.state.set(l,h),s.lodLevel.set(l,e)}else h=d&~(Kf.ACTIVE|Kf.TRANSFORM_CHANGED),s.state.set(l,h);if(null!=this._octreeCached){const e=!!(d&Kf.ACTIVE),t=!!(h&Kf.ACTIVE);!e&&t?this._octreeCached.addInstance(l):e&&!t?this._octreeCached.removeInstance(l):e&&t&&d&Kf.TRANSFORM_CHANGED&&(this._octreeCached.removeInstance(l),this._octreeCached.addInstance(l))}l=l+1===o?0:l+1,l%c==0&&e.madeProgress()}this._instanceIndex=l,this._allRenderInstanceData.forEach((e=>e.forEach((e=>e.endUpdate())))),this._context.requestRender()}_beginComponent(e,t,i){if(0===t.size)return null;const r=i.glMaterials.load(e.rctx,e.bindParameters.slot,e.output);return null!=r?r.beginSlot(e.bindParameters):null}_renderComponent(e,t,i,r,n){if(!t)return;const{bindParameters:s,rctx:a}=e;a.runAppleAmdDriverHelper();const o=a.bindTechnique(t,s,r.material.parameters,xg);a.bindVAO(r.vao),t.ensureAttributeLocations(r.vao),Fn.b.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL&&e.output===ks.V.Color&&(o.setUniform4fv("externalColor",bg[Math.min(n,bg.length-1)]),o.setUniform1i("colorMixMode",_u.Um.replace));const l=i.capacity,c=i.headIndex,d=i.tailIndex,h=i.firstIndex,u=this._glInstanceBufferLayout,p=(e,n)=>{(0,ug.yu)(a,$s.D,i.buffer,u,e),a.drawArraysInstanced(t.primitiveType,0,r.vertexCount,n-e),(0,ug.Hi)(a,$s.D,i.buffer,u)};r.material.parameters.transparent&&null!=h?c>d?((0,br.vA)(h>=d&&h<=c,"invalid firstIndex"),p(h,c),p(d,h)):c<d&&(h<=c?((0,br.vA)(h>=0&&h<=c,"invalid firstIndex"),p(h,c),p(d,l),p(0,h)):((0,br.vA)(h>=d&&h<=l,"invalid firstIndex"),p(h,l),p(0,c),p(d,h))):c>d?p(d,c):c<d&&(p(0,c),p(d,l)),a.bindVAO(null)}};function fg(e,t,i){const r=e.allocateHead();!function(e,t,i,r){(0,Ts.Vk)(e.modelOrigin,t,i.modelOriginHi,i.modelOriginLo,r),i.model.copyFrom(r,e.model,t),i.modelNormal.copyFrom(r,e.modelNormal,t),e.color&&i.color&&i.color.copyFrom(r,e.color,t),e.objectAndLayerIdColor&&i.objectAndLayerIdColor&&i.objectAndLayerIdColor.copyFrom(r,e.objectAndLayerIdColor,t),e.featureAttribute&&i.featureAttribute&&i.featureAttribute.copyFrom(r,e.featureAttribute,t)}(t,i,e.view,r)}(0,r._)([(0,d.MZ)({constructOnly:!0})],pg.prototype,"symbol",void 0),(0,r._)([(0,d.MZ)({constructOnly:!0})],pg.prototype,"optionalFields",void 0),(0,r._)([(0,d.MZ)({constructOnly:!0})],pg.prototype,"metadata",void 0),(0,r._)([(0,d.MZ)({constructOnly:!0})],pg.prototype,"shaderTransformation",void 0),(0,r._)([(0,d.MZ)()],pg.prototype,"_instanceData",void 0),(0,r._)([(0,d.MZ)()],pg.prototype,"_cycleStartIndex",void 0),(0,r._)([(0,d.MZ)({readOnly:!0})],pg.prototype,"_enableLevelSelection",null),(0,r._)([(0,d.MZ)()],pg.prototype,"_updateCyclesWithStaticCamera",void 0),(0,r._)([(0,d.MZ)({readOnly:!0})],pg.prototype,"running",null),pg=(0,r._)([(0,u.$)("esri.views.3d.webgl-engine.lib.lodRendering.LodRenderer")],pg);const gg=(0,I.vt)(),mg=(0,L.vt)(),_g=(0,P.vt)(),vg=(0,I.vt)(),yg=(0,I.vt)(),bg=[(0,L.fA)(1,0,1,1),(0,L.fA)(0,0,1,1),(0,L.fA)(0,1,0,1),(0,L.fA)(1,1,0,1),(0,L.fA)(1,0,0,1)],xg=new hg.V;class Sg{constructor(e,t,i,r,n,s,a,o,l,c,d,h){this.lodResources=e,this.lodRenderer=t,this.stageResources=i,this.originalMaterialParameters=r,this.resourceSize=n,this.isEsriSymbolResource=s,this.isWosr=a,this.resourceBoundingBox=o,this.symbolSize=l,this.extentPadding=c,this.physicalBasedRenderingEnabled=d,this.pivotOffset=h}}const wg=(0,I.vt)(),Cg=(0,P.vt)(),Ag=(0,P.vt)(),Rg=(0,L.vt)(),Eg=new Ut;class Og{constructor(e,t,i,r){this.vertices=e,this.positionsES=t,this.offset=r;const n=e.length,s=Math.floor(n/2),a=this.offset+3*s,o=i[a],l=i[a+1],c=i[a+2];this.origin=(0,I.fA)(o,l,c),this.positions=(0,Y.oe)(3*n);const d=this.offset+3*n;for(let h=this.offset;h<d;h+=3)this.positions[h]=i[h]-o,this.positions[h+1]=i[h+1]-l,this.positions[h+2]=i[h+2]-c;this.updatePathVertexInformation()}get usedMemory(){return(0,A.Ek)(this.positions)}updatePathVertexInformation(){const e=this.vertices.length,t=this.vertices[0];let i=this.offset;const r=this.positions;t.vRight[0]=r[i+3]-r[i],t.vRight[1]=r[i+4]-r[i+1],t.vRight[2]=r[i+5]-r[i+2],i+=3;let n=(0,M.l)(t.vRight);t.vMinSiblingLength=n,(0,M.n)(t.vRight,t.vRight);let s=t;for(let a=1;a<e;++a){const t=this.vertices[a];if(t.vLeft=s.vRight,a<e-1){t.vRight[0]=r[i+3]-r[i],t.vRight[1]=r[i+4]-r[i+1],t.vRight[2]=r[i+5]-r[i+2];const e=(0,M.l)(t.vRight);t.vMinSiblingLength=Math.min(n,e),n=e,(0,M.n)(t.vRight,t.vRight)}else(0,M.c)(t.vRight,t.vLeft),t.vMinSiblingLength=n;s=t,i+=3}}}class Tg{constructor(e,t,i,r,n){let s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:{};this.path=e,this.profile=t,this.extruder=i,this.startCap=r,this.endCap=n,this.options=s,this._extrusionVertexCount=0;const a=this.path.vertices.length-2;this.numExtrusionProfiles=i.numProfilesPerJoin()*a+2,this.numVerticesTotal=t.vertices.length*this.numExtrusionProfiles,this.startCap.vertexBufferStart=this.numVerticesTotal;const o=this.startCap.numVertices;this.numVerticesTotal+=o,this.endCap.vertexBufferStart=this.numVerticesTotal;const l=this.endCap.numVertices;this.numVerticesTotal+=l,this.pathVertexData=(0,X.JH)(1*this.numVerticesTotal),this.profileRightAxes=(0,Y.oe)(4*this.numVerticesTotal),this.profileUpAxes=(0,Y.oe)(4*this.numVerticesTotal),this.profileVertexAndNormals=(0,Y.oe)(4*this.numVerticesTotal),this.positions=(0,Y.AK)(e.positions,e.offset,3*e.vertices.length),this._rebuildGeometry(),this.buildTopology()}get usedMemory(){return(0,A.Ek)(this.pathVertexData,this.profileRightAxes,this.profileUpAxes,this.profileVertexAndNormals)+this.path.usedMemory+this.profile.usedMemory}emitVertex(e,t,i,r,n){const s=4*this._extrusionVertexCount;if(this.profileRightAxes[s]=t.right[0],this.profileRightAxes[s+1]=t.right[1],this.profileRightAxes[s+2]=t.right[2],this.profileUpAxes[s]=t.up[0],this.profileUpAxes[s+1]=t.up[1],this.profileUpAxes[s+2]=t.up[2],this.profileVertexAndNormals[s]=i[0],this.profileVertexAndNormals[s+1]=i[1],this.profileVertexAndNormals[s+2]=r[0],this.profileVertexAndNormals[s+3]=r[1],this.pathVertexData[this._extrusionVertexCount]=e,n){const t=this.path.vertices[e],i=t.maxStretchDistance;this.profileRightAxes[s+3]=t.rotationRight[0]*i,this.profileUpAxes[s+3]=t.rotationRight[1]*i}else this.profileRightAxes[s+3]=0,this.profileUpAxes[s+3]=0;++this._extrusionVertexCount}emitCapVertex(e,t,i,r,n,s){const a=4*this._extrusionVertexCount;this.profileRightAxes[a]=t.right[0],this.profileRightAxes[a+1]=t.right[1],this.profileRightAxes[a+2]=t.right[2],this.profileRightAxes[a+3]=n,this.profileUpAxes[a]=t.up[0],this.profileUpAxes[a+1]=t.up[1],this.profileUpAxes[a+2]=t.up[2],this.profileUpAxes[a+3]=s,this.profileVertexAndNormals[a]=i[0],this.profileVertexAndNormals[a+1]=i[1],this.profileVertexAndNormals[a+2]=r[0],this.profileVertexAndNormals[a+3]=r[1],this.pathVertexData[this._extrusionVertexCount]=e,++this._extrusionVertexCount}_rebuildGeometry(){this._extrusionVertexCount=0;const{positions:e,offset:t,vertices:i}=this.path;this.positions=(0,Y.AK)(e,t,3*i.length);let r=0;const n=(e,t,i,n,s)=>this.emitCapVertex(r,e,t,i,n,s),s=(e,t,i,n)=>this.emitVertex(r,e,t,i,n);for(this.startCap.rebuildConnectingProfileGeometry(i[r],this.profile,n),r=1;r<i.length-1;++r)this.extruder.extrude(i[r],this.profile,s);this.endCap.rebuildConnectingProfileGeometry(i[r],this.profile,n),r=0,this.startCap.rebuildCapGeometry(i[r],n),r=i.length-1,this.endCap.rebuildCapGeometry(i[r],n)}buildTopology(){const e=this.profile.vertices.length,t=this.profile.numSegments,i=this.numExtrusionProfiles-1;let r=t*i*2*3;this.startCap.indexBufferStart=r,this.startCap.firstProfileVertexIndex=0,r+=this.startCap.numIndices,this.endCap.indexBufferStart=r,this.endCap.firstProfileVertexIndex=e*(this.numExtrusionProfiles-1);const n=new Array,s=new Array,a=new Array,o=(e,t,i)=>{n.push(e),n.push(t),n.push(i),s.push(e),s.push(t),s.push(i),a.push(this.pathVertexData[e]),a.push(this.pathVertexData[t]),a.push(this.pathVertexData[i])};for(let l=0;l<t;++l){const t=this.profile.indices[2*l],r=this.profile.indices[2*l+1];for(let n=0;n<i;++n){const i=n*e+t,s=(n+1)*e+r,a=n*e+r;o(i,(n+1)*e+t,s),o(i,s,a)}}this.startCap.buildTopology(this.path.vertices[0],o),this.endCap.buildTopology(this.path.vertices[this.path.vertices.length-1],o),this.vertexIndices=(0,X.Dg)(n),this.normalIndices=(0,X.Dg)(s),this.pathVertexIndices=(0,X.Dg)(a)}onPathChanged(){this._rebuildGeometry()}}class Pg{rebuildConnectingProfileGeometry(e,t,i){for(let r=0;r<t.vertices.length;++r)i(e.frame,t.vertices[r],t.normals[r],0,0)}}class Mg extends Pg{constructor(){super(),this.numVertices=0,this.numIndices=0}rebuildCapGeometry(){}buildTopology(){}}class Ig extends Pg{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];super(),this.profile=e,this.profilePlaneOffset=t,this.flip=i}get numVertices(){return this.profile.vertices.length}get numIndices(){return 3*this.profile.numSegments}rebuildConnectingProfileGeometry(e,t,i){const r=this.profilePlaneOffset;for(let n=0;n<t.vertices.length;++n)i(e.frame,t.vertices[n],t.normals[n],r,0)}rebuildCapGeometry(e,t){const i=this.profile,r=this.flip?1:-1,n=this.profilePlaneOffset,s=Fg;(0,Sa.hZ)(s,0,0);for(let a=0;a<i.vertices.length;++a)t(e.frame,i.vertices[a],s,n,r)}buildTopology(e,t){const i=this.profile,r=this.vertexBufferStart+i.indices[0];for(let n=1;n<i.numSegments;++n){const e=i.indices[2*n],s=i.indices[2*n+1],a=this.vertexBufferStart+e,o=this.vertexBufferStart+s;this.flip?t(o,a,r):t(r,a,o)}}}class Dg extends Pg{constructor(e){super(),this.flip=!1,this.sign=0,this.breakNormals=!1,this.numSegments=3,this.profile=e.profile,this.flip=e.flip,this.sign=this.flip?1:-1,this.breakNormals=e.breakNormals,this.numSegments=e.subdivisions}get numVertices(){let e=this.profile.vertices.length*(this.numSegments-1)+this.profile.poles.length;return this.breakNormals&&(e+=this.profile.vertices.length),e}get numIndices(){let e=0;const t=this.profile;e+=2*t.numSegments*(this.numSegments-1);for(let i=0;i<t.numSegments;++i){const r=t.indices[2*i],n=t.indices[2*i+1];t.poleIndices[r]===t.poleIndices[n]?e+=1:e+=2}return 3*e}rebuildCapGeometry(e,t){const i=this.profile,r=e.frame,n=.5*this.sign,s=Lg,a=Fg;(0,Sa.hZ)(a,0,0);for(const o of i.poles)o.normal?t(r,o.position,o.normal,n,0):t(r,o.position,a,n,this.sign);if(this.breakNormals)for(let o=0;o<i.vertices.length;++o)t(r,i.vertices[o],i.normals[o],0,0);for(let o=0;o<this.numSegments-1;++o){const e=(1-(o+1)/this.numSegments)*Math.PI*.5,l=Math.sin(e),c=Math.cos(e);for(let o=0;o<i.vertices.length;++o){const e=i.poles[i.poleIndices[o]];(0,Sa.Re)(s,i.vertices[o],e.position),(0,Sa.hs)(s,s,l),e.normal?((0,Sa.WQ)(s,s,e.position),t(r,s,e.normal,n*c,0)):((0,Sa.S8)(a,s),(0,Sa.hs)(a,a,l),(0,Sa.WQ)(s,s,e.position),t(r,s,a,n*c,this.sign*c))}}}buildTopology(e,t){const i=this.profile,r=this.breakNormals?this.vertexBufferStart+i.poles.length:this.firstProfileVertexIndex,n=this.breakNormals?this.vertexBufferStart+i.poles.length+i.vertices.length:this.vertexBufferStart+i.poles.length;for(let s=0;s<i.numSegments;++s){const e=i.indices[2*s],a=i.indices[2*s+1],o=this.vertexBufferStart+i.poleIndices[e],l=this.vertexBufferStart+i.poleIndices[a];let c=r+e,d=r+a;for(let r=0;r<this.numSegments-1;++r){const s=n+r*i.vertices.length+e,o=n+r*i.vertices.length+a;this.flip?(t(s,d,c),t(d,s,o)):(t(c,d,s),t(o,s,d)),c=s,d=o}this.flip?(t(o,d,c),o!==l&&t(o,l,d)):(t(c,d,o),o!==l&&t(d,l,o))}}}const Lg=(0,pr.vt)(),Fg=(0,pr.vt)();class Ng{numProfilesPerJoin(){return 1}extrude(e,t,i){for(let r=0;r<t.vertices.length;++r)i(e.frame,t.vertices[r],t.normals[r],!1)}}class Vg{constructor(e,t){this.cutoffAngle=e,this.numBendSubdivisions=t}numProfilesPerJoin(){return this.numBendSubdivisions+1}extrude(e,t,i){const r=Hg,{rotationAngle:n,rotationRight:s,frame:a}=e;if(Math.abs(n)>=this.cutoffAngle){const o=e.rotationFrameUp;for(let l=0;l<this.numBendSubdivisions+1;++l){(0,T.$0)(Bg,.5*-n+l*n/this.numBendSubdivisions,o),Ug(r,a,Bg);for(let o=0;o<t.vertices.length;++o)(0,Sa.Om)(t.vertices[o],s)*n>=0?i(r,t.vertices[o],t.normals[o],!1):i(a,e.applyMiterStretch(zg,t.vertices[o]),t.normals[o],!0)}}else for(let o=0;o<this.numBendSubdivisions+1;++o)for(let r=0;r<t.vertices.length;++r){const o=(0,Sa.Om)(t.vertices[r],s)*n>=0;i(a,e.applyMiterStretch(zg,t.vertices[r]),t.normals[r],!o)}}}class Gg{constructor(){this.up=(0,I.vt)(),this.right=(0,I.vt)()}}function Ug(e,t,i){(0,M.e)(e.up,t.up,i),(0,M.e)(e.right,t.right,i)}const zg=(0,pr.vt)(),Bg=(0,P.vt)(),Hg=new Gg;class jg extends yr.V{constructor(e,t,i,r,n,s){super(e,t,null,vr.X.Mesh,s),this.path=i,this.geometrySR=r,this.stencilWidth=n}}var Wg;function kg(e){return"path"in e}!function(e){e[e.World=0]="World",e[e.Path=1]="Path"}(Wg||(Wg={}));class Zg{constructor(e){this.builder=e}onPathChanged(e){this.builder.onPathChanged()}}class qg extends Zg{constructor(e){super(e),this.vertexAttributeColor=(0,L.fA)(255,255,255,255),this.size=new Array,this.vertexAttributePosition=(0,Y.oe)(3*this.builder.numVerticesTotal),this.vertexAttributeNormal=new Int16Array(2*this.builder.numVerticesTotal)}bakeVertexColors(e){this.vertexAttributeColor[0]=255*e[0],this.vertexAttributeColor[1]=255*e[1],this.vertexAttributeColor[2]=255*e[2],this.vertexAttributeColor[3]=255*(e.length>3?e[3]:1)}bake(e){this.size=e;const{numVerticesTotal:t,pathVertexData:i,path:r,positions:n,profileRightAxes:s,profileUpAxes:a,profileVertexAndNormals:o}=this.builder;for(let l=0;l<t;++l){let t=i[l];const c=0===t||t===r.vertices.length-1;t*=3;const d=Kg;let h=0,u=0;const p=4*l,f=(0,M.s)(em,s[p],s[p+1],s[p+2]),g=(0,M.s)(tm,a[p],a[p+1],a[p+2]),m=(0,Sa.hZ)(Jg,o[p]*e[0],o[p+1]*e[1]);if(c)(0,M.b)(d,g,f),h=s[p+3]*e[0],u=a[p+3];else{const e=Yg,t=Xg;(0,Sa.hZ)(e,s[p+3],a[p+3]);const i=(0,Sa.Bw)(e);(0,Sa.S8)(e,e);const r=(0,Sa.Om)(m,e);if(Math.abs(r)>i){(0,Sa.hZ)(t,-e[1],e[0]);const n=(0,Sa.Om)(m,t);(0,Sa.hs)(e,e,i*Math.sign(r)),(0,Sa.hs)(t,t,n),(0,Sa.WQ)(m,e,t)}(0,M.s)(d,0,0,0)}const _=(0,M.s)($g,f[0]*m[0]+g[0]*m[1],f[1]*m[0]+g[1]*m[1],f[2]*m[0]+g[2]*m[1]),v=3*l;this.vertexAttributePosition[v]=n[t]+_[0]+d[0]*h,this.vertexAttributePosition[v+1]=n[t+1]+_[1]+d[1]*h,this.vertexAttributePosition[v+2]=n[t+2]+_[2]+d[2]*h;const y=(0,Sa.hZ)(Jg,o[p+2],o[p+3]);(0,oh.aT)(this.vertexAttributeNormal,l,f[0]*y[0]+g[0]*y[1]+d[0]*u,f[1]*y[0]+g[1]*y[1]+d[1]*u,f[2]*y[0]+g[2]*y[1]+d[2]*u)}}createGeometryData(){const e=this.builder.vertexIndices.length,{normalIndices:t,vertexIndices:i}=this.builder;return[[Pt.r.POSITION,new _r.n(this.vertexAttributePosition,i,3,!0)],[Pt.r.NORMALCOMPRESSED,new _r.n(this.vertexAttributeNormal,t,2,!0)],[Pt.r.COLOR,new _r.n(this.vertexAttributeColor,(0,X.EH)(e),4)]]}onPathChanged(e){super.onPathChanged(e),this.bake(this.size)}intersect(e,t,i){const r=this.builder.vertexIndices,n=new _r.K(this.vertexAttributePosition,3),s=r.length/3;(0,_u.Z$)(e,t,0,s,r,n,void 0,void 0,i)}}class Qg extends Zg{constructor(e,t,i,r){super(e),this.sizeAttributeValue=t,this.colorAttributeValue=i,this.opacityAttributeValue=r,this.vvData=null,this.baked=new qg(e),this.vvData=(0,Y.oe)(4*this.builder.path.vertices.length);for(let n=0;n<this.builder.path.vertices.length;++n){this.vvData[4*n]=t,this.vvData[4*n+1]=i,this.vvData[4*n+2]=r;const e=0===n||n===this.builder.path.vertices.length-1;this.vvData[4*n+3]=e?1:0}}createGeometryData(){const{positions:e,profileRightAxes:t,profileUpAxes:i,profileVertexAndNormals:r,pathVertexIndices:n,vertexIndices:s}=this.builder;return[[Pt.r.POSITION,new _r.n(e,n,3,!0)],[Pt.r.PROFILERIGHT,new _r.n(t,s,4,!0)],[Pt.r.PROFILEUP,new _r.n(i,s,4,!0)],[Pt.r.PROFILEVERTEXANDNORMAL,new _r.n(r,s,4,!0)],[Pt.r.FEATUREVALUE,new _r.n(this.vvData,n,4,!0)]]}onPathChanged(e){super.onPathChanged(e);const t=e.getMutableAttribute(Pt.r.POSITION);t&&(t.data=this.builder.positions)}}const Jg=(0,pr.vt)(),Yg=(0,pr.vt)(),Xg=(0,pr.vt)(),$g=(0,I.vt)(),Kg=(0,I.vt)(),em=(0,I.vt)(),tm=(0,I.vt)();const im=(0,I.vt)();class rm{constructor(){this.vertices=new Array,this.normals=new Array,this.indices=new Array,this.poles=new Array,this.poleIndices=new Array}addVertex(e,t){return this.vertices.push((0,pr.o8)(e)),this.normals.push((0,pr.o8)(t)),this.vertices.length-1}addPole(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return this.poles.push({position:(0,pr.o8)(e),normal:t?(0,pr.o8)(t):null}),this.poles.length-1}addSegment(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;this.indices.push(e.v0),this.indices.push(e.v1),t&&(this.poleIndices.push(t.v0),this.poleIndices.push(t.v1))}get numSegments(){return this.indices.length/2}translate(e,t){for(const i of this.vertices)i[0]+=e,i[1]+=t;for(const i of this.poles)i.position[0]+=e,i.position[1]+=t}get usedMemory(){return this.vertices.length*(0,A.Ek)(this.vertices[0])*2+(0,A.Ek)(this.indices)}}const nm={top:[0,-.5],bottom:[0,.5]};function sm(e){const t=hr,i=new rm,r={v0:0,v1:0};i.addPole((0,pr.fA)(0,0));for(let s=0;s<t;++s){const e=2*s*Math.PI/t,r=Math.cos(e),n=Math.sin(e),a=(0,pr.fA)(.5*r,.5*n),o=(0,pr.fA)(r,n);i.addVertex(a,o)}for(let s=0;s<t-1;++s){const e={v0:s,v1:s+1};i.addSegment(e,r)}const n={v0:t-1,v1:0};if(i.addSegment(n,r),"center"!==e){const t=nm[e];i.translate(t[0],t[1])}return i}const am={center:sm("center"),top:sm("top"),bottom:sm("bottom")},om={center:lm("center"),top:lm("top"),bottom:lm("bottom")};function lm(e){const t=new rm,i=(0,pr.fA)(-.5,-.5),r=(0,pr.fA)(.5,-.5),n=(0,pr.fA)(.5,.5),s=(0,pr.fA)(-.5,.5),a=(0,pr.fA)(0,-1),o=(0,pr.fA)(1,0),l=(0,pr.fA)(0,1),c=(0,pr.fA)(-1,0);if(t.addPole((0,pr.fA)(0,.5),l),t.addPole((0,pr.fA)(0,.5)),t.addPole((0,pr.fA)(0,-.5)),t.addPole((0,pr.fA)(0,-.5),a),t.addVertex(i,a),t.addVertex(r,a),t.addSegment({v0:0,v1:1},{v0:3,v1:3}),t.addVertex(r,o),t.addVertex(n,o),t.addSegment({v0:2,v1:3},{v0:2,v1:1}),t.addVertex(n,l),t.addVertex(s,l),t.addSegment({v0:4,v1:5},{v0:0,v1:0}),t.addVertex(s,c),t.addVertex(i,c),t.addSegment({v0:6,v1:7},{v0:1,v1:2}),"center"!==e){const i=nm[e];t.translate(i[0],i[1])}return t}var cm=i(53494);function dm(e,t,i,r,n){return e[0]=t,e[1]=i,e[2]=r,e[3]=n,e}function hm(e,t,i){const r=t[0],n=t[1],s=t[2],a=t[3],o=i[0],l=i[1],c=i[2],d=i[3];return e[0]=r*o+s*l,e[1]=n*o+a*l,e[2]=r*c+s*d,e[3]=n*c+a*d,e}function um(e,t,i){return e[0]=t[0]-i[0],e[1]=t[1]-i[1],e[2]=t[2]-i[2],e[3]=t[3]-i[3],e}const pm=hm,fm=um;Object.freeze(Object.defineProperty({__proto__:null,LDU:function(e,t,i,r){return e[2]=r[2]/r[0],i[0]=r[0],i[1]=r[1],i[3]=r[3]-e[2]*i[1],[e,t,i]},add:function(e,t,i){return e[0]=t[0]+i[0],e[1]=t[1]+i[1],e[2]=t[2]+i[2],e[3]=t[3]+i[3],e},adjoint:function(e,t){const i=t[0];return e[0]=t[3],e[1]=-t[1],e[2]=-t[2],e[3]=i,e},copy:function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},determinant:function(e){return e[0]*e[3]-e[2]*e[1]},equals:function(e,t){const i=e[0],r=e[1],n=e[2],s=e[3],a=t[0],o=t[1],l=t[2],c=t[3],d=(0,cm.FD)();return Math.abs(i-a)<=d*Math.max(1,Math.abs(i),Math.abs(a))&&Math.abs(r-o)<=d*Math.max(1,Math.abs(r),Math.abs(o))&&Math.abs(n-l)<=d*Math.max(1,Math.abs(n),Math.abs(l))&&Math.abs(s-c)<=d*Math.max(1,Math.abs(s),Math.abs(c))},exactEquals:function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]},frob:function(e){return Math.sqrt(e[0]**2+e[1]**2+e[2]**2+e[3]**2)},fromRotation:function(e,t){const i=Math.sin(t),r=Math.cos(t);return e[0]=r,e[1]=i,e[2]=-i,e[3]=r,e},fromScaling:function(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=t[1],e},identity:function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e},invert:function(e,t){const i=t[0],r=t[1],n=t[2],s=t[3];let a=i*s-n*r;return a?(a=1/a,e[0]=s*a,e[1]=-r*a,e[2]=-n*a,e[3]=i*a,e):null},mul:pm,multiply:hm,multiplyScalar:function(e,t,i){return e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i,e[3]=t[3]*i,e},multiplyScalarAndAdd:function(e,t,i,r){return e[0]=t[0]+i[0]*r,e[1]=t[1]+i[1]*r,e[2]=t[2]+i[2]*r,e[3]=t[3]+i[3]*r,e},rotate:function(e,t,i){const r=t[0],n=t[1],s=t[2],a=t[3],o=Math.sin(i),l=Math.cos(i);return e[0]=r*l+s*o,e[1]=n*l+a*o,e[2]=r*-o+s*l,e[3]=n*-o+a*l,e},scale:function(e,t,i){const r=t[0],n=t[1],s=t[2],a=t[3],o=i[0],l=i[1];return e[0]=r*o,e[1]=n*o,e[2]=s*l,e[3]=a*l,e},set:dm,str:function(e){return"mat2("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")"},sub:fm,subtract:um,transpose:function(e,t){if(e===t){const i=t[1];e[1]=t[2],e[2]=i}else e[0]=t[0],e[1]=t[2],e[2]=t[1],e[3]=t[3];return e}},Symbol.toStringTag,{value:"Module"}));function gm(){return[1,0,0,1]}Object.freeze(Object.defineProperty({__proto__:null,clone:function(e){return[e[0],e[1],e[2],e[3]]},create:gm,createView:function(e,t){return new Float64Array(e,t,4)},fromValues:function(e,t,i,r){return[e,t,i,r]}},Symbol.toStringTag,{value:"Module"}));class mm{constructor(){this.vLeft=(0,I.vt)(),this.vRight=(0,I.vt)(),this.vMinSiblingLength=0,this.frame=new Gg}setFrameFromUpVector(e){(0,M.c)(this.frame.up,e),(0,M.g)(Om,this.vLeft,this.vRight),(0,M.n)(Om,Om),(0,M.h)(Em,this.frame.up,(0,M.j)(Om,this.frame.up)),(0,M.f)(Tm,Om,Em),(0,M.n)(Tm,Tm),(0,M.b)(this.frame.right,Tm,this.frame.up)}get foldingAngle(){return Math.PI-this.rotationAngle}}class _m extends mm{get rotationFrameUp(){return this.frame.up}get rotationRight(){return pr.Cw}get rotationAngle(){return(0,M.h)(Am,this.frame.up,(0,M.j)(this.frame.up,this.vLeft)),(0,M.f)(Am,this.vLeft,Am),(0,M.E)(Am,Am),(0,M.n)(Am,Am),(0,M.h)(Rm,this.frame.up,(0,M.j)(this.frame.up,this.vRight)),(0,M.f)(Rm,this.vRight,Rm),(0,M.n)(Rm,Rm),(0,M.b)(Cm,this.rotationFrameUp,this.vLeft),Math.sign((0,M.j)(Cm,this.vRight))*(Math.PI-(0,U.XM)((0,M.j)(Am,Rm)))}get maxStretchDistance(){return Math.abs(this.vMinSiblingLength/Math.cos(.5*this.foldingAngle))}applyMiterStretch(e,t){const i=this.rotationAngle;if(Math.abs(i)<=0)return t;const r=(0,U.J_)(Math.cos(.5*i));return(0,Sa.hZ)(e,(r-1+1)*t[0],t[1])}}class vm extends mm{get rotationFrameUp(){const e=Math.sign((0,M.j)(this.frame.right,this.vRight));return(0,M.b)(bm,this.vRight,this.vLeft),(0,M.h)(bm,bm,e),(0,M.n)(bm,bm)}get rotationRight(){const e=this.rotationFrameUp,t=(0,M.j)(e,this.frame.up),i=(0,M.j)(e,this.frame.right);return(0,M.h)(Sm,this.frame.up,-i),(0,M.h)(wm,this.frame.right,t),(0,M.g)(Sm,Sm,wm),(0,M.n)(Sm,Sm),function(e,t,i){(0,Sa.hZ)(e,(0,M.j)(i,t.right),(0,M.j)(i,t.up))}(xm,this.frame,Sm),xm}get rotationAngle(){const e=Math.sign((0,M.j)(this.frame.right,this.vRight));return(0,M.E)(Cm,this.vLeft),-e*(Math.PI-(0,U.XM)((0,M.j)(Cm,this.vRight)))}get maxStretchDistance(){return Math.abs(this.vMinSiblingLength*(0,U.J_)(Math.cos(.5*this.foldingAngle)))}applyMiterStretch(e,t){const i=this.rotationAngle;if(0===Math.abs(i))return t;const r=(0,U.J_)(Math.cos(.5*i)),n=this.rotationRight,s=dm(Pm,1+(r-1)*n[0]*n[0],(r-1)*n[0]*n[1],(r-1)*n[0]*n[1],1+(r-1)*n[1]*n[1]);return(0,Sa.ZF)(e,t,s)}}function ym(e){switch(e){case Wg.World:return new _m;case Wg.Path:return new vm}}const bm=(0,I.vt)(),xm=(0,pr.vt)(),Sm=(0,I.vt)(),wm=(0,I.vt)(),Cm=(0,I.vt)(),Am=(0,I.vt)(),Rm=(0,I.vt)(),Em=(0,I.vt)(),Om=(0,I.vt)(),Tm=(0,I.vt)(),Pm=[1,0,0,1];var Mm=i(27920),Im=i(85887),Dm=i(91116);const Lm=new Map([[Pt.r.POSITION,0],[Pt.r.PROFILERIGHT,1],[Pt.r.PROFILEUP,2],[Pt.r.PROFILEVERTEXANDNORMAL,3],[Pt.r.FEATUREVALUE,4]]);class Fm extends Im.W{constructor(){super(...arguments),this.ambient=(0,I.fA)(.2,.2,.2),this.diffuse=(0,I.fA)(.8,.8,.8),this.specular=(0,I.fA)(0,0,0),this.opacity=1,this.origin=(0,I.vt)(),this.modelTransformation=null}}class Nm extends Xs.w{initializeConfiguration(e,t){t.spherical=e.viewingMode===ae.RT.Global,t.doublePrecisionRequiresObfuscation=e.rctx.driverTest.doublePrecisionRequiresObfuscation.result}initializeProgram(e){return new Ks.B(e.rctx,Nm.shader.get().build(this.configuration),Lm)}initializePipeline(){const e=this.configuration.transparencyPassType,t=this.configuration,i=e===Lo.y.NONE,r=e===Lo.y.FrontFace;return(0,ta.Ey)({blending:t.output!==ks.V.Color&&t.output!==ks.V.Alpha||!t.transparent?null:i?Io.V0:(0,Io.ez)(e),culling:t.hasSlicePlane&&!t.transparent&&t.doubleSidedMode!==Mm.W.None?ta.hG:null,depthTest:{func:(0,Io.K_)(e)},depthWrite:i||r?ta.kn:null,colorWrite:ta.wE,stencilWrite:t.hasOccludees?Do.v0:null,stencilTest:t.hasOccludees?Do.qh:null,polygonOffset:i||r?null:Io.SE})}}Nm.shader=new Ys.$(Dm.P,(()=>i.e(438).then(i.bind(i,10438))));class Vm extends na.E{constructor(){super(...arguments),this.output=ks.V.Color,this.doubleSidedMode=Mm.W.None,this.transparencyPassType=Lo.y.NONE,this.spherical=!1,this.receiveShadows=!1,this.receiveAmbientOcclusion=!1,this.vvSize=!1,this.vvColor=!1,this.vvOpacity=!1,this.hasSlicePlane=!1,this.transparent=!1,this.hasOccludees=!1,this.multipassEnabled=!1,this.cullAboveGround=!1,this.doublePrecisionRequiresObfuscation=!1}}(0,r._)([(0,ra.W)({count:ks.V.COUNT})],Vm.prototype,"output",void 0),(0,r._)([(0,ra.W)({count:Mm.W.COUNT})],Vm.prototype,"doubleSidedMode",void 0),(0,r._)([(0,ra.W)({count:Lo.y.COUNT})],Vm.prototype,"transparencyPassType",void 0),(0,r._)([(0,ra.W)()],Vm.prototype,"spherical",void 0),(0,r._)([(0,ra.W)()],Vm.prototype,"receiveShadows",void 0),(0,r._)([(0,ra.W)()],Vm.prototype,"receiveAmbientOcclusion",void 0),(0,r._)([(0,ra.W)()],Vm.prototype,"vvSize",void 0),(0,r._)([(0,ra.W)()],Vm.prototype,"vvColor",void 0),(0,r._)([(0,ra.W)()],Vm.prototype,"vvOpacity",void 0),(0,r._)([(0,ra.W)()],Vm.prototype,"hasSlicePlane",void 0),(0,r._)([(0,ra.W)()],Vm.prototype,"transparent",void 0),(0,r._)([(0,ra.W)()],Vm.prototype,"hasOccludees",void 0),(0,r._)([(0,ra.W)()],Vm.prototype,"multipassEnabled",void 0),(0,r._)([(0,ra.W)()],Vm.prototype,"cullAboveGround",void 0),(0,r._)([(0,ra.W)()],Vm.prototype,"doublePrecisionRequiresObfuscation",void 0),(0,r._)([(0,ra.W)({constValue:!1})],Vm.prototype,"occlusionPass",void 0),(0,r._)([(0,ra.W)({constValue:$a.A9.Disabled})],Vm.prototype,"pbrMode",void 0),(0,r._)([(0,ra.W)({constValue:!0})],Vm.prototype,"hasVvInstancing",void 0),(0,r._)([(0,ra.W)({constValue:!1})],Vm.prototype,"useCustomDTRExponentForWater",void 0),(0,r._)([(0,ra.W)({constValue:!1})],Vm.prototype,"useFillLights",void 0),(0,r._)([(0,ra.W)({constValue:!1})],Vm.prototype,"hasColorTexture",void 0);class Gm extends qs.im{constructor(e){super(e,new zm),this.supportsEdges=!0,this.produces=new Map([[Qs.N.OPAQUE_MATERIAL,e=>(this.parameters.castShadows&&(0,ks.PJ)(e)||(0,ks.XY)(e))&&!this.parameters.transparent],[Qs.N.TRANSPARENT_MATERIAL,e=>(this.parameters.castShadows&&(0,ks.PJ)(e)||(0,ks.XY)(e))&&this.parameters.transparent]]),this._vertexAttributeLocations=Lm,this._configuration=new Vm,this._vertexBufferLayout=Gm.getVertexBufferLayout()}getConfiguration(e,t){return this._configuration.output=e,this._configuration.vvSize=!!this.parameters.vvSize,this._configuration.vvColor=!!this.parameters.vvColor,this._configuration.vvOpacity=!!this.parameters.vvOpacity,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.transparent=this.parameters.transparent,this._configuration.hasOccludees=this.parameters.hasOccludees,e!==ks.V.Color&&e!==ks.V.Alpha||(this._configuration.doubleSidedMode=this.parameters.doubleSided&&"normal"===this.parameters.doubleSidedType?Mm.W.View:this.parameters.doubleSided&&"winding-order"===this.parameters.doubleSidedType?Mm.W.WindingOrder:Mm.W.None,this._configuration.receiveShadows=this.parameters.receiveShadows,this._configuration.receiveAmbientOcclusion=null!=t.ssao),this._configuration.transparencyPassType=t.transparencyPassType,this._configuration.multipassEnabled=t.multipassEnabled,this._configuration.cullAboveGround=t.multipassTerrain.cullAboveGround,this._configuration}isVisibleForOutput(e){return e!==ks.V.Shadow&&e!==ks.V.ShadowExcludeHighlight&&e!==ks.V.ShadowHighlight||this.parameters.castShadows}isVisible(){return super.isVisible()&&this.parameters.opacity>0}intersect(e,t,i,r,n,s){const a=e;if(!kg(a))return;const o=a.path,l=[this.parameters.size[0],this.parameters.size[1]];if(this.parameters.vvSize){const{offset:e,factor:t,minSize:i,maxSize:r}=this.parameters.vvSize,n=o.sizeAttributeValue;l[0]*=(0,U.qE)(e[0]+n*t[0],i[0],r[0]),l[1]*=(0,U.qE)(e[2]+n*t[2],i[2],r[2])}const c=Math.max(l[0],l[1]),d=e.boundingInfo;if(null==d)return void this._intersectTriangles(o,l,r,n,s);const h=(0,q.fA)(d.bbMin[0]-c,d.bbMin[1]-c,d.bbMin[2]-c,d.bbMax[0]+c,d.bbMax[1]+c,d.bbMax[2]+c),u=[n[0]-r[0],n[1]-r[1],n[2]-r[2]],p=Math.sqrt(u[0]*u[0]+u[1]*u[1]+u[2]*u[2]),f=[p/u[0],p/u[1],p/u[2]];(0,_u.Wb)(h,r,f,i.tolerance)&&this._intersectTriangles(o,l,r,n,s)}_intersectTriangles(e,t,i,r,n){e.baked.size&&e.baked.size[0]===t[0]&&e.baked.size[1]===t[1]||e.baked.bake(t),e.baked.intersect(i,r,n)}createBufferWriter(){return new Qp.Z(this._vertexBufferLayout)}createGLMaterial(e){return new Um(e)}static getVertexBufferLayout(){return(0,Ws.BP)().vec3f(Pt.r.POSITION).vec4f(Pt.r.PROFILERIGHT).vec4f(Pt.r.PROFILEUP).vec4f(Pt.r.PROFILEVERTEXANDNORMAL).vec4f(Pt.r.FEATUREVALUE)}}class Um extends Zs.A{_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})}_updateShadowState(e){null!=this.technique&&e.shadowMap.enabled===this.technique.configuration.receiveShadows||this._material.setParameters({receiveShadows:e.shadowMap.enabled})}beginSlot(e){return this._output!==ks.V.Color&&this._output!==ks.V.Alpha||(this._updateShadowState(e),this._updateOccludeeState(e)),this.ensureTechnique(Nm,e)}}class zm extends Fm{constructor(){super(...arguments),this.doubleSided=!1,this.doubleSidedType="normal",this.receiveShadows=!1,this.castShadows=!0,this.hasSlicePlane=!1,this.transparent=!1,this.hasOccludees=!1}}const Bm=["polyline"];function Hm(e,t,i){const{origin:r,positions:n}=e;let s=e.offset;switch(t){default:case Wg.World:for(const t of e.vertices)km[0]=n[s++]+r[0],km[1]=n[s++]+r[1],km[2]=n[s++]+r[2],i.worldUpAtPosition(km,km),t.setFrameFromUpVector(km);break;case Wg.Path:km[0]=n[s]+r[0],km[1]=n[s+1]+r[1],km[2]=n[s+2]+r[2],i.worldUpAtPosition(km,km),function(e,t){let i=null;const r=e.vertices.length,n=.99619469809,s=(0,I.vt)(),a=(0,I.vt)(),o=(0,I.vt)(),l=(0,I.vt)(),c=(0,I.vt)(),d=(0,I.vt)(),h=(0,gr.vt)();let u=e.vertices[0];(0,M.c)(a,t),(0,M.s)(s,0,1,0),Jr(u.vRight,a,s,s,o,a,n),(0,M.c)(u.frame.up,a),(0,M.c)(u.frame.right,o);const p=e.positions;let f=e.offset;i=u;for(let g=1;g<r;++g){u=e.vertices[g],(0,M.g)(c,u.vLeft,u.vRight);let t=(0,M.l)(c);t>0?(t=1/Math.sqrt(t),c[0]=c[0]*t,c[1]=c[1]*t,c[2]=c[2]*t):(c[0]=u.vRight[0],c[1]=u.vRight[1],c[2]=u.vRight[2]),d[0]=p[f]+i.frame.up[0],d[1]=p[f+1]+i.frame.up[1],d[2]=p[f+2]+i.frame.up[2],f+=3;const r=(0,M.s)(im,p[f],p[f+1],p[f+2]);(0,gr.O_)(r,c,h),(0,gr.Ui)(h,(0,mr.LV)(d,u.vLeft),l)?(l[0]-=p[f],l[1]-=p[f+1],l[2]-=p[f+2],(0,M.n)(a,l),(0,M.b)(o,c,a),(0,M.n)(o,o)):Jr(c,i.frame.up,i.frame.right,s,o,a,n),(0,M.c)(u.frame.up,a),(0,M.c)(u.frame.right,o),i=u}}(e,km)}}function jm(e,t,i){switch(e){case"symbol-value":return i;case"proportional":return t;default:return e}}function Wm(e,t,i,r){let n=0;const{origin:s,vertices:a,positions:o,positionsES:l}=e,c=e.offset+3*a.length;for(let d=e.offset;d<c;d+=3)(0,M.s)(km,l[d],l[d+1],l[d+2]),i(km,Zm),n+=Zm.sampledElevation,km[0]=o[d]+s[0],km[1]=o[d+1]+s[1],km[2]=o[d+2]+s[2],r.setAltitude(km,Zm.z),o[d]=km[0]-s[0],o[d+1]=km[1]-s[1],o[d+2]=km[2]-s[2];return e.updatePathVertexInformation(),n/a.length}const km=(0,I.vt)(),Zm=new Ut;function qm(e,t,i,r){let n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1;(0,M.s)(Xm,1,0,0),(0,M.s)($m,0,1,0),(0,M.s)(Km,0,0,1),function(e,t){(0,M.s)(c_,0,0,0);for(let i=0;i<t.length-3;i+=3)c_[0]+=t[i],c_[1]+=t[i+1],c_[2]+=t[i+2];(0,M.h)(e,c_,1/(t.length/3-1))}(Qm,i),(0,gr.ci)(Ym,i)&&function(e,t,i,r,n,s){null!=n?(n.basisMatrixAtPosition(s,s_),(0,M.s)(a_,s_[0],s_[1],s_[2]),(0,M.s)(o_,s_[4],s_[5],s_[6]),(0,M.s)(l_,s_[8],s_[9],s_[10])):((0,M.s)(a_,1,0,0),(0,M.s)(o_,0,1,0),(0,M.s)(l_,0,0,1));const a=(0,gr.Qj)(e);(0,M.j)(a,l_)<0&&(0,M.h)(a,a,-1),(0,M.c)(r,a);const o=(0,M.j)(a,o_),l=(0,M.j)(a,a_);Math.abs(o)>Math.abs(l)?((0,M.q)(t,a_,a,-l),(0,M.n)(t,t),(0,M.b)(i,t,a),(0,M.n)(i,i),(0,M.h)(i,i,-1)):((0,M.q)(i,o_,a,-o),(0,M.n)(i,i),(0,M.b)(t,i,a),(0,M.n)(t,t))}(Ym,Xm,$m,Km,r,Qm),(0,Sa.hZ)(e_,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),(0,Sa.hZ)(t_,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY);for(let d=0;d<i.length;d+=3){(0,M.s)(Jm,i[d],i[d+1],i[d+2]);const e=(0,M.j)(Xm,Jm),t=(0,M.j)($m,Jm);e_[0]=Math.min(e_[0],e),e_[1]=Math.min(e_[1],t),t_[0]=Math.max(t_[0],e),t_[1]=Math.max(t_[1],t)}const s=(0,M.j)(Km,Qm);d_(i_,e_[0],e_[1],s,Xm,$m,Km),d_(r_,t_[0],e_[1],s,Xm,$m,Km),d_(n_,e_[0],t_[1],s,Xm,$m,Km),(0,M.f)(r_,r_,i_),(0,M.h)(r_,r_,.5),(0,M.f)(n_,n_,i_),(0,M.h)(n_,n_,.5),(0,M.g)(i_,i_,r_),(0,M.g)(i_,i_,n_);const a=e_[0]%n,o=e_[1]%n,l=e_[0]-a,c=e_[1]-o;for(let d=0;d<i.length;d+=3){(0,M.s)(Jm,i[d],i[d+1],i[d+2]);const r=d/3,s=4*r;e[s]=((0,M.j)(Xm,Jm)-l)/n,e[s+1]=((0,M.j)($m,Jm)-c)/n,e[s+2]=l/n,e[s+3]=c/n;const a=9*r;for(let e=0;e<3;e++)t[a+e]=i_[e],t[a+e+3]=r_[e],t[a+e+6]=n_[e]}}const Qm=(0,I.vt)(),Jm=(0,I.vt)(),Ym=(0,gr.vt)(),Xm=(0,I.vt)(),$m=(0,I.vt)(),Km=(0,I.vt)(),e_=(0,pr.vt)(),t_=(0,pr.vt)(),i_=(0,I.vt)(),r_=(0,I.vt)(),n_=(0,I.vt)();const s_=(0,P.vt)(),a_=(0,I.vt)(),o_=(0,I.vt)(),l_=(0,I.vt)();const c_=(0,I.vt)();function d_(e,t,i,r,n,s,a){(0,M.s)(e,t*n[0]+i*s[0]+r*a[0],t*n[1]+i*s[1]+r*a[1],t*n[2]+i*s[2]+r*a[2])}class h_ extends qs.im{intersect(e,t,i,r,n,s){return(0,_u.Uy)(e,i,r,n,void 0,s)}}var u_=i(37923);To.S;class p_ extends Xs.w{initializeProgram(e){return new Ks.B(e.rctx,p_.shader.get().build(this.configuration),$s.D)}_createPipeline(e,t){const i=this.configuration,r=e===Lo.y.NONE,n=e===Lo.y.FrontFace;return(0,ta.Ey)({blending:i.output!==ks.V.Color&&i.output!==ks.V.Alpha||!i.transparent?null:r?Io.V0:(0,Io.ez)(e),culling:(0,ta.Xt)(i.cullFace),depthTest:i.draped?null:{func:(0,Io.K_)(e)},depthWrite:i.draped?null:(r||n)&&i.writeDepth?ta.kn:null,colorWrite:ta.wE,stencilWrite:i.hasOccludees?Do.v0:null,stencilTest:i.hasOccludees?t?Do.a9:Do.qh:null,polygonOffset:r||n?i.polygonOffset?f_:null:(0,Io.aB)(i.enableOffset)})}initializePipeline(){return this._occludeePipelineState=this._createPipeline(this.configuration.transparencyPassType,!0),this._createPipeline(this.configuration.transparencyPassType,!1)}getPipeline(e){return e?this._occludeePipelineState:super.getPipeline()}}p_.shader=new Ys.$(u_.C,(()=>i.e(5837).then(i.bind(i,35837))));const f_={factor:1,units:1};class g_ extends na.E{constructor(){super(...arguments),this.output=ks.V.Color,this.cullFace=fe.s2.None,this.transparencyPassType=Lo.y.NONE,this.hasSlicePlane=!1,this.hasVertexColors=!1,this.transparent=!1,this.polygonOffset=!1,this.enableOffset=!0,this.writeDepth=!0,this.hasOccludees=!1,this.multipassEnabled=!1,this.cullAboveGround=!1,this.objectAndLayerIdColorInstanced=!1,this.vvColor=!1,this.draped=!1}}(0,r._)([(0,ra.W)({count:ks.V.COUNT})],g_.prototype,"output",void 0),(0,r._)([(0,ra.W)({count:fe.s2.COUNT})],g_.prototype,"cullFace",void 0),(0,r._)([(0,ra.W)({count:Lo.y.COUNT})],g_.prototype,"transparencyPassType",void 0),(0,r._)([(0,ra.W)()],g_.prototype,"hasSlicePlane",void 0),(0,r._)([(0,ra.W)()],g_.prototype,"hasVertexColors",void 0),(0,r._)([(0,ra.W)()],g_.prototype,"transparent",void 0),(0,r._)([(0,ra.W)()],g_.prototype,"polygonOffset",void 0),(0,r._)([(0,ra.W)()],g_.prototype,"enableOffset",void 0),(0,r._)([(0,ra.W)()],g_.prototype,"writeDepth",void 0),(0,r._)([(0,ra.W)()],g_.prototype,"hasOccludees",void 0),(0,r._)([(0,ra.W)()],g_.prototype,"multipassEnabled",void 0),(0,r._)([(0,ra.W)()],g_.prototype,"cullAboveGround",void 0),(0,r._)([(0,ra.W)()],g_.prototype,"objectAndLayerIdColorInstanced",void 0),(0,r._)([(0,ra.W)()],g_.prototype,"vvColor",void 0),(0,r._)([(0,ra.W)()],g_.prototype,"draped",void 0),(0,r._)([(0,ra.W)({constValue:!1})],g_.prototype,"occlusionPass",void 0),(0,r._)([(0,ra.W)({constValue:!0})],g_.prototype,"hasVvInstancing",void 0),(0,r._)([(0,ra.W)({constValue:!1})],g_.prototype,"vvSize",void 0),(0,r._)([(0,ra.W)({constValue:!1})],g_.prototype,"vvOpacity",void 0);class m_ extends h_{constructor(e){super(e,new v_),this.supportsEdges=!0,this.produces=new Map([[Qs.N.OPAQUE_MATERIAL,e=>e===ks.V.Highlight||(0,ks.BF)(e)&&!this._isTransparent],[Qs.N.OPAQUE_NO_SSAO_DEPTH,e=>e===ks.V.LinearDepth&&this.parameters.writeLinearDepth&&!this._isTransparent],[Qs.N.TRANSPARENT_MATERIAL,e=>(0,ks.BF)(e)&&this._isTransparent&&this.parameters.writeDepth],[Qs.N.TRANSPARENT_NO_SSAO_DEPTH,e=>e===ks.V.LinearDepth&&this.parameters.writeLinearDepth&&this._isTransparent&&this.parameters.writeDepth],[Qs.N.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL,e=>((0,ks.BF)(e)||e===ks.V.LinearDepth&&this.parameters.writeLinearDepth)&&this._isTransparent&&!this.parameters.writeDepth],[Qs.N.DRAPED_MATERIAL,e=>(0,ks.i3)(e)]]),this._configuration=new g_}getConfiguration(e,t){return this._configuration.output=e,this._configuration.cullFace=this.parameters.cullFace,this._configuration.hasVertexColors=this.parameters.hasVertexColors&&!this.parameters.vvColor,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.transparent=this._isTransparent,this._configuration.polygonOffset=this.parameters.polygonOffset,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.hasOccludees=this.parameters.hasOccludees,this._configuration.transparencyPassType=t.transparencyPassType,this._configuration.enableOffset=t.camera.relativeElevation<Io.xt,this._configuration.multipassEnabled=t.multipassEnabled,this._configuration.cullAboveGround=t.multipassTerrain.cullAboveGround,this._configuration.vvColor=!!this.parameters.vvColor,this._configuration.draped=this.parameters.draped,this._configuration}createGLMaterial(e){return new __(e)}createBufferWriter(){const e=(0,Ws.BP)().vec3f(Pt.r.POSITION);return(0,h.A)("enable-feature:objectAndLayerId-rendering")&&e.vec4u8(Pt.r.OBJECTANDLAYERIDCOLOR),this.parameters.vvColor?e.f32(Pt.r.COLORFEATUREATTRIBUTE):e.vec4u8(Pt.r.COLOR),new Qp.Z(e)}get _isTransparent(){return this.parameters.color[3]<1||this.parameters.forceTransparentMode}}class __ extends Zs.A{_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})}beginSlot(e){return this._output!==ks.V.Color&&this._output!==ks.V.Alpha||this._updateOccludeeState(e),this.ensureTechnique(p_,e)}}class v_ extends To.S{constructor(){super(...arguments),this.color=L.uY,this.forceTransparentMode=!1,this.writeDepth=!0,this.writeLinearDepth=!1,this.hasVertexColors=!1,this.polygonOffset=!1,this.hasSlicePlane=!1,this.cullFace=fe.s2.None,this.hasOccludees=!1,this.draped=!1}}var y_=i(30250),b_=i(58071);class x_ extends Xs.w{initializeProgram(e){return new Ks.B(e.rctx,x_.shader.get().build(this.configuration),(0,h.A)("enable-feature:objectAndLayerId-rendering")?A_:C_)}_setPipelineState(e,t){const i=this.configuration,r=e===Lo.y.NONE,n=e===Lo.y.FrontFace;return(0,ta.Ey)({blending:i.output===ks.V.Color||i.output===ks.V.Alpha?r?Io.V0:(0,Io.ez)(e):null,culling:(0,ta.Xt)(i.cullFace),depthTest:i.draped?null:{func:(0,Io.K_)(e)},depthWrite:i.draped?null:r?ta.kn:(0,Io.XO)(e),colorWrite:ta.wE,stencilWrite:i.hasOccludees?Do.v0:null,stencilTest:i.hasOccludees?t?Do.a9:Do.qh:null,polygonOffset:r||n?i.polygonOffset?S_:null:(0,Io.aB)(i.enableOffset)})}initializePipeline(){return this._occludeePipelineState=this._setPipelineState(this.configuration.transparencyPassType,!0),this._setPipelineState(this.configuration.transparencyPassType,!1)}getPipeline(e){return e?this._occludeePipelineState:super.getPipeline()}}x_.shader=new Ys.$(b_.P,(()=>i.e(1109).then(i.bind(i,71109))));const S_={factor:1,units:1};class w_ extends na.E{constructor(){super(...arguments),this.output=ks.V.Color,this.cullFace=fe.s2.None,this.transparencyPassType=Lo.y.NONE,this.hasSlicePlane=!1,this.hasVertexColors=!1,this.polygonOffset=!1,this.hasOccludees=!1,this.enableOffset=!0,this.multipassEnabled=!1,this.cullAboveGround=!1,this.vvColor=!1,this.objectAndLayerIdColorInstanced=!1}}(0,r._)([(0,ra.W)({count:ks.V.COUNT})],w_.prototype,"output",void 0),(0,r._)([(0,ra.W)({count:fe.s2.COUNT})],w_.prototype,"cullFace",void 0),(0,r._)([(0,ra.W)({count:y_.O.COUNT})],w_.prototype,"style",void 0),(0,r._)([(0,ra.W)({count:Lo.y.COUNT})],w_.prototype,"transparencyPassType",void 0),(0,r._)([(0,ra.W)()],w_.prototype,"hasSlicePlane",void 0),(0,r._)([(0,ra.W)()],w_.prototype,"hasVertexColors",void 0),(0,r._)([(0,ra.W)()],w_.prototype,"polygonOffset",void 0),(0,r._)([(0,ra.W)()],w_.prototype,"hasOccludees",void 0),(0,r._)([(0,ra.W)()],w_.prototype,"patternSpacing",void 0),(0,r._)([(0,ra.W)()],w_.prototype,"lineWidth",void 0),(0,r._)([(0,ra.W)()],w_.prototype,"enableOffset",void 0),(0,r._)([(0,ra.W)()],w_.prototype,"draped",void 0),(0,r._)([(0,ra.W)()],w_.prototype,"multipassEnabled",void 0),(0,r._)([(0,ra.W)()],w_.prototype,"cullAboveGround",void 0),(0,r._)([(0,ra.W)()],w_.prototype,"vvColor",void 0),(0,r._)([(0,ra.W)({constValue:!0})],w_.prototype,"writeDepth",void 0),(0,r._)([(0,ra.W)({constValue:!1})],w_.prototype,"occlusionPass",void 0),(0,r._)([(0,ra.W)({constValue:!1})],w_.prototype,"hasVvInstancing",void 0),(0,r._)([(0,ra.W)({constValue:!1})],w_.prototype,"vvSize",void 0),(0,r._)([(0,ra.W)({constValue:!1})],w_.prototype,"vvOpacity",void 0);const C_=new Map([[Pt.r.POSITION,0],[Pt.r.COLOR,3],[Pt.r.UVMAPSPACE,4],[Pt.r.COLORFEATUREATTRIBUTE,5],[Pt.r.BOUNDINGRECT,6]]),A_=new Map([[Pt.r.POSITION,0],[Pt.r.COLOR,3],[Pt.r.UVMAPSPACE,4],[Pt.r.COLORFEATUREATTRIBUTE,5],[Pt.r.BOUNDINGRECT,6],[Pt.r.OBJECTANDLAYERIDCOLOR,9]]);class R_ extends h_{constructor(e){super(e,new T_),this.supportsEdges=!0,this.produces=new Map([[Qs.N.OPAQUE_MATERIAL,e=>(0,ks.u5)(e)],[Qs.N.TRANSPARENT_MATERIAL,e=>(0,ks.j8)(e)],[Qs.N.TRANSPARENT_NO_SSAO_DEPTH,e=>e===ks.V.LinearDepth&&this.parameters.writeLinearDepth],[Qs.N.DRAPED_MATERIAL,e=>this.parameters.draped&&e===ks.V.Color||(0,ks.u5)(e)]]),this._vertexAttributeLocations=(0,h.A)("enable-feature:objectAndLayerId-rendering")?A_:C_,this._configuration=new w_}getConfiguration(e,t){return this._configuration.output=e,this._configuration.cullFace=this.parameters.cullFace,this._configuration.hasVertexColors=this.parameters.hasVertexColors&&!this.parameters.vvColor,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.polygonOffset=this.parameters.polygonOffset,this._configuration.style=this.parameters.style,this._configuration.patternSpacing=this.parameters.patternSpacing,this._configuration.lineWidth=this.parameters.lineWidth,this._configuration.draped=this.parameters.draped,this._configuration.transparencyPassType=t.transparencyPassType,this._configuration.enableOffset=t.camera.relativeElevation<Io.xt,this._configuration.multipassEnabled=t.multipassEnabled,this._configuration.cullAboveGround=t.multipassTerrain.cullAboveGround,this._configuration.vvColor=!!this.parameters.vvColor,this._configuration}createGLMaterial(e){return new E_(e)}createBufferWriter(){const e=(0,Ws.BP)().vec3f(Pt.r.POSITION).vec4f(Pt.r.UVMAPSPACE);return this.parameters.draped||e.mat3f(Pt.r.BOUNDINGRECT),this.parameters.vvColor?e.f32(Pt.r.COLORFEATUREATTRIBUTE):e.vec4u8(Pt.r.COLOR),(0,h.A)("enable-feature:objectAndLayerId-rendering")&&e.vec4u8(Pt.r.OBJECTANDLAYERIDCOLOR),new O_(e)}}class E_ extends Zs.A{_updateParameters(e){return this.ensureTechnique(x_,e)}_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})}beginSlot(e){return this._output!==ks.V.Color&&this._output!==ks.V.Alpha||this._updateOccludeeState(e),this._updateParameters(e)}}class O_ extends Qp.Z{write(e,t,i,r,n){(0,Js.SA)(i,this.vertexBufferLayout,e,t,r,n);for(const s of this.vertexBufferLayout.fields.keys()){const t=i.attributes.get(s),a=null===t||void 0===t?void 0:t.indices;if(t&&a)switch(s){case Pt.r.UVMAPSPACE:{(0,br.vA)(4===t.size);const e=r.getField(s,uu.Eq);e&&(0,Js.Ut)(t,e,n);break}case Pt.r.BOUNDINGRECT:{(0,br.vA)(9===t.size);const i=r.getField(s,uu.jZ);i&&this.writeBoundingRect(t,e,i,n);break}}}}writeBoundingRect(e,t,i,r){const{data:n,indices:s}=e,a=t,o=i.typedBuffer,l=i.typedBufferStride,c=s.length;r*=l;for(let d=0;d<c;++d){const e=9*s[d],t=n[e],i=n[e+1],c=n[e+2];o[r]=a[0]*t+a[4]*i+a[8]*c+a[12],o[r+1]=a[1]*t+a[5]*i+a[9]*c+a[13],o[r+2]=a[2]*t+a[6]*i+a[10]*c+a[14];for(let s=3;s<9;++s)o[r+s]=n[e+s];r+=l}}}class T_ extends To.S{constructor(){super(...arguments),this.color=(0,L.fA)(1,1,1,1),this.writeLinearDepth=!1,this.hasVertexColors=!1,this.polygonOffset=!1,this.hasSlicePlane=!1,this.cullFace=fe.s2.None,this.hasOccludees=!1,this.style=y_.O.Cross,this.patternSpacing=10,this.lineWidth=1,this.draped=!0}}function P_(e,t){var i;const r=null!==(i=null===e||void 0===e?void 0:e.pattern)&&void 0!==i?i:null;return null==r?new m_(t):"none"===r.style||"solid"===r.style?("none"===r.style&&(t.color=(0,L.fA)(0,0,0,0),t.forceTransparentMode=!0),new m_(t)):(t.style=function(e){switch(e){case"horizontal":return y_.O.Horizontal;case"vertical":return y_.O.Vertical;case"cross":return y_.O.Cross;case"forward-diagonal":return y_.O.ForwardDiagonal;case"backward-diagonal":return y_.O.BackwardDiagonal;case"diagonal-cross":return y_.O.DiagonalCross;default:return}}(r.style),new R_(t))}function M_(e,t){if(function(e){return e.material instanceof R_&&!e.material.parameters.draped}(e)){const i=e.attributes.get(Pt.r.POSITION).data;qm(e.getMutableAttribute(Pt.r.UVMAPSPACE).data,e.getMutableAttribute(Pt.r.BOUNDINGRECT).data,i,t)}}function I_(e,t,i,r,n){const s=Vn(e,t,i,r,n),a=e.stageObject.geometries;for(const o of a)M_(o,n);return s}const D_=["polyline","polygon","extent"],L_=new vs.wI({size:!1,color:!0,rotation:!1,opacity:!1});class F_ extends bs{constructor(e,t,i,r){super(e,t,i,r),this._needsUV=!1}async doLoad(){this._fastUpdates=(0,vs.s_)(this._context.renderer,L_)}_createMaterials(){var e,t;if(this._materials.length>0)return;const i=null===(e=this.symbolLayer)||void 0===e||null===(e=e.material)||void 0===e?void 0:e.color,r=this._getCombinedOpacityAndColor(i);this._materials[U_.Fill]=P_(this.symbolLayer,{color:r,forceTransparentMode:this.needsDrivenTransparentPass,polygonOffset:!1,hasVertexColors:!0,writeLinearDepth:!0,draped:this.draped,hasSlicePlane:this._context.slicePlaneEnabled,...null===(t=this._fastUpdates)||void 0===t?void 0:t.materialParameters}),this._needsUV=this._materials[U_.Fill]instanceof R_;const n=this.symbolLayer.outline;if(this._isValidOutline(n)){const e=bp(n.pattern);this._materials[U_.Outline]=new zo({width:(0,Ln.Lz)(n.size),color:this._getOutlineColor(),hasPolygonOffset:!0,hasSlicePlane:this._context.slicePlaneEnabled,isClosed:!0,stipplePattern:e,cap:ip(n.patternCap||"butt")})}this._context.stage.addMany(this._materials)}_isValidOutline(e){return null!=(null===e||void 0===e?void 0:e.size)&&e.size>0&&null!=e.color&&(null==e.pattern||"style"!==e.pattern.type||"none"!==e.pattern.style)}destroy(){super.destroy(),this._context.stage.removeMany(this._materials),this._materials.length=0}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,D_,this.symbolLayer.type))return null;const i=this._getVertexOpacityAndColor(e.renderingInfo,255),r=this.setGraphicElevationContext(t);return this.ensureDrapedStatus("on-the-ground"===r.mode),this._createMaterials(),this.draped?this._createAsOverlay(t,i):this._createAs3DShape(t,i,r)}applyRendererDiff(e,t){for(const r in e.diff){var i;if("visualVariables"!==r)return gs.RecreateSymbol;if(!(0,vs.J_)(this._fastUpdates,t,L_))return gs.RecreateSymbol;null===(i=this._materials[U_.Fill])||void 0===i||i.setParameters(this._fastUpdates.materialParameters)}return gs.FastUpdate}layerOpacityChanged(){if(null!=this._materials[U_.Fill]){var e;const t=this._materials[U_.Fill].parameters.color,i=null===(e=this.symbolLayer)||void 0===e||null===(e=e.material)||void 0===e?void 0:e.color,r=this._getCombinedOpacity(i);this._materials[U_.Fill].setParameters({color:[t[0],t[1],t[2],r],forceTransparentMode:this.needsDrivenTransparentPass})}if(null!=this._materials[U_.Outline]){const e=this._materials[U_.Outline].parameters.color;this._materials[U_.Outline].setParameters({color:[e[0],e[1],e[2],this._getOutlineOpacity()]})}}layerElevationInfoChanged(e,t,i){const r=this._elevationContext.mode,n=Lt(F_.elevationModeChangeTypes,i,r);if(n!==Tt.UPDATE)return n;const s=Ft(r);return this.updateGraphics3DGraphicElevationInfo(e,t,(()=>s))}slicePlaneEnabledChanged(){var e;if(null!==(e=this._materials[U_.Fill])&&void 0!==e&&e.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),this._materials[U_.Outline]){const e={hasSlicePlane:this._context.slicePlaneEnabled};this._materials[U_.Outline].setParameters(e)}return!0}physicalBasedRenderingChanged(){return!0}_createAs3DShape(e,t,i){var r;const n=(0,Va.dE)(e.geometry);if(!n)return null;const s=Xd(n,this._context.elevationProvider,this._context.renderCoordsHelper,i),a=new V_(s,t,this._context.layer.uid,e.uid),o=a.renderData.position.length/3;if(this._needsUV&&(a.uvMapSpace=(0,Y.oe)(4*o,!0),a.boundingRect=(0,J.jh)(9*o,!0),qm(a.uvMapSpace,a.boundingRect,a.renderData.position,this._context.renderCoordsHelper)),a.objectAndLayerIdColor=null===(r=this._context.stage.renderView)||void 0===r?void 0:r.getObjectAndLayerIdColor(a),this._createAs3DShapeFill(e,a),this._materials[U_.Outline]&&this._createAs3DShapeOutline(a),this._logGeometryCreationWarnings(a.renderData,n.rings,"rings","FillSymbol3DLayer"),0===a.outGeometries.length)return null;const l=new Ps({geometries:a.outGeometries,castShadow:!1,layerUid:this._context.layer.uid,graphicUid:e.uid}),c=new ls(this,l,a.outGeometries,null,null,I_,i);return c.alignedSampledElevation=a.renderData.sampledElevation,c.needsElevationUpdates=Ft(i.mode),c}_createAs3DShapeFill(e,t){const i=t.renderData.polygons;for(const{position:n,mapPositions:s,holeIndices:a,index:o,count:l}of i){var r;if(null!=this._context.clippingExtent&&((0,q.Ie)(N_),(0,q.Hq)(N_,s),!(0,q.KG)(N_,this._context.clippingExtent)))continue;const i=(0,Va.v7)(s,a,this._context.elevationProvider.spatialReference);if(0===i.length)continue;const c=null===(r=this._fastUpdates)||void 0===r?void 0:r.visualVariables.color,d=(0,Va.a4)({material:this._materials[U_.Fill],indices:i,mapPositions:s,attributeData:{position:n,color:c?null:t.color,colorFeature:c?(0,vs.ul)(c.field,e):null,uvMapSpace:this._needsUV?(0,Y.AK)(t.uvMapSpace,4*o,4*l):null,boundingRect:this._needsUV?(0,J.l5)(t.boundingRect,9*o,9*l):null,objectAndLayerIdColor:t.objectAndLayerIdColor}});t.outGeometries.push(d)}}_createAs3DShapeOutline(e){if(null==this._materials[U_.Outline])return;const t=e.renderData.outlines;for(const{mapPositions:i,position:r}of t){if(null!=this._context.clippingExtent&&((0,q.Ie)(N_),(0,q.Hq)(N_,i),!(0,q.KG)(N_,this._context.clippingExtent)))continue;const t=np(this._materials[U_.Outline],{overlayInfo:null,removeDuplicateStartEnd:!0,mapPositions:i,attributeData:{position:r}},e.objectAndLayerIdColor);e.outGeometries.push(t)}}_createAsOverlay(e,t){var i;const r=(0,Va.dE)(e.geometry);if(null==r)return null;this._materials[U_.Fill].renderPriority=this._renderPriority+this._renderPriorityStep/2,null!=this._materials[U_.Outline]&&(this._materials[U_.Outline].renderPriority=this._renderPriority);const n=$d(r,this._context.overlaySR),s=new G_(n,t,this._context.layer.uid,e.uid),a=s.renderData.position.length/3;return this._needsUV&&(s.uvMapSpace=(0,Y.oe)(4*a,!0),function(e,t,i,r){let n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1;if(i.isGeographic&&r===ae.RT.Global){const e=(0,J.jh)(t.length),r=t.length,n=(0,xt.tO)(i);for(let i=0;i<r;i+=3)(0,N.RC)(t,i,e,i,n);t=e}(0,Sa.hZ)(e_,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY);for(let c=0;c<t.length;c+=3)e_[0]=Math.min(e_[0],t[c]),e_[1]=Math.min(e_[1],t[c+1]);const s=e_[0]%n,a=e_[1]%n,o=e_[0]-s,l=e_[1]-a;for(let c=0;c<t.length;c+=3){const i=c/3*4;e[i]=(t[c]-o)/n,e[i+1]=(t[c+1]-l)/n,e[i+2]=o/n,e[i+3]=l/n}}(s.uvMapSpace,s.renderData.position,this._context.overlaySR,this._context.graphicsCoreOwner.view.state.viewingMode)),s.outBoundingBox=(0,q.Ie)(),s.objectAndLayerIdColor=null===(i=this._context.stage.renderView)||void 0===i?void 0:i.getObjectAndLayerIdColor(s),this._createAsOverlayFill(e,s),this._materials[U_.Outline]&&this._createAsOverlayOutline(s),this._logGeometryCreationWarnings(s.renderData,r.rings,"rings","FillSymbol3DLayer"),0===s.outGeometries.length?null:new zh(this,s.outGeometries,s.outBoundingBox,this._context.drapeSourceRenderer)}_createAsOverlayFill(e,t){const i=t.renderData.polygons;for(const{position:n,holeIndices:s,index:a,count:o}of i){var r;const i=(0,q.Ie)(N_);if((0,q.Hq)(i,n),!(0,q.KG)(i,this._context.clippingExtent))continue;const l=(0,Oa.e)(n,s,3);if(0===l.length)continue;(0,q.RF)(t.outBoundingBox,i);const c=null===(r=this._fastUpdates)||void 0===r?void 0:r.visualVariables.color,d=(0,Va.a4)({material:this._materials[U_.Fill],indices:l,attributeData:{position:n,color:c?null:t.color,colorFeature:c?(0,vs.ul)(c.field,e):null,uvMapSpace:this._needsUV?(0,Y.AK)(t.uvMapSpace,4*a,4*o):null,objectAndLayerIdColor:t.objectAndLayerIdColor}});t.outGeometries.push(new du(d,t))}}_createAsOverlayOutline(e){if(null==this._materials[U_.Outline])return;const t=e.renderData.outlines;for(let i=0;i<t.length;++i){const{position:r}=t[i];if((0,q.Ie)(N_),(0,q.Hq)(N_,r),!(0,q.KG)(N_,this._context.clippingExtent))continue;(0,q.RF)(e.outBoundingBox,N_);const n=np(this._materials[U_.Outline],{overlayInfo:{spatialReference:this._context.overlaySR,renderCoordsHelper:this._context.renderCoordsHelper},removeDuplicateStartEnd:!0,attributeData:{position:r}},e.objectAndLayerIdColor);e.outGeometries.push(new du(n,e))}}_getOutlineOpacity(){var e;const t=null===(e=this.symbolLayer)||void 0===e||null===(e=e.outline)||void 0===e?void 0:e.color;return(this.draped?1:this._getLayerOpacity())*(null!=t?t.a:0)}_getOutlineColor(){var e;const t=null===(e=this.symbolLayer)||void 0===e||null===(e=e.outline)||void 0===e?void 0:e.color,i=this._getOutlineOpacity();return ts(null!=t?v.A.toUnitRGB(t):null,i)}test(){return{...super.test(),createAsOverlay:(e,t)=>this._createAsOverlay(e,t),createAs3DShape:(e,t,i)=>this._createAs3DShape(e,t,i)}}}F_.elevationModeChangeTypes={definedChanged:Tt.RECREATE,staysOnTheGround:Tt.NONE,onTheGroundChanged:Tt.RECREATE};const N_=(0,q.vt)();class V_ extends Va.JQ{constructor(e,t,i,r){super(e,i,r),this.color=t}}class G_ extends Va.JQ{constructor(e,t,i,r){super(e,i,r),this.color=t}}var U_;!function(e){e[e.Fill=0]="Fill",e[e.Outline=1]="Outline"}(U_||(U_={}));class z_{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"center",i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:(0,pr.vt)(),n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:(0,L.fA)(0,0,0,-1),s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:"world",a=arguments.length>6&&void 0!==arguments[6]?arguments[6]:(0,I.vt)(),o=arguments.length>7&&void 0!==arguments[7]?arguments[7]:0;this.verticalOffset=e,this.anchor=t,this.hasLabelVerticalOffset=i,this.screenOffset=r,this.centerOffset=n,this.centerOffsetUnits=s,this.translation=a,this.elevationOffset=o}}class B_{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"center",i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"center",r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:(0,pr.vt)();this.placement=e,this.horizontalPlacement=t,this.verticalPlacement=i,this.text=r,this.displaySize=n}}var H_=i(85504);class j_{constructor(e){this.definition=e,this.key=JSON.stringify(e),this.haloSize=Math.round(e.halo.size),this.textStyle=this._colorToRGBA(e.color),this.haloStyle=this._colorToRGB(e.halo.color),this.backgroundStyle=0!==e.background.color[3]?this._colorToRGBA(e.background.color):null}fontString(e){const t=this.definition.font;return"".concat(t.style," ").concat(t.weight," ").concat(e,"px ").concat(t.family,", ").concat("sans-serif, Apple Color Emoji, Segoe UI Emoji, Segoe UI Symbol, Noto Color Emoji")}setFontProperties(e,t){e.font=this.fontString(t),e.textAlign="left",e.textBaseline="alphabetic"}_colorToRGB(e){return"rgb(".concat(e.slice(0,3).map((e=>Math.floor(255*e))).toString(),")")}_colorToRGBA(e){return"rgba(".concat(e.slice(0,3).map((e=>Math.floor(255*e))).toString(),",").concat(e[3],")")}static async fromSymbol(e,t){var i,r,n,s,o,l,c,d,h,u;const p=null===e||void 0===e||null===(i=e.material)||void 0===i?void 0:i.color,f=null!==(r=v.A.toUnitRGBA(p))&&void 0!==r?r:L.uY,g=null!=e.size?(0,Ln.Lz)(e.size):12,m=e.lineHeight,_=null!=e.background?v.A.toUnitRGBA(e.background.color):L.uY,y={family:null!==(n=null===(s=e.font)||void 0===s?void 0:s.family)&&void 0!==n?n:"sans-serif",decoration:null!==(o=null===(l=e.font)||void 0===l?void 0:l.decoration)&&void 0!==o?o:"none",weight:null!==(c=null===(d=e.font)||void 0===d?void 0:d.weight)&&void 0!==c?c:"normal",style:null!==(h=null===(u=e.font)||void 0===u?void 0:u.style)&&void 0!==h?h:"normal"},b=e.halo,x=null!=(null===b||void 0===b?void 0:b.color)&&b.size>0?{size:(0,Ln.Lz)(b.size),color:v.A.toUnitRGBA(b.color)}:{size:0,color:L.uY},S=new j_({color:f,size:g,background:{color:_,padding:null!=e.background?[.65*g,.5*g]:[0,0],borderRadius:null!=e.background?g*(6/16):0},lineSpacingFactor:m,font:y,halo:x,pixelRatio:t});if(e.font){let t=!1;const i=S.fontString(g);try{t=(await document.fonts.load(i)).some((e=>!(0,H_.NZ)(e)))}catch(w){a.A.getLogger("esri.views.3d.webgl-engine.lib.TextRenderParameters").warnOnce("Failed to preload font '".concat(i,"'. Some text symbology may be rendered using the default browser font."))}if(!t&&!W_.has(e.font.family))try{await(0,H_.Al)(e.font)}catch(w){}}return S}}const W_=new Set(["Arial","Times New Roman","Courier New","serif","sans-serif","monospace","cursive","fantasy","system-ui","ui-serif","ui-sans-serif","ui-monospace","ui-rounded","math","emoji","fangsong"]);var k_=i(22856);const Z_=4096;let q_=class extends s.A{constructor(e){super(e),this.type=vr.X.Texture,this.id=(0,Ni.c)(),this.events=new Cn.A,this._glTexture=null,this._atlas=new $_(256,256),this._needsRepack=!1,this._canRepack=!0,this._elementsToRender=new Map,this._elements=new Map,this._stageObjects=new Map,this.updating=!1}initialize(){this._canvas=document.createElement("canvas"),this._canvas.setAttribute("id","textAtlasCanvas"),this._canvas.setAttribute("style","display:none"),this._ctx=this._canvas.getContext("2d"),this._stage=this.view._stage,this._stage.add(this),this._updateCanvasElementSize(this._atlas),this._reset()}unload(){this._glTexture=(0,le.WD)(this._glTexture),this.updating=!1,this.events.emit("unloaded")}get glTexture(){return this._glTexture}static get maxSize(){return ev=xo?J_:0,[Z_-J_-ev,Z_-J_-ev-Y_]}load(e){if(this._glTexture)return this._glTexture;const t=new Zd.R;return t.wrapMode=ft.pF.CLAMP_TO_EDGE,t.samplingMode=ft.Cj.LINEAR_MIPMAP_LINEAR,t.hasMipmap=!0,t.preMultiplyAlpha=!0,t.maxAnisotropy=e.parameters.maxMaxAnisotropy,this._glTexture=new Rl.g(e,t,this._canvas),this._frameWorker=this.view.resourceController.scheduler.registerTask(Ae.W6.TEXT_TEXTURE_ATLAS,this),this.setDirty(),this._glTexture}dispose(){this._elements.clear(),this._elementsToRender.clear(),this._frameWorker=(0,le.xt)(this._frameWorker),this._glTexture&&(this._stage.remove(this),this._glTexture=(0,le.WD)(this._glTexture)),this._canvas.width=0,this._canvas.height=0,this._canvas=null,this._ctx=null}_updateCanvasElementSize(e){this._canvas.setAttribute("width",e.width.toString()),this._canvas.setAttribute("height",e.height.toString())}_resizeAtlas(e,t){var i,r;const{width:n,height:s}=this._atlas;n===e&&s===t||(this._atlas.width=e,this._atlas.height=t,null!==(i=this._glTexture)&&void 0!==i&&i.resize(e,t),null!==(r=this._glTexture)&&void 0!==r&&r.updateData(0,0,0,n,s,this._canvas),this._updateCanvasElementSize(this._atlas),this._elements.forEach((e=>{const t=this._stageObjects.get(e.textRenderer.key);null===t||void 0===t||t.forEach((t=>Q_(t,e)))})),this._reset())}_reset(){this._elementsToRender.clear(),this._atlas.reset(),this._needsRepack=!0,this.setDirty()}_addAtlasElement(e,t,i,r){const n=this._atlas;if(n.width<i||n.height<r)return!1;let s=n.cursors.get(r);if(!s){if(n.height<n.nextY+r)return!1;s=[new K_(n.nextY)],n.cursors.set(r,s),n.nextY+=r}let a=s.find((e=>n.width>=e.x+i));if(null==a){if(n.height<n.nextY+r)return!1;a=new K_(n.nextY),n.nextY+=r,s.push(a)}return e.setNewPosition(a),this._elements.set(t,e),this._elementsToRender.set(t,e),a.x+=i,!0}_ensureStageObjects(e){const t=this._stageObjects.get(e);if(t)return t;const i=new Set;return this._stageObjects.set(e,i),i}_addStageObject(e,t){this._ensureStageObjects(e).add(t)}_removeStageObject(e,t){const i=this._stageObjects.get(e);(null===i||void 0===i?void 0:i.delete(t))&&(t.geometries[0].setAttributeData(Pt.r.SIZE,[0,0]),t.geometryVertexAttributeUpdated(t.geometries[0],Pt.r.SIZE),this._elementsToRender.delete(e))}_processAddition(e){const t=e.textRenderer.key;if(this._needsRepack)return void this._elements.set(t,e);const i=this._atlas,r=e.textRenderer.renderedWidth,n=e.textRenderer.renderedHeight,s=r+J_,a=n+J_+Y_;if(!this._addAtlasElement(e,t,s,a)){if(this._canRepack)this._reset();else if(i.width<s){const e=Math.min((0,ge.Mv)(Math.max(s,1.5*i.width)),Z_);this._resizeAtlas(e,i.height)}else{const e=i.nextY+a,t=Math.min((0,ge.Mv)(Math.max(e,1.5*i.height)),Z_);if(t>i.height)this._resizeAtlas(i.width,t);else if(i.width<Z_){const e=Math.min((0,ge.Mv)(1.5*i.width),Z_);this._resizeAtlas(e,i.height)}}this._elements.set(t,e)}}_renderElement(e){const t=e.commitNewPosition(),i=e.textRenderer;this._ctx.clearRect(t[0]-J_,t[1]-J_,i.renderedWidth+2*J_,i.renderedHeight+2*J_),i.render(this._ctx,t[0],t[1]);const r=this._stageObjects.get(i.key);null===r||void 0===r||r.forEach((t=>Q_(t,e)))}get running(){return this.updating}runTask(e){if(null==this._glTexture)return k_.G;for(;this._needsRepack&&(this._canRepack||this._atlas.height<Z_&&this._atlas.height<Z_);){this._canRepack=this._needsRepack=!1;const t=this._elements;this._elements=new Map,t.forEach((e=>this._processAddition(e))),e.madeProgress()}if(this._elementsToRender.size>0){for(const[t,i]of this._elementsToRender){if(e.done)break;this._renderElement(i),this._elementsToRender.delete(t),e.madeProgress()}this._glTexture.setData(this._canvas)}this.updating=this._elementsToRender.size>0}addTextTexture(e,t){const i=e.key;this._addStageObject(i,t);let r=this._elements.get(i);null==r&&(r=new X_(this._atlas,e),this._processAddition(r),this.setDirty()),function(e,t){e.geometries[0].setAttributeData(Pt.r.SIZE,[t.textRenderer.displayWidth,t.textRenderer.displayHeight]),e.geometryVertexAttributeUpdated(e.geometries[0],Pt.r.SIZE)}(t,r),Q_(t,r)}removeTextTexture(e,t){const i=e.key;if(!this._elements.get(i))return;this._removeStageObject(i,t);const r=this._stageObjects.get(i);r&&0!==r.size||this._elements.delete(i),0===(null===r||void 0===r?void 0:r.size)&&this._stageObjects.delete(i),this._canRepack=!0}setDirty(){this._glTexture&&(this.updating=!0)}get test(){const{_elements:e,_stageObjects:t,_atlas:i}=this,r=this;return{elements:e,stageObjects:t,atlas:i,resizeAtlas:(e,t)=>r._resizeAtlas(e,t),run:e=>r.runTask(e)}}};function Q_(e,t){e.geometries[0].setAttributeData(Pt.r.UV0,t.uv),e.geometryVertexAttributeUpdated(e.geometries[0],Pt.r.UV0,!0)}(0,r._)([(0,d.MZ)({constructOnly:!0})],q_.prototype,"view",void 0),(0,r._)([(0,d.MZ)({type:Boolean})],q_.prototype,"updating",void 0),q_=(0,r._)([(0,u.$)("esri.views.3d.webgl-engine.lib.TextTextureAtlas")],q_);const J_=2,Y_=2;class X_{constructor(e,t){this._atlas=e,this.textRenderer=t,this._uv=(0,L.vt)(),this._newPosition=[0,0]}get uv(){if(null==this._xOffset||null==this._yOffset)return L.uY;const{renderedWidth:e,renderedHeight:t}=this.textRenderer;return(0,D.s)(this._uv,this._xOffset/this._atlas.width,(this._yOffset+t)/this._atlas.height,(this._xOffset+e)/this._atlas.width,this._yOffset/this._atlas.height)}setNewPosition(e){this._newPosition[0]=e.x,this._newPosition[1]=e.y}commitNewPosition(){return this._xOffset=this._newPosition[0],this._yOffset=this._newPosition[1],this._newPosition}get xOffset(){return this._xOffset}get yOffset(){return this._yOffset}}class $_{constructor(e,t){this.width=e,this.height=t,this.cursors=new Map,this.nextY=0}reset(){this.cursors.clear(),this.nextY=ev}}class K_{constructor(e){this.y=e,this.x=ev}}let ev=0;class tv{constructor(e,t,i){this._renderer=new Xh(e,t,i,q_.maxSize)}get key(){return this._renderer.key}get baselineAnchorY(){return 1-this._renderer.firstRenderedBaselinePosition/this._renderer.renderedHeight}get displayWidth(){return this._renderer.displayWidth}get displayHeight(){return this._renderer.displayHeight}create(){const e=Wh(iv,this._renderer.renderedWidth,this._renderer.renderedHeight),t=e.getContext("2d");return t.save(),this._renderer.render(t,0,0),t.restore(),new pt.g(e,{wrap:{s:ft.pF.CLAMP_TO_EDGE,t:ft.pF.CLAMP_TO_EDGE},noUnpackFlip:!1,mipmap:!0,preMultiplyAlpha:!0})}}const iv={canvas:null},rv=(0,I.fA)(0,0,1);function nv(e,t,i){e&&e.forEach((e=>{const r=t(e);null!=r&&i(r,e.graphic)}))}const sv={mode:"relative-to-ground",offset:0};var av=i(72085),ov=(i(82884),i(15263));class lv extends Xs.w{initializeConfiguration(e,t){t.spherical=e.viewingMode===ae.RT.Global,t.doublePrecisionRequiresObfuscation=e.rctx.driverTest.doublePrecisionRequiresObfuscation.result}initializeProgram(e){return new Ks.B(e.rctx,lv.shader.get().build(this.configuration),$s.D)}_setPipelineState(e){const t=this.configuration,i=e===Lo.y.NONE,r=e===Lo.y.FrontFace;return(0,ta.Ey)({blending:t.output!==ks.V.Normal&&t.output!==ks.V.Highlight&&t.output!==ks.V.ObjectAndLayerIdColor&&t.transparent?i?Io.V0:(0,Io.ez)(e):null,depthTest:t.draped?null:{func:(0,Io.K_)(e)},depthWrite:t.draped?null:i?t.writeDepth?ta.kn:null:(0,Io.XO)(e),colorWrite:ta.wE,polygonOffset:i||r?null:(0,Io.aB)(t.enableOffset)})}initializePipeline(){return this._setPipelineState(this.configuration.transparencyPassType)}}lv.shader=new Ys.$(ov.W,(()=>i.e(9233).then(i.bind(i,69233))));class cv extends na.E{constructor(){super(...arguments),this.output=ks.V.Color,this.transparencyPassType=Lo.y.NONE,this.spherical=!1,this.receiveShadows=!1,this.hasSlicePlane=!1,this.transparent=!1,this.enableOffset=!0,this.writeDepth=!1,this.hasScreenSpaceReflections=!1,this.doublePrecisionRequiresObfuscation=!1,this.hasCloudsReflections=!1,this.objectAndLayerIdColorInstanced=!1,this.draped=!1,this.multipassEnabled=!1,this.cullAboveGround=!1}}(0,r._)([(0,ra.W)({count:ks.V.COUNT})],cv.prototype,"output",void 0),(0,r._)([(0,ra.W)({count:Lo.y.COUNT})],cv.prototype,"transparencyPassType",void 0),(0,r._)([(0,ra.W)()],cv.prototype,"spherical",void 0),(0,r._)([(0,ra.W)()],cv.prototype,"receiveShadows",void 0),(0,r._)([(0,ra.W)()],cv.prototype,"hasSlicePlane",void 0),(0,r._)([(0,ra.W)()],cv.prototype,"transparent",void 0),(0,r._)([(0,ra.W)()],cv.prototype,"enableOffset",void 0),(0,r._)([(0,ra.W)()],cv.prototype,"writeDepth",void 0),(0,r._)([(0,ra.W)()],cv.prototype,"hasScreenSpaceReflections",void 0),(0,r._)([(0,ra.W)()],cv.prototype,"doublePrecisionRequiresObfuscation",void 0),(0,r._)([(0,ra.W)()],cv.prototype,"hasCloudsReflections",void 0),(0,r._)([(0,ra.W)()],cv.prototype,"objectAndLayerIdColorInstanced",void 0),(0,r._)([(0,ra.W)()],cv.prototype,"draped",void 0),(0,r._)([(0,ra.W)()],cv.prototype,"multipassEnabled",void 0),(0,r._)([(0,ra.W)()],cv.prototype,"cullAboveGround",void 0),(0,r._)([(0,ra.W)({constValue:!1})],cv.prototype,"occlusionPass",void 0),(0,r._)([(0,ra.W)({constValue:$a.A9.Water})],cv.prototype,"pbrMode",void 0),(0,r._)([(0,ra.W)({constValue:!0})],cv.prototype,"useCustomDTRExponentForWater",void 0),(0,r._)([(0,ra.W)({constValue:!0})],cv.prototype,"highStepCount",void 0),(0,r._)([(0,ra.W)({constValue:!1})],cv.prototype,"useFillLights",void 0);class dv extends Zs.A{_updateShadowState(e){e.shadowMap.enabled!==this._material.parameters.receiveShadows&&this._material.setParameters({receiveShadows:e.shadowMap.enabled})}_updateSSRState(e){const t=null!=e.ssr.lastFrameColor;t!==this._material.parameters.hasScreenSpaceReflections&&this._material.setParameters({hasScreenSpaceReflections:t})}_updateCloudsReflectionState(e){const t=null!=e.cloudsFade.data;t!==this._material.parameters.hasCloudsReflections&&this._material.setParameters({hasCloudsReflections:t})}ensureResources(e){return this._techniqueRepository.constructionContext.waterTextureRepository.ensureResources(e)}beginSlot(e){return this._output===ks.V.Color&&(this._updateShadowState(e),this._updateSSRState(e),this._updateCloudsReflectionState(e)),this._material.setParameters(this._techniqueRepository.constructionContext.waterTextureRepository.passParameters),this.ensureTechnique(lv,e)}}class hv extends h_{constructor(e){super(e,new uv),this._configuration=new cv,this._animation=new av.a,this.produces=new Map([[Qs.N.OPAQUE_MATERIAL,e=>(0,ks.j8)(e)&&!this.parameters.transparent||(0,ks.u5)(e)],[Qs.N.TRANSPARENT_MATERIAL,e=>(0,ks.j8)(e)&&this.parameters.transparent||(0,ks.u5)(e)],[Qs.N.DRAPED_MATERIAL,e=>this.parameters.draped&&e===ks.V.Color||(0,ks.u5)(e)],[Qs.N.DRAPED_WATER,e=>e===ks.V.Normal]])}getConfiguration(e,t){return this._configuration.output=e,this._configuration.writeDepth=!0,this._configuration.receiveShadows=this.parameters.receiveShadows,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.transparent=this.parameters.transparent,this._configuration.hasScreenSpaceReflections=this.parameters.hasScreenSpaceReflections,this._configuration.hasCloudsReflections=this.parameters.hasCloudsReflections,this._configuration.draped=this.parameters.draped,this._configuration.transparencyPassType=t.transparencyPassType,this._configuration.enableOffset=t.camera.relativeElevation<Io.xt,this._configuration.multipassEnabled=t.multipassEnabled,this._configuration.cullAboveGround=t.multipassTerrain.cullAboveGround,this._configuration}update(e){const t=Math.min(e.camera.relativeElevation,e.camera.distance);this._animation.enabled=Math.sqrt(this.parameters.waveTextureRepeat/this.parameters.waveStrength)*t<pv;const i=this._animation.advance(e);return this.setParameters({timeElapsed:(0,fl.y)(this._animation.time)*this.parameters.animationSpeed},!1),this._animation.enabled&&i}createGLMaterial(e){return new dv(e)}createBufferWriter(){return new Qp.Z((0,h.A)("enable-feature:objectAndLayerId-rendering")?$p:Yp)}get test(){return{animationEnabled:this._animation.enabled}}}class uv extends qs.qA{constructor(){super(...arguments),this.waveStrength=.06,this.waveTextureRepeat=32,this.waveDirection=(0,pr.fA)(1,0),this.waveVelocity=.05,this.flowStrength=.015,this.flowOffset=-.5,this.animationSpeed=.35,this.timeElapsed=0,this.color=(0,L.fA)(0,0,0,0),this.transparent=!0,this.hasSlicePlane=!1,this.draped=!1,this.receiveShadows=!0,this.hasScreenSpaceReflections=!1,this.hasCloudsReflections=!1,this.origin=(0,I.vt)(),this.modelTransformation=null}}const pv=35e3,fv={"calm-small":{waveStrength:.005,perturbationStrength:.02,textureRepeat:12,waveVelocity:.01},"rippled-small":{waveStrength:.02,perturbationStrength:.09,textureRepeat:32,waveVelocity:.07},"slight-small":{waveStrength:.05,perturbationStrength:.07,textureRepeat:28,waveVelocity:.1},"moderate-small":{waveStrength:.075,perturbationStrength:.07,textureRepeat:24,waveVelocity:.1},"calm-medium":{waveStrength:.003125,perturbationStrength:.01,textureRepeat:8,waveVelocity:.02},"rippled-medium":{waveStrength:.035,perturbationStrength:.015,textureRepeat:12,waveVelocity:.07},"slight-medium":{waveStrength:.06,perturbationStrength:.015,textureRepeat:8,waveVelocity:.12},"moderate-medium":{waveStrength:.09,perturbationStrength:.03,textureRepeat:4,waveVelocity:.12},"calm-large":{waveStrength:.01,perturbationStrength:0,textureRepeat:4,waveVelocity:.05},"rippled-large":{waveStrength:.025,perturbationStrength:.01,textureRepeat:8,waveVelocity:.11},"slight-large":{waveStrength:.06,perturbationStrength:.02,textureRepeat:3,waveVelocity:.13},"moderate-large":{waveStrength:.14,perturbationStrength:.03,textureRepeat:2,waveVelocity:.15}},gv=["polyline","polygon","extent"];class mv extends bs{constructor(e,t,i,r){super(e,t,i,r)}async doLoad(){}destroy(){super.destroy(),this._context.stage.remove(this._materials[0]),this._materials.length=0}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,gv,this.symbolLayer.type))return null;const i=this.setGraphicElevationContext(t);return this.ensureDrapedStatus("on-the-ground"===i.mode),this.ensureMaterial(),this.draped?this._createAsOverlay(t):this._createAs3DShape(t,i,t.uid)}ensureMaterial(){if(this._materials[0])return;const e=new uv,t=this.symbolLayer.color;null!=t&&(e.color=v.A.toUnitRGBA(t));const i=this._getCombinedOpacity(t,{hasIntrinsicColor:!0});e.color=[e.color[0],e.color[1],e.color[2],i],e.transparent=i<1||this.needsDrivenTransparentPass,e.waveDirection=null!=this.symbolLayer.waveDirection?mv.headingVectorFromAngle(this.symbolLayer.waveDirection):(0,pr.fA)(0,0);const r=this.symbolLayer.waveStrength+"-"+this.symbolLayer.waterbodySize,n=fv[r];e.waveStrength=n.waveStrength,e.waveTextureRepeat=n.textureRepeat,e.waveVelocity=n.waveVelocity,e.flowStrength=n.perturbationStrength,e.hasSlicePlane=this._context.slicePlaneEnabled,e.draped=this.draped,this._materials[0]=new hv(e),this._context.stage.add(this._materials[0])}layerOpacityChanged(){if(null==this._materials[0])return;const e=this._materials[0].parameters.color,t=this._getCombinedOpacity(this.symbolLayer.color,{hasIntrinsicColor:!0}),i=t<1||this.needsDrivenTransparentPass;this._materials[0].setParameters({color:[e[0],e[1],e[2],t],transparent:i})}layerElevationInfoChanged(e,t,i){const r=this._elevationContext.mode,n=Lt(mv.elevationModeChangeTypes,i,r);if(n!==Tt.UPDATE)return n;const s=Ft(r);return this.updateGraphics3DGraphicElevationInfo(e,t,(()=>s))}slicePlaneEnabledChanged(){var e;return null!==(e=this._materials[0])&&void 0!==e&&e.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return!0}_createAs3DShape(e,t,i){var r;const n=(0,Va.dE)(e.geometry);if(null==n)return null;const s=Xd(n,this._context.elevationProvider,this._context.renderCoordsHelper,t),a=s.position.length/3,o=(0,J.jh)(2*a);this._createUVCoordsFromVertices(o,s.mapPositions,a,this._context.elevationProvider.spatialReference);const l=new xv(s,o,this._context.layer.uid,e.uid);if(l.objectAndLayerIdColor=null===(r=this._context.stage.renderView)||void 0===r?void 0:r.getObjectAndLayerIdColor(l),this._create3DShapeGeometries(l),this._logGeometryCreationWarnings(l.renderData,n.rings,"rings","WaterSymbol3DLayer"),0===l.outGeometries.length)return null;const c=new Ps({geometries:l.outGeometries,castShadow:!1,layerUid:this._context.layer.uid,graphicUid:i}),d=new ls(this,c,l.outGeometries,null,null,Vn,t);return d.alignedSampledElevation=l.renderData.sampledElevation,d.needsElevationUpdates=Ft(t.mode),d}_createUVCoordsFromVertices(e,t,i,r){const n=(0,R.GA)(r);(0,Q.Ie)(vv);for(let o=0;o<i;o++)(0,Sa.hZ)(yv,t[3*o],t[3*o+1]),(0,Q.tK)(vv,yv);(0,D.d)(vv,vv,n);const s=vv[0]%mv.unitSizeOfTexture,a=vv[1]%mv.unitSizeOfTexture;_v[0]=vv[0]-s,_v[1]=vv[1]-a;for(let o=0;o<i;o++)e[2*o]=(t[3*o]*n-_v[0])/mv.unitSizeOfTexture,e[2*o+1]=(t[3*o+1]*n-_v[1])/mv.unitSizeOfTexture}_create3DShapeGeometries(e){const t=e.renderData.polygons,i=e.uvCoords;for(const{count:r,index:n,position:s,mapPositions:a,holeIndices:o}of t){if(null!=this._context.clippingExtent&&((0,q.Ie)(bv),(0,q.Hq)(bv,a),!(0,q.KG)(bv,this._context.clippingExtent)))continue;const t=(0,Oa.e)(a,o,3);if(0===t.length)continue;const l=(0,J.l5)(i,2*n,2*r),c=(0,Va.SY)({material:this._materials[0],indices:t,mapPositions:a,attributeData:{position:s,uv0:l}},e.objectAndLayerIdColor);e.outGeometries.push(c)}}_createAsOverlay(e){var t;const i=(0,Va.dE)(e.geometry);if(null==i)return null;this._materials[0].renderPriority=this._renderPriority;const r=$d(i,this._context.overlaySR),n=r.position.length/3,s=(0,J.jh)(2*n);this._createUVCoordsFromVertices(s,r.position,n,this._context.overlaySR);const a=new Sv(r,s,this._context.layer.uid,e.uid);return a.objectAndLayerIdColor=null===(t=this._context.stage.renderView)||void 0===t?void 0:t.getObjectAndLayerIdColor(a),a.outBoundingBox=(0,q.Ie)(),this._createAsOverlayWater(a),this._logGeometryCreationWarnings(a.renderData,i.rings,"rings","WaterSymbol3DLayer"),0===a.outGeometries.length?null:new zh(this,a.outGeometries,a.outBoundingBox,this._context.drapeSourceRenderer)}_createAsOverlayWater(e){const t=e.uvCoords,i=e.renderData.polygons;for(const{position:r,holeIndices:n,index:s,count:a}of i){if((0,q.Ie)(bv),(0,q.Hq)(bv,r),!(0,q.KG)(bv,this._context.clippingExtent))continue;(0,q.RF)(e.outBoundingBox,bv);const i=(0,Oa.e)(r,n,3);if(0===i.length)continue;const o=(0,J.l5)(t,2*s,2*a),l=(0,Va.SY)({material:this._materials[0],indices:i,attributeData:{position:r,uv0:o}},e.objectAndLayerIdColor);e.outGeometries.push(new du(l,e))}}static headingVectorFromAngle(e){const t=(0,pr.vt)(),i=(0,cm.DF)(e);return t[0]=Math.sin(i),t[1]=Math.cos(i),t}test(){return{...super.test(),create3DShape:e=>this._createAs3DShape(e.graphic,e.elevationContext,e.graphicUid),ensureMaterial:()=>this.ensureMaterial()}}}mv.unitSizeOfTexture=100,mv.elevationModeChangeTypes={definedChanged:Tt.RECREATE,staysOnTheGround:Tt.NONE,onTheGroundChanged:Tt.RECREATE};const _v=(0,pr.vt)(),vv=(0,Q.vt)(),yv=(0,pr.vt)(),bv=(0,q.vt)();class xv extends Va.JQ{constructor(e,t,i,r){super(e,i,r),this.uvCoords=t}}class Sv extends Va.JQ{constructor(e,t,i,r){super(e,i,r),this.uvCoords=t}}function wv(e,t,i,r){var n;const s=(null===(n=Av[e.type])||void 0===n?void 0:n[t.type])||Cv[t.type];return s?new s(e,t,i,r):(a.A.getLogger("esri.views.3d.layers.graphics.Graphics3DSymbolLayerFactory").error("GraphicsLayerFactory#make","unknown symbol type ".concat(t.type)),null)}const Cv={icon:Xu,object:class extends bs{getCachedSize(){const[e,t,i]=null!=this._resources?this._resources.symbolSize:[1,1,1];return{width:e,depth:t,height:i}}constructor(e,t,i,r){super(e,t,i,r),this._resources=null,this._optionalFields=new Array,this._instanceIndexToGraphicUid=new Map,this._hasLoadedPBRTextures=!1,this._disposeResourceHandles=new Array,this.skipHighSymbolLodsChanged=!1,this.ensureDrapedStatus(!1),this._hasLoadedPBRTextures=i.physicalBasedRenderingEnabled}async doLoad(e){if(!this._drivenProperties.size&&rs(this.symbolLayer))throw new Error;if(this._isPrimitive){const t=this.symbolLayer.resource,i=t&&function(e){switch(e){case"sphere":case"cube":case"diamond":case"cylinder":case"cone":case"inverted-cone":case"tetrahedron":return!0}return!1}(t.primitive)?t.primitive:lr.r;this._resources=await this._createResourcesForPrimitive(i,e)}else{var t;const i=await async function(e){var t;if(null===e||null==e.styleName&&null==e.styleUrl)return null;const i=e.name;if(null==i)throw new oe.A("symbolstyleutils:style-symbol-reference-name-missing","Missing name in style symbol reference");const r={portal:e.portal},n=await(0,qf.cF)(e,r).catch((()=>null));if(null===n)return null;const s=(0,Qf.p)(i,n.data);if(s&&(null===(t=s.formatInfos)||void 0===t||!t.some((e=>"gltf_basisu"===e.type))))return null;const a=await(0,Qf.I)(n,i,r,"webRef",((e,t)=>(0,qf.o5)(e,t,["gltf_basisu","gltf"]))).catch((()=>null));if(null===a||"point-3d"!==a.type)return null;const o=a.symbolLayers.items[0];return"object"===o.type?o.resource:null}(this.symbol.styleOrigin),r=null!==(t=null===i||void 0===i?void 0:i.href)&&void 0!==t?t:this.symbolLayer.resource.href;this._resources=await this._createResourcesForUrl(r,e)}this.layerOpacityChanged(),this.slicePlaneEnabledChanged(),this.physicalBasedRenderingChanged(),this.complexity=this.computeComplexity()}get extentPadding(){return null!=this._resources?this._resources.extentPadding:0}get _isPrimitive(){var e;return!(null!==(e=this.symbolLayer.resource)&&void 0!==e&&e.href)}get lodRenderer(){var e;return null===(e=this._resources)||void 0===e?void 0:e.lodRenderer}get materials(){var e,t;return null!==(e=null===(t=this._resources)||void 0===t?void 0:t.stageResources.materials)&&void 0!==e?e:[]}_setMaterialTransparencyParameters(e){var t;let i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null===(t=this.symbolLayer)||void 0===t||null===(t=t.material)||void 0===t?void 0:t.color;const r=this._getCombinedOpacity(i),n=r<1||this.needsDrivenTransparentPass;return e.transparent=n,e.opacity=r,e.cullFace=n?fe.s2.None:fe.s2.Back,e}async _createResourcesForPrimitive(e,t){const i=this.symbolLayer,r=(0,q.vt)((0,Vf.Fq)(e)),n=(0,I.ci)((0,q.Ej)(r)),s=(0,I.ci)((0,Vf.Bb)(n,i)),a=(0,M.l)(s),o={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,mrrFactors:[...me.mX],ambient:I.Un,diffuse:I.Un,hasSlicePlane:this._context.slicePlaneEnabled,hasSliceHighlight:!1,castShadows:this.symbolLayer.castShadows,offsetTransparentBackfaces:!this.symbolLayer.isPrimitive},l=!!o.usePBR;this._setMaterialTransparencyParameters(o);const c=this.symbol;if("point-3d"===c.type&&c.verticalOffset){const{screenLength:e,minWorldLength:t,maxWorldLength:i}=c.verticalOffset;o.verticalOffset={screenLength:(0,Ln.Lz)(e),minWorldLength:t||0,maxWorldLength:null!=i?i:1/0},o.castShadows=!1}if(this._context.screenSizePerspectiveEnabled&&(o.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings),this._drivenProperties.color)o.externalColor=L.Un;else{const e=null!=i.material?i.material.color:null,t=null!=e?v.A.toUnitRGBA(e):L.Un;o.externalColor=t}this._fastUpdates=(0,vs.s_)(this._context.renderer,this._fastVisualVariableConvertOptions(r,s,n,null)),o.isInstanced=!0,this._fastUpdates?(Object.assign(o,this._fastUpdates.materialParameters),this._optionalFields.push(Pt.r.FEATUREATTRIBUTE)):this._hasPerInstanceColor()&&(o.hasInstancedColor=!0,this._optionalFields.push(Pt.r.COLOR)),(0,h.A)("enable-feature:objectAndLayerId-rendering")&&this._optionalFields.push(Pt.r.OBJECTANDLAYERIDCOLOR);const d=rn(e,new hn.$U(o));if(!d)throw new Error("Unknown object symbol primitive: ".concat(e));const u=Kr(d).map((e=>({opacity:1,transparent:e.parameters.transparent}))),p=await this._createStageResources(d,l,t),f=await this._createLodRenderer(d,t);return new Sg(d,f,p,u,n,!1,!1,r,s,a,l,null)}async _createResourcesForUrl(e,t){var i;const r={materialParameters:{isInstanced:!0,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows},streamDataRequester:this._context.streamDataRequester,cache:this._context.sharedResources.objectResourceCache};this._fastUpdates=(0,vs.s_)(this._context.renderer,this._fastVisualVariableConvertOptions(null,null,null,null)),this._fastUpdates?(Object.assign(r.materialParameters,this._fastUpdates.materialParameters),this._optionalFields.push(Pt.r.FEATUREATTRIBUTE)):this._hasPerInstanceColor()&&(r.materialParameters.hasInstancedColor=!0,this._optionalFields.push(Pt.r.COLOR)),(0,h.A)("enable-feature:objectAndLayerId-rendering")&&this._optionalFields.push(Pt.r.OBJECTANDLAYERIDCOLOR);const n=this.symbol;if("point-3d"===n.type&&n.verticalOffset){const{screenLength:e,minWorldLength:t,maxWorldLength:i}=n.verticalOffset;r.materialParameters.verticalOffset={screenLength:(0,Ln.Lz)(e),minWorldLength:t||0,maxWorldLength:null!=i?i:1/0},r.materialParameters.castShadows=!1}const s=this._context.physicalBasedRenderingEnabled;r.signal=t,r.usePBR=s,r.skipHighLods=this._context.skipHighSymbolLods;const a=await(0,Zf.fetch)(e,r),o=a.isEsriSymbolResource,l=a.isWosr,c=function(e){return new $r(e.map(((e,t)=>Wf(e,t))))}(a.lods),d=this._context,u=this.symbolLayer.material,p=this._getExternalColorParameters(u),f=null===(i=this.symbolLayer)||void 0===i||null===(i=i.material)||void 0===i?void 0:i.color,g=this._getCombinedOpacity(f,{hasIntrinsicColor:!0}),m=this.needsDrivenTransparentPass,_=Kr(c),v=Kr(c).map((e=>({opacity:e.parameters.opacity||1,transparent:e.parameters.transparent})));_.forEach((e=>{const t=e.parameters;e.setParameters(p);const i=t.opacity*g,r=i<1||m||t.transparent;e.setParameters({opacity:i,transparent:r}),d.screenSizePerspectiveEnabled&&e.setParameters({screenSizePerspective:d.sharedResources.screenSizePerspectiveSettings})}));const y=a.referenceBoundingBox,b=(0,I.ci)((0,q.Ej)(y)),x=(0,I.ci)(c.levels[0].pivotOffset),S=(0,I.ci)((0,Vf.Bb)(b,this.symbolLayer)),w=(0,M.l)(S),C=this._fastUpdates;(0,vs.J_)(C,this._context.renderer,this._fastVisualVariableConvertOptions(y,S,b,x))&&_.forEach((e=>e.setParameters(C.materialParameters)));const A=await this._createStageResources(c,s,t),R=await this._createLodRenderer(c,t);return new Sg(c,R,A,v,b,o,l,y,S,w,s,x)}_addDisposeResource(e){this._disposeResourceHandles.push(e)}async _createStageResources(e,t,i){const r=this._context.stage,n=Kr(e);t!==this._context.physicalBasedRenderingEnabled&&this.physicalBasedRenderingChanged(),r.addMany(n),this._addDisposeResource((()=>r.removeMany(n)));const s=en(e);r.addMany(s),this._addDisposeResource((()=>{s.forEach((e=>e.unload())),r.removeMany(s)})),await Promise.all(s.map((e=>this._context.stage.schedule((()=>e.load(r.renderView.renderingContext)),i)))),(0,o.Te)(i);const a=tn(e);return r.addMany(a),this._addDisposeResource((()=>r.removeMany(a))),{materials:n,textures:s,geometries:a}}async _createLodRenderer(e,t){const i=this._context.stage,r={layerUid:this._context.layer.uid,graphicUid:e=>this._instanceIndexToGraphicUid.get(e),notifyGraphicGeometryChanged:e=>this._context.notifyGraphicGeometryChanged(this._instanceIndexToGraphicUid.get(e)),notifyGraphicVisibilityChanged:e=>this._context.notifyGraphicVisibilityChanged(this._instanceIndexToGraphicUid.get(e))},n=this._fastUpdates,s=n?{applyTransform:(e,t,i)=>{e.getFeatureAttribute(t,Rg),(0,T.C)(i,(0,vs.b3)(n.materialParameters,Rg,i))},scaleFactor:(e,t,i)=>{t.getFeatureAttribute(i,Rg),(0,vs.VC)(e,n.materialParameters,Rg)}}:null,a=new pg({symbol:e,optionalFields:this._optionalFields,metadata:r,shaderTransformation:s},this._context.scheduler);return a.slicePlaneEnabled=this._context.slicePlaneEnabled,this._addDisposeResource((()=>{i.removeRenderPlugin(a),a.destroy()})),await i.addRenderPlugin(a,t),a}_getExternalColorParameters(e){const t={};return this._drivenProperties.color?t.externalColor=L.Un:null!=(null===e||void 0===e?void 0:e.color)?t.externalColor=v.A.toUnitRGBA(e.color):(t.externalColor=L.Un,t.colorMixMode="ignore"),t}destroy(){super.destroy(),this._cleanupResources()}_cleanupResources(){this._disposeResourceHandles.forEach((e=>e())),this._disposeResourceHandles.length=0,this._resources=null}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry))return null;const i=Bs(t.geometry);if(null==i)return this.logger.warn("unsupported geometry type for icon symbol: ".concat(t.geometry.type)),null;const r=this.setGraphicElevationContext(t),n=e.renderingInfo;return this._createAs3DShape(t,i,n,r,t.uid,e.layer.uid)}notifyDestroyGraphicLayer(e){this._instanceIndexToGraphicUid.delete(e.instanceIndex)}graphicLayerToGraphicId(){return 0}layerOpacityChanged(){if(null==this._resources)return;const e=this._drivenProperties.opacity,t=!this._isPrimitive,i=this._resources.stageResources.materials,r=this._resources.originalMaterialParameters;for(let s=0;s<i.length;s++){var n;const a=i[s],o=null===(n=this.symbolLayer)||void 0===n||null===(n=n.material)||void 0===n?void 0:n.color,l=r[s],c=this._getCombinedOpacity(o,{hasIntrinsicColor:t})*l.opacity,d=c<1||e||l.transparent;a.setParameters({opacity:c,transparent:d}),this._isPrimitive&&a.setParameters({cullFace:d?fe.s2.None:fe.s2.Back})}}layerElevationInfoChanged(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,Nt)}slicePlaneEnabledChanged(){if(null==this._resources)return!0;this._resources.lodRenderer.slicePlaneEnabled=this._context.slicePlaneEnabled;for(const e of this._resources.stageResources.materials)e.setParameters({hasSlicePlane:this._context.slicePlaneEnabled});return!0}physicalBasedRenderingChanged(){if(null==this._resources)return!0;const{stageResources:e,isWosr:t}=this._resources;for(const i of e.materials)this._isPrimitive?i.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}):t||i.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!1});return!1!==this._hasLoadedPBRTextures||!0!==this._context.physicalBasedRenderingEnabled||(this._hasLoadedPBRTextures=!0,!1)}applyRendererDiff(e,t){if(null==this._resources)return gs.RecreateSymbol;const{stageResources:{materials:i},lodRenderer:r,resourceBoundingBox:n,symbolSize:s,resourceSize:a,pivotOffset:o}=this._resources;for(const l in e.diff){if("visualVariables"!==l)return gs.RecreateSymbol;if(!(0,vs.J_)(this._fastUpdates,t,this._fastVisualVariableConvertOptions(n,s,a,o)))return gs.RecreateSymbol;for(const e of i)e.setParameters(this._fastUpdates.materialParameters);r.notifyShaderTransformationChanged()}return gs.FastUpdate}computeComplexity(){if(null==this._resources)return super.computeComplexity();const e=this._resources.lodResources,t=vn(e.levels),i=tn(e).reduce(((e,t)=>e+(e=>Array.from(e.attributes.values()).reduce(((e,t)=>e+(0,A.Ek)(t.data,t.indices)),0))(t)),0),r=en(e).reduce(((e,t)=>e+t.memoryEstimate),0)+i,n={...mn(this.symbol,this.symbolLayer),resourceBytes:r};return new sn({verticesPerFeature:t,memory:n})}_hasLodRenderer(){return null!=this._resources}_createAs3DShape(e,t,i,r,n,s){if(!this._hasLodRenderer()||null==this._resources)return null;const a=this.getFastUpdateAttrValues(e),o=this._context.clippingExtent;if((0,As.g)(t,wg,this._context.elevationProvider.spatialReference),null!=o&&!(0,q.Uc)(o,wg))return null;const l=this._requiresTerrainElevation(r),c=this._computeGlobalTransform(t,r,Ag,Eg),d=this._computeLocalTransform(this._resources,this.symbolLayer,i,Cg),h=this._resources.lodRenderer.instanceData,u=h.addInstance();this._instanceIndexToGraphicUid.set(u,n),h.setLocalTransform(u,d,!1),h.setGlobalTransform(u,c),a&&h.setFeatureAttribute(u,a),null==this._fastUpdates&&this._hasPerInstanceColor()&&h.setColor(u,ts(i.color,i.opacity,255)),null!=this._context.stage.renderView.objectAndLayerIdRenderHelper&&h.setObjectAndLayerIdColor(u,this._context.stage.renderView.objectAndLayerIdRenderHelper.getObjectAndLayerIdColor({graphicUid:n,layerUid:s}));const p=new Gf(this,u,zn,r);return l&&(p.alignedSampledElevation=Eg.sampledElevation),p.needsElevationUpdates=Nt(r.mode),zs(p,t,this._context.elevationProvider),p}_computeGlobalTransform(e,t,i,r){return It(e,this._context.elevationProvider,t,this._context.renderCoordsHelper,r),wg[0]=e.x,wg[1]=e.y,wg[2]=r.z,(0,Ct.l)(e.spatialReference,wg,i,this._context.renderCoordsHelper.spatialReference),i}_computeLocalTransform(e,t,i,r){return(0,T.D_)(r),this._applyObjectRotation(i,!1,r),this._applyObjectRotation(t,!0,r),this._applyObjectScale(e,i,r),this._applyAnchor(e,t,r),r}_applyObjectScale(e,t,i){var r;if(null!==(r=this._fastUpdates)&&void 0!==r&&r.requiresShaderTransformation)return;const n=is(this._drivenProperties.size&&t.size?t.size:e.symbolSize,e.symbolSize,e.resourceSize,this._context.renderCoordsHelper.unitInMeters);1===n[0]&&1===n[1]&&1===n[2]||(0,T.hs)(i,i,n)}prepareSymbolLayerPatch(e){if("partial"!==e.diff.type)return;const t=e.diff.diff;this._preparePatchTransform(e,t),this._preparePatchColor(e,t)}updateGeometry(e,t){if(null==this._resources)return!0;const i=t&&Bs(t);if(null==i)return!1;const r=this.getGeometryElevationMode(t);return e.elevationContext.mode===r&&(this._computeGlobalTransform(i,e.elevationContext,Ag,Eg),this._requiresTerrainElevation(e.elevationContext)&&(e.alignedSampledElevation=Eg.sampledElevation),this._resources.lodRenderer.instanceData.setGlobalTransform(e.instanceIndex,Ag,!0),zs(e,i,this._context.elevationProvider),!0)}_preparePatchTransform(e,t){if(!(t.heading||t.tilt||t.roll||t.width||t.height||t.depth||t.anchor||t.anchorPosition))return;if(null==this._resources)return;const i=(e,t,i)=>{var r;return null!==(r=null!=e&&"complete"===e.type?e.newValue:t)&&void 0!==r?r:i},r=i(t.heading,this.symbolLayer.heading,0),n=i(t.tilt,this.symbolLayer.tilt,0),s=i(t.roll,this.symbolLayer.roll,0),a=i(t.width,this.symbolLayer.width,void 0),o=i(t.height,this.symbolLayer.height,void 0),l=i(t.depth,this.symbolLayer.depth,void 0),c=i(t.anchor,this.symbolLayer.anchor,void 0),d=i(t.anchorPosition,this.symbolLayer.anchorPosition,void 0);delete t.heading,delete t.tilt,delete t.roll,delete t.width,delete t.height,delete t.depth,delete t.anchor,delete t.anchorPosition;const h={heading:r,tilt:n,roll:s,anchor:c,anchorPosition:d},u=this._resources;this.loadStatus===ms.LOADED&&e.symbolLayerStatePatches.push((()=>{u.symbolSize=(0,I.ci)((0,Vf.Bb)(u.resourceSize,{width:a,height:o,depth:l,isPrimitive:this.symbolLayer.isPrimitive}))})),e.graphics3DGraphicPatches.push(((e,t)=>{const i=this._computeLocalTransform(u,h,t,Cg),r=e.instanceIndex;u.lodRenderer.instanceData.setLocalTransform(r,i,!0)}))}_preparePatchColor(e,t){if(!t.material||"partial"!==t.material.type)return;const i=t.material.diff;if(!i.color||"complete"!==i.color.type||null==i.color.newValue||null==i.color.oldValue)return;const r=i.color.newValue,n=null!=r?v.A.toUnitRGBA(r):L.Un;delete i.color;const s=this._resources;null!=s&&e.graphics3DGraphicPatches.push((e=>{let t;this._hasPerInstanceColor()?(s.lodRenderer.instanceData.setColor(e.instanceIndex,n),t=this._setMaterialTransparencyParameters({},r)):t=this._setMaterialTransparencyParameters({externalColor:n},r);for(const i of s.stageResources.materials)i.setParameters(t)}))}_requiresTerrainElevation(e){return"absolute-height"!==e.mode}_applyObjectRotation(e,t,i){var r;if(null===(r=this._fastUpdates)||void 0===r||!r.requiresShaderTransformation||!t)return function(e,t,i){let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:(0,P.vt)();return e&&(0,T.Qr)(r,r,-e/180*Math.PI),t&&(0,T.eL)(r,r,t/180*Math.PI),i&&(0,T.Z8)(r,r,i/180*Math.PI),r}(e.heading,e.tilt,e.roll,i)}_computeAnchor(e,t,i){const r=(0,I.vt)();switch(i.anchor){case"center":(0,M.c)(r,(0,q.gX)(e)),(0,M.E)(r,r);break;case"top":{const t=(0,q.gX)(e);(0,M.s)(r,-t[0],-t[1],-e[5]);break}case"bottom":{const t=(0,q.gX)(e);(0,M.s)(r,-t[0],-t[1],-e[2]);break}case"relative":{const t=(0,q.gX)(e),n=(0,q.Ej)(e),s=i.anchorPosition,a=s?(0,I.fA)(s.x,s.y,s.z):I.uY;(0,M.A)(r,n,a),(0,M.g)(r,r,t),(0,M.E)(r,r);break}default:null!=t?(0,M.E)(r,t):(0,M.c)(r,I.uY)}return r}_applyAnchor(e,t,i){var r;if(null!==(r=this._fastUpdates)&&void 0!==r&&r.requiresShaderTransformation)return;const n=this._computeAnchor(e.resourceBoundingBox,e.pivotOffset,t);n&&(0,T.Tl)(i,i,n)}_hasPerInstanceColor(){return this._drivenProperties.color||this._drivenProperties.opacity}_fastVisualVariableConvertOptions(e,t,i,r){const n=null!=e?(0,I.ci)((0,q.Ej)(e)):I.Un,s=null!=e?this._computeAnchor(e,r,this.symbolLayer):I.uY,a=this._context.renderCoordsHelper.unitInMeters,o=is(null!=t?t:void 0,t,i,a),l=(0,I.fA)(this.symbolLayer.tilt||0,this.symbolLayer.roll||0,this.symbolLayer.heading||0);return new vs.wI({size:!0,color:!0,rotation:!0,opacity:!1},n,null!==t&&void 0!==t?t:I.Un,a,s,o,l)}},line:Cp,path:class extends bs{constructor(e,t,i,r){super(e,t,i,r),this._intrinsicSize=(0,pr.fA)(1,1),this._upVectorAlignment=Wg.Path,this._stencilWidth=.1,this.usedMemory=0,this.ensureDrapedStatus(!1)}async doLoad(){var e,t,i;const r=null!=this.symbolLayer.width?this.symbolLayer.width:this.symbolLayer.height,n=null!=this.symbolLayer.height?this.symbolLayer.height:r;this._vvConvertOptions=new vs.wI({size:!0,color:!0,rotation:!1,opacity:!0},[1,1,1],[r,1,n],this._context.renderCoordsHelper.unitInMeters),this._fastUpdates=(null===(e=this._context.renderer)||void 0===e||null===(e=e.visualVariables)||void 0===e?void 0:e.length)>0?(0,vs.s_)(this._context.renderer,this._vvConvertOptions):null;const s=this.symbolLayer.anchor||"center";this._upVectorAlignment="heading"===this.symbolLayer.profileRotation?Wg.World:Wg.Path;const a=this.symbolLayer.profile||"circle";switch(a){default:case"circle":this._profile=am[s];break;case"quad":this._profile=om[s]}switch(this.symbolLayer.join){case"round":this._extruder=new Vg(0,cr);break;case"bevel":this._extruder=new Vg(0,1);break;case"miter":this._extruder=new Vg(.8*Math.PI,1);break;default:this._extruder=new Ng}const o=this.symbolLayer.cap||"butt";switch(o){case"none":this._startCap=new Mg,this._endCap=new Mg;break;case"butt":default:this._startCap=new Ig(this._profile,0),this._endCap=new Ig(this._profile,0,!0);break;case"square":this._startCap=new Ig(this._profile,-.5),this._endCap=new Ig(this._profile,.5,!0);break;case"round":{const e="quad"===a;this._startCap=new Dg({profile:this._profile,flip:!1,breakNormals:e,subdivisions:dr}),this._endCap=new Dg({profile:this._profile,flip:!0,breakNormals:e,subdivisions:dr});break}}const l=null===(t=this.symbolLayer)||void 0===t||null===(t=t.material)||void 0===t?void 0:t.color,c=this._getCombinedOpacityAndColor(l),d=(0,I.ci)(c),h=c[3],u=h<1||this.needsDrivenTransparentPass,p={diffuse:d,ambient:d,opacity:h,transparent:u,hasVertexColors:!1,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,cullFace:u||"none"===o?fe.s2.None:fe.s2.Back,offsetTransparentBackfaces:!0};if(!this._drivenProperties.size&&((0,Sa.hZ)(this._intrinsicSize,r,n),!ns(this._intrinsicSize[0])||!ns(this._intrinsicSize[1])))throw new oe.A("graphics3dpathsymbollayer:invalid-size","Symbol sizes may not be negative values");if(null!==(i=this._fastUpdates)&&void 0!==i&&i.visualVariables.size||(0,Sa.hs)(this._intrinsicSize,this._intrinsicSize,1/this._context.renderCoordsHelper.unitInMeters),this._fastUpdates){const e={...p,...this._fastUpdates.materialParameters,size:(0,pr.ci)(this._intrinsicSize)};this._materials[0]=new Gm(e)}else p.hasVertexColors=this._drivenProperties.color||this._drivenProperties.opacity,p.normalType=ah.W.Compressed,this._materials[0]=new hn.$U(p);this._materials[0].setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),this._context.stage.add(this._materials[0])}destroy(){super.destroy(),this._context.stage.remove(this._materials[0]),this._materials[0]=null,this._materials.length=0}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,Bm,this.symbolLayer.type))return null;const i=this.setGraphicElevationContext(t),r=e.renderingInfo;return this._createAs3DShape(t,r,i,t.uid)}layerOpacityChanged(){var e,t;const i=null===(e=this.symbolLayer)||void 0===e||null===(e=e.material)||void 0===e?void 0:e.color,r=this._getCombinedOpacity(i),n=r<1||this.needsDrivenTransparentPass;null===(t=this._materials[0])||void 0===t||t.setParameters({opacity:r,transparent:n})}layerElevationInfoChanged(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,Nt)}slicePlaneEnabledChanged(){var e;return null!==(e=this._materials[0])&&void 0!==e&&e.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){var e;return null!==(e=this._materials[0])&&void 0!==e&&e.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),!0}applyRendererDiff(e,t){for(const r in e.diff){var i;if("visualVariables"!==r)return gs.RecreateSymbol;if(!(0,vs.J_)(this._fastUpdates,t,this._vvConvertOptions))return gs.RecreateSymbol;null===(i=this._materials[0])||void 0===i||i.setParameters(this._fastUpdates.materialParameters)}return gs.FastUpdate}_getVertexData(e){let t=0;const i=e.paths,r=[],n=e.spatialReference,s=this._context.elevationProvider.spatialReference,a=this._context.renderCoordsHelper.spatialReference;for(const d of i)t+=d.length;const o=(0,J.jh)(3*t);let l,c=0;for(const d of i){r.push({offset:c,numVertices:d.length});for(const t of d)o[c++]=t[0],o[c++]=t[1],o[c++]=e.hasZ?t[2]:0}return null==s||n.equals(s)||(0,k.projectBuffer)(o,n,0,o,s,0,t)?(null==s||s.equals(a)?l=(0,J.xm)(o):(l=(0,J.jh)(3*t),(0,k.projectBuffer)(o,s,0,l,a,0,t)),{pathVertexDataInfos:r,vertexDataES:o,vertexDataRS:l}):null}_createAs3DShape(e,t,i,r){this.usedMemory=0;const n=e.geometry,s=this._getVertexData(n);if(null==s)return this.logger.warn("PathSymbol3DLayer geometry failed to be created (failed to project geometry to view spatial reference)"),null;if(0===s.pathVertexDataInfos.length)return 0!==n.paths.length&&n.paths.some((e=>e.length>0))||this.logger.warn("PathSymbol3DLayer geometry failed to be created (no paths were defined)"),null;const a=new Array,o=n.spatialReference,l=(0,q.vt)(),c=this._context.renderCoordsHelper,d=new Rt(s.vertexDataES);for(const y of s.pathVertexDataInfos){const n=y.numVertices;if(n<2)continue;const _=y.offset;if(null!=this._context.clippingExtent&&((0,q.Ie)(l),(0,q.Hq)(l,s.vertexDataES,_,n),!(0,q.KG)(l,this._context.clippingExtent)))continue;const v=new Array,b=_+3*n;for(let e=_;e<b;e+=3){d.offset=e;const t=Dt(d,this._context.elevationProvider,i,c);(0,M.s)(km,s.vertexDataRS[e],s.vertexDataRS[e+1],s.vertexDataRS[e+2]),c.setAltitude(km,t),s.vertexDataRS[e]=km[0],s.vertexDataRS[e+1]=km[1],s.vertexDataRS[e+2]=km[2],v.push(ym(this._upVectorAlignment))}const x=new Og(v,s.vertexDataES,s.vertexDataRS,_);Hm(x,this._upVectorAlignment,this._context.renderCoordsHelper);const S=new Tg(x,this._profile,this._extruder,this._startCap,this._endCap);let w=null;if(this._fastUpdates){var h,u,p,f,g,m;const t=this._fastUpdates.visualVariables,i=null!==(h=(0,vs.ul)(null===(u=t.size)||void 0===u?void 0:u.field,e))&&void 0!==h?h:0,r=null!==(p=(0,vs.ul)(null===(f=t.color)||void 0===f?void 0:f.field,e))&&void 0!==p?p:0,n=null!==(g=(0,vs.ul)(null===(m=t.opacity)||void 0===m?void 0:m.field,e))&&void 0!==g?g:0;w=new Qg(S,i,r,n)}else{const e=[this._intrinsicSize[0],this._intrinsicSize[1]];if(this._drivenProperties.size){const i=t.size;e[0]*=jm(i[0],"symbol-value"===i[2]?this.symbolLayer.height||0:i[2],this.symbolLayer.width||0),e[1]*=jm(i[2],"symbol-value"===i[0]?this.symbolLayer.width||0:i[0],this.symbolLayer.height||0)}let i;this._drivenProperties.color&&(i=t.color),this._drivenProperties.opacity&&null!=t.opacity&&(i=i?[i[0],i[1],i[2],t.opacity]:[1,1,1,t.opacity]);const r=new qg(S);r.bake(e),i&&r.bakeVertexColors(i),w=r}const C=w.createGeometryData(),A=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:r,layerUid:this._context.layer.uid}),R=new jg(this._materials[0],C,w,o,this._stencilWidth,A);R.transformation=(0,T.Tl)((0,P.vt)(),P.zK,S.path.origin),a.push(R),this.usedMemory+=S.usedMemory}if(0===a.length)return null;const _=new Ps({geometries:a,layerUid:this._context.layer.uid,graphicUid:r}),v=new ls(this,_,a,null,null,((e,t,i,r,n)=>function(e,t,i,r,n){const s=e.stageObject,a=s.geometries;let o=0;for(const l of a){if(!kg(l))continue;const e=l.path,a=e.builder.path;o+=Wm(a,t,i,r),n!==Wg.World&&Hm(a,n,r),e.onPathChanged(l),l.invalidateBoundingInfo(),s.geometryVertexAttributeUpdated(l,Pt.r.POSITION)}return o/a.length}(e,t,r,n,this._upVectorAlignment)),i);return v.alignedSampledElevation=0,v.needsElevationUpdates=Nt(i.mode),v}},fill:F_,extrude:class extends bs{constructor(e,t,i,r){super(e,t,i,r),this.ensureDrapedStatus(!1)}async doLoad(){var e;if(!this._drivenProperties.size){const e=rs(this._getSymbolSize());if(e)throw new oe.A("graphics3dextrudesymbollayer:invalid-size",e)}const t=null===(e=this.symbolLayer)||void 0===e||null===(e=e.material)||void 0===e?void 0:e.color,i=this._getCombinedOpacityAndColor(t),r=(0,I.ci)(i),n=i[3],s=n<1||this.needsDrivenTransparentPass,a={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,diffuse:r,ambient:r,opacity:n,transparent:s,cullFace:s?fe.s2.None:fe.s2.Back,hasVertexColors:!0,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,offsetTransparentBackfaces:!0,normalType:ah.W.Compressed};this._materials[Eh.Main]=new hn.$U(a),this._materials[Eh.Bottom]=new hn.$U({...a,cullFace:fe.s2.Back}),this._context.stage.addMany(this._materials)}destroy(){super.destroy(),this._context.stage.removeMany(this._materials),this._materials.length=0}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,lh,this.symbolLayer.type))return null;const i=this._getVertexOpacityAndColor(e.renderingInfo,255),r=this.setGraphicElevationContext(t);return this._createAs3DShape(t,e.renderingInfo,i,r,t.uid)}layerOpacityChanged(e,t){var i,r,n;const s=null===(i=this.symbolLayer)||void 0===i||null===(i=i.material)||void 0===i?void 0:i.color,a=this._getCombinedOpacity(s),o=a<1||this.needsDrivenTransparentPass;null!==(r=this._materials[Eh.Main])&&void 0!==r&&r.setParameters({opacity:a,transparent:o}),null===(n=this._materials[Eh.Bottom])||void 0===n||n.setParameters({opacity:a,transparent:o});const l=this._getLayerOpacity();e.forEach((e=>{const i=t(e);null!=i&&i.layerOpacityChanged(l,this._context.isAsync)}))}layerElevationInfoChanged(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,Nt)}slicePlaneEnabledChanged(e,t){var i,r;return null!==(i=this._materials[Eh.Main])&&void 0!==i&&i.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),null!==(r=this._materials[Eh.Bottom])&&void 0!==r&&r.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),e.forEach((e=>{const i=t(e);null!=i&&i.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync)})),!0}physicalBasedRenderingChanged(){var e,t;const i={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0};return null!==(e=this._materials[Eh.Main])&&void 0!==e&&e.setParameters(i),null!==(t=this._materials[Eh.Bottom])&&void 0!==t&&t.setParameters(i),!0}_getExtrusionSize(e){var t;let i;return i=e.size&&this._drivenProperties.size?null!==(t=function(e){const t=e[arguments.length>1&&void 0!==arguments[1]?arguments[1]:0];return"number"==typeof t&&isFinite(t)?t:null}(e.size,2))&&void 0!==t?t:0:this._getSymbolSize(),i/=this._context.renderCoordsHelper.unitInMeters,i}applyRendererDiff(e,t){return this._drivenPropertiesChanged(t)?gs.RecreateSymbol:gs.RecreateGraphics}async queryForSnapping(e,t,i,r){var n;const s=this._getExtrusionSize(i)*this._context.renderCoordsHelper.unitInMeters/(0,R.G9)(t),{objectId:a,target:o}=e,l=(0,lt.o8)(o);switch(l.z=(null!==(n=l.z)&&void 0!==n?n:0)+s,e.type){case"edge":{var c,d;const{start:t,end:i}=e,r=(0,lt.o8)(t),n=(0,lt.o8)(i);return r.z=(null!==(c=r.z)&&void 0!==c?c:0)+s,n.z=(null!==(d=n.z)&&void 0!==d?d:0)+s,[(0,Pa.P)(a,l,1/0,r,n)]}case"vertex":return[(0,Pa.k)(a,l,1/0),(0,Pa.P)(a,o,1/0,o,l)];default:return[]}}_getSymbolSize(){var e;return null!==(e=this.symbolLayer.size)&&void 0!==e?e:1}_createAs3DShape(e,t,i,r,n){const s=(0,Va.dE)(e.geometry);if(null==s)return null;if(0===s.rings.length||!s.rings.some((e=>e.length>0)))return this._logGeometryValidationWarnings(s.rings,"rings","ExtrudeSymbol3DLayer"),null;const a=Xd(s,this._context.elevationProvider,this._context.renderCoordsHelper,r);this._logGeometryCreationWarnings(a,s.rings,"rings","ExtrudeSymbol3DLayer");const o=$n(s);if(null==o)return null;const l=new Array,c=new Array,d=(0,q.vt)(),h=(0,P.vt)(),u=(0,I.vt)(),p=this._context.renderCoordsHelper.viewingMode===ae.RT.Global;p||this._context.renderCoordsHelper.worldUpAtPosition(null,u),(0,Ct.l)(s.spatialReference,[o.x,o.y,0],h,this._context.renderCoordsHelper.spatialReference);const f=(0,P.vt)();(0,T.B8)(f,h);const g=(0,O.vt)();(0,E.Ge)(g,f);const{polygons:m,mapPositions:_,position:v}=a;for(const w of m){const e=w.count;if(this._context.clippingExtent&&((0,q.Ie)(d),(0,q.Hq)(d,w.mapPositions),!(0,q.KG)(d,this._context.clippingExtent)))continue;const r=(0,Oa.e)(w.mapPositions,w.holeIndices,3);if(0===r.length)continue;const s=r.length,a=6*e,o=(0,X.my)(a+s),h=(0,X.my)(s),g=(0,J.jh)(3*a),m=(0,J.jh)(3*a),y=(0,J.jh)(3*a),b=(0,J.jh)(a);dh(v,_,r,w,g,y,m,b,o,h,this._getExtrusionSize(t),u,p),(0,Ta.a)(g,g,f);const x=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:n,layerUid:this._context.layer.uid}),S=new Oh(g,y,(0,oh.fA)(m),b);l.push(ch(this._materials[Eh.Main],o,o.length-h.length,S,i,x),ch(this._materials[Eh.Bottom],h,0,S,i,x)),c.push(S.heights)}if(0===l.length)return null;const y=new Ps({geometries:l,layerUid:this._context.layer.uid,graphicUid:n,isElevationSource:!0});y.transformation=h;const b=(0,dn.Cc)(this.symbolLayer,{opacity:this._getLayerOpacity()}),x=null!=b?{baseMaterial:this._materials[Eh.Main],edgeMaterials:[b],properties:{mergeGeometries:!0,hasSlicePlane:this._context.slicePlaneEnabled}}:null,S=new ls(this,y,l,null,null,((e,t,i,r,n)=>function(e,t,i,r,n,s){const a=e.stageObject,o=a.geometries,l=o.length,c="absolute-height"!==t.mode;let d=0;const h=a.transformation,u=(0,T.Qw)((0,P.vt)(),h);for(let p=0;p<l;p+=2){const e=o[p];if(!Nn(e))continue;const t=e.getMutableAttribute(Pt.r.POSITION).data,l=s[p/2],f=new Rt(e.mapPositions),g=t.length/3;let m=0,_=!1,v=0;for(let s=0;s<g;s++){bh[0]=t[m],bh[1]=t[m+1],bh[2]=t[m+2],r(f,wh),c&&(v+=wh.sampledElevation),Fn.b.TESTS_DISABLE_OPTIMIZATIONS?((0,M.s)(xh,f.array[f.offset],f.array[f.offset+1],wh.z+l[m/3]),null!=i&&n.toRenderCoords(xh,i,xh),(0,M.e)(xh,xh,u)):((0,M.s)(xh,t[m],t[m+1],t[m+2]),(0,M.e)(xh,xh,h),n.setAltitude(xh,wh.z+l[m/3]),(0,M.e)(xh,xh,u)),t[m]=xh[0],t[m+1]=xh[1],t[m+2]=xh[2];const e=Rh/n.unitInMeters;(Math.abs(bh[0]-t[m])>=e||Math.abs(bh[1]-t[m+1])>=e||Math.abs(bh[2]-t[m+2])>=e)&&(_=!0),f.offset+=3,m+=3}_&&(e.invalidateBoundingInfo(),a.geometryVertexAttributeUpdated(o[p],Pt.r.POSITION),o[p+1].invalidateBoundingInfo(),a.geometryVertexAttributeUpdated(o[p+1],Pt.r.POSITION)),d+=v/g}return d/l}(e,t,i,r,n,c)),r,x);return S.alignedSampledElevation=a.sampledElevation,S.needsElevationUpdates=Nt(r.mode),S}},text:class extends bs{constructor(e,t,i,r){super(e,t,i,r),this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!1},this.ensureDrapedStatus(!1)}async doLoad(){if(!this._drivenProperties.size){const e=rs(this.symbolLayer.size);if(e)throw new oe.A("graphics3dtextsymbollayer:invalid-size",e)}await this._createTextRenderParameters()}async _createTextRenderParameters(){const e=this._context.graphicsCoreOwner.view.state.rasterPixelRatio;this._textRenderParameters=await j_.fromSymbol(this.symbolLayer,e)}destroy(){super.destroy()}createGraphics3DGraphic(e){const t=e.graphic,i=Bs(t.geometry);if(null==i)return this.logger.warn("unsupported geometry type for text symbol: ".concat(t.geometry.type)),null;const r=this.symbolLayer.text;if(null==r||""===r)return null;const n=(0,Dn.YX)(this.symbol)&&this.symbol.hasVisibleVerticalOffset()?this.symbol.verticalOffset:null;if(null!=n&&!(0,Dn.Ie)(this.symbolLayer))return this.logger.errorOncePerTick("Callouts and vertical offset on text symbols are currently only supported with 'center' horizontal alignment (not with '".concat(this.symbolLayer.horizontalAlignment,"' alignment)")),null;const{verticalAlignment:s}=this.symbolLayer,a=new z_(n);!function(e,t){switch(e){case"top":return(0,Sa.hZ)(t,0,Yh);case"bottom":return(0,Sa.hZ)(t,0,-Yh);default:(0,Sa.C)(t,pr.uY)}}(s,a.screenOffset);const o=new B_(a,this.symbolLayer.horizontalAlignment,function(e){return"middle"===e?"center":e}(s));return this._createAs3DShape(t,i,r,o)}createLabel(e,t,i,r,n){const s=e.graphic,a=Bs(s.geometry);if(null==a)return this.logger.warn("unsupported geometry type for label: ".concat(s.geometry.type)),null;const o=t.text;return!o||/^\s+$/.test(o)?null:this._createAs3DShape(s,a,o,t,i,r,n)}setGraphicElevationContext(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return super.setGraphicElevationContext(e,t),t.addOffsetRenderUnits(i),t}layerOpacityChanged(){return this.logger.warn("layer opacity change not yet implemented in Graphics3DTextSymbolLayer"),!1}layerElevationInfoChanged(e,t){return nv(e,t,((e,t)=>{this.updateGraphicElevationContext(t,e)})),Tt.UPDATE}slicePlaneEnabledChanged(e,t){return nv(e,t,(e=>{for(const t of e.stageObject.geometries)t.material.setParameters({hasSlicePlane:this._context.slicePlaneEnabled})})),!0}physicalBasedRenderingChanged(){return!0}get pixelRatioChanged(){return!1}updateGraphicElevationContext(e,t){const i=t.elevationContext;this.setGraphicElevationContext(e,i,null!=t.metadata?t.metadata.elevationOffset:0),t.needsElevationUpdates=Ft(i.mode)||"absolute-height"===i.mode}_defaultElevationInfoNoZ(){return sv}_createAs3DShape(e,t,i,r){var n;let s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,l=arguments.length>6&&void 0!==arguments[6]?arguments[6]:()=>r.placement.elevationOffset;const c=this.setGraphicElevationContext(e,new oi,r.placement.elevationOffset),d="polyline"===(null===(n=e.geometry)||void 0===n?void 0:n.type),h=e.uid;let u=null,p=null;if(null==a){const e=ou(r.horizontalPlacement);u=new tv(i,e,this._textRenderParameters);let t=null;if(null!=this._context.sharedResources.textures){p=this._context.sharedResources.textures.fromData(u.key,(()=>u.create())),p.texture.events.on("unloaded",(()=>{var e;return null===(e=t)||void 0===e?void 0:e.release()}));const e=this._context.stage.renderView.textureRepository.acquire(p.texture.id);if(null==e||(0,o.$X)(e))return p.release(),null;t=e}}const f=function(e,t){if("baseline"===t.verticalPlacement){const i=su[t.horizontalPlacement],r=null!=e?e.baselineAnchorY:0;return(0,pr.fA)(i,r)}const i=function(e,t){switch(t){case"bottom":return"left"===e?"bottom-left":"right"===e?"bottom-right":"bottom";case"center":return e;case"top":return"left"===e?"top-left":"right"===e?"top-right":"top"}}(t.horizontalPlacement,t.verticalPlacement);return au[i]}(u,r),g={occlusionTest:!0,screenOffset:r.placement.screenOffset,anchorPosition:f,polygonOffset:!0,color:[1,1,1,1],centerOffsetUnits:r.placement.centerOffsetUnits,drawInSecondSlot:!0};if(a?g.textureId=a.id:p&&(g.textureId=p.texture.id),null!=r.placement.verticalOffset){const{screenLength:e,minWorldLength:t,maxWorldLength:i}=r.placement.verticalOffset;g.verticalOffset={screenLength:(0,Ln.Lz)(e),minWorldLength:t||0,maxWorldLength:null!=i?i:1/0}}if(this._context.screenSizePerspectiveEnabled){const{screenSizePerspectiveSettings:e,screenSizePerspectiveSettingsLabels:t}=this._context.sharedResources,i=kh(this._textRenderParameters);g.screenSizePerspective=t.overrideFontHeight(i.maxHeight),g.screenSizePerspectiveAlignment=e}d&&(g.shaderPolygonOffset=1e-4),g.hasSlicePlane=this._context.slicePlaneEnabled;const m=s?((e,t)=>{const i=JSON.stringify(t);let r=e.get(i);return null==r&&(r=new wu(t),e.add(i,r)),r})(s,g):new wu(g),_=r.placement.translation,v=u?(0,pr.fA)(u.displayWidth,u.displayHeight):pr.uY,y=r.placement.centerOffset,b=Zr(m,rv,_,null,v,y,(0,pr.vt)(),null),x=Us(this._context,t,b,c,h);if(null==x)return null;const S=new ls(this,x.object,[b],null==s?[m]:null,p,((t,i,n,s,a,o)=>{const c=l()||r.placement.elevationOffset;return Gn(t,this.setGraphicElevationContext(e,i,c),0,s,a,o)}),c);S.alignedSampledElevation=x.sampledElevation,S.needsElevationUpdates=Ft(c.mode)||"absolute-height"===c.mode,S.getScreenSize=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,pr.vt)();return e[0]=u?u.displayWidth:r.displaySize[0],e[1]=u?u.displayHeight:r.displaySize[1],e};const w=new fs(r.placement.elevationOffset,i);return S.metadata=w,zs(S,t,this._context.elevationProvider),S}},water:mv};const Av={"mesh-3d":{fill:class extends bs{constructor(e,t,i,r){super(e,t,i,r),this._materialInfoCache=new Zp,this._fastUpdateProcessor=new kp,this._textures=new Map,this.ensureDrapedStatus(!1)}async doLoad(){Fn.b.DRAW_MESH_GEOMETRY_NORMALS&&(this._debugVertexNormalMaterial=new rf({color:[1,0,1,1]}),this._debugFaceNormalMaterial=new rf({color:[0,1,1,1]}))}destroy(){super.destroy(),this._textures.forEach((e=>e.unload())),this._context.stage.removeMany(this._materialInfoCache.materials),this._context.stage.removeMany(Array.from(this._textures.values())),this._materialInfoCache.clear(),this._textures.clear(),this._fastUpdateProcessor.destroy(this._context.stage)}get materials(){return this._materialInfoCache.materials}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,wf,"fill on mesh-3d"))return null;const i=this.setGraphicElevationContext(t),r=e.renderingInfo;return this._createAs3DShape(t,r,i,t.uid)}onRemoveGraphic(e){this._fastUpdateProcessor.onRemoveGraphic(e,this._materialInfoCache,this._context)}layerOpacityChanged(e,t){const i=this._getLayerOpacity();this._updateMaterialParameters((e=>{e.material.setParameters({layerOpacity:i});const t=e.material.parameters;this._setMaterialTransparentParameter(t,e),e.material.setParameters({transparent:t.transparent})})),e.forEach((e=>{var r;return null===(r=t(e))||void 0===r?void 0:r.layerOpacityChanged(i,this._context.isAsync)}))}layerElevationInfoChanged(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,Nt)}slicePlaneEnabledChanged(e,t){return this._updateMaterialParameters((e=>{let{material:t}=e;t.setParameters({hasSlicePlane:this._context.slicePlaneEnabled})})),e.forEach((e=>{var i;return null===(i=t(e))||void 0===i?void 0:i.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync)})),!0}physicalBasedRenderingChanged(){const e=this._usePBR();return this._updateMaterialParameters((t=>{let{material:i}=t;return i.setParameters({usePBR:e})})),!0}updateTransform(e,t,i,r){var n;const s=e.fastTransformUpdatesEnabled;switch(r){case Tp.EnableFastUpdates:if(s)return!0;break;case Tp.DisableFastUpdates:if(!s)return!0;break;default:if(!s)return!1}const a=this._context.renderCoordsHelper.spatialReference,o=If,{origin:l,transform:c}=i;if(!(0,Ct.l)(t,(0,M.s)(Rf,l.x,l.y,null!==(n=l.z)&&void 0!==n?n:0),o,a))return!1;switch(r){case Tp.EnableFastUpdates:this._fastUpdateProcessor.enable(e,this._materialInfoCache,this._context);break;case Tp.DisableFastUpdates:this._fastUpdateProcessor.disable(e,this._materialInfoCache,this._context);break;case Tp.UpdateFastLocalOrigin:e.updateFastLocalOrigin(o,c,this._context.localOriginFactory)}const{elevationContext:d}=e;d.centerPointInElevationSR=this._getCenterPointInElevationSR(o);const{elevationProvider:h,renderCoordsHelper:u}=this._context;return e.alignedSampledElevation=Gn(e,d,h.spatialReference,((e,t)=>It(e,h,d,u,t)),u,o),e.updateTransform(o,c,this._context.isAsync),!0}_requiresSymbolVertexColors(){return this._drivenProperties.color||this._drivenProperties.opacity}_colorOrTextureUid(e){return null==e?"-":e instanceof v.A?e.toHex():e.contentHash}_materialPropertiesDefault(e,t){const i=this._requiresSymbolVertexColors(),r=!!e.vertexAttributes.color,n=!!e.vertexAttributes.tangent;return{hasSymbolVertexColors:i,hasVertexColors:r,hasVertexTangents:n,uid:"vc:".concat(r,",vt:").concat(n,",vct").concat(t,",svc:").concat(i)}}_textureTransformUid(e){const{offset:t,scale:i,rotation:r}=null!==e&&void 0!==e?e:Ff;return"".concat(t[0],",").concat(t[1],",").concat(r,",").concat(i[0],",").concat(i[1])}_materialProperties(e,t,i){const r=this._materialPropertiesDefault(e,i);if(!t.material)return r;const{color:n,colorTexture:s,colorTextureTransform:a,normalTexture:o,normalTextureTransform:l,doubleSided:c,alphaCutoff:d,alphaMode:h}=t.material,u=this._colorOrTextureUid(n),p=this._colorOrTextureUid(s),f=this._textureTransformUid(a),g=this._colorOrTextureUid(o),m=this._textureTransformUid(l);if(r.color=n,r.colorTexture=s,r.normalTexture=o,r.uid="".concat(r.uid,",cmuid:").concat(u,",ctmuid:").concat(p,",cttuid:").concat(f,",ntmuid:").concat(g,",nttuid:").concat(m,",ds:").concat(c,",ac:").concat(d,",am:").concat(h),t.material instanceof Mp.A){const{metallic:e,roughness:i,metallicRoughnessTexture:n,metallicRoughnessTextureTransform:s,emissiveColor:o,emissiveTexture:c,emissiveTextureTransform:d,occlusionTexture:h,occlusionTextureTransform:u}=t.material,p=this._colorOrTextureUid(n),f=this._textureTransformUid(s),g=this._colorOrTextureUid(o),m=this._colorOrTextureUid(c),_=this._textureTransformUid(d),v=this._colorOrTextureUid(h),y=this._textureTransformUid(u);r.metallic=e,r.roughness=i,r.metallicRoughnessTexture=n,r.emissiveColor=o,r.emissiveTexture=c,r.occlusionTexture=h,r.colorTextureTransform=this._convertTextureTransform(a),r.normalTextureTransform=this._convertTextureTransform(l),r.emissiveTextureTransform=this._convertTextureTransform(d),r.occlusionTextureTransform=this._convertTextureTransform(u),r.metallicRoughnessTextureTransform=this._convertTextureTransform(s),r.uid="".concat(r.uid,",mrm:").concat(e,",mrr:").concat(i,",mrt:").concat(p,",mrtt:").concat(f,",emuid:").concat(g,",etmuid:").concat(m,",ett:").concat(_,",otmuid:").concat(v,",ott:").concat(y)}return r}_convertTextureTransform(e){if(!e)return null;const{scale:t,offset:i,rotation:r}=e;return{scale:t,offset:i,rotation:(0,U.kU)(r)}}_setInternalColorValueParameters(e,t){t.diffuse=v.A.toUnitRGB(e),t.opacity=e.a}_getLoadableTextureResource(e){var t;return null!==(t=e.data)&&void 0!==t?t:e.url}_getInternalTextureId(e){const t=this._getInternalTexture(e,fe.sf.Opaque);return null===t||void 0===t?void 0:t.id}_getInternalTexture(e,t){const i=this._getLoadableTextureResource(e);if(!i)return null;const r="".concat(e.contentHash,"/").concat(t);let n=this._textures.get(r);if(!n){let s=null;const a=this._context.stage.renderView.renderingContext.parameters.maxMaxAnisotropy,o={wrap:this._castTextureWrap(e.wrap),noUnpackFlip:!0,maxAnisotropy:a,mipmap:a>1};(0,pe.x3)(i)?(s=i.data,o.preMultiplyAlpha=!1,o.encoding=i.encoding):(s=i,o.preMultiplyAlpha=t!==fe.sf.Opaque,o.downsampleUncompressed=this._context.graphicsCoreOwner.view.qualitySettings.graphics3D.uncompressedTextureDownsamplingEnabled),n=new pt.g(s,o),this._textures.set(r,n),n.load(this._context.stage.renderView.renderingContext),this._context.stage.add(n)}return n}_castTextureWrap(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"repeat";if("string"==typeof e){const t=this._castTextureWrapIndividual(e);return{s:t,t:t}}return{s:this._castTextureWrapIndividual(e.horizontal),t:this._castTextureWrapIndividual(e.vertical)}}_castTextureWrapIndividual(e){switch(e){case"clamp":return ft.pF.CLAMP_TO_EDGE;case"mirror":return ft.pF.MIRRORED_REPEAT;default:return ft.pF.REPEAT}}_setInternalMaterialParameters(e,t){var i,r;if(null!=e.color&&this._setInternalColorValueParameters(e.color,t),null!=e.colorTexture){const i=this._getInternalTexture(e.colorTexture,t.textureAlphaMode);i?(t.textureId=i.id,t.textureAlphaPremultiplied=!!i.parameters.preMultiplyAlpha):t.textureId=void 0}e.normalTexture&&(t.normalTextureId=this._getInternalTextureId(e.normalTexture)),e.emissiveColor&&(t.emissiveFactor=v.A.toUnitRGB(e.emissiveColor)),e.emissiveTexture&&(t.emissiveTextureId=this._getInternalTextureId(e.emissiveTexture)),e.occlusionTexture&&(t.occlusionTextureId=this._getInternalTextureId(e.occlusionTexture)),e.metallicRoughnessTexture&&(t.metallicRoughnessTextureId=this._getInternalTextureId(e.metallicRoughnessTexture)),t.colorTextureTransformMatrix=(0,Fp.G)(e.colorTextureTransform),t.normalTextureTransformMatrix=(0,Fp.G)(e.normalTextureTransform);const n=null!=(null===(i=e.normalTextureTransform)||void 0===i?void 0:i.scale)?null===(r=e.normalTextureTransform)||void 0===r?void 0:r.scale:pr.Un;t.scale=[n[0],n[1]],t.occlusionTextureTransformMatrix=(0,Fp.G)(e.occlusionTextureTransform),t.emissiveTextureTransformMatrix=(0,Fp.G)(e.emissiveTextureTransform),t.metallicRoughnessTextureTransformMatrix=(0,Fp.G)(e.metallicRoughnessTextureTransform)}_setExternalMaterialParameters(e){var t,i;const r=this._drivenProperties.color;let n=null!==(t=null===(i=this.symbolLayer.material)||void 0===i?void 0:i.colorMixMode)&&void 0!==t?t:null;if(r)e.externalColor=L.Un;else{var s,a;const t=null!==(s=null===(a=this.symbolLayer.material)||void 0===a?void 0:a.color)&&void 0!==s?s:null;t?e.externalColor=v.A.toUnitRGBA(t):(n=null,e.externalColor=L.Un)}n&&(e.colorMixMode=n),e.castShadows=!!this.symbolLayer.castShadows}_hasTransparentVertexColors(e){const t=e.vertexAttributes.color;if(null==t)return!1;for(let i=3;i<t.length;i+=4)if(255!==t[i])return!0;return!1}_getOrCreateMaterial(e,t){var i,r,n;const s=null===(i=t.material)||void 0===i?void 0:i.color,a=null===(r=t.material)||void 0===r?void 0:r.colorTexture,o=null===(n=t.material)||void 0===n?void 0:n.alphaMode,l="blend"===o,c=!("opaque"===o)&&(this._hasTransparentVertexColors(e)||null!=s&&s.a<1||(null===a||void 0===a?void 0:a.transparent)||l),d=this._materialProperties(e,t,c),h=this._materialInfoCache.byUid(d.uid);if(h)return h.material;const u={uid:d.uid,material:null,isComponentTransparent:c,alphaMode:t.material?t.material.alphaMode:"opaque"},p=(0,me.Jr)({normalTexture:d.normalTexture,metallicRoughnessTexture:d.metallicRoughnessTexture,metallicFactor:d.metallic,roughnessFactor:d.roughness,emissiveTexture:d.emissiveTexture,emissiveFactor:v.A.toUnitRGB(d.emissiveColor),occlusionTexture:d.occlusionTexture}),f={usePBR:this._usePBR(),isSchematic:p,hasVertexColors:d.hasVertexColors,hasSymbolColors:d.hasSymbolVertexColors,hasVertexTangents:d.hasVertexTangents,ambient:I.uY,diffuse:I.Un,opacity:1,doubleSided:!0,doubleSidedType:"winding-order",cullFace:fe.s2.None,layerOpacity:this._getLayerOpacity(),hasSlicePlane:this._context.slicePlaneEnabled,initTextureTransparent:!0};f.mrrFactors=p?[...me.mX]:[d.metallic,d.roughness,me.Rk[2]],t.material&&(f.doubleSided=t.material.doubleSided,f.cullFace=t.material.doubleSided?fe.s2.None:fe.s2.Back,f.textureAlphaCutoff=t.material.alphaCutoff),this._setExternalMaterialParameters(f),this._setMaterialTransparentParameter(f,u),this._setInternalMaterialParameters(d,f);const g=new hn.$U(f);return u.material=g,this._materialInfoCache.set(d.uid,u),this._context.stage.add(g),g}_usePBR(){return this._context.physicalBasedRenderingEnabled}_setMaterialTransparentParameter(e,t){e.transparent=this.needsDrivenTransparentPass||t.isComponentTransparent||e.layerOpacity<1||e.opacity<1||e.externalColor&&e.externalColor[3]<1,"auto"===t.alphaMode?e.textureAlphaMode=e.transparent?fe.sf.MaskBlend:fe.sf.Opaque:e.textureAlphaMode="opaque"===t.alphaMode?fe.sf.Opaque:"mask"===t.alphaMode?fe.sf.Mask:fe.sf.Blend}_addDebugNormals(e,t){const i=t.length,r=e.spatialReference.isGeographic?20015077/180:1,n=.1*Math.max(e.extent.width*r,e.extent.height*r,e.extent.zmax-e.extent.zmin),s=[],a=[],o=[],l=[];for(let u=0;u<i;u++){const e=t[u],i=e.attributes.get(Pt.r.POSITION),r=e.attributes.get(Pt.r.NORMAL),c=i.data,d=i.indices,h=r.data,p=r.indices;for(let t=0;t<d.length;t++){const e=3*d[t],i=3*p[t];for(let t=0;t<3;t++)s.push(c[e+t]);for(let t=0;t<3;t++)s.push(c[e+t]+h[i+t]*n);if(a.push(a.length),a.push(a.length),t%3==0){this._calculateFaceNormal(c,d,t,Tf),this._getFaceVertices(c,d,t,Rf,Ef,Of),(0,M.g)(Rf,Rf,Ef),(0,M.g)(Rf,Rf,Of),(0,M.h)(Rf,Rf,1/3);for(let e=0;e<3;e++)o.push(Rf[e]);for(let e=0;e<3;e++)o.push(Rf[e]+Tf[e]*n);l.push(l.length),l.push(l.length)}}}const c=t[0].transformation,d=new yr.V(this._debugVertexNormalMaterial,[[Pt.r.POSITION,new _r.n(s,a,3,!0)]],null,vr.X.Line);t.push(d),d.transformation=c;const h=new yr.V(this._debugFaceNormalMaterial,[[Pt.r.POSITION,new _r.n(o,l,3,!0)]],null,vr.X.Line);h.transformation=c,t.push(h)}_createAs3DShape(e,t,i,r){const n=e.geometry;if("mesh"!==n.type)return null;const s=this._createGeometryInfo(n,t,r);if(null==s)return null;const{geometries:a,objectTransformation:o}=s;Fn.b.DRAW_MESH_GEOMETRY_NORMALS&&this._addDebugNormals(n,a);const l=new Ps({geometries:a,layerUid:this._context.layer.uid,graphicUid:r,isElevationSource:!0});l.transformation=o;const c=(0,dn.Cc)(this.symbolLayer,{opacity:this._getLayerOpacity()}),d=c?new os(a[0].material,[c],{mergeGeometries:!0,hasSlicePlane:this._context.slicePlaneEnabled}):null,h=new Np(this,l,a,null,null,Gn,i,d);this._fastUpdateProcessor.onAddGraphic(),h.needsElevationUpdates=Nt(i.mode),h.useObjectOriginAsAttachmentOrigin=!0,i.centerPointInElevationSR=this._getCenterPointInElevationSR(l.transformation);const{elevationProvider:u,renderCoordsHelper:p}=this._context;return h.alignedSampledElevation=Gn(h,i,u.spatialReference,((e,t)=>It(e,u,i,p,t)),p),h}_getCenterPointInElevationSR(e){const t=(0,ne.T)(0,0,0,null!=this._context.elevationProvider.spatialReference?this._context.elevationProvider.spatialReference:null);return Ep([e[12],e[13],e[14]],this._context.renderCoordsHelper.spatialReference,t),t}_createComponentNormals(e,t,i,r){switch(i.shading||"flat"){default:case"source":return this._createComponentNormalsSource(e,t,i,r);case"flat":return this._createComponentNormalsFlat(e,r);case"smooth":return this._createComponentNormalsSmooth(e,r)}}_createComponentNormalsSource(e,t,i,r){if(null==t)return this._createComponentNormalsFlat(e,r);let n=!1;if(!i.trustSourceNormals)for(let s=0;s<r.length;s+=3){this._calculateFaceNormal(e,r,s,Tf);for(let e=0;e<3;e++){const i=3*r[s+e];Rf[0]=t[i],Rf[1]=t[i+1],Rf[2]=t[i+2],(0,M.j)(Tf,Rf)<0&&(t[i]=-t[i],t[i+1]=-t[i+1],t[i+2]=-t[i+2],n=!0)}}return new Cf(t,r,n)}_createComponentNormalsFlat(e,t){const i=(0,Y.oe)(t.length),r=new Array(3*t.length);for(let n=0;n<t.length;n+=3){const s=this._calculateFaceNormal(e,t,n,Tf);for(let e=0;e<3;e++)i[n+e]=s[e],r[n+e]=n/3}return new Cf(i,r,!1)}_createComponentNormalsSmooth(e,t){const i={};for(let s=0;s<t.length;s+=3){const r=this._calculateFaceNormal(e,t,s,Tf);for(let e=0;e<3;e++){const n=t[s+e];let a=i[n];a||(a={normal:(0,I.vt)(),count:0},i[n]=a),(0,M.g)(a.normal,a.normal,r),a.count++}}const r=(0,Y.oe)(3*t.length),n=new Array(3*t.length);for(let s=0;s<t.length;s++){const e=i[t[s]];1!==e.count&&((0,M.n)(e.normal,e.normal),e.count=1);for(let t=0;t<3;t++)r[3*s+t]=e.normal[t];n[s]=s}return new Cf(r,n,!1)}_getFaceVertices(e,t,i,r,n,s){const a=3*t[i],o=3*t[i+1],l=3*t[i+2];r[0]=e[a],r[1]=e[a+1],r[2]=e[a+2],n[0]=e[o],n[1]=e[o+1],n[2]=e[o+2],s[0]=e[l],s[1]=e[l+1],s[2]=e[l+2]}_calculateFaceNormal(e,t,i,r){return this._getFaceVertices(e,t,i,Rf,Ef,Of),(0,M.f)(Ef,Ef,Rf),(0,M.f)(Of,Of,Rf),(0,M.b)(Rf,Ef,Of),(0,M.n)(r,Rf),r}_getOrCreateComponents(e){var t;return null!==(t=e.components)&&void 0!==t?t:Lf}_createPositionBuffer(e,t){let i=e.vertexAttributes.position;const r=t.reprojection===Nf.RENDER?t.transformBeforeProject:null;if(r&&(i=(0,Ta.a)(new Float64Array(i.length),i,r)),t.reprojection===Nf.NONE)return t.needsBufferCopy?new Float64Array(i):i;const n=r?i:new Float64Array(i.length);return(0,k.projectBuffer)(i,e.spatialReference,0,n,this._context.renderCoordsHelper.spatialReference,0,i.length/3),n}_createNormalBuffer(e,t,i){let r=e.vertexAttributes.normal;if(null==r)return null;const n=i.reprojection===Nf.RENDER?i.transformBeforeProject:null;if(n&&(r=(0,Lp.qs)(r,new Float32Array(r.length),n)),"local"===this._context.graphicsCoreOwner.view.viewingMode||i.reprojection===Nf.NONE)return i.needsBufferCopy&&e.vertexAttributes.normal===r?new Float32Array(r):r;const s=e.vertexAttributes.position,a=n?r:new Float32Array(r.length);return(0,Lp.X4)(r,s,t,e.spatialReference,a)}_createTangentBuffer(e,t,i){let r=e.vertexAttributes.tangent;if(null==r)return null;const n=i.reprojection===Nf.RENDER?i.transformBeforeProject:null;if(n&&(r=(0,Lp.KM)(r,new Float32Array(r.length),n)),"local"===this._context.graphicsCoreOwner.view.viewingMode||i.reprojection===Nf.NONE)return i.needsBufferCopy&&e.vertexAttributes.normal===r?new Float32Array(r):r;const s=e.vertexAttributes.position,a=n?r:new Float32Array(r.length);return(0,Lp.xA)(r,s,t,e.spatialReference,a)}_createColorBuffer(e){return e.vertexAttributes.color}_createSymbolColorBuffer(e){if(this._requiresSymbolVertexColors()){var t;const i=this._getVertexOpacityAndColor(e),r=(0,qp.Eb)(null===(t=this.symbolLayer)||void 0===t||null===(t=t.material)||void 0===t?void 0:t.colorMixMode),n=new Uint8Array(4);return(0,qp._j)(i,r,n),n}return null}_createBuffers(e,t){const i=e.vertexAttributes&&e.vertexAttributes.position;if(!i)return this.logger.warn("Mesh geometry must contain position vertex attributes"),null;const r=e.vertexAttributes.normal,n=e.vertexAttributes.uv,s=e.vertexAttributes.tangent;if(r&&r.length!==i.length)return this.logger.warn("Mesh normal vertex buffer must contain the same number of elements as the position buffer"),null;if(s&&s.length/4!=i.length/3)return this.logger.warn("Mesh tangent vertex buffer must contain the same number of elements as the position buffer"),null;if(n&&n.length/2!=i.length/3)return this.logger.warn("Mesh uv vertex buffer must contain the same number of elements as the position buffer"),null;const a=this._computeReprojectionInfo(e),o=this._createPositionBuffer(e,a),l=this._createColorBuffer(e),c=this._createSymbolColorBuffer(t),d=this._createNormalBuffer(e,o,a),h=this._createTangentBuffer(e,o,a);return{positionBuffer:o,normalBuffer:d,tangentBuffer:h,uvBuffer:n,colorBuffer:l,symbolColorBuffer:c,objectTransformation:a.reprojection===Nf.NONE&&a.objectTransformation?a.objectTransformation:this._transformOriginLocal(e,o,d,h),geometryTransformation:a.reprojection===Nf.NONE&&a.geometryTransformation?a.geometryTransformation:(0,P.vt)()}}_computeReprojectionInfo(e){const{vertexSpace:t}=e,i="georeferenced"===t.type?(0,G.aI)(this._context.renderCoordsHelper.spatialReference,e.spatialReference)?Nf.NONE:Nf.RENDER:Nf.NONE;if((0,he.Hq)(t)){var r,n;const s=t.origin,a=(0,P.vt)(),o=null!==(r=null===(n=e.transform)||void 0===n?void 0:n.localMatrix)&&void 0!==r?r:P.zK;if(i===Nf.NONE)return(0,Ct.l)(e.spatialReference,s,a,this._context.renderCoordsHelper.spatialReference),{reprojection:i,objectTransformation:a,geometryTransformation:(0,P.o8)(o),needsBufferCopy:!1};const l=(0,T.kN)((0,P.vt)(),s);return(0,T.lw)(l,l,o),{reprojection:i,transformBeforeProject:l,needsBufferCopy:!0}}return{reprojection:i,needsBufferCopy:!0}}_transformOriginLocal(e,t,i,r){var n;const s=this._context.renderCoordsHelper.spatialReference,a=e.anchor;Af[0]=a.x,Af[1]=a.y,Af[2]=null!==(n=a.z)&&void 0!==n?n:0;const o=(0,P.vt)();return(0,Ct.l)(e.spatialReference,Af,o,s),(0,T.B8)(Pf,o),(0,Ta.a)(t,t,Pf),(i||r)&&((0,E.z0)(Mf,o),(0,E.mg)(Mf,Mf),i&&(0,Ta.b)(i,i,Mf),r&&(0,Ta.b)(r,r,Mf,4)),o}_validateFaces(e,t){const i=e.vertexAttributes.position.length/3,r=t.faces;if(r){let e=-1;for(let t=0;t<r.length;t++){const i=r[t];i>e&&(e=i)}if(i<=e)return this.logger.warn("Vertex index ".concat(e," is out of bounds of the mesh position buffer")),!1}else if(i%3!=0)return this.logger.warn("Mesh position buffer length must be a multiple of 9 if no component faces are defined (3 values per vertex * 3 vertices per triangle)"),!1;return!0}_getOrCreateFaces(e,t){var i;return null!==(i=t.faces)&&void 0!==i?i:(0,X.tM)(e.vertexAttributes.position.length/3)}_isOutsideClippingArea(e){var t;if(!this._context.clippingExtent)return!1;const i=null===(t=e.vertexAttributes)||void 0===t?void 0:t.position;if(!i)return!1;const r=this._context.elevationProvider.spatialReference,n=(0,Dp.project)({positions:i,transform:e.transform,vertexSpace:e.vertexSpace,inSpatialReference:e.spatialReference,outSpatialReference:null!==r&&void 0!==r?r:e.spatialReference,localMode:this._context.stage.viewingMode===ae.RT.Local}),s=n.length/3;return(0,q.Ie)(Df),(0,q.Hq)(Df,n,0,s),!(0,q.KG)(Df,this._context.clippingExtent)}_createGeometryInfo(e,t,i){if(!(0,zi.canProjectWithoutEngine)(e.spatialReference,this._context.renderCoordsHelper.spatialReference))return this.logger.warn("Geometry spatial reference is not compatible with the view"),null;if(!this._validateVertexSpace(e))return null;if(this._isOutsideClippingArea(e))return null;const r=this._createBuffers(e,t);if(null==r)return null;const{positionBuffer:n,uvBuffer:s,colorBuffer:a,symbolColorBuffer:o,normalBuffer:l,tangentBuffer:c,objectTransformation:d,geometryTransformation:h}=r,u=this._getOrCreateComponents(e),p=new Array;let f=!1;const g=(0,T.sC)(Rf,d),m=this._context.localOriginFactory.getOrigin(g);for(const _ of u){if(!this._validateFaces(e,_))return null;const t=this._getOrCreateFaces(e,_);if(0===t.length)continue;const r=this._createComponentNormals(n,l,_,t);r.didFlipNormals&&(f=!0);const d=[[Pt.r.POSITION,new _r.n(n,t,3,!0)],[Pt.r.NORMAL,new _r.n(r.normals,r.indices,3,!0)]];a&&d.push([Pt.r.COLOR,new _r.n(a,t,4,!0)]),o&&d.push([Pt.r.SYMBOLCOLOR,new _r.n(o,(0,X.EH)(t.length),4,!0)]),s&&d.push([Pt.r.UV0,new _r.n(s,t,2,!0)]),c&&d.push([Pt.r.TANGENT,new _r.n(c,t,4,!0)]);const u=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:i,layerUid:this._context.layer.uid}),g=this._getOrCreateMaterial(e,_),v=new yr.V(g,d,null,vr.X.Mesh,u);v.transformation=h,v.localOrigin=m,p.push(v)}return f&&this.logger.warn("Normals have been automatically flipped to be consistent with the counter clock wise face winding order. It is better to generate mesh geometries that have consistent normals."),{geometries:p,objectTransformation:d}}_updateMaterialParameters(e){this._materialInfoCache.forEachMaterialInfo(e),this._fastUpdateProcessor.forEachMaterialInfo(e),this._fastUpdateProcessor.forEachClonedMaterial(((e,t)=>{t.setParameters(e.parameters)}))}_validateVertexSpace(e){const{_context:{graphicsCoreOwner:{view:{state:{viewingMode:t}}}}}=this,{vertexSpace:i}=e;return t!==ae.RT.Local||"local"!==i.type||(this.logger.warn("Displaying a mesh with a local vertex space in a view in local viewing mode is not supported."),!1)}test(){return{...super.test(),materials:this._materialInfoCache.materials}}}}};class Rv extends _s{set symbol(e){this._symbol=e,e.symbolLayers.forEach(((t,i)=>{const r=this.symbolLayers[i];null!=r&&(r.symbol=e,r.symbolLayer=t)}))}get symbol(){return this._symbol}constructor(e,t,i){super(t.schedule),this._symbol=e,this._context=t,this._backgroundLayers=i,this._destroyed=!1,this.symbolLayers=new Array,this.referenced=0,this._extentPadding=0}async doLoad(e){let t=this._symbol.symbolLayers;this._extentPadding=0,this._backgroundLayers&&(t=this._backgroundLayers.concat(t));const i=t.length;for(;this.symbolLayers.length<t.length;)this.symbolLayers.push(null);this.symbolLayers.length=t.length;const r=[];for(let n=0;n<i;n++){const s=t.at(n);if(!1===s.enabled)continue;Ev.renderPriority=1-(1+n)/i,Ev.renderPriorityStep=1/i,Ev.ignoreDrivers=s.ignoreDrivers;const a=wv(this.symbol,s,this._context,Ev),l=(0,o.NY)(e,(()=>{this.symbolLayers[n]=null,a.destroy()}));l&&r.push(l),this.symbolLayers[n]=a}if(await(0,ot.jJ)(this.symbolLayers,(async(e,t)=>{if(null!=e)try{await e.load(),this._extentPadding+=Math.max(this._extentPadding,e.extentPadding)}catch{this.symbolLayers[t]=null}})),r.forEach((e=>e.remove())),(0,o.Te)(e),this.symbolLayers.length&&!this.symbolLayers.some((e=>!!e)))throw new Error}getSymbolLayerSize(e){const t=this.symbolLayers[e];return null!=t?t.getCachedSize():null}get extentPadding(){return this._extentPadding}get symbologySnappingSupported(){return this.symbolLayers.some((e=>null===e||void 0===e?void 0:e.queryForSnapping))}createGraphics3DGraphic(e,t){var i;const r=e.graphic,n=this.symbolLayers.map((t=>{var i;return null!==(i=null===t||void 0===t?void 0:t.createGraphics3DGraphic(e))&&void 0!==i?i:null})),s=this._context.arcade||(null===(i=this._context.featureExpressionInfoContext)||void 0===i||null===(i=i.arcade)||void 0===i?void 0:i.modules)||null;return new Ea(r,t||this,n,e.layer,s)}get complexity(){return pn(this.symbolLayers.map((e=>null!=e?e.complexity:null)))}globalPropertyChanged(e,t){const i=this.symbolLayers.length;for(let r=0;r<i;r++){const i=this.symbolLayers[r],n=e=>{const t=e.layers[r];return t instanceof ls?t:null};if(null!=i&&!i.globalPropertyChanged(e,t,n))return!1}return!0}applyRendererDiff(e,t){return this.loadStatus!==ms.LOADED?gs.RecreateSymbol:this.symbolLayers.reduce(((i,r)=>i!==gs.RecreateSymbol&&null!=r?Math.min(i,r.applyRendererDiff(e,t)):i),gs.FastUpdate)}prepareSymbolPatch(e){if(this.loadStatus===ms.FAILED)return;if("partial"!==e.diff.type)return;const t=e.diff.diff;if(!t.symbolLayers||"partial"!==t.symbolLayers.type)return;const i=t.symbolLayers.diff;this.symbolLayers.forEach(((t,r)=>{if(null==t)return;const n=i[r];if(n){const i={diff:n,graphics3DGraphicPatches:[],symbolLayerStatePatches:[]};t.prepareSymbolLayerPatch(i),e.symbolStatePatches.push(...i.symbolLayerStatePatches),i.graphics3DGraphicPatches.length&&e.graphics3DGraphicPatches.push(((e,t)=>{const n=e.layers[r];null!=n&&i.graphics3DGraphicPatches.forEach((e=>e(n,t)))}))}}))}updateGeometry(e,t){return this._updateGeometryOrTransform(e,((e,i)=>e.updateGeometry(i,t)))}updateTransform(e,t,i,r){return this._updateGeometryOrTransform(e,((e,n)=>e.updateTransform(n,t,i,r)))}_updateGeometryOrTransform(e,t){for(let i=0;i<this.symbolLayers.length;i++){const r=this.symbolLayers[i];if(null==r)continue;const n=e.layers[i];if(!n||!t(r,n))return!1}return!0}onRemoveGraphic(e){for(let t=0;t<this.symbolLayers.length;t++){const i=this.symbolLayers[t];if(null==i)continue;const r=e.layers[t];null!=r&&i.onRemoveGraphic(r)}}getFastUpdateStatus(){let e=0,t=0,i=0;return this.symbolLayers.forEach((r=>{null!=r&&(r.loadStatus===ms.LOADING?e++:r.isFastUpdatesEnabled()?i++:t++)})),{loading:e,slow:t,fast:i}}async queryForSnapping(e,t,i,r){const n=this.symbolLayers.filter(b.Ru).filter((e=>null!=e.queryForSnapping)).map((n=>n.queryForSnapping(e,t,i,r))),s=await Promise.all(n);return(0,o.Te)(r),s.flat()}destroy(){if(this.destroyed)console.error("Graphics3DSymbol.destroy called when already destroyed!");else{super.destroy();for(const e of this.symbolLayers)null!=e&&e.destroy();this.symbolLayers.length=0,this._destroyed=!0}}get destroyed(){return this._destroyed}}const Ev=new class{constructor(){this.renderPriority=0,this.renderPriorityStep=1,this.ignoreDrivers=!1}};class Ov extends Rv{constructor(e,t,i){super(e,t,i),this._calloutSymbolLayer=null,this.symbol.hasVisibleCallout()&&(this._calloutSymbolLayer=va(this.symbol,t))}async doLoad(e){const t=this._calloutSymbolLayer?(0,ot.Ke)(this._calloutSymbolLayer.load()):null;try{await super.doLoad(e),(0,o.Te)(e)}catch(r){var i;throw null!==(i=this._calloutSymbolLayer)&&void 0!==i&&i.abortLoad(),r}t&&await t}destroy(){super.destroy(),this._calloutSymbolLayer=(0,le.pR)(this._calloutSymbolLayer)}createGraphics3DGraphic(e,t){const i=super.createGraphics3DGraphic(e,t);if(null!=this._calloutSymbolLayer&&null!=i){const t=this._createCalloutGraphic(e);t&&i.setCalloutGraphic(t)}return i}globalPropertyChanged(e,t){return!!super.globalPropertyChanged(e,t)&&(!this._calloutSymbolLayer||this._calloutSymbolLayer.globalPropertyChanged(e,t,(e=>e.calloutLayer)))}updateGeometry(e,t){const i=super.updateGeometry(e,t);if(i&&this._calloutSymbolLayer){const i=e.calloutLayer;if(i)return this._calloutSymbolLayer.updateGeometry(i,t)}return i}_createCalloutGraphic(e){const t=e.renderingInfo;return e.renderingInfo=new ma(t.renderer,t.symbol),this._calloutSymbolLayer.createGraphics3DGraphic(e)}}class Tv extends _s{constructor(e,t,i){super(t),this.symbol=e,this._convert=i,this.symbologySnappingSupported=!1,this.graphics3DSymbol=null,this.referenced=0}getSymbolLayerSize(e){return null!=this.graphics3DSymbol?this.graphics3DSymbol.getSymbolLayerSize(e):null}get symbolLayers(){return null!=this.graphics3DSymbol?this.graphics3DSymbol.symbolLayers:[]}get extentPadding(){return null!=this.graphics3DSymbol?this.graphics3DSymbol.extentPadding:0}async doLoad(e){const t=await this.symbol.fetchSymbol({signal:e});t.id=this.symbol.id,this.graphics3DSymbol=this._convert(t),null!=this.graphics3DSymbol&&await this.graphics3DSymbol.load()}createGraphics3DGraphic(e){return null!=this.graphics3DSymbol?this.graphics3DSymbol.createGraphics3DGraphic(e,this):null}get complexity(){return null!=this.graphics3DSymbol?this.graphics3DSymbol.complexity:un}globalPropertyChanged(e,t){return null!=this.graphics3DSymbol&&this.graphics3DSymbol.globalPropertyChanged(e,t)}applyRendererDiff(e,t){return null!=this.graphics3DSymbol?this.graphics3DSymbol.applyRendererDiff(e,t):gs.RecreateSymbol}prepareSymbolPatch(e){null!=this.graphics3DSymbol&&this.graphics3DSymbol.prepareSymbolPatch(e)}updateGeometry(e,t){return null!=this.graphics3DSymbol&&this.graphics3DSymbol.updateGeometry(e,t)}updateTransform(e,t,i,r){var n,s;return null!==(n=null===(s=this.graphics3DSymbol)||void 0===s?void 0:s.updateTransform(e,t,i,r))&&void 0!==n&&n}onRemoveGraphic(){}getFastUpdateStatus(){return null!=this.graphics3DSymbol?this.graphics3DSymbol.getFastUpdateStatus():{loading:1,fast:0,slow:0}}destroy(){null!=this.graphics3DSymbol&&this.graphics3DSymbol.destroy(),this.graphics3DSymbol=void 0,super.destroy()}get destroyed(){return void 0===this.graphics3DSymbol}}class Pv{constructor(e,t,i){this.visible=e,this.missing=t,this.pending=i}}class Mv{constructor(e){var t;this._graphicsCore=e,this._idToState=new Map,this._states=new Set;const i=null===(t=e.owner.layer)||void 0===t?void 0:t.objectIdField;i?(this._getGraphicId=e=>(0,ji.RW)(e,i),this._getGraphics3DGraphicById=e=>this._graphicsCore.getGraphics3DGraphicByObjectId(e)):(this._getGraphicId=e=>e.uid,this._getGraphics3DGraphicById=e=>this._graphicsCore.getGraphics3DGraphicById(e))}destroy(){this._idToState.clear(),this._states.forEach(((e,t)=>this.remove(t)))}add(e){const t=(0,w.hA)((()=>this.remove(e)));if(this._states.has(e))return t;const i=this._getGraphicId(e.graphic),r=this._getGraphics3DGraphicById(i);return this._states.has(e)||this._states.add(e),this._ensureStateList(i).push(e),e.displaying=null!=r&&r.isVisible(),e.isDraped=null!=r&&r.isDraped,e.tracking=!0,null!=r&&e.emit("changed"),t}remove(e){if(this._states.has(e)){if(this._idToState.size){const t=this._getGraphicId(e.graphic),i=this._idToState.get(t);i&&((0,b.TF)(i,e),0===i.length&&this._idToState.delete(t))}this._states.delete(e),e.tracking=!1,e.displaying=!1}}addGraphic(e){this._forEachState(e,(t=>{t.displaying=e.isVisible(),t.isDraped=e.isDraped,t.emit("changed")}))}removeGraphic(e){this._forEachState(e,(e=>{e.displaying=!1,e.isDraped=!1}))}updateGraphicGeometry(e){this._forEachState(e,(e=>e.emit("changed")))}updateGraphicVisibility(e){this._forEachState(e,(t=>t.displaying=e.isVisible()))}allGraphicsDeleted(){this._states.forEach((e=>e.displaying=!1))}_ensureStateList(e){const t=this._idToState.get(e);if(t)return t;const i=new Array;return this._idToState.set(e,i),i}_forEachState(e,t){if(0===this._states.size||0===this._idToState.size)return;const i=this._getGraphicId(e.graphic),r=this._idToState.get(i);null!=r&&r.forEach(t)}}var Iv=i(70373);let Dv=class extends s.A{constructor(e){super(e),this._index=new Iv.w(9,(0,h.A)("esri-csp-restrictions")?e=>({minX:e.extent[0],minY:e.extent[1],maxX:e.extent[2],maxY:e.extent[3]}):[".extent[0]",".extent[1]",".extent[2]",".extent[3]"]),this._missing=new Set,this._boundsByFeature=new Map,this.spatialReference=null,this.hasZ=null,this.hasM=null,this.objectIdField=null,this.updating=!1}setup(e){this._addMany(e)}destroy(){this._missing.clear(),this._index=(0,le.pR)(this._index),this._boundsByFeature.clear(),this._boundsByFeature=null}update(){this._missing.size>0&&(this._addMany(Array.from(this._missing.values())),this.updating=!1,this._missing.clear())}get updatingRemaining(){return this._missing.size}queryGraphicUIDsInExtent(e,t,i){null!=t&&t.equals(this.spatialReference)&&(Lv.minX=e[0],Lv.minY=e[1],Lv.maxX=e[2],Lv.maxY=e[3],this.update(),this._index.search(Lv,(e=>i(e.graphic.uid))))}add(e){this._missing.add(e),this.updating=!0}remove(e){if(this._missing.delete(e))return void(this.updating=this._missing.size>0);this._index.remove(e);const t=(0,ji.RW)(e.graphic,this._get("objectIdField"));null!=t&&this._boundsByFeature.delete(t)}_addMany(e){if(0===e.length)return;const t=this._get("objectIdField");for(const i of e){i.computeExtent(this.spatialReference);const e=(0,ji.RW)(i.graphic,t);null!=e&&this._boundsByFeature.set(e,i.extent)}this._index.load(e)}clear(){this._index.clear(),this._missing.clear(),this._boundsByFeature.clear(),this.updating=!1}forEachInBounds(e,t){Lv.minX=e[0],Lv.minY=e[1],Lv.maxX=e[2],Lv.maxY=e[3],this.update(),this._index.search(Lv,(e=>{t(e)}))}getBounds(e,t){this.update();const i=this._boundsByFeature.get(e);return i?(0,q.Jt)(t,i):null}};(0,r._)([(0,d.MZ)({constructOnly:!0})],Dv.prototype,"spatialReference",void 0),(0,r._)([(0,d.MZ)({constructOnly:!0})],Dv.prototype,"hasZ",void 0),(0,r._)([(0,d.MZ)({constructOnly:!0})],Dv.prototype,"hasM",void 0),(0,r._)([(0,d.MZ)({constructOnly:!0})],Dv.prototype,"objectIdField",void 0),(0,r._)([(0,d.MZ)()],Dv.prototype,"updating",void 0),(0,r._)([(0,d.MZ)({readOnly:!0})],Dv.prototype,"updatingRemaining",null),Dv=(0,r._)([(0,u.$)("esri.views.3d.layers.graphics.SpatialIndex2D")],Dv);const Lv={minX:0,minY:0,maxX:0,maxY:0};class Fv{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"scene";this.context=e,this.extent=(0,Q.Ie)()}}const Nv=Symbol("layerHandles");let Vv=class extends(Cn.A.EventedMixin(s.A)){get spatialReference(){var e;return null===(e=this.view)||void 0===e?void 0:e.spatialReference}constructor(e){super(e),this._elevationOffset=0}initialize(){this._renderCoordsHelper=this.view.renderCoordsHelper,this._intersectLayers=[this.stageLayer],this._intersector=Yc(this.view.state.viewingMode),this._intersector.options.store=nc.MIN;const e=this._computeLayerExtent(this.spatialReference,this.stageLayer);this._zmin=e[2],this._zmax=e[5];const t=this.stageLayer.events;this.addHandles([t.on(["layerObjectAdded","layerObjectRemoved","geometryAdded","geometryRemoved"],(e=>{let{object:t}=e;return this._objectChanged(t)})),t.on("attributesChanged",(e=>{let{attribute:t,object:i}=e;return(0,Pt.b)(t)&&this._objectChanged(i)})),t.on(["transformationChanged","shaderTransformationChanged"],(e=>this._objectChanged(e)))],Nv)}dispose(){this.removeHandles(Nv)}elevationInfoChanged(){const e=null!=this.layer?this.layer.elevationInfo:null;if(null!=e&&"on-the-ground"!==e.mode){var t,i;const r=(0,R.G9)(this.layer.spatialReference),n=(0,_.Ao)(null!==(t=e.unit)&&void 0!==t?t:"meters");this._elevationOffset=(null!==(i=e.offset)&&void 0!==i?i:0)*n/r}else this._elevationOffset=0}getElevation(e,t,i,r){if(zv[0]=e,zv[1]=t,zv[2]=i,!this._renderCoordsHelper.toRenderCoords(zv,r,zv))return a.A.getLogger(this).error("could not project point for elevation alignment"),null;const n=this._elevationOffset,s=this._zmin+n,o=this._zmax+n;this._renderCoordsHelper.setAltitude(Bv,o,zv),this._renderCoordsHelper.setAltitude(Hv,s,zv);return this._intersector.reset(Bv,Hv,null),this._intersector.intersect(this._intersectLayers,null,1,null,(e=>!!e.lastValidElevationBB)),this._intersector.results.min.getIntersectionPoint(zv)?this._renderCoordsHelper.getAltitude(zv):null}_objectChanged(e){const t=this.spatialReference;if(!e.lastValidElevationBB||!t)return;(0,q.Ie)(Gv);const i=e.lastValidElevationBB;i.isEmpty()||this._expandExtent(t,i.min,i.max,Gv);const{min:r,max:n}=e.boundingVolumeWorldSpace;this._expandExtent(t,r,n,Gv),(0,q.ES)(Gv,Uv.extent),this._zmin=Math.min(this._zmin,Gv[2]),this._zmax=Math.max(this._zmax,Gv[5]),Uv.spatialReference=t,this.emit("elevation-change",Uv),(0,M.c)(i.min,r),(0,M.c)(i.max,n)}_computeLayerExtent(e,t){return(0,q.Ie)(Gv),null!=e&&t.objects.forAll((t=>this._expandExtent(e,t.boundingVolumeWorldSpace.min,t.boundingVolumeWorldSpace.max,Gv))),Gv}_expandExtent(e,t,i,r){for(let n=0;n<8;++n)zv[0]=1&n?t[0]:i[0],zv[1]=2&n?t[1]:i[1],zv[2]=4&n?t[2]:i[2],this._renderCoordsHelper.fromRenderCoords(zv,zv,e),(0,q.iT)(r,zv);return r}};(0,r._)([(0,d.MZ)({constructOnly:!0})],Vv.prototype,"layer",void 0),(0,r._)([(0,d.MZ)({constructOnly:!0})],Vv.prototype,"stageLayer",void 0),(0,r._)([(0,d.MZ)({constructOnly:!0})],Vv.prototype,"view",void 0),(0,r._)([(0,d.MZ)()],Vv.prototype,"spatialReference",null),Vv=(0,r._)([(0,u.$)("esri.views.3d.layers.support.StageLayerElevationProvider")],Vv);const Gv=(0,q.Ie)(),Uv=new Fv,zv=(0,I.vt)(),Bv=(0,I.vt)(),Hv=(0,I.vt)();var jv,Wv=i(48606),kv=i(2257),Zv=i(13904),qv=i(16911),Qv=i(86659),Jv=i(89579);const Yv=(0,I.vt)(),Xv=(0,q.vt)();let $v=jv=class extends s.A{get _viewSpatialReference(){return this.owner.view.spatialReference}get spatialIndex(){var e;return this._spatialIndex||(this._spatialIndex=new Dv({objectIdField:null===(e=this.owner.layer)||void 0===e?void 0:e.objectIdField,spatialReference:this._viewSpatialReference,hasZ:!!this.hasZ,hasM:!!this.hasM}),this._spatialIndex.setup(Array.from(this.graphics3DGraphics.values()))),this._spatialIndex.update(),this._spatialIndex}get numberOfGraphics(){return this._numberOfGraphics}get effectiveUpdatePolicy(){var e;return null!=this.currentRenderer&&"dictionary"===this.currentRenderer.type?Ao.ASYNC:null!==(e=this._forcedUpdatePolicy)&&void 0!==e?e:this.preferredUpdatePolicy}get featureStore(){return this._featureStore}get initializePromise(){return this._initializePromise}get scaleVisibility(){return this._scaleVisibility}get elevationAlignment(){return this._elevationAlignment}get objectStates(){return this._objectStates}get filterVisibility(){return this._filterVisibility}get updating(){var e,t,i;return!!(this.dataUpdating||null!==(e=this._elevationAlignment)&&void 0!==e&&e.updating||null!==(t=this._scaleVisibility)&&void 0!==t&&t.updating||null!==(i=this._filterVisibility)&&void 0!==i&&i.updating||this._rendererChangeAbortController||this._elevationInfoChangeAbortController||this._frameTaskHandle.updating||this.running)}get dataUpdating(){var e;return!!(this._graphicsWaitingForSymbol.size>0||this._pendingUpdates.size>0||null!==(e=this._spatialIndex)&&void 0!==e&&e.updating||this._updatingPendingLoadedGraphicsChange||this._dataUpdateQueue.running||this._loadingSymbols>0)}get running(){var e;return this._pendingUpdates.size>0||!(null===(e=this._spatialIndex)||void 0===e||!e.updating)||this._dataUpdateQueue.running||this._updateQueue.running}get suspendedOrOutsideOfView(){var e;return this.owner.suspended||!(null===(e=this.owner.suspendInfo)||void 0===e||!e.outsideOfView)}get updatingRemaining(){var e,t;return this.updating?this._pendingUpdates.size+.1*((null===(e=this._spatialIndex)||void 0===e?void 0:e.updatingRemaining)||0)+.1*((null===(t=this._elevationAlignment)||void 0===t?void 0:t.updatingRemaining)||0):0}get displayFeatureLimit(){var e,t,i,r,n;const s=this.owner&&this.owner.view&&this.owner.view.qualitySettings,a=null!==(e=null===s||void 0===s?void 0:s.graphics3D.minTotalNumberOfFeatures)&&void 0!==e?e:0,o=null!==(t=null===s||void 0===s?void 0:s.graphics3D.maxTotalNumberOfFeatures)&&void 0!==t?t:0,l=null!==(i=null===s||void 0===s?void 0:s.graphics3D.maxNumberOfDrawCalls)&&void 0!==i?i:0,c=null!==(r=null===s||void 0===s?void 0:s.graphics3D.maxTotalNumberOfVertices)&&void 0!==r?r:0,d=this.averageSymbolComplexity,h=Math.max(1,null!==(n=null===d||void 0===d?void 0:d.verticesPerFeature)&&void 0!==n?n:1),u=d&&d.drawCallsPerFeature>0&&l>0?l/d.drawCallsPerFeature:o,p=Math.ceil(c/h),f=Math.max(a,Math.min(o,p,u)),g=this._get("displayFeatureLimit");return g&&g.maximumTotalNumberOfVertices===c&&g.averageSymbolComplexity===d&&g.maximumNumberOfFeatures===f?g:new bn(c,f,d)}get averageSymbolComplexity(){const e=function(e){const t=pn(e);return t.numComplexities>0&&(t.verticesPerFeature/=t.numComplexities,t.verticesPerCoordinate/=t.numComplexities,t.drawCallsPerFeature/=t.numComplexities,t.memory.bytesPerFeature/=t.numComplexities,t.memory.bytesPerFeatureLabel/=t.numComplexities,t.memory.resourceBytes/=t.numComplexities,t.memory.draped.bytesPerFeature/=t.numComplexities,t.memory.draped.bytesPerFeatureLabel/=t.numComplexities),t}(this._symbolComplexities),t=this._get("averageSymbolComplexity");return 0===e.numComplexities||null!=t&&(e.estimated&&(t.verticesPerFeature>=e.verticesPerFeature||t.verticesPerCoordinate>=e.verticesPerCoordinate||t.drawCallsPerFeature>=e.drawCallsPerFeature)||t.verticesPerFeature===e.verticesPerFeature&&t.verticesPerCoordinate===e.verticesPerCoordinate&&t.drawCallsPerFeature===e.drawCallsPerFeature)?t:e}get usedMemory(){const e=null!=this.averageSymbolComplexity&&this.labelsEnabled?this.averageSymbolComplexity.memory.bytesPerFeatureLabel*this._numberOfGraphics:0,t=this._getSymbolComplexitiesUsed().reduce(((e,t)=>e+t.memory.resourceBytes),0),i=this.owner.view._stage.renderer,r=this.owner.view.basemapTerrain.overlayManager.renderer,n=Array.from(this._symbols.values()).reduce(((e,t)=>{var n;return e+(null!==(n=null===t||void 0===t?void 0:t.symbolLayers.reduce(((e,t)=>{var n;return e+(null!==(n=null===t||void 0===t?void 0:t.materials.reduce(((e,t)=>{var n,s;return t?e+(null!==(n=null===(s=i.plugins.getMaterialRenderer(t))||void 0===s?void 0:s.usedMemory)&&void 0!==n?n:0)+r.getMemoryForMaterial(t):e}),0))&&void 0!==n?n:0)}),0))&&void 0!==n?n:0)}),0);return this._usedMemory+e+t+n}get usedMemoryPerGraphic(){if(this._usedMemory&&this._numberOfGraphics){const e=this._numberOfGraphics/(this._numberOfGraphics+Math.max(this._pendingAdds,this._pendingRemoves));return this._usedMemory/this._numberOfGraphics*e}if(null!=this.averageSymbolComplexity){const e=this.labelsEnabled?this.averageSymbolComplexity.memory.bytesPerFeatureLabel:0;return this.averageSymbolComplexity.memory.bytesPerFeature+e}return 0}get unprocessedMemoryEstimate(){return(this._pendingAdds-this._pendingRemoves)*this.usedMemoryPerGraphic}get _symbolComplexities(){return this.currentRenderer?this._getSymbolComplexitiesUsedOrRenderer(this.currentRenderer):this._getSymbolComplexitiesUsed()}get visible(){return this._visible}_getConvertedSymbol(e){var t,i;if("web-style"===e.type)return e.clone();const r=this._symbolConversionCache.get(e.id);if(null!=r)return r;const n=(0,Wi.t)(e,{geometryType:null!==(t=null===(i=this.layer)||void 0===i?void 0:i.geometryType)&&void 0!==t?t:void 0,retainId:!0,hasLabelingContext:this._hasLabelingContext(e)}),s=n.symbol||null;return null==s&&n.error&&a.A.getLogger(this).error(n.error.message),this._symbolConversionCache.set(e.id,s),s}_getSymbolComplexitiesUsedOrRenderer(e){if(null==e)return[];const t=e.getSymbols(),i="backgroundFillSymbol"in e?e.backgroundFillSymbol:null;if(!i&&(null===t||void 0===t||!t.length))return[];const r=[],n=this._getSymbolComplexityUsedOrRenderer(i);null!=n&&r.push(n);for(const s of t){const e=this._getSymbolComplexityUsedOrRenderer(s);null!=e&&r.push(e)}return r}_getSymbolComplexityUsedOrRenderer(e){if(null==e)return null;const t=this._symbols.get(e.id);if(null!=t)return t.complexity;const i=this._getConvertedSymbol(e);return null!=i?function(e){return"web-style"===e.type?un:pn(e.symbolLayers.toArray().map((t=>gn(e,t))))}(i):null}_getSymbolComplexitiesUsed(){const e=[];return this._symbols.forEach((t=>{null!=t&&e.push(t.complexity)})),e}get _objectIdField(){return this.layer.objectIdField}constructor(e){super(e),this._propertiesPool=new Wv.M({computedExtent:xp.A},this),this.computedExtent=null,this.currentRenderer=null,this.rendererHasGeometryOperations=!1,this._graphicStateTracking=null,this.graphics3DGraphics=new Map,this.stageLayer=null,this.stage=null,this._graphicsDrapedUids=new Set,this._graphicsBySymbol=new Map,this._symbolConversionCache=new Map,this._symbols=new Map,this._graphicsWithoutSymbol=new Map,this._graphicsWaitingForSymbol=new Map,this._graphicsUpdateId=0,this._frameTaskHandle=Ae.nu,this._dataUpdateQueue=new se.T,this._updateQueue=new se.T,this._suspendSymbolCleanup=!1,this._arcadeOnDemand=null,this._rendererChangeAbortController=null,this._elevationInfoChangeAbortController=null,this._initializeAbortController=null,this._scaleVisibility=null,this._filterVisibility=null,this._spatialIndex=null,this.extentPadding=0,this._updatingPendingLoadedGraphicsChange=null,this._featureStore=null,this._deconflictor=null,this._labeler=null,this._objectStates=null,this._viewElevationProvider=null,this._stageLayerElevationProvider=null,this._sharedSymbolResourcesOwnerHandle=null,this._whenGraphics3DGraphicRequests={},this._pendingUpdates=new Map,this._numberOfGraphics=0,this._numberOfGraphicsProvidingElevation=0,this._pendingAdds=0,this._pendingRemoves=0,this._applyPendingRemovesFirst=!1,this._loadingSymbols=0,this._pendingUpdatesPool=new C.A({allocator:e=>e||new ey,deallocator:e=>(e.clear(),e)}),this._symbolWarningLogged=!1,this._geometryWarningLogged=!1,this._objectIdInvisibleSet=new Set,this._whenSymbolRemoved=new C.A,this.preferredUpdatePolicy=Ao.SYNC,this._forcedUpdatePolicy=null,this.elevationFeatureExpressionEnabled=!0,this.owner=null,this.layer=null,this.graphicSymbolSupported=!0,this.getRenderingInfoWithoutRenderer=!1,this.setUidToIdOnAdd=!0,this.hasZ=null,this.hasM=null,this._usedMemory=0,this._visible=!1,this._startCreateGraphics=!1,this._unusedSymbolsCache=e.owner.view.resourceController.memoryController.newCache("graphics-3d-unused-symbols",(e=>e.destroy())),this.symbolCreationContext=new In(e.owner.view.resourceController.scheduler,((e,t)=>this._updateQueue.push(e,t)))}initialize(){var e;this._featureStore=new Tn({objectIdField:null===(e=this.owner.layer)||void 0===e?void 0:e.objectIdField,hasZ:!!this.hasZ,hasM:!!this.hasM,viewSpatialReference:this._viewSpatialReference,featureSpatialReference:this.owner.featureSpatialReference,getSpatialIndex:()=>this.spatialIndex,forEach:e=>this.graphics3DGraphics.forEach(e)});const t=(e,t,i)=>this.spatialIndex.queryGraphicUIDsInExtent(e,t,i),{componentFactories:i}=this;if(null!=i.elevationAlignment){const e=i.elevationAlignment(this,t);this._elevationAlignment=e}if(null!=i.scaleVisibility){const e=i.scaleVisibility(this,t);this._scaleVisibility=e}if(null!=i.filterVisibility){const e=i.filterVisibility({featureStore:this._featureStore,getFeatureCount:()=>this.graphics3DGraphics.size,updateFeatureVisibilities:e=>this.modifyGraphics3DGraphicVisibilities((t=>t.setVisibilityFlag(Sn.GRAPHIC,xn.FILTER,e((0,ji.RW)(t.graphic,this._objectIdField))))),setAllFeaturesVisibility:e=>this.modifyGraphics3DGraphicVisibilities((t=>t.setVisibilityFlag(Sn.GRAPHIC,xn.FILTER,e))),clearFeaturesVisibility:()=>this.modifyGraphics3DGraphicVisibilities((e=>e.setVisibilityFlag(Sn.GRAPHIC,xn.FILTER,!0)))});this._filterVisibility=e}if(null!=i.deconflictor){const e=i.deconflictor(this);this._deconflictor=e}if(null!=i.labeler&&null!=this._scaleVisibility){const e=i.labeler(this,this._scaleVisibility);this._labeler=e}if(null!=i.objectStates){const e=i.objectStates(this);this._objectStates=e}this._initializeAbortController=new AbortController,this._initializePromise=this._initializeAsync()}async _initializeAsync(){var e,t,i;const r=null===(e=this._initializeAbortController)||void 0===e?void 0:e.signal,n=this.owner.view;this._viewElevationProvider=new wn(this._viewSpatialReference,n),this._initializeStage(n,this.layer.uid);const s=n.sharedSymbolResources;this.symbolCreationContext.sharedResources=s,this._sharedSymbolResourcesOwnerHandle=s.addGraphicsOwner(this.owner),null!=this.currentRenderer&&(this.symbolCreationContext.renderer=this.currentRenderer),this.symbolCreationContext.stage=this.stage,this.symbolCreationContext.streamDataRequester=s.streamDataRequester,this.symbolCreationContext.renderCoordsHelper=n.renderCoordsHelper,this.symbolCreationContext.layer=this.layer,this.symbolCreationContext.graphicsCoreOwner=this.owner,this.symbolCreationContext.localOriginFactory=new ul(n.renderSpatialReference),this.symbolCreationContext.elevationProvider=n.elevationProvider,this.symbolCreationContext.notifyGraphicGeometryChanged=e=>this.notifyGraphicGeometryChanged(e),this.symbolCreationContext.notifyGraphicVisibilityChanged=e=>this.notifyGraphicVisibilityChanged(e);const c=ri(this.layer.elevationInfo,this.elevationFeatureExpressionEnabled);if(this.symbolCreationContext.featureExpressionInfoContext=await ei(c,this._viewSpatialReference,r,a.A.getLogger(this)),(0,o.Te)(r),this.symbolCreationContext.screenSizePerspectiveEnabled=n.screenSizePerspectiveEnabled&&!!this.layer.screenSizePerspectiveEnabled,this.symbolCreationContext.slicePlaneEnabled=!!this.owner.slicePlaneEnabled,this.symbolCreationContext.physicalBasedRenderingEnabled=!(null===(t=this.owner.view.qualitySettings)||void 0===t||!t.physicallyBasedRenderingEnabled),this.symbolCreationContext.skipHighSymbolLods=!(null===(i=this.owner.view.qualitySettings)||void 0===i||null===(i=i.graphics3D)||void 0===i||!i.skipHighSymbolLods),"drapeSourceType"in this.owner){const{owner:e}=this;this.symbolCreationContext.drapeSourceRenderer=n.basemapTerrain.overlayManager.registerGeometryDrapeSource(e),this.addHandles((0,w.hA)((()=>n.basemapTerrain.overlayManager.unregisterDrapeSource(e))))}this.addHandles([(0,l.wB)((()=>this.suspendedOrOutsideOfView),(()=>this._updateQueue.unshift((()=>this._updateLayerVisibility()),null))),(0,l.wB)((()=>{var e,t;return[null===(e=this.layer)||void 0===e?void 0:e.screenSizePerspectiveEnabled,null===(t=this.owner.view)||void 0===t?void 0:t.screenSizePerspectiveEnabled]}),(()=>{var e;const t=n.screenSizePerspectiveEnabled&&!!this.layer.screenSizePerspectiveEnabled;t!==this.symbolCreationContext.screenSizePerspectiveEnabled&&(this.symbolCreationContext.screenSizePerspectiveEnabled=t,null!==(e=this._labeler)&&void 0!==e&&e.reset(),this.recreateAllGraphicsAndSymbols())})),(0,l.wB)((()=>this.owner.slicePlaneEnabled),(e=>this._slicePlaneEnabledChange(!!e))),(0,l.wB)((()=>{var e;return null===(e=this.owner.view.state)||void 0===e?void 0:e.rasterPixelRatio}),(()=>this._pixelRatioChange())),(0,l.wB)((()=>{var e;return!(null===(e=this.owner.view.qualitySettings)||void 0===e||!e.physicallyBasedRenderingEnabled)}),(e=>this._physicalBasedRenderingChange(e))),(0,l.wB)((()=>{var e;return!(null===(e=this.owner.view.qualitySettings)||void 0===e||null===(e=e.graphics3D)||void 0===e||!e.skipHighSymbolLods)}),(e=>this._skipHighSymbolLoDsChange(e))),(0,l.z7)((()=>{var e;return null===(e=n.basemapTerrain)||void 0===e?void 0:e.tilingScheme}),(e=>{if(e.spatialReference.equals(this.symbolCreationContext.overlaySR)||null==n.basemapTerrain.spatialReference||(this.symbolCreationContext.overlaySR=n.basemapTerrain.spatialReference),this.hasHandles("loaded-graphics"))this.recreateAllGraphics();else{const e=()=>{var e;return null===(e=this.owner)||void 0===e?void 0:e.loadedGraphics};this.addHandles([(0,l.on)(e,"change",(e=>{this._graphicsCollectionChanged(e),this._signalUpdatingDuringAsyncLoadedGraphicsChange()}),{onListenerAdd:()=>{this.recreateAllGraphics(),this._signalUpdatingDuringAsyncLoadedGraphicsChange()}})],"loaded-graphics")}}),{initial:!0}),(0,l.wB)((()=>this.effectiveUpdatePolicy),(e=>{null!=this.stageLayer&&(this.stageLayer.updatePolicy=e),this.symbolCreationContext.isAsync=this.effectiveUpdatePolicy===Ao.ASYNC,e===Ao.SYNC&&this.runTask(Ae.Bb)}),l.pc)]),this._frameTaskHandle=n.resourceController.scheduler.registerTask(Ae.W6.GRAPHICS_CORE,this),this.layer&&"featureReduction"in this.layer&&this.addHandles((0,l.wB)((()=>this.layer.featureReduction),(()=>this._deconflictor.featureReductionChange()))),this.notifyChange("averageSymbolComplexity"),this.rendererChange(this.owner.renderer).catch((()=>{})),this._initializeAbortController=null}_abortInitialize(){this._initializeAbortController&&(this._initializeAbortController.abort(),this._initializeAbortController=null)}destroy(){var e,t;this._unusedSymbolsCache.destroy(),this._abortInitialize(),this._abortRendererChange(),this._abortElevationInfoChange(),this._frameTaskHandle.remove(),this._frameTaskHandle=Ae.nu,this._dataUpdateQueue.cancelAll(),this._updateQueue.cancelAll(),null!==(e=this.owner.view)&&void 0!==e&&null!==(e=e.deconflictor)&&void 0!==e&&e.removeGraphicsOwner(this),null!==(t=this.owner.view)&&void 0!==t&&null!==(t=t.labeler)&&void 0!==t&&t.removeGraphicsOwner(this),this._elevationAlignment=(0,le.pR)(this._elevationAlignment),this._scaleVisibility=(0,le.pR)(this._scaleVisibility),this._filterVisibility=(0,le.pR)(this._filterVisibility),this._deconflictor=null,this._labeler=null,this._objectStates=(0,le.pR)(this._objectStates),this.clear(),this._featureStore=(0,le.pR)(this._featureStore),this._updatingPendingLoadedGraphicsChange=(0,le.xt)(this._updatingPendingLoadedGraphicsChange),this._graphicStateTracking=(0,le.pR)(this._graphicStateTracking),this.stage&&(this.stageLayer=(0,le.pR)(this.stageLayer),this.stage=null),this._set("owner",null);for(const i in this._whenGraphics3DGraphicRequests)this._whenGraphics3DGraphicRequests[i].reject(new oe.A("graphic:layer-destroyed","Layer has been destroyed"));this._whenGraphics3DGraphicRequests=null,this._sharedSymbolResourcesOwnerHandle=(0,le.xt)(this._sharedSymbolResourcesOwnerHandle),this._propertiesPool=(0,le.pR)(this._propertiesPool),this._pendingUpdatesPool=null,this._symbolConversionCache.clear(),this._objectIdInvisibleSet.clear(),this._spatialIndex=(0,le.pR)(this._spatialIndex)}clear(){var e,t;null!==(e=this._objectStates)&&void 0!==e&&e.allGraphicsDeleted(),null!=this._graphicStateTracking&&this._graphicStateTracking.allGraphicsDeleted(),this.graphics3DGraphics.forEach((e=>e.destroy())),null!==(t=this._spatialIndex)&&void 0!==t&&t.clear(),this.graphics3DGraphics.clear(),this._numberOfGraphics=0,this._usedMemory=0,this._updateLayerVisibility(),this._symbols.forEach(le.pR),this._symbols.clear(),this._graphicsBySymbol.clear(),this._graphicsWithoutSymbol.clear(),this._graphicsWaitingForSymbol.clear(),this._pendingUpdates.clear(),this._pendingUpdatesPool.clear(),this._pendingAdds=0,this._pendingRemoves=0,this._applyPendingRemovesFirst=!1,this.notifyChange("dataUpdating"),this.notifyChange("running"),this.notifyChange("updatingRemaining"),this._featureStore.events.emit("changed")}_initializeStage(e,t){this.stage=e._stage,this.stageLayer=new Eo(this.stage,{pickable:!this.suspendedOrOutsideOfView,updatePolicy:this.effectiveUpdatePolicy},t);const i=this.stageLayer.events;i.on("transformationChanged",(e=>this.notifyGraphicGeometryChanged(e.graphicUid))),i.on("shaderTransformationChanged",(e=>this.notifyGraphicGeometryChanged(e.graphicUid))),i.on("visibilityChanged",(e=>this.notifyGraphicVisibilityChanged(e.graphicUid))),i.on("geometryAdded",(e=>this.notifyGraphicGeometryChanged(e.object.graphicUid))),i.on("geometryRemoved",(e=>this.notifyGraphicGeometryChanged(e.object.graphicUid))),i.on("attributesChanged",(e=>(0,Pt.b)(e.attribute)&&this.notifyGraphicGeometryChanged(e.object.graphicUid)))}notifyGraphicGeometryChanged(e){if(null==this._graphicStateTracking||null==e)return;const t=this.graphics3DGraphics.get(e);t&&this._graphicStateTracking.updateGraphicGeometry(t)}notifyGraphicVisibilityChanged(e){if(null==this._graphicStateTracking||null==e)return;const t=this.graphics3DGraphics.get(e);t&&this._graphicStateTracking.updateGraphicVisibility(t)}_updateLayerVisibility(){const e=this.displayFeatureLimit.maximumNumberOfFeatures,t=this._numberOfGraphics>e*ty,i=!this.suspendedOrOutsideOfView&&!t;i!==this._visible&&(this._visible=i,i?(this.stageLayer.pickable=!0,this.updateAllGraphicsVisibility()):(this.stageLayer.pickable=!1,this._hideAllGraphics()),this._updateStageLayerVisibility())}_updateStageLayerVisibility(){this.stageLayer.visible=this._visible&&(null==this.layer.opacity||this.layer.opacity>0)}getGraphics3DGraphicById(e){return null!=e?this.graphics3DGraphics.get(e):void 0}getGraphics3DGraphicByObjectId(e){var t;return null!==(t=this.owner.layer)&&void 0!==t&&t.objectIdField?this._findGraphics3DGraphicByObjectId(e):null}_getGraphicObjectID(e){var t;let i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null===(t=this.owner.layer)||void 0===t?void 0:t.objectIdField;return(0,ji.RW)(e,i)}get graphics3DGraphicsByObjectID(){var e;const t=null===(e=this.owner.layer)||void 0===e?void 0:e.objectIdField;if(!t)return;const i=new Map;return this.graphics3DGraphics.forEach((e=>{if(!e)return;const r=e.graphic,n=this._getGraphicObjectID(r,t);null!=n&&i.set(n,e)})),i}get labelsEnabled(){return!(!this._labeler||!this._labeler.layerLabelsEnabled())}async updateLabelingInfo(e){const t=this._deconflictor&&this._deconflictor.labelingInfoChange(e),i=this._labeler&&this._labeler.labelingInfoChange(e);await Promise.allSettled([t,i])}updateVisibilityInfo(){this._deconflictor&&this._deconflictor.labelingInfoChange(),this._labeler&&this._labeler.visibilityInfoChange()}get symbolUpdateType(){if(this._pendingUpdates.size>0)return"unknown";let e=0,t=0;return(0,Ui.Bs)(this._symbols,((i,r)=>{if(null!=i){const n=i.getFastUpdateStatus();if(n.loading>0)return!0;this._graphicsBySymbol.has(r)&&(t+=n.fast,e+=n.slow)}return!1}))?"unknown":t>=0&&0===e?"fast":e>=0&&0===t?"slow":"mixed"}runTask(e){if(this._dataUpdateQueue.runTask(e),this._updateQueue.runTask(e),this._applyPendingUpdates(e),this.notifyChange("running"),this.running||this.notifyChange("dataUpdating"),this.notifyChange("updatingRemaining"),!e.hasProgressed)return k_.G}setObjectIdVisibility(e,t){t?this._objectIdInvisibleSet.delete(e):this._objectIdInvisibleSet.add(e);const i=this._findGraphics3DGraphicByObjectId(e);null!=i&&this._updateUserVisibility(i)}_findGraphics3DGraphicByObjectId(e){return(0,Ui.$n)(this.graphics3DGraphics,(t=>this._getGraphicObjectID(t.graphic)===e))}_updateUserVisibility(e){if(null==e)return!1;const t=e.graphic,i=this._getGraphicObjectID(t),r=t.visible&&!this.owner.suspended&&(null==i||!this._objectIdInvisibleSet.has(i));return e.setVisibilityFlag(Sn.GRAPHIC,xn.USER,r)}_whenGraphics3DGraphic(e){const t=this.graphics3DGraphics.get(e.uid);if(t)return Promise.resolve(t);const i=this._whenGraphics3DGraphicRequests[e.uid];if(i)return i.promise;const r=(0,o.Tw)();return this._whenGraphics3DGraphicRequests[e.uid]=r,r.promise}async _boundsForGraphics3DGraphic(e,t){const i=this._viewSpatialReference,r=this.owner.view.renderSpatialReference,n=this.owner.view.basemapTerrain.spatialReference,s=this._viewElevationProvider?{service:this._viewElevationProvider,useViewElevation:null!=t&&!!t.useViewElevation,minDemResolution:null!=t?t.minDemResolution:null,minDemResolutionForPoints:this.owner.view.resolution}:null,a=await e.getProjectedBoundingBox(((e,t,n)=>(0,k.projectBuffer)(e,r,t,e,i,t,n)),((e,t,r)=>(0,k.projectBuffer)(e,n,t,e,i,t,r)),s,null===t||void 0===t?void 0:t.signal);if(!a)return null;const o=a.boundingBox;if(a.requiresDrapedElevation){const e=this.symbolCreationContext.elevationProvider;if(e){var l;(0,q.gX)(o,Yv);const t=null!==(l=e.getElevation(Yv[0],Yv[1],0,i,"ground"))&&void 0!==l?l:0;o[2]=Math.min(o[2],t),o[5]=Math.max(o[5],t)}}return{boundingBox:o,screenSpaceObjects:a.screenSpaceObjects}}async whenGraphicBounds(e,t){var i;await(0,l.C_)((()=>{var e;return null===(e=this.owner)||void 0===e?void 0:e.loadedGraphics}));const r=null===(i=this.owner.layer)||void 0===i?void 0:i.objectIdField,n=this.owner.loadedGraphics.find((t=>t===e||null!=r&&null!=t.attributes&&e.attributes&&t.attributes[r]===e.attributes[r]));if(!n)throw new oe.A("internal:graphic-not-part-of-view","Graphic is not part of this view");const s=await this._whenGraphics3DGraphic(n);return this._boundsForGraphics3DGraphic(s,t)}computeAttachmentOrigin(e,t){const i=this.graphics3DGraphics.get(e.uid);if(!i)return null;const r=i.computeAttachmentOrigin();if(0===r.render.num&&0===r.draped.num)return null;(0,M.s)(iy,0,0,0);let n=0;if(r.render.num>0){if(!(0,Z.F)(r.render.origin,this.symbolCreationContext.renderCoordsHelper.spatialReference,ry,t))return null;(0,M.g)(iy,iy,ry),n++}if(r.draped.num>0){var s;const[e,i]=r.draped.origin,a=null!==(s=this._viewElevationProvider.getElevation(e,i,"ground"))&&void 0!==s?s:0;if((0,M.s)(ry,e,i,a),!(0,Z.F)(ry,this._viewElevationProvider.spatialReference,ry,t))return null;(0,M.g)(iy,iy,ry),n++}return n>1&&(0,M.h)(iy,iy,1/n),new Zv.A({x:iy[0],y:iy[1],z:iy[2],spatialReference:t})}getSymbolLayerSize(e,t){const i=this._symbols.get(e.id);if(null==i)throw new oe.A("internal:symbol-not-part-of-view","Symbol is not part of this view");const r=e.symbolLayers.indexOf(t);if(-1===r)throw new oe.A("internal:missing-symbol-layer","Symbol layer is not in symbol");const n=i.getSymbolLayerSize(r);if(null==n)throw new oe.A("internal:missing-size","Symbol layer has no valid size");return n}_graphicsCollectionChanged(e){this._startCreateGraphics&&(this.add(e.added),this.remove(e.removed))}graphicUpdateHandler(e){const t=e.graphic.uid,i=this.graphics3DGraphics.get(t);if(null!=i||null!=this._graphicsWithoutSymbol.get(t))switch(e.property){case"visible":this._graphicUpdateVisibleHandler(i);break;case"geometry":this._graphicUpdateGeometryHandler(i,e);break;case"symbol":this._graphicUpdateSymbolHandler(i,e);break;case"attributes":break;case"origin-transform":this._graphicUpdateTransformHandler(i,e)}}_graphicUpdateGeometryHandler(e,t){this._graphicUpdateGeometryOrTransformHandler(e,t,(()=>null!=t.newValue&&null!=e&&e.graphics3DSymbol.updateGeometry(e,t.newValue)));const i=t.graphic.geometry;null!=i&&this._expandComputedExtent(i)}_graphicUpdateTransformHandler(e,t){const i=t.graphic.geometry;this._graphicUpdateGeometryOrTransformHandler(e,t,(()=>null!=t.newValue&&null!=e&&null!=i&&e.graphics3DSymbol.updateTransform(e,i.spatialReference,t.newValue,t.action)))}_graphicUpdateGeometryOrTransformHandler(e,t,i){if(null!=t.graphic.geometry)if(null!=e)i()||this._recreateGraphic(e.graphic);else{var r;const e=null===(r=t.graphic.symbol)||void 0===r?void 0:r.id;if(e){const t=this._symbols.get(e);if(null!=t&&t.loadStatus===ms.LOADING)return}this._recreateGraphic(t.graphic)}else this._recreateGraphic(t.graphic)}_graphicUpdateSymbolHandler(e,t){const i=t.graphic,r=null!=e?e.graphics3DSymbol:null!=t.oldValue?this._symbols.get(t.oldValue.id):null;if(null==r||null==t.newValue)return void this._recreateGraphic(i);const n=r.symbol,s=this._getConvertedSymbol(t.newValue);if(null!=s&&(s.type!==n.type||"web-style"===s.type)||"web-style"===n.type)return void this._recreateGraphic(i);const a=this._graphicsBySymbol.get(n.id);if(a&&1!==a.size)return void this._recreateGraphic(i);const o=(0,Vi.Ui)(n,s);if(null==o)return void this._updateSymbolMapping(n.id,s);const l={diff:o,graphics3DGraphicPatches:[],symbolStatePatches:[]};if(r.prepareSymbolPatch(l),!(0,Vi.Im)(l.diff))return void this._recreateGraphic(i);const c=this._getRenderingInfo(i);if(null==c)return void this._recreateGraphic(i);const d=r.extentPadding;for(const h of l.symbolStatePatches)h();if(d!==r.extentPadding&&this._recomputeExtentPadding(),null!=e)for(const h of l.graphics3DGraphicPatches)h(e,c);this._updateSymbolMapping(n.id,s)}_graphicUpdateVisibleHandler(e){this._updateUserVisibility(e)&&(this._labeler&&this.owner.view.labeler.setDirty(),this.owner.view.deconflictor.setDirty())}recreateGraphics(e){this._suspendSymbolCleanup=!0,this.remove(e),this.add(e),this._suspendSymbolCleanup=!1,this.effectiveUpdatePolicy===Ao.SYNC&&this._cleanupSymbols()}_recreateGraphic(e){this.recreateGraphics([e])}_beginGraphicUpdate(e){const t=this._graphicsUpdateId;return this._graphicsUpdateId++,this._graphicsWaitingForSymbol.set(e.uid,t),1===this._graphicsWaitingForSymbol.size&&this.notifyChange("dataUpdating"),t}_endGraphicUpdate(e){e&&(this._graphicsWaitingForSymbol.delete(e.uid),0===this._graphicsWaitingForSymbol.size&&(this._cleanupSymbols(),this.notifyChange("dataUpdating")))}_recomputeExtentPadding(){let e=0;this._symbols.forEach((t=>{null!=t&&(e=Math.max(e,t.extentPadding))})),this._set("extentPadding",e)}_expandComputedExtent(e){const t=Xv,i=e.spatialReference;(0,ji.w9)(e,t);const r=this._viewSpatialReference,n=jv.tmpVec;if((0,G.aI)(i,r)||(0,Bi.L)(t[0],t[1],0,i,n,r)&&(t[0]=n[0],t[1]=n[1],(0,Bi.L)(t[3],t[4],0,i,n,r),t[3]=n[0],t[4]=n[1]),!(isFinite(t[0])&&isFinite(t[3])&&isFinite(t[1])&&isFinite(t[4])))return;const s=this.computedExtent;let a=null;const o=isFinite(t[2])&&isFinite(t[5]),l=o&&(null==(null===s||void 0===s?void 0:s.zmin)||t[2]<s.zmin),c=o&&(null==(null===s||void 0===s?void 0:s.zmax)||t[5]>s.zmax);s?(t[0]<s.xmin||t[1]<s.ymin||t[3]>s.xmax||t[4]>s.ymax||l||c)&&(a=this._propertiesPool.get("computedExtent"),a.xmin=Math.min(t[0],s.xmin),a.ymin=Math.min(t[1],s.ymin),a.xmax=Math.max(t[3],s.xmax),a.ymax=Math.max(t[4],s.ymax),a.spatialReference=r):(a=this._propertiesPool.get("computedExtent"),a.xmin=t[0],a.ymin=t[1],a.xmax=t[3],a.ymax=t[4],a.spatialReference=r),a&&(l&&(a.zmin=t[2]),c&&(a.zmax=t[5]),this._set("computedExtent",a))}_abortElevationInfoChange(){this._elevationInfoChangeAbortController&&(this._elevationInfoChangeAbortController.abort(),this._elevationInfoChangeAbortController=null)}async elevationInfoChange(){var e,t;this._abortElevationInfoChange();const i=new AbortController;this._elevationInfoChangeAbortController=i;const r=ri(this.layer.elevationInfo,this.elevationFeatureExpressionEnabled);this.symbolCreationContext.featureExpressionInfoContext=await ei(r,this._viewSpatialReference,i.signal,a.A.getLogger(this)),(0,o.Te)(i.signal),this._elevationInfoChangeAbortController=null,null!==(e=this._labeler)&&void 0!==e&&e.elevationInfoChange(),this.forEachGraphics3DSymbol(((e,t,i)=>{e.globalPropertyChanged("elevationInfo",t)?t.forEach((e=>{const t=e.graphic,i=e.labelLayers;for(const r of i)r.graphics3DSymbolLayer.updateGraphicElevationContext(t,r)})):this._recreateSymbol(i)})),this.updateStageLayerElevationProvider(),null===(t=this._elevationAlignment)||void 0===t||t.elevationInfoChange()}updateStageLayerElevationProvider(){this._stageLayerElevationProvider?(this.layer.elevationInfo&&"relative-to-scene"===this.layer.elevationInfo.mode||0===this._numberOfGraphicsProvidingElevation)&&(this.owner.view.elevationProvider.unregister(this._stageLayerElevationProvider),this._stageLayerElevationProvider=(0,le.WD)(this._stageLayerElevationProvider)):(!this.layer.elevationInfo||this.layer.elevationInfo&&"relative-to-scene"!==this.layer.elevationInfo.mode)&&this._numberOfGraphicsProvidingElevation>0&&(this._stageLayerElevationProvider=new Vv({layer:this.layer,stageLayer:this.stageLayer,view:this.owner.view}),this.owner.view.elevationProvider.register("scene",this._stageLayerElevationProvider))}_clearSymbolsAndGraphics(){var e,t,i,r;this.clear(),null!=this._filterVisibility&&this._filterVisibility.clear(),null!==(e=this._labeler)&&void 0!==e&&e.reset(),null!==(t=this._deconflictor)&&void 0!==t&&t.clear(),null!==(i=this._elevationAlignment)&&void 0!==i&&i.clear(),null!==(r=this.stageLayer)&&void 0!==r&&r.invalidateSpatialQueryAccelerator(),this._stageLayerElevationProvider&&(this.owner.view.elevationProvider.unregister(this._stageLayerElevationProvider),this._stageLayerElevationProvider=(0,le.WD)(this._stageLayerElevationProvider))}startCreateGraphics(){this._startCreateGraphics=!0,this.recreateAllGraphics()}recreateAllGraphics(){this._recreateAllGraphics(!1)}recreateAllGraphicsAndSymbols(){this._recreateAllGraphics(!0)}_recreateAllGraphics(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(!this._startCreateGraphics)return;const{loadedGraphics:t,view:i}=this.owner,r=i.basemapTerrain.tilingScheme&&null!==t&&void 0!==t&&t.length?t.toArray():null;!e&&r||this._clearSymbolsAndGraphics(),this.symbolCreationContext.screenSizePerspectiveEnabled=this.owner.view.screenSizePerspectiveEnabled&&!!this.layer.screenSizePerspectiveEnabled,this.symbolCreationContext.slicePlaneEnabled=!!this.owner.slicePlaneEnabled,this._set("computedExtent",null),r&&(e?this.add(r):this.recreateGraphics(r))}_recreateSymbol(e){const t=this._graphicsBySymbol.get(e),i=[];t&&(t.forEach(((e,t)=>{var r;const n=e.usedMemory;this._conditionalRemove(e,t),null!==(r=this._spatialIndex)&&void 0!==r&&r.remove(e),i.push(e.graphic),e.destroy(),this._removeGraphics3DGraphic(t,n),this._updateLayerVisibility(),this._featureStore.events.emit("changed")})),this._graphicsBySymbol.set(e,new Map));const r=this._symbols.get(e);(0,le.pR)(r),this._symbols.delete(e),this.add(i)}_recreateGraphicsForSymbol(e){const t=this._graphicsBySymbol.get(e);if(t){const e=[];t.forEach((t=>e.push(t.graphic))),this.recreateGraphics(e)}}_conditionalRemove(e,t){var i,r,n;this._graphicsDrapedUids.delete(t),null!==(i=this._objectStates)&&void 0!==i&&i.removeGraphic(e),null!==(r=this._labeler)&&void 0!==r&&r.removeGraphic(e),null!==(n=this._deconflictor)&&void 0!==n&&n.removeGraphic(e),null!=this._graphicStateTracking&&this._graphicStateTracking.removeGraphic(e)}add(e){var t;e&&0!==e.length&&(null!==(t=this.owner.view.basemapTerrain)&&void 0!==t&&t.tilingScheme?(this._updatePolicyForGraphics(e)===Ao.ASYNC?this._addDelayed(e):this._addImmediate(e),this.notifyChange("dataUpdating")):a.A.getLogger(this).error("#add()","Cannot add graphics before terrain surface has been initialized"))}_updatePolicyForGraphics(e){if(this.effectiveUpdatePolicy===Ao.SYNC&&("mesh"===this.layer.geometryType||null==this.layer.geometryType))for(const t of e)if(null!=t.geometry&&"mesh"===t.geometry.type&&!t.geometry.loaded)return Ao.ASYNC;return this.effectiveUpdatePolicy}_addImmediate(e){this._geometryWarningLogged=!1,this._symbolWarningLogged=!1;for(const t of e)this._addGraphic(t,this._getRenderingInfo(t,a.A.getLogger(this)),Ao.SYNC);this._cleanupSymbols(),this._labeler&&(this.owner.view.labeler.setDirty(),this._cleanupSymbols()),this.owner.view.deconflictor.setDirty()}_addDelayed(e){for(const i of e){var t;const e=i.uid;let r=this._pendingUpdates.get(e);r?r.add?r.state!==Kv.NEW&&(null===(t=r.abortController)||void 0===t||t.abort()):this._pendingAdds++:(r=this._pendingUpdatesPool.pushNew(),this._pendingAdds++,this._pendingUpdates.set(e,r)),r.add=i}this.notifyChange("running"),this.notifyChange("updatingRemaining"),this.notifyChange("dataUpdating")}remove(e){this.effectiveUpdatePolicy===Ao.ASYNC?this._removeDelayed(e):this._removeImmediate(e),this.notifyChange("dataUpdating")}_removeImmediate(e){for(const t of e)this._removeGraphic(t);this._cleanupSymbols(),this._labeler&&this.owner.view.labeler.setDirty(),this.owner.view.deconflictor.setDirty()}_removeDelayed(e){for(const i of e){var t;const e=i.uid,r=this._pendingUpdates.get(e);if(r)r.add&&(r.remove?r.add=null:this._pendingUpdates.delete(e),r.state===Kv.LOADING&&null!==(t=r.abortController)&&void 0!==t&&t.abort(),this._pendingAdds--);else{const t=this._pendingUpdatesPool.pushNew();t.remove=i,this._pendingUpdates.set(e,t),this._pendingRemoves++,this._applyPendingRemovesFirst=!0}}0===this._pendingUpdates.size&&this._finishPendingUpdates(),this.notifyChange("running"),this.notifyChange("updatingRemaining"),this.notifyChange("dataUpdating")}_finishPendingUpdates(){this._pendingUpdatesPool.clear(),this._cleanupSymbols(),(this._pendingAdds||this._pendingRemoves)&&a.A.getLogger(this).warn("pendingAdds/Removes in inconsistent state!"),this._pendingAdds=0,this._pendingRemoves=0,this._applyPendingRemovesFirst=!1}_applyPendingUpdates(e){var t;if(this._geometryWarningLogged=!1,this._symbolWarningLogged=!1,0===this._pendingUpdates.size&&null!==(t=this._spatialIndex)&&void 0!==t&&t.updating)return this._spatialIndex.update(),void e.madeProgress();if(this._applyPendingRemovesFirst){this._applyPendingRemovesFirst=!1;for(const[t,i]of this._pendingUpdates){if(e.done){this._applyPendingRemovesFirst=!0;break}if(i.remove&&!i.add&&(this._pendingRemoves--,e.madeProgress(),this._removeGraphic(i.remove),i.remove=null,this._pendingUpdates.delete(t),0===this._pendingRemoves))break}}for(const[i,r]of this._pendingUpdates){if(e.done)break;r.add&&r.state===Kv.NEW&&this._processPendingUpdateNew(r);let t=this.effectiveUpdatePolicy;if(!r.remove||r.add&&r.state!==Kv.READY||(this._pendingRemoves--,e.madeProgress(),this._removeGraphic(r.remove),r.remove=null,t=Ao.SYNC),r.add)switch(r.state){case Kv.READY:this._addGraphic(r.add,r.renderingInfo,t),r.add=null,this._pendingAdds--,e.madeProgress();break;case Kv.REJECTED:r.add=null,this._pendingAdds--;case Kv.LOADING:}null==r.remove&&null==r.add&&this._pendingUpdates.delete(i)}0===this._pendingUpdates.size&&(this._finishPendingUpdates(),this.notifyChange("running"),this.notifyChange("dataUpdating"))}_processPendingUpdateNew(e){if(!e.add)return void(e.state=Kv.READY);const t=e.add.geometry;null==t||"mesh"!==t.type||t.loaded?this._processPendingUpdateNewRenderingInfo(e):this._processPendingUpdateNewMesh(e,t)}async _processPendingUpdateNewMesh(e,t){e.state=Kv.LOADING,e.abortController=new AbortController;const i=e.abortController.signal;try{await t.load({signal:i})}catch(r){return this._processPendingUpdateNewError(e,r)}e.abortController=null,this._processPendingUpdateNewRenderingInfo(e)}_processPendingUpdateNewError(e,t){e.abortController=null,(0,o.zf)(t)?e.state=Kv.NEW:e.state=Kv.REJECTED}async _processPendingUpdateNewRenderingInfo(e){var t;if(null==this.layer.renderer||"dictionary"!==this.layer.renderer.type)return e.renderingInfo=this._getRenderingInfo(e.add,a.A.getLogger(this)),void(e.state=Kv.READY);e.state=Kv.LOADING,e.abortController=new AbortController;let i=null;try{i=await this._getRenderingInfoAsync(e.add,{signal:e.abortController.signal})}catch(r){return e.abortController=null,void((0,o.zf)(r)?e.state=Kv.NEW:e.state=Kv.REJECTED)}null==(null===(t=i)||void 0===t?void 0:t.symbol)?(this._symbolWarningLogged||(this._symbolWarningLogged=!0,a.A.getLogger(this).warn("Graphic in layer ".concat(this.layer.id," has no symbol and will not render"))),e.renderingInfo=null):e.renderingInfo=i,e.state=Kv.READY}_addGraphic(e,t,i){if(this._graphicsWithoutSymbol.set(e.uid,e),null==(null===t||void 0===t?void 0:t.symbol)||!(0,ji.N3)(e))return;if(null!=this.stage.renderView.objectAndLayerIdRenderHelper&&this.setUidToIdOnAdd){var r;const t=(0,Fi.ns)(this.owner.view.map,this.layer.uid);this.stage.renderView.objectAndLayerIdRenderHelper.setUidToObjectAndLayerId(e.objectId,e.uid,this.layer.id,this.layer.uid,!!this.layer.popupEnabled&&!t&&(0,kv.d0)(this.layer,null===(r=this.owner.view.popup)||void 0===r?void 0:r.defaultPopupTemplateEnabled))}const n=t.symbol,s=this.getOrCreateGraphics3DSymbol(n,t.renderer);if(null==s)return;this._expandComputedExtent(e.geometry);const a=this._beginGraphicUpdate(e),l=new Mn(e,t,this.layer);let c=!1;const d=e=>{e===s.symbol.id&&(c=!0)};this._whenSymbolRemoved.push(d);const h=()=>{if(--this._loadingSymbols,!this.destroyed){if(this._whenSymbolRemoved.removeUnordered(d),this._graphicsWaitingForSymbol.get(e.uid)!==a||c||s.destroyed||this.graphicSymbolSupported&&e.symbol&&e.symbol.id!==s.symbol.id)--s.referenced,this._cleanupSymbols();else{const t=this._createGraphics3DGraphic(s,l);this._spatialIndex&&null!=t&&this._spatialIndex.add(t),--s.referenced,this._endGraphicUpdate(e)}this._featureStore.events.emit("changed"),this._labeler&&this.owner.view.labeler.setDirty()}},u=t=>{--this._loadingSymbols,this.destroyed||(this._whenSymbolRemoved.removeUnordered(d),c||((0,o.zf)(t)?this.add([e]):s.destroyed||this._endGraphicUpdate(e)))};++this._loadingSymbols,i===Ao.ASYNC?s.load((()=>this._dataUpdateQueue.push(h,null)),(e=>this._dataUpdateQueue.push((()=>u(e)),null))):s.load(h,u)}_removeGraphic(e){const t=e.uid,i=this.graphics3DGraphics.get(t);if(i){var r,n;i.graphics3DSymbol.onRemoveGraphic(i);const e=i.usedMemory,s=i.isElevationSource;this._conditionalRemove(i,t),null===(r=this._spatialIndex)||void 0===r||r.remove(i);const a=i.graphics3DSymbol.symbol.id;null!==(n=this._graphicsBySymbol.get(a))&&void 0!==n&&n.delete(t),this._graphicsWithoutSymbol.delete(t),this._removeGraphics3DGraphic(t,e,s),i.destroy(),this._featureStore.events.emit("changed")}else this._graphicsWithoutSymbol.delete(t),this._graphicsWaitingForSymbol.delete(t),0===this._graphicsWaitingForSymbol.size&&(this._cleanupSymbols(),this.notifyChange("dataUpdating"))}_hasLabelingContext(e){if(e instanceof qv.A||e instanceof Qv.A){const t=this.symbolCreationContext.layer;return!!t.labelingInfo&&t.labelingInfo.some((t=>t.symbol===e))}return!1}_hasValidSymbolCreationContext(e){return!(e instanceof qv.A&&!this._hasLabelingContext(e))||(a.A.getLogger(this).error("LabelSymbol3D is only valid as part of a LabelClass. Using LabelSymbol3D as a renderer symbol is not supported."),!1)}_getRenderingInfo(e,t){var i;const r=e.geometry;if(null==r)return t&&!this._geometryWarningLogged&&(this._geometryWarningLogged=!0,t.warn("Graphic in layer ".concat(this.layer.id," has no geometry and will not render"))),null;if(!(0,zi.canProjectWithoutEngine)(r.spatialReference,this._viewSpatialReference))return t&&!this._geometryWarningLogged&&(this._geometryWarningLogged=!0,t.warn("Graphic in layer ".concat(this.layer.id," has incompatible spatial reference and will not render"))),null;if(!this.graphicSymbolSupported&&null!=e.symbol)return t&&!this._symbolWarningLogged&&(this._symbolWarningLogged=!0,t.warn("Graphic in layer ".concat(this.layer.id," is not allowed to have a symbol, use a renderer instead"))),null;const n=this.rendererHasGeometryOperations?Qt(e,this.layer):e;let s;return s=this.owner.getRenderingInfo&&(this.getRenderingInfoWithoutRenderer||null!=this.currentRenderer)?this.owner.getRenderingInfo(n,this.currentRenderer,this._arcadeOnDemand):{symbol:n.symbol||ar(n.geometry)},null==(null===(i=s)||void 0===i?void 0:i.symbol)?(t&&!this._symbolWarningLogged&&(this._symbolWarningLogged=!0,t.warn("Graphic in layer ".concat(this.layer.id," has no symbol and will not render"))),null):s}_getRenderingInfoAsync(e,t){if(null==e.geometry)return this._geometryWarningLogged||(this._geometryWarningLogged=!0,a.A.getLogger(this).warn("Graphic in layer ".concat(this.layer.id," has no geometry and will not render"))),null;if(!this.graphicSymbolSupported&&null!=e.symbol)return this._symbolWarningLogged||(this._symbolWarningLogged=!0,a.A.getLogger(this).warn("Graphic in layer ".concat(this.layer.id," is not allowed to have a symbol, use a renderer instead"))),null;const i=this.rendererHasGeometryOperations?Qt(e,this.layer):e;return this.owner.getRenderingInfoAsync(i,this.currentRenderer,this._arcadeOnDemand,t)}_createGraphics3DSymbol(e,t){if(!this._hasValidSymbolCreationContext(e))return null;const i=this._getConvertedSymbol(e);if(!i)return null;let r;if(null!=t&&"backgroundFillSymbol"in t&&t.backgroundFillSymbol){const e=(0,Wi.t)(t.backgroundFillSymbol,{ignoreDrivers:!0});null!=e.symbol&&"web-style"!==e.symbol.type&&"cim"!==e.symbol.type&&(r=e.symbol.symbolLayers)}const n=function(e,t,i){return"point-3d"===e.type?new Ov(e,t,i):new Rv(e,t,i)}(i,this.symbolCreationContext,r);return n.load((()=>{const e=n.extentPadding;e>this.extentPadding&&this._set("extentPadding",e),this.notifyChange("averageSymbolComplexity")}),(()=>{})),n}getOrCreateGraphics3DSymbol(e,t){let i=this._symbols.get(e.id);if(void 0===i){const r=this._unusedSymbolsCache.pop(e.id);i=null!=r?r:e instanceof Jv.A?new Tv(e,(e=>this._dataUpdateQueue.push(e,null)),(e=>this._createGraphics3DSymbol(e,t))):this._createGraphics3DSymbol(e,t),this._symbols.set(e.id,i)}return null!=i&&++i.referenced,i}trackGraphicState(e){return null==this._graphicStateTracking&&(this._graphicStateTracking=new Mv(this)),this._graphicStateTracking.add(e)}_addGraphics3DGraphic(e){this._usedMemory+=e.usedMemory,this.graphics3DGraphics.set(e.graphic.uid,e),this._numberOfGraphics++,e.isElevationSource&&(this._numberOfGraphicsProvidingElevation++,this.updateStageLayerElevationProvider()),this._updateLayerVisibility()}_removeGraphics3DGraphic(e,t){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];this._usedMemory-=t,this.graphics3DGraphics.delete(e),this._numberOfGraphics--,i&&(this._numberOfGraphicsProvidingElevation--,this.updateStageLayerElevationProvider()),this._updateLayerVisibility()}_createGraphics3DGraphic(e,t){var i,r,n;const s=t.graphic;if(this._graphicsWithoutSymbol.delete(s.uid),!this._symbols.has(e.symbol.id))return this.add([s]),null;if(this.graphics3DGraphics.has(s.uid))return null;const a=e.createGraphics3DGraphic(t);if(null==a)return null;this._addGraphics3DGraphic(a);const o=e.symbol.id;if(this._graphicsBySymbol.has(o)||this._graphicsBySymbol.set(o,new Map),this._graphicsBySymbol.get(o).set(s.uid,a),a.isDraped&&this._graphicsDrapedUids.add(s.uid),a.centroid=null,null!=s.geometry&&"point"!==s.geometry.type&&(a.centroid=$n(s.geometry,this._viewSpatialReference)),this._updateUserVisibility(a),null!=this._scaleVisibility&&this._scaleVisibility.updateVisibility(a),null!=this._filterVisibility){const{defaultVisibility:e}=this._filterVisibility;a.setVisibilityFlag(Sn.GRAPHIC,xn.FILTER,e),e||this._filterVisibility.reapply()}null!==(i=this._deconflictor)&&void 0!==i&&i.addGraphic(a),null!==(r=this._labeler)&&void 0!==r&&r.addGraphic(a),null!==(n=this._objectStates)&&void 0!==n&&n.addGraphic(a),this._deconflictor&&this.owner.view.deconflictor.setInitialIconVisibilityFlag(this,a),a.initialize(this.stageLayer,this.owner),null!=this._graphicStateTracking&&this._graphicStateTracking.addGraphic(a);const l=this._whenGraphics3DGraphicRequests[s.uid];return l&&(delete this._whenGraphics3DGraphicRequests[s.uid],l.resolve(a)),a}_abortRendererChange(){this._rendererChangeAbortController&&(this._rendererChangeAbortController.abort(),this._rendererChangeAbortController=null)}async rendererChange(e){if(this._abortRendererChange(),e!==this.currentRenderer)if(this._validateRenderer(e),null==e&&this._currentRendererChange(null,!1),ki(e))if(null!=e&&e.arcadeRequired){const t=new AbortController;this._rendererChangeAbortController=t;const{arcadeUtils:i}=await this._ensureArcade();(0,o.Te)(t);const r=i.hasGeometryOperations(e);r&&(await i.enableGeometryOperations(),(0,o.Te)(t)),this.effectiveUpdatePolicy===Ao.ASYNC?await this._updateQueue.push((()=>this._currentRendererChange(e,r)),t.signal):this._currentRendererChange(e,r),this._rendererChangeAbortController=null}else if(this.effectiveUpdatePolicy===Ao.ASYNC){const t=new AbortController;this._rendererChangeAbortController=t,await this._updateQueue.push((()=>this._currentRendererChange(e,!1)),t.signal),this._rendererChangeAbortController=null}else this._currentRendererChange(e,!1);else this._currentRendererChange(e,!1)}async _ensureArcade(){return null==this._arcadeOnDemand?(this._arcadeOnDemand=await(0,Kt.lw)(),this._arcadeOnDemand):this._arcadeOnDemand}_currentRendererChange(e,t){var i;this.currentRenderer=e,this.rendererHasGeometryOperations=t,this.symbolCreationContext.arcade=this._arcadeOnDemand;const r=this.symbolCreationContext.renderer;if(e===r)return;if(this._symbolConversionCache.clear(),this._unusedSymbolsCache.clear(),null==e)return this.symbolCreationContext.renderer=null,void this.recreateAllGraphicsAndSymbols();const n=(0,Vi.Ui)(r,e);this._updateUnchangedSymbolMappings(n,e,r),this.symbolCreationContext.renderer=e,null!=n&&("complete"===n.type?this.recreateAllGraphicsAndSymbols():"partial"===n.type&&(this._applyRendererDiff(n,e,r)?null===(i=this._labeler)||void 0===i||i.reset():this.recreateAllGraphicsAndSymbols()),this.notifyChange("averageSymbolComplexity"))}_diffHasSymbolChange(e){for(const t in e.diff)switch(t){case"visualVariables":case"defaultSymbol":case"uniqueValueInfos":break;case"uniqueValueGroups":case"authoringInfo":case"fieldDelimiter":delete e.diff[t];break;default:return!0}return!1}_applySymbolSetDiff(e,t,i){e=e||[],t=t||[];const r=[];for(const n of t){const t=this._graphicsBySymbol.get(n.id);t&&t.forEach(((s,a)=>{const o=s.graphic,l=this.layer instanceof Hi.A?this.layer:null,c=this._arcadeOnDemand;if(n===i.defaultSymbol&&i.getSymbol(Qt(o,l),{arcade:c})===i.defaultSymbol)return;const d=s.usedMemory;e.length||i.defaultSymbol?r.push(o):this._graphicsWithoutSymbol.set(a,o);const h=this.graphics3DGraphics.get(a);this._conditionalRemove(h,a),s.destroy(),t.delete(a),this._removeGraphics3DGraphic(a,d),this._updateLayerVisibility()})),this._whenSymbolRemoved.forAll((e=>e(n.id)))}(e.length||r.length)&&(this._graphicsWithoutSymbol.forEach((e=>r.push(e))),this._graphicsWithoutSymbol.clear(),this.add(r)),this._cleanupSymbols(),this._labeler&&this.owner.view.labeler.setDirty(),this.owner.view.deconflictor.setDirty()}_applyUniqueValueRendererDiff(e,t,i){const r=e.diff.defaultSymbol,n=e.diff.uniqueValueInfos;if(r||n){const s=n?n.added.map((e=>e.symbol)).filter(b.Ru):[],a=n?n.removed.map((e=>e.symbol)).filter(b.Ru):[];if(n)for(let e=0;e<n.changed.length;e++)s.push(n.changed[e].newValue.symbol),a.push(n.changed[e].oldValue.symbol);return r?(i.defaultSymbol&&a.push(i.defaultSymbol),t.defaultSymbol&&s.push(t.defaultSymbol)):i.defaultSymbol&&s.length&&a.push(t.defaultSymbol),this._applySymbolSetDiff(s,a,t),delete e.diff.defaultSymbol,delete e.diff.uniqueValueInfos,!0}return!1}_calculateUnchangedSymbolMapping(e,t,i){if("unique-value"!==(null===t||void 0===t?void 0:t.type)||"unique-value"!==(null===i||void 0===i?void 0:i.type)||null!=e&&"partial"!==e.type)return[];const r=e=>null!=e?e.id:null,n=e&&e.diff,s=null===n||void 0===n?void 0:n.defaultSymbol,a=n&&n.uniqueValueInfos;let o;if(a)o=a.unchanged.map((e=>({oldId:r(e.oldValue.symbol),newId:r(e.newValue.symbol)})));else{o=[];for(const e of null!==(l=i.uniqueValueInfos)&&void 0!==l?l:[]){var l,c;const i=r(e.symbol),n=null===(c=t.uniqueValueInfos)||void 0===c?void 0:c.find((t=>t.value===e.value));n&&i!==r(n.symbol)&&o.push({oldId:i,newId:r(n.symbol)})}}return!s&&i.defaultSymbol&&o.push({oldId:r(i.defaultSymbol),newId:r(t.defaultSymbol)}),o}_updateSymbolMapping(e,t){const i=null!=t&&t?"string"==typeof t?t:t.id:null;if(null==e||e===i)return;const r=this._graphicsBySymbol.get(e);this._graphicsBySymbol.delete(e),void 0!==r&&this._graphicsBySymbol.set(i,r);const n=this._symbols.get(e);if(void 0!==n&&(this._symbols.delete(e),this._symbols.set(i,n),null!=n)){const e="string"==typeof t?null:t;null!=e?n.symbol=e:n.symbol.id=i}}_updateUnchangedSymbolMappings(e,t,i){const r=this._calculateUnchangedSymbolMapping(e,t,i);for(const{oldId:n,newId:s}of r)this._updateSymbolMapping(n,s)}_applyRendererDiff(e,t,i){if(this._diffHasSymbolChange(e))return!1;if(t instanceof Gi.A&&i instanceof Gi.A&&this._applyUniqueValueRendererDiff(e,t,i)&&0===Object.keys(e.diff).length)return!0;for(const[r]of this._graphicsBySymbol){const i=this._symbols.get(r);if(null!=i)switch(i.applyRendererDiff(e,t)){case gs.RecreateSymbol:this._recreateSymbol(r);break;case gs.RecreateGraphics:this._recreateGraphicsForSymbol(r);case gs.FastUpdate:}}return!0}opacityChange(){this.forEachGraphics3DSymbol(((e,t)=>e.globalPropertyChanged("opacity",t))),this._updateStageLayerVisibility()}_slicePlaneEnabledChange(e){e!==this.symbolCreationContext.slicePlaneEnabled&&(this.symbolCreationContext.slicePlaneEnabled=e,this.stageLayer.sliceable=e,this.forEachGraphics3DSymbol(((e,t)=>e.globalPropertyChanged("slicePlaneEnabled",t))),this._deconflictor&&this._deconflictor.slicePlaneEnabledChange(),this._labeler&&this._labeler.slicePlaneEnabledChange())}_physicalBasedRenderingChange(e){this.symbolCreationContext.physicalBasedRenderingEnabled=e,this.forEachGraphics3DSymbol(((e,t,i)=>{e.globalPropertyChanged("physicalBasedRenderingEnabled",t)||this._recreateSymbol(i)}))}_skipHighSymbolLoDsChange(e){this.symbolCreationContext.skipHighSymbolLods=e,this.forEachGraphics3DSymbol(((e,t,i)=>{e.globalPropertyChanged("skipHighSymbolLods",t)||this._recreateSymbol(i)}))}_pixelRatioChange(){this.forEachGraphics3DSymbol(((e,t,i)=>{e.globalPropertyChanged("pixelRatio",t)||this._recreateSymbol(i)}))}_signalUpdatingDuringAsyncLoadedGraphicsChange(){this._updatingPendingLoadedGraphicsChange&&this._updatingPendingLoadedGraphicsChange.remove(),this._updatingPendingLoadedGraphicsChange=(0,c._)((()=>{this._updatingPendingLoadedGraphicsChange=null}))}setClippingExtent(e,t){const i=this.symbolCreationContext.clippingExtent,r=(0,Q.vt)();return vi(e,r,t)?this.symbolCreationContext.clippingExtent=(0,q.Jt)((0,q.vt)(),r):this.symbolCreationContext.clippingExtent=null,!(0,q.aI)(this.symbolCreationContext.clippingExtent,i)}modifyGraphics3DGraphicVisibilities(e){var t,i;if(this.destroyed)return;let r=!1;this.graphics3DGraphics.forEach((t=>{e(t)&&(r=!0)})),r&&(null!==(t=this.owner.view.labeler)&&void 0!==t&&t.setDirty(),null===(i=this.owner.view.deconflictor)||void 0===i||i.setDirty())}forEachGraphics3DSymbol(e){for(const[t,i]of this._symbols){if(null==i)return;e(i,this._graphicsBySymbol.get(t)||ny,t)}}updateAllGraphicsVisibility(){null!=this._filterVisibility&&this._filterVisibility.reapply(),this.modifyGraphics3DGraphicVisibilities((e=>{const t=this._updateUserVisibility(e),i=null!=this._scaleVisibility&&this._scaleVisibility.updateVisibility(e);return t||i}))}_hideAllGraphics(){this.modifyGraphics3DGraphicVisibilities((e=>e.setVisibilityFlag(Sn.GRAPHIC,xn.USER,!1)))}_validateRenderer(e){var t;const i=Zi(e,{geometryType:null===(t=this.layer)||void 0===t?void 0:t.geometryType});if(i){const e="Renderer for layer '".concat(this.layer.title?"".concat(this.layer.title,", "):"",", id:").concat(this.layer.id,"' is not supported in a SceneView");a.A.getLogger(this).warn(e,i.message)}}_cleanupSymbols(){if(this._graphicsWaitingForSymbol.size>0||this._suspendSymbolCleanup)return;let e=!1;this._symbols.forEach(((t,i)=>{if(null==t||t.referenced>0)return;const r=this._graphicsBySymbol.get(i);r&&0!==r.size||(this._graphicsBySymbol.delete(i),this._symbols.delete(i),this._unusedSymbolsCache.put(i,t,function(e){return 2216+4096*e.symbolLayers.length+e.complexity.memory.resourceBytes}(t),ce.Ti),e=!0)})),e&&(this._recomputeExtentPadding(),this.notifyChange("averageSymbolComplexity"))}get test(){return{snapshotInternals:()=>({graphics:[...this.graphics3DGraphics.keys()].sort(),symbols:[...this._symbols.keys()].sort(),graphicsBySymbol:[...this._graphicsBySymbol.keys()].sort().map((e=>({symbolId:e,graphics:[...this._graphicsBySymbol.get(e).keys()].sort()}))),graphicsWithoutSymbol:[...this._graphicsWithoutSymbol.keys()].sort(),graphicsDrapedUids:[...this._graphicsDrapedUids].sort(),pendingUpdates:this._pendingUpdates}),symbols:this._symbols,filterVisibility:this._filterVisibility,numPending:this._pendingUpdates.size,forceUpdatePolicy:e=>{this._forcedUpdatePolicy=e}}}get performanceInfo(){return new Pv(this.graphics3DGraphics.size,this._graphicsWithoutSymbol.size,this._pendingUpdates.size)}};var Kv;$v.tmpVec=(0,I.vt)(),(0,r._)([(0,d.MZ)({readOnly:!0})],$v.prototype,"computedExtent",void 0),(0,r._)([(0,d.MZ)()],$v.prototype,"currentRenderer",void 0),(0,r._)([(0,d.MZ)()],$v.prototype,"rendererHasGeometryOperations",void 0),(0,r._)([(0,d.MZ)()],$v.prototype,"_frameTaskHandle",void 0),(0,r._)([(0,d.MZ)()],$v.prototype,"_dataUpdateQueue",void 0),(0,r._)([(0,d.MZ)()],$v.prototype,"_updateQueue",void 0),(0,r._)([(0,d.MZ)({readOnly:!0})],$v.prototype,"_viewSpatialReference",null),(0,r._)([(0,d.MZ)()],$v.prototype,"_rendererChangeAbortController",void 0),(0,r._)([(0,d.MZ)()],$v.prototype,"_elevationInfoChangeAbortController",void 0),(0,r._)([(0,d.MZ)()],$v.prototype,"_initializeAbortController",void 0),(0,r._)([(0,d.MZ)()],$v.prototype,"_elevationAlignment",void 0),(0,r._)([(0,d.MZ)()],$v.prototype,"_scaleVisibility",void 0),(0,r._)([(0,d.MZ)()],$v.prototype,"_filterVisibility",void 0),(0,r._)([(0,d.MZ)()],$v.prototype,"_initializePromise",void 0),(0,r._)([(0,d.MZ)()],$v.prototype,"_spatialIndex",void 0),(0,r._)([(0,d.MZ)({readOnly:!0})],$v.prototype,"extentPadding",void 0),(0,r._)([(0,d.MZ)()],$v.prototype,"_updatingPendingLoadedGraphicsChange",void 0),(0,r._)([(0,d.MZ)()],$v.prototype,"_featureStore",void 0),(0,r._)([(0,d.MZ)()],$v.prototype,"_deconflictor",void 0),(0,r._)([(0,d.MZ)()],$v.prototype,"_labeler",void 0),(0,r._)([(0,d.MZ)()],$v.prototype,"_objectStates",void 0),(0,r._)([(0,d.MZ)()],$v.prototype,"_loadingSymbols",void 0),(0,r._)([(0,d.MZ)()],$v.prototype,"preferredUpdatePolicy",void 0),(0,r._)([(0,d.MZ)()],$v.prototype,"_forcedUpdatePolicy",void 0),(0,r._)([(0,d.MZ)({readOnly:!0})],$v.prototype,"effectiveUpdatePolicy",null),(0,r._)([(0,d.MZ)({constructOnly:!0})],$v.prototype,"elevationFeatureExpressionEnabled",void 0),(0,r._)([(0,d.MZ)({constructOnly:!0})],$v.prototype,"owner",void 0),(0,r._)([(0,d.MZ)({constructOnly:!0})],$v.prototype,"layer",void 0),(0,r._)([(0,d.MZ)({constructOnly:!0})],$v.prototype,"graphicSymbolSupported",void 0),(0,r._)([(0,d.MZ)({constructOnly:!0})],$v.prototype,"getRenderingInfoWithoutRenderer",void 0),(0,r._)([(0,d.MZ)({constructOnly:!0})],$v.prototype,"componentFactories",void 0),(0,r._)([(0,d.MZ)({constructOnly:!0})],$v.prototype,"setUidToIdOnAdd",void 0),(0,r._)([(0,d.MZ)()],$v.prototype,"featureStore",null),(0,r._)([(0,d.MZ)()],$v.prototype,"initializePromise",null),(0,r._)([(0,d.MZ)()],$v.prototype,"scaleVisibility",null),(0,r._)([(0,d.MZ)()],$v.prototype,"elevationAlignment",null),(0,r._)([(0,d.MZ)()],$v.prototype,"objectStates",null),(0,r._)([(0,d.MZ)()],$v.prototype,"filterVisibility",null),(0,r._)([(0,d.MZ)({readOnly:!0})],$v.prototype,"updating",null),(0,r._)([(0,d.MZ)({readOnly:!0})],$v.prototype,"dataUpdating",null),(0,r._)([(0,d.MZ)({readOnly:!0})],$v.prototype,"running",null),(0,r._)([(0,d.MZ)({readOnly:!0})],$v.prototype,"suspendedOrOutsideOfView",null),(0,r._)([(0,d.MZ)({readOnly:!0,dependsOn:[]})],$v.prototype,"updatingRemaining",null),(0,r._)([(0,d.MZ)({readOnly:!0})],$v.prototype,"displayFeatureLimit",null),(0,r._)([(0,d.MZ)({readOnly:!0,dependsOn:[]})],$v.prototype,"averageSymbolComplexity",null),(0,r._)([(0,d.MZ)({constructOnly:!0})],$v.prototype,"hasZ",void 0),(0,r._)([(0,d.MZ)({constructOnly:!0})],$v.prototype,"hasM",void 0),(0,r._)([(0,d.MZ)()],$v.prototype,"_objectIdField",null),$v=jv=(0,r._)([(0,u.$)("esri.views.3d.layers.graphics.Graphics3DCore")],$v),function(e){e[e.NEW=0]="NEW",e[e.LOADING=1]="LOADING",e[e.READY=2]="READY",e[e.REJECTED=3]="REJECTED"}(Kv||(Kv={}));class ey{constructor(){this.add=null,this.renderingInfo=null,this.state=Kv.NEW,this.abortController=null,this.remove=null}clear(){this.add=null,this.renderingInfo=null,this.state=Kv.NEW,this.abortController=null,this.remove=null}}const ty=10,iy=(0,I.vt)(),ry=(0,I.vt)(),ny=new Map;let sy=class extends s.A{constructor(e){super(e),this._scaleRangeActive=!1,this._layerScaleRangeVisibilityQuery=!1,this._extent=null,this._updatingHandles=new F.U,this.graphicsCoreOwner=null,this.layer=null,this.queryGraphicUIDsInExtent=null,this.graphicsCore=null,this.basemapTerrain=null,this.layerScaleEnabled=!0,this.suspended=!1,this._dirty=!0}initialize(){this.updateScaleRangeActive();const e=this.graphicsCoreOwner.view.resourceController.scheduler;this.addHandles(e.registerTask(Ae.W6.SCALE_VISIBILITY,this)),this._updatingHandles.add((()=>this.layer.effectiveScaleRange),(()=>this.layerMinMaxScaleChangeHandler()))}destroy(){this._updatingHandles.destroy(),this.removeHandles(),this._dirty=!1,this._extent=null,this.graphicsCoreOwner=null,this.layer=null,this.queryGraphicUIDsInExtent=null,this.graphicsCore=null,this.basemapTerrain=null}get updating(){return this._dirty||this._updatingHandles.updating}_setDirty(){this._dirty=!0}setExtent(e){const t=this.graphicsCoreOwner.view.spatialReference,i=this.graphicsCoreOwner.view.basemapTerrain.spatialReference;if(t===i)this._extent=null!==e&&void 0!==e?e:null;else{const r=(0,Q.vt)();ee(e,t,r,i)?this._extent=r:this._extent=null}this._setDirty()}scaleRangeActive(){return this._scaleRangeActive}updateScaleRangeActive(){const e=this.layer,t=e.effectiveScaleRange;let i=this.layerScaleEnabled&&null!=t&&ay(t.minScale,t.maxScale);e.labelingInfo&&!i&&(i=e.labelingInfo.some((e=>{var t,i;return e&&ay(null!==(t=e.minScale)&&void 0!==t?t:0,null!==(i=e.maxScale)&&void 0!==i?i:0)})));const r=this._scaleRangeActive!==i;return this._scaleRangeActive=i,i&&!this.hasHandles(oy)&&this.basemapTerrain?(this.addHandles(this.basemapTerrain.on("scale-change",(e=>this._scaleUpdateHandler(e))),oy),this.layerScaleEnabled&&this.addHandles(this.basemapTerrain.on("tiles-visibility-changed",(()=>this._setDirty())),oy)):!i&&this.hasHandles(oy)&&this.removeHandles(oy),r}get running(){return!(!this.graphicsCoreOwner.view.basemapTerrain||!this.updating)}runTask(e){const t=this.graphicsCoreOwner.view.basemapTerrain;if(this._extent&&t&&t.ready&&this._scaleRangeActive&&this.layerScaleEnabled){if(this._layerScaleRangeVisibilityQuery)return k_.G;{this._layerScaleRangeVisibilityQuery=!0;const{minScale:e,maxScale:i}=this.layer.effectiveScaleRange;t.queryVisibleScaleRange(this._extent,e,i,(e=>this._finishUpdate(e)))}}else this._finishUpdate(!0);e.madeProgress()}_finishUpdate(e){this._layerScaleRangeVisibilityQuery=!1,this._set("suspended",!e),this._dirty=!1}_visibleAtLayerScale(e){const t=this.layer.effectiveScaleRange;return!this.layerScaleEnabled||(0,wi.JU)(e,t.minScale||0,t.maxScale||0)}_visibleAtLabelScale(e,t){return(0,wi.JU)(e,t.minScale||0,t.maxScale||0)}_graphicScale(e){let t;return null!=e.centroid?t=e.centroid:null!=e.graphic.geometry&&"point"===e.graphic.geometry.type&&(t=e.graphic.geometry),t?this.graphicsCoreOwner.view.basemapTerrain?this.graphicsCoreOwner.view.basemapTerrain.getScale(t):1:null}_graphicVisible(e){if(!this.layerScaleEnabled)return!0;const t=this._graphicScale(e);return this._visibleAtLayerScale(t)}updateVisibility(e){if(this._scaleRangeActive){const t=this._graphicVisible(e);return e.setVisibilityFlag(Sn.GRAPHIC,xn.SCALE_RANGE,t)}return!1}updateGraphicLabelScaleVisibility(e){if(!this._scaleRangeActive)return!1;if(!e.labelLayers||0===e.labelLayers.length)return!1;const t=this._graphicScale(e),i=this._updateLabelScaleVisibility(e,t);return i&&(this.graphicsCoreOwner.view.deconflictor.setDirty(),this.graphicsCoreOwner.view.labeler.setDirty()),i}_updateLabelScaleVisibility(e,t){if(!e.labelLayers||0===e.labelLayers.length)return!1;const i=e.labelLayers[0]._labelClass;if(null!=(null===i||void 0===i?void 0:i.minScale)&&null!=i.maxScale){const r=this._visibleAtLabelScale(t,i);if(e.setVisibilityFlag(Sn.LABEL,xn.SCALE_RANGE,r))return!0}return!1}_scaleUpdateHandler(e){if(this._setDirty(),!this.graphicsCore.visible)return;const t=e.extent,i=e.scale,r=this._visibleAtLayerScale(i);let n=!1;const s=this.graphicsCoreOwner.view.spatialReference,o=e.spatialReference;if(null==o)return void a.A.getLogger(this).error("scaleUpdate: Internal error, no SpatialReference given for tiles");const l=!o.equals(s);if(l&&!ee(t,o,ly,s))return void a.A.getLogger(this).error("scaleUpdate: Internal error, cannot project AABR from "+o+" to wkid "+s);const c=l?ly:t;this.queryGraphicUIDsInExtent(c,s,(e=>{const s=this.graphicsCore.getGraphics3DGraphicById(e);if(null==s)return;const a=s.centroid;null!=a&&(t[0]>a.x||t[1]>a.y||t[2]<a.x||t[3]<a.y)||(s.setVisibilityFlag(Sn.GRAPHIC,xn.SCALE_RANGE,r)&&(n=!0),this._updateLabelScaleVisibility(s,i)&&(n=!0))})),n&&(this.graphicsCoreOwner.view.deconflictor.setDirty(),this.graphicsCoreOwner.view.labeler.setDirty())}layerMinMaxScaleChangeHandler(){this.updateScaleRangeActive()&&!this._scaleRangeActive?this.graphicsCore.modifyGraphics3DGraphicVisibilities((e=>e.setVisibilityFlag(Sn.GRAPHIC,xn.SCALE_RANGE,!0))):this._scaleRangeActive&&this.graphicsCore.updateAllGraphicsVisibility(),this._setDirty()}};function ay(e,t){return e>0||t>0}(0,r._)([(0,d.MZ)()],sy.prototype,"graphicsCoreOwner",void 0),(0,r._)([(0,d.MZ)()],sy.prototype,"layer",void 0),(0,r._)([(0,d.MZ)()],sy.prototype,"queryGraphicUIDsInExtent",void 0),(0,r._)([(0,d.MZ)()],sy.prototype,"graphicsCore",void 0),(0,r._)([(0,d.MZ)()],sy.prototype,"basemapTerrain",void 0),(0,r._)([(0,d.MZ)({constructOnly:!0})],sy.prototype,"layerScaleEnabled",void 0),(0,r._)([(0,d.MZ)({readOnly:!0})],sy.prototype,"suspended",void 0),(0,r._)([(0,d.MZ)({readOnly:!0})],sy.prototype,"updating",null),(0,r._)([(0,d.MZ)()],sy.prototype,"_dirty",void 0),sy=(0,r._)([(0,u.$)("esri.views.3d.layers.graphics.Graphics3DScaleVisibility")],sy);const oy="terrain-events",ly=(0,Q.vt)();function cy(e,t,i,r,n){const s=t.getComponentAabb(i,e,dy),a=t.getObjectTransform(i);for(let o=0;o<8;++o)hy[0]=1&o?s[0]:s[3],hy[1]=2&o?s[1]:s[4],hy[2]=4&o?s[2]:s[5],(0,M.t)(hy,hy,a.rotationScale),(0,M.g)(hy,hy,a.position),r[n++]=hy[0],r[n++]=hy[1],r[n++]=hy[2];return r}const dy=(0,q.vt)(),hy=(0,I.vt)();class uy extends Cn.A{constructor(){super(...arguments),this._map=new Map}clear(){if(this._map.size>0){const e=this.toArray();this._map.clear(),this.emit("change",{added:[],removed:e})}}get length(){return this._map.size}get(e){return this._map.get(e)}addMany(e){if(0===e.length)return;const t=new Set;for(let r=0;r<e.length;r++){const i=e[r],n=i.objectId,s=this._map.get(n);s?(t.add(n),i!==s&&(e[r]=s),s.refCount||(s.refCount=0),++s.refCount):(i.refCount=1,this._map.set(n,i))}const i=t.size>0?e.filter((e=>!t.has(e.objectId))):e;i.length>0&&this.emit("change",{added:i,removed:[]})}removeMany(e){const t=[];for(const i of e){const e=i.objectId,r=this._map.get(e);null!=r&&(!r.refCount||--r.refCount<=0)&&(this._map.delete(e),t.push(i))}t.length>0&&this.emit("change",{added:[],removed:t})}removeManyByObjectId(e){const t=[];for(const i of e){const e=this._map.get(i);null!=e&&(!e.refCount||--e.refCount<=0)&&(this._map.delete(i),t.push(e))}t.length>0&&this.emit("change",{added:[],removed:t})}toArray(){return[...this._map.values()]}find(e){let t;return(0,Ui.Bs)(this._map,(i=>!!e(i)&&(t=i,!0))),t}forEach(e){this._map.forEach((t=>e(t)))}}class py extends Cn.A{constructor(e){super(),this._limit=e,this._all=new uy,this._active=new gy(this),this._pending=new Map,this._handle=this._all.on("change",(e=>this._handleChanges(e)))}destroy(){this._handle.remove()}get length(){return this._active.length}toArray(){return this._active.toArray()}find(e){return this._active.find(e)}forEach(e){this._active.forEach(e)}addMany(e){this._all.addMany(e)}removeManyByObjectId(e){this._all.removeManyByObjectId(e)}_handleChanges(e){let t=e.removed;if(this._pending.size>0){t=new Array;for(const i of e.removed)this._pending.delete(i.objectId)||t.push(i)}let i=this._limit-this._active.length+t.length;i<e.added.length&&(this._active.removeMany(t),t=[],fy.reset(1-this._limit/(this._active.length+e.added.length)),this._active.forEach((e=>{fy.sample()&&(t.push(e),this._pending.set(e.objectId,e))})),i=this._limit-this._active.length+t.length);let r=e.added;if(i<e.added.length){r=new Array,fy.reset(i/e.added.length);for(const t of e.added)fy.sample()?r.push(t):this._pending.set(t.objectId,t)}const n=i-r.length;n>0&&this._pending.size>0&&(fy.reset(n/this._pending.size),this._pending.forEach((e=>{fy.sample()&&(r.push(e),this._pending.delete(e.objectId))}))),this._active.addAndRemove(r,t)}}const fy=new class{constructor(){this._percentage=1,this._last=-1,this._index=0}reset(e){this._percentage=e,this._last=-1}sample(){const e=Math.floor(this._index*this._percentage);return++this._index,e!==this._last&&(this._last=e,!0)}};class gy{constructor(e){this._parent=e,this._map=new Map}get length(){return this._map.size}forEach(e){this._map.forEach((t=>e(t)))}find(e){let t;return(0,Ui.Bs)(this._map,(i=>!!e(i)&&(t=i,!0))),t}toArray(){return[...this._map.values()]}addAndRemove(e,t){for(const i of e)this._map.set(i.objectId,i);for(const i of t)this._map.delete(i.objectId);(e.length>0||t.length>0)&&this._parent.emit("change",{added:e,removed:t})}removeMany(e){for(const t of e)this._map.delete(t.objectId);e.length>0&&this._parent.emit("change",{added:[],removed:e})}}class my{constructor(e,t){this.meta=e,this.index=t}}class _y{constructor(e,t){this.graphic=e,this.geometry=t,this.components=[],this.overridesDirty=!1}}let vy=class extends s.A{get updating(){var e,t;return null!==(e=null===(t=this._graphicsCore)||void 0===t?void 0:t.updating)&&void 0!==e&&e}constructor(e){super(e),this.loadedGraphics=new py(5e4),this.slicePlaneEnabled=!1,this._renderingInfo={symbol:new Xi.A},this._featuresMap=new Map}initialize(){const e=this.view.basemapTerrain;this._graphicsCore=new $v({owner:this,layer:this.layer,preferredUpdatePolicy:Ao.ASYNC,elevationFeatureExpressionEnabled:!1,graphicSymbolSupported:!1,getRenderingInfoWithoutRenderer:!0,hasZ:!0,hasM:!1,componentFactories:{deconflictor:e=>this.view.deconflictor.addGraphicsOwner(e),labeler:(e,t)=>this.view.labeler.addGraphicsOwner(e,t,{emptySymbolLabelSupported:!0,elevationInfoOverride:{mode:"absolute-height",offset:0},disablePlacement:{logEntityDescription:"3D Object Scene Layer features"}}),scaleVisibility:(t,i)=>new sy({graphicsCoreOwner:this,layer:this.layer,queryGraphicUIDsInExtent:i,graphicsCore:t,basemapTerrain:e,layerScaleEnabled:!1})}}),this._graphicsCore.initializePromise.then((()=>this._graphicsCore.startCreateGraphics())).catch((()=>{})),this.addHandles((0,l.wB)((()=>this.layer.labelingInfo),((e,t)=>{(0,Vi.Ui)(e,t)&&this._graphicsCore.updateLabelingInfo()})))}destroy(){this._graphicsCore=(0,le.pR)(this._graphicsCore),this.loadedGraphics=(0,le.pR)(this.loadedGraphics),this.view=null}addNodeMeta(e,t){let i=0;const r=e.filteredIds,n=this.view.spatialReference,s=[];for(let a=0;a<e.featureIds.length;a++){const o=e.featureIds[a];let l=null==r;if(r&&i<r.length&&o===r[i]&&(l=!0,i++),!this._enabledForFeatureInNode(e,a))continue;const c=this._featuresMap.get(o);if(c){c.components.push(new my(e,a)),this._updateLabelPosition(o);continue}const d=t(a,e),h=(0,ne.T)(0,0,0,n),u={objectId:o,uid:(0,Ni.c)(),attributes:d,visible:l,geometry:h},p=new _y(u,h);p.components.push(new my(e,a)),this._featuresMap.set(o,p),this._updateLabelGeometry(o),s.push(u)}this.loadedGraphics.addMany(s)}updateLabelPositions(e){const t=this.view.renderCoordsHelper;this._forEachGraphic(e,((i,r,n)=>{var s;const a=this._graphicsCore.getGraphics3DGraphicById(r.uid);null!=a&&this._updateLabelGeometry(e.featureIds[i])&&a.alignWithAbsoluteElevation(null!==(s=n.z)&&void 0!==s?s:0,t,!1)}))}setNodeMetaAttributes(e,t){const i=new Array;this._forEachGraphic(e,((r,n)=>{const s=t(r,e);(0,lt.gh)(n.attributes,s)||(n.attributes=s,i.push(n.uid))})),this._graphicsCore.updateLabelingInfo(i)}applyFilterChange(e){this._forEachFeature(e,((t,i,r)=>{if(!this._enabledForFeatureInNode(e,t)){const r=e.featureIds[t];switch(this._removeFeature(i,e,t)){case by.REMOVED:this.loadedGraphics.removeManyByObjectId([r]);break;case by.MODIFIED:this._updateLabelPosition(r)}return}const n=i.graphic,s=n.visible;s!==r&&(n.visible=r,yy.graphic=n,yy.property="visible",yy.oldValue=s,yy.newValue=r,this._graphicsCore.graphicUpdateHandler(yy))}))}removeNodeMeta(e){const t=[];this._forEachGraphic(e,(i=>{const r=e.featureIds[i],n=this._featuresMap.get(r);if(n)switch(this._removeFeature(n,e,i)){case by.MODIFIED:this._updateLabelPosition(r);break;case by.REMOVED:t.push(r)}})),this.loadedGraphics.removeManyByObjectId(t)}_removeFeature(e,t,i){const r=e.components.length;return(0,b.$i)(e.components,(e=>!(e.meta===t&&e.index===i))),0===e.components.length?(this._featuresMap.delete(t.featureIds[i]),by.REMOVED):r!==e.components.length?by.MODIFIED:by.UNMODIFIED}getRenderingInfo(){return this._renderingInfo}notifyGraphicGeometryChanged(){}notifyGraphicVisibilityChanged(){}_updateLabelPosition(e){const t=this._featuresMap.get(e);t&&this._updateLabelGeometry(e)&&(this.loadedGraphics.removeManyByObjectId([e]),this.loadedGraphics.addMany([t.graphic]))}_updateLabelGeometry(e){var t;const i=this._featuresMap.get(e);if(!i)return!1;const r=i.geometry,n=this.view.spatialReference,s=this.view.renderCoordsHelper,a=r.x,o=r.y,l=null!==(t=r.z)&&void 0!==t?t:0,c=i.components.length,d=(0,J.jh)(24*c);let h=0;for(const{meta:u,index:p}of i.components)cy(p,this.collection,u.objectHandle,d,h),h+=24;return(0,k.projectBuffer)(d,s.spatialReference,0,d,n,0,d.length/3),(0,q.hZ)(xy,q.qv),(0,q.Hq)(xy,d),r.x=(xy[0]+xy[3])/2,r.y=(xy[1]+xy[4])/2,r.z=xy[5],!(0,U.Io)(r.x,a)||!(0,U.Io)(r.y,o)||!(0,U.Io)(r.z,l)}_forEachGraphic(e,t){this._forEachFeature(e,((i,r,n)=>{let{graphic:s,geometry:a}=r;this._enabledForFeatureInNode(e,i)&&t(i,s,a,n)}))}_forEachFeature(e,t){let i=0;for(let r=0;r<e.featureIds.length;r++){const n=this._featuresMap.get(e.featureIds[r]);let s=null==e.filteredIds;e.filteredIds&&e.filteredIds[i]===e.featureIds[r]&&(s=!0,i++),n&&t(r,n,s)}}_enabledForFeatureInNode(e,t){var i;return e.node.index<0||!(null!==(i=this.overrides)&&void 0!==i&&i.featureHasGeometryChanges(e.featureIds[t]))}get updatePolicy(){return this._graphicsCore.effectiveUpdatePolicy}get usedMemory(){return this._graphicsCore.usedMemory}get unloadedMemoryEstimate(){return this._graphicsCore.unprocessedMemoryEstimate}get test(){return{graphicsCore:this._graphicsCore}}};(0,r._)([(0,d.MZ)()],vy.prototype,"view",void 0),(0,r._)([(0,d.MZ)()],vy.prototype,"layer",void 0),(0,r._)([(0,d.MZ)()],vy.prototype,"collection",void 0),(0,r._)([(0,d.MZ)()],vy.prototype,"loadedGraphics",void 0),(0,r._)([(0,d.MZ)()],vy.prototype,"overrides",void 0),(0,r._)([(0,d.MZ)()],vy.prototype,"updating",null),(0,r._)([(0,d.MZ)()],vy.prototype,"slicePlaneEnabled",void 0),(0,r._)([(0,d.MZ)()],vy.prototype,"_graphicsCore",void 0),vy=(0,r._)([(0,u.$)("esri.views.3d.layers.I3SMeshViewLabeler")],vy);const yy={graphic:null,property:null,oldValue:null,newValue:null};var by;!function(e){e[e.UNMODIFIED=0]="UNMODIFIED",e[e.MODIFIED=1]="MODIFIED",e[e.REMOVED=2]="REMOVED"}(by||(by={}));const xy=(0,q.vt)();class Sy{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null;this.usedMemory=e,this.displayedFeatures=t,this.totalFeatures=i,this.maximumFeatures=r,this.nodes=n,this.core=s}}i(11941);f.B;new C.A({deallocator:null}),(0,I.vt)();var wy,Cy,Ay;!function(e){e[e.VISIBLE_ONLY=0]="VISIBLE_ONLY",e[e.ALL=1]="ALL",e[e.QUERYABLE=2]="QUERYABLE"}(wy||(wy={})),function(e){e[e.EXIT=0]="EXIT",e[e.CONTINUE=1]="CONTINUE",e[e.SKIP=2]="SKIP"}(Cy||(Cy={})),function(e){e[e.Absolute=0]="Absolute",e[e.RelativeToGround=1]="RelativeToGround",e[e.OnTheGround=2]="OnTheGround"}(Ay||(Ay={}));i(21734);var Ry=i(79701);function Ey(e){return e instanceof Tv?e.graphics3DSymbol:e instanceof Rv?e:null}const Oy=()=>a.A.getLogger("esri.views.3d.layers.graphics.labelPlacement");class Ty{constructor(e,t,i){let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;this.graphics3DGraphic=e,this.labelSymbol=t,this.labelClass=i,this.disablePlacement=r}}function Py(e){const t=function(e){const t=e.labelClass.labelPlacement,{labelSymbol:i,graphics3DGraphic:r}=e,n=Ey(r.graphics3DSymbol),s="point-3d"===(null===n||void 0===n?void 0:n.symbol.type)?n.symbol:null,a=Ny[t]||Dy(e);return null!=s&&s.supportsCallout()&&s.hasVisibleVerticalOffset()&&!r.isDraped?{placement:null,hasLabelVerticalOffset:!1,verticalOffset:Fy(s.verticalOffset),anchor:null,normalizedOffset:null}:!i||!i.hasVisibleVerticalOffset()||null!=s&&s.supportsCallout()&&s.verticalOffset&&!r.isDraped?{placement:null,verticalOffset:null,anchor:null,normalizedOffset:null,hasLabelVerticalOffset:!1}:a&&function(e){return"above-center"===e}(a.placement)?{placement:"above-center",verticalOffset:Fy(i.verticalOffset),anchor:"bottom",normalizedOffset:[0,a.normalizedOffset[1],0],hasLabelVerticalOffset:!0}:(Oy().errorOncePerTick("Callouts and vertical offset on labels are currently only supported with 'above-center' label placement (not with "+t+" placement)"),null)}(e);if(null==t)return null;const i=function(e,t){if(t.anchor)return t;const i=e.labelClass.labelPlacement,r=Ny[i],n=r||Dy(e);return i&&!r&&Oy().warnOncePerTick("the requested label placement '".concat(i,"' is currently unsupported in SceneView.")),function(e,t){const i=t.graphics3DGraphic.graphic.geometry;if(null==i)return null;if(null!=t.disablePlacement)return t.labelClass.labelPlacement?(Oy().warnOncePerTick(Iy(null===e||void 0===e?void 0:e.placement,t.disablePlacement.logEntityDescription)),Dy(t)):e;const r=i.type;switch(r){case"polyline":case"polygon":case"extent":case"multipoint":if(t.labelClass.labelPlacement)return Oy().warnOncePerTick(Iy(null===e||void 0===e?void 0:e.placement,"'".concat(r,"' geometries"))),Dy(t);break;case"point":case"mesh":return e}return e}(n,e)}(e,t);if(null==i)return null;const r=i.anchor,n=!!t.hasLabelVerticalOffset,s=t.verticalOffset;return function(e,t,i){const r=i.graphics3DGraphic.graphic.geometry;if(null==r)return null;switch(r.type){case"point":!function(e,t,i){const r=My(i);if(null==r)return;const n=i.graphics3DGraphic.layers[0];switch(null!=n?n.getCenterObjectSpace(e.translation):(0,M.s)(e.translation,0,0,0),r.type){case"icon":case"text":!function(e,t,i,r){const{graphics3DGraphic:n}=i,s=null!=r?r.getScreenSize():null;if(n.isDraped||null==s)e.hasLabelVerticalOffset||"center"===e.anchor||(Ny[i.labelClass.labelPlacement]&&Oy().warnOncePerTick("the requested placement '".concat(t.placement,"' is currently unsupported for draped graphics")),e.anchor="center");else{const r=function(e){var t;let i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Gy;const{graphics3DGraphic:r}=e,n=r.layers[0],s=null!==(t=null===n||void 0===n?void 0:n.stageObject.geometries[0].material)&&void 0!==t?t:null;if(s&&s instanceof wu){const e=s.parameters.anchorPosition;i[0]=2*(e[0]-.5),i[1]=2*(e[1]-.5)}else i[0]=0,i[1]=0;return i}(i);e.screenOffset[0]=s[0]/2*(t.normalizedOffset[0]-r[0]);const n=s[1]/2*(t.normalizedOffset[1]-r[1]);e.hasLabelVerticalOffset?(e.centerOffset[1]=n,e.centerOffsetUnits="screen"):e.screenOffset[1]=n}}(e,t,i,n);break;case"object":Ly(e,t,n)}}(e,t,i);break;case"polygon":!function(e,t,i){const r=My(i);if(null!=r)switch(r.type){case"extrude":{const r=i.graphics3DGraphic.layers[0];null!=r?(r.getBoundingBoxObjectSpace(Uy),(0,q.gX)(Uy,e.translation),e.translation[2]=(0,q.uJ)(Uy)/2):(0,M.s)(e.translation,0,0,0),Ly(e,t,r);break}}}(e,t,i);break;case"mesh":Ly(e,t,i.graphics3DGraphic.layers[0])}const n=Uh-Yh;return e.screenOffset[0]+=n*t.normalizedOffset[0],e.screenOffset[1]+=n*t.normalizedOffset[1],e}(new z_(s,r,n),i,e)}function My(e){const t=Ey(e.graphics3DGraphic.graphics3DSymbol);return null!=t?t.symbol.symbolLayers.at(0):null}function Iy(e,t){return"the requested label placement '".concat(e,"' is currently unsupported for ").concat(t," in SceneView.")}function Dy(e){const t=e.graphics3DGraphic.graphic.geometry;if(null==t)return null;switch(t.type){case"polyline":case"extent":case"multipoint":return{placement:"center-center",normalizedOffset:I.uY,anchor:"center"};case"polygon":{const t=My(e);return null!=t&&"extrude"===t.type?Ny["above-center"]:{placement:"center-center",normalizedOffset:I.uY,anchor:"center"}}case"point":case"mesh":return Ny["above-center"];default:return}}function Ly(e,t,i){const r=null!=i?i.getBoundingBoxObjectSpace(Uy):Uy,n=(0,I.fA)(r[3]-r[0],r[4]-r[1],r[5]-r[2]),s=Math.sqrt(n[0]*n[0]+n[1]*n[1]);e.centerOffset[0]=s/2*t.normalizedOffset[0];const a=e.translation[2],o=n[2]/2*t.normalizedOffset[1];e.translation[2]=0,e.elevationOffset=a+o;const l=(0,M.l)(n);e.centerOffset[2]=l/2*t.normalizedOffset[2]}function Fy(e){const{screenLength:t,minWorldLength:i,maxWorldLength:r}=e;return{screenLength:t,minWorldLength:i,maxWorldLength:r}}const Ny={"above-center":{placement:"above-center",normalizedOffset:[0,1,0],anchor:"bottom"},"above-left":{placement:"above-left",normalizedOffset:[-1,1,0],anchor:"bottom-right"},"above-right":{placement:"above-right",normalizedOffset:[1,1,0],anchor:"bottom-left"},"below-center":{placement:"below-center",normalizedOffset:[0,-1,2],anchor:"top"},"below-left":{placement:"below-left",normalizedOffset:[-1,-1,0],anchor:"top-right"},"below-right":{placement:"below-right",normalizedOffset:[1,-1,0],anchor:"top-left"},"center-center":{placement:"center-center",normalizedOffset:[0,0,1],anchor:"center"},"center-left":{placement:"center-left",normalizedOffset:[-1,0,0],anchor:"right"},"center-right":{placement:"center-right",normalizedOffset:[1,0,0],anchor:"left"}},Vy={"above-center":["default","esriServerPointLabelPlacementAboveCenter"],"above-left":["esriServerPointLabelPlacementAboveLeft"],"above-right":["esriServerPointLabelPlacementAboveRight"],"below-center":["esriServerPointLabelPlacementBelowCenter"],"below-left":["esriServerPointLabelPlacementBelowLeft"],"below-right":["esriServerPointLabelPlacementBelowRight"],"center-center":["esriServerPointLabelPlacementCenterCenter"],"center-left":["esriServerPointLabelPlacementCenterLeft"],"center-right":["esriServerPointLabelPlacementCenterRight"]};for(const QS in Vy){const e=Vy[QS],t=Ny[QS];e.forEach((e=>{Ny[e]=t}))}Object.freeze&&(Object.freeze(Ny),Object.keys(Ny).forEach((e=>{var t;Object.freeze(Ny[e]),Object.freeze(null===(t=Ny[e])||void 0===t?void 0:t.normalizedOffset)})));const Gy=[0,0],Uy=(0,q.vt)();class zy{constructor(e){this._stage=e,this._materials=new Map}get(e){return this._materials.get(e)}add(e,t){this._materials.set(e,t),this._stage.add(t)}dispose(){this._stage.removeMany(Array.from(this._materials.values())),this._materials.clear()}}class By{constructor(e,t){this.labelingContext=e,this.graphics3DGraphic=t,this.hasGraphics3DResources=!1,this.visible=!1,this.addedToTextureAtlas=!1,this.textInitialized=!1,this.textRenderers=new Array,this.textLabelPlacements=new Array}}class Hy{constructor(e,t,i,r,n){this.labelClass=e,this.graphics3DSymbol=t,this.graphics3DCalloutSymbolLayer=i,this.textRenderParameters=r,this.labelFunction=n,this.calloutSymbolLayerIndex=0}}class jy{constructor(e,t,i,r,n,s,a,o){this.layer=t,this.graphics3DCore=i,this.scaleVisibility=r,this.emptySymbolLabelSupported=n,this.elevationInfoOverride=s,this.disablePlacement=a,this.active=o,this.labelClassAbortController=new AbortController,this.labelClassContexts=new Array,this.graphics=new Map,this.labelsToInitialize=new Map,this.stageLayer=new Eo(e,{pickable:!0,disableOctree:!0},t.uid)}destroy(){this.stageLayer.destroy()}}let Wy=class extends s.A{constructor(e){super(e),this._dirty=!1,this._labels=new Map,this._labelingContexts=new Array}setup(){this.dispose(),this.addHandles([(0,l.wB)((()=>{var e;return null===(e=this.view.state)||void 0===e?void 0:e.camera}),(()=>this.setDirty())),(0,l.wB)((()=>{var e;return null===(e=this.view.state)||void 0===e?void 0:e.rasterPixelRatio}),(()=>this._resetAllLabels())),this.view.resourceController.scheduler.registerTask(Ae.W6.LABELER,this)]),this._textTextureAtlas=new q_({view:this.view}),this._hudMaterialCollection=new zy(this.view._stage),this._calloutMaterialCollection=new zy(this.view._stage)}dispose(){this.removeAllHandles(),this._textTextureAtlas=(0,le.WD)(this._textTextureAtlas),this._hudMaterialCollection=(0,le.WD)(this._hudMaterialCollection),this._calloutMaterialCollection=(0,le.WD)(this._calloutMaterialCollection),this._labelingContexts.length=0,this._labels.clear()}destroy(){this.dispose(),Qy.graphic=null,Qy.renderingInfo=null,Qy.layer=null}_activateLabelingContext(e){e.graphics.forEach(((t,i)=>{const r=new By(e,t);this._labels.set(i,r),e.labelsToInitialize.set(i,r),t.setVisibilityFlag(Sn.LABEL,xn.USER,!0)})),e.active=!0}_deactivateLabelingContext(e){e.graphics.forEach(((e,t)=>{e.setVisibilityFlag(Sn.LABEL,xn.USER,!1),this.setLabelGraphicVisibility(e,!1),e.clearLabelGraphics(),this._labels.delete(t)})),e.active=!1}_addLabelTextureToAtlas(e){for(const t of e.graphics3DGraphic.labelLayers){if(!t._labelClass)continue;const i=e.textRenderers[t._labelIndex];i&&(this._textTextureAtlas.addTextTexture(i,t.stageObject),e.addedToTextureAtlas=!0)}}_removeLabelTextureFromAtlas(e){for(const t of e.graphics3DGraphic.labelLayers){if(!t._labelClass)continue;const i=e.textRenderers[t._labelIndex];null!=i&&(this._textTextureAtlas.removeTextTexture(i,t.stageObject),e.addedToTextureAtlas=!1)}}get running(){return this.view.ready&&(this._dirty||this.deconflictor.running)}runTask(e){return this._updateLabels(e),!this._dirty&&this.deconflictor.running&&this.deconflictor.runTask(e),k_.G}_updateLabels(e){if(this._dirty){this._dirty=!1;for(const t of this._labelingContexts)if(t.active)if(ky(t))this._dirty=!0;else if(Zy(t.labelClassContexts)){if(null===t.labelClassContexts){this._deactivateLabelingContext(t);continue}this._createLabelClassContext(t),this._dirty=!0}else(0,Ui.Bs)(t.labelsToInitialize,((i,r)=>(this._ensureGraphics3DResources(i)&&(this._labels.set(r,i),this.deconflictor.setDirty(),e.madeProgress()),(i.visible&&i.textInitialized||!i.visible&&i.hasGraphics3DResources)&&(t.labelsToInitialize.delete(r),e.madeProgress()),e.done)))&&(this._dirty=!0);this._dirty||this.notifyChange("updating")}}async _createLabelClassContextAsync(e){var t,i;const r=null===(t=e.labelClassAbortController)||void 0===t?void 0:t.signal;e.layer.when&&await e.layer.when(),(0,o.Te)(r),e.scaleVisibility&&e.scaleVisibility.updateScaleRangeActive();const n=e.graphics3DCore,s=null===(i=n.layer.labelingInfo)||void 0===i?void 0:i.filter((e=>!!e.symbol));if(!s||0===s.length)return;let l=!1;await(0,ot.jJ)(s,(async(t,i)=>{const s=t.symbol,c=Ey(n.getOrCreateGraphics3DSymbol(s));if(null==c)return void a.A.getLogger(this).error("Failed to create Graphics3DSymbol for label");await c.load(),(0,o.Te)(r);let d=null;(0,Dn.YX)(s)&&s.hasVisibleCallout()&&(d=va(s,n.symbolCreationContext),await d.load(),(0,o.Te)(r));const h=await(0,ot.Ke)((0,Ry.l)(t,e.layer.fieldsIndex,this.view.spatialReference));if((0,o.Te)(r),!0===h.ok){const n=await this._createTextRenderParameters(c.symbol);(0,o.Te)(r),e.labelClassContexts[i]=new Hy(t,c,d,n,h.value)}else a.A.getLogger(this).error("Label expression failed to evaluate: ".concat(h.error)),l=!0})),(0,o.Te)(r)}async _createLabelClassContext(e){return null==e.labelClassPromise&&(e.labelClassPromise=this._createLabelClassContextAsync(e).catch((t=>{if((0,o.zf)(t))throw t;e.labelClassContexts.length=0})).then((()=>{e.labelClassAbortController=null,this.notifyChange("updating")})).catch((()=>{})),this.notifyChange("updating")),e.labelClassPromise}async _createTextRenderParameters(e){const t=e.symbolLayers.at(0);return"text"!==(null===t||void 0===t?void 0:t.type)?null:j_.fromSymbol(t,this.view.state.rasterPixelRatio)}_destroyLabelClassContext(e){for(const i of e.labelClassContexts)--i.graphics3DSymbol.referenced;const t=e.labelClassAbortController;e.labelClassAbortController=new AbortController,(0,le.DC)(t),e.labelClassContexts.length=0,e.labelClassPromise=null,this.notifyChange("updating")}_createTextSymbolGraphic(e,t,i,r,n,s){const a=new B_(i,lu(i.anchor),function(e){switch(e){case"bottom-left":case"bottom":case"bottom-right":return"bottom";case"left":case"center":case"right":return"center";case"top-left":case"top":case"top-right":return"top"}}(i.anchor),e.text,(0,pr.fA)(e.displayWidth,e.displayHeight));return Qy.graphic=t,Qy.renderingInfo=null,Qy.layer=r,n.createLabel(Qy,a,this._hudMaterialCollection,this._textTextureAtlas,(()=>{const e=Py(s);return e?e.elevationOffset:null}))}_createLineCalloutGraphic(e,t,i,r,n){Qy.graphic=e,Qy.layer=n;const s=r.screenOffset[0];return Qy.renderingInfo=new ma(null,t,r.translation,r.centerOffset,s,r.centerOffsetUnits,r.elevationOffset,this._calloutMaterialCollection),i.createGraphics3DGraphic(Qy)}_ensureGraphics3DResources(e){if(e.hasGraphics3DResources)return!1;const t=e.graphics3DGraphic;if(t.destroyed)return!1;this._ensureTextTextureResources(e);const i=e.labelingContext,r=i.labelClassContexts;if(Zy(r)||!i.emptySymbolLabelSupported&&0===t.layers.length)return!1;let n=!1;const s=t.graphic,a=i.layer,o=qy(i.layer);for(let d=0;d<r.length;d++){var l,c;const h=e.textRenderers[d],u=e.textLabelPlacements[d];if(null==h||null==u)continue;const p=r[d],f=p.graphics3DSymbol,g=f.symbol&&"label-3d"===f.symbol.type?f.symbol:null,m=f.symbolLayers[0];if(!m)continue;m.setElevationInfoOverride(i.elevationInfoOverride);const _=new Ty(t,g,p.labelClass),v=this._createTextSymbolGraphic(h,s,u,a,m,_);if(null==v)return!1;v._labelClass=p.labelClass,v._labelIndex=d,t.addLabelGraphic(v,i.stageLayer),t.deconflictionPriority=null!==(l=null===(c=p.textRenderParameters)||void 0===c?void 0:c.definition.size)&&void 0!==l?l:0,t.setVisibilityFlag(Sn.LABEL,xn.USER,o),t.setVisibilityFlag(Sn.LABEL,xn.SCALE_RANGE,!0),t.setVisibilityFlag(Sn.LABEL,xn.DECONFLICTION,!1),n=!0;const y=p.graphics3DCalloutSymbolLayer;if(y&&u.hasLabelVerticalOffset){y.setElevationInfoOverride(i.elevationInfoOverride);const e=this._createLineCalloutGraphic(s,g,y,u,a);null!=e&&(p.calloutSymbolLayerIndex=t.labelLayers.length,t.addLabelGraphic(e,i.stageLayer))}break}return i.scaleVisibility&&n&&i.scaleVisibility.updateGraphicLabelScaleVisibility(t),e.hasGraphics3DResources=!0,!0}_destroyGraphics3DResources(e){const t=e.labelingContext.labelClassContexts;for(const i of e.graphics3DGraphic.labelLayers){if(null==i._labelClass)continue;const e=t[i._labelIndex].graphics3DSymbol.symbolLayers[0];null===e||void 0===e||e.onRemoveGraphic(i)}e.graphics3DGraphic.deconflictionPriority=0,e.graphics3DGraphic.clearLabelGraphics(),e.hasGraphics3DResources=!1}_ensureTextTextureResources(e){if(e.textInitialized)return;const t=e.labelingContext,i=t.labelClassContexts;if(Zy(i))return;const r=e.graphics3DGraphic.graphic;for(let a=0;a<i.length;a++){var n;const o=i[a];if(e.textRenderers[a]=null,e.textLabelPlacements[a]=null,null==(null===o||void 0===o?void 0:o.textRenderParameters))continue;const l=o.labelFunction;let c;if("arcade"===l.type)try{const e=l.needsHydrationToEvaluate()?Qt(r,t.layer):r;c=l.evaluate(e)}catch(s){c=null}else c=l.evaluate(r);if(null==c||""===c||/^\s+$/.test(c))continue;const d=o.graphics3DSymbol,h="label-3d"===(null===(n=d.symbol)||void 0===n?void 0:n.type)?d.symbol:null;if(!d.symbolLayers[0])continue;const u=Py({graphics3DGraphic:e.graphics3DGraphic,labelSymbol:h,labelClass:o.labelClass,disablePlacement:t.disablePlacement});if(null==u)continue;const p=ou(lu(u.anchor));e.textRenderers[a]=new Xh(c,p,o.textRenderParameters,q_.maxSize),e.textLabelPlacements[a]=u}e.textInitialized=!0}_destroyTextTextureResources(e){e.textInitialized=!1,e.textRenderers.length=0,e.textLabelPlacements.length=0}_addGraphic(e,t){const i=t.graphic.uid;if(e.graphics.set(i,t),e.active){const r=new By(e,t);this._labels.set(i,r),e.labelsToInitialize.set(i,r)}this.setDirty(),this.deconflictor.setDirty()}_removeGraphic(e,t){const i=t.graphic.uid,r=this._labels.get(i);e.graphics.delete(i),r&&(this._destroyGraphic(r,i),e.labelsToInitialize.delete(i),this.setDirty(),this.deconflictor.setDirty())}_destroyGraphic(e,t){this._labels.delete(t),e.addedToTextureAtlas&&this._removeLabelTextureFromAtlas(e),this._destroyTextTextureResources(e),e.hasGraphics3DResources&&this._destroyGraphics3DResources(e)}async _labelingInfoChange(e,t){if(!t)return this._visibilityInfoChange(e),this._resetLabels(e),this._createLabelClassContext(e);for(const i of t){const t=e.graphics.get(i);t&&(this._removeGraphic(e,t),this._addGraphic(e,t))}}_globalPropertyChanged(e,t){for(const i of t.labelClassContexts){const r=new Map;t.graphics.forEach((e=>r.set(e.graphic.uid,e)));const n=e=>e.labelLayers[0];if(i.graphics3DSymbol.symbolLayers[0].globalPropertyChanged(e,r,n),i.graphics3DCalloutSymbolLayer){const t=e=>e.labelLayers[i.calloutSymbolLayerIndex];i.graphics3DCalloutSymbolLayer.globalPropertyChanged(e,r,t)}}}_visibilityInfoChange(e){const t=qy(e.layer);t&&!e.active&&this._activateLabelingContext(e),!t&&e.active&&this._deactivateLabelingContext(e),this.setDirty()}_resetAllLabels(){for(const e of this._labelingContexts)this._resetLabels(e)}_resetLabels(e){e.graphics.forEach(((t,i)=>{const r=this._labels.get(i);r&&(this._destroyGraphic(r,i),r.visible=!1,e.labelsToInitialize.set(i,r))})),this._destroyLabelClassContext(e),this.setDirty(),this.deconflictor.setDirty()}_findLabelingContext(e){for(const t of this._labelingContexts)if(t.graphics3DCore===e)return t;return null}addGraphicsOwner(e,t,i){const r=i&&i.emptySymbolLabelSupported||!1,n=(null===i||void 0===i?void 0:i.elevationInfoOverride)||null,s=(null===i||void 0===i?void 0:i.disablePlacement)||null;if(this._findLabelingContext(e))return;const a=e.layer,o=new jy(this.view._stage,a,e,t,r,n,s,qy(a));return this._labelingContexts.push(o),this.setDirty(),{addGraphic:e=>this._addGraphic(o,e),removeGraphic:e=>this._removeGraphic(o,e),featureReductionChange:()=>{},layerLabelsEnabled:()=>qy(o.layer),labelingInfoChange:e=>this._labelingInfoChange(o,e),elevationInfoChange:()=>this._globalPropertyChanged("elevationInfo",o),slicePlaneEnabledChange:()=>this._globalPropertyChanged("slicePlaneEnabled",o),visibilityInfoChange:()=>this._visibilityInfoChange(o),reset:()=>this._resetLabels(o),clear:()=>{}}}removeGraphicsOwner(e){const t=this._findLabelingContext(e);if(!t)return;const i=this._labelingContexts.indexOf(t);this._labelingContexts.splice(i,1),t.graphics.forEach((e=>this._removeGraphic(t,e))),t.destroy(),this.setDirty()}setLabelGraphicVisibility(e,t){const i=e.graphic.uid,r=this._labels.get(i);r&&r.visible!==t&&(t&&!r.addedToTextureAtlas?(this._addLabelTextureToAtlas(r),r.textInitialized||r.labelingContext.labelsToInitialize.set(i,r)):!t&&r.addedToTextureAtlas&&this._removeLabelTextureFromAtlas(r),r.visible=t,this.setDirty())}setDirty(){!this._dirty&&this._labelingContexts.length>0&&(this._dirty=!0,this.notifyChange("updating"))}get updating(){var e;return this._dirty||(null===(e=this._textTextureAtlas)||void 0===e?void 0:e.updating)||this.deconflictor.updating||this._labelingContexts.some((e=>ky(e)))}get updatingProgress(){if(!this.updating||!this._textTextureAtlas)return 1;const e=this._labelingContexts.length>0?this._labelingContexts.reduce(((e,t)=>e+(ky(t)?0:1)),0)/this._labelingContexts.length:1;return(this._dirty?0:.3)+(this._textTextureAtlas.updating?0:.1)+.1*e+.5*this.deconflictor.updatingProgress}get test(){return{textTextureAtlas:this._textTextureAtlas,resetAllLabels:()=>this._resetAllLabels()}}};function ky(e){return!!e.labelClassPromise&&!!e.labelClassAbortController}function Zy(e){return!e||0===e.length}function qy(e){var t;return!0===e.labelsVisible&&!(null===(t=e.labelingInfo)||void 0===t||!t.some((e=>!!e.symbol)))}(0,r._)([(0,d.MZ)({constructOnly:!0})],Wy.prototype,"view",void 0),(0,r._)([(0,d.MZ)({constructOnly:!0})],Wy.prototype,"deconflictor",void 0),(0,r._)([(0,d.MZ)()],Wy.prototype,"_textTextureAtlas",void 0),(0,r._)([(0,d.MZ)({type:Boolean,readOnly:!0})],Wy.prototype,"updating",null),Wy=(0,r._)([(0,u.$)("esri.views.3d.layers.graphics.Labeler")],Wy);const Qy=new class extends Mn{}(null,null,null);class Jy{constructor(){this._extents=new C.A({allocator:e=>e||(0,Q.vt)()}),this._tmpExtent=(0,Q.vt)(),this._dirty=!1}get empty(){return 0===this._extents.length}get size(){return this._extents.length}clear(){this._extents.clear()}add(e){this._contains(e)||(this._removeContained(e),(0,Q.C)(this._extents.pushNew(),e),this._dirty=!0)}pop(){return this._dirty&&this._mergeTight(),this._extents.pop()}merge(e){return this._mergeTight(e),e.hasProgressed}_mergeTight(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Ae.Bb;const t=this._extents,i=new Set;let r=0;for(;r!==t.length;){t.sort(((e,t)=>e[0]-t[0])),r=t.length,i.clear();for(let r=0;r<t.length;++r){if(e.done)return;const n=t.at(r);if(n){for(let e=r+1;e<t.length;++e){const r=t.at(e);if(null==r||r[0]>=n[2])break;i.add(r)}i.forEach((r=>{if(n===r)return;if(r[2]<=n[0])return void i.delete(r);const s=(0,Q.Wc)(n),a=(0,Q.Wc)(r),o=this._tmpExtent;(0,Q.fT)(n,r,o);const l=s+a;((0,Q.Wc)(o)-l)/l<.05&&((0,Q.C)(n,o),i.delete(r),t.remove(r),e.madeProgress())})),i.add(n)}}}this._dirty=!1}_contains(e){return this._extents.some((t=>(0,Q.gR)(t,e)))}_removeContained(e){this._extents.filterInPlace((t=>!(0,Q.gR)(e,t)))}get test(){const e=this;return{containsPoint:t=>e._extents.some((e=>(0,Q.Uc)(e,t)))}}}let Yy=class extends s.A{constructor(e,t,i,r){super({}),this._updateExtent=t,this._updateNode=i,this._getElevationMode=r,this.running=!1,this._extentSet=new Jy,this._nodeSet=new Set;const n=this._taskPriority,s=e.registerTask(this._taskPriority,this);this.addHandles(s),this._task=s,this._lastTaskPriority=n}get _taskPriority(){const e=this._getElevationMode();return e&&e===Ay.RelativeToGround?Ae.W6.ELEVATION_ALIGNMENT_SCENE:Ae.W6.ELEVATION_ALIGNMENT}_updateTaskPriority(){const e=this._taskPriority;e!==this._lastTaskPriority&&(this._task.priority=e,this._lastTaskPriority=e)}normalizeCtorArgs(){return{}}addExtent(e){this._extentSet.add(e),this._updateTaskPriority(),this.running=!0}schedule(e){this._nodeSet.add(e),this._updateTaskPriority(),this.running=!0}remove(e){this._nodeSet.delete(e),this._updateRunning()}runTask(e){const t=this._extentSet;for(e.run((()=>t.merge(e)));!t.empty&&!e.done;){const i=this._updateExtent(t.pop());null!=i&&i.forAll((e=>this.schedule(e))),e.madeProgress()}if(e.done)return;const i=this._nodeSet;for(const r of i)if(i.delete(r),this._updateNode(r),e.madeProgress(),e.done)break;this._updateRunning()}_updateRunning(){this.running=this._nodeSet.size>0||this._extentSet.size>0}};(0,r._)([(0,d.MZ)()],Yy.prototype,"running",void 0),Yy=(0,r._)([(0,u.$)("esri.views.3d.layers.i3s.I3SAsyncElevationUpdater.ts")],Yy);var Xy=i(60767),$y=i(50265),Ky=i(74438),eb=i(10156),tb=i(31933),ib=i(13096),rb=i(39483),nb=i(21820),sb=i(67993),ab=i(69194),ob=i(97015),lb=(i(89189),i(23701),i(31608)),cb=i(44135),db=i(74e3);class hb{get isReferenced(){return 0!==this.versions.length}get isSingle(){return 1===this.versions.length&&1===this.versions[0].refCount}constructor(e,t){this._highestResolutionVersion=null,this.versions=[],this.ref(e,t)}ref(e,t){const i=this.feature;pb.oldVersion=i,this.feature&&Object.defineProperty(e,"uid",{value:this.feature.uid,configurable:!0});for(const n of this.versions)if(n.resolution===t){n.refCount++;const t=this._highestResolutionVersion===n&&!(0,db.aI)(e,n.feature);return(t||this._highestResolutionVersion!==n)&&(n.feature=e),pb.newVersion=t?e:i,pb}const r={feature:e,resolution:t,refCount:1};return this.versions.push(r),!this._highestResolutionVersion||t<this._highestResolutionVersion.resolution?(pb.newVersion=e,this._highestResolutionVersion=r):pb.newVersion=i,pb}unref(e){for(let t=0;t<this.versions.length;t++){const i=this.versions[t];if(i.resolution===e)return i.refCount--,pb.oldVersion=this.feature,0===i.refCount&&(this.versions[t]=this.versions[this.versions.length-1],this.versions.length--,this._highestResolutionVersion===i&&(this._recalculateHighestResolutionVersion(),pb.oldVersion=i.feature)),pb.newVersion=this.feature,pb}return null}get feature(){return this._highestResolutionVersion?this._highestResolutionVersion.feature:null}_recalculateHighestResolutionVersion(){if(0===this.versions.length)return void(this._highestResolutionVersion=null);let e=this.versions[0];for(let t=1;t<this.versions.length;t++){const i=this.versions[t];i.resolution<e.resolution&&(e=i)}this._highestResolutionVersion=e}}class ub{get isReferenced(){return 0!==this._refCount}get isSingle(){return 1===this._refCount}constructor(e){this._feature=e,this._refCount=1}ref(e){return++this._refCount,pb.oldVersion=this._feature,this.feature&&Object.defineProperty(e,"uid",{value:this.feature.uid,configurable:!0}),(0,db.aI)(this._feature,e)||(this._feature=e),pb.newVersion=this._feature,pb}unref(){return pb.oldVersion=this._feature,this._refCount>0&&(this._refCount--,!this.isReferenced)?(pb.newVersion=null,pb):(pb.newVersion=this._feature,pb)}get feature(){return this._feature}}const pb={oldVersion:null,newVersion:null};var fb=i(75540);const gb=new Set;class mb{get featuresMissing(){return this._featuresMissing.value}set featuresMissing(e){this._featuresMissing.value=e}get missingAttributes(){return this._missingAttributes}get fetchFailed(){return this._fetchFailed.value}set fetchFailed(e){this._fetchFailed.value=e}get displayingFeatures(){return this._displayingFeatures}set displayingFeatures(e){this._displayingFeatures=e,this.extentIncludingBorrowedFeatures=null}get perTileMaximumNumberOfFeaturesExceeded(){const e=(this.fetchStatus===vb.DONE||this.fetchStatus===vb.FULL)&&this.featuresMissing;return!this.filtered&&(e||this.hasFeatureLimit)}get features(){return this._features}get featureLimit(){return this._featureLimit.value}set featureLimit(e){this._featureLimit.value!==e&&(this._featureLimit.value=e,this._estimatedUnusedSizeDirty=!0)}get hasFeatureLimit(){return this.featureLimit!==this._featuresLength.value}get hasAllFeatures(){return!(this.featuresMissing||this.fetchFailed||this.hasFeatureLimit)}get availableFields(){return this._availableFields}setFeatures(e,t,i,r){var n;this._availableFields=null!==i&&void 0!==i?i:gb,this._features=e,this._featuresLength.value=null!==(n=null===e||void 0===e?void 0:e.length)&&void 0!==n?n:0,this._shuffled=!1,this._estimatedSize=-1,this._estimatedUnusedSizeDirty=!0,this._missingAttributes=r,e&&e.length>0?(this._emptyFeatureRatio.value=t/(e.length+t),this._numVertices=e.reduce(((e,t)=>e+(0,ji.Kq)(t.geometry)),0)):(this._emptyFeatureRatio.value=0,this._numVertices=0)}get emptyFeatureRatio(){return this._emptyFeatureRatio.value}get numFeatures(){return this.hasPreciseFeatureCount?this._numFeatures:this._features?this._features.length:0}set numFeatures(e){this._numFeatures=e}get hasPreciseFeatureCount(){return this._numFeatures>_b}get needsFeatureCount(){return this._numFeatures===_b}get numVertices(){return this._numVertices}constructor(e){this.descriptor=e,this.fetchStatus=vb.FETCH_NEEDED,this._features=null,this._featuresLength=(0,fb.v)(0),this._numVertices=0,this._featureLimit=(0,fb.v)(0),this._featuresMissing=(0,fb.v)(!0),this._fetchFailed=(0,fb.v)(!1),this._shuffled=!1,this._numFeatures=_b,this._emptyFeatureRatio=(0,fb.v)(0),this._estimatedSize=-1,this._estimatedUnusedSize=0,this._estimatedUnusedSizeDirty=!1,this._availableFields=gb,this._displayingFeatures=null,this.alive=!0,this.filtered=!1}get id(){return this.descriptor.id}get estimatedSize(){return this.updateMemoryEstimates(),this._estimatedSize}get estimatedUnusedSize(){return this._estimatedUnusedSize}updateMemoryEstimates(){if(this._estimatedSize<0){if(this._estimatedSize=0,this._estimatedUnusedSize=0,this._features)for(let e=0;e<this._features.length;++e){const t=(0,ji.Ek)(this._features[e]);this._estimatedSize+=t,e>=this.featureLimit&&(this._estimatedUnusedSize+=t)}return!0}if(this._estimatedUnusedSizeDirty){if(this._estimatedUnusedSize=0,this._estimatedUnusedSizeDirty=!1,this._features)for(let e=this.featureLimit;e<this._features.length;++e)this._estimatedUnusedSize+=(0,ji.Ek)(this._features[e]);return!0}return!1}get isFetching(){return this.fetchStatus===vb.FETCHING||this.fetchStatus===vb.REFETCHING}get isRefetching(){return this.fetchStatus===vb.REFETCHING}get needsFetching(){return this.fetchStatus===vb.FETCH_NEEDED||this.fetchStatus===vb.REFETCH_NEEDED}get needsRefetching(){return this.fetchStatus===vb.REFETCH_NEEDED}get isFetched(){return this.fetchStatus===vb.DONE||this.fetchStatus===vb.FULL}resetFetching(){this.fetchStatus=this.fetchStatus===vb.REFETCHING?vb.REFETCH_NEEDED:vb.FETCH_NEEDED}get needsDisplayUpdate(){return!!this._features&&!function(e,t,i){if(null==t||null==e||i!==t.length||i>e.length)return!1;for(let r=0;r<i;++r)if(e[r]!==t[r])return!1;return!0}(this._features,this.displayingFeatures,this.featureLimit)}intersects(e){return null==e||!this.descriptor.extent||((0,Q.VY)(e,yb),(0,Q.HY)(this.descriptor.extent,yb))}intersectionIncludingBorrowed(e,t){const i=null!=this.extentIncludingBorrowedFeatures?this.extentIncludingBorrowedFeatures:this.descriptor.extent;return e||i?(null!=e?((0,Q.VY)(e,t),(0,Q.E$)(t,i,t)):(0,Q.C)(t,i),t):((0,Q.C)(t,Q.sI),t)}_shuffle(e){this._features&&(this._features.sort(((t,i)=>(0,ji.RW)(t,e)-(0,ji.RW)(i,e))),(0,b.k4)(this._features,16438),this._shuffled=!0,this._estimatedUnusedSizeDirty=!0)}reduceFeatures(e,t,i){if(e<=0)return!1;if(!this._features)return this.featureLimit=0,!1;let r=!1;this.featureLimit=Math.ceil(this.numFeatures*e),this.featureLimit>this._features.length&&(this.featureLimit=this._features.length,this.fetchStatus===vb.DONE&&this._features.length>0&&(this.fetchStatus=vb.REFETCH_NEEDED,r=!0)),!this._shuffled&&e<1&&this._shuffle(i);const n=Math.max(this.featureLimit,Math.ceil(t*this.numFeatures));return this._features.length>n&&(this._features.length=n,this._featuresLength.value=n,this.featuresMissing=!0,this.fetchStatus===vb.FULL&&(this.fetchStatus=vb.DONE)),r}get cache(){return{availableFields:this._availableFields,features:this._features,numFeatures:this._numFeatures,emptyFeatureRatio:this._emptyFeatureRatio.value,fetchStatus:this.fetchStatus,featuresMissing:this.featuresMissing}}set cache(e){var t,i;this.requestController=null,this._availableFields=e.availableFields,this._features=e.features,this._featuresLength.value=null!==(t=null===(i=e.features)||void 0===i?void 0:i.length)&&void 0!==t?t:0,this._numFeatures=e.numFeatures,this._emptyFeatureRatio.value=e.emptyFeatureRatio,this.fetchStatus=e.fetchStatus,this.featuresMissing=e.featuresMissing,this._estimatedSize=-1,this._estimatedUnusedSizeDirty=!0}}const _b=-1;var vb;!function(e){e[e.FETCH_NEEDED=0]="FETCH_NEEDED",e[e.REFETCH_NEEDED=1]="REFETCH_NEEDED",e[e.FETCHING=2]="FETCHING",e[e.REFETCHING=3]="REFETCHING",e[e.DONE=4]="DONE",e[e.FULL=5]="FULL"}(vb||(vb={}));const yb=(0,Q.vt)();var bb;!function(e){e[e.BACK_TO_FRONT=-1]="BACK_TO_FRONT",e[e.NONE=0]="NONE",e[e.FRONT_TO_BACK=1]="FRONT_TO_BACK"}(bb||(bb={}));let xb=class extends s.A{set maximumNumberOfFeatures(e){e=e||1/0;const t=this._get("maximumNumberOfFeatures");e===t||e<1||(this._set("maximumNumberOfFeatures",e),this._maximumFeaturesUpdated(t,e))}set memoryFactor(e){this.memoryFactor!==e&&(this._set("memoryFactor",e),this._setDirty())}set lodFactor(e){this.lodFactor!==e&&(this._set("lodFactor",e),this._supportsResolution&&this.refetch())}get useTileCount(){return this._useTileCount&&null!=this.context.query.queryFeatureCount}set useTileCount(e){this._useTileCount=e,this.notifyChange("useTileCount")}get updating(){var e,t;return this._dirty||!!this._pendingEdits||this._isFetching||null!==(e=null===(t=this.tileDescriptors)||void 0===t?void 0:t.updating)&&void 0!==e&&e}get memoryForUnusedFeatures(){let e=0;return this._featureTiles.forEach((t=>e+=t.estimatedUnusedSize)),e}get totalVertices(){let e=0;return this._featureTiles.forEach((t=>e+=t.numVertices)),e}get totalFeatures(){let e=0;return this._featureTiles.forEach((t=>e+=t.numFeatures)),e}get hasAllFeatures(){if(this._paused||this.dataUpdating)return!1;for(const[,e]of this._featureTiles)if(!this.hasFullGeometries&&0!==e.emptyFeatureRatio||!e.hasAllFeatures)return!1;return!0}get hasFullGeometries(){return!this._supportsResolution||(!this.tileDescriptors.find((e=>null!=e.resolution))||!this.context.capabilities.supportsQuantization&&"polyline"!==this.context.geometryType)}set filterExtent(e){if(null!=e&&this.context.tilingScheme&&!e.spatialReference.equals(this.context.tilingScheme.spatialReference))return void a.A.getLogger(this).error("#filterExtent=","extent needs to be in the same spatial reference as the tiling scheme");const t=this._get("filterExtent");if(t===e||null!=t&&e&&t.equals(e))return;const i=null!=e?e.clone():null;this._set("filterExtent",i),this._reclip(i,t)}constructor(e){super(e),this._useTileCount=!1,this.dataUpdating=!1,this.running=!1,this.updatingTotal=0,this.updatingRemaining=0,this.expectedFeatureDiff=0,this.maximumNumberOfFeaturesExceeded=!1,this._fullRatio=1,this._farRatio=1,this._changes={updates:{adds:new Array,removes:new Array},adds:new Array,removes:new Array},this._frameTask=Ae.nu,this._dirty=!1,this._featureTiles=new sb.A,this._displayingFeatureReferences=new Map,this._numDisplayingFeatureReferences=0,this._suspended=!0,this._pendingEdits=null,this._applyEditsTilesUpdated=!1,this._isFetching=!1}initialize(){this.addHandles((0,l.on)((()=>this.tileDescriptors),"change",(()=>this._setDirty()),{sync:!0,onListenerAdd:()=>this._setDirty()})),this._objectIdField=this.context.objectIdField,this.FeatureReferenceClass=this.context.capabilities.supportsMultipleResolutions?hb:ub;const e=this.context.scheduler;null!=e&&(this._frameTask=e.registerTask(Ae.W6.FEATURE_TILE_FETCHER,this)),this._setDirty()}destroy(){var e;this._frameTask.remove(),this._featureTiles.forEach((e=>{this._cancelFetchTile(e),this._removeTile(e)})),this._featureTiles.clear(),this._displayingFeatureReferences.clear(),null!==(e=this._pendingEdits)&&void 0!==e&&e.controller.abort(),this._pendingEdits=null}get _paused(){return this._suspended||!!this._pendingEdits}restart(){this._featureTiles.forEach((e=>{this._cancelFetchTile(e),this._clearTile(e),this._resetFetchTile(e)})),null!=this.context.memoryCache&&this.context.memoryCache.clear(),this._setDirty()}refetch(){this._featureTiles.forEach((e=>{this._cancelFetchTile(e),this._resetFetchTile(e)})),null!=this.context.memoryCache&&this.context.memoryCache.clear(),this._setDirty()}suspend(){this._suspended||(this._suspended=!0,this._pause(),this._setDirty())}resume(){this._suspended&&(this._suspended=!1,this._unpause())}getMissingAttributesForFeature(e){for(const[,i]of this._featureTiles){var t;const r=null===(t=i.missingAttributes)||void 0===t?void 0:t.get(e);if(null!=r)return r}}_pause(){this._paused&&(this._featureTiles.forEach((e=>this._cancelFetchTile(e))),this._updated())}_unpause(){this._paused||(this._setDirty(),this._updated())}get availableFields(){let e=null;return this._featureTiles.forEach((t=>{null!=t.displayingFeatures&&0!==t.displayingFeatures.length&&(null==e?e=new Set(t.availableFields):e.forEach((i=>{t.availableFields.has(i)||e.delete(i)})))})),null!=e?e:new Set}applyEdits(e){this._pendingEdits||(this._pendingEdits={edits:Promise.resolve(),count:0,controller:new AbortController},this._pause());const t=this._pendingEdits;t.count++;const i=t.edits.then((()=>e.result.catch((e=>{if((0,o.zf)(e))throw e;return null})).then((e=>e?(this._applyEditsDeleteFeatures(e.deletedFeatures),this._applyEditsAddUpdateFeatures(e.addedFeatures,e.updatedFeatures,t.controller.signal).then((()=>e))):e)).then((e=>(0==--t.count&&(this._pendingEdits===t&&(this._pendingEdits=null),null!=this.context.memoryCache&&this.context.memoryCache.clear(),this._applyEditsTilesUpdated=!1,this._unpause()),e)))));return t.edits=i,this._updated(),i}_applyEditsDeleteFeatures(e){if(0===e.length)return;const t=this.context.globalIdField,i=t&&this.availableFields.has(t),r=new Set,n=this._objectIdField;e.forEach((e=>{let{objectId:s,globalId:o}=e;(!s||s<0)&&t&&o&&(i||a.A.getLogger(this).errorOncePerTick("Editing the specified service requires the layer's globalIdField, ".concat(t," to be included the layer's outFields for updates to be reflected in the view")),s=this._objectIdFromGlobalId(o,n,t)),null!=s&&s>=0&&r.add(s)})),this._featureTiles.forEach((e=>{if(!e.features)return;const t=e.features.filter((e=>!r.has((0,ji.RW)(e,this._objectIdField))));t.length!==e.features.length&&(this._applyEditsTileUpdated(),e.setFeatures(t,0,e.availableFields,e.missingAttributes),this._invalidateCounts())}))}_objectIdFromGlobalId(e,t,i){if(null==e)return null;const r=this.features.find((t=>{var r;return(null===(r=t.attributes)||void 0===r?void 0:r[i])===e}));return r?(0,ji.RW)(r,t):null}async _applyEditsAddUpdateFeatures(e,t,i){const{objectIdField:r,globalIdField:n}=this.context,s=n&&this.availableFields.has(n),o=new Set,l=new Set;for(const a of e){const e=a.objectId;null!=e&&o.add(e)}for(const{objectId:d,globalId:h}of t){let e=d;(null==e||e<0)&&n&&(s||a.A.getLogger(this).errorOncePerTick("Editing the specified service requires the layer's globalIdField, ".concat(n," to be included the layer's outFields for updates to be reflected in the view")),e=this._objectIdFromGlobalId(h,r,n)),null!=e&&e>=0&&(o.add(e),l.add(e))}if(0===o.size)return;const c=[];this._featureTiles.forEach((e=>{const t=this._applyEditsAddUpdateTile(e,o,l,i);t&&c.push(t)})),this._updated(),await Promise.allSettled(c)}async _applyEditsAddUpdateTile(e,t,i,r){if(!e.features)return;const n=this._createQuery(e);n.resultType=void 0,n.cacheHint=!1,n.objectIds=Array.from(t);const s=await this._queryFeatures(n,r);let a=null;if(i.size>0){const t=e.features.filter((e=>!i.has((0,ji.RW)(e,this._objectIdField))));t.length!==e.features.length&&(a=t)}if(s.features.length>0){a||(a=e.features.slice());for(const e of s.features)a.push(e)}a&&(e.hasPreciseFeatureCount&&(e.numFeatures=Math.max(e.numFeatures,a.length)),this._applyEditsTileUpdated(),e.setFeatures(a,0,Ab(e.availableFields,s.fields),Rb(e.missingAttributes,s.missingAttributes)),this._invalidateCounts())}_applyEditsTileUpdated(){this._applyEditsTilesUpdated||(this._applyEditsTilesUpdated=!0,this._updated())}_queryFeatures(e,t){return this.context.query.queryFeaturesDehydrated(e,{signal:t,timeout:Pb})}_setDirty(){this._dirty=!0,this._updated()}runTask(e){const t=this._frameTask.processQueue(e);if(!this._dirty||!this.initialized)return t;this._dirty=!1;const i=this._getListOfTiles();if(this._markTilesNotAlive(i),!e.run((()=>this._addTiles(i,e)))||!e.run((()=>this._filterExtentTiles(i,e)))||!e.run((()=>this._removeTiles(i,e)))||e.done)return void this._setDirty();const r=this._sortTiles(i);e.run((()=>this._showTiles(r,e)))&&e.run((()=>this._fetchTiles(r,e)))&&e.run((()=>this._updateMemoryEstimates(r,e)))||this._setDirty(),this._updated(),this.updating||this._updateMaximumNumberOfFeaturesExceeded()}_markTilesNotAlive(e){for(const t of e)t.alive=!1}_addTiles(e,t){return!(this._suspended||!this.tileDescriptors)&&(this.tileDescriptors.forEach((i=>{const r=this._featureTiles.get(i.id);r?r.alive=!0:t.done||(e.push(this._addTile(i)),t.madeProgress())})),t.hasProgressed)}_filterExtentTiles(e,t){for(const i of e){if(t.done)break;i.alive&&(i.filtered=!i.intersects(this.filterExtent),i.filtered&&(this._clearTile(i),t.madeProgress()))}return t.hasProgressed}_removeTiles(e,t){for(let i=e.length-1;i>=0&&!t.done;i--){const r=e[i];r.alive||(this._removeTile(r),i!==e.length-1&&(e[i]=e[e.length-1]),e.pop(),t.madeProgress())}return t.hasProgressed}_sortTiles(e){return e.sort(((e,t)=>{var i,r;return(null!==(i=e.descriptor.loadPriority)&&void 0!==i?i:0)-(null!==(r=t.descriptor.loadPriority)&&void 0!==r?r:0)})),e}_showTiles(e,t){const i=this._updateRatio(e),r=e=>{const t=this._fullRatio<1?i(e)*this._farRatio:1;return e.reduceFeatures(t,this.memoryFactor,this._objectIdField)&&this._setDirty(),this._showTile(e)};for(const n of e)if(!t.run((()=>r(n)))){this._setDirty();break}return t.hasProgressed}_fetchTiles(e,t){if(this._paused)return!1;let i=!1;for(const r of e){if(!r.needsFetching)continue;const e=null!=this.context.memoryCache?this.context.memoryCache.pop(r.id):null;if(null==e){if(this._needsNumFeatures(r)){const e=new AbortController,n=this._fetchTileCount(r,e.signal);this._handleRequest(r,n,e,(()=>r.numFeatures=-2)),i=!0,t.madeProgress()}if(t.done)return!0}else r.cache=e,this._setDirty(),this._scheduleUpdated(),t.madeProgress()}if(i)return t.hasProgressed;for(const r of e)if(r.needsFetching){const e=new AbortController,i=this._fetchTile(r,e.signal);if(this._handleRequest(r,i,e,(e=>{r.setFeatures([],0,null,void 0),this._invalidateCounts(),r.featuresMissing=!1,r.fetchFailed=!0,this.context.logFetchError(a.A.getLogger(this),e)})),t.madeProgress())return!0}return t.hasProgressed}_updateMemoryEstimates(e,t){return e.some((e=>!t.run((()=>e.updateMemoryEstimates()))&&(this._setDirty(),!0))),t.hasProgressed}_reclip(e,t){if(!this.initialized)return;const i=new Array;this._featureTiles.forEach((r=>{null!=r.displayingFeatures&&0!==r.displayingFeatures.length&&(r.intersectionIncludingBorrowed(t,Ob),r.intersectionIncludingBorrowed(e,Tb),(0,Q.aI)(Ob,Tb)||i.push(r))})),this._refreshDisplayingFeatures(i),this._updated()}_refreshDisplayingFeatures(e){const t=new Set,i=this._changes.updates;for(const r of e)if(null!=r.displayingFeatures)for(const e of r.displayingFeatures){const r=(0,ji.RW)(e,this._objectIdField);if(t.has(r))continue;t.add(r);const n=this._displayingFeatureReferences.get(r).feature;i.removes.push(n),i.adds.push(n)}this._applyChanges()}_updated(){let e=0;if(this._paused||this._featureTiles.forEach((t=>t.isFetching?++e:0)),this._isFetching=e>0,this._set("running",this._dirty),e>0||this._applyEditsTilesUpdated?this._set("dataUpdating",!0):this._dirty||this._set("dataUpdating",!1),this.updating){let t=0,i=0,r=0,n=0,s=0;const a=this._displayingFeatureReferences.size/this._numDisplayingFeatureReferences;this._featureTiles.forEach((e=>{if(++i,e.isFetching&&e.hasPreciseFeatureCount){const t=this._maximumFeaturesForTile(e)*(1-e.emptyFeatureRatio),i=null!=e.displayingFeatures?e.displayingFeatures.length*a:0;s+=t-i}e.needsFetching?++n:e.numFeatures>0&&(++r,t+=e.numFeatures)})),n+=e;let o=0,l=0;t?(l=t,o=Math.min(n*t/r,t)):(l=i,o=n),s=Math.min(this.maximumNumberOfFeatures-this.features.length,s),this._set("updatingTotal",l),this._set("updatingRemaining",o),this._set("expectedFeatureDiff",s)}else this._set("updatingTotal",0),this._set("updatingRemaining",0),this._set("expectedFeatureDiff",0);this.debugger&&this.debugger.update()}_updateMaximumNumberOfFeaturesExceeded(){const e=(0,Ui.Bs)(this._featureTiles,(e=>e.perTileMaximumNumberOfFeaturesExceeded));this._set("maximumNumberOfFeaturesExceeded",e)}_updateRatio(e){const t=function(e){let t=0;for(const i of e)i.features&&i.features.length>0&&i.alive&&(t=Math.max(t,i.descriptor.lij[0]));return t}(e),i=e=>1/(1<<Math.max(0,t-e.descriptor.lij[0]));let r=0,n=0;for(const s of e){const e=s.numFeatures;r+=e,n+=e*i(s)}return this._fullRatio=Math.min(1,this.maximumNumberOfFeatures/r),this._farRatio=this.maximumNumberOfFeatures/n,this._scheduleUpdated(),i}_maximumFeaturesUpdated(e,t){e!==t&&(t>e&&this._featureTiles.forEach((e=>{if(!e.featuresMissing)return;const t=this._maximumFeaturesForTile(e);e.features&&(e.features.length>=t||e.fetchStatus===vb.FULL)||(this._cancelFetchTile(e),this._resetFetchTile(e))})),this._setDirty())}_addTile(e){const t=new mb(e);return this._featureTiles.set(t.id,t),this._resetFetchTile(t),this._referenceDisplayingFeaturesFromRelatedTiles(t),t}_referenceDisplayingFeaturesFromRelatedTiles(e){const t=e.descriptor.resolution;this._featureTiles.forEach((i=>{if(!(null==i.displayingFeatures||e===i||e.descriptor.lij&&i.descriptor.lij&&!function(e,t){if(!e||!t||e[0]===t[0])return!1;const i=e[0]<t[0],r=i?e:t,n=i?t:e,s=1<<n[0]-r[0];return Math.floor(n[1]/s)===r[1]&&Math.floor(n[2]/s)===r[2]}(e.descriptor.lij,i.descriptor.lij))){null==e.displayingFeatures&&(e.displayingFeatures=[]),e.descriptor.extent&&i.descriptor.extent&&(null==e.extentIncludingBorrowedFeatures&&(e.extentIncludingBorrowedFeatures=(0,Q.o8)(e.descriptor.extent)),(0,Q.fT)(e.extentIncludingBorrowedFeatures,i.descriptor.extent,e.extentIncludingBorrowedFeatures));for(const r of i.displayingFeatures){e.displayingFeatures.push(r);const i=this._displayingFeatureReferences.get((0,ji.RW)(r,this._objectIdField));i.ref(i.feature,t),this._numDisplayingFeatureReferences++}}})),e.featureLimit=null!=e.displayingFeatures?e.displayingFeatures.length:0}_removeTile(e){this._clearTile(e),this._featureTiles.delete(e.id)}_resetFetchTile(e){e.filtered=!e.intersects(this.filterExtent),e.filtered?e.needsFetching&&(e.fetchStatus=vb.DONE):e.fetchStatus=vb.FETCH_NEEDED}_cancelFetchTile(e){const t=e.requestController;null!=t&&(e.requestController=null,e.resetFetching(),t.abort())}async _fetchTileCount(e,t){return e.numFeatures=await this._fetchCount(e,t),this._updateRatio(this._getListOfTiles()),e.fetchStatus===vb.REFETCHING?vb.REFETCH_NEEDED:vb.FETCH_NEEDED}async _fetchTile(e,t){e.fetchFailed=!1;const i=this._maximumFeaturesForTile(e);if(i<=0)return e.hasPreciseFeatureCount&&0===e.numFeatures||(e.fetchFailed=!0),function(e){return e.setFeatures([],0,null,void 0),e.featuresMissing=!1,vb.DONE}(e);const r=this._getMaxRecordCount(e),n=Math.ceil(i/r);if(Sb(e)||!this.context.capabilities.supportsMaxRecordCountFactor||e.numFeatures<=i&&n>ob.A.MAX_MAX_RECORD_COUNT_FACTOR)return this._fetchPagedTile(e,t);const s=this._createQuery(e);if(s.maxRecordCountFactor=Math.ceil(i/r),e.isRefetching&&e.features&&e.features.length>0){const t=Math.ceil(e.features.length/(1-e.emptyFeatureRatio)/r);s.maxRecordCountFactor=Math.max(t+1,s.maxRecordCountFactor)}const{features:a,exceededTransferLimit:l,fields:c,missingAttributes:d}=await this._queryFeatures(s,t),h=l?s.maxRecordCountFactor>=ob.A.MAX_MAX_RECORD_COUNT_FACTOR?vb.FULL:vb.DONE:vb.FULL;return await this._frameTask.schedule((()=>{e.featuresMissing=e.hasPreciseFeatureCount&&a.length<e.numFeatures||!!l;const t=this._removeEmptyFeatures(a);e.setFeatures(a,t,Cb(c),Rb(void 0,d))}),t),(0,o.Te)(t),this._invalidateCounts(),h}async _fetchCount(e,t){return this.context.query.queryFeatureCount(this._createFeatureCountQuery(e),{signal:t})}async _fetchPagedTile(e,t){let i,r=0,n=0,s=0,a=this._maximumFeaturesForTile(e)-s;const l=this._getMaxRecordCount(e);let c,d=null;for(;;){const h=this._createQuery(e),u=this._setPagingParameters(h,r,a,l),{features:p,exceededTransferLimit:f,fields:g,missingAttributes:m}=await this._queryFeatures(h,t);if(await this._frameTask.schedule((()=>{u&&(r+=h.num),s+=p.length,n+=this._removeEmptyFeatures(p),e.featuresMissing=u&&e.hasPreciseFeatureCount&&r<e.numFeatures||!!f,i=i?i.concat(p):p,d=Ab(d,g),c=Rb(c,m),e.setFeatures(i,n,d,c)}),t),(0,o.Te)(t),this._invalidateCounts(),this._setDirty(),a=this._maximumFeaturesForTile(e)-s,!u||!f||a<=0)return f?vb.DONE:vb.FULL}}_createFeatureCountQuery(e){const t=this._createQuery(e);return this.context.capabilities.supportsCacheHint&&(t.resultType=void 0,t.cacheHint=!0),t}_createQuery(e){const t=this.context.createQuery(),i=e.descriptor.extent;if(i){const e=this.context.tilingScheme.spatialReference;t.geometry=(0,Q.w1)(i,e)}return this._setResolutionParams(t,e),this._useTileQuery(e)?t.resultType="tile":this.context.capabilities.supportsCacheHint&&(t.cacheHint=!0),t}_setPagingParameters(e,t,i,r){return!!this.context.capabilities.supportsPagination&&(e.start=t,i>0&&this.context.capabilities.supportsMaxRecordCountFactor?(e.maxRecordCountFactor=Math.ceil(i/r),e.num=Math.min(e.maxRecordCountFactor*r,i)):e.num=Math.min(r),!0)}_getEffectiveTileResolution(e){if(null==e.descriptor.resolution)return null;const t=this.context.viewingMode===ae.RT.Global?this.context.tilingScheme.resolutionAtLevel(3):1/0;return Math.min(e.descriptor.resolution,t)/this.lodFactor}get _supportsResolution(){return this.context.capabilities.supportsMultipleResolutions&&"point"!==this.context.geometryType}_setResolutionParams(e,t){if(!this._supportsResolution)return;const i=this._getEffectiveTileResolution(t);null!=i&&(this.context.capabilities.supportsQuantization?e.quantizationParameters=new ab.A({mode:"view",originPosition:"upper-left",tolerance:i,extent:this.context.fullExtent}):"polyline"===this.context.geometryType&&(e.maxAllowableOffset=i))}_removeEmptyFeatures(e){const t=e.length;for(let i=0;i<e.length;){const t=e[i];(0,ji.ao)(t.geometry)?++i:(e[i]=e[e.length-1],--e.length)}return t-e.length}_needsNumFeatures(e){return this.useTileCount&&e.needsFeatureCount&&!Sb(e)}_getMaxRecordCount(e){const{tileMaxRecordCount:t,maxRecordCount:i}=this.context;return this._useTileQuery(e)&&null!=t&&t>0&&this.context.capabilities.supportsResultType?t:null!=i&&i>0?i:Eb}_useTileQuery(e){return(!Sb(e)||!this.context.capabilities.supportsCacheHint)&&this.context.capabilities.supportsResultType}_handleRequest(e,t,i,r){e.fetchStatus=e.needsRefetching?vb.REFETCHING:vb.FETCHING,e.requestController=i;let n=!1;t.then((t=>{e.requestController=null,e.fetchStatus=t})).catch((t=>{e.requestController===i&&(e.requestController=null,e.fetchStatus=vb.DONE),(0,o.zf)(t)?n=!0:r(t)})).then((()=>{n||this._setDirty(),this._scheduleUpdated()}))}_scheduleUpdated(){this.hasHandles("scheduleUpdated")||this.addHandles((0,c._)((()=>{this.removeHandles("scheduleUpdated"),this._updated()})),"scheduleUpdated")}_showTile(e){if(null!=e.displayingFeatures&&!e.needsDisplayUpdate)return!1;const t=e.features;if(0===e.featureLimit||!t){const t=null!=e.displayingFeatures&&e.displayingFeatures.length>0;return this._hideTileFeatures(e),e.displayingFeatures=[],t}const i=e.descriptor.resolution,r=this._changes.updates,n=this._changes.adds,s=Math.min(e.featureLimit,t.length);e.featureLimit=s;for(let a=0;a<s;++a){const e=t[a],s=(0,ji.RW)(e,this._objectIdField),o=this._displayingFeatureReferences.get(s);if(o){const t=o.ref(e,i);t.oldVersion!==t.newVersion&&(t.oldVersion&&r.removes.push(t.oldVersion),t.newVersion&&r.adds.push(t.newVersion))}else this._displayingFeatureReferences.set(s,new this.FeatureReferenceClass(e,i)),n.push(e);this._numDisplayingFeatureReferences++}return this._hideTileFeatures(e),this._applyChanges(),e.displayingFeatures=t.slice(0,s),!0}_hideTile(e){this._cancelFetchTile(e),this._hideTileFeatures(e)}_hideTileFeatures(e){if(null==e.displayingFeatures)return;const t=this._changes.updates,i=this._changes.removes;for(const r of e.displayingFeatures){const n=(0,ji.RW)(r,this._objectIdField),s=this._displayingFeatureReferences.get(n);if(!s)continue;const a=s.unref(e.descriptor.resolution);this._numDisplayingFeatureReferences--,a?a.oldVersion!==a.newVersion&&(null==a.newVersion?(this._displayingFeatureReferences.delete(n),a.oldVersion&&i.push(a.oldVersion)):(t.adds.push(a.newVersion),a.oldVersion&&t.removes.push(a.oldVersion))):console.error("Hiding unreferenced feature")}this._applyChanges(),e.displayingFeatures=null}_applyChanges(){const e=this._changes.updates;e.removes.length>0&&(this.features.removeMany(e.removes),e.removes.length=0),e.adds.length>0&&(this.features.addMany(e.adds),e.adds.length=0);const t=this._changes.adds,i=this._changes.removes,r=Math.min(t.length,i.length);let n=0;for(;n<r;){const e=Math.min(n+Mb,r);this.features.addMany(t.slice(n,e)),this.features.removeMany(i.slice(n,e)),n=e}t.length>r&&this.features.addMany(0===n?t:t.slice(n)),i.length>r&&this.features.removeMany(0===n?i:i.slice(n)),t.length=0,i.length=0}_clearTile(e){if(this._hideTile(e),e.features&&null!=this.context.memoryCache){const t=16+e.estimatedSize;this.context.memoryCache.put(e.id,e.cache,t)}e.setFeatures(null,0,null,void 0),this._invalidateCounts()}_invalidateCounts(){this.notifyChange("totalVertices"),this.notifyChange("totalFeatures"),this.notifyChange("memoryForUnusedFeatures")}_getListOfTiles(){return Array.from(this._featureTiles.values())}get storedFeatures(){return this._getListOfTiles().reduce(((e,t)=>e+(t.features?t.features.length:0)),0)}get missingTiles(){return Array.from(this._featureTiles.values()).reduce(((e,t)=>e+(t.needsFetching||t.isFetching?1:0)),0)}_maximumFeaturesForTile(e){const t=e.hasPreciseFeatureCount?e.numFeatures:1/0,i=e.hasPreciseFeatureCount?t:this.maximumNumberOfFeatures,r=this._fullRatio<1?this._farRatio:1;return Math.min(Math.ceil(i*r/(1-e.emptyFeatureRatio)),t)}get test(){return{process:e=>this.runTask(e),getFeatureTileById:e=>this._featureTiles.get(e),forEachFeatureTile:e=>this._featureTiles.forEach(e)}}};function Sb(e){return"dummy-tile-full-extent"===e.id}function wb(e){switch(e.geometryType){case"polyline":return!0;case"polygon":return e.capabilities&&e.capabilities.query&&e.capabilities.query.supportsQuantization;default:return!1}}function Cb(e){return null==e?new Set:new Set(e.map((e=>e.name)))}function Ab(e,t){if(null==e||null==t)return Cb(t);const i=new Set;for(const{name:r}of t)e.has(r)&&i.add(r);return i}function Rb(e,t){var i;if(null===t||void 0===t||!t.length)return e;null!==(i=e)&&void 0!==i||(e=new Map);const r=()=>new Set;for(const{objectId:n,attribute:s}of t)(0,Ui.tE)(e,n,r).add(s);return e}(0,r._)([(0,d.MZ)({constructOnly:!0})],xb.prototype,"features",void 0),(0,r._)([(0,d.MZ)()],xb.prototype,"tileDescriptors",void 0),(0,r._)([(0,d.MZ)({value:1/0})],xb.prototype,"maximumNumberOfFeatures",null),(0,r._)([(0,d.MZ)({value:1})],xb.prototype,"memoryFactor",null),(0,r._)([(0,d.MZ)({value:1})],xb.prototype,"lodFactor",null),(0,r._)([(0,d.MZ)()],xb.prototype,"useTileCount",null),(0,r._)([(0,d.MZ)({readOnly:!0})],xb.prototype,"updating",null),(0,r._)([(0,d.MZ)({readOnly:!0})],xb.prototype,"dataUpdating",void 0),(0,r._)([(0,d.MZ)({readOnly:!0})],xb.prototype,"running",void 0),(0,r._)([(0,d.MZ)({readOnly:!0})],xb.prototype,"updatingTotal",void 0),(0,r._)([(0,d.MZ)({readOnly:!0})],xb.prototype,"updatingRemaining",void 0),(0,r._)([(0,d.MZ)({readOnly:!0})],xb.prototype,"expectedFeatureDiff",void 0),(0,r._)([(0,d.MZ)({readOnly:!0})],xb.prototype,"memoryForUnusedFeatures",null),(0,r._)([(0,d.MZ)({readOnly:!0})],xb.prototype,"maximumNumberOfFeaturesExceeded",void 0),(0,r._)([(0,d.MZ)({readOnly:!0})],xb.prototype,"totalVertices",null),(0,r._)([(0,d.MZ)({readOnly:!0})],xb.prototype,"totalFeatures",null),(0,r._)([(0,d.MZ)({readOnly:!0})],xb.prototype,"hasAllFeatures",null),(0,r._)([(0,d.MZ)({readOnly:!0})],xb.prototype,"hasFullGeometries",null),(0,r._)([(0,d.MZ)()],xb.prototype,"filterExtent",null),(0,r._)([(0,d.MZ)({constructOnly:!0})],xb.prototype,"context",void 0),(0,r._)([(0,d.MZ)()],xb.prototype,"_dirty",void 0),(0,r._)([(0,d.MZ)()],xb.prototype,"_suspended",void 0),(0,r._)([(0,d.MZ)()],xb.prototype,"_pendingEdits",void 0),(0,r._)([(0,d.MZ)()],xb.prototype,"_applyEditsTilesUpdated",void 0),(0,r._)([(0,d.MZ)()],xb.prototype,"_paused",null),(0,r._)([(0,d.MZ)()],xb.prototype,"_isFetching",void 0),xb=(0,r._)([(0,u.$)("esri.views.3d.layers.support.FeatureTileFetcher3D")],xb);const Eb=2e3,Ob=(0,Q.vt)(),Tb=(0,Q.vt)(),Pb=6e5,Mb=200;var Ib=i(21405),Db=i(48670),Lb=i(45417),Fb=i(22848),Nb=i(88235);class Vb{constructor(e){const t=Vb.checkUnsupported(e);if(null!=t)throw t;const i=e;this.spatialReference=i.spatialReference,this._isWebMercator=this.spatialReference.isWebMercator,this._isGCS=(0,zi.canProjectToWGS84ComparableLonLat)(this.spatialReference)||(0,G.q8)(this.spatialReference)||(0,G.KQ)(this.spatialReference),this.origin=[i.origin.x,i.origin.y],this.pixelSize=i.size[0],this.dpi=i.dpi;const r=i.lods.reduce(((e,t,i)=>(t.level<e.min&&(e.min=t.level,e.minIndex=i),e.max=Math.max(e.max,t.level),e)),{min:1/0,minIndex:0,max:-1/0}),n=i.lods[r.minIndex],s=2**n.level;let a=n.resolution*s,o=n.scale*s;this.levels=new Array(r.max+1);for(let l=0;l<this.levels.length;l++)this.levels[l]={resolution:a,scale:o,tileSize:[a*i.size[0],a*i.size[1]]},a/=2,o/=2}clone(){return new Vb(this.toTileInfo())}toTileInfo(){return new Nb.A({dpi:this.dpi,origin:new Zv.A({x:this.origin[0],y:this.origin[1],spatialReference:this.spatialReference}),size:[this.pixelSize,this.pixelSize],spatialReference:this.spatialReference,lods:this.levels.map(((e,t)=>new Fb.A({level:t,scale:e.scale,resolution:e.resolution})))})}getExtent(e,t,i,r){const n=this.levels[e],s=n.tileSize[0],a=n.tileSize[1];r[0]=this.origin[0]+i*s,r[2]=this.origin[0]+(i+1)*s,r[3]=this.origin[1]-t*a,r[1]=this.origin[1]-(t+1)*a}convertExtentToRadians(e,t){this._isWebMercator?(t[0]=(0,Lb.yw)(e[0]),t[1]=(0,Lb.jg)(e[1]),t[2]=(0,Lb.yw)(e[2]),t[3]=(0,Lb.jg)(e[3])):this._isGCS&&(t[0]=(0,U.kU)(e[0]),t[1]=(0,U.kU)(e[1]),t[2]=(0,U.kU)(e[2]),t[3]=(0,U.kU)(e[3]))}getExtentGeometry(e,t,i){let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:new xp.A;return this.getExtent(e,t,i,Gb),r.spatialReference=this.spatialReference,r.xmin=Gb[0],r.ymin=Gb[1],r.xmax=Gb[2],r.ymax=Gb[3],r.zmin=void 0,r.zmax=void 0,r}ensureMaxLod(e){if(null==e)return!1;let t=!1;for(;this.levels.length<=e;){const e=this.levels[this.levels.length-1],i=e.resolution/2;this.levels.push({resolution:i,scale:e.scale/2,tileSize:[i*this.pixelSize,i*this.pixelSize]}),t=!0}return t}capMaxLod(e){this.levels.length>e+1&&(this.levels.length=e+1)}getMaxLod(){return this.levels.length-1}scaleAtLevel(e){return this.levels[0].scale/2**e}levelAtScale(e){const t=this.levels[0].scale;return e>=t?0:Math.log(t/e)*Math.LOG2E}resolutionAtLevel(e){return this.levels[0].resolution/2**e}compatibleWith(e){if(!(e instanceof Vb)){if(Vb.checkUnsupported(e))return!1;e=new Vb(e)}if(!e.spatialReference.equals(this.spatialReference))return!1;if(e.pixelSize!==this.pixelSize)return!1;const t=Math.min(this.levels.length,e.levels.length)-1,i=this.levels[t].resolution;let r=.5*i;return!(!(0,U.Sp)(e.origin[0],this.origin[0],r)||!(0,U.Sp)(e.origin[1],this.origin[1],r))&&(r=.5*i/2**t/this.pixelSize*12,(0,U.Sp)(i,e.levels[t].resolution,r))}rootTilesInExtent(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1/0;const r=new Array,n=this.levels[0].tileSize;if(null==e||0===n[0]||0===n[1])return r;Vb.computeRowColExtent(e,n,this.origin,Gb);let s=Gb[1],a=Gb[3],o=Gb[0],l=Gb[2];const c=l-o,d=a-s;if(c*d>i){const e=Math.floor(Math.sqrt(i));d>e&&(s=s+Math.floor(.5*d)-Math.floor(.5*e),a=s+e),c>e&&(o=o+Math.floor(.5*c)-Math.floor(.5*e),l=o+e)}for(let h=s;h<a;h++)for(let e=o;e<l;e++)r.push([0,h,e]);return null!=t&&(t[0]=this.origin[0]+o*n[0],t[1]=this.origin[1]-a*n[1],t[2]=this.origin[0]+l*n[0],t[3]=this.origin[1]-s*n[1]),r}static computeRowColExtent(e,t,i,r){const n=.001*(e[2]-e[0]+(e[3]-e[1]));r[0]=Math.max(0,Math.floor((e[0]+n-i[0])/t[0])),r[2]=Math.max(0,Math.ceil((e[2]-n-i[0])/t[0])),r[1]=Math.max(0,Math.floor((i[1]-e[3]+n)/t[1])),r[3]=Math.max(0,Math.ceil((i[1]-e[1]-n)/t[1]))}static isPowerOfTwo(e){const t=e.lods,i=t[0].resolution*2**t[0].level;return!t.some((e=>!(0,U.b6)(e.resolution,i/2**e.level)))}static hasGapInLevels(e){const t=e.lods.map((e=>e.level));t.sort(((e,t)=>e-t));for(let i=1;i<t.length;i++)if(t[i]!==t[0]+i)return!0;return!1}static tileSizeSupported(e){const t=e.size[1];return t===e.size[0]&&0==(t&t-1)&&t>=128&&t<=512}static hasOriginPerLODs(e){const t=e.origin;return e.lods.some((e=>null!=e.origin&&(e.origin[0]!==t.x||e.origin[1]!==t.y)))}static getMissingTileInfoError(){return new oe.A("tilingscheme:tile-info-missing","Tiling scheme must have tiling information")}static checkUnsupported(e){return null==e?new oe.A("tilingscheme:tile-info-missing","Tiling scheme must have tiling information"):e.lods.length<1?new oe.A("tilingscheme:generic","Tiling scheme must have at least one level"):Vb.isPowerOfTwo(e)?Vb.hasGapInLevels(e)?new oe.A("tilingscheme:gaps","Tiling scheme levels must not have gaps between min and max level"):Vb.tileSizeSupported(e)?Vb.hasOriginPerLODs(e)?new oe.A("tilingscheme:multiple-origin","Tiling scheme levels must not have their own origin"):null:new oe.A("tilingscheme:tile-size","Tiles must be square and size must be one of [128, 256, 512]"):new oe.A("tilingscheme:power-of-two","Tiling scheme must be power of two")}static fromExtent(e,t){const i=e[2]-e[0],r=e[3]-e[1],n=(0,R.GA)(t),s=1.2*Math.max(i,r),a=256,o=new Vb(new Nb.A({size:[a,a],origin:new Zv.A({x:e[0]-.5*(s-i),y:e[3]+.5*(s-r)}),lods:[new Fb.A({level:0,resolution:s/a,scale:1/(a/96*.0254/(s*n))})],spatialReference:t}));return o.ensureMaxLod(20),o}static makeWebMercatorAuxiliarySphere(e){const t=new Vb(Vb.WebMercatorAuxiliarySphereTileInfo);return t.ensureMaxLod(e),t}static makeGCSWithTileSize(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:256,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:16;const r=256/t,n=new Vb(new Nb.A({size:[t,t],origin:new Zv.A({x:-180,y:90,spatialReference:e}),spatialReference:e,lods:[new Fb.A({level:0,resolution:.703125*r,scale:295497598.570834*r})]}));return n.ensureMaxLod(i),n}get test(){return{isWebMercator:this._isWebMercator,isGCS:this._isGCS}}}Vb.WebMercatorAuxiliarySphereTileInfo=new Nb.A({size:[256,256],origin:new Zv.A({x:-20037508.342787,y:20037508.342787,spatialReference:kt.A.WebMercator}),spatialReference:kt.A.WebMercator,lods:[new Fb.A({level:0,resolution:156543.03392800014,scale:591657527.591555})]}),Vb.WebMercatorAuxiliarySphere=Vb.makeWebMercatorAuxiliarySphere(19);const Gb=(0,Q.vt)();var Ub=i(92135);const zb=[[0,179,255],[117,62,128],[0,104,255],[215,189,166],[32,0,193],[98,162,206],[102,112,129],[52,125,0],[142,118,246],[138,83,0],[92,122,255],[122,55,83],[0,142,255],[81,40,179],[0,200,244],[13,24,127],[0,170,147],[19,58,241],[22,44,35]];class Bb{constructor(e,t,i){this._loadingGraphics=new Map,this._loadedGraphics=new Map,this._pendingGraphics=new Map,this._dataExtentGraphic=null,this._enabled=!0,this._tileFetcher=e,this._view=i,this._tilingScheme=new Vb(t),this._loadedSymbols=zb.map((e=>new $i.A({symbolLayers:new S.A([new Qi.A({material:{color:[e[0],e[1],e[2],.6]},outline:{color:"black",size:1}})])}))),this._loadingSymbols=[new $i.A({symbolLayers:new S.A([new Qi.A({material:{color:[200,200,200,.4]},outline:{color:[30,30,30],size:1}})])})],this._pendingSymbols=[new $i.A({symbolLayers:new S.A([new Qi.A({material:{color:[100,100,100,.4]},outline:{color:[30,30,30],size:1}})])})],this._dataExtentSymbol=new $i.A({symbolLayers:new S.A([new Qi.A({material:{color:[0,0,0,0]},outline:{color:"green",size:4}})])})}destroy(){this.enabled=!1}get enabled(){return this._enabled}set enabled(e){this._enabled=e,this.update()}update(){this._enabled?(this._synchronizeMaps(this._loadingGraphics,{filter:e=>e.isFetching,symbols:this._loadingSymbols}),this._synchronizeMaps(this._loadedGraphics,{filter:e=>!e.isFetching,symbols:this._loadedSymbols}),this._synchronizeMaps(this._pendingGraphics,{filter:e=>!e.isFetching,symbols:this._pendingSymbols}),this.showDataExtent(this._tileFetcher.filterExtent)):(this._loadingGraphics.forEach((e=>{this._view.graphics.removeMany(e)})),this._loadingGraphics.clear(),this._loadedGraphics.forEach((e=>{this._view.graphics.removeMany(e)})),this._loadedGraphics.clear(),this._pendingGraphics.forEach((e=>{this._view.graphics.removeMany(e)})),this._pendingGraphics.clear(),this._dataExtentGraphic&&(this._view.graphics.remove(this._dataExtentGraphic),this._dataExtentGraphic=null))}showDataExtent(e){if(this._dataExtentGraphic&&(this._view.graphics.remove(this._dataExtentGraphic),this._dataExtentGraphic=null),null==e)return;const t=wa.A.fromExtent(e);this._dataExtentGraphic=new y.A({geometry:t,symbol:this._dataExtentSymbol}),this._view.graphics.add(this._dataExtentGraphic)}_synchronizeMaps(e,t){const i=[];e.forEach(((e,r)=>{const n=this._tileFetcher.test.getFeatureTileById(r);n&&t.filter(n)||(this._view.graphics.removeMany(e),i.push(r))})),i.forEach((t=>e.delete(t))),this._tileFetcher.test.forEachFeatureTile((i=>{if(t.filter(i)&&!e.has(i.id)){const[r,n,s]=i.descriptor.lij;this._tilingScheme.ensureMaxLod(r);const a=this._tilingScheme.getExtentGeometry(r,n,s),o=[new y.A({geometry:a,symbol:t.symbols[r%t.symbols.length]}),new y.A({geometry:a.center,symbol:new Xi.A({verticalOffset:new Db.A({screenLength:40/.75}),callout:new Ub.A({color:"white",border:{color:"black"}}),symbolLayers:new S.A([new Ib.A({text:"".concat(r,"/").concat(n,"/").concat(s),halo:{color:"white",size:1/.75},material:{color:"black"},size:16})])})})];e.set(i.id,o),this._view.graphics.addMany(o)}}))}}let Hb=class extends((0,K.g)(s.A)){get dataUpdating(){var e,t;return null!==(e=null===(t=this._tileFetcher)||void 0===t?void 0:t.dataUpdating)&&void 0!==e&&e}set extent(e){if(null!=e&&!e.spatialReference.equals(this.layerView.view.spatialReference))return void a.A.getLogger(this).error("#extent=","extent needs to be in the same spatial reference as the view");const t=this._get("extent");if(t===e)return;if(null!=t&&e&&t.equals(e))return;const i=null!=e?e.clone():null;this._set("extent",i)}get updating(){return!!(null!=this._tileFetcher&&this._tileFetcher.updating||null!=this._fetchDataInfoPromise||"tiles"===this.mode&&this.layerView.view.featureTiles&&this.layerView.view.featureTiles.updating||this._updatingHandles&&this._updatingHandles.updating)}get updatingTotal(){return this.updating&&null!=this._tileFetcher?this._tileFetcher.updatingTotal:0}get updatingRemaining(){return this.updating&&null!=this._tileFetcher?this._tileFetcher.updatingRemaining:0}get expectedFeatureDiff(){return this.updating&&null!=this._tileFetcher?this._tileFetcher.expectedFeatureDiff:0}get memoryForUnusedFeatures(){return null!=this._tileFetcher?this._tileFetcher.memoryForUnusedFeatures:0}get maximumNumberOfFeaturesExceeded(){return!(null==this._tileFetcher||!this._tileFetcher.maximumNumberOfFeaturesExceeded)}get maximumNumberOfFeatures(){var e,t;return null!==(e=null===(t=this.displayFeatureLimit)||void 0===t?void 0:t.maximumNumberOfFeatures)&&void 0!==e?e:0}set maximumNumberOfFeatures(e){e!==this.maximumNumberOfFeatures&&this._overrideIfSome("maximumNumberOfFeatures",e)}get hasMaximumNumberOfFeaturesOverride(){return this._isOverridden("maximumNumberOfFeatures")}get hasAllFeatures(){return this.serviceDataCount===Zb.noServiceDataCount&&"snapshot"===this.mode&&this.hasAllFeaturesInView||this.serviceDataCount===this.graphics.length}get hasAllFeaturesInView(){var e,t;return null!==(e=null===(t=this._tileFetcher)||void 0===t?void 0:t.hasAllFeatures)&&void 0!==e&&e}get hasFullGeometries(){var e,t;return null!==(e=null===(t=this._tileFetcher)||void 0===t?void 0:t.hasFullGeometries)&&void 0!==e&&e}get mode(){var e;const t=this.layerView.layer;if("feature"===t.type&&null!=t.infoFor3D)return"snapshot";if(this._forceTilesMode)return"tiles";const i=this.layerView.view;if(!1===(null===(e=i.qualitySettings)||void 0===e||null===(e=e.graphics3D)||void 0===e?void 0:e.snapshotAvailable)||this.serviceDataCount===Zb.noServiceDataCount||this._snapshotLimitExceeded||this.maximumNumberOfFeaturesExceeded||i.quality<1)return"tiles";const r=i&&i.featureTiles,n=r&&r.tilingScheme;if(t&&t.minScale&&this.serviceDataExtent&&n){const e=this._approximateExtentSizeAtScale(t.minScale,n);if((this.serviceDataExtent.width/e+this.serviceDataExtent.height/e)/2>Zb.maxSnapshotMinScaleFactor)return"tiles"}return!this.maximumNumberOfFeatures||this.serviceDataCount<=this.maximumNumberOfFeatures?"snapshot":"tiles"}get maxTotalSnapshotVertices(){var e;const t=this._get("maxTotalSnapshotVertices")||0,i="snapshot"===this.mode&&(null===(e=this._tileFetcher)||void 0===e?void 0:e.totalVertices)||0;return Math.max(t,i)}_approximateExtentSizeAtScale(e,t){const i=this.layerView.view,r=Math.ceil((i.width/t.pixelSize+i.height/t.pixelSize)/2),n=t.levels[0];return r*((n.tileSize[0]/(n.scale/e)+n.tileSize[1]/(n.scale/e))/2)}get tileDescriptors(){const e=this.layerView.view.featureTiles;return"snapshot"===this.mode?new S.A([{id:"dummy-tile-full-extent",lij:[0,0,0]}]):e?e.tiles:new S.A}get test(){return{fetchDataInfoPromise:this._fetchDataInfoPromise,tileFetcher:this._tileFetcher}}constructor(e){super(e),this.type="feature-tile-3d",this._updatingHandles=new F.U,this.serviceDataExtent=null,this.serviceDataCount=Zb.noServiceDataCount,this._snapshotLimitExceeded=!1,this.displayFeatureLimit=null,this._forceTilesMode=!1,this._suspended=!1,this._tileFetcher=null,this._fetchDataInfoPromise=null,this._fetchDataInfoAbortController=null,this._lifeCycleAbortController=new AbortController}initialize(){this._updatingHandles.add((()=>this.displayFeatureLimit),(e=>this._updatingHandles.addPromise(this._updateSnapshotLimit(e,null,this._lifeCycleAbortController.signal)))),this._updatingHandles.add((()=>this.mode),(()=>this._modeChanged()),l.Vh),this._updatingHandles.add((()=>this.mode),((e,t)=>{"tiles"===e&&"snapshot"===t&&(this._forceTilesMode=!0)}),l.Vh),this.addResolvingPromise(Promise.resolve().then((()=>this._verifyCapabilities())).then((()=>this._updatingHandles.addPromise(this._fetchServiceDataInfo()))).then((()=>this._initializeTileFetcher())))}_verifyCapabilities(){var e;const t=this.layerView.layer;if("ogc-feature"!==t.type&&(null===(e=(0,tb.BR)(t))||void 0===e||!e.operations.supportsQuery))throw new oe.A("graphicscontroller:query-capability-required","Service requires query capabilities to be used as a feature layer",{layer:t})}destroy(){this._cancelFetchServiceDataInfo(),this._tileFetcher=(0,le.pR)(this._tileFetcher),this._tilesHandle=(0,le.xt)(this._tilesHandle),this._lifeCycleAbortController=(0,le.DC)(this._lifeCycleAbortController),this._updatingHandles.destroy(),this._set("_updatingHandles",null)}suspend(){this._suspended||(this._suspended=!0,null!=this._tileFetcher&&this._tileFetcher.suspend())}resume(){this._suspended&&(this._suspended=!1,null!=this._tileFetcher&&this._tileFetcher.resume())}restart(){const e=()=>{null!=this._tileFetcher&&this._tileFetcher.restart()};this._updatingHandles.addPromise(this._fetchServiceDataInfo().then(e,e))}refetch(){this._refetch({resetForceTilesMode:!1})}getMissingAttributesForFeature(e){var t;return null===(t=this._tileFetcher)||void 0===t?void 0:t.getMissingAttributesForFeature(e)}_refetch(e){const t=()=>{null!=this._tileFetcher&&(e.resetForceTilesMode&&(this._forceTilesMode=!1),this._tileFetcher.refetch())};this._updatingHandles.addPromise(this._fetchServiceDataInfo().then(t,t))}_initializeTileFetcher(){const e=this.layerView.view;if(!e)return;const t=(0,l.C_)((()=>{var t;return null===(t=e.featureTiles)||void 0===t?void 0:t.tilingScheme}),this._lifeCycleAbortController.signal);this._updatingHandles.addPromise(t),t.then((()=>{const{layerView:e,tileDescriptors:t}=this,i=e.layer,r=new xb({context:this.context,filterExtent:this.extent,tileDescriptors:t,features:this.graphics});this._tileFetcher=r,this._suspended?r.suspend():r.resume();const n=this.layerView.view;n&&this.addHandles((0,l.wB)((()=>n.quality),(e=>r.memoryFactor=e),l.pc));const s="polygon"===this.context.geometryType?"polygonLodFactor":"polyline"===this.context.geometryType?"polylineLodFactor":null;s&&this.addHandles((0,l.wB)((()=>{var e;return null===(e=this.layerView.view)||void 0===e||null===(e=e.qualitySettings)||void 0===e||null===(e=e.graphics3D)||void 0===e?void 0:e[s]}),(e=>r.lodFactor=e||1),l.Vh));"ogc-feature"!==i.type&&this._updatingHandles.add((()=>i.createQueryVersion),(()=>this._dataFilterChanged())),this._updatingHandles.add((()=>e.availableFields),((e,t)=>this._availableFieldsChanged(t,e))),this._updatingHandles.add((()=>e.requiredFields),((e,t)=>this._requiredFieldsChanged(t,e))),"customParameters"in i&&this._updatingHandles.add((()=>i.customParameters),(()=>this.restart())),this.addHandles([i.on("apply-edits",(e=>this._applyEdits(e))),(0,l.wB)((()=>this.extent),(e=>r.filterExtent=e),l.OH),(0,l.wB)((()=>this.tileDescriptors),(e=>r.tileDescriptors=e),l.OH),(0,l.wB)((()=>this.maximumNumberOfFeatures),(e=>{r.maximumNumberOfFeatures=e,r.useTileCount=this.serviceDataCount>e}),l.pc),(0,l.wB)((()=>this.serviceDataCount),(e=>{r.useTileCount=e>this.maximumNumberOfFeatures}),l.pc),(0,l.wB)((()=>Fn.b.FEATURE_TILE_FETCH_SHOW_TILES),(e=>{e&&r&&!r.debugger?(r.debugger=new Bb(r,n.featureTiles.tilingScheme.toTileInfo(),n),r.debugger.update()):!e&&this._tileFetcher&&r.debugger&&(r.debugger.destroy(),r.debugger=null)}),l.pc)]),this._supportsExceedsLimitQuery||this._updatingHandles.add((()=>this.maxTotalSnapshotVertices),(()=>this._updatingHandles.addPromise(this._updateSnapshotLimit(this.displayFeatureLimit,null,this._lifeCycleAbortController.signal))))})).catch((()=>{}))}_modeChanged(){switch(this.mode){case"tiles":this._tilesHandle||(this._tilesHandle=this.layerView.view.featureTiles.addClient());break;default:a.A.getLogger(this).warn("Unhandled feature layer mode "+this.mode);case"snapshot":null!=this._tilesHandle&&(this._tilesHandle.remove(),this._tilesHandle=null)}}_dataFilterChanged(){this._set("maxTotalSnapshotVertices",0),this.notifyChange("maxTotalSnapshotVertices"),this._refetch({resetForceTilesMode:!0})}_applyEdits(e){null!=this._tileFetcher&&this._tileFetcher.applyEdits(e).then((e=>{if(e){if(!this._lifeCycleAbortController)throw(0,o.NK)();e.exceededTransferLimit?this.layerView.layer.refresh():(e.deletedFeatures.length||e.updatedFeatures.length||e.addedFeatures.length)&&this._updatingHandles.addPromise(this._updateServiceDataExtent(this._lifeCycleAbortController.signal))}})).catch((e=>{if(!(0,o.zf)(e))throw e}))}_availableFieldsChanged(e,t){null!=this._tileFetcher&&kb(this._tileFetcher.availableFields,t)&&this._refetch({resetForceTilesMode:!1})}_requiredFieldsChanged(e,t){null!=this._tileFetcher&&kb(this._tileFetcher.availableFields,t)&&this.restart()}_createVertexLimitExceededQuery(e){var t;const i=this.layerView.layer,r=i.createQuery();return r.returnGeometry=!1,r.outStatistics=[new nb.A({statisticType:"exceedslimit",maxVertexCount:e,outStatisticFieldName:"exceedslimit",maxPointCount:1e8,maxRecordCount:1e8})],null!==(t=i.capabilities)&&void 0!==t&&t.query.supportsCacheHint&&(r.cacheHint=!0),r}_createDataInfoQuery(){var e;const t=this.layerView.layer,i=t.createQuery();return i.returnGeometry=!1,i.outSpatialReference=this.layerView.view.spatialReference,null!==(e=t.capabilities)&&void 0!==e&&e.query.supportsCacheHint&&(i.cacheHint=!0),i}_fullExtentIsAccurate(){const e=this.layerView.layer;if("definitionExpression"in e&&e.definitionExpression)return!1;switch(e.type){case"feature":case"oriented-imagery":return(0,ib.Wo)(e.url);case"csv":case"geojson":case"ogc-feature":case"wfs":return!0;default:return}}async _updateServiceDataExtent(e){try{await this._tryUpdateServiceDataExtent(e)}catch(t){(0,o.zf)(t)||this._set("serviceDataExtent",(0,lt.o8)(this.layerView.fullExtentInLocalViewSpatialReference))}}async _tryUpdateServiceDataExtent(e){var t,i;const r=this.layerView,n=r.layer,s=null!==(t=null===(i=n.capabilities)||void 0===i?void 0:i.query.supportsExtent)&&void 0!==t&&t,a=(0,lt.o8)(r.fullExtentInLocalViewSpatialReference),o=n.fullExtent,l=this._fullExtentIsAccurate(),c=this.serviceDataCount;if(s&&c<=Zb.maxFeatureCountForExtent&&(!a||!l)&&"queryExtent"in n){const t=this._createDataInfoQuery(),i=await n.queryExtent(t,{timeout:Zb.queryExtentTimeout,signal:e});this._set("serviceDataExtent",i.extent)}else if(a)this._set("serviceDataExtent",a);else if(null!=o){const t="portalItem"in n?n.portalItem:null,i=await(0,rb.projectGeometry)(o,r.view.spatialReference,t,e);this._set("serviceDataExtent",i)}else this._set("serviceDataExtent",null)}async _updateServiceDataCount(e){const t=this.layerView.layer;if(!("queryFeatureCount"in t)||!(0,h.A)("featurelayer-snapshot-enabled"))return void this._set("serviceDataCount",Zb.noServiceDataCount);const i=await(0,ot.Ke)(t.queryFeatureCount(this._createDataInfoQuery(),{timeout:Zb.queryStatisticsTimeout,signal:e}));if(!0===i.ok)this._set("serviceDataCount",i.value);else{if((0,o.zf)(i.error))throw i.error;this._set("serviceDataCount",Zb.noServiceDataCount)}}get _supportsExceedsLimitQuery(){const e=this.layerView.layer;return null!=e.capabilities&&e.capabilities.operations&&e.capabilities.operations.supportsExceedsLimitStatistics}get _minimumNumberOfVerticesForGeometry(){switch(this.layerView.layer.geometryType){case"point":case"multipoint":return 1;case"polygon":return 4;case"polyline":return 2;case"multipatch":case"mesh":return 3;default:return 0}}async _updateSnapshotLimit(e,t,i){if(null==(null===e||void 0===e?void 0:e.averageSymbolComplexity))return void(this._snapshotLimitExceeded=!1);const{maximumTotalNumberOfVertices:r,averageSymbolComplexity:n}=e,{verticesPerFeature:s,verticesPerCoordinate:a}=n,l=s<=0,c=this._minimumNumberOfVerticesForGeometry>1;if(!l&&!c)return void(this._snapshotLimitExceeded=!1);0!==s&&null!=t&&await t;const d=Math.min(r,jb),u=this.serviceDataCount,p=u!==Zb.noServiceDataCount;let f=p?Math.ceil((d-u*s)/(a||1)):Math.ceil(d/(a||1));if(c&&(f=Math.min(f,Wb)),p&&this._minimumNumberOfVerticesForGeometry*u>f)return void(this._snapshotLimitExceeded=!0);if(!this._supportsExceedsLimitQuery||!(0,h.A)("featurelayer-snapshot-enabled"))return void(this._snapshotLimitExceeded=this.maxTotalSnapshotVertices>f);const g=await(0,ot.Ke)(this.layerView.layer.queryFeatures(this._createVertexLimitExceededQuery(f),{timeout:Zb.queryStatisticsTimeout,signal:i}));if(!1===g.ok){if((0,o.zf)(g.error))throw g.error;return void(this._snapshotLimitExceeded=!1)}const m=g.value.features[0];this._snapshotLimitExceeded=!(null===m||void 0===m||!m.attributes)&&!!m.attributes.exceedslimit}async _fetchServiceDataInfo(){this._cancelFetchServiceDataInfo();let e=new AbortController;const t=e.signal,i=this._updateServiceDataCount(t),r=Promise.allSettled([i,this._updateSnapshotLimit(this.displayFeatureLimit,i,t)]),n=r.then((()=>this._updateServiceDataExtent(t))).catch((e=>{(0,o.zf)(e)||a.A.getLogger(this).error("#fetchServiceDataInfo()",e)})).then((()=>{n===this._fetchDataInfoPromise&&(this._fetchDataInfoPromise=null,this._fetchDataInfoAbortController=null),e=null}));return e&&(this._fetchDataInfoPromise=n),this._fetchDataInfoAbortController=e,r.then((()=>{}),(()=>{}))}_cancelFetchServiceDataInfo(){const e=this._fetchDataInfoAbortController;e&&(this._fetchDataInfoAbortController=null,this._fetchDataInfoPromise=null,e.abort())}get performanceInfo(){var e,t,i,r,n,s,a,o;return{storedFeatures:null!==(e=null===(t=this._tileFetcher)||void 0===t?void 0:t.storedFeatures)&&void 0!==e?e:0,totalFeatures:null!==(i=null===(r=this._tileFetcher)||void 0===r?void 0:r.totalFeatures)&&void 0!==i?i:0,totalVertices:null!==(n=null===(s=this._tileFetcher)||void 0===s?void 0:s.totalVertices)&&void 0!==n?n:0,missingTiles:null!==(a=null===(o=this._tileFetcher)||void 0===o?void 0:o.missingTiles)&&void 0!==a?a:0}}};(0,r._)([(0,d.MZ)({readOnly:!0})],Hb.prototype,"type",void 0),(0,r._)([(0,d.MZ)({constructOnly:!0})],Hb.prototype,"graphics",void 0),(0,r._)([(0,d.MZ)({constructOnly:!0})],Hb.prototype,"layerView",void 0),(0,r._)([(0,d.MZ)({constructOnly:!0})],Hb.prototype,"context",void 0),(0,r._)([(0,d.MZ)({readOnly:!0})],Hb.prototype,"dataUpdating",null),(0,r._)([(0,d.MZ)()],Hb.prototype,"extent",null),(0,r._)([(0,d.MZ)()],Hb.prototype,"updating",null),(0,r._)([(0,d.MZ)({readOnly:!0})],Hb.prototype,"_updatingHandles",void 0),(0,r._)([(0,d.MZ)()],Hb.prototype,"updatingTotal",null),(0,r._)([(0,d.MZ)()],Hb.prototype,"updatingRemaining",null),(0,r._)([(0,d.MZ)()],Hb.prototype,"expectedFeatureDiff",null),(0,r._)([(0,d.MZ)()],Hb.prototype,"memoryForUnusedFeatures",null),(0,r._)([(0,d.MZ)()],Hb.prototype,"maximumNumberOfFeaturesExceeded",null),(0,r._)([(0,d.MZ)({readOnly:!0})],Hb.prototype,"serviceDataExtent",void 0),(0,r._)([(0,d.MZ)({readOnly:!0})],Hb.prototype,"serviceDataCount",void 0),(0,r._)([(0,d.MZ)()],Hb.prototype,"_snapshotLimitExceeded",void 0),(0,r._)([(0,d.MZ)()],Hb.prototype,"displayFeatureLimit",void 0),(0,r._)([(0,d.MZ)({type:Number})],Hb.prototype,"maximumNumberOfFeatures",null),(0,r._)([(0,d.MZ)({readOnly:!0})],Hb.prototype,"hasAllFeatures",null),(0,r._)([(0,d.MZ)({readOnly:!0})],Hb.prototype,"hasAllFeaturesInView",null),(0,r._)([(0,d.MZ)({readOnly:!0})],Hb.prototype,"hasFullGeometries",null),(0,r._)([(0,d.MZ)()],Hb.prototype,"_forceTilesMode",void 0),(0,r._)([(0,d.MZ)({readOnly:!0})],Hb.prototype,"mode",null),(0,r._)([(0,d.MZ)({readOnly:!0})],Hb.prototype,"maxTotalSnapshotVertices",null),(0,r._)([(0,d.MZ)({readOnly:!0})],Hb.prototype,"tileDescriptors",null),(0,r._)([(0,d.MZ)()],Hb.prototype,"_tileFetcher",void 0),(0,r._)([(0,d.MZ)()],Hb.prototype,"_fetchDataInfoPromise",void 0),Hb=(0,r._)([(0,u.$)("esri.layers.graphics.controllers.FeatureTileController3D")],Hb);const jb=1e6,Wb=5e6;function kb(e,t){if(!t)return!1;for(const i of t)if(!e.has(i))return!0;return!1}var Zb;!function(e){e.noServiceDataCount=1/0,e.maxSnapshotMinScaleFactor=5,e.reset=function(){e.maxFeatureCountForExtent=1e4,e.queryStatisticsTimeout=12e3,e.queryExtentTimeout=1e4}}(Zb||(Zb={})),Zb.reset();class qb extends Sy{constructor(e,t,i,r,n,s){super(e.usedMemory,e.displayedFeatures,e.totalFeatures,e.maximumFeatures,e.nodes,e.core),this.storedFeatures=t,this.totalVertices=i,this.partial=r,this.mode=n,this.symbolComplexity=s}}var Qb=i(12482);var Jb=i(45667),Yb=i(50008);let Xb=class extends s.A{constructor(e){super(e),this._dirtyExtents=new Jy,this._globalDirty=!1,this._averageExtentUpdateSize=0,this._dirtyGraphicsSet=new Set,this._updateElevation=!1,this.graphicsCoreOwner=null,this.graphicsCore=null,this.events=new Cn.A}initialize(){var e;const t=this.elevationProvider,i=this.graphicsCoreOwner.view.resourceController.scheduler;this._task=i.registerTask($b(null===(e=this.graphicsCore.layer.elevationInfo)||void 0===e?void 0:e.mode),this),this.addHandles([t.on("elevation-change",(e=>this._elevationChanged(e))),(0,l.wB)((()=>this.graphicsCoreOwner.suspended),(()=>this._suspendedChange())),this._task,(0,l.wB)((()=>{var e;return $b(null===(e=this.graphicsCore.layer.elevationInfo)||void 0===e?void 0:e.mode)}),(e=>this._task.priority=e))])}destroy(){this._dirtyGraphicsSet.clear(),this.graphicsCoreOwner=null,this.graphicsCore=null,this.queryGraphicUIDsInExtent=null,this.elevationProvider=null}clear(){this._dirtyGraphicsSet.clear(),this.notifyChange("updating")}_suspendedChange(){!0===this.graphicsCoreOwner.suspended?this._updateElevation=!1:!1===this.graphicsCoreOwner.suspended&&this._updateElevation&&(this._globalDirty=!0,this.notifyChange("updating"))}elevationInfoChange(){this._globalDirty=!0,this.notifyChange("updating")}get updating(){return this.running}get running(){return this._dirtyGraphicsSet.size>0||this._dirtyExtents&&!this._dirtyExtents.empty||this._globalDirty}get updatingRemaining(){return this._dirtyGraphicsSet.size+this._dirtyExtents.size*this._averageExtentUpdateSize}runTask(e){for(this._globalDirty&&(this._markAllGraphicsElevationDirty(),this._globalDirty=!1,e.madeProgress()),e.run((()=>this._dirtyExtents.merge(e)));this.running&&!e.done;)this._updateDirtyGraphics(e),this._updateDirtyExtents(e);this.notifyChange("updating")}_updateDirtyGraphics(e){const t=this.graphicsCoreOwner.view.renderCoordsHelper,i=this.graphicsCore.effectiveUpdatePolicy===Ao.ASYNC;for(const r of this._dirtyGraphicsSet.keys()){const n=this.graphicsCore.getGraphics3DGraphicById(r);if(this._dirtyGraphicsSet.delete(r),null!=n&&(n.alignWithElevation(this.elevationProvider,t,i),this.graphicsCoreOwner.view.deconflictor.setDirty(),e.madeProgress()),e.done)return}}_updateDirtyExtents(e){for(;!this._dirtyExtents.empty&&!e.done;){const t=this._dirtyExtents.pop(),i=this.elevationProvider.spatialReference;this.events.emit("invalidate-elevation",{extent:t,spatialReference:i});const r=this._dirtyGraphicsSet.size;this.queryGraphicUIDsInExtent(t,i,(e=>{const t=this.graphicsCore.getGraphics3DGraphicById(e);null!=t&&t.needsElevationUpdates()&&this._dirtyGraphicsSet.add(e)})),this._averageExtentUpdateSize=.1*(this._dirtyGraphicsSet.size-r)+.9*this._averageExtentUpdateSize,e.madeProgress()}}_markAllGraphicsElevationDirty(){this._dirtyExtents.clear(),this._dirtyGraphicsSet.clear(),this.graphicsCore.graphics3DGraphics.forEach(((e,t)=>this._dirtyGraphicsSet.add(t)))}_elevationChanged(e){if("scene"===e.context&&(!this.graphicsCore.layer.elevationInfo||"relative-to-scene"!==this.graphicsCore.layer.elevationInfo.mode))return;const t=e.extent;if(this.graphicsCoreOwner.suspended){if(!this._updateElevation){const e=this.graphicsCore.computedExtent;e&&t[2]>e.xmin&&t[0]<e.xmax&&t[3]>e.ymin&&t[1]<e.ymax&&(this._updateElevation=!0)}this.events.emit("invalidate-elevation",e)}else t[0]===-1/0?this._globalDirty=!0:this._dirtyExtents.add(t),this.notifyChange("updating")}};function $b(e){return null==e?Ae.W6.ELEVATION_ALIGNMENT:"relative-to-scene"===e?Ae.W6.ELEVATION_ALIGNMENT_SCENE:Ae.W6.ELEVATION_ALIGNMENT}function Kb(e,t,i,r){return rx(e,t,i,tx(r,t,i,!0))}(0,r._)([(0,d.MZ)()],Xb.prototype,"graphicsCoreOwner",void 0),(0,r._)([(0,d.MZ)()],Xb.prototype,"graphicsCore",void 0),(0,r._)([(0,d.MZ)()],Xb.prototype,"queryGraphicUIDsInExtent",void 0),(0,r._)([(0,d.MZ)()],Xb.prototype,"elevationProvider",void 0),(0,r._)([(0,d.MZ)({readOnly:!0})],Xb.prototype,"updating",null),(0,r._)([(0,d.MZ)({readOnly:!0})],Xb.prototype,"updatingRemaining",null),Xb=(0,r._)([(0,u.$)("esri.views.3d.layers.graphics.Graphics3DElevationAlignment")],Xb);const ex={dir:(0,I.vt)(),len:0,clip:(0,pr.vt)()};function tx(e,t,i,r){const n=ex;return e?(i&&r&&(n.len=(0,M.p)(t,i)),(0,M.c)(n.dir,e)):r?(n.len=(0,M.p)(t,i),(0,M.f)(n.dir,i,t),(0,M.h)(n.dir,n.dir,1/n.len)):((0,M.f)(n.dir,i,t),(0,M.n)(n.dir,n.dir)),n}function ix(e,t,i){const r=(0,M.j)((0,gr.Qj)(e),i.dir),n=-(0,gr.mN)(e,t);if(n<0&&r>=0)return!1;if(r>-1e-6&&r<1e-6)return n>0;if((n<0||r<0)&&!(n<0&&r<0))return!0;const s=n/r;return r>0?s<i.clip[1]&&(i.clip[1]=s):s>i.clip[0]&&(i.clip[0]=s),i.clip[0]<=i.clip[1]}function rx(e,t,i,r){r.clip[0]=0,r.clip[1]=i?r.len:Number.MAX_VALUE;for(let n=0;n<e.length;n++)if(!ix(e[n],t,r))return!1;return!0}const nx=.5*Math.PI,sx=nx/Math.PI*180;class ax{constructor(e){this._renderCoordsHelper=e.renderCoordsHelper,this._extent=new Array(4),this._planes=new Array(6),this._maxSpan=0,this._center={origin:(0,I.vt)(),direction:(0,I.vt)()};for(let t=0;t<4;t++)this._extent[t]={origin:(0,I.vt)(),direction:(0,I.vt)(),cap:{next:null,direction:(0,I.vt)()}},this._planes[t]=(0,gr.vt)();this._planes[wt.FB.NEAR]=(0,gr.vt)(),this._planes[wt.FB.FAR]=(0,gr.vt)(),this._planesWithoutFar=this._planes.slice(0,5)}update(e,t,i){let r=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];const n=this._extent;this._toRenderBoundingExtent(e,t,i),(0,M.g)(this._center.origin,n[0].origin,n[2].origin),(0,M.h)(this._center.origin,this._center.origin,.5),this._renderCoordsHelper.worldUpAtPosition(this._center.origin,this._center.direction),r||(0,M.h)(this._center.direction,this._center.direction,-1);for(let s=0;s<4;s++){const e=n[s];this._renderCoordsHelper.worldUpAtPosition(e.origin,e.direction);const t=n[3===s?0:s+1];e.cap.next=t.origin,(0,M.D)(e.cap.direction,e.origin,t.origin),(0,gr.mR)(e.direction,e.cap.direction,e.origin,this._planes[s]),r||(0,M.h)(e.direction,e.direction,-1)}(0,gr.mR)(n[0].cap.direction,n[1].cap.direction,n[0].origin,this._planes[wt.FB.NEAR]),r?(0,gr.ze)(this._planes[wt.FB.NEAR],this._planes[wt.FB.FAR]):((0,gr.C)(this._planes[wt.FB.FAR],this._planes[wt.FB.NEAR]),(0,gr.ze)(this._planes[wt.FB.NEAR],this._planes[wt.FB.NEAR])),this._maxSpan=Math.max(Math.abs(e[0]-e[2]),Math.abs(e[1]-e[3])),this._maxSpanSpatialReference=t,this._minGlobalAltitude=.9*(0,xt.tO)(this._maxSpanSpatialReference).radius}isVisibleInFrustum(e,t){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(null==e)return!1;if(this._renderCoordsHelper.viewingMode===ae.RT.Global){const i=this._maxSpanSpatialReference.isGeographic?sx:nx*t;if(this._maxSpan>i)return!0;if(null!=e.altitude&&e.altitude>=this._minGlobalAltitude)return this._isVisibleInFrustumGlobal(e)}if(0===this._maxSpan){const t=this._extent[0];return!(i||!e.intersectsRay((0,mr.LV)(t.origin,t.direction)))}for(let n=0;n<this._extent.length;n++){const t=this._extent[n];if(!i&&e.intersectsRay((0,mr.LV)(t.origin,t.direction)))return!0;if(e.intersectsLineSegment((0,Oo.Cr)(t.origin,t.cap.next,px),t.cap.direction))return!0}const r=i?this._planes:this._planesWithoutFar;for(let n=0;n<e.lines.length;n++){const t=e.lines[n];if(Kb(r,t.origin,t.endpoint,t.direction))return!0}return!1}_toRenderBoundingExtentGlobal(e,t,i){(0,Q.gX)(e,lx),lx[2]=i,(0,Ct.l)(t,lx,cx,this._renderCoordsHelper.spatialReference),(0,T.B8)(dx,cx),(0,q.Ie)(hx);for(const{x0:r,x1:n,y0:s,y1:a}of ox)for(let o=0;o<5;o++){const l=o/4;lx[0]=(0,U.Cc)(e[r],e[n],l),lx[1]=(0,U.Cc)(e[s],e[a],l),lx[2]=i,(0,Z.F)(lx,t,lx,this._renderCoordsHelper.spatialReference),(0,M.e)(lx,lx,dx),(0,q.iT)(hx,lx)}(0,M.s)(this._extent[0].origin,hx[0],hx[1],hx[2]),(0,M.s)(this._extent[1].origin,hx[3],hx[1],hx[2]),(0,M.s)(this._extent[2].origin,hx[3],hx[4],hx[2]),(0,M.s)(this._extent[3].origin,hx[0],hx[4],hx[2]);for(let r=0;r<4;++r)(0,M.e)(this._extent[r].origin,this._extent[r].origin,cx)}_toRenderBoundingExtentLocal(e,t,i){ee(e,t,ux,this._renderCoordsHelper.spatialReference),(0,M.s)(this._extent[0].origin,ux[0],ux[1],i),(0,M.s)(this._extent[1].origin,ux[2],ux[1],i),(0,M.s)(this._extent[2].origin,ux[2],ux[3],i),(0,M.s)(this._extent[3].origin,ux[0],ux[3],i)}_toRenderBoundingExtent(e,t,i){switch(this._renderCoordsHelper.viewingMode){case ae.RT.Global:this._toRenderBoundingExtentGlobal(e,t,i);break;case ae.RT.Local:this._toRenderBoundingExtentLocal(e,t,i);break;default:(0,or.Xb)(this._renderCoordsHelper.viewingMode)}}_isVisibleInFrustumGlobal(e){if((0,gr.mN)(e.planes[wt.FB.NEAR],this._center.origin)<0&&(0,M.j)(this._center.direction,e.direction)<0)return!0;for(let t=0;t<4;t++){const i=this._extent[t];if((0,gr.mN)(e.planes[wt.FB.NEAR],i.origin)<0&&(0,M.j)(i.direction,e.direction)<0)return!0}return!1}}const ox=[{x0:0,y0:1,x1:2,y1:1},{x0:0,y0:3,x1:2,y1:3},{x0:0,y0:1,x1:0,y1:3},{x0:2,y0:1,x1:2,y1:3}],lx=(0,I.vt)(),cx=(0,P.vt)(),dx=(0,P.vt)(),hx=(0,q.vt)(),ux=(0,Q.vt)(),px=(0,Oo.vt)();let fx=class extends s.A{constructor(e){super(e),this.suspended=!1,this._extent=null,this._extentIntersectionDirty=!0,this._isVisibleBelowSurfaceInternal=!1,this.graphicsCoreOwner=null,this.updating=!0}initialize(){const{graphicsCoreOwner:e}=this;this._extentIntersection=new ax({renderCoordsHelper:e.view.renderCoordsHelper});const t=e.view,i=t.basemapTerrain,r=t.resourceController.scheduler;this.addHandles([t.on("resize",(()=>this._viewChange())),(0,l.wB)((()=>t.state.camera),(()=>this._viewChange()),l.OH),r.registerTask(Ae.W6.FRUSTUM_VISIBILITY,this),(0,l.wB)((()=>i.visibleElevationBounds),(()=>this._elevationBoundsChange()))]),"local"===t.viewingMode?this._isVisibleBelowSurface=!0:this.addHandles([(0,l.wB)((()=>{var e;return[i.baseOpacity,i.wireframe,null===(e=t.map)||void 0===e||null===(e=e.ground)||void 0===e||null===(e=e.navigationConstraint)||void 0===e?void 0:e.type]}),(()=>this._updateIsVisibleBelowSurface()),l.Vh)])}destroy(){this._set("graphicsCoreOwner",null),this._extent=null,this._extentIntersection=null}_setDirty(){this.updating||this._set("updating",!0)}setExtent(e){this._extent=e,this._extentIntersectionDirty=!0,this._setDirty()}_viewChange(){this._setDirty()}_elevationBoundsChange(){this._setDirty(),this._extentIntersectionDirty=!0}set _isVisibleBelowSurface(e){this._isVisibleBelowSurfaceInternal=e,this._setDirty(),this._extentIntersectionDirty=!0}_updateIsVisibleBelowSurface(){var e;const t=this.graphicsCoreOwner.view,i=t.basemapTerrain,r="local"===t.viewingMode,n="none"===(null===(e=t.map.ground)||void 0===e||null===(e=e.navigationConstraint)||void 0===e?void 0:e.type);this._isVisibleBelowSurface=r||!i.opaque||n}_updateExtentIntersection(){if(!this._extentIntersectionDirty)return;this._extentIntersectionDirty=!1;const e=this.graphicsCoreOwner.view;let t;if(this._isVisibleBelowSurfaceInternal)t=-.3*(0,xt.tO)(e.spatialReference).radius;else{const{min:i,max:r}=e.basemapTerrain.visibleElevationBounds;t=i-Math.max(1,(r-i)*(1.2-1))}this._extentIntersection.update(this._extent,e.spatialReference,t)}get running(){return this.updating}runTask(e){if(this._set("updating",!1),!this._extent)return this._set("suspended",!1),k_.G;this._updateExtentIntersection();const t=this.graphicsCoreOwner.view.frustum,i=(0,xt.tO)(this.graphicsCoreOwner.view.spatialReference).radius;this._set("suspended",!this._extentIntersection.isVisibleInFrustum(t,i)),e.madeProgress()}};var gx;(0,r._)([(0,d.MZ)({readOnly:!0})],fx.prototype,"suspended",void 0),(0,r._)([(0,d.MZ)({constructOnly:!0})],fx.prototype,"graphicsCoreOwner",void 0),(0,r._)([(0,d.MZ)({readOnly:!0})],fx.prototype,"updating",void 0),fx=(0,r._)([(0,u.$)("esri.views.3d.layers.graphics.Graphics3DFrustumVisibility")],fx),function(e){e[e.Object=0]="Object",e[e.RenderGeometry=1]="RenderGeometry",e[e.External=2]="External",e[e.COUNT=3]="COUNT"}(gx||(gx={}));class mx{constructor(){this._items=[]}addObject(e,t){this._items.push({type:gx.Object,objectStateId:t,object:e})}addRenderGeometry(e,t,i){this._items.push({type:gx.RenderGeometry,objectStateId:t,renderGeometry:e,owner:i})}addExternal(e,t){this._items.push({type:gx.External,objectStateId:t,remove:e})}remove(e){for(let t=this._items.length-1;t>=0;--t){const i=this._items[t];i.objectStateId===e&&(this._removeObjectStateItem(i),this._items.splice(t,1))}}removeObject(e){for(let t=this._items.length-1;t>=0;--t){const i=this._items[t];i.type===gx.Object&&i.object===e&&(this._removeObjectStateItem(i),this._items.splice(t,1))}}removeRenderGeometry(e){for(let t=this._items.length-1;t>=0;--t){const i=this._items[t];i.type===gx.RenderGeometry&&i.renderGeometry===e&&(this._removeObjectStateItem(i),this._items.splice(t,1))}}removeAll(){this._items.forEach((e=>{this._removeObjectStateItem(e)})),this._items=[]}_removeObjectStateItem(e){switch(e.type){case gx.Object:e.objectStateId.channel===fe.Mg.Highlight?e.object.removeHighlight(e.objectStateId):e.objectStateId.channel===fe.Mg.MaskOccludee&&e.object.removeOcclude(e.objectStateId);break;case gx.RenderGeometry:e.owner.removeRenderGeometryObjectState(e.renderGeometry,e.objectStateId);break;case gx.External:e.remove(e.objectStateId)}}}class _x{constructor(e,t){this.stateType=e,this.objectIdField=t,this.objectStateSet=new mx,this.ids=new Set,this.paused=!1}hasGraphic(e){if(this.objectIdField){const t=e.graphic.attributes[this.objectIdField];return this.ids.has(t)}return this.ids.has(e.graphic.uid)}}class vx{constructor(e){this._graphicsCore=e,this._stateSets=new Array}destroy(){this.reset(),this._stateSets=null}reset(){this._stateSets&&(this._stateSets.forEach((e=>e.objectStateSet.removeAll())),this._stateSets.length=0)}acquireSet(e,t){const i=new _x(e,t);this._stateSets.push(i);const r=(0,w.hA)((()=>this.releaseSet(i)));return{set:i,handle:r}}releaseSet(e){e.objectStateSet.removeAll();const t=this._stateSets?this._stateSets.indexOf(e):-1;-1!==t&&this._stateSets.splice(t,1)}_addObjectStateSet(e,t){e.addObjectStateSet(t.stateType,t.objectStateSet)}_removeObjectStateSet(e,t){e.removeObjectState(t.objectStateSet)}setUid(e,t){e.ids.add(t);const i=this._graphicsCore.graphics3DGraphics.get(t);i&&this._addObjectStateSet(i,e)}setUids(e,t){t.forEach((t=>this.setUid(e,t)))}setObjectIds(e,t){t.forEach((t=>e.ids.add(t))),this._initializeSet(e)}addGraphic(e){this._stateSets.forEach((t=>{!t.paused&&t.hasGraphic(e)&&this._addObjectStateSet(e,t)}))}removeGraphic(e){this._stateSets.forEach((t=>{t.hasGraphic(e)&&this._removeObjectStateSet(e,t)}))}allGraphicsDeleted(){this._stateSets&&this._stateSets.forEach((e=>e.objectStateSet.removeAll()))}_initializeSet(e){const t=this._graphicsCore.graphics3DGraphics;e.objectIdField?t.forEach((t=>{t&&e.hasGraphic(t)&&this._addObjectStateSet(t,e)})):e.ids.forEach((i=>{const r=t.get(i);r&&this._addObjectStateSet(r,e)}))}get test(){return{states:this._stateSets}}}function yx(e,t,i){if(!i||null==t)return null;if(!e)return function(e,t){const i=t.toLowerCase();for(const r in e)if(r.toLowerCase()===i)return e[r];return null}(t,i);const r=e.get(i);return r?t[r.name]:null}var bx=i(8203),xx=i(46530),Sx=i(26151),wx=i(1900),Cx=i(77725);const Ax=Sx.d;let Rx=class extends s.A{get layer(){return this.context.layer}get spatialReference(){return this.context.spatialReference}get _queryGeometryType(){switch(this.layer.geometryType){case"multipoint":case"point":case"polygon":case"polyline":return this.layer.geometryType;case"mesh":return"polygon";default:return}}get defaultQueryJSON(){return new ob.A({outSpatialReference:this.spatialReference}).toJSON()}get _dataQueryEngine(){return this._ensureDataQueryEngine()}constructor(e){super(e),this._dataQueryEngineInstance=null}destroy(){this.clear()}clear(){return!!this._dataQueryEngineInstance&&(this._dataQueryEngineInstance.destroy(),this._dataQueryEngineInstance=null,!0)}async executeQueryForIdSet(e,t,i){return this._dataQueryEngine.executeQueryForIdSet(this._ensureQueryJSON(e,t),i)}async executeQueryForCount(e,t){return this._dataQueryEngine.executeQueryForCount(this._ensureQueryJSON(e),t)}async executeQueryForExtent(e,t){const{count:i,extent:r}=await this._dataQueryEngine.executeQueryForExtent(this._ensureQueryJSON(e),t);return{count:i,extent:xp.A.fromJSON(r)}}async executeQueryForIds(e,t){return this._dataQueryEngine.executeQueryForIds(this._ensureQueryJSON(e),t)}async executeQueryForLatestObservations(e,t){const i=await this._dataQueryEngine.executeQueryForLatestObservations(this._ensureQueryJSON(e),t),r=Cx.A.fromJSON(i);return r.features.forEach((e=>{e.layer=this.layer,e.sourceLayer=this.layer})),r}async executeQuery(e,t){const i=await this._dataQueryEngine.executeQuery(this._ensureQueryJSON(e),t),r=Cx.A.fromJSON(i);return r.features.forEach((e=>{e.layer=this.layer,e.sourceLayer=this.layer})),r}_ensureQueryJSON(e,t){let i=this.defaultQueryJSON;if(null!=e&&("outSpatialReference"in e&&!e.outSpatialReference&&(e.outSpatialReference=this.spatialReference),i=e.toJSON()),null!=t){const e=t.geometries.map((e=>e.toJSON())).reduce(((e,t)=>(e.rings=e.rings.concat(t.rings),e)));i={...i,sceneFilter:{...t,geometry:e}}}return i}_ensureDataQueryEngine(){var e,t;if(this._dataQueryEngineInstance)return this._dataQueryEngineInstance;const i="timeInfo"in this.layer&&(null===(e=this.layer.timeInfo)||void 0===e?void 0:e.toJSON())||null,r=this.layer.objectIdField,n=lb.g.toJSON(this._queryGeometryType),s=(null===(t=this.layer.fieldsIndex)||void 0===t?void 0:t.toJSON())||new wx.A([]),a=this.priority,o=this.spatialReference.toJSON(),{hasZ:l,hasM:c,featureStore:d,scheduler:h}=this.context;return this._dataQueryEngineInstance=new Ax({hasZ:l,hasM:c,geometryType:n,fieldsIndex:s,timeInfo:i,spatialReference:o,objectIdField:r,featureStore:d,scheduler:h,priority:a}),this._dataQueryEngineInstance}};(0,r._)([(0,d.MZ)({constructOnly:!0})],Rx.prototype,"context",void 0),(0,r._)([(0,d.MZ)({constructOnly:!0})],Rx.prototype,"priority",void 0),(0,r._)([(0,d.MZ)()],Rx.prototype,"layer",null),(0,r._)([(0,d.MZ)()],Rx.prototype,"spatialReference",null),(0,r._)([(0,d.MZ)()],Rx.prototype,"_queryGeometryType",null),(0,r._)([(0,d.MZ)()],Rx.prototype,"defaultQueryJSON",null),Rx=(0,r._)([(0,u.$)("esri.views.3d.layers.graphics.QueryEngine")],Rx);let Ex=class extends s.A{constructor(e){super(e),this._updateTask=null,this._frameTask=null,this._queryEngine=null,this._updateRequested=!0,this._updatingHandles=new F.U,this._updateVisibility=async e=>{if(null==this._compositedFeatureFilter&&null==this._sceneFilter||0===this.context.getFeatureCount())return this._frameTask.schedule((()=>this.clear()),e);try{const t=await this._queryEngine.executeQueryForIdSet(this._compositedFeatureFilter,this._sceneFilter,e);return this._frameTask.schedule((()=>{this.context.updateFeatureVisibilities((e=>t.has(e)))}),e)}catch(t){return(0,o.QP)(t),a.A.getLogger(this).warn("FeatureFilter query failed: ".concat(t),{error:t}),this._frameTask.schedule((()=>{this.context.setAllFeaturesVisibility(!0)}),e)}}}initialize(){const e=Ae.W6.FILTER_VISIBILITY,{layer:t,view:i}=this._layerView,{featureStore:r}=this.context,n="hasZ"in this._layerView&&this._layerView.hasZ,s="hasM"in this._layerView&&this._layerView.hasM;this._queryEngine=new Rx({context:{spatialReference:i.spatialReference,layer:t,scheduler:i.resourceController.scheduler,featureStore:r,hasM:s,hasZ:n},priority:e}),this._frameTask=this._layerView.view.resourceController.scheduler.registerTask(e,this),this._updatingHandles.add((()=>[this._compositedFeatureFilter,this._sceneFilter]),(()=>this.reapply()),l.Vh)}destroy(){this._updateRequested=!1,this._updatingHandles.destroy(),this.clear(),this._updateTask=(0,le.DC)(this._updateTask),this._frameTask=(0,le.xt)(this._frameTask),this._queryEngine=(0,le.pR)(this._queryEngine),this._set("context",null)}get updating(){return this.running||this._updatingHandles.updating||null!=this._updateTask&&!this._updateTask.finished}get running(){return this._updateRequested||this._frameTask.updating}get defaultVisibility(){return null==this._compositedFeatureFilter&&null==this._sceneFilter}get _featureFilter(){return"filter"in this._layerView?this._layerView.filter:null}get _sceneFilter(){return"layerFilter"in this._layerView?this._layerView.layerFilter:null}get _floorFilter(){return(0,xx.E)(this._layerView)}get _timeExtent(){return"timeExtent"in this._layerView?this._layerView.timeExtent:null}get _compositedFeatureFilter(){const{_featureFilter:e,_timeExtent:t,_floorFilter:i}=this;if(null==t&&null==i)return e;const r=null!=e?e.clone():new bx.A;if(null!=t&&(r.timeExtent=null!=r.timeExtent?r.timeExtent.intersection(t):t),null!=i){const e=null==r.where||""===r.where;r.where=e?i:"(".concat(r.where,") AND (").concat(i,")")}return r}get _layerView(){return this.context.layerView}reapply(){this._updateRequested=!0}clear(){this._queryEngine.clear(),this.context.clearFeaturesVisibility()}runTask(e){if(this._updateRequested&&(this._updateTask=(0,le.DC)(this._updateTask),this._updateTask=(0,ot.UT)(this._updateVisibility),this._updateRequested=!1,e.madeProgress()),this._frameTask.processQueue(e),!e.hasProgressed)return k_.G}};(0,r._)([(0,d.MZ)({constructOnly:!0})],Ex.prototype,"context",void 0),(0,r._)([(0,d.MZ)()],Ex.prototype,"updating",null),(0,r._)([(0,d.MZ)()],Ex.prototype,"running",null),(0,r._)([(0,d.MZ)()],Ex.prototype,"defaultVisibility",null),(0,r._)([(0,d.MZ)()],Ex.prototype,"_featureFilter",null),(0,r._)([(0,d.MZ)()],Ex.prototype,"_sceneFilter",null),(0,r._)([(0,d.MZ)()],Ex.prototype,"_floorFilter",null),(0,r._)([(0,d.MZ)()],Ex.prototype,"_timeExtent",null),(0,r._)([(0,d.MZ)()],Ex.prototype,"_compositedFeatureFilter",null),(0,r._)([(0,d.MZ)()],Ex.prototype,"_layerView",null),(0,r._)([(0,d.MZ)()],Ex.prototype,"_updateTask",void 0),(0,r._)([(0,d.MZ)()],Ex.prototype,"_updateRequested",void 0),Ex=(0,r._)([(0,u.$)("esri.views.3d.layers.support.FeatureVisibilityFilter")],Ex);let Ox=class extends s.A{constructor(e){super(e),this.type="graphics-3d",this._randomRotationRenderers=null,this._updatingHandles=new F.U,this.elevationFeatureExpressionEnabled=!1,this.scaleVisibilityEnabled=!1,this.filterVisibilityEnabled=!1,this.frustumVisibilityEnabled=!1,this.elevationAlignmentEnabled=!1,this.timeExtentEnabled=!1,this.setUidToIdOnAdd=!0,this.dataExtent=null,this.drapeSourceType=La.Features,this.preferredUpdatePolicy=Ao.ASYNC,this._suspendResumeExtent=null}initialize(){const e=this.owner,t=(this.filterVisibilityEnabled||this.timeExtentEnabled)&&"multipatch"!==e.layer.geometryType,i=new $v({owner:this,layer:this.layer,preferredUpdatePolicy:this.preferredUpdatePolicy,elevationFeatureExpressionEnabled:this.elevationFeatureExpressionEnabled,graphicSymbolSupported:!1,hasZ:e.hasZ,hasM:e.hasM,setUidToIdOnAdd:this.setUidToIdOnAdd,componentFactories:{deconflictor:t=>e.view.deconflictor.addGraphicsOwner(t),labeler:(t,i)=>e.view.labeler.addGraphicsOwner(t,i),elevationAlignment:this.elevationAlignmentEnabled?(t,i)=>new Xb({graphicsCoreOwner:this,graphicsCore:t,queryGraphicUIDsInExtent:i,elevationProvider:e.view.elevationProvider}):null,scaleVisibility:this.scaleVisibilityEnabled?(t,i)=>new sy({graphicsCoreOwner:this,layer:this.layer,queryGraphicUIDsInExtent:i,graphicsCore:t,basemapTerrain:e.view.basemapTerrain}):null,filterVisibility:t?t=>new Ex({context:{layerView:e,...t}}):null,objectStates:e=>new vx(e)}});this._set("graphicsCore",i),this.frustumVisibilityEnabled&&this._set("frustumVisibility",new fx({graphicsCoreOwner:this})),this.elevationAlignment&&this._updatingHandles.add((()=>this.layer.elevationInfo),((e,t)=>{(0,Vi.Ui)(e,t)&&this._updatingHandles.addPromise(this.graphicsCore.elevationInfoChange())})),this._updatingHandles.add((()=>this.layer.labelsVisible),(()=>this.graphicsCore.updateVisibilityInfo())),this._updatingHandles.add((()=>this.layer.labelingInfo),((e,t)=>{(0,Vi.Ui)(e,t)&&this.graphicsCore.updateLabelingInfo()})),this._updatingHandles.add((()=>this.preferredUpdatePolicy),(e=>this.graphicsCore.preferredUpdatePolicy=e)),this._set("initializePromise",this._initializeAsync()),this._updatingHandles.addPromise(this.initializePromise)}async _initializeAsync(){await(0,o.Qg)(this.graphicsCore.initializePromise);const e=this.owner;this._updatingHandles.add((()=>this.renderer),(e=>this._updatingHandles.addPromise(this.graphicsCore.rendererChange(e)))),this._updatingHandles.add((()=>e.fullOpacity),(()=>this.graphicsCore.opacityChange())),this._setupSuspendResumeExtent(),this.updateClippingExtent&&(this._updatingHandles.add((()=>e.view.clippingArea),(()=>this._updateClippingExtent())),this._updateClippingExtent()),this.graphicsCore.startCreateGraphics(),this.graphicsCore.labelsEnabled&&await(0,o.Qg)(this.graphicsCore.updateLabelingInfo())}destroy(){this._updatingHandles.destroy(),this._set("frustumVisibility",(0,le.pR)(this.frustumVisibility)),this._set("graphicsCore",(0,le.pR)(this.graphicsCore)),this._set("owner",null)}get layer(){return this.owner.layer}get dataUpdating(){var e,t;return null!==(e=null===(t=this.graphicsCore)||void 0===t?void 0:t.dataUpdating)&&void 0!==e&&e}get renderer(){const{renderer:e,objectIdField:t}=this.layer;if(!e||!t||"heatmap"===e.type||!e.visualVariables)return e;const i=e.visualVariables.findIndex((e=>"rotation"===e.type&&null!=e.valueExpression&&(0,Yb.D)(e.valueExpression)===t&&(null==e.axis||"heading"===e.axis)&&"geographic"===e.rotationType));if(i<0)return e;const r=e.clone();return r.visualVariables.splice(i,1),this._randomRotationRenderers||(this._randomRotationRenderers=new WeakMap),this._randomRotationRenderers.set(r,t),r}get scaleVisibility(){var e;return null===(e=this.graphicsCore)||void 0===e?void 0:e.scaleVisibility}get filterVisibility(){var e;return null===(e=this.graphicsCore)||void 0===e?void 0:e.filterVisibility}get elevationAlignment(){var e;return null===(e=this.graphicsCore)||void 0===e?void 0:e.elevationAlignment}get objectStates(){var e;return null===(e=this.graphicsCore)||void 0===e?void 0:e.objectStates}get suspendResumeExtentMode(){return"suspendResumeExtentMode"in this.owner?this.owner.suspendResumeExtentMode:"computed"}get scaleVisibilitySuspended(){return null!=this.scaleVisibility&&this.scaleVisibility.suspended}get suspended(){return this.owner.suspended}get legendEnabled(){return null==this.frustumVisibility||!this.frustumVisibility.suspended}get suspendInfo(){const e={};return this.scaleVisibilitySuspended&&(e.outsideScaleRange=!0),null!=this.frustumVisibility&&this.frustumVisibility.suspended&&(e.outsideOfView=!0),e}get updating(){var e,t;return!!(null!==(e=this.graphicsCore)&&void 0!==e&&e.updating||null!==(t=this.frustumVisibility)&&void 0!==t&&t.updating||this._updatingHandles.updating)}get updatingRemaining(){var e,t;return null!==(e=null===(t=this.graphicsCore)||void 0===t?void 0:t.updatingRemaining)&&void 0!==e?e:0}get featureStore(){var e;return null===(e=this.graphicsCore)||void 0===e?void 0:e.featureStore}get view(){return this.owner.view}get loadedGraphics(){return this.owner.loadedGraphics}get fullOpacity(){var e;return null===(e=this.owner)||void 0===e?void 0:e.fullOpacity}get filter(){return"filter"in this.owner?this.owner.filter:null}get slicePlaneEnabled(){return this.owner.slicePlaneEnabled}get updatePolicy(){return this.owner.updatePolicy}get featureSpatialReference(){return"featureSpatialReference"in this.owner?this.owner.featureSpatialReference:this.owner.view.spatialReference}get graphics3DGraphics(){var e;return null===(e=this.graphicsCore)||void 0===e?void 0:e.graphics3DGraphics}get graphics3DGraphicsByObjectID(){var e;return null===(e=this.graphicsCore)||void 0===e?void 0:e.graphics3DGraphicsByObjectID}get symbolUpdateType(){var e;return null===(e=this.graphicsCore)||void 0===e?void 0:e.symbolUpdateType}get displayFeatureLimit(){var e;const t=this.view.quality,i=null===(e=this.graphicsCore)||void 0===e?void 0:e.displayFeatureLimit;if(1===t)return i;const r=Math.ceil(i.maximumNumberOfFeatures*t);return new bn(i.maximumTotalNumberOfVertices,r,i.averageSymbolComplexity)}get usedMemory(){var e,t;return null!==(e=null===(t=this.graphicsCore)||void 0===t?void 0:t.usedMemory)&&void 0!==e?e:0}get loadedFeatures(){var e,t;return null!==(e=null===(t=this.graphicsCore)||void 0===t?void 0:t.numberOfGraphics)&&void 0!==e?e:0}get usedMemoryPerFeature(){var e,t;return null!==(e=null===(t=this.graphicsCore)||void 0===t?void 0:t.usedMemoryPerGraphic)&&void 0!==e?e:0}get unprocessedMemoryEstimate(){var e,t;return null!==(e=null===(t=this.graphicsCore)||void 0===t?void 0:t.unprocessedMemoryEstimate)&&void 0!==e?e:0}get performanceInfo(){return this.graphicsCore.performanceInfo}maskOccludee(e){const{set:t,handle:i}=this.objectStates.acquireSet(fe.Mg.MaskOccludee,null);return this.objectStates.setUid(t,e.uid),i}highlight(e,t){if(e instanceof ob.A){const{set:i,handle:r}=this.objectStates.acquireSet(fe.Mg.Highlight,t);return this.owner.queryObjectIds(e).then((e=>this.objectStates.setObjectIds(i,e))),r}if("number"==typeof e||"string"==typeof e)return this.highlight([e],t);if(e instanceof y.A)return this.highlight([e],t);if("toArray"in e&&(e=e.toArray()),Array.isArray(e)&&e.length>0){if(e[0]instanceof y.A){const i=e;if(null==yx(this.layer.fieldsIndex,i[0].attributes,t)){const e=i.map((e=>e.uid)),{set:t,handle:r}=this.objectStates.acquireSet(fe.Mg.Highlight,null);return this.objectStates.setUids(t,e),r}e=i.map((e=>yx(this.layer.fieldsIndex,e.attributes,t)))}if(Array.isArray(e)&&("number"==typeof e[0]||"string"==typeof e[0])){const i=e,{set:r,handle:n}=this.objectStates.acquireSet(fe.Mg.Highlight,t);return this.objectStates.setObjectIds(r,i),n}}return(0,w.hA)()}resetObjectStates(){this.objectStates.reset()}whenGraphicBounds(e,t){var i;return null===(i=this.graphicsCore)||void 0===i?void 0:i.whenGraphicBounds(e,t)}computeAttachmentOrigin(e,t){var i;return null===(i=this.graphicsCore)||void 0===i?void 0:i.computeAttachmentOrigin(e,t)}notifyGraphicGeometryChanged(e){this.graphicsCore.notifyGraphicGeometryChanged(e)}notifyGraphicVisibilityChanged(e){this.graphicsCore.notifyGraphicVisibilityChanged(e)}getRenderingInfo(e,t,i){var r;const n=Ia(e,{renderer:t,arcade:i});if(null!==n&&void 0!==n&&n.color){const e=n.color;e[0]=e[0]/255,e[1]=e[1]/255,e[2]=e[2]/255}if(null!=n&&null!=t&&null!==(r=this._randomRotationRenderers)&&void 0!==r&&r.has(t)){const i=this._randomRotationRenderers.get(t),r=e.attributes[i],s=new Jb.b(0);s.updateFloatArray([r]),s.updateUint8Array([173]),n.heading=8.381e-8*s.digest()}return n}getRenderingInfoAsync(e,t,i,r){return Da(e,{renderer:t,arcade:i,...r})}getSymbolLayerSize(e,t){var i;return null===(i=this.graphicsCore)||void 0===i?void 0:i.getSymbolLayerSize(e,t)}setObjectIdVisibility(e,t){var i;null===(i=this.graphicsCore)||void 0===i||i.setObjectIdVisibility(e,t)}refreshFilter(){null!=this.filterVisibility&&this.filterVisibility.reapply()}getGraphics3DGraphicByObjectId(e){var t;return null===(t=this.graphicsCore)||void 0===t?void 0:t.getGraphics3DGraphicByObjectId(e)}_updateClippingExtent(){const e=this.owner.view.clippingArea;this.graphicsCore.setClippingExtent(e,this.owner.view.spatialReference)&&(this.updateClippingExtent(e)||this.graphicsCore.recreateAllGraphics())}_setupSuspendResumeExtent(){(this.frustumVisibility||this.scaleVisibility)&&this.addHandles((0,l.wB)((()=>this.suspendResumeExtentMode),(()=>{switch(this.removeHandles(Tx),this.suspendResumeExtentMode){case"computed":this.addHandles([(0,l.wB)((()=>this.graphicsCore.computedExtent),(e=>this._updateSuspendResumeExtent(e)),l.Vh),(0,l.wB)((()=>this.graphicsCore.extentPadding),(()=>this._updateSuspendResumeExtent(this.graphicsCore.computedExtent)))],Tx);break;case"data":this.addHandles([(0,l.z7)((()=>this.dataExtent),(e=>this._updateSuspendResumeExtent(e)),l.Vh),(0,l.wB)((()=>this.graphicsCore.extentPadding),(()=>this._updateSuspendResumeExtent(this.dataExtent)))],Tx);break;default:(0,or.Xb)(this.suspendResumeExtentMode)}}),l.Vh))}_updateSuspendResumeExtent(e){e?this._suspendResumeExtentChanged(this._extentToSuspendResumeRect(e,this._suspendResumeExtent)):this._suspendResumeExtentChanged(null)}_extentToSuspendResumeRect(e,t){const i=this.owner.view.spatialReference;if(!e.spatialReference.equals(i)){if(!(0,Lb.y7)(e,i))return;e=(0,Lb.Cv)(e,i)}return function(e,t,i){let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;if(e){t||(t=(0,Q.vt)());const n=e;let s=.5*n.width*(i-1),a=.5*n.height*(i-1);return n.width<1e-7*n.height?s+=a/20:n.height<1e-7*n.width&&(a+=s/20),(0,D.s)(t,n.xmin-s-r,n.ymin-a-r,n.xmax+s+r,n.ymax+a+r),t}return null}(e,t,1.2,this.graphicsCore.extentPadding)}_suspendResumeExtentChanged(e){null!=this.frustumVisibility&&this.frustumVisibility.setExtent(e),null!=this.scaleVisibility&&this.scaleVisibility.setExtent(e)}};(0,r._)([(0,d.MZ)()],Ox.prototype,"type",void 0),(0,r._)([(0,d.MZ)({constructOnly:!0})],Ox.prototype,"owner",void 0),(0,r._)([(0,d.MZ)()],Ox.prototype,"layer",null),(0,r._)([(0,d.MZ)({readOnly:!0})],Ox.prototype,"dataUpdating",null),(0,r._)([(0,d.MZ)()],Ox.prototype,"renderer",null),(0,r._)([(0,d.MZ)({constructOnly:!0})],Ox.prototype,"updateClippingExtent",void 0),(0,r._)([(0,d.MZ)({constructOnly:!0})],Ox.prototype,"elevationFeatureExpressionEnabled",void 0),(0,r._)([(0,d.MZ)({constructOnly:!0})],Ox.prototype,"graphicsCore",void 0),(0,r._)([(0,d.MZ)({constructOnly:!0})],Ox.prototype,"scaleVisibilityEnabled",void 0),(0,r._)([(0,d.MZ)({constructOnly:!0})],Ox.prototype,"filterVisibilityEnabled",void 0),(0,r._)([(0,d.MZ)({constructOnly:!0})],Ox.prototype,"frustumVisibilityEnabled",void 0),(0,r._)([(0,d.MZ)({constructOnly:!0})],Ox.prototype,"elevationAlignmentEnabled",void 0),(0,r._)([(0,d.MZ)({constructOnly:!0})],Ox.prototype,"timeExtentEnabled",void 0),(0,r._)([(0,d.MZ)({constructOnly:!0})],Ox.prototype,"setUidToIdOnAdd",void 0),(0,r._)([(0,d.MZ)()],Ox.prototype,"scaleVisibility",null),(0,r._)([(0,d.MZ)()],Ox.prototype,"filterVisibility",null),(0,r._)([(0,d.MZ)()],Ox.prototype,"elevationAlignment",null),(0,r._)([(0,d.MZ)({constructOnly:!0})],Ox.prototype,"frustumVisibility",void 0),(0,r._)([(0,d.MZ)()],Ox.prototype,"objectStates",null),(0,r._)([(0,d.MZ)()],Ox.prototype,"initializePromise",void 0),(0,r._)([(0,d.MZ)()],Ox.prototype,"suspendResumeExtentMode",null),(0,r._)([(0,d.MZ)()],Ox.prototype,"dataExtent",void 0),(0,r._)([(0,d.MZ)()],Ox.prototype,"scaleVisibilitySuspended",null),(0,r._)([(0,d.MZ)()],Ox.prototype,"suspended",null),(0,r._)([(0,d.MZ)()],Ox.prototype,"legendEnabled",null),(0,r._)([(0,d.MZ)()],Ox.prototype,"suspendInfo",null),(0,r._)([(0,d.MZ)()],Ox.prototype,"updating",null),(0,r._)([(0,d.MZ)()],Ox.prototype,"updatingRemaining",null),(0,r._)([(0,d.MZ)()],Ox.prototype,"featureStore",null),(0,r._)([(0,d.MZ)()],Ox.prototype,"view",null),(0,r._)([(0,d.MZ)()],Ox.prototype,"loadedGraphics",null),(0,r._)([(0,d.MZ)()],Ox.prototype,"fullOpacity",null),(0,r._)([(0,d.MZ)()],Ox.prototype,"filter",null),(0,r._)([(0,d.MZ)()],Ox.prototype,"slicePlaneEnabled",null),(0,r._)([(0,d.MZ)()],Ox.prototype,"drapeSourceType",void 0),(0,r._)([(0,d.MZ)()],Ox.prototype,"updatePolicy",null),(0,r._)([(0,d.MZ)()],Ox.prototype,"preferredUpdatePolicy",void 0),(0,r._)([(0,d.MZ)({readOnly:!0})],Ox.prototype,"displayFeatureLimit",null),Ox=(0,r._)([(0,u.$)("esri.views.3d.layers.graphics.Graphics3DFeatureProcessor")],Ox);const Tx="suspendResumeExtentMode";const Px={candidates:[],sourceCandidateIndices:[]};var Mx=i(68002),Ix=i(72547),Dx=i(4414),Lx=i(21812);new Lx._(Pt.r.POSITION,3,ft.pe.FLOAT,0,12),new Lx._(Pt.r.POSITION,3,ft.pe.FLOAT,0,20),new Lx._(Pt.r.UV0,2,ft.pe.FLOAT,12,20),new Lx._(Pt.r.POSITION,3,ft.pe.FLOAT,0,32),new Lx._(Pt.r.NORMAL,3,ft.pe.FLOAT,12,32),new Lx._(Pt.r.UV0,2,ft.pe.FLOAT,24,32),new Lx._(Pt.r.POSITION,3,ft.pe.FLOAT,0,16),new Lx._(Pt.r.COLOR,4,ft.pe.UNSIGNED_BYTE,12,16);const Fx=[new Lx._(Pt.r.POSITION,2,ft.pe.FLOAT,0,8)],Nx=[new Lx._(Pt.r.POSITION,2,ft.pe.FLOAT,0,16),new Lx._(Pt.r.UV0,2,ft.pe.FLOAT,8,16)];var Vx=i(86901);class Gx extends to.Y{constructor(){super(...arguments),this.colorRamp=null,this.densityMap=null,this.searchRadius=1,this.fieldTotal=0,this.minDensity=0,this.maxDensity=100}}class Ux extends Xs.w{constructor(e,t){super(e,t,(()=>this.destroy()))}initializeProgram(e){return new Ks.B(e.rctx,Ux.shader.get().build(this.configuration),$s.D)}initializePipeline(){return(0,ta.Ey)({blending:Io.V0,colorWrite:ta.wE,depthTest:null,depthWrite:null})}get primitiveType(){return ft.WR.TRIANGLE_STRIP}}Ux.shader=new Ys.$(Vx.H,(()=>i.e(6443).then(i.bind(i,86443))));class zx extends na.E{constructor(){super(...arguments),this.usesHalfFloat=!1}}(0,r._)([(0,ra.W)()],zx.prototype,"usesHalfFloat",void 0);var Bx=i(12331);let Hx=class extends Gd{constructor(e){super(e),this.pixelRatio=1,this._colorRampData=new Uint8ClampedArray(4),this.type="draped-heatmap",this._heatmapParameters=new Gx;const t=new Zd.R;t.pixelFormat=e.pixelFormat,t.internalFormat=e.internalFormat,t.dataType=e.dataType,t.samplingMode=e.samplingMode,t.wrapMode=ft.pF.CLAMP_TO_EDGE;const i=e.rendererContext.rctx;this._densityMap=new Bx.H(i,t),this._quad=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Fx,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:$s.D,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:-1,n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1,s=null;return s=t===Nx?new Float32Array([r,r,0,0,n,r,1,0,r,n,0,1,n,n,1,1]):new Float32Array([r,r,n,r,r,n,n,n]),new bd(e,i,{geometry:t},{geometry:xd.g.createVertex(e,ft._U.STATIC_DRAW,s)})}(i);const r=new zx;r.usesHalfFloat=e.dataType!==ft.ld.FLOAT,this._technique=new Ux({rctx:i,viewingMode:ae.RT.Local},r)}initialize(){const e=this._colorRampData,t=new Zd.R(e.length/4,1);t.wrapMode=ft.pF.CLAMP_TO_EDGE,this._colorRamp=new Rl.g(this.rctx,t,e),this._heatmapParameters.densityMap=this._densityMap.colorTexture,this.addHandles((0,l.wB)((()=>[this.colorRampData,this.minDensity,this.maxDensity,this.fieldTotal,this.pixelRatio,this.searchRadius]),(()=>this.rendererContext.notifyContentChanged())))}destroy(){this._technique=(0,le.Gz)(this._technique),this._densityMap=(0,le.WD)(this._densityMap),this._quad=(0,le.WD)(this._quad),this._colorRamp=(0,le.WD)(this._colorRamp)}get searchRadius(){return this._heatmapParameters.searchRadius}set searchRadius(e){e!==this._heatmapParameters.searchRadius&&(this._heatmapParameters.searchRadius=e,this.notifyChange("searchRadius"))}get minDensity(){return this._heatmapParameters.minDensity}set minDensity(e){e!==this._heatmapParameters.minDensity&&(this._heatmapParameters.minDensity=e,this.notifyChange("minDensity"))}get maxDensity(){return this._heatmapParameters.maxDensity}set maxDensity(e){e!==this._heatmapParameters.maxDensity&&(this._heatmapParameters.maxDensity=e,this.notifyChange("maxDensity"))}get fieldTotal(){return this._heatmapParameters.fieldTotal}set fieldTotal(e){this._heatmapParameters.fieldTotal=e,this.notifyChange("fieldTotal")}get colorRampData(){return this._colorRampData}set colorRampData(e){const{colorRamp:t}=this._heatmapParameters;if(null!=t&&e!==this._colorRampData){const i=t.descriptor.width,r=e.length/4;r!==i&&t.resize(r,1),t.setData(e)}this._colorRampData=e}get _colorRamp(){return this._heatmapParameters.colorRamp}set _colorRamp(e){this._heatmapParameters.colorRamp=e}get hasHighlights(){return!1}get hasWater(){return!1}get rendersOccludedDraped(){return!1}render(e){const t=this._sortedMaterialRenderers;if(0===t.length)return;const i=this.rctx.getBoundFramebufferObject(),r=this.rctx.getViewport(),{pixelRatio:n}=this,s=Math.ceil(r.width*n),a=Math.ceil(r.height*n);this._densityMap.resize(s,a),this.rctx.bindFramebuffer(this._densityMap),this.rctx.setViewport(0,0,s,a),this.rctx.clear(ft.hn.COLOR_BUFFER_BIT);let o=!1;t.forAll((t=>{const i=t.prepareTechnique(e);null!=i&&(t.renderNode(e,i),o=!0)})),this.rctx.bindFramebuffer(i),this.rctx.setViewport(r.x,r.y,r.width,r.height),o&&(this.rctx.bindVAO(this._quad),this.rctx.bindTechnique(this._technique,e.bindParameters,this._heatmapParameters),this.rctx.drawArrays(this._technique.primitiveType,0,(0,ug.mT)(this._quad,"geometry")))}};(0,r._)([(0,d.MZ)()],Hx.prototype,"searchRadius",null),(0,r._)([(0,d.MZ)()],Hx.prototype,"minDensity",null),(0,r._)([(0,d.MZ)()],Hx.prototype,"maxDensity",null),(0,r._)([(0,d.MZ)()],Hx.prototype,"fieldTotal",null),(0,r._)([(0,d.MZ)()],Hx.prototype,"pixelRatio",void 0),(0,r._)([(0,d.MZ)()],Hx.prototype,"colorRampData",null),(0,r._)([(0,d.MZ)({constructOnly:!0})],Hx.prototype,"dataType",void 0),(0,r._)([(0,d.MZ)({constructOnly:!0})],Hx.prototype,"samplingMode",void 0),(0,r._)([(0,d.MZ)({constructOnly:!0})],Hx.prototype,"pixelFormat",void 0),(0,r._)([(0,d.MZ)({constructOnly:!0})],Hx.prototype,"internalFormat",void 0),(0,r._)([(0,d.MZ)()],Hx.prototype,"_colorRampData",void 0),Hx=(0,r._)([(0,u.$)("esri.views.3d.webgl-engine.lib.DrapedHeatmapRenderer")],Hx);var jx=i(26741);class Wx extends qs.qA{constructor(){super(...arguments),this.searchRadius=128,this.resolutionForScale=0}}class kx extends Xs.w{initializeProgram(e){return new Ks.B(e.rctx,kx.shader.get().build(this.configuration),$s.D)}initializePipeline(){return(0,ta.Ey)({blending:(0,ta.ox)(ft.dn.ONE,ft.dn.ONE,ft.Tb.ADD),colorWrite:ta.wE,depthTest:null,depthWrite:null})}destroy(){super.destroy()}}kx.shader=new Ys.$(jx.H,(()=>i.e(3263).then(i.bind(i,83263))));class Zx extends na.E{constructor(){super(...arguments),this.isAttributeDriven=!1,this.usesHalfFloat=!1}}(0,r._)([(0,ra.W)()],Zx.prototype,"isAttributeDriven",void 0),(0,r._)([(0,ra.W)()],Zx.prototype,"usesHalfFloat",void 0);class qx extends Wx{constructor(){super(...arguments),this.isAttributeDriven=!1,this.usesHalfFloats=!1}}class Qx extends qs.im{constructor(e){super(e,new qx),this.produces=new Map([[Qs.N.DRAPED_MATERIAL,e=>e===ks.V.Color]]),this._configuration=new Zx}getConfiguration(){return this._configuration.isAttributeDriven=this.parameters.isAttributeDriven,this._configuration.usesHalfFloat=this.parameters.usesHalfFloats,this._configuration}createGLMaterial(e){return new Jx(e)}intersect(){}intersectDraped(e,t,i,r,n,s){const a=e.attributes.get(Pt.r.POSITION),{parameters:o}=this,{searchRadius:l}=o,{screenToWorldRatio:c}=e,d=l*c+2*c,h=d*d,u=a.data.length/a.size;for(let p=0;p<u;p++){const e=p*a.size,t=(0,Sa.hZ)(eS,a.data[e],a.data[e+1]);(0,Sa.hG)(t,r)<h&&n(s.dist,s.normal,-1,!1)}}createBufferWriter(){return new Yx(this.parameters.isAttributeDriven?$x:Xx)}}class Jx extends Zs.A{beginSlot(e){return this.ensureTechnique(kx,e)}}class Yx{constructor(e){this.vertexBufferLayout=e}elementCount(e){return e.attributes.get(Pt.r.POSITION).indices.length*Kx}write(e,t,i,r,n){(0,Js.Hk)(i.attributes.get(Pt.r.POSITION),e,r.position,n,Kx);const s=i.attributes.get(Pt.r.POSITION).indices.length,a=r.uv0;let o=n;for(let c=0;c<s;++c)a.setValues(o++,-1,-1),a.setValues(o++,1,-1),a.setValues(o++,1,1),a.setValues(o++,1,1),a.setValues(o++,-1,1),a.setValues(o++,-1,-1);const l=Pt.r.FEATUREATTRIBUTE in r?r.featureAttribute:null;l&&(0,Js.uO)(i.attributes.get(Pt.r.FEATUREATTRIBUTE),l,n,Kx)}}const Xx=(0,Ws.BP)().vec3f(Pt.r.POSITION).vec2f(Pt.r.UV0),$x=Xx.clone().f32(Pt.r.FEATUREATTRIBUTE),Kx=6,eS=(0,pr.vt)();var tS=i(2995);let iS=class extends s.A{constructor(e){super(e),this.type="heatmap",this.preferredUpdatePolicy=Ao.ASYNC,this.dataExtent=null,this.drapeSourceType=La.Features,this._renderGeometries=new Map,this._fieldTotal=0,this._drapeSourceRenderer=null,this._dataType=ft.ld.HALF_FLOAT,this._pixelFormat=ft.Ab.RGBA,this._updatingHandles=new F.U,this.initializePromise=Promise.resolve()}initialize(){this._featureStore=new Ix.A({geometryType:"esriGeometryPoint",hasZ:this.hasZ,hasM:this.hasM});const{dataType:e,samplingMode:t,pixelFormat:i,internalFormat:r}=(0,tS.S)(this._renderView.renderingContext,a.A.getLogger(this));this._dataType=e,this._pixelFormat=i;const n=e!==ft.ld.FLOAT;this._drapeSourceRenderer=this.view.basemapTerrain.overlayManager.registerDrapeSource(this,Hx,{...this._rendererParameters,dataType:e,samplingMode:t,pixelFormat:i,internalFormat:r}),this._material=new Qx({usesHalfFloats:n}),this._materialWithField=new Qx({usesHalfFloats:n,isAttributeDriven:!0}),this._filterVisibility=new Ex({context:{layerView:this.owner,featureStore:this.featureStore,getFeatureCount:()=>this._loadedPointGraphics.length,setAllFeaturesVisibility:e=>this._setAllFeaturesVisibility(e),clearFeaturesVisibility:()=>this._setAllFeaturesVisibility(!0),updateFeatureVisibilities:e=>this._updateFeatureVisibilities(e)}}),this._updatingHandles.addOnCollectionChange((()=>this._loadedPointGraphics),(e=>this._onLoadedFeaturesChange(e)),l.Vh),this._updatingHandles.addWhen((()=>this._materialParameters),(e=>this._forEachMaterial((t=>t.setParameters(e)))),l.Vh),this._updatingHandles.add((()=>this._rendererParameters),(e=>this._drapeSourceRenderer.set(e))),this._updatingHandles.add((()=>this._heatmapRendererField),(()=>{this._recreate()}),l.OH),this._updatingHandles.add((()=>({fieldName:this._heatmapRendererFieldName,numeric:this._heatmapRendererFieldIsNumeric})),(e=>{let{fieldName:t,numeric:i}=e;if(null!=t&&i){let e=0;this._featureStore.forEach((i=>{var r;return e+=null!==(r=i.attributes[t])&&void 0!==r?r:0})),this._fieldTotal=e}else this._fieldTotal=this._featureStore.numFeatures}),l.Vh),this.addHandles([(0,l.wB)((()=>({fieldName:this._heatmapRendererFieldName,field:this._heatmapRendererField})),(e=>{var t;let{fieldName:i,field:r}=e;i&&!r&&a.A.getLogger(this).warn("Heatmap renderer field '".concat(i,"' for layer '").concat(null!==(t=this.layer.title)&&void 0!==t?t:this.layer.id,"' not found"))})),(0,l.wB)((()=>({field:this._heatmapRendererField,numeric:this._heatmapRendererFieldIsNumeric})),(e=>{var t;let{field:i,numeric:r}=e;null==i||r||a.A.getLogger(this).warn("Heatmap renderer field '".concat(i.name,"' for layer '").concat(null!==(t=this.layer.title)&&void 0!==t?t:this.layer.id,"' does not contain numeric values and cannot be used to drive the heatmap density"))})),(0,w.hA)((()=>this.view.basemapTerrain.overlayManager.unregisterDrapeSource(this)))])}destroy(){this._renderGeometries.clear(),this._material=null,this._materialWithField=null,this._featureStore.clear(),this._featureStore=null,this._updatingHandles.destroy()}get layer(){return this.owner.layer}get featureStore(){return this._featureStore}get updating(){return this._updatingHandles.updating||this.filterVisibility.updating}get updatingRemaining(){return 0}get suspendInfo(){return{}}get legendEnabled(){return!0}get filterVisibility(){return this._filterVisibility}get displayFeatureLimit(){var e,t,i;const r=null!==(e=null===(t=this.owner)||void 0===t||null===(t=t.view)||void 0===t?void 0:t.quality)&&void 0!==e?e:1,n=null===(i=this.owner)||void 0===i||null===(i=i.view)||void 0===i?void 0:i.qualitySettings,s=n?Math.ceil(n.heatmap.maxTotalNumberOfFeatures*r):0;return new bn(6*s,s)}get hasZ(){return"hasZ"in this.layer&&this.layer.hasZ}get hasM(){return"hasM"in this.layer&&this.layer.hasM}get view(){return this.owner.view}get fullOpacity(){return this.owner.fullOpacity}get updatePolicy(){return this.owner.updatePolicy}get scaleVisibilitySuspended(){if(!this._isScaleRangeActive)return!1;const{minScale:e,maxScale:t}=this.layer.effectiveScaleRange,{scale:i}=this.view;return!(0,wi.JU)(i,null!==e&&void 0!==e?e:0,null!==t&&void 0!==t?t:0)}get usedMemory(){var e,t,i;const r=this.usedMemoryPerFeature*this._featureStore.numFeatures,n=this._pixelFormat===ft.Ab.RED?1:4,s=this._dataType===ft.ld.FLOAT?4:2,a=null!==(e=Math.ceil((null!==(t=null===(i=this._overlayRenderer)||void 0===i||null===(i=i.overlays[0])||void 0===i?void 0:i.resolution)&&void 0!==t?t:0)*this._densityMapPixelRatio))&&void 0!==e?e:0;return a*a*n*s+r}get usedMemoryPerFeature(){const e=this._loadedPointGraphics.find((()=>!0));if(null==e)return 0;const t=(0,ba.eY)(e),i=(0,ba.f3)();return 6*(0,ba.zd)([0,0,0],i)+6*(0,ba.zd)([0,0],i)+(this._heatmapRendererFieldIsNumeric?6*i:0)+t}get loadedFeatures(){return this._featureStore.numFeatures}get unprocessedMemoryEstimate(){return 0}get performanceInfo(){return new Pv(this._visibleFeatures,0,0)}get renderer(){return this._heatmapRenderer}get _overlayRenderer(){return this.view.basemapTerrain.overlayManager.renderer}get _overlaySpatialReference(){return this._overlayRenderer.spatialReference}get _rendererParameters(){return{...this._radiusParameter,...this._densityParameters,...this._colorRampParameter,...this._pixelRatioParameter}}get _materialParameters(){return{...this._radiusParameter,...this._resolutionForScaleParameter}}get _densityParameters(){const e=this._heatmapRenderer;if(null==e)return null;const{minDensity:t,maxDensity:i}=e;return{minDensity:t,maxDensity:i,fieldTotal:this._fieldTotal}}get _radiusParameter(){const e=this._heatmapRenderer;return e?{searchRadius:(0,Ln.Lz)(this._clampSearchRadius(e.radius))}:null}get _resolutionForScaleParameter(){const e=this._heatmapRenderer;if(!e)return null;const{referenceScale:t}=e;return{resolutionForScale:0===t?0:(0,Mx.i1)(t,this.view.spatialReference)}}get _colorRampParameter(){const e=this._heatmapRenderer;return e?{colorRampData:(0,Dx.O3)(e.colorStops)}:null}get _pixelRatioParameter(){return{pixelRatio:this._densityMapPixelRatio}}get _densityMapPixelRatio(){var e,t;return null!==(e=null===(t=this.owner)||void 0===t||null===(t=t.view)||void 0===t?void 0:t.qualitySettings.heatmap.pixelRatio)&&void 0!==e?e:1}get _renderView(){return this.view._stage.renderView}get _featuresArePoints(){return"point"===this.layer.geometryType}get _loadedPointGraphics(){return this.owner.loadedGraphics}get _heatmapRenderer(){const e=this.layer.renderer;return"heatmap"===(null===e||void 0===e?void 0:e.type)?e:null}get _heatmapRendererFieldName(){var e;return null===(e=this._heatmapRenderer)||void 0===e?void 0:e.field}get _heatmapRendererField(){const e=this._heatmapRendererFieldName;return null!=e?this.layer.fieldsIndex.get(e):null}get _heatmapRendererFieldIsNumeric(){const e=this._heatmapRendererField;return null!=e&&(0,Di.WA)(e)}get _isScaleRangeActive(){const{layer:e}=this;if(!("effectiveScaleRange"in e))return!1;const{minScale:t,maxScale:i}=e.effectiveScaleRange;return(0,wi.WK)(t,i)}get _visibleFeatures(){let e=0;return this._renderGeometries.forEach((t=>{t.visible&&++e})),e}async whenGraphicBounds(){return null}computeAttachmentOrigin(){return null}highlight(){return(0,w.hA)()}maskOccludee(){return(0,w.hA)()}setObjectIdVisibility(){}refreshFilter(){this.filterVisibility.reapply()}_onLoadedFeaturesChange(e){if(!this._featuresArePoints)return;const{objectIdField:t}=this.layer;this._featureStore.removeManyById(e.removed.map((e=>(0,ji.RW)(e,t)))),this._featureStore.addMany(e.added.map((e=>{const{attributes:i,centroid:r,geometry:n}=e,s=new An.Om((0,Ca.qN)(new Rn.A,n),i,r?(0,Ca.qN)(new Rn.A,r):null,(0,ji.RW)(e,t));return s.displayId=e.uid,s})));const i=e.added,r=e.removed;this._fieldTotal+=this._computeFieldTotalChange(i,r);const n=r.map((e=>{let{uid:t}=e;const i=this._renderGeometries.get(t);return this._renderGeometries.delete(t),i})).filter(b.Ru),s=i.map((e=>{const t=this._pointGraphicToRenderGeometry(e);return this._renderGeometries.set(e.uid,t),t}));n.length>0&&this._drapeSourceRenderer.removeGeometries(n,rd.REMOVE),s.length>0&&this._drapeSourceRenderer.addGeometries(s,rd.ADD),(s.length>0||n.length>0)&&(this.filterVisibility.reapply(),this._renderView.requestRender())}_recreate(){if(!this._loadedPointGraphics)return;const e=this._loadedPointGraphics.toArray();this._onLoadedFeaturesChange({added:e,removed:e})}_pointGraphicToRenderGeometry(e){var t;const i=this._heatmapRendererFieldName,r=null!=i?this._materialWithField:this._material,n=(0,I.vt)();(0,As.g)(e.geometry,n,this._overlaySpatialReference),n[2]=-2;const s=(0,X.tM)(1),a=[[Pt.r.POSITION,new _r.n(n,s,n.length)]],o=this._heatmapRendererFieldIsNumeric;null!=i&&a.push([Pt.r.FEATUREATTRIBUTE,new _r.n([o&&null!==(t=e.attributes[i])&&void 0!==t?t:0],s,1)]);const l=new du(new yr.V(r,a,null,vr.X.Point),{layerUid:this.layer.uid,graphicUid:e.uid});return l.visible=this.filterVisibility.defaultVisibility,l}_forEachMaterial(e){e(this._material),e(this._materialWithField)}_computeFieldTotalChange(e,t){if(null==this._heatmapRendererFieldName||!this._heatmapRendererFieldIsNumeric)return e.length-t.length;const i=this._heatmapRendererFieldName,r=(e,t)=>{var r;return e+(null!==(r=t.attributes[i])&&void 0!==r?r:0)};return e.reduce(r,0)-t.reduce(r,0)}_clampSearchRadius(e){return e>112&&a.A.getLogger(this).warnOnce("SceneView supports a maximum radius of ".concat(112," pt for HeatmapRenderer.")),Math.min(e,112)}_updateFeatureVisibilities(e){const t=[];this._featureStore.forEach((i=>{let{objectId:r,displayId:n}=i;const s=e(r),a=this._renderGeometries.get(n);a&&a.visible!==s&&(t.push(a),a.visible=s)})),this._drapeSourceRenderer.modifyGeometries(t,nd.VISIBILITY)}_setAllFeaturesVisibility(e){const t=[];for(const i of this._renderGeometries.values())i.visible!==e&&(t.push(i),i.visible=e);this._drapeSourceRenderer.modifyGeometries(t,nd.VISIBILITY)}get test(){return{visibleFeatureCount:this._visibleFeatures}}};(0,r._)([(0,d.MZ)()],iS.prototype,"type",void 0),(0,r._)([(0,d.MZ)({constructOnly:!0})],iS.prototype,"owner",void 0),(0,r._)([(0,d.MZ)()],iS.prototype,"layer",null),(0,r._)([(0,d.MZ)()],iS.prototype,"featureStore",null),(0,r._)([(0,d.MZ)()],iS.prototype,"updating",null),(0,r._)([(0,d.MZ)()],iS.prototype,"updatingRemaining",null),(0,r._)([(0,d.MZ)()],iS.prototype,"suspendInfo",null),(0,r._)([(0,d.MZ)()],iS.prototype,"legendEnabled",null),(0,r._)([(0,d.MZ)()],iS.prototype,"filterVisibility",null),(0,r._)([(0,d.MZ)()],iS.prototype,"displayFeatureLimit",null),(0,r._)([(0,d.MZ)()],iS.prototype,"preferredUpdatePolicy",void 0),(0,r._)([(0,d.MZ)()],iS.prototype,"hasZ",null),(0,r._)([(0,d.MZ)()],iS.prototype,"hasM",null),(0,r._)([(0,d.MZ)()],iS.prototype,"dataExtent",void 0),(0,r._)([(0,d.MZ)()],iS.prototype,"view",null),(0,r._)([(0,d.MZ)()],iS.prototype,"fullOpacity",null),(0,r._)([(0,d.MZ)()],iS.prototype,"updatePolicy",null),(0,r._)([(0,d.MZ)()],iS.prototype,"drapeSourceType",void 0),(0,r._)([(0,d.MZ)()],iS.prototype,"scaleVisibilitySuspended",null),(0,r._)([(0,d.MZ)()],iS.prototype,"renderer",null),(0,r._)([(0,d.MZ)()],iS.prototype,"_featureStore",void 0),(0,r._)([(0,d.MZ)()],iS.prototype,"_filterVisibility",void 0),(0,r._)([(0,d.MZ)()],iS.prototype,"_overlayRenderer",null),(0,r._)([(0,d.MZ)()],iS.prototype,"_overlaySpatialReference",null),(0,r._)([(0,d.MZ)()],iS.prototype,"_rendererParameters",null),(0,r._)([(0,d.MZ)()],iS.prototype,"_materialParameters",null),(0,r._)([(0,d.MZ)()],iS.prototype,"_densityParameters",null),(0,r._)([(0,d.MZ)()],iS.prototype,"_radiusParameter",null),(0,r._)([(0,d.MZ)()],iS.prototype,"_resolutionForScaleParameter",null),(0,r._)([(0,d.MZ)()],iS.prototype,"_colorRampParameter",null),(0,r._)([(0,d.MZ)()],iS.prototype,"_pixelRatioParameter",null),(0,r._)([(0,d.MZ)()],iS.prototype,"_densityMapPixelRatio",null),(0,r._)([(0,d.MZ)()],iS.prototype,"_renderGeometries",void 0),(0,r._)([(0,d.MZ)()],iS.prototype,"_material",void 0),(0,r._)([(0,d.MZ)()],iS.prototype,"_materialWithField",void 0),(0,r._)([(0,d.MZ)()],iS.prototype,"_renderView",null),(0,r._)([(0,d.MZ)()],iS.prototype,"_featuresArePoints",null),(0,r._)([(0,d.MZ)()],iS.prototype,"_loadedPointGraphics",null),(0,r._)([(0,d.MZ)()],iS.prototype,"_heatmapRenderer",null),(0,r._)([(0,d.MZ)()],iS.prototype,"_heatmapRendererFieldName",null),(0,r._)([(0,d.MZ)()],iS.prototype,"_heatmapRendererField",null),(0,r._)([(0,d.MZ)()],iS.prototype,"_heatmapRendererFieldIsNumeric",null),(0,r._)([(0,d.MZ)()],iS.prototype,"_fieldTotal",void 0),(0,r._)([(0,d.MZ)()],iS.prototype,"_drapeSourceRenderer",void 0),(0,r._)([(0,d.MZ)()],iS.prototype,"_isScaleRangeActive",null),iS=(0,r._)([(0,u.$)("esri.views.3d.layers.support.HeatmapFeatureProcessor")],iS);const rS=e=>{let t=class extends e{constructor(){super(...arguments),this._dataUpdatingState=nS.NONE,this.controller=null,this.updatePolicy=Ao.SYNC,this.suspendResumeExtentMode="computed",this.slicePlaneEnabled=!1,this.fullExtentInLocalViewSpatialReference=null,this.suspendResumeExtent=null,this._controllerCreated=!1,this.supportsHeightUnitConversion=!0,this._pendingController=null,this.queryEngine=null}initialize(){const e=this.layer;if("isTable"in e&&e.isTable)return void this.addResolvingPromise(Promise.reject(new oe.A("featurelayerview:table-not-supported","table feature layer can't be displayed",{layer:e})));this.addResolvingPromise(this._validateGeometryType()),this._updatingHandles.add((()=>this.layer.renderer),(e=>this._recreateProcessor(e)),l.Vh),this.addResolvingPromise((async()=>{const e=await function(e){const t=e.view.spatialReference,i=e.layer.fullExtent,r=null!=i&&i.spatialReference;if(null==i||!r)return Promise.resolve(null);if(r.equals(t))return Promise.resolve(i.clone());const n=(0,Lb.Cv)(i,t);return null!=n?Promise.resolve(n):e.view.state.isLocal?(0,rb.projectGeometry)(i,t,e.layer.portalItem).then((t=>!e.destroyed&&t?t:null)).catch((()=>null)):Promise.resolve(null)}(this);this.fullExtentInLocalViewSpatialReference=e,await this._initializeController()})()),this._updatingHandles.add((()=>this.updatePolicy),(e=>this.processor.preferredUpdatePolicy=e));const t=()=>this.processor.featureStore;this.queryEngine=new Rx({context:{spatialReference:this.view.spatialReference,layer:this.layer,scheduler:this.view.resourceController.scheduler,get featureStore(){return t()},hasZ:this.hasZ,hasM:this.hasM},priority:Ae.W6.FEATURE_QUERY_ENGINE}),this.notifyChange("updating")}destroy(){this._destroyPendingController(),this.controller=(0,le.pR)(this.controller),this._set("processor",(0,le.pR)(this.processor)),this.queryEngine=(0,le.pR)(this.queryEngine),this.loadedGraphics=null}_destroyPendingController(){this._pendingController=(0,le.pR)(this._pendingController)}get dataUpdating(){return this._dataUpdatingState!==nS.NONE}get legendEnabled(){var e;return this.canResume()&&(null===(e=this.processor)||void 0===e?void 0:e.legendEnabled)}get graphics3DProcessor(){var e;return"graphics-3d"===(null===(e=this.processor)||void 0===e?void 0:e.type)?this.processor:null}get heatmapProcessor(){var e;return"heatmap"===(null===(e=this.processor)||void 0===e?void 0:e.type)?this.processor:null}get symbologySnappingSupported(){var e,t;const i=null===(e=this.layer)||void 0===e||null===(e=e.renderer)||void 0===e?void 0:e.getSymbols();return null!==(t=null===i||void 0===i?void 0:i.some(Nh.f3))&&void 0!==t&&t}get hasAllFeatures(){return!(!this.controller||!("hasAllFeatures"in this.controller))&&this.controller.hasAllFeatures}get hasAllFeaturesInView(){return!(!this.controller||!("hasAllFeaturesInView"in this.controller))&&this.controller.hasAllFeaturesInView}get hasFullGeometries(){return!(!this.controller||!("hasFullGeometries"in this.controller))&&this.controller.hasFullGeometries}getHit(e){var t;let i;return null!==(t=this.loadedGraphics)&&void 0!==t&&t.forEach((t=>{t.uid===e&&(i=Qt(t,this.layer))})),i?{type:"graphic",graphic:i,layer:i.layer}:null}whenGraphicBounds(e,t){var i;return null===(i=this.processor)||void 0===i?void 0:i.whenGraphicBounds(e,t)}computeAttachmentOrigin(e,t){var i;return null===(i=this.processor)||void 0===i?void 0:i.computeAttachmentOrigin(e,t)}async elevationAlignPointsInFeatures(e,t){const i=this.graphics3DProcessor;if(null==i)throw new oe.A("featurelayerview3d:missing-processor","A Graphics3D processor is needed to resolve graphics elevation.");return async function(e,t,i,r,n){var s;const{elevationProvider:a,renderCoordsHelper:l}=e,{elevationInfo:c}=t,{pointsInFeatures:d,spatialReference:h}=r,u=kt.A.fromJSON(h),p=ri(c,!0),f=await ei(p,u,n);(0,o.Te)(n);const g=[],m=new Set,_=new Set,v=new oi,y=(0,ne.T)(0,0,0,kt.A.WGS84),b=new Ut,x=(0,I.vt)();y.spatialReference=u;const S=null!==(s=e.elevationProvider.spatialReference)&&void 0!==s?s:e.spatialReference;for(const{objectId:o,points:C}of d){const e=i(o);if(null==e){for(const e of C){var w;g.push(null!==(w=e.z)&&void 0!==w?w:0)}m.add(o);continue}e.isDraped&&_.add(o);const r=e.graphic.geometry;v.setFromElevationInfo((0,Qb.ze)(r,c)),v.updateFeatureExpressionInfoContext(f,e.graphic,t);for(const{x:t,y:i,z:s}of C)y.x=t,y.y=i,y.z=null!==s&&void 0!==s?s:0,await(0,As.W)(y,x,S,0,{signal:n}),It(x,a,v,l,b),g.push(b.z)}return{elevations:g,drapedObjectIds:_,failedObjectIds:m}}(this.view,this.layer,(e=>i.getGraphics3DGraphicByObjectId(e)),e,t)}async queryForSymbologySnapping(e,t){return this.symbologySnappingSupported?async function(e,t,i){var r;if(null==e||0===t.candidates.length)return Px;const n=null!==(r=e.graphics3DGraphicsByObjectID)&&void 0!==r?r:e.graphics3DGraphics,s=[],a=[],{renderer:l}=e,c=null!=l&&"arcadeRequired"in l&&l.arcadeRequired?(0,Kt.lw)():null,d=async(t,r)=>{let{graphic:n,graphics3DSymbol:s}=r;const a=await c,o=await e.getRenderingInfoAsync(n,l,a,{signal:i});return null==o?[]:s.queryForSnapping(t,u,o,i)},{candidates:h,spatialReference:u}=t;for(let o=0;o<h.length;++o){const e=h[o],{objectId:t}=e,i="number"==typeof t?null===n||void 0===n?void 0:n.get(t):void 0;if(null==i)continue;const{graphics3DSymbol:r}=i;r.symbologySnappingSupported&&(s.push(d(e,i)),a.push(o))}if(0===s.length)return Px;const p=await Promise.all(s);(0,o.Te)(i);const f=[],g=[];for(let o=0;o<p.length;++o){const e=p[o],t=a[o];for(const i of e)f.push(i),g.push(t)}return{candidates:f,sourceCandidateIndices:g}}(this.graphics3DProcessor,e,t):{candidates:[],sourceCandidateIndices:[]}}queryFeatures(e,t){return this.queryEngine.executeQuery(this._ensureQuery(e),null===t||void 0===t?void 0:t.signal)}queryObjectIds(e,t){return this.queryEngine.executeQueryForIds(this._ensureQuery(e),null===t||void 0===t?void 0:t.signal)}queryFeatureCount(e,t){return this.queryEngine.executeQueryForCount(this._ensureQuery(e),null===t||void 0===t?void 0:t.signal)}queryExtent(e,t){return this.queryEngine.executeQueryForExtent(this._ensureQuery(e),null===t||void 0===t?void 0:t.signal)}_ensureQuery(e){return null==e?this.createQuery():ob.A.from(e)}highlight(e){return this.processor.highlight(e,this.layer.objectIdField)}maskOccludee(e){return this.processor.maskOccludee(e)}canResume(){var e;return super.canResume()&&!(null!==(e=this.processor)&&void 0!==e&&e.scaleVisibilitySuspended)}getSuspendInfo(){const e=super.getSuspendInfo();return this.processor?{...e,...this.processor.suspendInfo}:e}isUpdating(){var e,t;return!(!this.processor||this.processor.destroyed)&&!(this._controllerCreated&&(null===(e=this.controller)||void 0===e||!e.updating)&&null!==(t=this.view)&&void 0!==t&&null!==(t=t.basemapTerrain)&&void 0!==t&&t.ready&&!this.processor.updating)}async _initializeController(){const e=this.createController();this._pendingController=e,this._setupDataUpdating(e),await e.when(),this._setControllerWhenInitialized(e)}_setupDataUpdating(e){"dataUpdating"in e&&this.addHandles([(0,l.wB)((()=>e.dataUpdating),(e=>{e&&this._dataUpdatingState===nS.NONE?this._dataUpdatingState=nS.CONTROLLER:e||this._dataUpdatingState!==nS.CONTROLLER||(this._dataUpdatingState=nS.NONE)}),l.OH),(0,l.wB)((()=>{var e;return!(null===(e=this.graphics3DProcessor)||void 0===e||!e.dataUpdating)}),(t=>{t&&this._dataUpdatingState===nS.CONTROLLER?this._dataUpdatingState=nS.CORE:t||this._dataUpdatingState!==nS.CORE||(this._dataUpdatingState=e.dataUpdating?nS.CONTROLLER:nS.NONE)}),l.OH)])}async _setControllerWhenInitialized(e){try{await this.when()}catch(t){}this._controllerCreated=!0,this.notifyChange("updating"),this.isResolved()&&!this.destroyed?(await(0,l.C_)((()=>{var e;return null===(e=this.view)||void 0===e||null===(e=e.basemapTerrain)||void 0===e?void 0:e.ready})),this.beforeSetController(e),this._pendingController=null,this.controller=e,this.loadedGraphics=e.graphics,this.notifyChange("updating")):this._destroyPendingController()}_updateClippingExtent(e){if(this.clippingExtent=e,!this.controller)return!1;switch(this.controller.type){case"stream":return!1;case"feature-tile-3d":return this.controller.extent=e,!0}}async _validateGeometryType(){switch(this.layer.geometryType){case"multipatch":case"multipoint":throw new oe.A("featurelayerview3d:unsupported-geometry-type","Unsupported geometry type ${geometryType}",{geometryType:this.layer.geometryType})}}_recreateProcessor(e){var t,i;const r="heatmap"===(null===e||void 0===e?void 0:e.type),n="heatmap"===(null===(t=this.processor)||void 0===t?void 0:t.type),s=this.processor;if(s&&r===n)return;const a=r?new iS({owner:this}):new Ox({owner:this,frustumVisibilityEnabled:!0,scaleVisibilityEnabled:!0,filterVisibilityEnabled:!0,timeExtentEnabled:!0,elevationAlignmentEnabled:!0,elevationFeatureExpressionEnabled:!0,preferredUpdatePolicy:this.updatePolicy,updateClippingExtent:e=>this._updateClippingExtent(e)});this._set("processor",a),null!==s&&void 0!==s&&s.destroy(),null!==(i=this.queryEngine)&&void 0!==i&&i.clear(),this.addResolvingPromise(a.initializePromise)}get performanceInfo(){var e,t,i;const r=this.controller instanceof Hb?this.controller:null;return new Sy(this.processor.usedMemory,null===(e=this.loadedGraphics)||void 0===e?void 0:e.length,null!==(t=null===r||void 0===r?void 0:r.serviceDataCount)&&void 0!==t?t:-1,null!==(i=null===r||void 0===r?void 0:r.maximumNumberOfFeatures)&&void 0!==i?i:-1,0,this.processor.performanceInfo)}};return(0,r._)([(0,d.MZ)()],t.prototype,"loadedGraphics",void 0),(0,r._)([(0,d.MZ)()],t.prototype,"_dataUpdatingState",void 0),(0,r._)([(0,d.MZ)({readOnly:!0})],t.prototype,"dataUpdating",null),(0,r._)([(0,d.MZ)()],t.prototype,"suspended",void 0),(0,r._)([(0,d.MZ)({readOnly:!0})],t.prototype,"legendEnabled",null),(0,r._)([(0,d.MZ)()],t.prototype,"updating",void 0),(0,r._)([(0,d.MZ)()],t.prototype,"controller",void 0),(0,r._)([(0,d.MZ)()],t.prototype,"processor",void 0),(0,r._)([(0,d.MZ)({readOnly:!0})],t.prototype,"updatePolicy",void 0),(0,r._)([(0,d.MZ)({readOnly:!0})],t.prototype,"suspendResumeExtentMode",void 0),(0,r._)([(0,d.MZ)({type:Boolean})],t.prototype,"slicePlaneEnabled",void 0),(0,r._)([(0,d.MZ)({readOnly:!0})],t.prototype,"suspendInfo",void 0),(0,r._)([(0,d.MZ)()],t.prototype,"graphics3DProcessor",null),(0,r._)([(0,d.MZ)()],t.prototype,"heatmapProcessor",null),(0,r._)([(0,d.MZ)()],t.prototype,"symbologySnappingSupported",null),(0,r._)([(0,d.MZ)({readOnly:!0})],t.prototype,"hasAllFeatures",null),(0,r._)([(0,d.MZ)({readOnly:!0})],t.prototype,"hasAllFeaturesInView",null),(0,r._)([(0,d.MZ)({readOnly:!0})],t.prototype,"hasFullGeometries",null),t=(0,r._)([(0,u.$)("esri.views.3d.layers.FeatureLikeLayerView3D")],t),t};var nS;!function(e){e[e.NONE=0]="NONE",e[e.CONTROLLER=1]="CONTROLLER",e[e.CORE=2]="CORE"}(nS||(nS={}));var sS=i(47700);const aS=e=>{let t=class extends e{constructor(){super(...arguments),this.slicePlaneEnabled=!1,this.supportsHeightUnitConversion=!1}postscript(e){super.postscript(e),(0,sS.jI)(this.layer)&&this.addResolvingPromise(this._validateHeightModelInfo())}async _validateHeightModelInfo(){const e=new AbortController,t=e.signal;this.addHandles((0,w.hA)((()=>e.abort()))),await(0,l.C_)((()=>{var e;return null===(e=this.view.defaultsFromMap)||void 0===e?void 0:e.heightModelInfoReady}),t),(0,o.Te)(t);const i=(0,sS.Hu)(this.layer,this.view.heightModelInfo,this.supportsHeightUnitConversion);if(i)throw i}canResume(){const e=this.layer&&"effectiveScaleRange"in this.layer?this.layer.effectiveScaleRange:null;return super.canResume()&&(!(null!==e&&void 0!==e&&e.minScale)||!e.maxScale||e.minScale>=e.maxScale)}getSuspendInfo(){const e=super.getSuspendInfo(),t=this.layer&&"effectiveScaleRange"in this.layer?this.layer.effectiveScaleRange:null;return t&&t.minScale&&t.maxScale&&t.minScale<t.maxScale&&(e.outsideScaleRange=!0),e}};return(0,r._)([(0,d.MZ)()],t.prototype,"view",void 0),(0,r._)([(0,d.MZ)()],t.prototype,"slicePlaneEnabled",void 0),t=(0,r._)([(0,u.$)("esri.views.3d.layers.LayerView3D")],t),t};var oS=i(36643);class lS{constructor(e){this._controller=e,this._handle=new dS((t=>e.schedule(t)))}destroy(){this._handle.destroy()}invoke(e,t){return e.buffer&&0!==e.buffer.byteLength?(e.options.sourceSpatialReference&&e.options.sourceSpatialReference instanceof kt.A&&(e.options={...e.options,sourceSpatialReference:e.options.sourceSpatialReference.toJSON()}),this._handle.invoke(e,t).then((e=>{let t=0,i=0;const r=kt.A.fromJSON(e.spatialReference);e.spatialReference=r;const n=async s=>{const a=e.fields;if(a)for(;t<a.length;)if(a[t]=cb.A.fromJSON(a[t]),t++,s.madeProgress())return this._controller.reschedule((e=>n(e)));const o=e.features;for(;i<o.length;){const e=o[i];++i,e.uid=y.A.generateUID();const t=e.geometry;if(null!=t&&(t.spatialReference=r,cS(t),s.madeProgress()))return this._controller.reschedule((e=>n(e)))}return e};return this._controller.schedule((e=>n(e)))}))):Promise.resolve(null)}}function cS(e){switch(e.type){case"polyline":e.paths.reduce(((e,t)=>e+t.length),0)<A.y9&&(e.paths=e.hasZ||e.hasM?e.paths.map((e=>e.map((e=>[e[0],e[1],e[2]])))):e.paths.map((e=>e.map((e=>[e[0],e[1]])))));break;case"polygon":e.rings.reduce(((e,t)=>e+t.length),0)<A.y9&&(e.rings=e.hasZ||e.hasM?e.rings.map((e=>e.map((e=>[e[0],e[1],e[2]])))):e.rings.map((e=>e.map((e=>[e[0],e[1]])))))}}class dS extends f.B{constructor(e){super("PBFDecoderWorker","_parseFeatureQuery",{_parseFeatureQuery:e=>[e.buffer]},e)}}let hS=class extends s.A{constructor(e){super(e)}get implicitFields(){var e;if(!(null===(e=this.layer.outFields)||void 0===e?void 0:e.includes("*")))return new Set;const t=new Set(this.layerView.requiredFields),i=new Set(this.layerView.availableFields);return(0,Ua.iv)(i,t)}get queryFeaturesDehydrated(){const{layer:e}=this,t=e.capabilities,i=t&&t.query,r=i&&i.supportsFormatPBF,n=e.parsedUrl;if(r){var s,a;null==this._decoder&&(this._decoder=new lS(this.controller));const t={sourceSpatialReference:null!==(s=null===(a=e.spatialReference)||void 0===a?void 0:a.toJSON())&&void 0!==s?s:null,applyTransform:!0,maxStringAttributeFields:this.implicitFields,maxStringAttributeLength:gS};return(e,i)=>(0,oS.GB)(n,e,"pbf",this._createRequestOptions(i)).then((e=>((0,o.Te)(i),null!=this._decoder?this._decoder.invoke({buffer:e.data,options:t},i.signal):Promise.reject((0,o.NK)()))))}return(t,i)=>(0,oS.eW)(n,t,e.spatialReference,this._createRequestOptions(i)).then((e=>(0,ji.JS)(e.data,{maxStringAttributeFields:this.implicitFields,maxStringAttributeLength:gS})))}queryFeatureCount(e,t){return this.layer.queryFeatureCount(e,t)}destroy(){this._decoder=(0,le.pR)(this._decoder)}_createRequestOptions(e){return{...e,query:{...this.layer.customParameters,token:this.layer.apiKey,...null===e||void 0===e?void 0:e.query}}}};(0,r._)([(0,d.MZ)({constructOnly:!0})],hS.prototype,"layer",void 0),(0,r._)([(0,d.MZ)({constructOnly:!0})],hS.prototype,"layerView",void 0),(0,r._)([(0,d.MZ)({constructOnly:!0})],hS.prototype,"controller",void 0),(0,r._)([(0,d.MZ)({readOnly:!0})],hS.prototype,"implicitFields",null),(0,r._)([(0,d.MZ)({readOnly:!0})],hS.prototype,"queryFeaturesDehydrated",null),hS=(0,r._)([(0,u.$)("esri.views.3d.layers.support.featureTileQuery3D.FeatureTileServiceQuery3D")],hS);let uS=class extends s.A{constructor(e){super(e)}queryFeaturesDehydrated(e,t){return this.layer.queryFeatures(e,t)}queryFeatureCount(e,t){return this.layer.queryFeatureCount(e,t)}};(0,r._)([(0,d.MZ)({constructOnly:!0})],uS.prototype,"layer",void 0),(0,r._)([(0,d.MZ)({readOnly:!0})],uS.prototype,"queryFeaturesDehydrated",null),uS=(0,r._)([(0,u.$)("esri.views.3d.layers.support.featureTileQuery3D.FeatureTileServiceMeshQuery3D")],uS);let pS=class extends s.A{constructor(e){super(e)}queryFeaturesDehydrated(e,t){return this.layer.queryFeatures(e,t)}};(0,r._)([(0,d.MZ)({constructOnly:!0})],pS.prototype,"layer",void 0),pS=(0,r._)([(0,u.$)("esri.views.3d.layers.support.featureTileQuery3D.FeatureTileServiceQuery3D")],pS);let fS=class extends s.A{constructor(e){super(e)}queryFeaturesDehydrated(e,t){return this.source.queryFeaturesJSON(e,t).then(ji.JS,(i=>{if(i&&"query-features-json:unsupported"===i.name)return this.layer.queryFeatures(e,t);throw i}))}queryFeatureCount(e,t){return this.layer.queryFeatureCount(e,t)}};(0,r._)([(0,d.MZ)({constructOnly:!0})],fS.prototype,"layer",void 0),(0,r._)([(0,d.MZ)({constructOnly:!0})],fS.prototype,"source",void 0),fS=(0,r._)([(0,u.$)("esri.views.3d.layers.support.featureTileQuery3D.FeatureTileClientQuery3D")],fS);const gS=1024;class mS{constructor(e){this._memoryCache=null,this._capabilities=null;const t=e.layerView.layer;this._layerView=e.layerView,this.objectIdField=t.objectIdField,this.globalIdField="globalIdField"in t?t.globalIdField:null,this._returnZ=e.returnZ,this._returnM=e.returnM;const i=this._layerView.view.resourceController;this.query=function(e,t){const{layer:i}=e;return"feature"===i.type&&"feature-layer"===i.source.type?null!=i.infoFor3D?new uS({layer:i}):new hS({layer:i,layerView:e,controller:t}):"feature"===i.type&&"memory"===i.source.type||"csv"===i.type||"geojson"===i.type||"oriented-imagery"===i.type||"wfs"===i.type?new fS({layer:i,source:i.source}):"ogc-feature"===i.type?new pS({layer:i}):null}(this._layerView,i.normal),i&&this._memoryCacheEnabled&&(this._memoryCache=i.memoryController.newCache("fl-".concat(t.uid)))}get _memoryCacheEnabled(){switch(this._layerView.layer.source.type){case"feature-layer":case"ogc-feature":case"oriented-imagery":return!0;case"csv":case"geojson":case"memory":case"wfs":return!1}}destroy(){this._memoryCache=(0,le.pR)(this._memoryCache),this.query.destroy()}createQuery(){const e=this._layerView.layer.createQuery();return e.outFields=this._layerView.availableFields,e.returnZ=this._returnZ,e.returnM=this._returnM,e.outSpatialReference=this.tilingScheme.spatialReference,e}get memoryCache(){return this._memoryCache}get viewingMode(){return this._layerView.view.state.viewingMode}get tilingScheme(){return this._layerView.view.featureTiles.tilingScheme}get scheduler(){const e=this._layerView.view.resourceController;return e?e.scheduler:null}get geometryType(){return this._layerView.layer.geometryType}get fullExtent(){return this._layerView.layer.fullExtent}get tileMaxRecordCount(){return this._layerView.layer.capabilities.query.tileMaxRecordCount}get maxRecordCount(){return this._layerView.layer.capabilities.query.maxRecordCount}get capabilities(){return null!=this._capabilities||(this._capabilities=function(e){const t=e.capabilities.query;return{supportsMultipleResolutions:wb(e),supportsPagination:!(!t||!t.supportsPagination),supportsResultType:!(!t||!t.supportsResultType),supportsCacheHint:!(!t||!t.supportsCacheHint),supportsQuantization:!(!t||!t.supportsQuantization),supportsQuantizationEditMode:!(!t||!t.supportsQuantizationEditMode),supportsMaxRecordCountFactor:!(!t||!t.supportsMaxRecordCountFactor),supportsFormatPBF:!(!t||!t.supportsFormatPBF)}}(this._layerView.layer)),this._capabilities}logFetchError(e,t){var i;e.error("#fetchTile()",this._layerView.layer,null!==(i=null===t||void 0===t?void 0:t.message)&&void 0!==i?i:t)}}var _S=i(44892);class vS extends Cn.A{constructor(){super(...arguments),this._set=new Set,this._length=(0,fb.v)(0)}clear(){if(this._set.size>0){const e=this.toArray();this._set.clear(),this.emit("after-changes",{type:_S.R.REMOVE}),this.emit("change",{added:[],removed:e})}}get length(){return this._length.value}addMany(e){if(0!==e.length){for(const t of e)this._set.add(t);this._length.value=this._set.size,this.emit("after-changes",{type:_S.R.ADD}),this.emit("change",{added:e,removed:[]})}}remove(e){this._set.delete(e)&&(this._length.value=this._set.size,this.emit("after-changes",{type:_S.R.REMOVE}),this.emit("change",{added:[],removed:[e]}))}removeMany(e){const t=[];for(const i of e)this._set.delete(i)&&t.push(i);t.length>0&&(this._length.value=this._set.size,this.emit("after-changes",{type:_S.R.REMOVE}),this.emit("change",{added:[],removed:t}))}toArray(){return[...this._set]}find(e){let t;return(0,Ua.bw)(this._set,(i=>!!e(i)&&(t=i,!0))),t}forEach(e){this._set.forEach((t=>e(t)))}}const yS={readOnly:!0,value:.5,get(){return this.updating?this.updatingProgressValue:1}};var bS=i(51364),xS=i(91196),SS=i(771);let wS=class extends((0,SS.A)(rS((0,bS.A)(aS(xS.A))))){constructor(e){super(e),this._controllerTotal=0,this._processorTotal=0,this._needsRefresh=!1,this.suspendResumeExtentMode="data"}initialize(){this.addHandles([(0,l.wB)((()=>this._updatingRequiredFieldsPromise),(e=>this._updatingHandles.addPromise(e)),l.pc),(0,l.wB)((()=>({controller:this.controller,suspended:this.suspended})),(e=>{let{controller:t,suspended:i}=e;t&&!i&&this._needsRefresh&&(t.refetch(),this._needsRefresh=!1)}))])}destroy(){this._updatingHandles.removeAll(),this._fetcherContext=(0,le.pR)(this._fetcherContext)}get maximumNumberOfFeatures(){var e,t;return null!==(e=null===(t=this.controller)||void 0===t?void 0:t.maximumNumberOfFeatures)&&void 0!==e?e:this._get("maximumNumberOfFeatures")}set maximumNumberOfFeatures(e){this._set("maximumNumberOfFeatures",e),this.controller&&(this.controller.maximumNumberOfFeatures=e)}get maximumNumberOfFeaturesExceeded(){return!!this.controller&&!(this.suspended||!this.controller.maximumNumberOfFeaturesExceeded)}get updatingProgressValue(){var e,t;let i=0;if(null!==(e=this.controller)&&void 0!==e&&e.updating){const e=this.controller.updatingRemaining,t=Math.max(this.controller.updatingTotal,this._controllerTotal);t>0&&(i=(t-e)/t,this._controllerTotal=t)}let r=0;if(null!==(t=this.processor)&&void 0!==t&&t.updating){const e=this.processor.updatingRemaining,t=Math.max(e,this._processorTotal);t>0&&(r=(t-e)/t,this._processorTotal=t)}return.5*(i+r)}get updatePolicy(){if(!this.controller)return Ao.ASYNC;switch(this.controller.mode){case"snapshot":{const e=CS.get(this.layer.geometryType);return null==e||this.controller.serviceDataCount>e?Ao.ASYNC:Ao.SYNC}case"tiles":return Ao.ASYNC}}get hasZ(){const e=this.layer,t=e.capabilities&&e.capabilities.data;return!(!t||!t.supportsZ)&&("returnZ"in e&&null!=e.returnZ?e.returnZ:t.supportsZ)}get hasM(){const e=this.layer,t=e.capabilities&&e.capabilities.data;return!(!t||!t.supportsM)&&"returnM"in e&&null!=e.returnM&&e.returnM}setVisibility(e,t){var i;null===(i=this.processor)||void 0===i||i.setObjectIdVisibility(e,t)}createQuery(){return super.createQuery()}queryFeatures(e,t){const i=()=>super.queryFeatures(e,t);return"mesh"===this.layer.geometryType?this._queryFeaturesMesh(this._ensureQuery(e),i):i()}beforeSetController(e){e.maximumNumberOfFeatures=this.maximumNumberOfFeatures}createController(){this._fetcherContext=new mS({layerView:this,returnZ:this.hasZ,returnM:this.hasM});const e=new Hb({layerView:this,context:this._fetcherContext,graphics:new vS,extent:this.clippingExtent});return this._updatingHandles.add((()=>e.serviceDataExtent),(e=>{this.processor&&(this.processor.dataExtent=e)}),l.Vh),this.addHandles((0,l.wB)((()=>this.suspended),(t=>{t?e.suspend():e.resume()}),l.pc)),this._updatingHandles.add((()=>{var e;return null===(e=this.processor)||void 0===e?void 0:e.displayFeatureLimit}),(t=>e.displayFeatureLimit=t),l.Vh),this.addHandles((0,l.z7)((()=>!this.updating),(()=>{this._controllerTotal=0,this._processorTotal=0}))),e}async doRefresh(e){const{controller:t,processor:i,suspended:r}=this;e&&t&&(r?this._needsRefresh=!0:(t.refetch(),this._needsRefresh=!1)),i.refreshFilter()}_popupFeatureHasRequiredFields(e,t){if(!super._popupFeatureHasRequiredFields(e,t))return!1;const i=(0,ji.RW)(e,this.layer.objectIdField);if(null==i)return!0;const r=this.controller.getMissingAttributesForFeature(i);if(null==r)return!0;for(const n of t)if(r.has(n))return!1;return!0}get usedMemory(){var e,t,i,r;return(null!==(e=null===(t=this.processor)||void 0===t?void 0:t.usedMemory)&&void 0!==e?e:0)+(null!==(i=null===(r=this.controller)||void 0===r?void 0:r.memoryForUnusedFeatures)&&void 0!==i?i:0)}get unloadedMemory(){var e,t,i,r,n,s,a,o;const l=null!==(e=null===(t=this.processor)||void 0===t?void 0:t.unprocessedMemoryEstimate)&&void 0!==e?e:0,c=null!==(i=null===(r=this.controller)||void 0===r?void 0:r.expectedFeatureDiff)&&void 0!==i?i:0,d=null!==(n=null===(s=this.processor)||void 0===s?void 0:s.loadedFeatures)&&void 0!==n?n:0,h=d+c>0?d/(d+c):1;return l+c*(null!==(a=null===(o=this.processor)||void 0===o?void 0:o.usedMemoryPerFeature)&&void 0!==a?a:0)*h}get ignoresMemoryFactor(){var e;return null===(e=this.controller)||void 0===e?void 0:e.hasMaximumNumberOfFeaturesOverride}async _queryFeaturesMesh(e,t){await this._validateQueryFeaturesMesh(e);const i=await t();if(null!==e&&void 0!==e&&e.outStatistics||null==this.graphics3DProcessor)return i;const r=this.layer.objectIdField,n=this.graphics3DProcessor.graphics3DGraphicsByObjectID,s=[];for(const a of i.features)if(a.geometry){const e=n.get(a.attributes[r]);e&&(a.geometry=Jt(e.graphic.geometry),s.push(a))}else s.push(a);return i.features=s,i}async _validateQueryFeaturesMesh(e){if(!e)return;const t=e=>{throw new oe.A("feature-layer-view:unsupported-query","Queries on Mesh feature collection layers do not support '".concat(e,"'"))},i=["quantizationParameters","geometryPrecision","maxAllowableOffset"];for(const r of i)null!=e[r]&&t(r);"returnM"in e&&e.returnM&&t("returnM"),"returnCentroid"in e&&e.returnCentroid&&t("returnCentroid"),null==e.outSpatialReference||e.outSpatialReference.equals(this.view.spatialReference)||t("outSpatialReference")}get performanceInfo(){var e,t,i,r,n,s,a;const o=null===(e=this.controller)||void 0===e?void 0:e.displayFeatureLimit,l=null!=o?o.averageSymbolComplexity:void 0,c=null!=l?"f:".concat(l.verticesPerFeature,",v:").concat(l.verticesPerCoordinate):"n/a";return new qb(super.performanceInfo,null!==(t=null===(i=this.controller)||void 0===i||null===(i=i.performanceInfo)||void 0===i?void 0:i.storedFeatures)&&void 0!==t?t:0,null!==(r=null===(n=this.controller)||void 0===n||null===(n=n.performanceInfo)||void 0===n?void 0:n.totalVertices)&&void 0!==r?r:0,this.maximumNumberOfFeaturesExceeded,null!==(s=null===(a=this.controller)||void 0===a?void 0:a.mode)&&void 0!==s?s:"n/a",c)}get test(){var e;return{updatePolicy:this.updatePolicy,controller:this.controller,loadedGraphics:null===(e=this.controller)||void 0===e?void 0:e.graphics,...this.getTest()}}};(0,r._)([(0,d.MZ)()],wS.prototype,"layer",void 0),(0,r._)([(0,d.MZ)()],wS.prototype,"controller",void 0),(0,r._)([(0,d.MZ)()],wS.prototype,"_controllerTotal",void 0),(0,r._)([(0,d.MZ)()],wS.prototype,"_processorTotal",void 0),(0,r._)([(0,d.MZ)()],wS.prototype,"_needsRefresh",void 0),(0,r._)([(0,d.MZ)()],wS.prototype,"maximumNumberOfFeatures",null),(0,r._)([(0,d.MZ)()],wS.prototype,"maximumNumberOfFeaturesExceeded",null),(0,r._)([(0,d.MZ)(yS)],wS.prototype,"updatingProgress",void 0),(0,r._)([(0,d.MZ)({readOnly:!0})],wS.prototype,"updatingProgressValue",null),(0,r._)([(0,d.MZ)({readOnly:!0})],wS.prototype,"updatePolicy",null),(0,r._)([(0,d.MZ)({readOnly:!0})],wS.prototype,"hasZ",null),(0,r._)([(0,d.MZ)({readOnly:!0})],wS.prototype,"hasM",null),(0,r._)([(0,d.MZ)()],wS.prototype,"suspendResumeExtentMode",void 0),wS=(0,r._)([(0,u.$)("esri.views.3d.layers.FeatureLayerViewBase3D")],wS);const CS=new Map([["point",5e3],["polygon",500],["polyline",1e3]]),AS=wS;let RS=class extends AS{constructor(){super(...arguments),this.type="feature-3d",this.direct3DObjectFeatureLayerDisplayEnabled=(0,Pe.Qf)()}initialize(){var e;const{layer:t,view:i}=this;null!==(e=(0,tb.BR)(t))&&void 0!==e&&e.operations.supportsQuery||this.addResolvingPromise(Promise.reject(new oe.A("featurelayerview:query-not-supported","layer view requires a layer with query capability",{layer:t}))),null!=t.infoFor3D&&(this.direct3DObjectFeatureLayerDisplayEnabled?this._set("suspendResumeExtentMode","computed"):this.addResolvingPromise(Promise.reject(new oe.A("featurelayerview3d:unsupported-geometry-type","Unsupported geometry type ".concat(t.geometryType))))),"mesh"!==t.geometryType||(0,zi.canProjectWithoutEngine)(t.spatialReference,i.spatialReference)||this.addResolvingPromise(Promise.reject(new oe.A("layerview:spatial-reference-incompatible","The spatial references of the feature layer is incompatible with the spatial reference of the view")))}get featureSpatialReference(){var e;return null===(e=this.view.featureTiles)||void 0===e||null===(e=e.tilingScheme)||void 0===e?void 0:e.spatialReference}};(0,r._)([(0,d.MZ)({constructOnly:!0})],RS.prototype,"direct3DObjectFeatureLayerDisplayEnabled",void 0),(0,r._)([(0,d.MZ)()],RS.prototype,"layer",void 0),RS=(0,r._)([(0,u.$)("esri.views.3d.layers.FeatureLayerView3D")],RS);const ES=RS,OS="esri.views.3d.layers.i3s.I3SOverrides";let TS=class extends s.A{constructor(e){super(e),this._warnMaximumChangedObjectsExceeded=!1,this._maximumNumberOfEditOVerrides=IS,this._original3DOFLDefinitionExpression=null,this._interactiveEditingSessions=new S.A,this.geometryOverrides=new S.A,this._clientGeometryCache=new Map,this._associatedLayerView=null,this._attributeChangedObjectIds=new Xy.A,this._geometryChangedObjectIds=new Xy.A,this._pendingFetchChangedObjectIds=null,this._pendingFetchAbortController=new AbortController,this._featureIdLocks=new Map}initialize(){var e;this._memCache=this.memoryController.newCache("i3s-attribute-overrides-".concat(this.layer.uid)),this._pendingFetchChangedObjectIds=this._fetchChangedObjectIds(null===(e=this._pendingFetchAbortController)||void 0===e?void 0:e.signal),this._pendingFetchChangedObjectIds.finally((()=>{this._pendingFetchAbortController=null,this._pendingFetchChangedObjectIds=null})),this.is3DOFL&&null!=this._associatedLayer&&((0,Pe.Qf)()?this._associatedLayer.load().then((e=>{this.destroyed||(this._original3DOFLDefinitionExpression=e.definitionExpression,this.addHandles((0,l.wB)((()=>this._definitionExpression),(t=>e.definitionExpression=t),l.Vh)),this._associatedLayerView=new ES({layer:this._associatedLayer,view:this.view}))})):(0,Pe.lC)())}destroy(){this.is3DOFL&&null!=this._associatedLayer&&((0,Pe.Qf)()?null!=this._associatedLayerView&&(this._associatedLayer.definitionExpression=this._original3DOFLDefinitionExpression):(0,Pe.lC)()),this._set("layer",null),this._memCache=(0,le.pR)(this._memCache),this._pendingFetchAbortController=(0,le.DC)(this._pendingFetchAbortController),this._pendingFetchChangedObjectIds=null,this._featureIdLocks.clear()}get is3DOFL(){var e;return(0,Pe.Vo)()&&null!=(null===(e=this._associatedLayer)||void 0===e?void 0:e.infoFor3D)}get sortedGeometryChangedObjectIds(){return this.is3DOFL?[...this._geometryChangedObjectIds].sort(((e,t)=>e-t)):[]}get _associatedLayer(){return null==this.layer?null:this.layer.associatedLayer}get hasGeometryChanges(){return this._geometryChangedObjectIds.size>0}get _definitionExpression(){const e=this.sortedGeometryChangedObjectIds;return 0===e.length?"1 = 0":"OBJECTID IN (".concat(e.join(","),")")}get updating(){return!!this.is3DOFL&&(!!this._pendingFetchChangedObjectIds||!!(0,Pe.Qf)()&&(!(null!=this._associatedLayerView)||null!=this._associatedLayerView&&this._associatedLayerView.updating))}get isEmpty(){return null==this._pendingFetchChangedObjectIds&&0===this._attributeChangedObjectIds.size&&0===this._geometryChangedObjectIds.size}featureHasGeometryChanges(e){return this._geometryChangedObjectIds.has(e)}featureHasAttributeChanges(e){return this._attributeChangedObjectIds.has(e)}createInteractiveEditSession(e){this._attributeChangedObjectIds.add(e);const t=this._interactiveEditingSessions,i=new PS(e,(()=>{t.remove(i)}));return t.unshift(i),i}async applyAttributeOverrides(e,t,i){let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[];if(this._pendingFetchChangedObjectIds&&await(0,o.qr)(this._pendingFetchChangedObjectIds,i),null==t)return;const{attributeData:n,loadedAttributes:s}=t;if(null==s||null==n||0===this._attributeChangedObjectIds.size)return;const a=new Set;for(const o of s)a.add(o.index);for(const o of r)a.has(o.index)||(s.push(o),n[o.name]=new Array(e.length));const l=await this._lockFeatureIds(e);try{const t={attributeData:n,loadedAttributes:s},r=this._getOverridesFromCache(e,t,this._attributeChangedObjectIds),{objectIds:a,fieldNames:o}=r;if(0===a.length||0===o.length)return;const l=await this._queryAttributeOverridesFromAssociatedLayer(a,o,i);if(null==l)return;this._processOverridesFromAssociatedLayer(e,l,o,t)}finally{l.remove()}}updateGeometry(e,t){this._geometryChangedObjectIds.add(e);const i=this._clientGeometryCache.get(e);if(null!=i&&(this.geometryOverrides.remove(i),this._clientGeometryCache.delete(e)),null!=t){const i={oid:e,mesh:t};this.geometryOverrides.add(i),this._clientGeometryCache.set(e,i)}}updateAttributeValue(e,t,i){this._attributeChangedObjectIds.add(e),this._cacheAttributeValue(e,t,i)}featureAdded(e){this.is3DOFL&&(0,Pe.lC)()&&this._geometryChangedObjectIds.add(e),this._attributeChangedObjectIds.add(e)}_cacheAttributeValue(e,t,i){this._memCache.put(this._getAttributeCacheKey(e,t),i,this._memCacheAttributeValueSize(i))}_getOverridesFromCache(e,t,i){let{loadedAttributes:r,attributeData:n}=t;const s=new Set,a=new Array;for(const l of r)a[l.index]=n[l.name];const o=new Set;for(let l=0;l<e.length;l++){const t=e[l];if(i.has(t))for(const e of r){const i=this._attributeFromCache(t,e.index);void 0===i?(s.add(t),o.add(e.name)):a[e.index][l]=i}}return{objectIds:Array.from(s),fieldNames:Array.from(o)}}_attributeFromCache(e,t){const i=this._fromInteractiveEditingSession(e,t);if(void 0!==i)return i;const r=this._getAttributeCacheKey(e,t);return this._memCache.get(r)}_fromInteractiveEditingSession(e,t){if(null!=this._interactiveEditingSessions)for(const i of this._interactiveEditingSessions){if(i.objectId!==e)continue;const r=i.getAttribute(t);if(void 0!==r)return r}}_getAttributeCacheKey(e,t){return"".concat(e,"-").concat(t)}async _queryAttributeOverridesFromAssociatedLayer(e,t,i){if(0===e.length)return null;this._logWarningIfMaximumObjectsExceeded();const{associatedLayer:r}=this.layer;if(null==r)return null;const n=r.createQuery(),{objectIdField:s}=r,a=[s,...t];n.where="1=1",n.returnGeometry=!1,n.outFields=a,n.cacheHint=!0;const o=await this._executeBatchQuery(r,e,n,i),l=[];for(const c of o)if(c.ok)for(const e of c.value.features)l.push(e);return l}async _queryGeometryOverridesFromAssociatedLayer(e,t){if(0===e.length||!this.is3DOFL||!(0,Pe.lC)())return null;const i=this.layer.associatedLayer,r=i.infoFor3D,{spatialReference:n}=i,{state:{viewingMode:s},spatialReference:o}=this.view,l=s===ae.RT.Global,c=n.isGeographic;if(l&&!c)return a.A.getLogger(OS).warn("unsupported-pcs-edits-in-global-view",this.layer.title,LS(n,o,this.view.viewingMode,DS.Mode)),null;if(!l&&c)return a.A.getLogger(OS).warn("unsupported-gcs-edits-in-local-view",this.layer.title,LS(n,o,this.view.viewingMode,DS.Mode)),null;if(!((0,G.aI)(n,o)||l&&o.isWebMercator&&n.isWGS84))return a.A.getLogger(OS).warn("unsupported-mismatched-spatial-reference-edits",this.layer.title,LS(n,o,this.view.viewingMode,DS.SpatialReference)),null;this._logWarningIfMaximumObjectsExceeded();const{objectIdField:d,globalIdField:h}=i,u=[d,...null!=h?[h]:[]],p=i.createQuery();p.where="1=1",p.returnGeometry=!0,p.outFields=u,p.cacheHint=!0,p.returnZ=i.hasZ,p.returnM=i.hasM;const f=await this._executeBatchQuery(i,e,p,t),g=[];for(const a of f){if(!a.ok)continue;const e=a.value,{assetMaps:t,features:i,globalIdFieldName:s}=e;if(null==t)continue;const o=(0,eb.assetMapFromAssetMapsJSON)(r,t);for(const a of i){const e=(0,eb.extractMesh)(a,s,n,r,o),t=a;null!=e?(t.geometry=e,g.push(t)):t.geometry=null}}return g}_logWarningIfMaximumObjectsExceeded(){if(!this._warnMaximumChangedObjectsExceeded)return;this._warnMaximumChangedObjectsExceeded=!1;let e="The number of edited objects that are not yet cached in the scene service exceeds the maximum limit. Attribute changes will only be available for the first ".concat((0,$y.ZV)(this._maximumNumberOfEditOVerrides)," objects. Please consider re-caching the scene service");const t=this.layer.portalItem;t&&t.loaded?e+=" (".concat(t.portal.url,"/home/item.html?id=").concat(t.id,"#settings)"):e+=" (".concat(this.layer.parsedUrl.path,")"),a.A.getLogger(OS).warn("#queryOverrides()",this.layer.title,"".concat(e,"."))}async _executeBatchQuery(e,t,i,r){if(0===t.length)return[];const n=(0,Ky.qM)(e);t=[...t].sort(((e,t)=>e-t));const s=(0,b.Ho)(t,n).map((t=>{const n=i.clone();return n.objectIds=t,(0,ot.DZ)((0,Ky.SE)(e,n,{signal:r}))}));return Promise.all(s)}_processOverridesFromAssociatedLayer(e,t,i,r){let{loadedAttributes:n,attributeData:s}=r;const a=this._associatedLayer;if(null==a)return;const o=a.objectIdField,l=i.map((t=>(t in s||(s[t]=new Array(e.length)),s[t]))),c=new Map(n.map((e=>[e.name,e.index]))),d=i.map((e=>c.get(e))),h=new Map(Array.from(e,((e,t)=>[e,t])));for(const u of t){const e=u.attributes[o];for(let t=0;t<i.length;t++){const r=d[t],n=h.get(e),s=u.attributes[i[t]];l[t][n]=s,this._cacheAttributeValue(e,r,s)}}}_memCacheAttributeValueSize(e){return"string"==typeof e?(0,ba.xU)(e):(0,ba.f3)()}async _fetchChangedObjectIds(e){var t,i;const r=this.layer;await r.load({signal:e}),this._geometryChangedObjectIds.clear(),this._attributeChangedObjectIds.clear();const{associatedLayer:s}=r;if(null==s||null===(t=s.capabilities)||void 0===t||null===(t=t.operations)||void 0===t||!t.supportsChangeTracking)return;const o=this._getFetchChangedObjectIdsServerGen();if(null==o)return;const l=s.layerId,c=this.is3DOFL,d={f:"json",returnIdsOnly:!0,layers:"[".concat(l,"]"),returnUpdates:!0,returnDeletes:c,returnInserts:c,layerServerGens:JSON.stringify([{id:l,serverGen:o}])};if(c){const e=s.infoFor3D;d.fieldsToCompare=JSON.stringify({fields:[...Object.values(e.transformFieldRoles),e.sourceHashField]})}const h=await(0,ot.Ke)((0,n.A)("".concat(s.url,"/extractChanges"),{method:"post",query:d,timeout:MS,signal:e}));if(!h.ok&&(0,ue.c8)(h.error)){const e=this.layer.title;a.A.getLogger(OS).warn("extractChanges:timeout",e,"".concat(e," could not obtain edited features that are not cached in the scene service. Display of features may not be up to date with the latest edits. Consider re-caching the scene service."))}if(h.ok&&1===(null===(i=h.value.data)||void 0===i||null===(i=i.edits)||void 0===i?void 0:i.length)){var u,p,f;const t=h.value.data.edits[0],i=null===t||void 0===t?void 0:t.objectIds,r=null===t||void 0===t?void 0:t.fieldUpdates,n=null!==(u=null===i||void 0===i?void 0:i.adds)&&void 0!==u?u:[],a=null!==(p=null===i||void 0===i?void 0:i.updates)&&void 0!==p?p:[],o=null!==(f=null===i||void 0===i?void 0:i.deletes)&&void 0!==f?f:[],l=[...n,...a,...o],d=c?[...n,...null!==r&&void 0!==r?r:a,...o]:[],g=Math.min(this._maximumNumberOfEditOVerrides,l.length);g<l.length&&(this._warnMaximumChangedObjectsExceeded=!0);const m=l.sort(((e,t)=>e-t));for(let e=0;e<g;++e){const t=m[e];this._attributeChangedObjectIds.add(t)}for(const e of d)this._geometryChangedObjectIds.add(e);if(this.is3DOFL&&(0,Pe.lC)()&&this._geometryChangedObjectIds.size>0){const t=await this._queryGeometryOverridesFromAssociatedLayer(Array.from(this._geometryChangedObjectIds),e);if(null!=t)for(const e of t)null!=e.geometry&&this.updateGeometry(e.attributes[s.objectIdField],e.geometry)}}}_getFetchChangedObjectIdsServerGen(){var e,t;const i=this.layer;if(null!=(null===(e=i.serviceUpdateTimeStamp)||void 0===e?void 0:e.lastUpdate))return i.serviceUpdateTimeStamp.lastUpdate;const r=i.associatedLayer;return null!=(null===r||void 0===r||null===(t=r.serverGens)||void 0===t?void 0:t.minServerGen)?r.serverGens.minServerGen:null}async _lockFeatureIds(e){const t=this._featureIdLocks;let i=!0;for(;i;){const r=new Array;for(const i of e){const e=t.get(i);e&&r.push(e)}0===r.length?i=!1:await Promise.all(r)}const r=(0,o.Tw)(),n=r.promise;for(const s of e)t.set(s,n);return(0,w.hA)((()=>{for(const i of e)t.delete(i);r.resolve()}))}get test(){const e=Array.from(this._attributeChangedObjectIds),t=this._pendingFetchChangedObjectIds,i=this;return{changedObjectIds:e,pendingFetchChangedObjectIds:t,get maximumNumberOfEditOVerrides(){return i._maximumNumberOfEditOVerrides},set maximumNumberOfEditOVerrides(e){i._maximumNumberOfEditOVerrides=e}}}};(0,r._)([(0,d.MZ)({constructOnly:!0})],TS.prototype,"view",void 0),(0,r._)([(0,d.MZ)({constructOnly:!0})],TS.prototype,"layer",void 0),(0,r._)([(0,d.MZ)({readOnly:!0})],TS.prototype,"is3DOFL",null),(0,r._)([(0,d.MZ)()],TS.prototype,"_interactiveEditingSessions",void 0),(0,r._)([(0,d.MZ)({readOnly:!0})],TS.prototype,"sortedGeometryChangedObjectIds",null),(0,r._)([(0,d.MZ)({readOnly:!0})],TS.prototype,"geometryOverrides",void 0),(0,r._)([(0,d.MZ)()],TS.prototype,"_clientGeometryCache",void 0),(0,r._)([(0,d.MZ)()],TS.prototype,"_associatedLayer",null),(0,r._)([(0,d.MZ)()],TS.prototype,"_associatedLayerView",void 0),(0,r._)([(0,d.MZ)({constructOnly:!0})],TS.prototype,"memoryController",void 0),(0,r._)([(0,d.MZ)()],TS.prototype,"_attributeChangedObjectIds",void 0),(0,r._)([(0,d.MZ)()],TS.prototype,"_geometryChangedObjectIds",void 0),(0,r._)([(0,d.MZ)()],TS.prototype,"hasGeometryChanges",null),(0,r._)([(0,d.MZ)()],TS.prototype,"_pendingFetchChangedObjectIds",void 0),(0,r._)([(0,d.MZ)()],TS.prototype,"_pendingFetchAbortController",void 0),(0,r._)([(0,d.MZ)()],TS.prototype,"_definitionExpression",null),(0,r._)([(0,d.MZ)()],TS.prototype,"updating",null),(0,r._)([(0,d.MZ)()],TS.prototype,"isEmpty",null),TS=(0,r._)([(0,u.$)(OS)],TS);class PS{constructor(e,t){this.objectId=e,this._remove=t,this._updates=new Map,this._isActive=!0}getAttribute(e){return this._updates.get(e)}setAttribute(e,t){this.isActive&&this._updates.set(e,t)}remove(){this.isActive&&(this._isActive=!1,this._remove())}get isActive(){return this._isActive}}const MS=1e4,IS=5e4;var DS;function LS(e,t,i,r){return"Displaying the edits of a SceneLayer with a".concat(r===DS.Mode?e.isGeographic?" geographic ":" projected ":" ","spatial reference (wkid:").concat(e.wkid,") in ").concat(i," viewing mode").concat(r===DS.SpatialReference?" with spatial reference (wkid:".concat(t.wkid,") "):" ","is not supported. No geometry edits will be displayed for this layer.\nPlease consider re-caching the scene service or changing the ").concat(r===DS.Mode?"viewing mode":"view spatial reference"," to display edits.")}!function(e){e[e.Mode=0]="Mode",e[e.SpatialReference=1]="SpatialReference"}(DS||(DS={}));i(11486);new WeakMap;let FS=class extends(Cn.A.EventedMixin(s.A)){constructor(e){super(e),this._tmpEvent=new Fv,this._renderCoordsHelper=e.view.renderCoordsHelper,this._renderSR=this._renderCoordsHelper.spatialReference,this._layerElevationSource=e.layerElevationSource}initialize(){this._intersector=Yc(this.view.state.viewingMode),this._intersector.options.store=nc.MIN,this._tmpEvent.context=this.intersectionHandler.isGround?"ground":"scene"}get spatialReference(){var e;return null===(e=this.view)||void 0===e||null===(e=e.elevationProvider)||void 0===e?void 0:e.spatialReference}getElevation(e,t,i,r){const n=this._renderCoordsHelper,s=(0,M.s)(GS,e,t,i);if(!n.toRenderCoords(s,r,s))return a.A.getLogger(this).error("could not project point to compute elevation"),null;const{layerElevationSource:o,_intersector:l,intersectionHandler:c}=this,d=o.fullExtent,h=null!=d&&Number.isFinite(d.xmin)&&Number.isFinite(d.xmax)&&Number.isFinite(d.ymin)&&Number.isFinite(d.ymax)&&Number.isFinite(d.zmin)&&Number.isFinite(d.zmax)?new Le.H(d.zmin,d.zmax):o.elevationRange;if(null==h)return null;const u=o.elevationOffset,p=h.elevationRangeMin+u,f=h.elevationRangeMax+u,g=n.setAltitude(US,f,s),m=n.setAltitude(zS,p,s);return l.reset(g,m,null),c.intersect(l,null,g,m,null,!0),l.results.min.getIntersectionPoint(s)?n.getAltitude(s):null}getSphereElevationBounds(e,t){return z(e,t,VS,this._renderSR),this._layerElevationSource.getElevationRange(VS)}getRootElevationBounds(){const e=this.layerElevationSource.fullExtent;return null!==e&&void 0!==e&&e.hasZ?new Le.H(e.zmin,e.zmax):null}objectsChanged(e){this.spatialReference&&(this._computeLayerExtent(e,this._tmpEvent.extent),this._tmpEvent.spatialReference=this.spatialReference,this.emit("elevation-change",this._tmpEvent))}objectChanged(e){this.spatialReference&&(this._computeObjectExtent(e,this._tmpEvent.extent),this._tmpEvent.spatialReference=this.spatialReference,this.emit("elevation-change",this._tmpEvent))}_computeObjectExtent(e,t){(0,Q.Ie)(t),this._expandExtent(e,t)}_computeLayerExtent(e,t){(0,Q.Ie)(t);for(const i of e)this._expandExtent(i,t)}_expandExtent(e,t){const i=this.spatialReference;if(null==i)return;if(null==e)return;(0,T.I0)(NS,e.quaternion),NS[12]=e.center[0],NS[13]=e.center[1],NS[14]=e.center[2];const r=e.halfSize;for(let n=0;n<8;++n)GS[0]=1&n?r[0]:-r[0],GS[1]=2&n?r[1]:-r[1],GS[2]=4&n?r[2]:-r[2],(0,M.e)(GS,GS,NS),this._renderCoordsHelper.fromRenderCoords(GS,GS,i),(0,Q.fT)(t,GS,t)}};(0,r._)([(0,d.MZ)({constructOnly:!0})],FS.prototype,"layerElevationSource",void 0),(0,r._)([(0,d.MZ)({constructOnly:!0})],FS.prototype,"intersectionHandler",void 0),(0,r._)([(0,d.MZ)({constructOnly:!0})],FS.prototype,"view",void 0),(0,r._)([(0,d.MZ)()],FS.prototype,"spatialReference",null),FS=(0,r._)([(0,u.$)("esri.views.3d.layers.i3s.LayerElevationProvider")],FS);const NS=(0,P.vt)(),VS=(0,$.f)(0,0,0,0),GS=(0,I.vt)(),US=(0,I.vt)(),zS=(0,I.vt)();i(97808);i(22728);var BS;!function(e){e[e.CastShadows=4]="CastShadows",e[e.Pickable=5]="Pickable"}(BS||(BS={}));x.u.MEGABYTES;var HS;!function(e){e[e.ADD=0]="ADD",e[e.REMOVE=1]="REMOVE",e[e.UPDATE=2]="UPDATE"}(HS||(HS={}));(0,q.vt)(),(0,Q.vt)(),(0,Q.vt)(),new Fe.ab,new v.A([0,0,0,0]),(0,$.f)(0,0,0,0);(0,I.vt)(),(0,q.vt)();function jS(e){return t=>{if(e.immediate)return e.immediate.schedule(t);throw console.error("Error no immediate schudler"),new Error("cant find immediate scheduler")}}new Le.H;var WS,kS;!function(e){e[e.Lifetime=0]="Lifetime",e[e.Jobs=1]="Jobs",e[e.Renderables=2]="Renderables"}(WS||(WS={})),function(e){e[e.Critical=0]="Critical",e[e.Error=1]="Error",e[e.Warning=2]="Warning",e[e.Info=3]="Info"}(kS||(kS={}));let ZS=class extends s.A{constructor(e){super(e),this._lyr3DMainPromise=null,this._lyr3DMain=null,this._layers=new Map,this._debugFlags=new Set,this._debugLevel=kS.Critical,this._pulseTaskHandle=null,this._session=null,this._debugFlags.add(WS.Lifetime),this._debugFlags.add(WS.Jobs),this._debugFlags.add(WS.Renderables)}_debugLog(e,t,i){let r=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];if(this._debugFlags.has(e)&&this._debugLevel>=t){const e=r?"[js] ".concat(i):"".concat(i);t===kS.Critical||t===kS.Error?a.A.getLogger(this).error(e):t===kS.Warning&&a.A.getLogger(this).warn(e),a.A.getLogger(this).info(e)}}initialize(){this._debugLevel>kS.Warning&&(a.A.getLogger(this).level="info"),this._debugLog(WS.Lifetime,kS.Info,"Lyr3DWasmPerSceneView.initialize()"),this.addHandles([(0,l.wB)((()=>{var e;return null===(e=this.view.state)||void 0===e?void 0:e.contentCamera}),(()=>this._updateWasmCamera()))]),this._pulseTaskHandle=(0,c.mg)({preRender:()=>this._pulseTask()})}destroy(){var e;this._debugLog(WS.Lifetime,kS.Info,"Lyr3DWasmPerSceneView.destroy()"),this._lyr3DMain&&(this._layers.forEach((e=>{e.abortController.abort()})),this._lyr3DMain.uninitialize_lyr3d_wasm(),this._lyr3DMain=null);const t=this._worker;t&&t.destroyWasm().then((()=>{var e;null!==(e=this._worker)&&void 0!==e&&e.destroy(),this._worker=null})),null!==(e=this._pulseTaskHandle)&&void 0!==e&&e.remove(),this._pulseTaskHandle=null}add3DTilesLayerView(e){return this._lyr3DMain?this._add3DTilesLayerView(e):(this._debugLog(WS.Lifetime,kS.Error,"Lyr3DWasmPerSceneView.add3DTilesLayerView() called when WASM wasn't initialized"),p.vE)}remove3DTilesLayerView(e){if(!this._lyr3DMain)return this._debugLog(WS.Lifetime,kS.Error,"Lyr3DWasmPerSceneView.remove3DTilesLayerView() called when WASM wasn't loaded!"),0;this._doRemoveLayerView(e);const t=this._layers.size;return 0===t&&(this._debugLog(WS.Lifetime,kS.Info,"Lyr3DWasmPerSceneView.remove3DTilesLayerView() no Lyr3D layers left after removing a layer, destroying"),this.destroy()),t}setEnabled(e,t){if(!this._lyr3DMain)return void this._debugLog(WS.Lifetime,kS.Error,"Lyr3DWasmPerSceneView.setEnabled() called when WASM wasn't loaded!");const i=this._layers.get(e.wasmLayerId);i&&(this._lyr3DMain.set_enabled(e.wasmLayerId,t),i.needMemoryUsageUpdate=!0)}setLayerOffset(e,t){this._lyr3DMain?this._layers.get(e.wasmLayerId)&&this._lyr3DMain.set_carto_offset_z(e.wasmLayerId,t):this._debugLog(WS.Lifetime,kS.Error,"Lyr3DWasmPerSceneView.setLayerOffset() called when WASM wasn't loaded!")}getAttributionText(){return this._lyr3DMain?this._lyr3DMain.get_current_attribution_text().split("|"):(this._debugLog(WS.Lifetime,kS.Error,"Lyr3DWasmPerSceneView.getAttributionText() called when WASM wasn't loaded!"),[])}onRenderableEvicted(e,t,i){this._lyr3DMain?this._layers.get(e.wasmLayerId)&&this._lyr3DMain.on_renderable_evicted(e.wasmLayerId,t,i):this._debugLog(WS.Lifetime,kS.Error,"Lyr3DWasmPerSceneView.onRenderableEvicted() called when WASM wasn't loaded!")}isUpdating(e){if(!this._lyr3DMain&&this._lyr3DMainPromise)return!0;const t=this._layers.get(e);return!!t&&(t.outstandingJobCount>0||t.outstandingRenderableCount>0)}initializeWasm(){return this._lyr3DMain?Promise.resolve():(this._debugLog(WS.Lifetime,kS.Info,"Lyr3DWasmPerSceneView.initializeWasm()"),this._lyr3DMainPromise||(this._lyr3DMainPromise=(0,m.a)().then((e=>{var t,i,r,n;this._lyr3DMain=e,this._lyr3DMainPromise=null;const s=this._lyr3DMain.addFunction(this._onNewJob.bind(this),"v"),a=this._lyr3DMain.addFunction(this._onNewRenderable.bind(this),"v"),o=this._lyr3DMain.addFunction(this._freeRenderables.bind(this),"viii"),l=this._lyr3DMain.addFunction(this._setRenderableVisibility.bind(this),"viiii"),c=this._lyr3DMain.addFunction(this._onWasmError.bind(this),"viiii"),d="global"===this.view.viewingMode,h=null!==(t=this.view.renderSpatialReference)&&void 0!==t&&t.isWebMercator?3857:null!==(i=null===(r=this.view.renderSpatialReference)||void 0===r?void 0:r.wkid)&&void 0!==i?i:-1,u=null===(n=this.view.heightModelInfo)||void 0===n?void 0:n.heightModel,p=!u||"gravity-related-height"===u;return this._lyr3DMain.initialize_lyr3d_wasm(c,s,a,o,l,d,p,h,this._debugLevel)?(this._worker=new g(jS(this.view.resourceController)),this._worker.promise?this._worker.promise:void 0):(this._lyr3DMain=null,void this._debugLog(WS.Lifetime,kS.Critical,"Lyr3d Main WASM failed to initialize",!1))})).catch((e=>{this._debugLog(WS.Lifetime,kS.Critical,"Lyr3d WASM failed to download error = ".concat(e),!1)}))),this._lyr3DMainPromise)}_pulseTask(){if(this._lyr3DMain){let e=0;this._layers.forEach((t=>{e+=t.layerView.usedMemory})),e/=1048576;const t=this.view.resourceController.memoryController,i=t.usedMemory*t.maxMemory-e,r=t.maxMemory-i+t.additionalCacheMemory;this._lyr3DMain.frame_pulse(r,e,i,t.maxMemory)}}_incrementJobCount(e){e.outstandingJobCount+=1,1===e.outstandingJobCount&&e.outstandingRenderableCount<1&&e.layerView.updatingFlagChanged()}_decrementJobCount(e){e.outstandingJobCount-=1,0===e.outstandingJobCount&&e.outstandingRenderableCount<1&&e.layerView.updatingFlagChanged()}_incrementRenderableCount(e){e.outstandingRenderableCount+=1,e.outstandingJobCount<1&&1===e.outstandingRenderableCount&&e.layerView.updatingFlagChanged()}_decrementRenderableCount(e){e.outstandingRenderableCount-=1,e.outstandingJobCount<1&&0===e.outstandingRenderableCount&&e.layerView.updatingFlagChanged()}_onJobFailed(e,t,i){t.error.length&&this._debugLog(WS.Jobs,kS.Error,t.error,!1),this._lyr3DMain&&this._lyr3DMain.on_job_failed(i.jobId,i.desc),this._decrementJobCount(e)}_onJobSucceeded(e,t,i){if(this._lyr3DMain){const e=t.data.byteLength,r=this._lyr3DMain._malloc(e);new Uint8Array(this._lyr3DMain.HEAPU8.buffer,r,e).set(t.data),this._lyr3DMain.on_job_completed(i.jobId,t.jobDescJson,r,e),this._lyr3DMain._free(r)}this._decrementJobCount(e)}_getRequestPromises(e,t){const i=[];for(const r of e){const e=new URL(r),s=e.searchParams.get("session");s?this._session=s:this._session&&e.searchParams.append("session",this._session),i.push((0,n.A)(e.toString(),t).then((e=>e.data)))}return i}_onNewJob(){const e=this._lyr3DMain.get_next_job(),t=this._layers.get(e.layerId);if(!t)return;this._incrementJobCount(t);const i=t.abortController.signal,r={responseType:"array-buffer",signal:i,query:{...t.customParameters,token:t.apiKey}},n={inputs:[],jobDescJson:e.desc,isMissingResourceCase:!1},s=this._getRequestPromises(e.urls,r);Promise.all(s).then((e=>(n.inputs=e,this._worker.invoke(n,i)))).then((e=>e)).catch((t=>((0,o.zf)(t)?this._debugLog(WS.Jobs,kS.Warning,"job ".concat(e.jobId," was cancelled.")):this._debugLog(WS.Jobs,kS.Error,"job ".concat(e.jobId," failed with error ").concat(t,".")),{status:p.Qg.Failed,error:"",jobDescJson:"",data:new Uint8Array(0),missingInputUrls:[],inputs:[]}))).then((s=>{if(s.status===p.Qg.Failed)this._onJobFailed(t,s,e);else if(s.status===p.Qg.Succeeded)this._onJobSucceeded(t,s,e);else if(s.status===p.Qg.MissingInputs){const a=this._getRequestPromises(s.missingInputUrls,r);Promise.all(a).then((e=>{n.jobDescJson=s.jobDescJson,s.originalInputs?n.inputs=s.originalInputs:n.inputs=[],n.isMissingResourceCase=!0;for(const t of e)n.inputs.push(t);return this._worker.invoke(n,i)})).then((i=>{i.status===p.Qg.Failed?this._onJobFailed(t,i,e):i.status===p.Qg.Succeeded&&this._onJobSucceeded(t,i,e)})).catch((i=>{this._decrementJobCount(t),(0,o.zf)(i)?this._debugLog(WS.Jobs,kS.Warning,"job ".concat(e.jobId," was cancelled.")):this._debugLog(WS.Jobs,kS.Error,"job ".concat(e.jobId," failed with error2 ").concat(i,".")),this._lyr3DMain&&this._lyr3DMain.on_job_failed(e.jobId,e.desc)}))}}))}_onNewRenderable(){const e=this._lyr3DMain.get_next_renderable(),t=e.meshData;if(t.data&&t.data.byteLength>0){const e=t.data.slice();t.data=e}const i=this._layers.get(e.layerId);i&&(this._incrementRenderableCount(i),i.layerView.createRenderable(e).then((t=>{this._lyr3DMain&&this._lyr3DMain.on_renderable_created(!0,e.layerId,e.handle,t.memUsageBytes),this._decrementRenderableCount(i)})).catch((t=>{(0,o.zf)(t)||this._debugLog(WS.Renderables,kS.Error,"createRenderable failed with error ".concat(t,".")),this._lyr3DMain&&this._lyr3DMain.on_renderable_created(!1,e.layerId,e.handle,0),this._decrementRenderableCount(i)})))}_freeRenderables(e,t,i){if(i<1)return;const r=this._layers.get(e);if(!r)return;const n=r.layerView,s=[],a=new Uint32Array(this._lyr3DMain.HEAPU32.buffer,t,i);for(let o=0;o<i;++o)s.push(a[o]);for(let o=0;o<i;++o)n.freeRenderable(s[o])}_setRenderableVisibility(e,t,i,r){if(r<1)return;const n=this._layers.get(e);if(!n)return;const s=n.layerView,a=[],o=[],l=new Uint32Array(this._lyr3DMain.HEAPU32.buffer,t,r),c=new Uint8Array(this._lyr3DMain.HEAPU8.buffer,i,r);for(let d=0;d<r;++d)a.push(l[d]),o.push(1===c[d]);s.setRenderableVisibility(a,o,r)}_onWasmError(e,t,i,r){this._lyr3DMain&&this._debugLog(i,r,this._lyr3DMain.UTF8ToString(e,t),!1)}_doRemoveLayerView(e){const t=this._layers.get(e.wasmLayerId);return!!t&&(t.abortController.abort(),this._lyr3DMain.remove_layer(e.wasmLayerId),this._layers.delete(e.wasmLayerId),!0)}_add3DTilesLayerView(e){var t,i,r,n;const s=e.layer;if(!s.url)return p.Pl;const a=this._lyr3DMain.get_next_layer_id(),o=new AbortController;this._layers.set(a,{layerView:e,abortController:o,needMemoryUsageUpdate:!1,outstandingJobCount:0,outstandingRenderableCount:0,customParameters:s.customParameters,apiKey:s.apiKey});const l=null!==(t=null===(i=s.elevationInfo)||void 0===i?void 0:i.offset)&&void 0!==t?t:0,c=null!==(r=s.elevationInfo)&&void 0!==r&&r.unit?(0,_.Ao)(null===(n=s.elevationInfo)||void 0===n?void 0:n.unit):1;return this._lyr3DMain.add_layer(s.url,a,l*c)?(this._updateWasmCamera(),a):(this._layers.delete(a),p.Pl)}_updateWasmCamera(){var e;const t=null===(e=this.view.state)||void 0===e?void 0:e.contentCamera;if(!t||!this._lyr3DMain)return;const{eye:i,center:r,up:n,near:s,far:a,fovY:o}=t,l=[t.viewport[2],t.viewport[3]],c=t.width/t.height;this._lyr3DMain.set_camera_parameters({eye:i,center:r,up:n,near:s,far:a,fov:o,aspectRatio:c,viewport:l})}};(0,r._)([(0,d.MZ)({constructOnly:!0})],ZS.prototype,"view",void 0),ZS=(0,r._)([(0,u.$)("esri.layers.Lyr3DWasmPerSceneView")],ZS);const qS=ZS},33328:(e,t,i)=>{i.d(t,{F:()=>l});var r=i(81806),n=i(70373),s=i(2413);const a={minX:0,minY:0,maxX:0,maxY:0};function o(e,t,i){(function(e){a.minX=e[0],a.minY=e[1],a.maxX=e[2],a.maxY=e[3]})(t),e.search(a,i)}class l{constructor(){this._indexInvalid=!1,this._boundsToLoad=[],this._boundsById=new Map,this._idByBounds=new Map,this._index=new n.w(9,(0,r.A)("esri-csp-restrictions")?e=>({minX:e[0],minY:e[1],maxX:e[2],maxY:e[3]}):["[0]","[1]","[2]","[3]"]),this._loadIndex=()=>{if(this._indexInvalid){const e=new Array(this._idByBounds.size);let t=0;this._idByBounds.forEach(((i,r)=>{e[t++]=r})),this._indexInvalid=!1,this._index.clear(),this._index.load(e)}else this._boundsToLoad.length&&(this._index.load(Array.from(new Set(this._boundsToLoad.filter((e=>this._idByBounds.has(e)))))),this._boundsToLoad.length=0)}}get fullBounds(){if(!this._boundsById.size)return null;const e=(0,s.Ie)();for(const t of this._boundsById.values())t&&(e[0]=Math.min(t[0],e[0]),e[1]=Math.min(t[1],e[1]),e[2]=Math.max(t[2],e[2]),e[3]=Math.max(t[3],e[3]));return e}get valid(){return!this._indexInvalid}clear(){this._indexInvalid=!1,this._boundsToLoad.length=0,this._boundsById.clear(),this._idByBounds.clear(),this._index.clear()}delete(e){const t=this._boundsById.get(e);this._boundsById.delete(e),t&&(this._idByBounds.delete(t),this._indexInvalid||this._index.remove(t))}forEachInBounds(e,t){this._loadIndex(),o(this._index,e,(e=>t(this._idByBounds.get(e))))}get(e){return this._boundsById.get(e)}has(e){return this._boundsById.has(e)}invalidateIndex(){this._indexInvalid||(this._indexInvalid=!0,this._boundsToLoad.length=0)}set(e,t){if(!this._indexInvalid){const t=this._boundsById.get(e);t&&(this._index.remove(t),this._idByBounds.delete(t))}this._boundsById.set(e,t),t&&(this._idByBounds.set(t,e),this._indexInvalid||(this._boundsToLoad.push(t),this._boundsToLoad.length>5e4&&this._loadIndex()))}}},72547:(e,t,i)=>{i.d(t,{A:()=>f});var r=i(18690),n=i(50076),s=i(54099),a=i(76460),o=i(42294),l=i(2413),c=i(98618),d=i(33328),h=i(55167),u=i(26724);const p=(0,o.vt)();class f{constructor(e){this.geometryInfo=e,this._boundsStore=new d.F,this._featuresById=new Map,this._markedIds=new Set,this.events=new s.A,this.featureAdapter=u.T}get geometryType(){return this.geometryInfo.geometryType}get hasM(){return this.geometryInfo.hasM}get hasZ(){return this.geometryInfo.hasZ}get numFeatures(){return this._featuresById.size}get fullBounds(){return this._boundsStore.fullBounds}get storeStatistics(){let e=0;return this._featuresById.forEach((t=>{null!=t.geometry&&t.geometry.coords&&(e+=t.geometry.coords.length)})),{featureCount:this._featuresById.size,vertexCount:e/(this.hasZ?this.hasM?4:3:this.hasM?3:2)}}getFullExtent(e){if(null==this.fullBounds)return null;const[t,i,r,n]=this.fullBounds;return{xmin:t,ymin:i,xmax:r,ymax:n,spatialReference:(0,h.ag)(e)}}add(e){this._add(e),this._emitChanged()}addMany(e){for(const t of e)this._add(t);this._emitChanged()}upsertMany(e){const t=e.map((e=>this._upsert(e)));return this._emitChanged(),t.filter(r.Ru)}clear(){this._featuresById.clear(),this._boundsStore.clear(),this._emitChanged()}removeById(e){const t=this._featuresById.get(e);return t?(this._remove(t),this._emitChanged(),t):null}removeManyById(e){this._boundsStore.invalidateIndex();for(const t of e){const e=this._featuresById.get(t);e&&this._remove(e)}this._emitChanged()}forEachBounds(e,t){for(const i of e){const e=this._boundsStore.get(i.objectId);e&&t((0,o.Jt)(p,e))}}getFeature(e){return this._featuresById.get(e)}has(e){return this._featuresById.has(e)}forEach(e){this._featuresById.forEach((t=>e(t)))}forEachInBounds(e,t){this._boundsStore.forEachInBounds(e,(e=>{t(this._featuresById.get(e))}))}startMarkingUsedFeatures(){this._boundsStore.invalidateIndex(),this._markedIds.clear()}sweep(){let e=!1;this._featuresById.forEach(((t,i)=>{this._markedIds.has(i)||(e=!0,this._remove(t))})),this._markedIds.clear(),e&&this._emitChanged()}_emitChanged(){this.events.emit("changed",void 0)}_add(e){var t;if(!e)return;const i=e.objectId;if(null==i)return void a.A.getLogger("esri.layers.graphics.data.FeatureStore").error(new n.A("featurestore:invalid-feature","feature id is missing",{feature:e}));const r=this._featuresById.get(i);let s;if(this._markedIds.add(i),r?(e.displayId=r.displayId,s=this._boundsStore.get(i),this._boundsStore.delete(i)):null!=this.onFeatureAdd&&this.onFeatureAdd(e),null===(t=e.geometry)||void 0===t||null===(t=t.coords)||void 0===t||!t.length)return this._boundsStore.set(i,null),void this._featuresById.set(i,e);s=(0,c.jQ)(null!=s?s:(0,l.vt)(),e.geometry,this.geometryInfo.hasZ,this.geometryInfo.hasM),null!=s&&this._boundsStore.set(i,s),this._featuresById.set(i,e)}_upsert(e){var t;const i=null===e||void 0===e?void 0:e.objectId;if(null==i)return a.A.getLogger("esri.layers.graphics.data.FeatureStore").error(new n.A("featurestore:invalid-feature","feature id is missing",{feature:e})),null;const r=this._featuresById.get(i);if(!r)return this._add(e),e;this._markedIds.add(i);const{geometry:s,attributes:o}=e;for(const n in o)r.attributes[n]=o[n];return s&&(r.geometry=s,this._boundsStore.set(i,null!==(t=(0,c.jQ)((0,l.vt)(),s,this.geometryInfo.hasZ,this.geometryInfo.hasM))&&void 0!==t?t:null)),r}_remove(e){null!=this.onFeatureRemove&&this.onFeatureRemove(e);const t=e.objectId;return this._markedIds.delete(t),this._boundsStore.delete(t),this._featuresById.delete(t),e}}},74e3:(e,t,i)=>{i.d(t,{aI:()=>o});i(81806),i(15941);var r=i(80963);function n(e,t){if(e===t)return!0;if(null==e||null==t)return!1;if(e.length!==t.length)return!1;for(let i=0;i<e.length;i++){const r=e[i],n=t[i];if(r.length!==n.length)return!1;for(let e=0;e<r.length;e++)if(r[e]!==n[e])return!1}return!0}function s(e,t){if(e===t)return!0;if(null==e||null==t)return!1;if(e.length!==t.length)return!1;for(let i=0;i<e.length;i++)if(!n(e[i],t[i]))return!1;return!0}function a(e,t){if(e===t)return!0;if(null==e||null==t)return!1;if(e.type!==t.type)return!1;switch(e.type){case"point":return function(e,t){return e===t||null!=e&&null!=t&&(0,r.aI)(e.spatialReference,t.spatialReference)&&e.x===t.x&&e.y===t.y&&e.z===t.z&&e.m===t.m}(e,t);case"extent":return function(e,t){return e.hasZ===t.hasZ&&e.hasM===t.hasM&&!!(0,r.aI)(e.spatialReference,t.spatialReference)&&e.xmin===t.xmin&&e.ymin===t.ymin&&e.zmin===t.zmin&&e.xmax===t.xmax&&e.ymax===t.ymax&&e.zmax===t.zmax}(e,t);case"polyline":return function(e,t){return e.hasZ===t.hasZ&&e.hasM===t.hasM&&!!(0,r.aI)(e.spatialReference,t.spatialReference)&&s(e.paths,t.paths)}(e,t);case"polygon":return function(e,t){return e.hasZ===t.hasZ&&e.hasM===t.hasM&&!!(0,r.aI)(e.spatialReference,t.spatialReference)&&s(e.rings,t.rings)}(e,t);case"multipoint":return function(e,t){return e.hasZ===t.hasZ&&e.hasM===t.hasM&&!!(0,r.aI)(e.spatialReference,t.spatialReference)&&n(e.points,t.points)}(e,t);case"mesh":return!1;default:return}}function o(e,t){return e===t||null!=e&&null!=t&&e.objectId===t.objectId&&!!a(e.geometry,t.geometry)&&!!function(e,t){if(e===t)return!0;if(!e||!t)return!1;const i=Object.keys(e),r=Object.keys(t);if(i.length!==r.length)return!1;for(const n of i)if(e[n]!==t[n])return!1;return!0}(e.attributes,t.attributes)}},99784:(e,t,i)=>{i.d(t,{Ek:()=>_,HP:()=>u,JS:()=>g,Kq:()=>v,N3:()=>p,RW:()=>S,Uz:()=>w,ao:()=>y,iQ:()=>x,jy:()=>f,w9:()=>b});var r=i(21499),n=(i(81806),i(78393)),s=i(90632),a=i(13312),o=i(42294),l=i(2413),c=i(76279),d=i(31608),h=i(44135);i(74e3);class u{constructor(e,t,i){this.uid=e,this.geometry=t,this.attributes=i,this.visible=!0,this.objectId=null,this.centroid=null}}function p(e){return null!=e.geometry}class f{constructor(){this.exceededTransferLimit=!1,this.features=[],this.fields=[],this.hasM=!1,this.hasZ=!1,this.geometryType=null,this.objectIdFieldName=null,this.globalIdFieldName=null,this.geometryProperties=null,this.geohashFieldName=null,this.spatialReference=null,this.transform=null}}function g(e,t){var i,r;const n=d.g.fromJSON(e.geometryType),o=a.A.fromJSON(e.spatialReference),l=e.transform,u=e.objectIdFieldName,p=null===t||void 0===t?void 0:t.maxStringAttributeLength,f=null===t||void 0===t?void 0:t.maxStringAttributeFields;let g;const _=e.features.map((t=>{const i=function(e,t,i,r){return{uid:(0,s.c)(),objectId:r&&e.attributes?e.attributes[r]:null,attributes:e.attributes,geometry:m(e.geometry,t,i),visible:!0}}(t,n,o,e.objectIdFieldName),r=i.geometry;if(w(i.attributes,f,p,(e=>{var t;null!==(t=g)&&void 0!==t||(g=[]);const r=S(i,u);null!=r&&g.push({objectId:r,attribute:e})})),null!=r&&l)switch(r.type){case"point":i.geometry=(0,c.Tr)(l,r,r,r.hasZ,r.hasM);break;case"multipoint":i.geometry=(0,c.SW)(l,r,r,!!r.hasZ,!!r.hasM);break;case"polygon":i.geometry=(0,c.$X)(l,r,r,!!r.hasZ,!!r.hasM);break;case"polyline":i.geometry=(0,c.P5)(l,r,r,!!r.hasZ,!!r.hasM);break;case"extent":case"mesh":i.geometry=r}return i}));return{geometryType:n,features:_,spatialReference:o,fields:null!==(i=null===(r=e.fields)||void 0===r?void 0:r.map((e=>h.A.fromJSON(e))))&&void 0!==i?i:[],objectIdFieldName:e.objectIdFieldName,globalIdFieldName:e.globalIdFieldName,geohashFieldName:e.geohashFieldName,geometryProperties:e.geometryProperties,hasZ:e.hasZ,hasM:e.hasM,exceededTransferLimit:e.exceededTransferLimit,transform:null,missingAttributes:g}}function m(e,t,i){if(null==e)return null;switch(t){case"point":{const t=e;return{x:t.x,y:t.y,z:t.z,m:t.m,hasZ:null!=t.z,hasM:null!=t.m,type:"point",spatialReference:i}}case"polyline":{const t=e;return{paths:t.paths,hasZ:!!t.hasZ,hasM:!!t.hasM,type:"polyline",spatialReference:i}}case"polygon":{const t=e;return{rings:t.rings,hasZ:!!t.hasZ,hasM:!!t.hasM,type:"polygon",spatialReference:i}}case"multipoint":{const t=e;return{points:t.points,hasZ:!!t.hasZ,hasM:!!t.hasM,type:"multipoint",spatialReference:i}}}}function _(e){let t=32;return t+=(0,r.eY)(e.attributes),t+=3,t+=8+function(e){if(null==e)return 0;let t=32;switch(e.type){case"point":t+=42;break;case"polyline":case"polygon":{let i=0;const r=2+(e.hasZ?1:0)+(e.hasM?1:0),n="polyline"===e.type?e.paths:e.rings;for(const e of n)i+=e.length;t+=8*i*r+64,t+=128*i,t+=34,t+=32*(n.length+1);break}case"multipoint":{const i=2+(e.hasZ?1:0)+(e.hasM?1:0),r=e.points.length;t+=8*r*i+64,t+=128*r,t+=34,t+=32;break}case"extent":t+=98,e.hasM&&(t+=32),e.hasZ&&(t+=32);break;case"mesh":t+=(0,n.Ek)(e.vertexAttributes.position,e.vertexAttributes.normal,e.vertexAttributes.uv,e.vertexAttributes.tangent)}return t}(e.geometry),t}function v(e){if(null==e)return 0;switch(e.type){case"point":return 1;case"polyline":{let t=0;for(const i of e.paths)t+=i.length;return t}case"polygon":{let t=0;for(const i of e.rings)t+=i.length;return t}case"multipoint":return e.points.length;case"extent":return 2;case"mesh":{const t=e.vertexAttributes&&e.vertexAttributes.position;return t?t.length/3:0}default:return}}function y(e){if(null==e)return!1;switch(e.type){case"extent":case"point":return!0;case"polyline":for(const t of e.paths)if(t.length>0)return!0;return!1;case"polygon":for(const t of e.rings)if(t.length>0)return!0;return!1;case"multipoint":return e.points.length>0;case"mesh":return!e.loaded||e.vertexAttributes.position.length>0}}function b(e,t){switch((0,o.Ie)(t),"mesh"===e.type&&(e=e.extent),e.type){case"point":t[0]=t[3]=e.x,t[1]=t[4]=e.y,e.hasZ&&(t[2]=t[5]=e.z);break;case"polyline":for(let i=0;i<e.paths.length;i++)(0,o.Jf)(t,e.paths[i],!!e.hasZ);break;case"polygon":for(let i=0;i<e.rings.length;i++)(0,o.Jf)(t,e.rings[i],!!e.hasZ);break;case"multipoint":(0,o.Jf)(t,e.points,!!e.hasZ);break;case"extent":t[0]=e.xmin,t[1]=e.ymin,t[3]=e.xmax,t[4]=e.ymax,null!=e.zmin&&(t[2]=e.zmin),null!=e.zmax&&(t[5]=e.zmax)}}function x(e,t){switch((0,l.Ie)(t),"mesh"===e.type&&(e=e.extent),e.type){case"point":t[0]=t[2]=e.x,t[1]=t[3]=e.y;break;case"polyline":for(let i=0;i<e.paths.length;i++)(0,l.Jf)(t,e.paths[i]);break;case"polygon":for(let i=0;i<e.rings.length;i++)(0,l.Jf)(t,e.rings[i]);break;case"multipoint":(0,l.Jf)(t,e.points);break;case"extent":t[0]=e.xmin,t[1]=e.ymin,t[2]=e.xmax,t[3]=e.ymax}}function S(e,t){return null!=e.objectId?e.objectId:e.attributes&&t?e.attributes[t]:null}function w(e,t,i,r){if(null!==t&&void 0!==t&&t.size&&null!=i&&e)for(const n in e){if(!t.has(n))continue;const s=e[n];"string"==typeof s&&s.length>i&&(r(n),e[n]="")}}},74438:(e,t,i)=>{i.d(t,{SE:()=>n,qM:()=>s});var r=i(97015);async function n(e,t,i){t=t.clone(),e.capabilities.query.supportsMaxRecordCountFactor&&(t.maxRecordCountFactor=a(e));const r=s(e),n=e.capabilities.query.supportsPagination;t.start=0,t.num=r;let o=null;for(;;){const s=await e.source.queryFeaturesJSON(t,i);if(null==o?o=s:o.features=o.features.concat(s.features),o.exceededTransferLimit=s.exceededTransferLimit,!n||!s.exceededTransferLimit)break;t.start+=r}return o}function s(e){return a(e)*function(e){return e.capabilities.query.maxRecordCount||2e3}(e)}function a(e){return e.capabilities.query.supportsMaxRecordCountFactor?r.A.MAX_MAX_RECORD_COUNT_FACTOR:1}},19463:(e,t,i)=>{i.d(t,{E1:()=>o,Fm:()=>l,JZ:()=>g,R_:()=>a,fu:()=>n,oF:()=>s,rq:()=>c});const r=[["binary","application/octet-stream","bin",""]];function n(e,t){var i;return null!=h(t.name,null!==(i=null===e||void 0===e?void 0:e.supportedFormats)&&void 0!==i?i:[])}function s(e,t){var i;if(!e)return!1;const r=c(t,null!==(i=e.supportedFormats)&&void 0!==i?i:[]);return null!=r&&e.editFormats.includes(r)}function a(e,t){return u(function(e,t){const i=e.toLowerCase();return d(t).find((e=>p(e)===i))}(e,t))}function o(e,t){return u(h(e,t))}function l(e,t){return p(function(e,t){return d(t).find((t=>u(t)===e))}(e,t))}function c(e,t){var i;return null!==(i=o(e.name,t))&&void 0!==i?i:a(e.type,t)}function d(e){return[...r,...e]}function h(e,t){const i=e.toLowerCase();return d(t).find((e=>f(e).some((e=>i.endsWith(e)))))}function u(e){return null===e||void 0===e?void 0:e[0]}function p(e){return null===e||void 0===e?void 0:e[1].toLowerCase()}function f(e){var t;return null!==(t=null===e||void 0===e?void 0:e[2].split(",").map((e=>e.toLowerCase())))&&void 0!==t?t:[]}function g(e){var t;return null===(t=e.tables)||void 0===t?void 0:t.find((e=>"assetMaps"===e.role))}},79701:(e,t,i)=>{i.d(t,{W:()=>m,l:()=>g});var r=i(50076),n=i(76460),s=i(34154),a=i(65256),o=i(50265),l=i(15142),c=i(53430),d=i(65460),h=i(98976);const u=()=>n.A.getLogger("esri.layers.support.labelFormatUtils"),p={type:"simple",evaluate:()=>null},f={getAttribute:(e,t)=>e.field(t)};async function g(e,t,i){if(!e||!e.symbol||!t)return p;const n=e.where,a=(0,d.XJ)(e);let o;if("arcade"===a.type){const e=await(0,h.$I)(a.expression,i,t);if(null==e)return p;o={type:"arcade",evaluate(t,n){try{const i="attributes"in t?e.repurposeFeature(t):t;i.contextTimeZone=null!==n&&void 0!==n?n:null;const r=e.evaluate({$view:{timeZone:n},$feature:i},e.services);if(null!=r)return r.toString()}catch(i){u().error(new r.A("arcade-expression-error","Encountered an error when evaluating label expression for feature",{error:i,feature:t,expression:a}))}return null},needsHydrationToEvaluate:()=>null==(0,d.tH)(a.expression)}}else o={type:"simple",evaluate:e=>a.expression.replaceAll(/{[^}]*}/g,(i=>{const r=i.slice(1,-1),n=t.get(r);if(!n)return i;let s=null;return"attributes"in e?e&&e.attributes&&(s=e.attributes[n.name]):s=e.field(n.name),null==s?"":m(s,n)}))};if(n){let e;try{e=await(0,s.G)(n,t)}catch(l){return u().error(new r.A("bad-where-clause","Encountered an error when evaluating where clause, ignoring",{where:n,error:l})),p}const i=o.evaluate;o.evaluate=(t,s)=>{const a="attributes"in t?void 0:f;try{if(e.testFeature(t,a))return i(t,s)}catch(l){u().error(new r.A("bad-where-clause","Encountered an error when evaluating where clause for feature",{where:n,feature:t,error:l}))}return null}}return o}function m(e,t){if(null==e)return"";const i=t.domain;if(i)if("codedValue"===i.type||"coded-value"===i.type){const t=e;for(const e of i.codedValues)if(e.code===t)return e.name}else if("range"===i.type){const{max:r,min:n}=(0,l.A5)(t),s=+e;if(null!=n&&null!=r&&n<=s&&s<=r)return i.name}let r=e;return(0,c.vE)(t)?r=(0,a.Yq)(r,(0,a.J2)("short-date")):(0,c.WA)(t)&&(r=(0,o.ZV)(+r)),r||""}},65460:(e,t,i)=>{i.d(t,{BI:()=>m,D3:()=>f,XJ:()=>g,lc:()=>p,mX:()=>v,rU:()=>_,tH:()=>w});var r=i(88685);const n="__begin__",s="__end__",a=new RegExp(n,"ig"),o=new RegExp(s,"ig"),l=new RegExp("^"+n,"i"),c=new RegExp(s+"$","i"),d='"',h=d+" + ",u=" + "+d;function p(e){return e.replaceAll(new RegExp("\\[","g"),"{").replaceAll(new RegExp("\\]","g"),"}")}function f(e){return e.replaceAll(new RegExp("\\{","g"),"[").replaceAll(new RegExp("\\}","g"),"]")}function g(e){const t={expression:"",type:"none"};return e.labelExpressionInfo?e.labelExpressionInfo.value?(t.expression=e.labelExpressionInfo.value,t.type="conventional"):e.labelExpressionInfo.expression&&(t.expression=e.labelExpressionInfo.expression,t.type="arcade"):null!=e.labelExpression&&(t.expression=p(e.labelExpression),t.type="conventional"),t}function m(e){const t=g(e);if(!t)return null;switch(t.type){case"conventional":return v(t.expression);case"arcade":return t.expression}return null}function _(e){const t=g(e);if(!t)return null;switch(t.type){case"conventional":return function(e){const t=null===e||void 0===e?void 0:e.match(y);return(null===t||void 0===t?void 0:t[1].trim())||null}(t.expression);case"arcade":return w(t.expression)}return null}function v(e){let t;return e?(t=(0,r.HC)(e,(e=>n+'$feature["'+e+'"]'+s)),t=l.test(t)?t.replace(l,""):d+t,t=c.test(t)?t.replace(c,""):t+d,t=t.replaceAll(a,h).replaceAll(o,u)):t='""',t}const y=/^\s*\{([^}]+)\}\s*$/i;const b=/^\s*(?:(?:\$feature\.(\w+))|(?:\$feature\[(["'])([\w\s]+)(\2)\]));?\s*$/i,x=/^\s*(?:(?:\$feature\.(\w+))|(?:\$feature\[(["'])([\w\s]+)(\2)\]));?\s*(?:DomainName\(\s*\$feature\s*,\s*(["'])(\1|\3)(\5)\s*\));?\s*$/i,S=/^\s*(?:DomainName\(\s*\$feature\s*,\s*(["'])([\w\s]+)(\1)\s*\));?\s*$/i;function w(e){if(!e)return null;let t=b.exec(e)||x.exec(e);return t?t[1]||t[3]:(t=S.exec(e),t?t[2]:null)}},11941:(e,t,i)=>{var r,n;i.d(t,{D:()=>n,f:()=>r}),function(e){e[e.None=0]="None",e[e.Int16=1]="Int16",e[e.Int32=2]="Int32"}(r||(r={})),function(e){e[e.Replace=0]="Replace",e[e.Outside=1]="Outside",e[e.Inside=2]="Inside",e[e.Finished=3]="Finished"}(n||(n={}))},43414:(e,t,i)=>{i.d(t,{a:()=>n,h:()=>s});var r=i(28899);function n(){return new Promise((e=>i.e(4001).then(i.bind(i,26382)).then((e=>e.l)).then((t=>{let{default:i}=t;const r=i({locateFile:a,onRuntimeInitialized:()=>e(r)})})))).catch((e=>{throw e}))}function s(){return new Promise((e=>i.e(3409).then(i.bind(i,23409)).then((e=>e.l)).then((t=>{let{default:i}=t;const r=i({locateFile:a,onRuntimeInitialized:()=>e(r)})})))).catch((e=>{throw e}))}function a(e){return(0,r.s)("esri/libs/lyr3d/".concat(e))}},39483:(e,t,i)=>{i.r(t),i.d(t,{getGeometryServiceURL:()=>l,projectGeometry:()=>c});var r=i(86560),n=i(50076),s=i(65308),a=i(71334),o=i(70414);async function l(){var e;let t,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,a=arguments.length>1?arguments[1]:void 0;if(r.A.geometryServiceUrl)return r.A.geometryServiceUrl;if(!i)throw new n.A("internal:geometry-service-url-not-configured");t="portal"in i?i.portal||s.A.getDefault():i,await t.load({signal:a});const o=null===(e=t.helperServices)||void 0===e||null===(e=e.geometry)||void 0===e?void 0:e.url;if(!o)throw new n.A("internal:geometry-service-url-not-configured");return o}async function c(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,r=arguments.length>3?arguments[3]:void 0;const s=await l(i,r),c=new o.A;c.geometries=[e],c.outSpatialReference=t;const d=await(0,a.C)(s,c,{signal:r});if(d&&Array.isArray(d)&&1===d.length)return d[0];throw new n.A("internal:geometry-service-projection-failed")}},3454:(e,t,i)=>{i.d(t,{j:()=>s});var r=i(31633),n=i(14556);const s={unknown:1,inches:(0,r.oU)(1,"meters","inches"),feet:(0,r.oU)(1,"meters","feet"),"us-feet":(0,r.oU)(1,"meters","us-feet"),yards:(0,r.oU)(1,"meters","yards"),miles:(0,r.oU)(1,"meters","miles"),"nautical-miles":(0,r.oU)(1,"meters","nautical-miles"),millimeters:(0,r.oU)(1,"meters","millimeters"),centimeters:(0,r.oU)(1,"meters","centimeters"),decimeters:(0,r.oU)(1,"meters","decimeters"),meters:(0,r.oU)(1,"meters","meters"),kilometers:(0,r.oU)(1,"meters","kilometers"),"decimal-degrees":1/(0,r.vl)(1,"meters",n.$O.radius)}},71334:(e,t,i)=>{i.d(t,{C:()=>d});var r=i(3825),n=i(40565),s=i(19902),a=i(54994),o=i(71838),l=i(70414);const c=(0,n.dp)(l.A);async function d(e,t,i){t=c(t);const n=(0,a.Dl)(e),l={...n.query,f:"json",...t.toJSON()},d=t.outSpatialReference,h=(0,s.$B)(t.geometries[0]),u=(0,a.jV)(l,i);return(0,r.A)(n.path+"/project",u).then((e=>{let{data:{geometries:t}}=e;return(0,o.V)(t,h,d)}))}},78238:(e,t,i)=>{function r(e){const t={};for(const i in e){if("declaredClass"===i)continue;const n=e[i];if(null!=n&&"function"!=typeof n)if(Array.isArray(n)){t[i]=[];for(let e=0;e<n.length;e++)t[i][e]=r(n[e])}else"object"==typeof n?n.toJSON&&(t[i]=JSON.stringify(n)):t[i]=n}return t}i.d(t,{z:()=>r})},36643:(e,t,i)=>{i.d(t,{GB:()=>y,IJ:()=>f,Jf:()=>v,Pk:()=>m,eW:()=>p,gW:()=>_,kS:()=>g});var r=i(3825),n=i(90534),s=i(19902),a=i(1438),o=i(80963),l=i(78238),c=i(89122),d=i(57831);const h="Layer does not support extent calculation.";function u(e,t){var i;const r=e.geometry,n=e.toJSON();delete n.compactGeometryEnabled,delete n.defaultSpatialReferenceEnabled;const a=n;let l,c,d;if(null!=r&&(c=r.spatialReference,d=(0,o.YX)(c),a.geometryType=(0,s.$B)(r),a.geometry=function(e,t){if(t&&"extent"===e.type)return"".concat(e.xmin,",").concat(e.ymin,",").concat(e.xmax,",").concat(e.ymax);if(t&&"point"===e.type)return"".concat(e.x,",").concat(e.y);const i=e.toJSON();return delete i.spatialReference,JSON.stringify(i)}(r,e.compactGeometryEnabled),a.inSR=d),n.groupByFieldsForStatistics&&(a.groupByFieldsForStatistics=n.groupByFieldsForStatistics.join(",")),n.objectIds&&(a.objectIds=n.objectIds.join(",")),n.orderByFields&&(a.orderByFields=n.orderByFields.join(",")),!n.outFields||!n.returnDistinctValues&&(null!==t&&void 0!==t&&t.returnCountOnly||null!==t&&void 0!==t&&t.returnExtentOnly||null!==t&&void 0!==t&&t.returnIdsOnly)?delete a.outFields:n.outFields.includes("*")?a.outFields="*":a.outFields=n.outFields.join(","),n.outSR?(a.outSR=(0,o.YX)(n.outSR),l=e.outSpatialReference):r&&(n.returnGeometry||n.returnCentroid)&&(a.outSR=a.inSR,l=c),n.returnGeometry&&delete n.returnGeometry,n.outStatistics&&(a.outStatistics=JSON.stringify(n.outStatistics)),n.fullText&&(a.fullText=JSON.stringify(n.fullText)),n.pixelSize&&(a.pixelSize=JSON.stringify(n.pixelSize)),n.quantizationParameters&&(e.defaultSpatialReferenceEnabled&&null!=c&&null!=(null===(i=e.quantizationParameters)||void 0===i?void 0:i.extent)&&c.equals(e.quantizationParameters.extent.spatialReference)&&delete n.quantizationParameters.extent.spatialReference,a.quantizationParameters=JSON.stringify(n.quantizationParameters)),n.parameterValues&&(a.parameterValues=JSON.stringify(n.parameterValues)),n.rangeValues&&(a.rangeValues=JSON.stringify(n.rangeValues)),n.dynamicDataSource&&(a.layer=JSON.stringify({source:n.dynamicDataSource}),delete n.dynamicDataSource),n.timeExtent){const e=n.timeExtent,{start:t,end:i}=e;null==t&&null==i||(a.time=t===i?t:"".concat(null!==t&&void 0!==t?t:"null",",").concat(null!==i&&void 0!==i?i:"null")),delete n.timeExtent}return e.defaultSpatialReferenceEnabled&&null!=c&&null!=l&&c.equals(l)&&(a.defaultSR=a.inSR,delete a.inSR,delete a.outSR),a}async function p(e,t,i,r){const n=null!=t.timeExtent&&t.timeExtent.isEmpty?{data:{features:[]}}:await y(e,t,"json",r);return(0,d.q)(t,i,n.data),n}async function f(e,t,i,r){if(null!=t.timeExtent&&t.timeExtent.isEmpty)return{data:i.createFeatureResult()};const n=await g(e,t,r),s=n;return s.data=(0,c.m)(n.data,i),s}function g(e,t,i){return y(e,t,"pbf",i)}function m(e,t,i){return null!=t.timeExtent&&t.timeExtent.isEmpty?Promise.resolve({data:{objectIds:[]}}):y(e,t,"json",i,{returnIdsOnly:!0})}function _(e,t,i){return null!=t.timeExtent&&t.timeExtent.isEmpty?Promise.resolve({data:{count:0}}):y(e,t,"json",i,{returnIdsOnly:!0,returnCountOnly:!0})}async function v(e,t,i){if(null!=t.timeExtent&&t.timeExtent.isEmpty)return{data:{count:0,extent:null}};const r=await y(e,t,"json",i,{returnExtentOnly:!0,returnCountOnly:!0}),n=r.data;if(n.hasOwnProperty("extent"))return r;if(n.features)throw new Error(h);if(n.hasOwnProperty("count"))throw new Error(h);return r}async function y(e,t,i){let s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{};const c="string"==typeof e?(0,n.An)(e):e,d=t.geometry?[t.geometry]:[],h=await(0,a.el)(d,null,{signal:s.signal}),p=null===h||void 0===h?void 0:h[0];null!=p&&((t=t.clone()).geometry=p);const f=(0,l.z)({...c.query,f:i,...o,...u(t,o)});return(0,r.A)((0,n.fj)(c.path,function(e,t){return null!=e.formatOf3DObjects&&!(t.returnCountOnly||t.returnExtentOnly||t.returnIdsOnly)}(t,o)?"query3d":"query"),{...s,responseType:"pbf"===i?"array-buffer":"json",query:{...f,...s.query}})}},57831:(e,t,i)=>{i.d(t,{q:()=>n});var r=i(86729);function n(e,t,i){if(null===i||void 0===i||!i.features||!i.hasZ)return;const n=(0,r.N)(i.geometryType,t,e.outSpatialReference);if(null!=n)for(const r of i.features)n(r.geometry)}},70414:(e,t,i)=>{i.d(t,{A:()=>d});var r=i(35143),n=i(42553),s=i(46053),a=(i(81806),i(76460),i(47249),i(85842)),o=i(19902),l=i(80963);let c=class extends n.oY{constructor(e){super(e),this.geometries=[],this.outSpatialReference=null,this.transformation=null,this.transformForward=null}toJSON(){const e=this.geometries.map((e=>e.toJSON())),t=this.geometries[0],i={};return i.outSR=(0,l.YX)(this.outSpatialReference),i.inSR=(0,l.YX)(t.spatialReference),i.geometries=JSON.stringify({geometryType:(0,o.$B)(t),geometries:e}),this.transformation&&(i.transformation=this.transformation.wkid||JSON.stringify(this.transformation)),null!=this.transformForward&&(i.transformForward=this.transformForward),i}};(0,r._)([(0,s.MZ)()],c.prototype,"geometries",void 0),(0,r._)([(0,s.MZ)({json:{read:{source:"outSR"}}})],c.prototype,"outSpatialReference",void 0),(0,r._)([(0,s.MZ)()],c.prototype,"transformation",void 0),(0,r._)([(0,s.MZ)()],c.prototype,"transformForward",void 0),c=(0,r._)([(0,a.$)("esri.rest.support.ProjectParameters")],c);const d=c},10156:(e,t,i)=>{i.r(t),i.d(t,{assetMapFromAssetMapsJSON:()=>v,extractMesh:()=>m,meshFeatureSetFromJSON:()=>g});var r=i(39356),n=i(76460),s=i(87663),a=i(76797),o=i(14710),l=i(13904),c=i(13312),d=i(32186),h=i(57045),u=i(19463),p=i(77725);const f=()=>n.A.getLogger("esri.rest.support.meshFeatureSet");function g(e,t,i){var n;const s=i.features;i.features=[],delete i.geometryType;const a=p.A.fromJSON(i);if(a.geometryType="mesh",!i.assetMaps)return a;const o=v(t,i.assetMaps),l=null!==(n=e.sourceSpatialReference)&&void 0!==n?n:c.A.WGS84,d=i.globalIdFieldName,{outFields:h}=e,u=null!=h&&h.length>0?function(e){return t=>{let{attributes:i}=t;if(!i)return{};if(!e)return i;for(const r in i)e.has(r)||delete i[r];return i}}(h.includes("*")?null:new Set(h)):()=>({});for(const c of s){const e=m(c,d,l,t,o);null!=e&&a.features.push(new r.A({geometry:e,attributes:u(c)}))}return a}function m(e,t,i,r,n){const s=e.attributes[t],c=n.get(s);if(null==c)return f().error("mesh-feature-set:asset-not-found","Service returned a feature which was not found in the asset map",e),null;if(!e.geometry)return f().error("mesh-feature-set:no-geometry","Service returned a feature without geometry",e),null;const u=function(e,t,i){let{attributes:r}=e,{transformFieldRoles:n}=i;const s=r[n.originX],a=r[n.originY],o=r[n.originZ];return new l.A({x:s,y:a,z:o,spatialReference:t})}(e,i,r),p=a.A.fromJSON(e.geometry);p.spatialReference=i;const g=function(e,t){let{transformFieldRoles:i}=t;return new d.A({translation:[e[i.translationX],-e[i.translationZ],e[i.translationY]],rotationAxis:[e[i.rotationX],-e[i.rotationZ],e[i.rotationY]],rotationAngle:e[i.rotationDeg],scale:[e[i.scaleX],e[i.scaleZ],e[i.scaleY]]})}(e.attributes,r),m=i.isGeographic?"local":"georeferenced",v=function(e){const t=Array.from(e.files.values()),i=new Array;for(const r of t){if(r.status!==_.COMPLETED)return null;const e=new Array;for(const t of r.parts){if(!t)return null;e.push(new h.Bq(t.url,t.hash))}i.push(new h.Qp(r.name,r.mimeType,e))}return i}(c);return v?o.A.createWithExternalSource(u,v,{extent:p,transform:g,vertexSpace:m}):o.A.createIncomplete(u,{extent:p,transform:g,vertexSpace:m})}var _;function v(e,t){const i=new Map;for(const r of t){const t=r.parentGlobalId;if(null==t)continue;const n=r.assetName,a=r.assetType,o=r.assetHash,l=r.assetURL,c=r.conversionStatus,d=r.seqNo,h=(0,u.Fm)(a,e.supportedFormats);if(!h){f().error("mesh-feature-set:unknown-format","Service returned an asset of type ".concat(a,", but it does not list it as a supported type"));continue}const p=(0,s.tE)(i,t,(()=>({files:new Map})));(0,s.tE)(p.files,n,(()=>({name:n,type:a,mimeType:h,status:y(c),parts:[]}))).parts[d]={hash:o,url:l}}return i}function y(e){switch(e){case"COMPLETED":case"SUBMITTED":return _.COMPLETED;case"INPROGRESS":return _.PENDING;default:return _.FAILED}}!function(e){e[e.FAILED=0]="FAILED",e[e.PENDING=1]="PENDING",e[e.COMPLETED=2]="COMPLETED"}(_||(_={}))},28808:(e,t,i)=>{var r,n,s,a,o,l,c,d,h,u,p,f,g,m,_,v,y,b,x,S,w,C,A,R,E,O,T,P,M,I,D,L,F,N,V,G,U,z,B,H,j,W,k,Z,q,Q,J,Y,X,$,K,ee,te,ie,re,ne,se,ae,oe,le,ce;i.d(t,{$2:()=>o,C1:()=>s,JO:()=>n,M1:()=>C,O$:()=>se,Q1:()=>Q,TZ:()=>v,WE:()=>P,Y:()=>c,YI:()=>Y,bj:()=>d,e_:()=>q,f0:()=>ne,fu:()=>p,g7:()=>h,ip:()=>J,mU:()=>M,oF:()=>S,uQ:()=>w,uT:()=>G,vG:()=>oe,wd:()=>H,xR:()=>r,xn:()=>y,xw:()=>E,yS:()=>U}),function(e){e[e.BUTT=0]="BUTT",e[e.ROUND=1]="ROUND",e[e.SQUARE=2]="SQUARE",e[e.UNKNOWN=4]="UNKNOWN"}(r||(r={})),function(e){e[e.BEVEL=0]="BEVEL",e[e.ROUND=1]="ROUND",e[e.MITER=2]="MITER",e[e.UNKNOWN=4]="UNKNOWN"}(n||(n={})),function(e){e[e.SCREEN=0]="SCREEN",e[e.MAP=1]="MAP"}(s||(s={})),function(e){e[e.Tint=0]="Tint",e[e.Ignore=1]="Ignore",e[e.Multiply=99]="Multiply"}(a||(a={})),function(e){e.Both="Both",e.JustBegin="JustBegin",e.JustEnd="JustEnd",e.None="None"}(o||(o={})),function(e){e[e.Mosaic=0]="Mosaic",e[e.Centered=1]="Centered"}(l||(l={})),function(e){e[e.Normal=0]="Normal",e[e.Superscript=1]="Superscript",e[e.Subscript=2]="Subscript"}(c||(c={})),function(e){e[e.MSSymbol=0]="MSSymbol",e[e.Unicode=1]="Unicode"}(d||(d={})),function(e){e[e.Unspecified=0]="Unspecified",e[e.TrueType=1]="TrueType",e[e.PSOpenType=2]="PSOpenType",e[e.TTOpenType=3]="TTOpenType",e[e.Type1=4]="Type1"}(h||(h={})),function(e){e[e.Display=0]="Display",e[e.Map=1]="Map"}(u||(u={})),function(e){e.None="None",e.Loop="Loop",e.Oscillate="Oscillate"}(p||(p={})),function(e){e[e.Z=0]="Z",e[e.X=1]="X",e[e.Y=2]="Y"}(f||(f={})),function(e){e[e.XYZ=0]="XYZ",e[e.ZXY=1]="ZXY",e[e.YXZ=2]="YXZ"}(g||(g={})),function(e){e[e.Rectangle=0]="Rectangle",e[e.RoundedRectangle=1]="RoundedRectangle",e[e.Oval=2]="Oval"}(m||(m={})),function(e){e[e.None=0]="None",e[e.Alpha=1]="Alpha",e[e.Screen=2]="Screen",e[e.Multiply=3]="Multiply",e[e.Add=4]="Add"}(_||(_={})),function(e){e[e.TTB=0]="TTB",e[e.RTL=1]="RTL",e[e.BTT=2]="BTT"}(v||(v={})),function(e){e[e.None=0]="None",e[e.SignPost=1]="SignPost",e[e.FaceNearPlane=2]="FaceNearPlane"}(y||(y={})),function(e){e[e.Float=0]="Float",e[e.String=1]="String",e[e.Boolean=2]="Boolean"}(b||(b={})),function(e){e[e.Intersect=0]="Intersect",e[e.Subtract=1]="Subtract"}(x||(x={})),function(e){e.OpenEnded="OpenEnded",e.Block="Block",e.Crossed="Crossed"}(S||(S={})),function(e){e.FullGeometry="FullGeometry",e.PerpendicularFromFirstSegment="PerpendicularFromFirstSegment",e.ReversedFirstSegment="ReversedFirstSegment",e.PerpendicularToSecondSegment="PerpendicularToSecondSegment",e.SecondSegmentWithTicks="SecondSegmentWithTicks",e.DoublePerpendicular="DoublePerpendicular",e.OppositeToFirstSegment="OppositeToFirstSegment",e.TriplePerpendicular="TriplePerpendicular",e.HalfCircleFirstSegment="HalfCircleFirstSegment",e.HalfCircleSecondSegment="HalfCircleSecondSegment",e.HalfCircleExtended="HalfCircleExtended",e.OpenCircle="OpenCircle",e.CoverageEdgesWithTicks="CoverageEdgesWithTicks",e.GapExtentWithDoubleTicks="GapExtentWithDoubleTicks",e.GapExtentMidline="GapExtentMidline",e.Chevron="Chevron",e.PerpendicularWithArc="PerpendicularWithArc",e.ClosedHalfCircle="ClosedHalfCircle",e.TripleParallelExtended="TripleParallelExtended",e.ParallelWithTicks="ParallelWithTicks",e.Parallel="Parallel",e.PerpendicularToFirstSegment="PerpendicularToFirstSegment",e.ParallelOffset="ParallelOffset",e.OffsetOpposite="OffsetOpposite",e.OffsetSame="OffsetSame",e.CircleWithArc="CircleWithArc",e.DoubleJog="DoubleJog",e.PerpendicularOffset="PerpendicularOffset",e.LineExcludingLastSegment="LineExcludingLastSegment",e.MultivertexArrow="MultivertexArrow",e.CrossedArrow="CrossedArrow",e.ChevronArrow="ChevronArrow",e.ChevronArrowOffset="ChevronArrowOffset",e.PartialFirstSegment="PartialFirstSegment",e.Arch="Arch",e.CurvedParallelTicks="CurvedParallelTicks",e.Arc90Degrees="Arc90Degrees"}(w||(w={})),function(e){e.Mitered="Mitered",e.Bevelled="Bevelled",e.Rounded="Rounded",e.Square="Square",e.TrueBuffer="TrueBuffer"}(C||(C={})),function(e){e.ClosePath="ClosePath",e.ConvexHull="ConvexHull",e.RectangularBox="RectangularBox"}(A||(A={})),function(e){e.BeginningOfLine="BeginningOfLine",e.EndOfLine="EndOfLine"}(R||(R={})),function(e){e.Mitered="Mitered",e.Bevelled="Bevelled",e.Rounded="Rounded",e.Square="Square"}(E||(E={})),function(e){e.Fast="Fast",e.Accurate="Accurate"}(O||(O={})),function(e){e.BeginningOfLine="BeginningOfLine",e.EndOfLine="EndOfLine"}(T||(T={})),function(e){e.Sinus="Sinus",e.Square="Square",e.Triangle="Triangle",e.Random="Random"}(P||(P={})),function(e){e[e.None=0]="None",e[e.Default=1]="Default",e[e.Force=2]="Force"}(M||(M={})),function(e){e[e.Buffered=0]="Buffered",e[e.Left=1]="Left",e[e.Right=2]="Right",e[e.AlongLine=3]="AlongLine"}(I||(I={})),function(e){e[e.Linear=0]="Linear",e[e.Rectangular=1]="Rectangular",e[e.Circular=2]="Circular",e[e.Buffered=3]="Buffered"}(D||(D={})),function(e){e[e.Discrete=0]="Discrete",e[e.Continuous=1]="Continuous"}(L||(L={})),function(e){e[e.AcrossLine=0]="AcrossLine",e[e.AloneLine=1]="AloneLine"}(F||(F={})),function(e){e[e.Left=0]="Left",e[e.Right=1]="Right",e[e.Center=2]="Center",e[e.Justify=3]="Justify"}(N||(N={})),function(e){e[e.Base=0]="Base",e[e.MidPoint=1]="MidPoint",e[e.ThreePoint=2]="ThreePoint",e[e.FourPoint=3]="FourPoint",e[e.Underline=4]="Underline",e[e.CircularCW=5]="CircularCW",e[e.CircularCCW=6]="CircularCCW"}(V||(V={})),function(e){e.Butt="Butt",e.Round="Round",e.Square="Square"}(G||(G={})),function(e){e.NoConstraint="NoConstraint",e.HalfPattern="HalfPattern",e.HalfGap="HalfGap",e.FullPattern="FullPattern",e.FullGap="FullGap",e.Custom="Custom"}(U||(U={})),function(e){e[e.None=-1]="None",e[e.Custom=0]="Custom",e[e.Circle=1]="Circle",e[e.OpenArrow=2]="OpenArrow",e[e.ClosedArrow=3]="ClosedArrow",e[e.Diamond=4]="Diamond"}(z||(z={})),function(e){e[e.ExtraLeading=0]="ExtraLeading",e[e.Multiple=1]="Multiple",e[e.Exact=2]="Exact"}(B||(B={})),function(e){e.Bevel="Bevel",e.Round="Round",e.Miter="Miter"}(H||(H={})),function(e){e[e.Default=0]="Default",e[e.String=1]="String",e[e.Numeric=2]="Numeric"}(j||(j={})),function(e){e[e.InsidePolygon=0]="InsidePolygon",e[e.PolygonCenter=1]="PolygonCenter",e[e.RandomlyInsidePolygon=2]="RandomlyInsidePolygon"}(W||(W={})),function(e){e[e.Tint=0]="Tint",e[e.Replace=1]="Replace",e[e.Multiply=2]="Multiply"}(k||(k={})),function(e){e[e.ClipAtBoundary=0]="ClipAtBoundary",e[e.RemoveIfCenterOutsideBoundary=1]="RemoveIfCenterOutsideBoundary",e[e.DoNotTouchBoundary=2]="DoNotTouchBoundary",e[e.DoNotClip=3]="DoNotClip"}(Z||(Z={})),function(e){e.NoConstraint="NoConstraint",e.WithMarkers="WithMarkers",e.WithFullGap="WithFullGap",e.WithHalfGap="WithHalfGap",e.Custom="Custom"}(q||(q={})),function(e){e.Fixed="Fixed",e.Random="Random",e.RandomFixedQuantity="RandomFixedQuantity"}(Q||(Q={})),function(e){e.LineMiddle="LineMiddle",e.LineBeginning="LineBeginning",e.LineEnd="LineEnd",e.SegmentMidpoint="SegmentMidpoint"}(J||(J={})),function(e){e.OnPolygon="OnPolygon",e.CenterOfMass="CenterOfMass",e.BoundingBoxCenter="BoundingBoxCenter"}(Y||(Y={})),function(e){e[e.Low=0]="Low",e[e.Medium=1]="Medium",e[e.High=2]="High"}(X||(X={})),function(e){e[e.MarkerCenter=0]="MarkerCenter",e[e.MarkerBounds=1]="MarkerBounds"}($||($={})),function(e){e[e.None=0]="None",e[e.PropUniform=1]="PropUniform",e[e.PropNonuniform=2]="PropNonuniform",e[e.DifUniform=3]="DifUniform",e[e.DifNonuniform=4]="DifNonuniform"}(K||(K={})),function(e){e.Tube="Tube",e.Strip="Strip",e.Wall="Wall"}(ee||(ee={})),function(e){e[e.Random=0]="Random",e[e.Increasing=1]="Increasing",e[e.Decreasing=2]="Decreasing",e[e.IncreasingThenDecreasing=3]="IncreasingThenDecreasing"}(te||(te={})),function(e){e[e.Relative=0]="Relative",e[e.Absolute=1]="Absolute"}(ie||(ie={})),function(e){e[e.Normal=0]="Normal",e[e.LowerCase=1]="LowerCase",e[e.Allcaps=2]="Allcaps"}(re||(re={})),function(e){e[e.LTR=0]="LTR",e[e.RTL=1]="RTL"}(ne||(ne={})),function(e){e.Draft="Draft",e.Picture="Picture",e.Text="Text"}(se||(se={})),function(e){e[e.Top=0]="Top",e[e.Center=1]="Center",e[e.Baseline=2]="Baseline",e[e.Bottom=3]="Bottom"}(ae||(ae={})),function(e){e[e.Right=0]="Right",e[e.Upright=1]="Upright"}(oe||(oe={})),function(e){e[e.Small=0]="Small",e[e.Medium=1]="Medium",e[e.Large=2]="Large"}(le||(le={})),function(e){e[e.Calm=0]="Calm",e[e.Rippled=1]="Rippled",e[e.Slight=2]="Slight",e[e.Moderate=3]="Moderate"}(ce||(ce={}))},84202:(e,t,i)=>{i.d(t,{A7:()=>c,Cx:()=>d,Hk:()=>h,JJ:()=>f,UK:()=>l,jM:()=>u,x3:()=>p});i(81806);var r=i(86875),n=i(7246),s=i(76940),a=i(86659),o=i(44460);const l=s.A.fromJSON(o.Cb),c=n.A.fromJSON(o.yM),d=r.A.fromJSON(o.WR),h=a.A.fromJSON(o.JZ);const u=s.A.fromJSON(o.nC),p=n.A.fromJSON(o.HW),f=r.A.fromJSON(o.b6)},44460:(e,t,i)=>{i.d(t,{Cb:()=>s,HW:()=>d,JR:()=>n,JZ:()=>l,WR:()=>o,b6:()=>h,fT:()=>r,nC:()=>c,yM:()=>a});const r=[252,146,31,255],n=[153,153,153,255],s={type:"esriSMS",style:"esriSMSCircle",size:6,color:r,outline:{type:"esriSLS",style:"esriSLSSolid",width:.75,color:[153,153,153,255]}},a={type:"esriSLS",style:"esriSLSSolid",width:.75,color:r},o={type:"esriSFS",style:"esriSFSSolid",color:[252,146,31,196],outline:{type:"esriSLS",style:"esriSLSSolid",width:.75,color:[255,255,255,191]}},l={type:"esriTS",color:[255,255,255,255],font:{family:"arial-unicode-ms",size:10,weight:"bold"},horizontalAlignment:"center",kerning:!0,haloColor:[0,0,0,255],haloSize:1,rotated:!1,text:"",xoffset:0,yoffset:0,angle:0},c={type:"esriSMS",style:"esriSMSCircle",color:[0,0,0,255],outline:null,size:10.5},d={type:"esriSLS",style:"esriSLSSolid",color:[0,0,0,255],width:1.5},h={type:"esriSFS",style:"esriSFSSolid",color:[0,0,0,255],outline:null}},26314:(e,t,i)=>{i.d(t,{I:()=>g,p:()=>f,resolveWebStyleSymbol:()=>p});var r=i(95444),n=i(93795),s=i(50076),a=i(90534),o=i(65308),l=i(79453),c=i(10609),d=i(24141),h=i(8446),u=i(25158);function p(e,t,i,r){const n=e.name;return null==n?Promise.reject(new s.A("symbolstyleutils:style-symbol-reference-name-missing","Missing name in style symbol reference")):e.styleName&&"Esri2DPointSymbolsStyle"===e.styleName?function(e,t,i){const r=h.jg.replaceAll(/\{SymbolName\}/gi,e),n=null!=t.portal?t.portal:o.A.getDefault();return(0,h.yA)(r,i).then((e=>{const t=(0,h.bo)(e.data);return(0,c.rS)(t,{portal:n,url:(0,a.An)((0,a.nM)(r)),origin:"portal-item"})}))}(n,t,r):(0,h.cF)(e,t,r).then((e=>g(e,n,t,i,h.o5,r)))}function f(e,t){return t.items.find((t=>t.name===e))}function g(e,t,i,p,g,m){var _,v,y,b;const x=null!=(null===i||void 0===i?void 0:i.portal)?i.portal:o.A.getDefault(),S={portal:x,url:(0,a.An)(e.baseUrl),origin:"portal-item"},w=f(t,e.data);if(!w){const e="The symbol name '".concat(t,"' could not be found");return Promise.reject(new s.A("symbolstyleutils:symbol-name-not-found",e,{symbolName:t}))}let C=(0,l.f)(g(w,p),S),A=null!==(_=null===(v=w.thumbnail)||void 0===v?void 0:v.href)&&void 0!==_?_:null;const R=null===(y=w.thumbnail)||void 0===y?void 0:y.imageData;(0,n.b5)()&&(C=null!==(b=(0,n.EM)(C))&&void 0!==b?b:"",A=(0,n.EM)(A));const E={portal:x,url:(0,a.An)((0,a.nM)(C)),origin:"portal-item"};return(0,h.yA)(C,m).then((n=>{const s="cimRef"===p?(0,h.bo)(n.data):n.data,a=(0,c.rS)(s,E);if(a&&(0,r.wk)(a)){if(A){const e=(0,l.f)(A,S);a.thumbnail=new u.V({url:e})}else R&&(a.thumbnail=new u.V({url:"data:image/png;base64,".concat(R)}));e.styleUrl?a.styleOrigin=new d.A({portal:i.portal,styleUrl:e.styleUrl,name:t}):e.styleName&&(a.styleOrigin=new d.A({portal:i.portal,styleName:e.styleName,name:t}))}return a}))}},19358:(e,t,i)=>{i.d(t,{A:()=>n});var r=i(59422);class n{constructor(e,t,i,n){this.computedX=0,this.computedY=0,this.center=(0,r.fA)(e,t),this.centerT=(0,r.vt)(),this.halfWidth=i/2,this.halfHeight=n/2,this.width=i,this.height=n}get x(){return this.center[0]}get y(){return this.center[1]}get blX(){return this.center[0]+this.halfWidth}get blY(){return this.center[1]+this.halfHeight}get trX(){return this.center[0]-this.halfWidth}get trY(){return this.center[1]-this.halfHeight}get xmin(){return this.x-this.halfWidth}get xmax(){return this.x+this.halfWidth}get ymin(){return this.y-this.halfHeight}get ymax(){return this.y+this.halfHeight}set x(e){this.center[0]=e}set y(e){this.center[1]=e}clone(){return new n(this.x,this.y,this.width,this.height)}serialize(e){return e.writeF32(this.center[0]),e.writeF32(this.center[1]),e.push(this.width),e.push(this.height),e}findCollisionDelta(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:4;const i=Math.abs(e.centerT[0]-this.centerT[0]),r=Math.abs(e.centerT[1]-this.centerT[1]),n=(e.halfWidth+this.halfWidth+t)/i,s=(e.halfHeight+this.halfHeight+t)/r,a=Math.min(n,s);return Math.log2(a)}extend(e){const t=Math.min(this.xmin,e.xmin),i=Math.min(this.ymin,e.ymin),r=Math.max(this.xmax,e.xmax)-t,n=Math.max(this.ymax,e.ymax)-i,s=t+r/2,a=i+n/2;this.width=r,this.height=n,this.halfWidth=r/2,this.halfHeight=n/2,this.x=s,this.y=a}static deserialize(e){const t=e.readF32(),i=e.readF32(),r=e.readInt32(),s=e.readInt32();return new n(t,i,r,s)}}},5095:(e,t,i)=>{i.d(t,{$U:()=>M,C2:()=>h,CQ:()=>n,CR:()=>w,C_:()=>D,Cp:()=>C,DY:()=>c,Gh:()=>T,LY:()=>E,O5:()=>B,Pq:()=>u,Qb:()=>U,Sr:()=>x,TB:()=>Z,Tv:()=>a,Vl:()=>k,Xh:()=>W,YS:()=>f,YV:()=>o,_j:()=>F,_x:()=>H,bg:()=>s,c5:()=>P,dV:()=>R,eG:()=>d,eI:()=>j,fq:()=>V,g0:()=>O,hM:()=>L,ju:()=>l,lL:()=>v,mg:()=>I,n9:()=>b,nM:()=>_,nW:()=>N,qM:()=>r,r1:()=>z,sn:()=>y,uM:()=>g,ue:()=>p,vN:()=>A,vd:()=>S,yv:()=>G,z2:()=>m});const r=1e-30,n=512,s=128,a=511,o=16777216,l=8,c=29,d=24,h=4,u=0,p=0,f=0,g=1,m=2,_=3,v=4,y=5,b=6,x=12,S=5,w=6,C=5,A=6;var R;!function(e){e[e.FilterFlags=0]="FilterFlags",e[e.Animation=1]="Animation",e[e.GPGPU=2]="GPGPU",e[e.VV=3]="VV",e[e.DD0=4]="DD0",e[e.DD1=5]="DD1",e[e.DD2=6]="DD2"}(R||(R={}));const E=8,O=E<<1,T=1.05,P=1,M=5,I=6,D=1.15,L=2,F=128-2*L,N=2,V=10,G=1024,U=128,z=4,B=1,H=1<<20,j=.75,W=10,k=.75,Z=256},49753:(e,t,i)=>{var r,n;function s(e){return null!=e&&!e.running}i.d(t,{c:()=>n,c2:()=>r,pi:()=>s}),function(e){e[e.RENDERING=0]="RENDERING",e[e.FADING=1]="FADING",e[e.FINISHED=2]="FINISHED"}(r||(r={})),function(e){e[e.RG=0]="RG",e[e.BA=1]="BA"}(n||(n={}))},63401:(e,t,i)=>{i.d(t,{OQ:()=>r,ny:()=>f});var r,n=i(15941),s=i(34761),a=i(13191),o=i(20664),l=i(9392),c=i(52896),d=i(14556),h=i(49753),u=i(317),p=i(98476);class f{constructor(){this.readChannels=h.c.RG,this.renderingStage=h.c2.FINISHED,this.startTime=0,this.startTimeHeightFade=0,this.cameraPositionLastFrame=(0,l.vt)(),this.parallax=new g,this.parallaxNew=new g,this.pointOnGround=(0,l.vt)(),this.fadeMode=r.HIDE,this.fadeFactor=0,this.opacity=0}updateParallax(e){const t=this.parallax,i=(0,o.l)(e.eye);if(t.radiusCurvatureCorrectionFactor=.84*Math.sqrt(Math.max(i*i-d.$O.radius*d.$O.radius,0))/i,(0,c.Cr)(m,t.anchorPointClouds,_),(0,s.e$)(t.transform,a.zK,_[3],(0,c.yo)(_)),this.fadeMode===r.CROSS_FADE){const e=this.parallaxNew;(0,c.Cr)(m,e.anchorPointClouds,_),(0,s.e$)(e.transform,a.zK,_[3],(0,c.yo)(_))}}updateFading(e,t,i,r){this.isFading&&this._advanceFading(i,r),this._evaluateFading(e,t,i)}_evaluateFading(e,t,i){const n=e.relativeElevation,s=this._calculateDistanceToAnchorPoint(e);if((n>1.7*u.ni||n<-u.ni||s>S)&&this.opacity>0)this._setFade(r.HIDE,i);else if(!this.isFading)if((n>u.ni||n<-.35*u.ni||s>x)&&this.opacity>0)this._setFade(r.FADE_OUT,i);else if(n<=u.ni&&n>=-.35*u.ni&&t===p.M.IDLE&&(0,h.pi)(this.data)){if(0===this.opacity)return void this._setFade(r.FADE_IN,i);(s>b||this.renderingStage===h.c2.FADING)&&this._setFade(r.CROSS_FADE,i)}}_advanceFading(e,t){this._switchReadChannels(),this._updateAnchorPoint(),this._advanceFadingFactorAndOpacity(e,t)}_advanceFadingFactorAndOpacity(e,t){if(this.fadeFactor<1)return this.fadeFactor=t?(0,n.qE)((e-this.startTime)/(y*t),0,1):1,this.fadeMode===r.FADE_OUT&&(this.opacity=1-this.fadeFactor),this.fadeMode===r.FADE_IN&&(this.opacity=this.fadeFactor),void(this.fadeMode===r.CROSS_FADE&&(this.opacity=1));this.fadeFactor=0,this.fadeMode===r.FADE_OUT&&(this.opacity=0),this.fadeMode===r.FADE_IN&&(this.opacity=1),this.fadeMode===r.CROSS_FADE&&(this.opacity=1),this.fadeMode=r.NONE}_switchReadChannels(){const e=this.fadeMode===r.CROSS_FADE&&1===this.fadeFactor,t=this.fadeMode===r.FADE_IN&&0===this.fadeFactor;this.renderingStage===h.c2.FADING&&(e||t)&&(this.readChannels=1-this.readChannels,this.renderingStage=h.c2.FINISHED)}_calculateDistanceToAnchorPoint(e){return(0,o.n)(this.pointOnGround,e.eye),(0,o.h)(this.pointOnGround,this.pointOnGround,d.$O.radius),(0,o.l)((0,o.f)(v,this.parallax.anchorPointClouds,this.pointOnGround))}_updateAnchorPoint(){this.fadeMode===r.CROSS_FADE&&(0===this.fadeFactor&&(0,o.c)(this.parallaxNew.anchorPointClouds,this.pointOnGround),1===this.fadeFactor&&(0,o.c)(this.parallax.anchorPointClouds,this.parallaxNew.anchorPointClouds)),this.fadeMode===r.FADE_IN&&0===this.fadeFactor&&(0,o.c)(this.parallax.anchorPointClouds,this.pointOnGround)}_setFade(e,t){switch(e){case r.HIDE:this.opacity=0;break;case r.FADE_OUT:this.opacity=1;break;case r.FADE_IN:this.opacity=0;break;case r.CROSS_FADE:this.opacity=1}this.fadeMode=e,this.fadeFactor=0,this.startTime=t}get isFading(){return this.fadeMode===r.FADE_OUT||this.fadeMode===r.FADE_IN||this.fadeMode===r.CROSS_FADE}}!function(e){e[e.NONE=0]="NONE",e[e.HIDE=1]="HIDE",e[e.FADE_OUT=2]="FADE_OUT",e[e.FADE_IN=3]="FADE_IN",e[e.CROSS_FADE=4]="CROSS_FADE"}(r||(r={}));class g{constructor(){this.anchorPointClouds=(0,l.vt)(),this.radiusCurvatureCorrectionFactor=0,this.transform=(0,a.vt)()}}const m=(0,l.fA)(0,0,1),_=(0,c.vt)(),v=(0,l.vt)(),y=1.25,b=34e3,x=64e3,S=2e5},317:(e,t,i)=>{i.d(t,{k9:()=>C,ni:()=>w});var r,n=i(35143),s=i(42553),a=i(46053),o=(i(81806),i(76460),i(47249),i(6409)),l=i(85842);let c=r=class extends s.oY{constructor(e){super(e),this.type="cloudy",this.cloudCover=.5}clone(){return new r({cloudCover:this.cloudCover})}};(0,n._)([(0,o.e)({cloudy:"cloudy"})],c.prototype,"type",void 0),(0,n._)([(0,a.MZ)({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],c.prototype,"cloudCover",void 0),c=r=(0,n._)([(0,l.$)("esri.views.3d.environment.CloudyWeather")],c);const d=c;var h;let u=h=class extends s.oY{constructor(e){super(e),this.type="foggy",this.fogStrength=.5}clone(){return new h({fogStrength:this.fogStrength})}};(0,n._)([(0,o.e)({foggy:"foggy"})],u.prototype,"type",void 0),(0,n._)([(0,a.MZ)({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],u.prototype,"fogStrength",void 0),u=h=(0,n._)([(0,l.$)("esri.views.3d.environment.FoggyWeather")],u);const p=u;var f;let g=f=class extends s.oY{constructor(e){super(e),this.type="rainy",this.cloudCover=.5,this.precipitation=.5}clone(){return new f({cloudCover:this.cloudCover,precipitation:this.precipitation})}};(0,n._)([(0,o.e)({rainy:"rainy"})],g.prototype,"type",void 0),(0,n._)([(0,a.MZ)({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],g.prototype,"cloudCover",void 0),(0,n._)([(0,a.MZ)({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],g.prototype,"precipitation",void 0),g=f=(0,n._)([(0,l.$)("esri.views.3d.environment.RainyWeather")],g);const m=g;var _;let v=_=class extends s.oY{constructor(e){super(e),this.type="snowy",this.cloudCover=.5,this.precipitation=.5,this.snowCover="disabled"}clone(){return new _({cloudCover:this.cloudCover,precipitation:this.precipitation,snowCover:this.snowCover})}};(0,n._)([(0,o.e)({snowy:"snowy"})],v.prototype,"type",void 0),(0,n._)([(0,a.MZ)({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],v.prototype,"cloudCover",void 0),(0,n._)([(0,a.MZ)({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],v.prototype,"precipitation",void 0),(0,n._)([(0,a.MZ)({type:["enabled","disabled"],nonNullable:!0,json:{write:!0}})],v.prototype,"snowCover",void 0),v=_=(0,n._)([(0,l.$)("esri.views.3d.environment.SnowyWeather")],v);const y=v;var b;let x=b=class extends s.oY{constructor(e){super(e),this.type="sunny",this.cloudCover=.5}clone(){return new b({cloudCover:this.cloudCover})}};(0,n._)([(0,o.e)({sunny:"sunny"})],x.prototype,"type",void 0),(0,n._)([(0,a.MZ)({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],x.prototype,"cloudCover",void 0),x=b=(0,n._)([(0,l.$)("esri.views.3d.environment.SunnyWeather")],x);const S={key:"type",base:x,typeMap:{sunny:x,cloudy:d,rainy:m,snowy:y,foggy:p}};Object.keys(S.typeMap);const w=1e4,C=1e5},21734:(e,t,i)=>{i.r(t),i.d(t,{destroyContext:()=>b,dracoDecompressPointCloudData:()=>f,filterObbsForModifications:()=>g,filterObbsForModificationsSync:()=>R,initialize:()=>T,interpretObbModificationResults:()=>A,process:()=>p,project:()=>v,setLegacySchema:()=>_,setModifications:()=>m,setModificationsSync:()=>w,test:()=>M,transformNormals:()=>y});var r=i(13312),n=i(44815),s=i(14894),a=i(5845),o=i(45136),l=i(11941),c=i(28899);function d(e){return(0,c.s)("esri/libs/i3s/".concat(e))}let h;var u=i(12119);async function p(e){S=await P();const t=[e.geometryBuffer];return{result:C(S,e,t),transferList:t}}async function f(e){var t;S=await P();const i=[e.geometryBuffer],{geometryBuffer:r}=e,n=r.byteLength,s=S._malloc(n),a=new Uint8Array(S.HEAPU8.buffer,s,n);a.set(new Uint8Array(r));const o=S.dracoDecompressPointCloudData(s,a.byteLength);if(S._free(s),o.error.length>0)throw new Error("i3s.wasm: ".concat(o.error));const l=(null===(t=o.featureIds)||void 0===t?void 0:t.length)>0?o.featureIds.slice():null,c=o.positions.slice();return l&&i.push(l.buffer),i.push(c.buffer),{result:{positions:c,featureIds:l},transferList:i}}async function g(e){await P(),R(e);const t={buffer:e.buffer};return{result:t,transferList:[t.buffer]}}async function m(e){await P(),w(e)}async function _(e){S=await P(),S.setLegacySchema(e.context,e.jsonSchema)}async function v(e){const{localMatrix:t,origin:o,positions:l,vertexSpace:c,localMode:d}=e,h=r.A.fromJSON(e.inSpatialReference),u=r.A.fromJSON(e.outSpatialReference);let p;if("georeferenced"===c.type&&null==c.origin){const[{projectBuffer:e},{initializeProjection:t}]=await Promise.all([Promise.resolve().then(i.bind(i,45308)),Promise.resolve().then(i.bind(i,9624))]);await t(h,u),p=new Float64Array(l.length),e(l,h,0,p,u,0,p.length/3)}else{const e="georeferenced"===c.type?s.A.fromJSON(c):a.A.fromJSON(c),{project:r}=await Promise.all([i.e(8105),i.e(8620)]).then(i.bind(i,48620));p=(0,n.Ns)(r({positions:l,transform:t?{localMatrix:t}:void 0,vertexSpace:e,inSpatialReference:h,outSpatialReference:u,localMode:d}))}const f=p.length,[g,m,_]=o;for(let i=0;i<f;i+=3)p[i]-=g,p[i+1]-=m,p[i+2]-=_;return{result:{projected:p,original:l},transferList:[p.buffer,l.buffer]}}async function y(e){let{normalMatrix:t,normals:i}=e;const r=new Float32Array(i.length);return(0,o.b)(r,i,t),(0,o.n)(r,r),{result:{transformed:r,original:i},transferList:[r.buffer,i.buffer]}}function b(e){E(e)}let x,S;function w(e){if(!S)return;const t=e.modifications,i=S._malloc(8*t.length),r=new Float64Array(S.HEAPU8.buffer,i,t.length);for(let n=0;n<t.length;++n)r[n]=t[n];S.setModifications(e.context,i,t.length,e.isGeodetic),S._free(i)}function C(e,t,i){const{context:r,localOrigin:n,globalTrafo:s,mbs:a,obbData:o,elevationOffset:c,geometryBuffer:d,geometryDescriptor:h,indexToVertexProjector:u,vertexToRenderProjector:p}=t,f=e._malloc(d.byteLength),g=e._malloc(33*Float64Array.BYTES_PER_ELEMENT),m=new Uint8Array(e.HEAPU8.buffer,f,d.byteLength);m.set(new Uint8Array(d));const _=new Float64Array(e.HEAPU8.buffer,g,33);O(_,n);let v=_.byteOffset+3*_.BYTES_PER_ELEMENT,y=new Float64Array(_.buffer,v);O(y,s),v+=16*_.BYTES_PER_ELEMENT,y=new Float64Array(_.buffer,v),O(y,a),v+=4*_.BYTES_PER_ELEMENT,o&&(y=new Float64Array(_.buffer,v),O(y,o));const b=h,x={isDraco:!1,isLegacy:!1,color:t.layouts.some((e=>e.some((e=>"color"===e.name)))),normal:t.needNormals&&t.layouts.some((e=>e.some((e=>"normalCompressed"===e.name)))),uv0:t.layouts.some((e=>e.some((e=>"uv0"===e.name)))),uvRegion:t.layouts.some((e=>e.some((e=>"uvRegion"===e.name)))),featureIndex:b.featureIndex},S=e.process(r,!!t.obbData,f,m.byteLength,b,x,g,c,u,p,t.normalReferenceFrame);if(e._free(g),e._free(f),S.error.length>0)throw new Error("i3s.wasm: ".concat(S.error));if(S.discarded)return null;const w=S.componentOffsets.length>0?S.componentOffsets.slice():null,C=S.featureIds.length>0?S.featureIds.slice():null,A=S.anchorIds.length>0?Array.from(S.anchorIds):null,R=S.anchors.length>0?Array.from(S.anchors):null,E=S.interleavedVertedData.slice().buffer,T=S.indicesType===l.f.Int16?new Uint16Array(S.indices.buffer,S.indices.byteOffset,S.indices.byteLength/2).slice():new Uint32Array(S.indices.buffer,S.indices.byteOffset,S.indices.byteLength/4).slice(),P=S.positions.slice(),M=S.positionIndicesType===l.f.Int16?new Uint16Array(S.positionIndices.buffer,S.positionIndices.byteOffset,S.positionIndices.byteLength/2).slice():new Uint32Array(S.positionIndices.buffer,S.positionIndices.byteOffset,S.positionIndices.byteLength/4).slice(),I={layout:t.layouts[0],interleavedVertexData:E,indices:T,hasColors:S.hasColors,hasModifications:S.hasModifications,positionData:{data:P,indices:M}};return C&&i.push(C.buffer),w&&i.push(w.buffer),i.push(E),i.push(T.buffer),i.push(P.buffer),i.push(M.buffer),{componentOffsets:w,featureIds:C,anchorIds:A,anchors:R,transformedGeometry:I,obb:S.obb}}function A(e){return 0===e?u.Js.Unmodified:1===e?u.Js.PotentiallyModified:2===e?u.Js.Culled:u.Js.Unknown}function R(e){if(!S)return;const{context:t,buffer:i}=e,r=S._malloc(i.byteLength),n=i.byteLength/Float64Array.BYTES_PER_ELEMENT,s=new Float64Array(S.HEAPU8.buffer,r,n),a=new Float64Array(i);s.set(a),S.filterOBBs(t,r,n),a.set(s),S._free(r)}function E(e){S&&0===S.destroy(e)&&(S=null)}function O(e,t){for(let i=0;i<t.length;++i)e[i]=t[i]}async function T(){S||await P()}function P(){return S?Promise.resolve(S):(x||(x=(h||(h=new Promise((e=>i.e(7258).then(i.bind(i,77258)).then((e=>e.i)).then((t=>{let{default:i}=t;const r=i({locateFile:d,onRuntimeInitialized:()=>e(r)});delete r.then})))).catch((e=>{throw e}))),h).then((e=>(S=e,x=null,S)))),x)}const M={transform:(e,t)=>S&&C(S,e,t),destroy:E}},12119:(e,t,i)=>{i.d(t,{EG:()=>f,Js:()=>n,TJ:()=>r,UY:()=>o,ay:()=>u,bP:()=>p,cJ:()=>a,iF:()=>s});var r,n,s,a,o,l=i(55855),c=i(93582),d=i(74279),h=i(95225);class u extends h.H{constructor(e,t){super(NaN,NaN),this.id=e,this.serviceMbsInIndexSR=t,this.serviceMbsInRenderSR=(0,c.f)(0,0,0,-1)}invalidateServiceBVsInRenderSR(){var e;(0,d.Q7)(this.serviceMbsInRenderSR),null===(e=this.serviceObbInRenderSR)||void 0===e||e.invalidate()}shareServiceBVsInRenderSRWith(e){this.serviceObbInRenderSR=e.serviceObbInRenderSR,this.serviceMbsInRenderSR=e.serviceMbsInRenderSR}}!function(e){e[e.Unmodified=0]="Unmodified",e[e.Culled=1]="Culled",e[e.NotChecked=2]="NotChecked"}(r||(r={})),function(e){e[e.Unmodified=0]="Unmodified",e[e.PotentiallyModified=1]="PotentiallyModified",e[e.Culled=2]="Culled",e[e.Unknown=3]="Unknown",e[e.NotChecked=4]="NotChecked"}(n||(n={}));class p extends u{constructor(e,t,i,r,a,o,c,d,h,u){super(e,i),this.index=t,this.childCount=r,this.level=a,this.resources=o,this.version=c,this.lodMetric=d,this.maxError=h,this.numFeatures=u,this.failed=!1,this.cacheState=s.Unknown,this.vertexCount=0,this.memory=0,this.childrenLoaded=0,this.hasModifications=!1,this.imModificationImpact=n.NotChecked,this.elevationAgnosticBoundingVolume=(0,l.fA)(0,0,0,-1)}invalidateServiceBVsInRenderSR(){super.invalidateServiceBVsInRenderSR(),this.elevationAgnosticBoundingVolume[3]=-1}}!function(e){e[e.Unknown=0]="Unknown",e[e.Uncached=1]="Uncached",e[e.Cached=2]="Cached"}(s||(s={})),function(e){e[e.None=0]="None",e[e.MaxScreenThreshold=1]="MaxScreenThreshold",e[e.ScreenSpaceRelative=2]="ScreenSpaceRelative",e[e.RemovedFeatureDiameter=3]="RemovedFeatureDiameter",e[e.DistanceRangeFromDefaultCamera=4]="DistanceRangeFromDefaultCamera"}(a||(a={})),function(e){e[e.Hole=0]="Hole",e[e.Leaf=1]="Leaf"}(o||(o={}));class f{constructor(e,t,i,r){this.nodeHasLOD=e,this.isChosen=t,this.lodLevel=i,this.version=r}}},95225:(e,t,i)=>{i.d(t,{H:()=>r});class r{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1/0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:-1/0;this.elevationRangeMin=e,this.elevationRangeMax=t}get elevationRangeValid(){return!Number.isNaN(this.elevationRangeMin)}invalidateElevationRange(){this.elevationRangeMin=NaN}expandElevationRangeValues(e,t){this.elevationRangeMin=Math.min(this.elevationRangeMin,e),this.elevationRangeMax=Math.max(this.elevationRangeMax,t)}expandElevationRange(e){this.elevationRangeMin=Math.min(this.elevationRangeMin,e.elevationRangeMin),this.elevationRangeMax=Math.max(this.elevationRangeMax,e.elevationRangeMax)}setElevationRange(e){this.elevationRangeMin=e.elevationRangeMin,this.elevationRangeMax=e.elevationRangeMax}}},57481:(e,t,i)=>{i.d(t,{U:()=>s});var r=i(93345),n=i(21812);function s(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;const i=e.stride;return Array.from(e.fields.keys()).map((r=>{const s=e.fields.get(r),o=s.constructor.ElementCount,l=a(s.constructor.ElementType),c=s.offset,d=!(!s.optional||!s.optional.glNormalized);return new n._(r,o,l,c,i,d,t)}))}function a(e){const t=o[e];if(t)return t;throw new Error("BufferType not supported in WebGL")}const o={u8:r.pe.UNSIGNED_BYTE,u16:r.pe.UNSIGNED_SHORT,u32:r.pe.UNSIGNED_INT,i8:r.pe.BYTE,i16:r.pe.SHORT,i32:r.pe.INT,f32:r.pe.FLOAT}},99443:(e,t,i)=>{i.d(t,{Cz:()=>n,DZ:()=>o,PV:()=>a,vO:()=>r});i(72900),i(93345),i(98433),i(96673);const r=64,n=r/2,s=n/5,a=r/s,o=.25},72900:(e,t,i)=>{i.d(t,{CN:()=>o,Q_:()=>a,ny:()=>l,sZ:()=>c});i(81806);var r=i(14522),n=i(96897),s=i(93345);const a=128,o=.5;function l(e){return"cross"===e||"x"===e}function c(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:a;const i=d(e,t,arguments.length>2&&void 0!==arguments[2]?arguments[2]:t*o,arguments.length>3&&void 0!==arguments[3]?arguments[3]:0);return new n.g(i,{mipmap:!1,wrap:{s:s.pF.CLAMP_TO_EDGE,t:s.pF.CLAMP_TO_EDGE},width:t,height:t,components:4,noUnpackFlip:!0,reloadable:!0})}function d(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:a,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:t*o,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;switch(e){case"circle":default:return function(e,t){const i=e/2-.5;return g(e,p(i,i,t/2))}(t,i);case"square":return function(e,t){return h(e,t,!1)}(t,i);case"cross":return function(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return u(e,t,!1,i)}(t,i,r);case"x":return function(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return u(e,t,!0,i)}(t,i,r);case"kite":return function(e,t){return h(e,t,!0)}(t,i);case"triangle":return function(e,t){return g(e,f(e/2,t,t/2))}(t,i);case"arrow":return function(e,t){const i=t,r=t/2,n=e/2,s=.8*i,a=p(n,(e-t)/2-s,Math.sqrt(s*s+r*r)),o=f(n,i,r);return g(e,((e,t)=>Math.max(o(e,t),-a(e,t))))}(t,i)}}function h(e,t,i){return i&&(t/=Math.SQRT2),g(e,((r,n)=>{let s=r-.5*e+.25,a=.5*e-n-.75;if(i){const e=(s+a)/Math.SQRT2;a=(a-s)/Math.SQRT2,s=e}return Math.max(Math.abs(s),Math.abs(a))-.5*t}))}function u(e,t,i){let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;t-=r,i&&(t*=Math.SQRT2);const n=.5*t;return g(e,((t,s)=>{let a,o=t-.5*e,l=.5*e-s-1;if(i){const e=(o+l)/Math.SQRT2;l=(l-o)/Math.SQRT2,o=e}return o=Math.abs(o),l=Math.abs(l),a=o>l?o>n?Math.sqrt((o-n)*(o-n)+l*l):l:l>n?Math.sqrt(o*o+(l-n)*(l-n)):o,a-=r/2,a}))}function p(e,t,i){return(r,n)=>{const s=r-e,a=n-t;return Math.sqrt(s*s+a*a)-i}}function f(e,t,i){const r=Math.sqrt(t*t+i*i);return(n,s)=>{const a=Math.abs(n-e)-i,o=s-e+t/2+.75,l=(t*a+i*o)/r,c=-o;return Math.max(l,c)}}function g(e,t){const i=new Uint8Array(4*e*e);for(let n=0;n<e;n++)for(let s=0;s<e;s++){const a=s+e*n;let o=t(s,n);o=o/e+.5,(0,r.U)(o,i,4*a)}return i}},19539:(e,t,i)=>{var r,n,s,a;i.d(t,{vr:()=>r}),function(e){e[e.INNER=0]="INNER",e[e.OUTER=1]="OUTER"}(r||(r={})),function(e){e[e.REGULAR=0]="REGULAR",e[e.HAS_NORTH_POLE=1]="HAS_NORTH_POLE",e[e.HAS_SOUTH_POLE=2]="HAS_SOUTH_POLE",e[e.HAS_BOTH_POLES=3]="HAS_BOTH_POLES"}(n||(n={})),function(e){e[e.OFF=0]="OFF",e[e.ON=1]="ON"}(s||(s={})),function(e){e[e.FADING=0]="FADING",e[e.IMMEDIATE=1]="IMMEDIATE",e[e.UNFADED=2]="UNFADED"}(a||(a={}))},85887:(e,t,i)=>{i.d(t,{H:()=>A,W:()=>R});var r,n,s,a,o,l,c,d,h,u,p,f=i(57528),g=i(72745),m=i(838),_=i(95756),v=i(5517),y=i(66701),b=i(60205),x=i(64839),S=i(66470),w=i(93684);const C=8;function A(e,t){const i=S.r.FEATUREVALUE;e.attributes.add(i,"vec4");const g=e.vertex;g.code.add((0,x.H)(r||(r=(0,f.A)(["\n  bool isCapVertex() {\n    return ",".w == 1.0;\n  }\n  "])),i)),g.uniforms.add(new _.G("size",(e=>e.size))),t.vvSize?(g.uniforms.add(new v.t("vvSizeMinSize",(e=>e.vvSize.minSize)),new v.t("vvSizeMaxSize",(e=>e.vvSize.maxSize)),new v.t("vvSizeOffset",(e=>e.vvSize.offset)),new v.t("vvSizeFactor",(e=>e.vvSize.factor))),g.code.add((0,x.H)(n||(n=(0,f.A)(["\n    vec2 getSize() {\n      return size * clamp(vvSizeOffset + ",".x * vvSizeFactor, vvSizeMinSize, vvSizeMaxSize).xz;\n    }\n    "])),i))):g.code.add((0,x.H)(s||(s=(0,f.A)(["vec2 getSize(){\nreturn size;\n}"])))),t.vvOpacity?(g.constants.add("vvOpacityNumber","int",C),g.uniforms.add(new b.x("vvOpacityValues",(e=>e.vvOpacity.values),C),new b.x("vvOpacityOpacities",(e=>e.vvOpacity.opacityValues),C)),g.code.add((0,x.H)(a||(a=(0,f.A)(["\n    vec4 applyOpacity(vec4 color) {\n      float value = ",".z;\n      if (value <= vvOpacityValues[0]) {\n        return vec4( color.xyz, vvOpacityOpacities[0]);\n      }\n\n      for (int i = 1; i < vvOpacityNumber; ++i) {\n        if (vvOpacityValues[i] >= value) {\n          float f = (value - vvOpacityValues[i-1]) / (vvOpacityValues[i] - vvOpacityValues[i-1]);\n          return vec4( color.xyz, mix(vvOpacityOpacities[i-1], vvOpacityOpacities[i], f));\n        }\n      }\n\n      return vec4( color.xyz, vvOpacityOpacities[vvOpacityNumber - 1]);\n    }\n    "])),i))):g.code.add((0,x.H)(o||(o=(0,f.A)(["vec4 applyOpacity(vec4 color){\nreturn color;\n}"])))),t.vvColor?(g.constants.add("vvColorNumber","int",w.p),g.uniforms.add(new b.x("vvColorValues",(e=>e.vvColor.values),w.p),new y.F("vvColorColors",(e=>e.vvColor.colors),w.p)),g.code.add((0,x.H)(l||(l=(0,f.A)(["\n    vec4 getColor() {\n      float value = ",".y;\n      if (value <= vvColorValues[0]) {\n        return applyOpacity(vvColorColors[0]);\n      }\n\n      for (int i = 1; i < vvColorNumber; ++i) {\n        if (vvColorValues[i] >= value) {\n          float f = (value - vvColorValues[i-1]) / (vvColorValues[i] - vvColorValues[i-1]);\n          return applyOpacity(mix(vvColorColors[i-1], vvColorColors[i], f));\n        }\n      }\n\n      return applyOpacity(vvColorColors[vvColorNumber - 1]);\n    }\n    "])),i))):g.code.add((0,x.H)(c||(c=(0,f.A)(["vec4 getColor(){\nreturn applyOpacity(vec4(1, 1, 1, 1));\n}"])))),e.include(m.I),e.attributes.add(S.r.PROFILERIGHT,"vec4"),e.attributes.add(S.r.PROFILEUP,"vec4"),e.attributes.add(S.r.PROFILEVERTEXANDNORMAL,"vec4"),g.code.add((0,x.H)(d||(d=(0,f.A)(["vec3 calculateVPos() {\nvec2 size = getSize();\nvec3 origin = position;\nvec3 right = profileRight.xyz;\nvec3 up = profileUp.xyz;\nvec3 forward = cross(up, right);\nvec2 profileVertex = profileVertexAndNormal.xy * size;\nvec2 profileNormal = profileVertexAndNormal.zw;\nfloat positionOffsetAlongProfilePlaneNormal = 0.0;\nfloat normalOffsetAlongProfilePlaneNormal = 0.0;"])))),g.code.add((0,x.H)(h||(h=(0,f.A)(["if(!isCapVertex()) {\nvec2 rotationRight = vec2(profileRight.w, profileUp.w);\nfloat maxDistance = length(rotationRight);"])))),g.code.add((0,x.H)(u||(u=(0,f.A)(["rotationRight = maxDistance > 0.0 ? normalize(rotationRight) : vec2(0, 0);\nfloat rx = dot(profileVertex, rotationRight);\nif (abs(rx) > maxDistance) {\nvec2 rotationUp = vec2(-rotationRight.y, rotationRight.x);\nfloat ry = dot(profileVertex, rotationUp);\nprofileVertex = rotationRight * maxDistance * sign(rx) + rotationUp * ry;\n}\n}else{\npositionOffsetAlongProfilePlaneNormal = profileRight.w * size[0];\nnormalOffsetAlongProfilePlaneNormal = profileUp.w;\n}\nvec3 offset = right * profileVertex.x + up * profileVertex.y + forward * positionOffsetAlongProfilePlaneNormal;\nreturn origin + offset;\n}"])))),g.code.add((0,x.H)(p||(p=(0,f.A)(["vec3 localNormal() {\nvec3 right = profileRight.xyz;\nvec3 up = profileUp.xyz;\nvec3 forward = cross(up, right);\nvec2 profileNormal = profileVertexAndNormal.zw;\nvec3 normal = right * profileNormal.x + up * profileNormal.y;\nif(isCapVertex()) {\nnormal += forward * profileUp.w;\n}\nreturn normal;\n}"]))))}class R extends w.S{constructor(){super(...arguments),this.size=(0,g.fA)(1,1)}}},3838:(e,t,i)=>{i.d(t,{s:()=>_});var r,n,s,a,o,l,c=i(57528),d=i(66763),h=i(5517),u=i(21390),p=i(60205),f=i(64839),g=i(66470);const m=8;function _(e,t){const i=e.vertex;i.uniforms.add(new u.m("intrinsicWidth",(e=>e.width))),t.vvSize?(e.attributes.add(g.r.SIZEFEATUREATTRIBUTE,"float"),i.uniforms.add(new h.t("vvSizeMinSize",(e=>e.vvSize.minSize)),new h.t("vvSizeMaxSize",(e=>e.vvSize.maxSize)),new h.t("vvSizeOffset",(e=>e.vvSize.offset)),new h.t("vvSizeFactor",(e=>e.vvSize.factor))),i.code.add((0,f.H)(r||(r=(0,c.A)(["float getSize() {\nreturn intrinsicWidth * clamp(vvSizeOffset + sizeFeatureAttribute * vvSizeFactor, vvSizeMinSize, vvSizeMaxSize).x;\n}"]))))):(e.attributes.add(g.r.SIZE,"float"),i.code.add((0,f.H)(n||(n=(0,c.A)(["float getSize(){\nreturn intrinsicWidth * size;\n}"]))))),t.vvOpacity?(e.attributes.add(g.r.OPACITYFEATUREATTRIBUTE,"float"),i.constants.add("vvOpacityNumber","int",8),i.uniforms.add(new p.x("vvOpacityValues",(e=>e.vvOpacity.values),m),new p.x("vvOpacityOpacities",(e=>e.vvOpacity.opacityValues),m)),i.code.add((0,f.H)(s||(s=(0,c.A)(["float interpolateOpacity( float value ){\nif (value <= vvOpacityValues[0]) {\nreturn vvOpacityOpacities[0];\n}\nfor (int i = 1; i < vvOpacityNumber; ++i) {\nif (vvOpacityValues[i] >= value) {\nfloat f = (value - vvOpacityValues[i-1]) / (vvOpacityValues[i] - vvOpacityValues[i-1]);\nreturn mix(vvOpacityOpacities[i-1], vvOpacityOpacities[i], f);\n}\n}\nreturn vvOpacityOpacities[vvOpacityNumber - 1];\n}\nvec4 applyOpacity( vec4 color ){\nreturn vec4(color.xyz, interpolateOpacity(opacityFeatureAttribute));\n}"]))))):i.code.add((0,f.H)(a||(a=(0,c.A)(["vec4 applyOpacity( vec4 color ){\nreturn color;\n}"])))),t.vvColor?(e.include(d.A,t),e.attributes.add(g.r.COLORFEATUREATTRIBUTE,"float"),i.code.add((0,f.H)(o||(o=(0,c.A)(["vec4 getColor(){\nreturn applyOpacity(interpolateVVColor(colorFeatureAttribute));\n}"]))))):(e.attributes.add(g.r.COLOR,"vec4"),i.code.add((0,f.H)(l||(l=(0,c.A)(["vec4 getColor(){\nreturn applyOpacity(color);\n}"])))))}},98720:(e,t,i)=>{i.d(t,{K:()=>l});var r,n,s=i(57528),a=i(53736),o=i(64839);function l(e){e.uniforms.add(new a.e("alignPixelEnabled",((e,t)=>t.alignPixelEnabled))),e.code.add((0,o.H)(r||(r=(0,s.A)(["vec4 alignToPixelCenter(vec4 clipCoord, vec2 widthHeight) {\nif (!alignPixelEnabled)\nreturn clipCoord;\nvec2 xy = vec2(0.500123) + 0.5 * clipCoord.xy / clipCoord.w;\nvec2 pixelSz = vec2(1.0) / widthHeight;\nvec2 ij = (floor(xy * widthHeight) + vec2(0.5)) * pixelSz;\nvec2 result = (ij * 2.0 - vec2(1.0)) * clipCoord.w;\nreturn vec4(result, clipCoord.zw);\n}"])))),e.code.add((0,o.H)(n||(n=(0,s.A)(["vec4 alignToPixelOrigin(vec4 clipCoord, vec2 widthHeight) {\nif (!alignPixelEnabled)\nreturn clipCoord;\nvec2 xy = vec2(0.5) + 0.5 * clipCoord.xy / clipCoord.w;\nvec2 pixelSz = vec2(1.0) / widthHeight;\nvec2 ij = floor((xy + 0.5 * pixelSz) * widthHeight) * pixelSz;\nvec2 result = (ij * 2.0 - vec2(1.0)) * clipCoord.w;\nreturn vec4(result, clipCoord.zw);\n}"]))))}},40318:(e,t,i)=>{i.d(t,{Q:()=>y,R:()=>v});var r,n,s,a,o,l,c,d=i(57528),h=i(25530),u=i(69817),p=i(42451),f=i(58350),g=i(21390),m=i(64839),_=i(66470);const v=.5;function y(e,t){e.include(u.Y6),e.attributes.add(_.r.POSITION,"vec3"),e.attributes.add(_.r.NORMAL,"vec3"),e.attributes.add(_.r.CENTEROFFSETANDDISTANCE,"vec4");const i=e.vertex;(0,p.NB)(i,t),(0,p.yu)(i,t),i.uniforms.add(new f.E("viewport",((e,t)=>t.camera.fullViewport)),new g.m("polygonOffset",(e=>e.shaderPolygonOffset)),new g.m("cameraGroundRelative",((e,t)=>t.camera.aboveGround?1:-1))),t.hasVerticalOffset&&(0,h.V)(i),i.constants.add("smallOffsetAngle","float",.984807753012208),i.code.add((0,m.H)(r||(r=(0,d.A)(["struct ProjectHUDAux {\nvec3 posModel;\nvec3 posView;\nvec3 vnormal;\nfloat distanceToCamera;\nfloat absCosAngle;\n};"])))),i.code.add((0,m.H)(n||(n=(0,d.A)(["\n    float applyHUDViewDependentPolygonOffset(float pointGroundDistance, float absCosAngle, inout vec3 posView) {\n      float pointGroundSign = ",";\n      if (pointGroundSign == 0.0) {\n        pointGroundSign = cameraGroundRelative;\n      }\n\n      // cameraGroundRelative is -1 if camera is below ground, 1 if above ground\n      // groundRelative is 1 if both camera and symbol are on the same side of the ground, -1 otherwise\n      float groundRelative = cameraGroundRelative * pointGroundSign;\n\n      // view angle dependent part of polygon offset emulation: we take the absolute value because the sign that is\n      // dropped is instead introduced using the ground-relative position of the symbol and the camera\n      if (polygonOffset > .0) {\n        float cosAlpha = clamp(absCosAngle, 0.01, 1.0);\n        float tanAlpha = sqrt(1.0 - cosAlpha * cosAlpha) / cosAlpha;\n        float factor = (1.0 - tanAlpha / viewport[2]);\n\n        // same side of the terrain\n        if (groundRelative > 0.0) {\n          posView *= factor;\n        }\n        // opposite sides of the terrain\n        else {\n          posView /= factor;\n        }\n      }\n\n      return groundRelative;\n    }\n  "])),t.multipassEnabled?m.H.float(0):(0,m.H)(s||(s=(0,d.A)(["sign(pointGroundDistance)"]))))),t.draped&&!t.hasVerticalOffset||(0,p.S7)(i),t.draped||(i.uniforms.add(new g.m("perDistancePixelRatio",((e,t)=>Math.tan(t.camera.fovY/2)/(t.camera.fullViewport[2]/2)))),i.code.add((0,m.H)(a||(a=(0,d.A)(["\n    void applyHUDVerticalGroundOffset(vec3 normalModel, inout vec3 posModel, inout vec3 posView) {\n      float distanceToCamera = length(posView);\n\n      // Compute offset in world units for a half pixel shift\n      float pixelOffset = distanceToCamera * perDistancePixelRatio * ",";\n\n      // Apply offset along normal in the direction away from the ground surface\n      vec3 modelOffset = normalModel * cameraGroundRelative * pixelOffset;\n\n      // Apply the same offset also on the view space position\n      vec3 viewOffset = (viewNormal * vec4(modelOffset, 1.0)).xyz;\n\n      posModel += modelOffset;\n      posView += viewOffset;\n    }\n  "])),m.H.float(v)))),t.screenCenterOffsetUnitsEnabled&&(0,p.Nz)(i),t.hasScreenSizePerspective&&(0,u.OH)(i),i.code.add((0,m.H)(o||(o=(0,d.A)(["\n    vec4 projectPositionHUD(out ProjectHUDAux aux) {\n      vec3 centerOffset = centerOffsetAndDistance.xyz;\n      float pointGroundDistance = centerOffsetAndDistance.w;\n\n      aux.posModel = position;\n      aux.posView = (view * vec4(aux.posModel, 1.0)).xyz;\n      aux.vnormal = normal;\n      ","\n\n      // Screen sized offset in world space, used for example for line callouts\n      // Note: keep this implementation in sync with the CPU implementation, see\n      //   - MaterialUtil.verticalOffsetAtDistance\n      //   - HUDMaterial.applyVerticalOffsetTransformation\n\n      aux.distanceToCamera = length(aux.posView);\n\n      vec3 viewDirObjSpace = normalize(cameraPosition - aux.posModel);\n      float cosAngle = dot(aux.vnormal, viewDirObjSpace);\n\n      aux.absCosAngle = abs(cosAngle);\n\n      ","\n\n      ","\n\n      ","\n\n      float groundRelative = applyHUDViewDependentPolygonOffset(pointGroundDistance, aux.absCosAngle, aux.posView);\n\n      ","\n\n      vec4 posProj = proj * vec4(aux.posView, 1.0);\n\n      ","\n\n      ","\n\n      // constant part of polygon offset emulation\n      posProj.z -= groundRelative * polygonOffset * posProj.w;\n      return posProj;\n    }\n  "])),t.draped?"":"applyHUDVerticalGroundOffset(aux.vnormal, aux.posModel, aux.posView);",t.hasScreenSizePerspective&&(t.hasVerticalOffset||t.screenCenterOffsetUnitsEnabled)?"vec3 perspectiveFactor = screenSizePerspectiveScaleFactor(aux.absCosAngle, aux.distanceToCamera, screenSizePerspectiveAlignment);":"",t.hasVerticalOffset?t.hasScreenSizePerspective?"float verticalOffsetScreenHeight = applyScreenSizePerspectiveScaleFactorFloat(verticalOffset.x, perspectiveFactor);":"float verticalOffsetScreenHeight = verticalOffset.x;":"",t.hasVerticalOffset?(0,m.H)(l||(l=(0,d.A)(["\n            float worldOffset = clamp(verticalOffsetScreenHeight * verticalOffset.y * aux.distanceToCamera, verticalOffset.z, verticalOffset.w);\n            vec3 modelOffset = aux.vnormal * worldOffset;\n            aux.posModel += modelOffset;\n            vec3 viewOffset = (viewNormal * vec4(modelOffset, 1.0)).xyz;\n            aux.posView += viewOffset;\n            // Since we elevate the object, we need to take that into account\n            // in the distance to ground\n            pointGroundDistance += worldOffset;"]))):"",t.screenCenterOffsetUnitsEnabled?"":(0,m.H)(c||(c=(0,d.A)(["\n            // Apply x/y in view space, but z in screen space (i.e. along posView direction)\n            aux.posView += vec3(centerOffset.x, centerOffset.y, 0.0);\n\n            // Same material all have same z != 0.0 condition so should not lead to\n            // branch fragmentation and will save a normalization if it's not needed\n            if (centerOffset.z != 0.0) {\n              aux.posView -= normalize(aux.posView) * centerOffset.z;\n            }\n          "]))),t.screenCenterOffsetUnitsEnabled?t.hasScreenSizePerspective?"float centerOffsetY = applyScreenSizePerspectiveScaleFactorFloat(centerOffset.y, perspectiveFactor);":"float centerOffsetY = centerOffset.y;":"",t.screenCenterOffsetUnitsEnabled?"posProj.xy += vec2(centerOffset.x, centerOffsetY) * pixelRatio * 2.0 / viewport.zw * posProj.w;":""))}},38280:(e,t,i)=>{i.d(t,{I:()=>u});var r,n,s,a,o=i(57528),l=i(98720),c=i(10708),d=i(81993),h=i(64839);function u(e,t){const{vertex:i,fragment:u}=e;i.include(l.K),t.multipassEnabled&&(i.include(c.H),e.varyings.add("depth","float")),i.code.add((0,h.H)(r||(r=(0,o.A)(["\n  void main(void) {\n    vec4 posProjCenter;\n    if (dot(position, position) > 0.0) {\n      // Render single point to center of the pixel to avoid subpixel filtering to affect the marker color\n      ProjectHUDAux projectAux;\n      vec4 posProj = projectPositionHUD(projectAux);\n      posProjCenter = alignToPixelCenter(posProj, viewport.zw);\n\n      ","\n\n      ","\n      vec3 vpos = projectAux.posModel;\n      if (rejectBySlice(vpos)) {\n        // Project out of clip space\n        posProjCenter = vec4(1e038, 1e038, 1e038, 1.0);\n      }\n\n    } else {\n      // Project out of clip space\n      posProjCenter = vec4(1e038, 1e038, 1e038, 1.0);\n    }\n\n    gl_Position = posProjCenter;\n    gl_PointSize = 1.0;\n  }\n  "])),t.multipassEnabled?(0,h.H)(n||(n=(0,o.A)(["\n        // Don't draw vertices behind geometry\n        if(geometryDepthTest(.5 + .5 * posProjCenter.xy / posProjCenter.w, projectAux.posView.z)){\n          posProjCenter = vec4(1e038, 1e038, 1e038, 1.0);\n        }"]))):"",t.multipassEnabled?"depth = projectAux.posView.z;":"")),e.include(d.Q,t),u.code.add((0,h.H)(s||(s=(0,o.A)(["\n  void main() {\n    fragColor = vec4(1);\n    ","\n  }\n  "])),t.multipassEnabled?(0,h.H)(a||(a=(0,o.A)(["\n        if(terrainDepthTest(depth)) {\n          fragColor.g = 0.5;\n        }"]))):""))}},98521:(e,t,i)=>{var r;i.d(t,{D:()=>r}),function(e){e[e.Occluded=0]="Occluded",e[e.NotOccluded=1]="NotOccluded",e[e.Both=2]="Both",e[e.COUNT=3]="COUNT"}(r||(r={}))},62374:(e,t,i)=>{i.d(t,{y:()=>h});var r,n=i(57528),s=i(98720),a=i(98521),o=i(58350),l=i(21390),c=i(64839),d=i(70367);function h(e){e.vertex.uniforms.add(new l.m("renderTransparentlyOccludedHUD",((e,t)=>t.hudRenderStyle===a.D.Occluded?1:t.hudRenderStyle===a.D.NotOccluded?0:.75)),new o.E("viewport",((e,t)=>t.camera.fullViewport)),new d.N("hudVisibilityTexture",((e,t)=>{var i;return null===(i=t.hudVisibility)||void 0===i?void 0:i.getTexture()}))),e.vertex.include(s.K),e.vertex.code.add((0,c.H)(r||(r=(0,n.A)(["bool testHUDVisibility(vec4 posProj) {\nvec4 posProjCenter = alignToPixelCenter(posProj, viewport.zw);\nvec4 occlusionPixel = texture(hudVisibilityTexture, .5 + .5 * posProjCenter.xy / posProjCenter.w);\nif (renderTransparentlyOccludedHUD > 0.5) {\nreturn occlusionPixel.r * occlusionPixel.g > 0.0 && occlusionPixel.g * renderTransparentlyOccludedHUD < 1.0;\n}\nreturn occlusionPixel.r * occlusionPixel.g > 0.0 && occlusionPixel.g == 1.0;\n}"]))))}},32925:(e,t,i)=>{i.d(t,{v:()=>l,z:()=>o});var r,n,s=i(57528),a=i(64839);function o(e){e.fragment.code.add((0,a.H)(r||(r=(0,s.A)(["float normals2FoamIntensity(vec3 n, float waveStrength){\nfloat normalizationFactor =  max(0.015, waveStrength);\nreturn max((n.x + n.y)*0.3303545/normalizationFactor + 0.3303545, 0.0);\n}"]))))}function l(e){e.fragment.code.add((0,a.H)(n||(n=(0,s.A)(["vec3 foamIntensity2FoamColor(float foamIntensityExternal, float foamPixelIntensity, vec3 skyZenitColor, float dayMod){\nreturn foamIntensityExternal * (0.075 * skyZenitColor * pow(foamPixelIntensity, 4.) +  50.* pow(foamPixelIntensity, 23.0)) * dayMod;\n}"]))))}},56906:(e,t,i)=>{i.d(t,{q:()=>A,h:()=>R});var r=i(57528),n=i(81449),s=i(42451),a=i(58350),o=i(21390),l=i(64839),c=i(70367);i(14522),i(93345),i(98433),i(96673);function d(e){return e.pattern.map((t=>Math.round(t*e.pixelRatio)))}function h(e){if(null==e)return 1;const t=d(e);return Math.floor(t.reduce(((e,t)=>e+t)))}function u(e){return d(e).reduce(((e,t)=>Math.max(e,t)))}var p=i(43047),f=i(55855);const g=(0,f.vt)();var m,_,v,y,b,x,S,w,C;function A(e,t){e.constants.add("stippleAlphaColorDiscard","float",.001),e.constants.add("stippleAlphaHighlightDiscard","float",.5),t.stippleEnabled?function(e,t){const i=!(t.draped&&t.stipplePreferContinuous),{vertex:d,fragment:h}=e;h.include(n.W),t.draped||((0,s.yu)(d,t),d.uniforms.add(new o.m("worldToScreenPerDistanceRatio",((e,t)=>1/t.camera.perScreenPixelRatio))),d.code.add((0,l.H)(m||(m=(0,r.A)(["float computeWorldToScreenRatio(vec3 segmentCenter) {\nfloat segmentDistanceToCamera = length(segmentCenter - cameraPosition);\nreturn worldToScreenPerDistanceRatio / segmentDistanceToCamera;\n}"]))))),e.varyings.add("vStippleDistance","float"),e.varyings.add("vStippleDistanceLimits","vec2"),e.varyings.add("vStipplePatternStretch","float"),d.code.add((0,l.H)(_||(_=(0,r.A)(["\n    float discretizeWorldToScreenRatio(float worldToScreenRatio) {\n      float step = ",";\n\n      float discreteWorldToScreenRatio = log(worldToScreenRatio);\n      discreteWorldToScreenRatio = ceil(discreteWorldToScreenRatio / step) * step;\n      discreteWorldToScreenRatio = exp(discreteWorldToScreenRatio);\n      return discreteWorldToScreenRatio;\n    }\n  "])),E)),d.code.add((0,l.H)(v||(v=(0,r.A)(["vec2 computeStippleDistanceLimits(float startPseudoScreen, float segmentLengthPseudoScreen, float segmentLengthScreen, float patternLength) {"])))),d.code.add((0,l.H)(y||(y=(0,r.A)(["\n    if (segmentLengthPseudoScreen >= ",") {\n  "])),i?"patternLength":"1e4")),(0,s.Nz)(d),d.code.add((0,l.H)(b||(b=(0,r.A)(["float repetitions = segmentLengthScreen / (patternLength * pixelRatio);\nfloat flooredRepetitions = max(1.0, floor(repetitions + 0.5));\nfloat segmentLengthScreenRounded = flooredRepetitions * patternLength;\nfloat stretch = repetitions / flooredRepetitions;\nvStipplePatternStretch = max(0.75, stretch);\nreturn vec2(0.0, segmentLengthScreenRounded);\n}\nreturn vec2(startPseudoScreen, startPseudoScreen + segmentLengthPseudoScreen);\n}"])))),h.uniforms.add(new c.N("stipplePatternTexture",(e=>e.stippleTexture)),new o.m("stipplePatternSDFNormalizer",(e=>function(e){return e?(Math.floor(.5*(u(e)-1))+.5)/e.pixelRatio:1}(e.stipplePattern))),new o.m("stipplePatternPixelSizeInv",(e=>1/R(e)))),h.code.add((0,l.H)(x||(x=(0,r.A)(["float getStippleSDF(out bool isClamped) {\nfloat stippleDistanceClamped = clamp(vStippleDistance, vStippleDistanceLimits.x, vStippleDistanceLimits.y);\nvec2 aaCorrectedLimits = vStippleDistanceLimits + vec2(1.0, -1.0) / gl_FragCoord.w;\nisClamped = vStippleDistance < aaCorrectedLimits.x || vStippleDistance > aaCorrectedLimits.y;\nfloat u = stippleDistanceClamped * gl_FragCoord.w * stipplePatternPixelSizeInv * vLineSizeInv;\nu = fract(u);\nfloat encodedSDF = rgba2float(texture(stipplePatternTexture, vec2(u, 0.5)));\nfloat sdf = (encodedSDF * 2.0 - 1.0) * stipplePatternSDFNormalizer;\nreturn (sdf - 0.5) * vStipplePatternStretch + 0.5;\n}\nfloat getStippleSDF() {\nbool ignored;\nreturn getStippleSDF(ignored);\n}\nfloat getStippleAlpha() {\nbool isClamped;\nfloat stippleSDF = getStippleSDF(isClamped);\nfloat antiAliasedResult = clamp(stippleSDF * vLineWidth + 0.5, 0.0, 1.0);\nreturn isClamped ? floor(antiAliasedResult + 0.5) : antiAliasedResult;\n}"])))),t.stippleOffColorEnabled?(h.uniforms.add(new a.E("stippleOffColor",(e=>function(e){return null==e?f.uY:4===e.length?e:(0,p.s)(g,e[0],e[1],e[2],1)}(e.stippleOffColor)))),h.code.add((0,l.H)(S||(S=(0,r.A)(["#define discardByStippleAlpha(stippleAlpha, threshold) {}\n#define blendStipple(color, stippleAlpha) mix(color, stippleOffColor, stippleAlpha)"]))))):h.code.add((0,l.H)(w||(w=(0,r.A)(["#define discardByStippleAlpha(stippleAlpha, threshold) if (stippleAlpha < threshold) { discard; }\n#define blendStipple(color, stippleAlpha) vec4(color.rgb, color.a * stippleAlpha)"]))))}(e,t):function(e){e.fragment.code.add((0,l.H)(C||(C=(0,r.A)(["float getStippleAlpha() { return 1.0; }\n#define discardByStippleAlpha(_stippleAlpha_, _threshold_) {}\n#define blendStipple(color, _stippleAlpha_) color"]))))}(e)}function R(e){const t=e.stipplePattern;return t?h(e.stipplePattern)/t.pixelRatio:1}const E=l.H.float(.4)},17698:(e,t,i)=>{i.d(t,{r:()=>h});var r,n,s=i(57528),a=i(99443),o=i(42451),l=i(21390),c=i(64839),d=i(50125);function h(e,t){const{vertex:i,constants:h}=e;h.add("markerSizePerLineWidth","float",a.PV),(0,o.Nz)(i),null==i.uniforms.get("markerScale")&&i.constants.add("markerScale","float",1),i.code.add((0,c.H)(r||(r=(0,s.A)(["float getLineWidth() {\nreturn max(getSize(), 1.0) * pixelRatio;\n}\nfloat getScreenMarkerSize() {\nreturn markerSizePerLineWidth * markerScale * getLineWidth();\n}"])))),t.space===d.lM.World&&(i.constants.add("maxSegmentLengthFraction","float",.45),i.uniforms.add(new l.m("perRenderPixelRatio",((e,t)=>t.camera.perRenderPixelRatio))),i.code.add((0,c.H)(n||(n=(0,s.A)(["bool areWorldMarkersHidden(vec4 pos, vec4 other) {\nvec3 midPoint = mix(pos.xyz, other.xyz, 0.5);\nfloat distanceToCamera = length(midPoint);\nfloat screenToWorldRatio = perRenderPixelRatio * distanceToCamera * 0.5;\nfloat worldMarkerSize = getScreenMarkerSize() * screenToWorldRatio;\nfloat segmentLen = length(pos.xyz - other.xyz);\nreturn worldMarkerSize > maxSegmentLengthFraction * segmentLen;\n}\nfloat getWorldMarkerSize(vec4 pos) {\nfloat distanceToCamera = length(pos.xyz);\nfloat screenToWorldRatio = perRenderPixelRatio * distanceToCamera * 0.5;\nreturn getScreenMarkerSize() * screenToWorldRatio;\n}"])))))}},10708:(e,t,i)=>{i.d(t,{H:()=>c,U:()=>d});var r,n=i(57528),s=i(65058),a=i(95756),o=i(64839),l=i(70367);function c(e){e.include(s.D),e.uniforms.add(new l.N("geometryDepthTexture",((e,t)=>{var i;return null===(i=t.multipassGeometry.linearDepth)||void 0===i?void 0:i.getTexture()})),new a.G("nearFar",((e,t)=>t.camera.nearFar))),e.code.add((0,o.H)(r||(r=(0,n.A)(["bool geometryDepthTest(vec2 pos, float elementDepth) {\nfloat geometryDepth = linearDepthFromTexture(geometryDepthTexture, pos, nearFar);\nreturn (elementDepth < (geometryDepth - 1.0));\n}"]))))}class d{}},2260:(e,t,i)=>{i.d(t,{n:()=>c});var r,n,s,a,o=i(57528),l=i(64839);function c(e,t){t.spherical?e.vertex.code.add((0,l.H)(r||(r=(0,o.A)(["vec3 getLocalUp(in vec3 pos, in vec3 origin) {\nreturn normalize(pos + origin);\n}"])))):e.vertex.code.add((0,l.H)(n||(n=(0,o.A)(["vec3 getLocalUp(in vec3 pos, in vec3 origin) {\nreturn vec3(0.0, 0.0, 1.0);\n}"])))),t.spherical?e.vertex.code.add((0,l.H)(s||(s=(0,o.A)(["mat3 getTBNMatrix(in vec3 n) {\nvec3 t = normalize(cross(vec3(0.0, 0.0, 1.0), n));\nvec3 b = normalize(cross(n, t));\nreturn mat3(t, b, n);\n}"])))):e.vertex.code.add((0,l.H)(a||(a=(0,o.A)(["mat3 getTBNMatrix(in vec3 n) {\nvec3 t = vec3(1.0, 0.0, 0.0);\nvec3 b = normalize(cross(n, t));\nreturn mat3(t, b, n);\n}"]))))}},92176:(e,t,i)=>{i.d(t,{E:()=>k});var r,n=i(57528),s=i(32925),a=i(64839);function o(e){e.fragment.code.add((0,a.H)(r||(r=(0,n.A)(["const float GAMMA = 2.2;\nconst float INV_GAMMA = 0.4545454545;\nvec4 delinearizeGamma(vec4 color) {\nreturn vec4(pow(color.rgb, vec3(INV_GAMMA)), color.w);\n}\nvec3 linearizeGamma(vec3 color) {\nreturn pow(color, vec3(GAMMA));\n}"]))))}var l,c=i(42953),d=i(48353),h=i(65058),u=i(95756),p=i(21390),f=i(43425),g=i(70367);function m(e,t){const i=e.fragment;i.include(h.D),i.uniforms.add(new u.G("nearFar",((e,t)=>t.camera.nearFar))),i.uniforms.add(new g.N("depthMap",((e,t)=>{var i;return null===(i=t.linearDepth)||void 0===i?void 0:i.getTexture()}))),i.uniforms.add(new f.X("proj",((e,t)=>t.camera.projectionMatrix))),i.uniforms.add(new p.m("invResolutionHeight",((e,t)=>1/t.camera.height))),i.uniforms.add(new f.X("reprojectionMatrix",((e,t)=>t.ssr.reprojectionMatrix))),i.code.add((0,a.H)(l||(l=(0,n.A)(["\n  vec2 reprojectionCoordinate(vec3 projectionCoordinate)\n  {\n    vec4 zw = proj * vec4(0.0, 0.0, -projectionCoordinate.z, 1.0);\n    vec4 reprojectedCoord = reprojectionMatrix * vec4(zw.w * (projectionCoordinate.xy * 2.0 - 1.0), zw.z, zw.w);\n    reprojectedCoord.xy /= reprojectedCoord.w;\n    return reprojectedCoord.xy * 0.5 + 0.5;\n  }\n\n  const int maxSteps = ",";\n\n  vec4 applyProjectionMat(mat4 projectionMat, vec3 x)\n  {\n    vec4 projectedCoord =  projectionMat * vec4(x, 1.0);\n    projectedCoord.xy /= projectedCoord.w;\n    projectedCoord.xy = projectedCoord.xy*0.5 + 0.5;\n    return projectedCoord;\n  }\n\n  vec3 screenSpaceIntersection(vec3 dir, vec3 startPosition, vec3 viewDir, vec3 normal)\n  {\n    vec3 viewPos = startPosition;\n    vec3 viewPosEnd = startPosition;\n\n    // Project the start position to the screen\n    vec4 projectedCoordStart = applyProjectionMat(proj, viewPos);\n    vec3  Q0 = viewPos / projectedCoordStart.w; // homogeneous camera space\n    float k0 = 1.0/ projectedCoordStart.w;\n\n    // advance the position in the direction of the reflection\n    viewPos += dir;\n\n    vec4 projectedCoordVanishingPoint = applyProjectionMat(proj, dir);\n\n    // Project the advanced position to the screen\n    vec4 projectedCoordEnd = applyProjectionMat(proj, viewPos);\n    vec3  Q1 = viewPos / projectedCoordEnd.w; // homogeneous camera space\n    float k1 = 1.0/ projectedCoordEnd.w;\n\n    // calculate the reflection direction in the screen space\n    vec2 projectedCoordDir = (projectedCoordEnd.xy - projectedCoordStart.xy);\n    vec2 projectedCoordDistVanishingPoint = (projectedCoordVanishingPoint.xy - projectedCoordStart.xy);\n\n    float yMod = min(abs(projectedCoordDistVanishingPoint.y), 1.0);\n\n    float projectedCoordDirLength = length(projectedCoordDir);\n    float maxSt = float(maxSteps);\n\n    // normalize the projection direction depending on maximum steps\n    // this determines how blocky the reflection looks\n    vec2 dP = yMod * (projectedCoordDir)/(maxSt * projectedCoordDirLength);\n\n    // Normalize the homogeneous camera space coordinates\n    vec3  dQ = yMod * (Q1 - Q0)/(maxSt * projectedCoordDirLength);\n    float dk = yMod * (k1 - k0)/(maxSt * projectedCoordDirLength);\n\n    // initialize the variables for ray marching\n    vec2 P = projectedCoordStart.xy;\n    vec3 Q = Q0;\n    float k = k0;\n    float rayStartZ = -startPosition.z; // estimated ray start depth value\n    float rayEndZ = -startPosition.z;   // estimated ray end depth value\n    float prevEstimateZ = -startPosition.z;\n    float rayDiffZ = 0.0;\n    float dDepth;\n    float depth;\n    float rayDiffZOld = 0.0;\n\n    // early outs\n    if (dot(normal, dir) < 0.0 || dot(-viewDir, normal) < 0.0)\n      return vec3(P, 0.0);\n\n    for(int i = 0; i < maxSteps-1; i++)\n    {\n      depth = -linearDepthFromTexture(depthMap, P, nearFar); // get linear depth from the depth buffer\n\n      // estimate depth of the marching ray\n      rayStartZ = prevEstimateZ;\n      dDepth = -rayStartZ - depth;\n      rayEndZ = (dQ.z * 0.5 + Q.z)/ ((dk * 0.5 + k));\n      rayDiffZ = rayEndZ- rayStartZ;\n      prevEstimateZ = rayEndZ;\n\n      if(-rayEndZ > nearFar[1] || -rayEndZ < nearFar[0] || P.y < 0.0  || P.y > 1.0 )\n      {\n        return vec3(P, 0.);\n      }\n\n      // If we detect a hit - return the intersection point, two conditions:\n      //  - dDepth > 0.0 - sampled point depth is in front of estimated depth\n      //  - if difference between dDepth and rayDiffZOld is not too large\n      //  - if difference between dDepth and 0.025/abs(k) is not too large\n      //  - if the sampled depth is not behind far plane or in front of near plane\n\n      if((dDepth) < 0.025/abs(k) + abs(rayDiffZ) && dDepth > 0.0 && depth > nearFar[0] && depth < nearFar[1] && abs(P.y - projectedCoordStart.y) > invResolutionHeight)\n      {\n        return vec3(P, depth);\n      }\n\n      // continue with ray marching\n      P = clamp(P + dP, vec2(0.0), vec2(0.999));\n      Q.z += dQ.z;\n      k += dk;\n      rayDiffZOld = rayDiffZ;\n    }\n    return vec3(P, 0.0);\n  }\n  "])),t.highStepCount?"150":"75"))}var _,v,y,b,x,S,w,C,A,R,E,O,T,P,M,I,D=i(15941),L=i(14556),F=i(49753),N=i(63401),V=i(317),G=i(43557),U=i(53736),z=i(5517),B=i(7223),H=i(24245);class j extends B.n{constructor(e,t){super(e,"samplerCube",H.c.Pass,((i,r,n)=>i.bindTexture(e,t(r,n))))}}function W(e){const t=e.fragment;t.uniforms.add(new f.X("rotationMatrixClouds",((e,t)=>t.cloudsFade.parallax.transform)),new f.X("rotationMatrixCloudsCrossFade",((e,t)=>t.cloudsFade.parallaxNew.transform)),new z.t("anchorPosition",((e,t)=>t.cloudsFade.parallax.anchorPointClouds)),new z.t("anchorPositionCrossFade",((e,t)=>t.cloudsFade.parallaxNew.anchorPointClouds)),new p.m("cloudsHeight",(()=>V.k9)),new p.m("radiusCurvatureCorrectionFactor",((e,t)=>t.cloudsFade.parallax.radiusCurvatureCorrectionFactor)),new p.m("totalFadeInOut",((e,t)=>1-t.cloudsFade.opacity)),new p.m("crossFadeAnchorFactor",((e,t)=>(0,D.qE)(t.cloudsFade.fadeFactor,0,1))),new j("cubeMap",((e,t)=>{var i,r;return null!==(i=null===(r=t.cloudsFade.data)||void 0===r||null===(r=r.cubeMap)||void 0===r?void 0:r.colorTexture)&&void 0!==i?i:null})),new U.e("crossFade",((e,t)=>t.cloudsFade.fadeMode===N.OQ.CROSS_FADE)),new U.e("readChannelsRG",((e,t)=>t.cloudsFade.readChannels===F.c.RG)),new U.e("fadeTextureChannels",((e,t)=>t.cloudsFade.renderingStage===F.c2.FADING))),t.constants.add("planetRadius","float",L.$O.radius),t.code.add((0,a.H)(_||(_=(0,n.A)(["vec3 intersectWithCloudLayer(vec3 dir, vec3 cameraPosition, vec3 spherePos)\n{\nfloat radiusClouds = planetRadius + cloudsHeight;\nfloat B = 2.0 * dot(cameraPosition, dir);\nfloat C = dot(cameraPosition, cameraPosition) - radiusClouds * radiusClouds;\nfloat det = B * B - 4.0 * C;\nfloat pointIntDist = max(0.0, 0.5 *(-B + sqrt(det)));\nvec3 intersectionPont = cameraPosition + dir * pointIntDist;\nintersectionPont =  intersectionPont - spherePos;\nreturn intersectionPont;\n}"])))),t.code.add((0,a.H)(v||(v=(0,n.A)(["vec3 correctForPlanetCurvature(vec3 dir)\n{\ndir.z = dir.z*(1.-radiusCurvatureCorrectionFactor) + radiusCurvatureCorrectionFactor;\nreturn dir;\n}"])))),t.code.add((0,a.H)(y||(y=(0,n.A)(["vec3 rotateDirectionToAnchorPoint(mat4 rotMat, vec3 inVec)\n{\nreturn (rotMat * vec4(inVec, 0.0)).xyz;\n}"])))),(0,G.Gc)(t),(0,G.O4)(t),t.code.add((0,a.H)(b||(b=(0,n.A)(["const float SUNSET_TRANSITION_FACTOR = 0.3;\nconst vec3 RIM_COLOR = vec3(0.28, 0.175, 0.035);\nconst float RIM_SCATTERING_FACTOR = 140.0;\nconst float BACKLIGHT_FACTOR = 0.2;\nconst float BACKLIGHT_SCATTERING_FACTOR = 10.0;\nconst float BACKLIGHT_TRANSITION_FACTOR = 0.3;\nvec3 calculateCloudColor(vec3 cameraPosition, vec3 worldSpaceRay, vec4 clouds)\n{\nfloat upDotLight = dot(normalize(cameraPosition), normalize(mainLightDirection));\nfloat dirDotLight = max(dot(normalize(-worldSpaceRay), normalize(mainLightDirection)), 0.0);\nfloat sunsetTransition = clamp(pow(max(upDotLight, 0.0), SUNSET_TRANSITION_FACTOR), 0.0, 1.0);\nvec3 ambientLight = calculateAmbientIrradiance(normalize(cameraPosition),  0.0);\nvec3 mainLight = evaluateMainLighting(normalize(cameraPosition),  0.0);\nvec3 combinedLight = clamp((mainLightIntensity + ambientLight )/PI, vec3(0.0), vec3(1.0));\nvec3 baseCloudColor = pow(combinedLight * pow(clouds.xyz, vec3(GAMMA)), vec3(INV_GAMMA));\nfloat scatteringMod = max(clouds.a < 0.5 ? clouds.a / 0.5 : - clouds.a / 0.5 + 2.0, 0.0);\nfloat rimLightIntensity = 0.5 + 0.5 *pow(max(upDotLight, 0.0), 0.35);\nvec3 directSunScattering = RIM_COLOR * rimLightIntensity * (pow(dirDotLight, RIM_SCATTERING_FACTOR)) * scatteringMod;\nfloat additionalLight = BACKLIGHT_FACTOR * pow(dirDotLight, BACKLIGHT_SCATTERING_FACTOR) * (1. - pow(sunsetTransition, BACKLIGHT_TRANSITION_FACTOR)) ;\nreturn vec3(baseCloudColor * (1. + additionalLight) + directSunScattering);\n}"])))),t.code.add((0,a.H)(x||(x=(0,n.A)(["vec4 getCloudData(vec3 rayDir, bool readOtherChannel)\n{\nvec4 cloudData = texture(cubeMap, rayDir);\nfloat mu = dot(rayDir, vec3(0, 0, 1));\nbool readChannels = readChannelsRG ^^ readOtherChannel;\nif (readChannels) {\ncloudData = vec4(vec3(cloudData.r), cloudData.g);\n} else {\ncloudData = vec4(vec3(cloudData.b), cloudData.a);\n}\nif (length(cloudData) == 0.0) {\nreturn vec4(cloudData.rgb, 1.0);\n}\nreturn cloudData;\n}"])))),t.code.add((0,a.H)(S||(S=(0,n.A)(["vec4 renderCloudsNoFade(vec3 worldRay, vec3 cameraPosition)\n{\nvec3 intersectionPoint = intersectWithCloudLayer(normalize(worldRay), cameraPosition, anchorPosition);\nvec3 worldRayRotated = rotateDirectionToAnchorPoint(rotationMatrixClouds, normalize(intersectionPoint));\nvec3 worldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);\nvec4 cloudData = getCloudData(worldRayRotatedCorrected, false);\nfloat totalTransmittance = clamp(cloudData.a * (1.0 - totalFadeInOut) + totalFadeInOut, 0.0 , 1.0);\nif (length(cloudData.rgb) == 0.0) {\ntotalTransmittance = 1.0;\n}\nreturn vec4(calculateCloudColor(cameraPosition, normalize(-worldRay), cloudData), totalTransmittance);\n}"])))),t.code.add((0,a.H)(w||(w=(0,n.A)(["vec4 renderCloudsCrossFade(vec3 worldRay, vec3 cameraPosition)\n{\nvec3 intersectionPoint = intersectWithCloudLayer(normalize(worldRay), cameraPosition, anchorPosition);\nvec3 worldRayRotated = rotateDirectionToAnchorPoint(rotationMatrixClouds, normalize(intersectionPoint));\nvec3 worldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);\nvec4 cloudData = getCloudData(worldRayRotatedCorrected, false);\nvec4 cloudColor = vec4(calculateCloudColor(cameraPosition, normalize(-worldRay), cloudData), cloudData.a);\nintersectionPoint = intersectWithCloudLayer(normalize(worldRay), cameraPosition, anchorPositionCrossFade);\nworldRayRotated = rotateDirectionToAnchorPoint(rotationMatrixCloudsCrossFade, normalize(intersectionPoint));\nworldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);\ncloudData = getCloudData(worldRayRotatedCorrected, fadeTextureChannels);\nvec4 cloudColorCrossFade = vec4(calculateCloudColor(cameraPosition, normalize(-worldRay), cloudData), cloudData.a);\ncloudColor = mix(cloudColor, cloudColorCrossFade, crossFadeAnchorFactor);\nfloat totalTransmittance = clamp(cloudColor.a * (1.0 - totalFadeInOut) + totalFadeInOut, 0.0 , 1.0);\nif (length(cloudColor.rgb) == 0.0) {\ntotalTransmittance = 1.0;\n}\nreturn vec4(cloudColor.rgb, totalTransmittance);\n}"])))),t.code.add((0,a.H)(C||(C=(0,n.A)(["vec4 renderClouds(vec3 worldRay, vec3 cameraPosition)\n{\nreturn crossFade ? renderCloudsCrossFade(worldRay, cameraPosition) : renderCloudsNoFade(worldRay, cameraPosition);\n}"]))))}function k(e,t){e.include(c.f,t),e.include(o),e.include(s.v),t.hasCloudsReflections&&e.include(W,t),t.hasScreenSpaceReflections&&e.include(m,t);const i=e.fragment;i.constants.add("fresnelSky","vec3",[.02,1,15]).add("fresnelMaterial","vec2",[.02,.1]).add("roughness","float",.015).add("foamIntensityExternal","float",1.7).add("ssrIntensity","float",.65).add("ssrHeightFadeStart","float",d.O).add("ssrHeightFadeEnd","float",d.b).add("waterDiffusion","float",.92).add("waterSeaColorMod","float",.8).add("correctionViewingPowerFactor","float",.4).add("skyZenitColor","vec3",[.52,.68,.9]).add("skyColor","vec3",[.67,.79,.9]).add("cloudFresnelModifier","vec2",[1.2,.01]),i.code.add((0,a.H)(A||(A=(0,n.A)(["PBRShadingWater shadingInfo;\nvec3 getSkyGradientColor(in float cosTheta, in vec3 horizon, in vec3 zenit) {\nfloat exponent = pow((1.0 - cosTheta), fresnelSky[2]);\nreturn mix(zenit, horizon, exponent);\n}"])))),i.uniforms.add(new p.m("lightingSpecularStrength",((e,t)=>t.lighting.mainLight.specularStrength)),new p.m("lightingEnvironmentStrength",((e,t)=>t.lighting.mainLight.environmentStrength))),i.code.add((0,a.H)(R||(R=(0,n.A)(["vec3 getSeaColor(in vec3 n, in vec3 v, in vec3 l, vec3 color, in vec3 lightIntensity, in vec3 localUp, in float shadow, float foamIntensity, vec3 viewPosition, vec3 position) {\nfloat reflectionHit = 0.0;\nfloat reflectionHitDiffused = 0.0;\nvec3 seaWaterColor = linearizeGamma(color);\nvec3 h = normalize(l + v);\nshadingInfo.NdotL = clamp(dot(n, l), 0.0, 1.0);\nshadingInfo.NdotV = clamp(dot(n, v), 0.001, 1.0);\nshadingInfo.VdotN = clamp(dot(v, n), 0.001, 1.0);\nshadingInfo.NdotH = clamp(dot(n, h), 0.0, 1.0);\nshadingInfo.VdotH = clamp(dot(v, h), 0.0, 1.0);\nshadingInfo.LdotH = clamp(dot(l, h), 0.0, 1.0);\nfloat upDotV = max(dot(localUp,v), 0.0);\nvec3 skyHorizon = linearizeGamma(skyColor);\nvec3 skyZenit = linearizeGamma(skyZenitColor);\nvec3 skyColor = getSkyGradientColor(upDotV, skyHorizon, skyZenit );\nfloat upDotL = max(dot(localUp,l),0.0);\nfloat daytimeMod = 0.1 + upDotL * 0.9;\nskyColor *= daytimeMod;\nfloat shadowModifier = clamp(shadow, 0.8, 1.0);\nvec3 fresnelModifier = fresnelReflection(shadingInfo.VdotN, vec3(fresnelSky[0]), fresnelSky[1]);\nvec3 reflSky = lightingEnvironmentStrength * fresnelModifier * skyColor * shadowModifier;\nvec3 reflSea = seaWaterColor * mix(skyColor, upDotL * lightIntensity * LIGHT_NORMALIZATION, 2.0 / 3.0) * shadowModifier;\nvec3 specular = vec3(0.0);\nif(upDotV > 0.0 && upDotL > 0.0) {\nvec3 specularSun = brdfSpecularWater(shadingInfo, roughness, vec3(fresnelMaterial[0]), fresnelMaterial[1]);\nvec3 incidentLight = lightIntensity * LIGHT_NORMALIZATION * shadow;\nspecular = lightingSpecularStrength * shadingInfo.NdotL * incidentLight * specularSun;\n}\nvec3 foam = vec3(0.0);\nif(upDotV > 0.0) {\nfoam = foamIntensity2FoamColor(foamIntensityExternal, foamIntensity, skyZenitColor, daytimeMod);\n}\nfloat correctionViewingFactor = pow(max(dot(v, localUp), 0.0), correctionViewingPowerFactor);\nvec3 normalCorrectedClouds = mix(localUp, n, correctionViewingFactor);\nvec3 reflectedWorld = normalize(reflect(-v, normalCorrectedClouds));"])))),t.hasCloudsReflections&&i.code.add((0,a.H)(E||(E=(0,n.A)(["vec4 cloudsColor = renderClouds(reflectedWorld, position);\ncloudsColor.a = 1.0 - cloudsColor.a;\ncloudsColor = pow(cloudsColor, vec4(GAMMA));\ncloudsColor *= clamp(fresnelModifier.y * cloudFresnelModifier[0] - cloudFresnelModifier[1], 0.0, 1.0) * clamp((1.0 - totalFadeInOut), 0.0, 1.0);"])))),t.hasScreenSpaceReflections?(i.uniforms.add(new f.X("view",((e,t)=>t.camera.viewMatrix)),new g.N("lastFrameColorTexture",((e,t)=>{var i;return null===(i=t.ssr.lastFrameColor)||void 0===i?void 0:i.getTexture()})),new p.m("fadeFactorSSR",((e,t)=>t.ssr.fadeFactor))),i.code.add((0,a.H)(O||(O=(0,n.A)(["vec3 viewDir = normalize(viewPosition);\nvec4 viewNormalVectorCoordinate = view *vec4(n, 0.0);\nvec3 viewNormal = normalize(viewNormalVectorCoordinate.xyz);\nvec4 viewUp = view * vec4(localUp, 0.0);\nvec3 viewNormalCorrectedSSR = mix(viewUp.xyz, viewNormal, correctionViewingFactor);\nvec3 reflected = normalize(reflect(viewDir, viewNormalCorrectedSSR));\nvec3 hitCoordinate = screenSpaceIntersection(reflected, viewPosition, viewDir, viewUp.xyz);\nvec3 reflectedColor = vec3(0.0);\nif (hitCoordinate.z > 0.0)\n{\nvec2 reprojectedCoordinate = reprojectionCoordinate(hitCoordinate);\nvec2 dCoords = smoothstep(0.3, 0.6, abs(vec2(0.5, 0.5) - hitCoordinate.xy));\nfloat heightMod = smoothstep(ssrHeightFadeEnd, ssrHeightFadeStart, -viewPosition.z);\nreflectionHit = clamp(1.0 - (1.3 * dCoords.y), 0.0, 1.0) * heightMod * fadeFactorSSR;\nreflectionHitDiffused = waterDiffusion * reflectionHit;\nreflectedColor = linearizeGamma(texture(lastFrameColorTexture, reprojectedCoordinate).xyz) *\nreflectionHitDiffused * fresnelModifier.y * ssrIntensity;\n}\nfloat seaColorMod =  mix(waterSeaColorMod, waterSeaColorMod * 0.5, reflectionHitDiffused);\nvec3 waterRenderedColor = tonemapACES((1.0 - reflectionHitDiffused) * reflSky + reflectedColor +\nreflSea * seaColorMod + specular + foam);"]))))):i.code.add((0,a.H)(T||(T=(0,n.A)(["vec3 waterRenderedColor = tonemapACES(reflSky + reflSea * waterSeaColorMod + specular + foam);"])))),t.hasCloudsReflections?t.hasScreenSpaceReflections?i.code.add((0,a.H)(P||(P=(0,n.A)(["return waterRenderedColor * (1.0 - (1.0 - reflectionHit) * cloudsColor.a) + (1.0 - reflectionHit) * cloudsColor.xyz;\n}"])))):i.code.add((0,a.H)(M||(M=(0,n.A)(["return waterRenderedColor * (1.0 - cloudsColor.a) + cloudsColor.xyz;\n}"])))):i.code.add((0,a.H)(I||(I=(0,n.A)(["return waterRenderedColor;\n}"]))))}},82884:(e,t,i)=>{i.d(t,{V:()=>f});var r,n=i(57528),s=i(19555),a=i(72745),o=i(43047),l=i(55855),c=i(32925),d=(i(1773),i(95756)),h=i(58350),u=i(64839),p=i(70367);function f(e){e.fragment.uniforms.add(new p.N("texWaveNormal",(e=>e.waveNormal)),new p.N("texWavePerturbation",(e=>e.wavePerturbation)),new h.E("waveParams",(e=>(0,o.s)(g,e.waveStrength,e.waveTextureRepeat,e.flowStrength,e.flowOffset))),new d.G("waveDirection",(e=>(0,s.hZ)(m,e.waveDirection[0]*e.waveVelocity,e.waveDirection[1]*e.waveVelocity)))),e.include(c.z),e.fragment.code.add((0,u.H)(r||(r=(0,n.A)(["const vec2  FLOW_JUMP = vec2(6.0/25.0, 5.0/24.0);\nvec2 textureDenormalized2D(sampler2D _tex, vec2 _uv) {\nreturn 2.0 * texture(_tex, _uv).rg - 1.0;\n}\nfloat sampleNoiseTexture(vec2 _uv) {\nreturn texture(texWavePerturbation, _uv).b;\n}\nvec3 textureDenormalized3D(sampler2D _tex, vec2 _uv) {\nreturn 2.0 * texture(_tex, _uv).rgb - 1.0;\n}\nfloat computeProgress(vec2 uv, float time) {\nreturn fract(time);\n}\nfloat computeWeight(vec2 uv, float time) {\nfloat progress = computeProgress(uv, time);\nreturn 1.0 - abs(1.0 - 2.0 * progress);\n}\nvec3 computeUVPerturbedWeigth(sampler2D texFlow, vec2 uv, float time, float phaseOffset) {\nfloat flowStrength = waveParams[2];\nfloat flowOffset = waveParams[3];\nvec2 flowVector = textureDenormalized2D(texFlow, uv) * flowStrength;\nfloat progress = computeProgress(uv, time + phaseOffset);\nfloat weight = computeWeight(uv, time + phaseOffset);\nvec2 result = uv;\nresult -= flowVector * (progress + flowOffset);\nresult += phaseOffset;\nresult += (time - progress) * FLOW_JUMP;\nreturn vec3(result, weight);\n}\nconst float TIME_NOISE_TEXTURE_REPEAT = 0.3737;\nconst float TIME_NOISE_STRENGTH = 7.77;\nvec3 getWaveLayer(sampler2D _texNormal, sampler2D _dudv, vec2 _uv, vec2 _waveDir, float time) {\nfloat waveStrength = waveParams[0];\nvec2 waveMovement = time * -_waveDir;\nfloat timeNoise = sampleNoiseTexture(_uv * TIME_NOISE_TEXTURE_REPEAT) * TIME_NOISE_STRENGTH;\nvec3 uv_A = computeUVPerturbedWeigth(_dudv, _uv + waveMovement, time + timeNoise, 0.0);\nvec3 uv_B = computeUVPerturbedWeigth(_dudv, _uv + waveMovement, time + timeNoise, 0.5);\nvec3 normal_A = textureDenormalized3D(_texNormal, uv_A.xy) * uv_A.z;\nvec3 normal_B = textureDenormalized3D(_texNormal, uv_B.xy) * uv_B.z;\nvec3 mixNormal = normalize(normal_A + normal_B);\nmixNormal.xy *= waveStrength;\nmixNormal.z = sqrt(1.0 - dot(mixNormal.xy, mixNormal.xy));\nreturn mixNormal;\n}\nvec4 getSurfaceNormalAndFoam(vec2 _uv, float _time) {\nfloat waveTextureRepeat = waveParams[1];\nvec3 normal = getWaveLayer(texWaveNormal, texWavePerturbation, _uv * waveTextureRepeat, waveDirection, _time);\nfloat foam  = normals2FoamIntensity(normal, waveParams[0]);\nreturn vec4(normal, foam);\n}"]))))}const g=(0,l.vt)(),m=(0,a.vt)()},25672:(e,t,i)=>{i.d(t,{aT:()=>n,fA:()=>s});var r=i(15941);i(20664),i(9392),i(75002);function n(e,t,i,r,n){let s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:2;const o=1/(Math.abs(i)+Math.abs(r)+Math.abs(n)),l=i*o,c=r*o,d=n<=0?(l>=0?1:-1)*(1-Math.abs(c)):l,h=n<=0?(c>=0?1:-1)*(1-Math.abs(l)):c,u=t*s;e[u]=a(d),e[u+1]=a(h)}function s(e){const t=e.length/3,i=new Int16Array(2*t);let r=0;for(let s=0;s<t;++s)n(i,s,e[r++],e[r++],e[r++]);return i}function a(e){return(0,r.qE)(Math.round(32767*e),-32767,32767)}},30250:(e,t,i)=>{var r;i.d(t,{O:()=>r}),function(e){e[e.Horizontal=0]="Horizontal",e[e.Vertical=1]="Vertical",e[e.Cross=2]="Cross",e[e.ForwardDiagonal=3]="ForwardDiagonal",e[e.BackwardDiagonal=4]="BackwardDiagonal",e[e.DiagonalCross=5]="DiagonalCross",e[e.COUNT=6]="COUNT"}(r||(r={}))},50125:(e,t,i)=>{i.d(t,{Dt:()=>d,kJ:()=>n,lM:()=>r});var r,n,s=i(35143),a=i(34981),o=i(99415),l=i(10773),c=i(92656);!function(e){e[e.Draped=0]="Draped",e[e.Screen=1]="Screen",e[e.World=2]="World",e[e.COUNT=3]="COUNT"}(r||(r={})),function(e){e[e.Center=0]="Center",e[e.Tip=1]="Tip",e[e.COUNT=2]="COUNT"}(n||(n={}));class d extends c.E{constructor(){super(...arguments),this.output=a.V.Color,this.transparencyPassType=l.y.NONE,this.occluder=!1,this.hasSlicePlane=!1,this.writeDepth=!1,this.space=r.Screen,this.hideOnShortSegments=!1,this.hasCap=!1,this.anchor=n.Center,this.hasTip=!1,this.vvSize=!1,this.vvColor=!1,this.vvOpacity=!1,this.hasOccludees=!1,this.multipassEnabled=!1,this.cullAboveGround=!1}get draped(){return this.space===r.Draped}}(0,s._)([(0,o.W)({count:a.V.COUNT})],d.prototype,"output",void 0),(0,s._)([(0,o.W)({count:l.y.COUNT})],d.prototype,"transparencyPassType",void 0),(0,s._)([(0,o.W)()],d.prototype,"occluder",void 0),(0,s._)([(0,o.W)()],d.prototype,"hasSlicePlane",void 0),(0,s._)([(0,o.W)()],d.prototype,"writeDepth",void 0),(0,s._)([(0,o.W)({count:r.COUNT})],d.prototype,"space",void 0),(0,s._)([(0,o.W)()],d.prototype,"hideOnShortSegments",void 0),(0,s._)([(0,o.W)()],d.prototype,"hasCap",void 0),(0,s._)([(0,o.W)({count:n.COUNT})],d.prototype,"anchor",void 0),(0,s._)([(0,o.W)()],d.prototype,"hasTip",void 0),(0,s._)([(0,o.W)()],d.prototype,"vvSize",void 0),(0,s._)([(0,o.W)()],d.prototype,"vvColor",void 0),(0,s._)([(0,o.W)()],d.prototype,"vvOpacity",void 0),(0,s._)([(0,o.W)()],d.prototype,"hasOccludees",void 0),(0,s._)([(0,o.W)()],d.prototype,"multipassEnabled",void 0),(0,s._)([(0,o.W)()],d.prototype,"cullAboveGround",void 0),(0,s._)([(0,o.W)({constValue:!1})],d.prototype,"occlusionPass",void 0),(0,s._)([(0,o.W)({constValue:!0})],d.prototype,"hasVvInstancing",void 0),(0,s._)([(0,o.W)({constValue:!0})],d.prototype,"hasSliceTranslatedView",void 0)},46259:(e,t,i)=>{i.d(t,{Q:()=>c,x:()=>r});var r,n=i(35143),s=i(34981),a=i(99415),o=i(10773),l=i(92656);!function(e){e[e.BUTT=0]="BUTT",e[e.SQUARE=1]="SQUARE",e[e.ROUND=2]="ROUND",e[e.COUNT=3]="COUNT"}(r||(r={}));class c extends l.E{constructor(){super(...arguments),this.output=s.V.Color,this.capType=r.BUTT,this.transparencyPassType=o.y.NONE,this.occluder=!1,this.hasSlicePlane=!1,this.hasPolygonOffset=!1,this.writeDepth=!1,this.draped=!1,this.stippleEnabled=!1,this.stippleOffColorEnabled=!1,this.stipplePreferContinuous=!0,this.roundJoins=!1,this.applyMarkerOffset=!1,this.vvSize=!1,this.vvColor=!1,this.vvOpacity=!1,this.falloffEnabled=!1,this.innerColorEnabled=!1,this.hasOccludees=!1,this.multipassEnabled=!1,this.cullAboveGround=!1,this.wireframe=!1,this.objectAndLayerIdColorInstanced=!1}}(0,n._)([(0,a.W)({count:s.V.COUNT})],c.prototype,"output",void 0),(0,n._)([(0,a.W)({count:r.COUNT})],c.prototype,"capType",void 0),(0,n._)([(0,a.W)({count:o.y.COUNT})],c.prototype,"transparencyPassType",void 0),(0,n._)([(0,a.W)()],c.prototype,"occluder",void 0),(0,n._)([(0,a.W)()],c.prototype,"hasSlicePlane",void 0),(0,n._)([(0,a.W)()],c.prototype,"hasPolygonOffset",void 0),(0,n._)([(0,a.W)()],c.prototype,"writeDepth",void 0),(0,n._)([(0,a.W)()],c.prototype,"draped",void 0),(0,n._)([(0,a.W)()],c.prototype,"stippleEnabled",void 0),(0,n._)([(0,a.W)()],c.prototype,"stippleOffColorEnabled",void 0),(0,n._)([(0,a.W)()],c.prototype,"stipplePreferContinuous",void 0),(0,n._)([(0,a.W)()],c.prototype,"roundJoins",void 0),(0,n._)([(0,a.W)()],c.prototype,"applyMarkerOffset",void 0),(0,n._)([(0,a.W)()],c.prototype,"vvSize",void 0),(0,n._)([(0,a.W)()],c.prototype,"vvColor",void 0),(0,n._)([(0,a.W)()],c.prototype,"vvOpacity",void 0),(0,n._)([(0,a.W)()],c.prototype,"falloffEnabled",void 0),(0,n._)([(0,a.W)()],c.prototype,"innerColorEnabled",void 0),(0,n._)([(0,a.W)()],c.prototype,"hasOccludees",void 0),(0,n._)([(0,a.W)()],c.prototype,"multipassEnabled",void 0),(0,n._)([(0,a.W)()],c.prototype,"cullAboveGround",void 0),(0,n._)([(0,a.W)()],c.prototype,"wireframe",void 0),(0,n._)([(0,a.W)()],c.prototype,"objectAndLayerIdColorInstanced",void 0),(0,n._)([(0,a.W)({constValue:!1})],c.prototype,"occlusionPass",void 0),(0,n._)([(0,a.W)({constValue:!0})],c.prototype,"hasVvInstancing",void 0),(0,n._)([(0,a.W)({constValue:!0})],c.prototype,"hasSliceTranslatedView",void 0)},90992:(e,t,i)=>{function r(e){return e&&"function"==typeof e.highlight}function n(e,t,i){return null==e||e>i&&(0===t||e<t)}function s(e,t){return null!=e&&e>0||null!=t&&t>0}function a(e){var t,i;const r=e.effectiveScaleRange;return{minScale:null!==(t=null===r||void 0===r?void 0:r.minScale)&&void 0!==t?t:0,maxScale:null!==(i=null===r||void 0===r?void 0:r.maxScale)&&void 0!==i?i:0}}i.d(t,{Cf:()=>a,JU:()=>n,Of:()=>r,WK:()=>s})},36911:(e,t,i)=>{i.d(t,{Z:()=>c});var r=i(76460),n=i(30726),s=i(78393),a=i(93345),o=i(27207);const l=()=>r.A.getLogger("esri.views.webgl.VertexArrayObject");let c=class{constructor(e,t,i,r){let n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;this._context=e,this._locations=t,this._layout=i,this._buffers=r,this._indexBuffer=n,this._glName=null,this._initialized=!1}get glName(){return this._glName}get context(){return this._context}get vertexBuffers(){return this._buffers}get indexBuffer(){return this._indexBuffer}get byteSize(){return Object.keys(this._buffers).reduce(((e,t)=>e+this._buffers[t].usedMemory),null!=this._indexBuffer?this._indexBuffer.usedMemory:0)}get layout(){return this._layout}get locations(){return this._locations}get usedMemory(){return this.byteSize+(Object.keys(this._buffers).length+(this._indexBuffer?1:0))*s.zQ}dispose(){if(this._context){this._context.getBoundVAO()===this&&this._context.bindVAO(null);for(const t in this._buffers){var e;null!==(e=this._buffers[t])&&void 0!==e&&e.dispose(),delete this._buffers[t]}this._indexBuffer=(0,n.WD)(this._indexBuffer),this.disposeVAOOnly()}else(this._glName||Object.getOwnPropertyNames(this._buffers).length>0)&&l().warn("Leaked WebGL VAO")}disposeVAOOnly(){this._glName&&(this._context.gl.deleteVertexArray(this._glName),this._glName=null,this._context.instanceCounter.decrement(a.vt.VertexArrayObject,this)),this._context=null}initialize(){if(this._initialized)return;const{gl:e}=this._context,t=e.createVertexArray();e.bindVertexArray(t),this._bindLayout(),e.bindVertexArray(null),this._glName=t,this._context.instanceCounter.increment(a.vt.VertexArrayObject,this),this._initialized=!0}bind(){this.initialize(),this._context.gl.bindVertexArray(this.glName)}_bindLayout(){const{_buffers:e,_layout:t,_indexBuffer:i}=this;e||l().error("Vertex buffer dictionary is empty!");const r=this._context.gl;for(const n in e){const i=e[n];i||l().error("Vertex buffer is uninitialized!");const r=t[n];r||l().error("Vertex element descriptor is empty!"),(0,o.yu)(this._context,this._locations,i,r)}null!=i&&r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,i.glName)}unbind(){this.initialize(),this._context.gl.bindVertexArray(null)}}},21812:(e,t,i)=>{i.d(t,{_:()=>r});class r{constructor(e,t,i,r,n){let s=arguments.length>5&&void 0!==arguments[5]&&arguments[5],a=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0;this.name=e,this.count=t,this.type=i,this.offset=r,this.stride=n,this.normalized=s,this.divisor=a}}},2995:(e,t,i)=>{i.d(t,{S:()=>a});var r=i(50076),n=i(93345);class s{constructor(e,t,i,r){this.dataType=e,this.samplingMode=t,this.pixelFormat=i,this.internalFormat=r}}function a(e,t){const{textureFloat:i,colorBufferFloat:a}=e.capabilities,o=null===i||void 0===i?void 0:i.textureFloatLinear,l=null===a||void 0===a?void 0:a.textureFloat,c=null===a||void 0===a?void 0:a.textureHalfFloat,d=null===a||void 0===a?void 0:a.floatBlend,h=e.driverTest.floatBufferBlend.result;if(!l&&!c)throw new r.A("heatmap:missing-color-buffer-float","HeatmapRenderer requires the WebGL extension EXT_color_buffer_float or EXT_color_buffer_half_float or WEBGL_color_buffer_float.");if(!(d&&h||c))throw new r.A("heatmap:missing-float-blend","HeatmapRenderer requires the WebGL extension EXT_float_blend or EXT_color_buffer_half_float."+(h?"":" This device claims support for EXT_float_blend, but does not actually support it."));const u=l&&d&&h,p=c,f=o,g=!(null===a||void 0===a||!a.R32F),m=!(null===a||void 0===a||!a.R16F);if(u&&f)return f||t.warnOnce("Missing WebGL extension OES_texture_float_linear. Heatmap quality may be reduced."),new s(n.ld.FLOAT,f?n.Cj.LINEAR:n.Cj.NEAREST,g?n.Ab.RED:n.Ab.RGBA,g?n.H0.R32F:n.Ab.RGBA);if(p)return new s(n.ld.HALF_FLOAT,n.Cj.LINEAR,m?n.Ab.RED:n.Ab.RGBA,m?n.H0.R16F:n.Ab.RGBA);throw new r.A("heatmap:missing-hardware-support","HeatmapRenderer requires WebGL extensions that allow it to render and blend to float or half float textures.")}}}]);
//# sourceMappingURL=7458.be59f308.chunk.js.map